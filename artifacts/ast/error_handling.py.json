Module(body=[Expr(value=Constant(value='Centralized error handling for CodeIntel MCP server.\n\nThis module provides the unified error handling infrastructure for all MCP tools,\nensuring consistent error responses with RFC 9457 Problem Details compliance and\nstructured logging for observability.\n\nArchitecture\n------------\nThe error handling follows a three-layer pattern:\n\n1. **Adapter Layer**: Pure domain logic that raises typed exceptions\n2. **Decorator Layer**: Automatic exception → envelope conversion\n3. **Client Layer**: Uniform error envelope with Problem Details\n\nAll MCP tool functions are decorated with ``@handle_adapter_errors`` which\ncatches all exceptions, converts them to Problem Details, logs with structured\ncontext, and returns a unified error envelope.\n\nExamples\n--------\nApplying decorator to MCP tool:\n\n>>> @mcp.tool()\n>>> @handle_adapter_errors(\n...     operation="files:open_file", empty_result={"path": "", "content": "", "lines": 0, "size": 0}\n... )\n... def open_file(path: str, start_line: int | None, end_line: int | None) -> dict:\n...     context = get_context()\n...     return files_adapter.open_file(context, path, start_line, end_line)\n\nError envelope structure:\n\n>>> # On success:\n>>> {"path": "src/main.py", "content": "...", "lines": 10, "size": 234}\n>>>\n>>> # On error (FileNotFoundError):\n>>> {\n...     "path": "",\n...     "content": "",\n...     "lines": 0,\n...     "size": 0,\n...     "error": "File not found: src/main.py",\n...     "problem": {\n...         "type": "https://kgfoundry.dev/problems/file-not-found",\n...         "title": "File Not Found",\n...         "status": 404,\n...         "detail": "File not found: src/main.py",\n...         "instance": "urn:codeintel:files:open_file",\n...         "code": "file-not-found",\n...     },\n... }\n', lineno=1, col_offset=0, end_lineno=52, end_col_offset=3), lineno=1, col_offset=0, end_lineno=52, end_col_offset=3), ImportFrom(module='__future__', names=[alias(name='annotations', lineno=54, col_offset=23, end_lineno=54, end_col_offset=34)], level=0, lineno=54, col_offset=0, end_lineno=54, end_col_offset=34), ImportFrom(module='collections.abc', names=[alias(name='Callable', lineno=56, col_offset=28, end_lineno=56, end_col_offset=36), alias(name='Mapping', lineno=56, col_offset=38, end_lineno=56, end_col_offset=45)], level=0, lineno=56, col_offset=0, end_lineno=56, end_col_offset=45), ImportFrom(module='functools', names=[alias(name='wraps', lineno=57, col_offset=22, end_lineno=57, end_col_offset=27)], level=0, lineno=57, col_offset=0, end_lineno=57, end_col_offset=27), ImportFrom(module='typing', names=[alias(name='TYPE_CHECKING', lineno=58, col_offset=19, end_lineno=58, end_col_offset=32), alias(name='TypeVar', lineno=58, col_offset=34, end_lineno=58, end_col_offset=41), alias(name='cast', lineno=58, col_offset=43, end_lineno=58, end_col_offset=47)], level=0, lineno=58, col_offset=0, end_lineno=58, end_col_offset=47), ImportFrom(module='kgfoundry_common.errors', names=[alias(name='KgFoundryError', lineno=60, col_offset=36, end_lineno=60, end_col_offset=50)], level=0, lineno=60, col_offset=0, end_lineno=60, end_col_offset=50), ImportFrom(module='kgfoundry_common.logging', names=[alias(name='get_logger', lineno=61, col_offset=37, end_lineno=61, end_col_offset=47), alias(name='with_fields', lineno=61, col_offset=49, end_lineno=61, end_col_offset=60)], level=0, lineno=61, col_offset=0, end_lineno=61, end_col_offset=60), ImportFrom(module='kgfoundry_common.problem_details', names=[alias(name='build_problem_details', lineno=62, col_offset=45, end_lineno=62, end_col_offset=66)], level=0, lineno=62, col_offset=0, end_lineno=62, end_col_offset=66), If(test=Name(id='TYPE_CHECKING', ctx=Load(), lineno=64, col_offset=3, end_lineno=64, end_col_offset=16), body=[ImportFrom(module='kgfoundry_common.problem_details', names=[alias(name='ProblemDetails', lineno=65, col_offset=49, end_lineno=65, end_col_offset=63)], level=0, lineno=65, col_offset=4, end_lineno=65, end_col_offset=63)], lineno=64, col_offset=0, end_lineno=65, end_col_offset=63), Assign(targets=[Name(id='LOGGER', ctx=Store(), lineno=67, col_offset=0, end_lineno=67, end_col_offset=6)], value=Call(func=Name(id='get_logger', ctx=Load(), lineno=67, col_offset=9, end_lineno=67, end_col_offset=19), args=[Name(id='__name__', ctx=Load(), lineno=67, col_offset=20, end_lineno=67, end_col_offset=28)], lineno=67, col_offset=9, end_lineno=67, end_col_offset=29), lineno=67, col_offset=0, end_lineno=67, end_col_offset=29), Assign(targets=[Name(id='COMPONENT_NAME', ctx=Store(), lineno=68, col_offset=0, end_lineno=68, end_col_offset=14)], value=Constant(value='codeintel_mcp', lineno=68, col_offset=17, end_lineno=68, end_col_offset=32), lineno=68, col_offset=0, end_lineno=68, end_col_offset=32), Assign(targets=[Name(id='F', ctx=Store(), lineno=70, col_offset=0, end_lineno=70, end_col_offset=1)], value=Call(func=Name(id='TypeVar', ctx=Load(), lineno=70, col_offset=4, end_lineno=70, end_col_offset=11), args=[Constant(value='F', lineno=70, col_offset=12, end_lineno=70, end_col_offset=15)], keywords=[keyword(arg='bound', value=Subscript(value=Name(id='Callable', ctx=Load(), lineno=70, col_offset=23, end_lineno=70, end_col_offset=31), slice=Tuple(elts=[Constant(value=Ellipsis, lineno=70, col_offset=32, end_lineno=70, end_col_offset=35), Name(id='object', ctx=Load(), lineno=70, col_offset=37, end_lineno=70, end_col_offset=43)], ctx=Load(), lineno=70, col_offset=32, end_lineno=70, end_col_offset=43), ctx=Load(), lineno=70, col_offset=23, end_lineno=70, end_col_offset=44), lineno=70, col_offset=17, end_lineno=70, end_col_offset=44)], lineno=70, col_offset=4, end_lineno=70, end_col_offset=45), lineno=70, col_offset=0, end_lineno=70, end_col_offset=45), FunctionDef(name='convert_exception_to_envelope', args=arguments(args=[arg(arg='exc', annotation=Name(id='Exception', ctx=Load(), lineno=74, col_offset=9, end_lineno=74, end_col_offset=18), lineno=74, col_offset=4, end_lineno=74, end_col_offset=18), arg(arg='operation', annotation=Name(id='str', ctx=Load(), lineno=75, col_offset=15, end_lineno=75, end_col_offset=18), lineno=75, col_offset=4, end_lineno=75, end_col_offset=18), arg(arg='empty_result', annotation=Subscript(value=Name(id='Mapping', ctx=Load(), lineno=76, col_offset=18, end_lineno=76, end_col_offset=25), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=76, col_offset=26, end_lineno=76, end_col_offset=29), Name(id='object', ctx=Load(), lineno=76, col_offset=31, end_lineno=76, end_col_offset=37)], ctx=Load(), lineno=76, col_offset=26, end_lineno=76, end_col_offset=37), ctx=Load(), lineno=76, col_offset=18, end_lineno=76, end_col_offset=38), lineno=76, col_offset=4, end_lineno=76, end_col_offset=38)]), body=[Expr(value=Constant(value='Convert exception to unified error envelope with Problem Details.\n\n    This function is the single source of truth for exception → envelope\n    conversion. It handles all exception types (KgFoundryError subclasses,\n    builtin exceptions, unknown exceptions) and produces a consistent error\n    structure with RFC 9457 Problem Details compliance.\n\n    The error envelope includes:\n    - All fields from ``empty_result`` (tool-specific fields with empty/zero values)\n    - ``error`` field with human-readable message\n    - ``problem`` field with RFC 9457 Problem Details\n\n    Parameters\n    ----------\n    exc : Exception\n        Exception to convert. Can be any exception type - KgFoundryError\n        subclasses are handled specially, builtin exceptions (FileNotFoundError,\n        ValueError, etc.) are mapped to standard Problem Details, unknown\n        exceptions are mapped to 500 Internal Error.\n    operation : str\n        Operation identifier in format "category:operation" (e.g.,\n        "files:open_file", "search:text"). Used for Problem Details instance\n        field and structured logging.\n    empty_result : Mapping[str, object]\n        Tool-specific result fields with empty/zero values. These are merged\n        into the error envelope so clients always see the same field structure.\n        Example: ``{"path": "", "content": "", "lines": 0, "size": 0}``\n\n    Returns\n    -------\n    dict\n        Error envelope with:\n\n        - All fields from ``empty_result`` (empty/zero values)\n        - ``error: str`` - Human-readable error message\n        - ``problem: ProblemDetails`` - RFC 9457 Problem Details with type,\n          title, status, detail, instance, code, and optional extensions\n\n    Notes\n    -----\n    Exception Mapping:\n\n    - **KgFoundryError**: Uses ``to_problem_details()`` method. HTTP status,\n      error code, and context from exception fields. Logged at exception\'s\n      log_level with structured context.\n    - **FileNotFoundError**: 404 Not Found, code "file-not-found". Logged\n      at WARNING level.\n    - **UnicodeDecodeError**: 415 Unsupported Media Type, code\n      "unsupported-encoding". Encoding and reason in extensions. Logged at\n      WARNING level.\n    - **ValueError**: 400 Bad Request, code "invalid-parameter". Logged at\n      WARNING level.\n    - **Unknown exceptions**: 500 Internal Server Error, code "internal-error".\n      Exception type in extensions. Logged at EXCEPTION level (includes stack\n      trace).\n\n    Structured Logging:\n\n    All exceptions are logged with structured context:\n\n    - KgFoundryError: ``operation``, ``error_code``, ``component``\n    - Builtin exceptions: ``operation``, ``component``, ``error``\n    - Unknown exceptions: ``operation``, ``component``, ``exception_type``\n\n    Examples\n    --------\n    Convert FileNotFoundError:\n\n    >>> exc = FileNotFoundError("File not found: src/main.py")\n    >>> envelope = convert_exception_to_envelope(\n    ...     exc,\n    ...     operation="files:open_file",\n    ...     empty_result={"path": "", "content": "", "lines": 0, "size": 0},\n    ... )\n    >>> envelope["error"]\n    \'File not found: src/main.py\'\n    >>> envelope["problem"]["status"]\n    404\n    >>> envelope["problem"]["code"]\n    \'file-not-found\'\n    >>> envelope["path"]\n    \'\'\n\n    Convert KgFoundryError with context:\n\n    >>> from kgfoundry_common.errors import VectorSearchError\n    >>> exc = VectorSearchError("Search timeout", context={"query": "def main"})\n    >>> envelope = convert_exception_to_envelope(\n    ...     exc, operation="search:text", empty_result={"matches": [], "total": 0}\n    ... )\n    >>> envelope["problem"]["extensions"]["query"]\n    \'def main\'\n    ', lineno=78, col_offset=4, end_lineno=170, end_col_offset=7), lineno=78, col_offset=4, end_lineno=170, end_col_offset=7), AnnAssign(target=Name(id='problem', ctx=Store(), lineno=171, col_offset=4, end_lineno=171, end_col_offset=11), annotation=Name(id='ProblemDetails', ctx=Load(), lineno=171, col_offset=13, end_lineno=171, end_col_offset=27), simple=1, lineno=171, col_offset=4, end_lineno=171, end_col_offset=27), If(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=174, col_offset=7, end_lineno=174, end_col_offset=17), args=[Name(id='exc', ctx=Load(), lineno=174, col_offset=18, end_lineno=174, end_col_offset=21), Name(id='KgFoundryError', ctx=Load(), lineno=174, col_offset=23, end_lineno=174, end_col_offset=37)], lineno=174, col_offset=7, end_lineno=174, end_col_offset=38), body=[Assign(targets=[Name(id='problem', ctx=Store(), lineno=175, col_offset=8, end_lineno=175, end_col_offset=15)], value=Call(func=Attribute(value=Name(id='exc', ctx=Load(), lineno=175, col_offset=18, end_lineno=175, end_col_offset=21), attr='to_problem_details', ctx=Load(), lineno=175, col_offset=18, end_lineno=175, end_col_offset=40), keywords=[keyword(arg='instance', value=Name(id='operation', ctx=Load(), lineno=175, col_offset=50, end_lineno=175, end_col_offset=59), lineno=175, col_offset=41, end_lineno=175, end_col_offset=59)], lineno=175, col_offset=18, end_lineno=175, end_col_offset=60), lineno=175, col_offset=8, end_lineno=175, end_col_offset=60), With(items=[withitem(context_expr=Call(func=Name(id='with_fields', ctx=Load(), lineno=176, col_offset=13, end_lineno=176, end_col_offset=24), args=[Name(id='LOGGER', ctx=Load(), lineno=177, col_offset=12, end_lineno=177, end_col_offset=18)], keywords=[keyword(arg='component', value=Name(id='COMPONENT_NAME', ctx=Load(), lineno=178, col_offset=22, end_lineno=178, end_col_offset=36), lineno=178, col_offset=12, end_lineno=178, end_col_offset=36), keyword(arg='operation', value=Name(id='operation', ctx=Load(), lineno=179, col_offset=22, end_lineno=179, end_col_offset=31), lineno=179, col_offset=12, end_lineno=179, end_col_offset=31), keyword(arg='error_code', value=Attribute(value=Attribute(value=Name(id='exc', ctx=Load(), lineno=180, col_offset=23, end_lineno=180, end_col_offset=26), attr='code', ctx=Load(), lineno=180, col_offset=23, end_lineno=180, end_col_offset=31), attr='value', ctx=Load(), lineno=180, col_offset=23, end_lineno=180, end_col_offset=37), lineno=180, col_offset=12, end_lineno=180, end_col_offset=37)], lineno=176, col_offset=13, end_lineno=181, end_col_offset=9), optional_vars=Name(id='adapter', ctx=Store(), lineno=181, col_offset=13, end_lineno=181, end_col_offset=20))], body=[Expr(value=Call(func=Attribute(value=Name(id='adapter', ctx=Load(), lineno=182, col_offset=12, end_lineno=182, end_col_offset=19), attr='log', ctx=Load(), lineno=182, col_offset=12, end_lineno=182, end_col_offset=23), args=[Attribute(value=Name(id='exc', ctx=Load(), lineno=182, col_offset=24, end_lineno=182, end_col_offset=27), attr='log_level', ctx=Load(), lineno=182, col_offset=24, end_lineno=182, end_col_offset=37), Attribute(value=Name(id='exc', ctx=Load(), lineno=182, col_offset=39, end_lineno=182, end_col_offset=42), attr='message', ctx=Load(), lineno=182, col_offset=39, end_lineno=182, end_col_offset=50)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='context', lineno=182, col_offset=59, end_lineno=182, end_col_offset=68)], values=[Attribute(value=Name(id='exc', ctx=Load(), lineno=182, col_offset=70, end_lineno=182, end_col_offset=73), attr='context', ctx=Load(), lineno=182, col_offset=70, end_lineno=182, end_col_offset=81)], lineno=182, col_offset=58, end_lineno=182, end_col_offset=82), lineno=182, col_offset=52, end_lineno=182, end_col_offset=82)], lineno=182, col_offset=12, end_lineno=182, end_col_offset=83), lineno=182, col_offset=12, end_lineno=182, end_col_offset=83)], lineno=176, col_offset=8, end_lineno=182, end_col_offset=83)], orelse=[If(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=185, col_offset=9, end_lineno=185, end_col_offset=19), args=[Name(id='exc', ctx=Load(), lineno=185, col_offset=20, end_lineno=185, end_col_offset=23), Name(id='FileNotFoundError', ctx=Load(), lineno=185, col_offset=25, end_lineno=185, end_col_offset=42)], lineno=185, col_offset=9, end_lineno=185, end_col_offset=43), body=[Assign(targets=[Name(id='problem', ctx=Store(), lineno=186, col_offset=8, end_lineno=186, end_col_offset=15)], value=Call(func=Name(id='build_problem_details', ctx=Load(), lineno=186, col_offset=18, end_lineno=186, end_col_offset=39), keywords=[keyword(arg='problem_type', value=Constant(value='https://kgfoundry.dev/problems/file-not-found', lineno=187, col_offset=25, end_lineno=187, end_col_offset=72), lineno=187, col_offset=12, end_lineno=187, end_col_offset=72), keyword(arg='title', value=Constant(value='File Not Found', lineno=188, col_offset=18, end_lineno=188, end_col_offset=34), lineno=188, col_offset=12, end_lineno=188, end_col_offset=34), keyword(arg='status', value=Constant(value=404, lineno=189, col_offset=19, end_lineno=189, end_col_offset=22), lineno=189, col_offset=12, end_lineno=189, end_col_offset=22), keyword(arg='detail', value=Call(func=Name(id='str', ctx=Load(), lineno=190, col_offset=19, end_lineno=190, end_col_offset=22), args=[Name(id='exc', ctx=Load(), lineno=190, col_offset=23, end_lineno=190, end_col_offset=26)], lineno=190, col_offset=19, end_lineno=190, end_col_offset=27), lineno=190, col_offset=12, end_lineno=190, end_col_offset=27), keyword(arg='instance', value=Name(id='operation', ctx=Load(), lineno=191, col_offset=21, end_lineno=191, end_col_offset=30), lineno=191, col_offset=12, end_lineno=191, end_col_offset=30), keyword(arg='code', value=Constant(value='file-not-found', lineno=192, col_offset=17, end_lineno=192, end_col_offset=33), lineno=192, col_offset=12, end_lineno=192, end_col_offset=33)], lineno=186, col_offset=18, end_lineno=193, end_col_offset=9), lineno=186, col_offset=8, end_lineno=193, end_col_offset=9), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=194, col_offset=8, end_lineno=194, end_col_offset=14), attr='warning', ctx=Load(), lineno=194, col_offset=8, end_lineno=194, end_col_offset=22), args=[Constant(value='File not found', lineno=195, col_offset=12, end_lineno=195, end_col_offset=28)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='component', lineno=197, col_offset=16, end_lineno=197, end_col_offset=27), Constant(value='operation', lineno=198, col_offset=16, end_lineno=198, end_col_offset=27), Constant(value='error', lineno=199, col_offset=16, end_lineno=199, end_col_offset=23)], values=[Name(id='COMPONENT_NAME', ctx=Load(), lineno=197, col_offset=29, end_lineno=197, end_col_offset=43), Name(id='operation', ctx=Load(), lineno=198, col_offset=29, end_lineno=198, end_col_offset=38), Call(func=Name(id='str', ctx=Load(), lineno=199, col_offset=25, end_lineno=199, end_col_offset=28), args=[Name(id='exc', ctx=Load(), lineno=199, col_offset=29, end_lineno=199, end_col_offset=32)], lineno=199, col_offset=25, end_lineno=199, end_col_offset=33)], lineno=196, col_offset=18, end_lineno=200, end_col_offset=13), lineno=196, col_offset=12, end_lineno=200, end_col_offset=13)], lineno=194, col_offset=8, end_lineno=201, end_col_offset=9), lineno=194, col_offset=8, end_lineno=201, end_col_offset=9)], orelse=[If(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=204, col_offset=9, end_lineno=204, end_col_offset=19), args=[Name(id='exc', ctx=Load(), lineno=204, col_offset=20, end_lineno=204, end_col_offset=23), Name(id='UnicodeDecodeError', ctx=Load(), lineno=204, col_offset=25, end_lineno=204, end_col_offset=43)], lineno=204, col_offset=9, end_lineno=204, end_col_offset=44), body=[Assign(targets=[Name(id='problem', ctx=Store(), lineno=205, col_offset=8, end_lineno=205, end_col_offset=15)], value=Call(func=Name(id='build_problem_details', ctx=Load(), lineno=205, col_offset=18, end_lineno=205, end_col_offset=39), keywords=[keyword(arg='problem_type', value=Constant(value='https://kgfoundry.dev/problems/unsupported-encoding', lineno=206, col_offset=25, end_lineno=206, end_col_offset=78), lineno=206, col_offset=12, end_lineno=206, end_col_offset=78), keyword(arg='title', value=Constant(value='Unsupported Encoding', lineno=207, col_offset=18, end_lineno=207, end_col_offset=40), lineno=207, col_offset=12, end_lineno=207, end_col_offset=40), keyword(arg='status', value=Constant(value=415, lineno=208, col_offset=19, end_lineno=208, end_col_offset=22), lineno=208, col_offset=12, end_lineno=208, end_col_offset=22), keyword(arg='detail', value=JoinedStr(values=[Constant(value='Binary file or encoding error: ', lineno=209, col_offset=21, end_lineno=209, end_col_offset=52), FormattedValue(value=Attribute(value=Name(id='exc', ctx=Load(), lineno=209, col_offset=53, end_lineno=209, end_col_offset=56), attr='reason', ctx=Load(), lineno=209, col_offset=53, end_lineno=209, end_col_offset=63), conversion=-1, lineno=209, col_offset=52, end_lineno=209, end_col_offset=64)], lineno=209, col_offset=19, end_lineno=209, end_col_offset=65), lineno=209, col_offset=12, end_lineno=209, end_col_offset=65), keyword(arg='instance', value=Name(id='operation', ctx=Load(), lineno=210, col_offset=21, end_lineno=210, end_col_offset=30), lineno=210, col_offset=12, end_lineno=210, end_col_offset=30), keyword(arg='code', value=Constant(value='unsupported-encoding', lineno=211, col_offset=17, end_lineno=211, end_col_offset=39), lineno=211, col_offset=12, end_lineno=211, end_col_offset=39), keyword(arg='extensions', value=Dict(keys=[Constant(value='encoding', lineno=212, col_offset=24, end_lineno=212, end_col_offset=34), Constant(value='reason', lineno=212, col_offset=50, end_lineno=212, end_col_offset=58)], values=[Attribute(value=Name(id='exc', ctx=Load(), lineno=212, col_offset=36, end_lineno=212, end_col_offset=39), attr='encoding', ctx=Load(), lineno=212, col_offset=36, end_lineno=212, end_col_offset=48), Attribute(value=Name(id='exc', ctx=Load(), lineno=212, col_offset=60, end_lineno=212, end_col_offset=63), attr='reason', ctx=Load(), lineno=212, col_offset=60, end_lineno=212, end_col_offset=70)], lineno=212, col_offset=23, end_lineno=212, end_col_offset=71), lineno=212, col_offset=12, end_lineno=212, end_col_offset=71)], lineno=205, col_offset=18, end_lineno=213, end_col_offset=9), lineno=205, col_offset=8, end_lineno=213, end_col_offset=9), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=214, col_offset=8, end_lineno=214, end_col_offset=14), attr='warning', ctx=Load(), lineno=214, col_offset=8, end_lineno=214, end_col_offset=22), args=[Constant(value='Encoding error', lineno=215, col_offset=12, end_lineno=215, end_col_offset=28)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='component', lineno=217, col_offset=16, end_lineno=217, end_col_offset=27), Constant(value='operation', lineno=218, col_offset=16, end_lineno=218, end_col_offset=27), Constant(value='encoding', lineno=219, col_offset=16, end_lineno=219, end_col_offset=26), Constant(value='reason', lineno=220, col_offset=16, end_lineno=220, end_col_offset=24)], values=[Name(id='COMPONENT_NAME', ctx=Load(), lineno=217, col_offset=29, end_lineno=217, end_col_offset=43), Name(id='operation', ctx=Load(), lineno=218, col_offset=29, end_lineno=218, end_col_offset=38), Attribute(value=Name(id='exc', ctx=Load(), lineno=219, col_offset=28, end_lineno=219, end_col_offset=31), attr='encoding', ctx=Load(), lineno=219, col_offset=28, end_lineno=219, end_col_offset=40), Attribute(value=Name(id='exc', ctx=Load(), lineno=220, col_offset=26, end_lineno=220, end_col_offset=29), attr='reason', ctx=Load(), lineno=220, col_offset=26, end_lineno=220, end_col_offset=36)], lineno=216, col_offset=18, end_lineno=221, end_col_offset=13), lineno=216, col_offset=12, end_lineno=221, end_col_offset=13)], lineno=214, col_offset=8, end_lineno=222, end_col_offset=9), lineno=214, col_offset=8, end_lineno=222, end_col_offset=9)], orelse=[If(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=225, col_offset=9, end_lineno=225, end_col_offset=19), args=[Name(id='exc', ctx=Load(), lineno=225, col_offset=20, end_lineno=225, end_col_offset=23), Name(id='ValueError', ctx=Load(), lineno=225, col_offset=25, end_lineno=225, end_col_offset=35)], lineno=225, col_offset=9, end_lineno=225, end_col_offset=36), body=[Assign(targets=[Name(id='problem', ctx=Store(), lineno=226, col_offset=8, end_lineno=226, end_col_offset=15)], value=Call(func=Name(id='build_problem_details', ctx=Load(), lineno=226, col_offset=18, end_lineno=226, end_col_offset=39), keywords=[keyword(arg='problem_type', value=Constant(value='https://kgfoundry.dev/problems/invalid-parameter', lineno=227, col_offset=25, end_lineno=227, end_col_offset=75), lineno=227, col_offset=12, end_lineno=227, end_col_offset=75), keyword(arg='title', value=Constant(value='Invalid Parameter', lineno=228, col_offset=18, end_lineno=228, end_col_offset=37), lineno=228, col_offset=12, end_lineno=228, end_col_offset=37), keyword(arg='status', value=Constant(value=400, lineno=229, col_offset=19, end_lineno=229, end_col_offset=22), lineno=229, col_offset=12, end_lineno=229, end_col_offset=22), keyword(arg='detail', value=Call(func=Name(id='str', ctx=Load(), lineno=230, col_offset=19, end_lineno=230, end_col_offset=22), args=[Name(id='exc', ctx=Load(), lineno=230, col_offset=23, end_lineno=230, end_col_offset=26)], lineno=230, col_offset=19, end_lineno=230, end_col_offset=27), lineno=230, col_offset=12, end_lineno=230, end_col_offset=27), keyword(arg='instance', value=Name(id='operation', ctx=Load(), lineno=231, col_offset=21, end_lineno=231, end_col_offset=30), lineno=231, col_offset=12, end_lineno=231, end_col_offset=30), keyword(arg='code', value=Constant(value='invalid-parameter', lineno=232, col_offset=17, end_lineno=232, end_col_offset=36), lineno=232, col_offset=12, end_lineno=232, end_col_offset=36)], lineno=226, col_offset=18, end_lineno=233, end_col_offset=9), lineno=226, col_offset=8, end_lineno=233, end_col_offset=9), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=234, col_offset=8, end_lineno=234, end_col_offset=14), attr='warning', ctx=Load(), lineno=234, col_offset=8, end_lineno=234, end_col_offset=22), args=[Constant(value='Invalid parameter', lineno=235, col_offset=12, end_lineno=235, end_col_offset=31)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='component', lineno=237, col_offset=16, end_lineno=237, end_col_offset=27), Constant(value='operation', lineno=238, col_offset=16, end_lineno=238, end_col_offset=27), Constant(value='error', lineno=239, col_offset=16, end_lineno=239, end_col_offset=23)], values=[Name(id='COMPONENT_NAME', ctx=Load(), lineno=237, col_offset=29, end_lineno=237, end_col_offset=43), Name(id='operation', ctx=Load(), lineno=238, col_offset=29, end_lineno=238, end_col_offset=38), Call(func=Name(id='str', ctx=Load(), lineno=239, col_offset=25, end_lineno=239, end_col_offset=28), args=[Name(id='exc', ctx=Load(), lineno=239, col_offset=29, end_lineno=239, end_col_offset=32)], lineno=239, col_offset=25, end_lineno=239, end_col_offset=33)], lineno=236, col_offset=18, end_lineno=240, end_col_offset=13), lineno=236, col_offset=12, end_lineno=240, end_col_offset=13)], lineno=234, col_offset=8, end_lineno=241, end_col_offset=9), lineno=234, col_offset=8, end_lineno=241, end_col_offset=9)], orelse=[Assign(targets=[Name(id='problem', ctx=Store(), lineno=246, col_offset=8, end_lineno=246, end_col_offset=15)], value=Call(func=Name(id='build_problem_details', ctx=Load(), lineno=246, col_offset=18, end_lineno=246, end_col_offset=39), keywords=[keyword(arg='problem_type', value=Constant(value='https://kgfoundry.dev/problems/internal-error', lineno=247, col_offset=25, end_lineno=247, end_col_offset=72), lineno=247, col_offset=12, end_lineno=247, end_col_offset=72), keyword(arg='title', value=Constant(value='Internal Error', lineno=248, col_offset=18, end_lineno=248, end_col_offset=34), lineno=248, col_offset=12, end_lineno=248, end_col_offset=34), keyword(arg='status', value=Constant(value=500, lineno=249, col_offset=19, end_lineno=249, end_col_offset=22), lineno=249, col_offset=12, end_lineno=249, end_col_offset=22), keyword(arg='detail', value=Call(func=Name(id='str', ctx=Load(), lineno=250, col_offset=19, end_lineno=250, end_col_offset=22), args=[Name(id='exc', ctx=Load(), lineno=250, col_offset=23, end_lineno=250, end_col_offset=26)], lineno=250, col_offset=19, end_lineno=250, end_col_offset=27), lineno=250, col_offset=12, end_lineno=250, end_col_offset=27), keyword(arg='instance', value=Name(id='operation', ctx=Load(), lineno=251, col_offset=21, end_lineno=251, end_col_offset=30), lineno=251, col_offset=12, end_lineno=251, end_col_offset=30), keyword(arg='code', value=Constant(value='internal-error', lineno=252, col_offset=17, end_lineno=252, end_col_offset=33), lineno=252, col_offset=12, end_lineno=252, end_col_offset=33), keyword(arg='extensions', value=Dict(keys=[Constant(value='exception_type', lineno=253, col_offset=24, end_lineno=253, end_col_offset=40)], values=[Attribute(value=Call(func=Name(id='type', ctx=Load(), lineno=253, col_offset=42, end_lineno=253, end_col_offset=46), args=[Name(id='exc', ctx=Load(), lineno=253, col_offset=47, end_lineno=253, end_col_offset=50)], lineno=253, col_offset=42, end_lineno=253, end_col_offset=51), attr='__name__', ctx=Load(), lineno=253, col_offset=42, end_lineno=253, end_col_offset=60)], lineno=253, col_offset=23, end_lineno=253, end_col_offset=61), lineno=253, col_offset=12, end_lineno=253, end_col_offset=61)], lineno=246, col_offset=18, end_lineno=254, end_col_offset=9), lineno=246, col_offset=8, end_lineno=254, end_col_offset=9), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=255, col_offset=8, end_lineno=255, end_col_offset=14), attr='error', ctx=Load(), lineno=255, col_offset=8, end_lineno=255, end_col_offset=20), args=[Constant(value='Unexpected error', lineno=256, col_offset=12, end_lineno=256, end_col_offset=30)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='component', lineno=258, col_offset=16, end_lineno=258, end_col_offset=27), Constant(value='operation', lineno=259, col_offset=16, end_lineno=259, end_col_offset=27), Constant(value='exception_type', lineno=260, col_offset=16, end_lineno=260, end_col_offset=32)], values=[Name(id='COMPONENT_NAME', ctx=Load(), lineno=258, col_offset=29, end_lineno=258, end_col_offset=43), Name(id='operation', ctx=Load(), lineno=259, col_offset=29, end_lineno=259, end_col_offset=38), Attribute(value=Call(func=Name(id='type', ctx=Load(), lineno=260, col_offset=34, end_lineno=260, end_col_offset=38), args=[Name(id='exc', ctx=Load(), lineno=260, col_offset=39, end_lineno=260, end_col_offset=42)], lineno=260, col_offset=34, end_lineno=260, end_col_offset=43), attr='__name__', ctx=Load(), lineno=260, col_offset=34, end_lineno=260, end_col_offset=52)], lineno=257, col_offset=18, end_lineno=261, end_col_offset=13), lineno=257, col_offset=12, end_lineno=261, end_col_offset=13)], lineno=255, col_offset=8, end_lineno=262, end_col_offset=9), lineno=255, col_offset=8, end_lineno=262, end_col_offset=9)], lineno=225, col_offset=4, end_lineno=262, end_col_offset=9)], lineno=204, col_offset=4, end_lineno=262, end_col_offset=9)], lineno=185, col_offset=4, end_lineno=262, end_col_offset=9)], lineno=174, col_offset=4, end_lineno=262, end_col_offset=9), Assign(targets=[Name(id='envelope', ctx=Store(), lineno=265, col_offset=4, end_lineno=265, end_col_offset=12)], value=Call(func=Name(id='dict', ctx=Load(), lineno=265, col_offset=15, end_lineno=265, end_col_offset=19), args=[Name(id='empty_result', ctx=Load(), lineno=265, col_offset=20, end_lineno=265, end_col_offset=32)], lineno=265, col_offset=15, end_lineno=265, end_col_offset=33), lineno=265, col_offset=4, end_lineno=265, end_col_offset=33), Assign(targets=[Subscript(value=Name(id='envelope', ctx=Load(), lineno=266, col_offset=4, end_lineno=266, end_col_offset=12), slice=Constant(value='error', lineno=266, col_offset=13, end_lineno=266, end_col_offset=20), ctx=Store(), lineno=266, col_offset=4, end_lineno=266, end_col_offset=21)], value=Subscript(value=Name(id='problem', ctx=Load(), lineno=266, col_offset=24, end_lineno=266, end_col_offset=31), slice=Constant(value='detail', lineno=266, col_offset=32, end_lineno=266, end_col_offset=40), ctx=Load(), lineno=266, col_offset=24, end_lineno=266, end_col_offset=41), lineno=266, col_offset=4, end_lineno=266, end_col_offset=41), Assign(targets=[Subscript(value=Name(id='envelope', ctx=Load(), lineno=267, col_offset=4, end_lineno=267, end_col_offset=12), slice=Constant(value='problem', lineno=267, col_offset=13, end_lineno=267, end_col_offset=22), ctx=Store(), lineno=267, col_offset=4, end_lineno=267, end_col_offset=23)], value=Name(id='problem', ctx=Load(), lineno=267, col_offset=26, end_lineno=267, end_col_offset=33), lineno=267, col_offset=4, end_lineno=267, end_col_offset=33), Return(value=Name(id='envelope', ctx=Load(), lineno=269, col_offset=11, end_lineno=269, end_col_offset=19), lineno=269, col_offset=4, end_lineno=269, end_col_offset=19)], returns=Name(id='dict', ctx=Load(), lineno=77, col_offset=5, end_lineno=77, end_col_offset=9), lineno=73, col_offset=0, end_lineno=269, end_col_offset=19), FunctionDef(name='handle_adapter_errors', args=arguments(kwonlyargs=[arg(arg='operation', annotation=Name(id='str', ctx=Load(), lineno=274, col_offset=15, end_lineno=274, end_col_offset=18), lineno=274, col_offset=4, end_lineno=274, end_col_offset=18), arg(arg='empty_result', annotation=Subscript(value=Name(id='Mapping', ctx=Load(), lineno=275, col_offset=18, end_lineno=275, end_col_offset=25), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=275, col_offset=26, end_lineno=275, end_col_offset=29), Name(id='object', ctx=Load(), lineno=275, col_offset=31, end_lineno=275, end_col_offset=37)], ctx=Load(), lineno=275, col_offset=26, end_lineno=275, end_col_offset=37), ctx=Load(), lineno=275, col_offset=18, end_lineno=275, end_col_offset=38), lineno=275, col_offset=4, end_lineno=275, end_col_offset=38)], kw_defaults=[None, None]), body=[Expr(value=Constant(value='Convert adapter exceptions to unified error envelopes.\n\n    This decorator is applied to all MCP tool functions to provide automatic\n    error handling. It catches all exceptions raised by adapters and converts\n    them to consistent error envelopes with Problem Details.\n\n    The decorator:\n\n    1. Catches ALL exceptions (no exception escapes)\n    2. Converts exception → Problem Details → error envelope\n    3. Logs with structured context (operation, error_code, etc.)\n    4. Returns error envelope (does not re-raise)\n    5. Preserves function signature (important for FastMCP schema generation)\n\n    Parameters\n    ----------\n    operation : str\n        Operation identifier in format "category:operation". Examples:\n\n        - "files:open_file"\n        - "files:list_paths"\n        - "search:text"\n        - "search:semantic"\n        - "git:blame_range"\n        - "git:file_history"\n\n        Used for Problem Details instance field and structured logging.\n    empty_result : Mapping[str, object]\n        Tool-specific result fields with empty/zero values. These are merged\n        into the error envelope so clients always see the same field structure\n        (just with empty values on error).\n\n    Examples\n    --------\n        - open_file: ``{"path": "", "content": "", "lines": 0, "size": 0}``\n        - list_paths: ``{"items": [], "total": 0, "truncated": False}``\n        - blame_range: ``{"blame": []}``\n        - file_history: ``{"commits": []}``\n        - search_text: ``{"matches": [], "total": 0, "truncated": False}``\n        - semantic_search: ``{"findings": [], "answer": "", "confidence": 0.0}``\n\n    Returns\n    -------\n    Callable[[F], F]\n        Decorator function that wraps the adapter call in try/except and\n        converts exceptions to error envelopes. Preserves the function type\n        signature ``F``.\n\n    Notes\n    -----\n    Decorator Order:\n\n    The decorator MUST be applied AFTER ``@mcp.tool()`` so FastMCP sees the\n    unwrapped function signature for JSON Schema generation:\n\n    .. code-block:: python\n\n        @mcp.tool()  # FIRST\n        @handle_adapter_errors(...)  # SECOND\n        def my_tool(...):\n            ...\n\n    Function Signature Preservation:\n\n    The decorator uses ``functools.wraps`` to preserve the function\'s\n    ``__name__``, ``__doc__``, and ``__annotations__``. This is critical for\n    FastMCP\'s automatic JSON Schema generation.\n\n    Async Function Compatibility:\n\n    The decorator works with both sync and async functions. Async functions\n    should use ``async def`` and the decorator will properly await the result.\n\n    Examples\n    --------\n    Sync function:\n\n    >>> @mcp.tool()\n    >>> @handle_adapter_errors(\n    ...     operation="files:open_file",\n    ...     empty_result={"path": "", "content": "", "lines": 0, "size": 0},\n    ... )\n    ... def open_file(path: str, start_line: int | None, end_line: int | None) -> dict:\n    ...     context = get_context()\n    ...     return files_adapter.open_file(context, path, start_line, end_line)\n\n    Async function:\n\n    >>> @mcp.tool()\n    >>> @handle_adapter_errors(operation="git:blame_range", empty_result={"blame": []})\n    ... async def blame_range(path: str, start_line: int, end_line: int) -> dict:\n    ...     context = get_context()\n    ...     return await history_adapter.blame_range(context, path, start_line, end_line)\n\n    Success case (no exception):\n\n    >>> @handle_adapter_errors(operation="test", empty_result={"value": 0})\n    ... def func():\n    ...     return {"value": 42}\n    >>> result = func()\n    >>> result\n    {\'value\': 42}\n\n    Error case (exception raised):\n\n    >>> @handle_adapter_errors(operation="test", empty_result={"value": 0})\n    ... def func():\n    ...     raise FileNotFoundError("File not found")\n    >>> result = func()\n    >>> result["error"]\n    \'File not found\'\n    >>> result["problem"]["status"]\n    404\n    >>> result["value"]\n    0\n    ', lineno=277, col_offset=4, end_lineno=392, end_col_offset=7), lineno=277, col_offset=4, end_lineno=392, end_col_offset=7), FunctionDef(name='decorator', args=arguments(args=[arg(arg='func', annotation=Name(id='F', ctx=Load(), lineno=394, col_offset=24, end_lineno=394, end_col_offset=25), lineno=394, col_offset=18, end_lineno=394, end_col_offset=25)]), body=[FunctionDef(name='wrapper', args=arguments(vararg=arg(arg='args', annotation=Name(id='object', ctx=Load(), lineno=396, col_offset=27, end_lineno=396, end_col_offset=33), lineno=396, col_offset=21, end_lineno=396, end_col_offset=33), kwarg=arg(arg='kwargs', annotation=Name(id='object', ctx=Load(), lineno=396, col_offset=45, end_lineno=396, end_col_offset=51), lineno=396, col_offset=37, end_lineno=396, end_col_offset=51)), body=[Try(body=[Return(value=Call(func=Name(id='func', ctx=Load(), lineno=398, col_offset=23, end_lineno=398, end_col_offset=27), args=[Starred(value=Name(id='args', ctx=Load(), lineno=398, col_offset=29, end_lineno=398, end_col_offset=33), ctx=Load(), lineno=398, col_offset=28, end_lineno=398, end_col_offset=33)], keywords=[keyword(value=Name(id='kwargs', ctx=Load(), lineno=398, col_offset=37, end_lineno=398, end_col_offset=43), lineno=398, col_offset=35, end_lineno=398, end_col_offset=43)], lineno=398, col_offset=23, end_lineno=398, end_col_offset=44), lineno=398, col_offset=16, end_lineno=398, end_col_offset=44)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='KeyboardInterrupt', ctx=Load(), lineno=399, col_offset=20, end_lineno=399, end_col_offset=37), Name(id='SystemExit', ctx=Load(), lineno=399, col_offset=39, end_lineno=399, end_col_offset=49), Name(id='GeneratorExit', ctx=Load(), lineno=399, col_offset=51, end_lineno=399, end_col_offset=64)], ctx=Load(), lineno=399, col_offset=19, end_lineno=399, end_col_offset=65), body=[Raise(lineno=401, col_offset=16, end_lineno=401, end_col_offset=21)], lineno=399, col_offset=12, end_lineno=401, end_col_offset=21), ExceptHandler(type=Tuple(elts=[Name(id='ValueError', ctx=Load(), lineno=403, col_offset=16, end_lineno=403, end_col_offset=26), Name(id='TypeError', ctx=Load(), lineno=404, col_offset=16, end_lineno=404, end_col_offset=25), Name(id='AttributeError', ctx=Load(), lineno=405, col_offset=16, end_lineno=405, end_col_offset=30), Name(id='KeyError', ctx=Load(), lineno=406, col_offset=16, end_lineno=406, end_col_offset=24), Name(id='IndexError', ctx=Load(), lineno=407, col_offset=16, end_lineno=407, end_col_offset=26), Name(id='FileNotFoundError', ctx=Load(), lineno=408, col_offset=16, end_lineno=408, end_col_offset=33), Name(id='PermissionError', ctx=Load(), lineno=409, col_offset=16, end_lineno=409, end_col_offset=31), Name(id='OSError', ctx=Load(), lineno=410, col_offset=16, end_lineno=410, end_col_offset=23), Name(id='RuntimeError', ctx=Load(), lineno=411, col_offset=16, end_lineno=411, end_col_offset=28), Name(id='NotImplementedError', ctx=Load(), lineno=412, col_offset=16, end_lineno=412, end_col_offset=35), Name(id='UnicodeDecodeError', ctx=Load(), lineno=413, col_offset=16, end_lineno=413, end_col_offset=34), Name(id='LookupError', ctx=Load(), lineno=414, col_offset=16, end_lineno=414, end_col_offset=27), Name(id='ArithmeticError', ctx=Load(), lineno=415, col_offset=16, end_lineno=415, end_col_offset=31), Name(id='ReferenceError', ctx=Load(), lineno=416, col_offset=16, end_lineno=416, end_col_offset=30)], ctx=Load(), lineno=402, col_offset=19, end_lineno=417, end_col_offset=13), name='exc', body=[Return(value=Call(func=Name(id='convert_exception_to_envelope', ctx=Load(), lineno=420, col_offset=23, end_lineno=420, end_col_offset=52), args=[Name(id='exc', ctx=Load(), lineno=420, col_offset=53, end_lineno=420, end_col_offset=56), Name(id='operation', ctx=Load(), lineno=420, col_offset=58, end_lineno=420, end_col_offset=67), Name(id='empty_result', ctx=Load(), lineno=420, col_offset=69, end_lineno=420, end_col_offset=81)], lineno=420, col_offset=23, end_lineno=420, end_col_offset=82), lineno=420, col_offset=16, end_lineno=420, end_col_offset=82)], lineno=402, col_offset=12, end_lineno=420, end_col_offset=82)], lineno=397, col_offset=12, end_lineno=420, end_col_offset=82)], decorator_list=[Call(func=Name(id='wraps', ctx=Load(), lineno=395, col_offset=9, end_lineno=395, end_col_offset=14), args=[Name(id='func', ctx=Load(), lineno=395, col_offset=15, end_lineno=395, end_col_offset=19)], lineno=395, col_offset=9, end_lineno=395, end_col_offset=20)], returns=Name(id='dict', ctx=Load(), lineno=396, col_offset=56, end_lineno=396, end_col_offset=60), lineno=396, col_offset=8, end_lineno=420, end_col_offset=82), Return(value=Call(func=Name(id='cast', ctx=Load(), lineno=422, col_offset=15, end_lineno=422, end_col_offset=19), args=[Constant(value='F', lineno=422, col_offset=20, end_lineno=422, end_col_offset=23), Name(id='wrapper', ctx=Load(), lineno=422, col_offset=25, end_lineno=422, end_col_offset=32)], lineno=422, col_offset=15, end_lineno=422, end_col_offset=33), lineno=422, col_offset=8, end_lineno=422, end_col_offset=33)], returns=Name(id='F', ctx=Load(), lineno=394, col_offset=30, end_lineno=394, end_col_offset=31), lineno=394, col_offset=4, end_lineno=422, end_col_offset=33), Return(value=Name(id='decorator', ctx=Load(), lineno=424, col_offset=11, end_lineno=424, end_col_offset=20), lineno=424, col_offset=4, end_lineno=424, end_col_offset=20)], returns=Subscript(value=Name(id='Callable', ctx=Load(), lineno=276, col_offset=5, end_lineno=276, end_col_offset=13), slice=Tuple(elts=[List(elts=[Name(id='F', ctx=Load(), lineno=276, col_offset=15, end_lineno=276, end_col_offset=16)], ctx=Load(), lineno=276, col_offset=14, end_lineno=276, end_col_offset=17), Name(id='F', ctx=Load(), lineno=276, col_offset=19, end_lineno=276, end_col_offset=20)], ctx=Load(), lineno=276, col_offset=14, end_lineno=276, end_col_offset=20), ctx=Load(), lineno=276, col_offset=5, end_lineno=276, end_col_offset=21), lineno=272, col_offset=0, end_lineno=424, end_col_offset=20), Assign(targets=[Name(id='__all__', ctx=Store(), lineno=427, col_offset=0, end_lineno=427, end_col_offset=7)], value=List(elts=[Constant(value='convert_exception_to_envelope', lineno=428, col_offset=4, end_lineno=428, end_col_offset=35), Constant(value='handle_adapter_errors', lineno=429, col_offset=4, end_lineno=429, end_col_offset=27)], ctx=Load(), lineno=427, col_offset=10, end_lineno=430, end_col_offset=1), lineno=427, col_offset=0, end_lineno=430, end_col_offset=1)])