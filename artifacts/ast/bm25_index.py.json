Module(body=[Expr(value=Constant(value='Overview of bm25 index.\n\nThis module bundles bm25 index logic for the kgfoundry stack. It groups related helpers so\ndownstream packages can import a single cohesive namespace. Refer to the functions and classes below\nfor implementation specifics.\n', lineno=1, col_offset=0, end_lineno=6, end_col_offset=3), lineno=1, col_offset=0, end_lineno=6, end_col_offset=3), ImportFrom(module='__future__', names=[alias(name='annotations', lineno=10, col_offset=23, end_lineno=10, end_col_offset=34)], level=0, lineno=10, col_offset=0, end_lineno=10, end_col_offset=34), Import(names=[alias(name='math', lineno=12, col_offset=7, end_lineno=12, end_col_offset=11)], lineno=12, col_offset=0, end_lineno=12, end_col_offset=11), Import(names=[alias(name='os', lineno=13, col_offset=7, end_lineno=13, end_col_offset=9)], lineno=13, col_offset=0, end_lineno=13, end_col_offset=9), Import(names=[alias(name='re', lineno=14, col_offset=7, end_lineno=14, end_col_offset=9)], lineno=14, col_offset=0, end_lineno=14, end_col_offset=9), ImportFrom(module='dataclasses', names=[alias(name='dataclass', lineno=15, col_offset=24, end_lineno=15, end_col_offset=33)], level=0, lineno=15, col_offset=0, end_lineno=15, end_col_offset=33), ImportFrom(module='pathlib', names=[alias(name='Path', lineno=16, col_offset=20, end_lineno=16, end_col_offset=24)], level=0, lineno=16, col_offset=0, end_lineno=16, end_col_offset=24), ImportFrom(module='typing', names=[alias(name='TYPE_CHECKING', lineno=17, col_offset=19, end_lineno=17, end_col_offset=32), alias(name='cast', lineno=17, col_offset=34, end_lineno=17, end_col_offset=38)], level=0, lineno=17, col_offset=0, end_lineno=17, end_col_offset=38), Import(names=[alias(name='duckdb', lineno=19, col_offset=7, end_lineno=19, end_col_offset=13)], lineno=19, col_offset=0, end_lineno=19, end_col_offset=13), ImportFrom(module='kgfoundry_common.errors', names=[alias(name='ConfigurationError', lineno=21, col_offset=36, end_lineno=21, end_col_offset=54), alias(name='DeserializationError', lineno=21, col_offset=56, end_lineno=21, end_col_offset=76)], level=0, lineno=21, col_offset=0, end_lineno=21, end_col_offset=76), ImportFrom(module='kgfoundry_common.navmap_loader', names=[alias(name='load_nav_metadata', lineno=22, col_offset=43, end_lineno=22, end_col_offset=60)], level=0, lineno=22, col_offset=0, end_lineno=22, end_col_offset=60), ImportFrom(module='kgfoundry_common.safe_pickle_v2', names=[alias(name='UnsafeSerializationError', lineno=24, col_offset=4, end_lineno=24, end_col_offset=28), alias(name='load_unsigned_legacy', lineno=25, col_offset=4, end_lineno=25, end_col_offset=24)], level=0, lineno=23, col_offset=0, end_lineno=26, end_col_offset=1), ImportFrom(module='kgfoundry_common.serialization', names=[alias(name='deserialize_json', lineno=28, col_offset=4, end_lineno=28, end_col_offset=20), alias(name='serialize_json', lineno=29, col_offset=4, end_lineno=29, end_col_offset=18)], level=0, lineno=27, col_offset=0, end_lineno=30, end_col_offset=1), ImportFrom(module='registry.duckdb_helpers', names=[alias(name='fetch_all', lineno=31, col_offset=36, end_lineno=31, end_col_offset=45), alias(name='fetch_one', lineno=31, col_offset=47, end_lineno=31, end_col_offset=56)], level=0, lineno=31, col_offset=0, end_lineno=31, end_col_offset=56), If(test=Name(id='TYPE_CHECKING', ctx=Load(), lineno=33, col_offset=3, end_lineno=33, end_col_offset=16), body=[ImportFrom(module='collections.abc', names=[alias(name='Iterable', lineno=34, col_offset=32, end_lineno=34, end_col_offset=40)], level=0, lineno=34, col_offset=4, end_lineno=34, end_col_offset=40), ImportFrom(module='kgfoundry_common.problem_details', names=[alias(name='JsonValue', lineno=36, col_offset=49, end_lineno=36, end_col_offset=58)], level=0, lineno=36, col_offset=4, end_lineno=36, end_col_offset=58)], lineno=33, col_offset=0, end_lineno=36, end_col_offset=58), Assign(targets=[Name(id='__all__', ctx=Store(), lineno=38, col_offset=0, end_lineno=38, end_col_offset=7)], value=List(elts=[Constant(value='BM25Doc', lineno=39, col_offset=4, end_lineno=39, end_col_offset=13), Constant(value='BM25Index', lineno=40, col_offset=4, end_lineno=40, end_col_offset=15), Constant(value='toks', lineno=41, col_offset=4, end_lineno=41, end_col_offset=10)], ctx=Load(), lineno=38, col_offset=10, end_lineno=42, end_col_offset=1), lineno=38, col_offset=0, end_lineno=42, end_col_offset=1), Assign(targets=[Name(id='__navmap__', ctx=Store(), lineno=43, col_offset=0, end_lineno=43, end_col_offset=10)], value=Call(func=Name(id='load_nav_metadata', ctx=Load(), lineno=43, col_offset=13, end_lineno=43, end_col_offset=30), args=[Name(id='__name__', ctx=Load(), lineno=43, col_offset=31, end_lineno=43, end_col_offset=39), Call(func=Name(id='tuple', ctx=Load(), lineno=43, col_offset=41, end_lineno=43, end_col_offset=46), args=[Name(id='__all__', ctx=Load(), lineno=43, col_offset=47, end_lineno=43, end_col_offset=54)], lineno=43, col_offset=41, end_lineno=43, end_col_offset=55)], lineno=43, col_offset=13, end_lineno=43, end_col_offset=56), lineno=43, col_offset=0, end_lineno=43, end_col_offset=56), Assign(targets=[Name(id='TOKEN_RE', ctx=Store(), lineno=46, col_offset=0, end_lineno=46, end_col_offset=8)], value=Call(func=Attribute(value=Name(id='re', ctx=Load(), lineno=46, col_offset=11, end_lineno=46, end_col_offset=13), attr='compile', ctx=Load(), lineno=46, col_offset=11, end_lineno=46, end_col_offset=21), args=[Constant(value='[A-Za-z0-9]+', lineno=46, col_offset=22, end_lineno=46, end_col_offset=37)], lineno=46, col_offset=11, end_lineno=46, end_col_offset=38), lineno=46, col_offset=0, end_lineno=46, end_col_offset=38), FunctionDef(name='_validate_parquet_path', args=arguments(args=[arg(arg='path', annotation=BinOp(left=Name(id='str', ctx=Load(), lineno=50, col_offset=10, end_lineno=50, end_col_offset=13), op=BitOr(), right=Name(id='Path', ctx=Load(), lineno=50, col_offset=16, end_lineno=50, end_col_offset=20), lineno=50, col_offset=10, end_lineno=50, end_col_offset=20), lineno=50, col_offset=4, end_lineno=50, end_col_offset=20)], kwonlyargs=[arg(arg='allowed_roots', annotation=BinOp(left=Subscript(value=Name(id='list', ctx=Load(), lineno=52, col_offset=19, end_lineno=52, end_col_offset=23), slice=Name(id='Path', ctx=Load(), lineno=52, col_offset=24, end_lineno=52, end_col_offset=28), ctx=Load(), lineno=52, col_offset=19, end_lineno=52, end_col_offset=29), op=BitOr(), right=Constant(value=None, lineno=52, col_offset=32, end_lineno=52, end_col_offset=36), lineno=52, col_offset=19, end_lineno=52, end_col_offset=36), lineno=52, col_offset=4, end_lineno=52, end_col_offset=36), arg(arg='must_exist', annotation=Name(id='bool', ctx=Load(), lineno=53, col_offset=16, end_lineno=53, end_col_offset=20), lineno=53, col_offset=4, end_lineno=53, end_col_offset=20)], kw_defaults=[Constant(value=None, lineno=52, col_offset=39, end_lineno=52, end_col_offset=43), Constant(value=True, lineno=53, col_offset=23, end_lineno=53, end_col_offset=27)]), body=[Expr(value=Constant(value='Validate and resolve parquet path against allowlist to prevent path traversal.\n\n    Parameters\n    ----------\n    path : str | Path\n        Path to validate (may be relative or absolute).\n    allowed_roots : list[Path] | None, optional\n        List of allowed root directories. If None, uses environment variable\n        PARQUET_ROOT or default /data/parquet.\n    must_exist : bool, optional\n        If True, require path to exist. If False, only validate it\'s within\n        allowed directory. Defaults to True.\n\n    Returns\n    -------\n    Path\n        Resolved absolute path that is within an allowed directory.\n\n    Raises\n    ------\n    ConfigurationError\n        If path resolves outside allowed directories or contains invalid characters.\n    ValueError\n        If path cannot be resolved or (when must_exist=True) is not accessible.\n\n    Notes\n    -----\n    This function prevents path traversal attacks by:\n    1. Resolving paths to absolute paths using Path.resolve()\n    2. Checking resolved path is within allowed root directories\n    3. Validating path exists and is accessible (when must_exist=True)\n    4. Rejecting paths with unsafe patterns (.., symlinks outside allowed roots)\n\n    Examples\n    --------\n    >>> from pathlib import Path\n    >>> _validate_parquet_path("/data/parquet/chunks", allowed_roots=[Path("/data/parquet")])\n    Path(\'/data/parquet/chunks\')\n\n    >>> _validate_parquet_path("../../../etc/passwd", allowed_roots=[Path("/data/parquet")])\n    Traceback (most recent call last):\n        ...\n    ConfigurationError: Path resolves outside allowed directories\n    ', lineno=55, col_offset=4, end_lineno=98, end_col_offset=7), lineno=55, col_offset=4, end_lineno=98, end_col_offset=7), Assign(targets=[Name(id='candidate', ctx=Store(), lineno=99, col_offset=4, end_lineno=99, end_col_offset=13)], value=Call(func=Attribute(value=Call(func=Name(id='Path', ctx=Load(), lineno=99, col_offset=16, end_lineno=99, end_col_offset=20), args=[Name(id='path', ctx=Load(), lineno=99, col_offset=21, end_lineno=99, end_col_offset=25)], lineno=99, col_offset=16, end_lineno=99, end_col_offset=26), attr='expanduser', ctx=Load(), lineno=99, col_offset=16, end_lineno=99, end_col_offset=37), lineno=99, col_offset=16, end_lineno=99, end_col_offset=39), lineno=99, col_offset=4, end_lineno=99, end_col_offset=39), Try(body=[Assign(targets=[Name(id='resolved', ctx=Store(), lineno=103, col_offset=8, end_lineno=103, end_col_offset=16)], value=Call(func=Attribute(value=Name(id='candidate', ctx=Load(), lineno=103, col_offset=19, end_lineno=103, end_col_offset=28), attr='resolve', ctx=Load(), lineno=103, col_offset=19, end_lineno=103, end_col_offset=36), keywords=[keyword(arg='strict', value=Name(id='must_exist', ctx=Load(), lineno=103, col_offset=44, end_lineno=103, end_col_offset=54), lineno=103, col_offset=37, end_lineno=103, end_col_offset=54)], lineno=103, col_offset=19, end_lineno=103, end_col_offset=55), lineno=103, col_offset=8, end_lineno=103, end_col_offset=55)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='OSError', ctx=Load(), lineno=104, col_offset=12, end_lineno=104, end_col_offset=19), Name(id='RuntimeError', ctx=Load(), lineno=104, col_offset=21, end_lineno=104, end_col_offset=33)], ctx=Load(), lineno=104, col_offset=11, end_lineno=104, end_col_offset=34), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=105, col_offset=8, end_lineno=105, end_col_offset=11)], value=JoinedStr(values=[Constant(value='Invalid parquet path: ', lineno=105, col_offset=16, end_lineno=105, end_col_offset=38), FormattedValue(value=Name(id='path', ctx=Load(), lineno=105, col_offset=39, end_lineno=105, end_col_offset=43), conversion=-1, lineno=105, col_offset=38, end_lineno=105, end_col_offset=44)], lineno=105, col_offset=14, end_lineno=105, end_col_offset=45), lineno=105, col_offset=8, end_lineno=105, end_col_offset=45), Raise(exc=Call(func=Name(id='ValueError', ctx=Load(), lineno=106, col_offset=14, end_lineno=106, end_col_offset=24), args=[Name(id='msg', ctx=Load(), lineno=106, col_offset=25, end_lineno=106, end_col_offset=28)], lineno=106, col_offset=14, end_lineno=106, end_col_offset=29), cause=Name(id='exc', ctx=Load(), lineno=106, col_offset=35, end_lineno=106, end_col_offset=38), lineno=106, col_offset=8, end_lineno=106, end_col_offset=38)], lineno=104, col_offset=4, end_lineno=106, end_col_offset=38)], lineno=102, col_offset=4, end_lineno=106, end_col_offset=38), If(test=Compare(left=Name(id='allowed_roots', ctx=Load(), lineno=109, col_offset=7, end_lineno=109, end_col_offset=20), ops=[Is()], comparators=[Constant(value=None, lineno=109, col_offset=24, end_lineno=109, end_col_offset=28)], lineno=109, col_offset=7, end_lineno=109, end_col_offset=28), body=[Assign(targets=[Name(id='parquet_root_env', ctx=Store(), lineno=110, col_offset=8, end_lineno=110, end_col_offset=24)], value=Call(func=Attribute(value=Name(id='os', ctx=Load(), lineno=110, col_offset=27, end_lineno=110, end_col_offset=29), attr='getenv', ctx=Load(), lineno=110, col_offset=27, end_lineno=110, end_col_offset=36), args=[Constant(value='PARQUET_ROOT', lineno=110, col_offset=37, end_lineno=110, end_col_offset=51), Constant(value='/data/parquet', lineno=110, col_offset=53, end_lineno=110, end_col_offset=68)], lineno=110, col_offset=27, end_lineno=110, end_col_offset=69), lineno=110, col_offset=8, end_lineno=110, end_col_offset=69), Assign(targets=[Name(id='allowed_roots', ctx=Store(), lineno=111, col_offset=8, end_lineno=111, end_col_offset=21)], value=List(elts=[Call(func=Attribute(value=Call(func=Name(id='Path', ctx=Load(), lineno=111, col_offset=25, end_lineno=111, end_col_offset=29), args=[Name(id='parquet_root_env', ctx=Load(), lineno=111, col_offset=30, end_lineno=111, end_col_offset=46)], lineno=111, col_offset=25, end_lineno=111, end_col_offset=47), attr='resolve', ctx=Load(), lineno=111, col_offset=25, end_lineno=111, end_col_offset=55), lineno=111, col_offset=25, end_lineno=111, end_col_offset=57)], ctx=Load(), lineno=111, col_offset=24, end_lineno=111, end_col_offset=58), lineno=111, col_offset=8, end_lineno=111, end_col_offset=58)], lineno=109, col_offset=4, end_lineno=111, end_col_offset=58), Assign(targets=[Name(id='is_allowed', ctx=Store(), lineno=114, col_offset=4, end_lineno=114, end_col_offset=14)], value=Constant(value=False, lineno=114, col_offset=17, end_lineno=114, end_col_offset=22), lineno=114, col_offset=4, end_lineno=114, end_col_offset=22), For(target=Name(id='allowed_root', ctx=Store(), lineno=115, col_offset=8, end_lineno=115, end_col_offset=20), iter=Name(id='allowed_roots', ctx=Load(), lineno=115, col_offset=24, end_lineno=115, end_col_offset=37), body=[Assign(targets=[Name(id='allowed_resolved', ctx=Store(), lineno=116, col_offset=8, end_lineno=116, end_col_offset=24)], value=Call(func=Attribute(value=Name(id='allowed_root', ctx=Load(), lineno=116, col_offset=27, end_lineno=116, end_col_offset=39), attr='resolve', ctx=Load(), lineno=116, col_offset=27, end_lineno=116, end_col_offset=47), lineno=116, col_offset=27, end_lineno=116, end_col_offset=49), lineno=116, col_offset=8, end_lineno=116, end_col_offset=49), Try(body=[Expr(value=Call(func=Attribute(value=Name(id='resolved', ctx=Load(), lineno=119, col_offset=12, end_lineno=119, end_col_offset=20), attr='relative_to', ctx=Load(), lineno=119, col_offset=12, end_lineno=119, end_col_offset=32), args=[Name(id='allowed_resolved', ctx=Load(), lineno=119, col_offset=33, end_lineno=119, end_col_offset=49)], lineno=119, col_offset=12, end_lineno=119, end_col_offset=50), lineno=119, col_offset=12, end_lineno=119, end_col_offset=50), Assign(targets=[Name(id='is_allowed', ctx=Store(), lineno=120, col_offset=12, end_lineno=120, end_col_offset=22)], value=Constant(value=True, lineno=120, col_offset=25, end_lineno=120, end_col_offset=29), lineno=120, col_offset=12, end_lineno=120, end_col_offset=29), Break(lineno=121, col_offset=12, end_lineno=121, end_col_offset=17)], handlers=[ExceptHandler(type=Name(id='ValueError', ctx=Load(), lineno=122, col_offset=15, end_lineno=122, end_col_offset=25), body=[Continue(lineno=124, col_offset=12, end_lineno=124, end_col_offset=20)], lineno=122, col_offset=8, end_lineno=124, end_col_offset=20)], lineno=117, col_offset=8, end_lineno=124, end_col_offset=20)], lineno=115, col_offset=4, end_lineno=124, end_col_offset=20), If(test=UnaryOp(op=Not(), operand=Name(id='is_allowed', ctx=Load(), lineno=126, col_offset=11, end_lineno=126, end_col_offset=21), lineno=126, col_offset=7, end_lineno=126, end_col_offset=21), body=[Assign(targets=[Name(id='allowed_str', ctx=Store(), lineno=127, col_offset=8, end_lineno=127, end_col_offset=19)], value=Call(func=Attribute(value=Constant(value=', ', lineno=127, col_offset=22, end_lineno=127, end_col_offset=26), attr='join', ctx=Load(), lineno=127, col_offset=22, end_lineno=127, end_col_offset=31), args=[GeneratorExp(elt=Call(func=Name(id='str', ctx=Load(), lineno=127, col_offset=32, end_lineno=127, end_col_offset=35), args=[Name(id='root', ctx=Load(), lineno=127, col_offset=36, end_lineno=127, end_col_offset=40)], lineno=127, col_offset=32, end_lineno=127, end_col_offset=41), generators=[comprehension(target=Name(id='root', ctx=Store(), lineno=127, col_offset=46, end_lineno=127, end_col_offset=50), iter=Name(id='allowed_roots', ctx=Load(), lineno=127, col_offset=54, end_lineno=127, end_col_offset=67), is_async=0)], lineno=127, col_offset=31, end_lineno=127, end_col_offset=68)], lineno=127, col_offset=22, end_lineno=127, end_col_offset=68), lineno=127, col_offset=8, end_lineno=127, end_col_offset=68), Assign(targets=[Name(id='msg', ctx=Store(), lineno=128, col_offset=8, end_lineno=128, end_col_offset=11)], value=JoinedStr(values=[Constant(value='Path resolves outside allowed directories. Resolved: ', lineno=129, col_offset=12, end_lineno=130, end_col_offset=24), FormattedValue(value=Name(id='resolved', ctx=Load(), lineno=130, col_offset=25, end_lineno=130, end_col_offset=33), conversion=-1, lineno=130, col_offset=24, end_lineno=130, end_col_offset=34), Constant(value=', Allowed roots: ', lineno=130, col_offset=34, end_lineno=130, end_col_offset=51), FormattedValue(value=Name(id='allowed_str', ctx=Load(), lineno=130, col_offset=52, end_lineno=130, end_col_offset=63), conversion=-1, lineno=130, col_offset=51, end_lineno=130, end_col_offset=64)], lineno=129, col_offset=12, end_lineno=130, end_col_offset=65), lineno=128, col_offset=8, end_lineno=131, end_col_offset=9), Raise(exc=Call(func=Name(id='ConfigurationError', ctx=Load(), lineno=132, col_offset=14, end_lineno=132, end_col_offset=32), args=[Name(id='msg', ctx=Load(), lineno=132, col_offset=33, end_lineno=132, end_col_offset=36)], lineno=132, col_offset=14, end_lineno=132, end_col_offset=37), lineno=132, col_offset=8, end_lineno=132, end_col_offset=37)], lineno=126, col_offset=4, end_lineno=132, end_col_offset=37), If(test=BoolOp(op=And(), values=[Name(id='must_exist', ctx=Load(), lineno=135, col_offset=7, end_lineno=135, end_col_offset=17), UnaryOp(op=Not(), operand=Call(func=Attribute(value=Name(id='resolved', ctx=Load(), lineno=135, col_offset=26, end_lineno=135, end_col_offset=34), attr='exists', ctx=Load(), lineno=135, col_offset=26, end_lineno=135, end_col_offset=41), lineno=135, col_offset=26, end_lineno=135, end_col_offset=43), lineno=135, col_offset=22, end_lineno=135, end_col_offset=43)], lineno=135, col_offset=7, end_lineno=135, end_col_offset=43), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=136, col_offset=8, end_lineno=136, end_col_offset=11)], value=JoinedStr(values=[Constant(value='Parquet path does not exist: ', lineno=136, col_offset=16, end_lineno=136, end_col_offset=45), FormattedValue(value=Name(id='resolved', ctx=Load(), lineno=136, col_offset=46, end_lineno=136, end_col_offset=54), conversion=-1, lineno=136, col_offset=45, end_lineno=136, end_col_offset=55)], lineno=136, col_offset=14, end_lineno=136, end_col_offset=56), lineno=136, col_offset=8, end_lineno=136, end_col_offset=56), Raise(exc=Call(func=Name(id='ValueError', ctx=Load(), lineno=137, col_offset=14, end_lineno=137, end_col_offset=24), args=[Name(id='msg', ctx=Load(), lineno=137, col_offset=25, end_lineno=137, end_col_offset=28)], lineno=137, col_offset=14, end_lineno=137, end_col_offset=29), lineno=137, col_offset=8, end_lineno=137, end_col_offset=29)], lineno=135, col_offset=4, end_lineno=137, end_col_offset=29), Return(value=Name(id='resolved', ctx=Load(), lineno=139, col_offset=11, end_lineno=139, end_col_offset=19), lineno=139, col_offset=4, end_lineno=139, end_col_offset=19)], returns=Name(id='Path', ctx=Load(), lineno=54, col_offset=5, end_lineno=54, end_col_offset=9), lineno=49, col_offset=0, end_lineno=139, end_col_offset=19), FunctionDef(name='_as_str', args=arguments(args=[arg(arg='value', annotation=Name(id='object', ctx=Load(), lineno=142, col_offset=19, end_lineno=142, end_col_offset=25), lineno=142, col_offset=12, end_lineno=142, end_col_offset=25)]), body=[If(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=143, col_offset=7, end_lineno=143, end_col_offset=17), args=[Name(id='value', ctx=Load(), lineno=143, col_offset=18, end_lineno=143, end_col_offset=23), Name(id='str', ctx=Load(), lineno=143, col_offset=25, end_lineno=143, end_col_offset=28)], lineno=143, col_offset=7, end_lineno=143, end_col_offset=29), body=[Return(value=Name(id='value', ctx=Load(), lineno=144, col_offset=15, end_lineno=144, end_col_offset=20), lineno=144, col_offset=8, end_lineno=144, end_col_offset=20)], lineno=143, col_offset=4, end_lineno=144, end_col_offset=20), If(test=Compare(left=Name(id='value', ctx=Load(), lineno=145, col_offset=7, end_lineno=145, end_col_offset=12), ops=[Is()], comparators=[Constant(value=None, lineno=145, col_offset=16, end_lineno=145, end_col_offset=20)], lineno=145, col_offset=7, end_lineno=145, end_col_offset=20), body=[Return(value=Constant(value='', lineno=146, col_offset=15, end_lineno=146, end_col_offset=17), lineno=146, col_offset=8, end_lineno=146, end_col_offset=17)], lineno=145, col_offset=4, end_lineno=146, end_col_offset=17), Return(value=Call(func=Name(id='str', ctx=Load(), lineno=147, col_offset=11, end_lineno=147, end_col_offset=14), args=[Name(id='value', ctx=Load(), lineno=147, col_offset=15, end_lineno=147, end_col_offset=20)], lineno=147, col_offset=11, end_lineno=147, end_col_offset=21), lineno=147, col_offset=4, end_lineno=147, end_col_offset=21)], returns=Name(id='str', ctx=Load(), lineno=142, col_offset=30, end_lineno=142, end_col_offset=33), lineno=142, col_offset=0, end_lineno=147, end_col_offset=21), FunctionDef(name='toks', args=arguments(args=[arg(arg='text', annotation=Name(id='str', ctx=Load(), lineno=151, col_offset=15, end_lineno=151, end_col_offset=18), lineno=151, col_offset=9, end_lineno=151, end_col_offset=18)]), body=[Expr(value=Constant(value='Extract tokens from text using word boundary regex.\n\n    Tokenizes input text by finding all sequences of alphanumeric characters\n    (using regex pattern ``[A-Za-z0-9]+``) and converting them to lowercase.\n    Used for BM25 indexing and query processing.\n\n    Parameters\n    ----------\n    text : str\n        Input text to tokenize. May be empty or None (treated as empty).\n\n    Returns\n    -------\n    list[str]\n        List of lowercase tokens extracted from the text. Empty list if input\n        is empty or contains no alphanumeric sequences.\n\n    Examples\n    --------\n    >>> toks("Hello World 123")\n    [\'hello\', \'world\', \'123\']\n    >>> toks("")\n    []\n    ', lineno=152, col_offset=4, end_lineno=175, end_col_offset=7), lineno=152, col_offset=4, end_lineno=175, end_col_offset=7), AnnAssign(target=Name(id='matches', ctx=Store(), lineno=177, col_offset=4, end_lineno=177, end_col_offset=11), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=177, col_offset=13, end_lineno=177, end_col_offset=17), slice=Name(id='str', ctx=Load(), lineno=177, col_offset=18, end_lineno=177, end_col_offset=21), ctx=Load(), lineno=177, col_offset=13, end_lineno=177, end_col_offset=22), value=Call(func=Attribute(value=Name(id='TOKEN_RE', ctx=Load(), lineno=177, col_offset=25, end_lineno=177, end_col_offset=33), attr='findall', ctx=Load(), lineno=177, col_offset=25, end_lineno=177, end_col_offset=41), args=[BoolOp(op=Or(), values=[Name(id='text', ctx=Load(), lineno=177, col_offset=42, end_lineno=177, end_col_offset=46), Constant(value='', lineno=177, col_offset=50, end_lineno=177, end_col_offset=52)], lineno=177, col_offset=42, end_lineno=177, end_col_offset=52)], lineno=177, col_offset=25, end_lineno=177, end_col_offset=53), simple=1, lineno=177, col_offset=4, end_lineno=177, end_col_offset=53), Return(value=ListComp(elt=Call(func=Attribute(value=Name(id='token', ctx=Load(), lineno=178, col_offset=12, end_lineno=178, end_col_offset=17), attr='lower', ctx=Load(), lineno=178, col_offset=12, end_lineno=178, end_col_offset=23), lineno=178, col_offset=12, end_lineno=178, end_col_offset=25), generators=[comprehension(target=Name(id='token', ctx=Store(), lineno=178, col_offset=30, end_lineno=178, end_col_offset=35), iter=Name(id='matches', ctx=Load(), lineno=178, col_offset=39, end_lineno=178, end_col_offset=46), is_async=0)], lineno=178, col_offset=11, end_lineno=178, end_col_offset=47), lineno=178, col_offset=4, end_lineno=178, end_col_offset=47)], returns=Subscript(value=Name(id='list', ctx=Load(), lineno=151, col_offset=23, end_lineno=151, end_col_offset=27), slice=Name(id='str', ctx=Load(), lineno=151, col_offset=28, end_lineno=151, end_col_offset=31), ctx=Load(), lineno=151, col_offset=23, end_lineno=151, end_col_offset=32), lineno=151, col_offset=0, end_lineno=178, end_col_offset=47), ClassDef(name='BM25Doc', body=[Expr(value=Constant(value='Document representation for BM25 indexing and retrieval.\n\n    Stores term frequency statistics and document metadata for a single\n    document chunk. Inline attribute docstrings describe alias usage.\n\n    See Also\n    --------\n    BM25Index : BM25 index using these document representations.\n    ', lineno=184, col_offset=4, end_lineno=192, end_col_offset=7), lineno=184, col_offset=4, end_lineno=192, end_col_offset=7), AnnAssign(target=Name(id='chunk_id', ctx=Store(), lineno=194, col_offset=4, end_lineno=194, end_col_offset=12), annotation=Name(id='str', ctx=Load(), lineno=194, col_offset=14, end_lineno=194, end_col_offset=17), simple=1, lineno=194, col_offset=4, end_lineno=194, end_col_offset=17), Expr(value=Constant(value='Unique identifier for the chunk.\n\n    Alias: none; name ``chunk_id``.\n    ', lineno=195, col_offset=4, end_lineno=198, end_col_offset=7), lineno=195, col_offset=4, end_lineno=198, end_col_offset=7), AnnAssign(target=Name(id='doc_id', ctx=Store(), lineno=199, col_offset=4, end_lineno=199, end_col_offset=10), annotation=Name(id='str', ctx=Load(), lineno=199, col_offset=12, end_lineno=199, end_col_offset=15), simple=1, lineno=199, col_offset=4, end_lineno=199, end_col_offset=15), Expr(value=Constant(value='Parent document identifier.\n\n    Alias: none; name ``doc_id``.\n    ', lineno=200, col_offset=4, end_lineno=203, end_col_offset=7), lineno=200, col_offset=4, end_lineno=203, end_col_offset=7), AnnAssign(target=Name(id='title', ctx=Store(), lineno=204, col_offset=4, end_lineno=204, end_col_offset=9), annotation=Name(id='str', ctx=Load(), lineno=204, col_offset=11, end_lineno=204, end_col_offset=14), simple=1, lineno=204, col_offset=4, end_lineno=204, end_col_offset=14), Expr(value=Constant(value='Document title used for term weighting.\n\n    Alias: none; name ``title``.\n    ', lineno=205, col_offset=4, end_lineno=208, end_col_offset=7), lineno=205, col_offset=4, end_lineno=208, end_col_offset=7), AnnAssign(target=Name(id='section', ctx=Store(), lineno=209, col_offset=4, end_lineno=209, end_col_offset=11), annotation=Name(id='str', ctx=Load(), lineno=209, col_offset=13, end_lineno=209, end_col_offset=16), simple=1, lineno=209, col_offset=4, end_lineno=209, end_col_offset=16), Expr(value=Constant(value='Section label where the chunk appears.\n\n    Alias: none; name ``section``.\n    ', lineno=210, col_offset=4, end_lineno=213, end_col_offset=7), lineno=210, col_offset=4, end_lineno=213, end_col_offset=7), AnnAssign(target=Name(id='tf', ctx=Store(), lineno=214, col_offset=4, end_lineno=214, end_col_offset=6), annotation=Subscript(value=Name(id='dict', ctx=Load(), lineno=214, col_offset=8, end_lineno=214, end_col_offset=12), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=214, col_offset=13, end_lineno=214, end_col_offset=16), Name(id='float', ctx=Load(), lineno=214, col_offset=18, end_lineno=214, end_col_offset=23)], ctx=Load(), lineno=214, col_offset=13, end_lineno=214, end_col_offset=23), ctx=Load(), lineno=214, col_offset=8, end_lineno=214, end_col_offset=24), simple=1, lineno=214, col_offset=4, end_lineno=214, end_col_offset=24), Expr(value=Constant(value='Term frequency mapping per token.\n\n    Alias: none; name ``tf``.\n    ', lineno=215, col_offset=4, end_lineno=218, end_col_offset=7), lineno=215, col_offset=4, end_lineno=218, end_col_offset=7), AnnAssign(target=Name(id='dl', ctx=Store(), lineno=219, col_offset=4, end_lineno=219, end_col_offset=6), annotation=Name(id='float', ctx=Load(), lineno=219, col_offset=8, end_lineno=219, end_col_offset=13), simple=1, lineno=219, col_offset=4, end_lineno=219, end_col_offset=13), Expr(value=Constant(value='BM25 document length (sum of term frequencies).\n\n    Alias: none; name ``dl``.\n    ', lineno=220, col_offset=4, end_lineno=223, end_col_offset=7), lineno=220, col_offset=4, end_lineno=223, end_col_offset=7)], decorator_list=[Call(func=Name(id='dataclass', ctx=Load(), lineno=182, col_offset=1, end_lineno=182, end_col_offset=10), keywords=[keyword(arg='frozen', value=Constant(value=True, lineno=182, col_offset=18, end_lineno=182, end_col_offset=22), lineno=182, col_offset=11, end_lineno=182, end_col_offset=22)], lineno=182, col_offset=1, end_lineno=182, end_col_offset=23)], lineno=183, col_offset=0, end_lineno=223, end_col_offset=7), ClassDef(name='BM25Index', body=[Expr(value=Constant(value='BM25 ranking function implementation for text search.\n\n    Implements the Best Matching 25 (BM25) ranking algorithm for document\n    retrieval. BM25 computes relevance scores based on term frequency (TF),\n    inverse document frequency (IDF), and document length normalization.\n\n    Parameters\n    ----------\n    k1 : float, optional\n        Term frequency saturation parameter. Controls how quickly term frequency\n        saturates. Higher values allow more influence from repeated terms.\n        Defaults to 0.9.\n    b : float, optional\n        Document length normalization parameter. Controls the degree of length\n        normalization. Values closer to 1.0 normalize more aggressively.\n        Defaults to 0.4.\n\n    Notes\n    -----\n    BM25 scoring formula:\n    :math:`score(D, Q) = \\sum_{t \\in Q} IDF(t) \\cdot `\n    :math:`\\frac{TF(t, D) \\cdot (k1 + 1)}{TF(t, D) + k1 \\cdot (1 - b + b \\cdot \\frac{|D|}{avgdl})}`\n\n    Where:\n    - :math:`TF(t, D)` is the term frequency of term :math:`t` in document :math:`D`\n    - :math:`IDF(t)` is the inverse document frequency of term :math:`t`\n    - :math:`|D|` is the document length\n    - :math:`avgdl` is the average document length\n\n    See Also\n    --------\n    BM25Doc : Document representation used by this index.\n    toks : Tokenization function used for indexing and queries.\n    ', lineno=228, col_offset=4, end_lineno=261, end_col_offset=7), lineno=228, col_offset=4, end_lineno=261, end_col_offset=7), FunctionDef(name='__init__', args=arguments(args=[arg(arg='self', lineno=263, col_offset=17, end_lineno=263, end_col_offset=21), arg(arg='k1', annotation=Name(id='float', ctx=Load(), lineno=263, col_offset=27, end_lineno=263, end_col_offset=32), lineno=263, col_offset=23, end_lineno=263, end_col_offset=32), arg(arg='b', annotation=Name(id='float', ctx=Load(), lineno=263, col_offset=43, end_lineno=263, end_col_offset=48), lineno=263, col_offset=40, end_lineno=263, end_col_offset=48)], defaults=[Constant(value=0.9, lineno=263, col_offset=35, end_lineno=263, end_col_offset=38), Constant(value=0.4, lineno=263, col_offset=51, end_lineno=263, end_col_offset=54)]), body=[Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=264, col_offset=8, end_lineno=264, end_col_offset=12), attr='k1', ctx=Store(), lineno=264, col_offset=8, end_lineno=264, end_col_offset=15)], value=Name(id='k1', ctx=Load(), lineno=264, col_offset=18, end_lineno=264, end_col_offset=20), lineno=264, col_offset=8, end_lineno=264, end_col_offset=20), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=265, col_offset=8, end_lineno=265, end_col_offset=12), attr='b', ctx=Store(), lineno=265, col_offset=8, end_lineno=265, end_col_offset=14)], value=Name(id='b', ctx=Load(), lineno=265, col_offset=17, end_lineno=265, end_col_offset=18), lineno=265, col_offset=8, end_lineno=265, end_col_offset=18), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=266, col_offset=8, end_lineno=266, end_col_offset=12), attr='docs', ctx=Store(), lineno=266, col_offset=8, end_lineno=266, end_col_offset=17), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=266, col_offset=19, end_lineno=266, end_col_offset=23), slice=Name(id='BM25Doc', ctx=Load(), lineno=266, col_offset=24, end_lineno=266, end_col_offset=31), ctx=Load(), lineno=266, col_offset=19, end_lineno=266, end_col_offset=32), value=List(ctx=Load(), lineno=266, col_offset=35, end_lineno=266, end_col_offset=37), simple=0, lineno=266, col_offset=8, end_lineno=266, end_col_offset=37), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=267, col_offset=8, end_lineno=267, end_col_offset=12), attr='df', ctx=Store(), lineno=267, col_offset=8, end_lineno=267, end_col_offset=15), annotation=Subscript(value=Name(id='dict', ctx=Load(), lineno=267, col_offset=17, end_lineno=267, end_col_offset=21), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=267, col_offset=22, end_lineno=267, end_col_offset=25), Name(id='int', ctx=Load(), lineno=267, col_offset=27, end_lineno=267, end_col_offset=30)], ctx=Load(), lineno=267, col_offset=22, end_lineno=267, end_col_offset=30), ctx=Load(), lineno=267, col_offset=17, end_lineno=267, end_col_offset=31), value=Dict(lineno=267, col_offset=34, end_lineno=267, end_col_offset=36), simple=0, lineno=267, col_offset=8, end_lineno=267, end_col_offset=36), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=268, col_offset=8, end_lineno=268, end_col_offset=12), attr='N', ctx=Store(), lineno=268, col_offset=8, end_lineno=268, end_col_offset=14)], value=Constant(value=0, lineno=268, col_offset=17, end_lineno=268, end_col_offset=18), lineno=268, col_offset=8, end_lineno=268, end_col_offset=18), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=269, col_offset=8, end_lineno=269, end_col_offset=12), attr='avgdl', ctx=Store(), lineno=269, col_offset=8, end_lineno=269, end_col_offset=18)], value=Constant(value=0.0, lineno=269, col_offset=21, end_lineno=269, end_col_offset=24), lineno=269, col_offset=8, end_lineno=269, end_col_offset=24)], returns=Constant(value=None, lineno=263, col_offset=59, end_lineno=263, end_col_offset=63), lineno=263, col_offset=4, end_lineno=269, end_col_offset=24), FunctionDef(name='build_from_duckdb', args=arguments(args=[arg(arg='cls', lineno=272, col_offset=26, end_lineno=272, end_col_offset=29), arg(arg='db_path', annotation=Name(id='str', ctx=Load(), lineno=272, col_offset=40, end_lineno=272, end_col_offset=43), lineno=272, col_offset=31, end_lineno=272, end_col_offset=43)]), body=[Expr(value=Constant(value='Build BM25 index from DuckDB database.\n\n        Queries a DuckDB database for the most recent chunks dataset and\n        builds a BM25 index from the parquet files. Reads chunk text, document\n        titles, and sections, then computes term frequencies and document\n        frequencies.\n\n        Parameters\n        ----------\n        db_path : str\n            Path to DuckDB database file containing datasets and documents tables.\n\n        Returns\n        -------\n        BM25Index\n            Initialized BM25 index with documents loaded from DuckDB.\n\n        Raises\n        ------\n        TypeError\n            If parquet_root value in the database is not a string.\n\n        Notes\n        -----\n        The method queries for the most recent chunks dataset ordered by\n        created_at. If no dataset is found, returns an empty index. Path\n        validation prevents path traversal attacks by ensuring resolved paths\n        are within allowed directories. Errors raised by\n        :func:`_validate_parquet_path` propagate unchanged.\n        ', lineno=273, col_offset=8, end_lineno=302, end_col_offset=11), lineno=273, col_offset=8, end_lineno=302, end_col_offset=11), Assign(targets=[Name(id='index', ctx=Store(), lineno=303, col_offset=8, end_lineno=303, end_col_offset=13)], value=Call(func=Name(id='cls', ctx=Load(), lineno=303, col_offset=16, end_lineno=303, end_col_offset=19), lineno=303, col_offset=16, end_lineno=303, end_col_offset=21), lineno=303, col_offset=8, end_lineno=303, end_col_offset=21), Assign(targets=[Name(id='con', ctx=Store(), lineno=304, col_offset=8, end_lineno=304, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='duckdb', ctx=Load(), lineno=304, col_offset=14, end_lineno=304, end_col_offset=20), attr='connect', ctx=Load(), lineno=304, col_offset=14, end_lineno=304, end_col_offset=28), args=[Name(id='db_path', ctx=Load(), lineno=304, col_offset=29, end_lineno=304, end_col_offset=36)], lineno=304, col_offset=14, end_lineno=304, end_col_offset=37), lineno=304, col_offset=8, end_lineno=304, end_col_offset=37), Try(body=[Assign(targets=[Name(id='dataset', ctx=Store(), lineno=306, col_offset=12, end_lineno=306, end_col_offset=19)], value=Call(func=Name(id='fetch_one', ctx=Load(), lineno=306, col_offset=22, end_lineno=306, end_col_offset=31), args=[Name(id='con', ctx=Load(), lineno=307, col_offset=16, end_lineno=307, end_col_offset=19), Constant(value="SELECT parquet_root FROM datasets WHERE kind='chunks' ORDER BY created_at DESC LIMIT 1", lineno=308, col_offset=16, end_lineno=309, end_col_offset=70)], lineno=306, col_offset=22, end_lineno=310, end_col_offset=13), lineno=306, col_offset=12, end_lineno=310, end_col_offset=13), If(test=Compare(left=Name(id='dataset', ctx=Load(), lineno=311, col_offset=15, end_lineno=311, end_col_offset=22), ops=[Is()], comparators=[Constant(value=None, lineno=311, col_offset=26, end_lineno=311, end_col_offset=30)], lineno=311, col_offset=15, end_lineno=311, end_col_offset=30), body=[Return(value=Name(id='index', ctx=Load(), lineno=312, col_offset=23, end_lineno=312, end_col_offset=28), lineno=312, col_offset=16, end_lineno=312, end_col_offset=28)], lineno=311, col_offset=12, end_lineno=312, end_col_offset=28), Assign(targets=[Name(id='root_obj', ctx=Store(), lineno=313, col_offset=12, end_lineno=313, end_col_offset=20)], value=Subscript(value=Name(id='dataset', ctx=Load(), lineno=313, col_offset=23, end_lineno=313, end_col_offset=30), slice=Constant(value=0, lineno=313, col_offset=31, end_lineno=313, end_col_offset=32), ctx=Load(), lineno=313, col_offset=23, end_lineno=313, end_col_offset=33), lineno=313, col_offset=12, end_lineno=313, end_col_offset=33), If(test=UnaryOp(op=Not(), operand=Call(func=Name(id='isinstance', ctx=Load(), lineno=314, col_offset=19, end_lineno=314, end_col_offset=29), args=[Name(id='root_obj', ctx=Load(), lineno=314, col_offset=30, end_lineno=314, end_col_offset=38), Name(id='str', ctx=Load(), lineno=314, col_offset=40, end_lineno=314, end_col_offset=43)], lineno=314, col_offset=19, end_lineno=314, end_col_offset=44), lineno=314, col_offset=15, end_lineno=314, end_col_offset=44), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=315, col_offset=16, end_lineno=315, end_col_offset=19)], value=JoinedStr(values=[Constant(value='Invalid parquet_root type: ', lineno=315, col_offset=24, end_lineno=315, end_col_offset=51), FormattedValue(value=Call(func=Name(id='type', ctx=Load(), lineno=315, col_offset=52, end_lineno=315, end_col_offset=56), args=[Name(id='root_obj', ctx=Load(), lineno=315, col_offset=57, end_lineno=315, end_col_offset=65)], lineno=315, col_offset=52, end_lineno=315, end_col_offset=66), conversion=-1, lineno=315, col_offset=51, end_lineno=315, end_col_offset=67)], lineno=315, col_offset=22, end_lineno=315, end_col_offset=68), lineno=315, col_offset=16, end_lineno=315, end_col_offset=68), Raise(exc=Call(func=Name(id='TypeError', ctx=Load(), lineno=316, col_offset=22, end_lineno=316, end_col_offset=31), args=[Name(id='msg', ctx=Load(), lineno=316, col_offset=32, end_lineno=316, end_col_offset=35)], lineno=316, col_offset=22, end_lineno=316, end_col_offset=36), lineno=316, col_offset=16, end_lineno=316, end_col_offset=36)], lineno=314, col_offset=12, end_lineno=316, end_col_offset=36), Assign(targets=[Name(id='root_path', ctx=Store(), lineno=319, col_offset=12, end_lineno=319, end_col_offset=21)], value=Call(func=Name(id='_validate_parquet_path', ctx=Load(), lineno=319, col_offset=24, end_lineno=319, end_col_offset=46), args=[Name(id='root_obj', ctx=Load(), lineno=319, col_offset=47, end_lineno=319, end_col_offset=55)], keywords=[keyword(arg='must_exist', value=Constant(value=True, lineno=319, col_offset=68, end_lineno=319, end_col_offset=72), lineno=319, col_offset=57, end_lineno=319, end_col_offset=72)], lineno=319, col_offset=24, end_lineno=319, end_col_offset=73), lineno=319, col_offset=12, end_lineno=319, end_col_offset=73), Assign(targets=[Name(id='parquet_pattern', ctx=Store(), lineno=320, col_offset=12, end_lineno=320, end_col_offset=27)], value=Call(func=Name(id='str', ctx=Load(), lineno=320, col_offset=30, end_lineno=320, end_col_offset=33), args=[BinOp(left=BinOp(left=Name(id='root_path', ctx=Load(), lineno=320, col_offset=34, end_lineno=320, end_col_offset=43), op=Div(), right=Constant(value='*', lineno=320, col_offset=46, end_lineno=320, end_col_offset=49), lineno=320, col_offset=34, end_lineno=320, end_col_offset=49), op=Div(), right=Constant(value='*.parquet', lineno=320, col_offset=52, end_lineno=320, end_col_offset=63), lineno=320, col_offset=34, end_lineno=320, end_col_offset=63)], lineno=320, col_offset=30, end_lineno=320, end_col_offset=64), lineno=320, col_offset=12, end_lineno=320, end_col_offset=64), Assign(targets=[Name(id='sql', ctx=Store(), lineno=321, col_offset=12, end_lineno=321, end_col_offset=15)], value=Constant(value="\n                SELECT c.chunk_id, c.doc_id, coalesce(c.section,''), c.text, coalesce(d.title,'')\n                FROM read_parquet(?, union_by_name=true) AS c\n                LEFT JOIN documents d ON c.doc_id = d.doc_id\n            ", lineno=321, col_offset=18, end_lineno=325, end_col_offset=15), lineno=321, col_offset=12, end_lineno=325, end_col_offset=15), Assign(targets=[Name(id='raw_rows', ctx=Store(), lineno=326, col_offset=12, end_lineno=326, end_col_offset=20)], value=Call(func=Name(id='fetch_all', ctx=Load(), lineno=326, col_offset=23, end_lineno=326, end_col_offset=32), args=[Name(id='con', ctx=Load(), lineno=326, col_offset=33, end_lineno=326, end_col_offset=36), Name(id='sql', ctx=Load(), lineno=326, col_offset=38, end_lineno=326, end_col_offset=41), List(elts=[Name(id='parquet_pattern', ctx=Load(), lineno=326, col_offset=44, end_lineno=326, end_col_offset=59)], ctx=Load(), lineno=326, col_offset=43, end_lineno=326, end_col_offset=60)], lineno=326, col_offset=23, end_lineno=326, end_col_offset=61), lineno=326, col_offset=12, end_lineno=326, end_col_offset=61), AnnAssign(target=Name(id='typed_rows', ctx=Store(), lineno=327, col_offset=12, end_lineno=327, end_col_offset=22), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=327, col_offset=24, end_lineno=327, end_col_offset=28), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=327, col_offset=29, end_lineno=327, end_col_offset=34), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=327, col_offset=35, end_lineno=327, end_col_offset=38), Name(id='str', ctx=Load(), lineno=327, col_offset=40, end_lineno=327, end_col_offset=43), Name(id='str', ctx=Load(), lineno=327, col_offset=45, end_lineno=327, end_col_offset=48), Name(id='str', ctx=Load(), lineno=327, col_offset=50, end_lineno=327, end_col_offset=53), Name(id='str', ctx=Load(), lineno=327, col_offset=55, end_lineno=327, end_col_offset=58)], ctx=Load(), lineno=327, col_offset=35, end_lineno=327, end_col_offset=58), ctx=Load(), lineno=327, col_offset=29, end_lineno=327, end_col_offset=59), ctx=Load(), lineno=327, col_offset=24, end_lineno=327, end_col_offset=60), value=ListComp(elt=Tuple(elts=[Call(func=Name(id='_as_str', ctx=Load(), lineno=329, col_offset=20, end_lineno=329, end_col_offset=27), args=[Name(id='chunk_id_val', ctx=Load(), lineno=329, col_offset=28, end_lineno=329, end_col_offset=40)], lineno=329, col_offset=20, end_lineno=329, end_col_offset=41), Call(func=Name(id='_as_str', ctx=Load(), lineno=330, col_offset=20, end_lineno=330, end_col_offset=27), args=[Name(id='doc_id_val', ctx=Load(), lineno=330, col_offset=28, end_lineno=330, end_col_offset=38)], lineno=330, col_offset=20, end_lineno=330, end_col_offset=39), Call(func=Name(id='_as_str', ctx=Load(), lineno=331, col_offset=20, end_lineno=331, end_col_offset=27), args=[Name(id='section_val', ctx=Load(), lineno=331, col_offset=28, end_lineno=331, end_col_offset=39)], lineno=331, col_offset=20, end_lineno=331, end_col_offset=40), Call(func=Name(id='_as_str', ctx=Load(), lineno=332, col_offset=20, end_lineno=332, end_col_offset=27), args=[Name(id='text_val', ctx=Load(), lineno=332, col_offset=28, end_lineno=332, end_col_offset=36)], lineno=332, col_offset=20, end_lineno=332, end_col_offset=37), Call(func=Name(id='_as_str', ctx=Load(), lineno=333, col_offset=20, end_lineno=333, end_col_offset=27), args=[Name(id='title_val', ctx=Load(), lineno=333, col_offset=28, end_lineno=333, end_col_offset=37)], lineno=333, col_offset=20, end_lineno=333, end_col_offset=38)], ctx=Load(), lineno=328, col_offset=16, end_lineno=334, end_col_offset=17), generators=[comprehension(target=Tuple(elts=[Name(id='chunk_id_val', ctx=Store(), lineno=335, col_offset=20, end_lineno=335, end_col_offset=32), Name(id='doc_id_val', ctx=Store(), lineno=335, col_offset=34, end_lineno=335, end_col_offset=44), Name(id='section_val', ctx=Store(), lineno=335, col_offset=46, end_lineno=335, end_col_offset=57), Name(id='text_val', ctx=Store(), lineno=335, col_offset=59, end_lineno=335, end_col_offset=67), Name(id='title_val', ctx=Store(), lineno=335, col_offset=69, end_lineno=335, end_col_offset=78)], ctx=Store(), lineno=335, col_offset=20, end_lineno=335, end_col_offset=78), iter=Name(id='raw_rows', ctx=Load(), lineno=335, col_offset=82, end_lineno=335, end_col_offset=90), is_async=0)], lineno=327, col_offset=63, end_lineno=336, end_col_offset=13), simple=1, lineno=327, col_offset=12, end_lineno=336, end_col_offset=13)], finalbody=[Expr(value=Call(func=Attribute(value=Name(id='con', ctx=Load(), lineno=338, col_offset=12, end_lineno=338, end_col_offset=15), attr='close', ctx=Load(), lineno=338, col_offset=12, end_lineno=338, end_col_offset=21), lineno=338, col_offset=12, end_lineno=338, end_col_offset=23), lineno=338, col_offset=12, end_lineno=338, end_col_offset=23)], lineno=305, col_offset=8, end_lineno=338, end_col_offset=23), Expr(value=Call(func=Attribute(value=Name(id='index', ctx=Load(), lineno=339, col_offset=8, end_lineno=339, end_col_offset=13), attr='_build', ctx=Load(), lineno=339, col_offset=8, end_lineno=339, end_col_offset=20), args=[Name(id='typed_rows', ctx=Load(), lineno=339, col_offset=21, end_lineno=339, end_col_offset=31)], lineno=339, col_offset=8, end_lineno=339, end_col_offset=32), lineno=339, col_offset=8, end_lineno=339, end_col_offset=32), Return(value=Name(id='index', ctx=Load(), lineno=340, col_offset=15, end_lineno=340, end_col_offset=20), lineno=340, col_offset=8, end_lineno=340, end_col_offset=20)], decorator_list=[Name(id='classmethod', ctx=Load(), lineno=271, col_offset=5, end_lineno=271, end_col_offset=16)], returns=Name(id='BM25Index', ctx=Load(), lineno=272, col_offset=48, end_lineno=272, end_col_offset=57), lineno=272, col_offset=4, end_lineno=340, end_col_offset=20), FunctionDef(name='_build', args=arguments(args=[arg(arg='self', lineno=342, col_offset=15, end_lineno=342, end_col_offset=19), arg(arg='rows', annotation=Subscript(value=Name(id='Iterable', ctx=Load(), lineno=342, col_offset=27, end_lineno=342, end_col_offset=35), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=342, col_offset=36, end_lineno=342, end_col_offset=41), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=342, col_offset=42, end_lineno=342, end_col_offset=45), Name(id='str', ctx=Load(), lineno=342, col_offset=47, end_lineno=342, end_col_offset=50), Name(id='str', ctx=Load(), lineno=342, col_offset=52, end_lineno=342, end_col_offset=55), Name(id='str', ctx=Load(), lineno=342, col_offset=57, end_lineno=342, end_col_offset=60), Name(id='str', ctx=Load(), lineno=342, col_offset=62, end_lineno=342, end_col_offset=65)], ctx=Load(), lineno=342, col_offset=42, end_lineno=342, end_col_offset=65), ctx=Load(), lineno=342, col_offset=36, end_lineno=342, end_col_offset=66), ctx=Load(), lineno=342, col_offset=27, end_lineno=342, end_col_offset=67), lineno=342, col_offset=21, end_lineno=342, end_col_offset=67)]), body=[Expr(value=Constant(value='Build index from document rows.\n\n        Processes an iterable of document rows, tokenizes text fields, computes\n        term frequencies with weighted scoring (title 2.0, section 1.2, body\n        1.0), and updates document frequency statistics.\n\n        Parameters\n        ----------\n        rows : Iterable[tuple[str, str, str, str, str]]\n            Iterable of tuples containing (chunk_id, doc_id, section, body, title).\n            Each tuple represents one document chunk to index.\n\n        Notes\n        -----\n        This method clears existing index state before building. Term frequencies\n        are computed separately for title, section, and body fields with different\n        weights. The average document length (avgdl) is computed after processing\n        all rows.\n        ', lineno=343, col_offset=8, end_lineno=361, end_col_offset=11), lineno=343, col_offset=8, end_lineno=361, end_col_offset=11), Expr(value=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=362, col_offset=8, end_lineno=362, end_col_offset=12), attr='docs', ctx=Load(), lineno=362, col_offset=8, end_lineno=362, end_col_offset=17), attr='clear', ctx=Load(), lineno=362, col_offset=8, end_lineno=362, end_col_offset=23), lineno=362, col_offset=8, end_lineno=362, end_col_offset=25), lineno=362, col_offset=8, end_lineno=362, end_col_offset=25), Expr(value=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=363, col_offset=8, end_lineno=363, end_col_offset=12), attr='df', ctx=Load(), lineno=363, col_offset=8, end_lineno=363, end_col_offset=15), attr='clear', ctx=Load(), lineno=363, col_offset=8, end_lineno=363, end_col_offset=21), lineno=363, col_offset=8, end_lineno=363, end_col_offset=23), lineno=363, col_offset=8, end_lineno=363, end_col_offset=23), Assign(targets=[Name(id='dl_sum', ctx=Store(), lineno=364, col_offset=8, end_lineno=364, end_col_offset=14)], value=Constant(value=0.0, lineno=364, col_offset=17, end_lineno=364, end_col_offset=20), lineno=364, col_offset=8, end_lineno=364, end_col_offset=20), For(target=Tuple(elts=[Name(id='chunk_id', ctx=Store(), lineno=365, col_offset=12, end_lineno=365, end_col_offset=20), Name(id='doc_id', ctx=Store(), lineno=365, col_offset=22, end_lineno=365, end_col_offset=28), Name(id='section', ctx=Store(), lineno=365, col_offset=30, end_lineno=365, end_col_offset=37), Name(id='body', ctx=Store(), lineno=365, col_offset=39, end_lineno=365, end_col_offset=43), Name(id='title', ctx=Store(), lineno=365, col_offset=45, end_lineno=365, end_col_offset=50)], ctx=Store(), lineno=365, col_offset=12, end_lineno=365, end_col_offset=50), iter=Name(id='rows', ctx=Load(), lineno=365, col_offset=54, end_lineno=365, end_col_offset=58), body=[AnnAssign(target=Name(id='tf', ctx=Store(), lineno=366, col_offset=12, end_lineno=366, end_col_offset=14), annotation=Subscript(value=Name(id='dict', ctx=Load(), lineno=366, col_offset=16, end_lineno=366, end_col_offset=20), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=366, col_offset=21, end_lineno=366, end_col_offset=24), Name(id='float', ctx=Load(), lineno=366, col_offset=26, end_lineno=366, end_col_offset=31)], ctx=Load(), lineno=366, col_offset=21, end_lineno=366, end_col_offset=31), ctx=Load(), lineno=366, col_offset=16, end_lineno=366, end_col_offset=32), value=Dict(lineno=366, col_offset=35, end_lineno=366, end_col_offset=37), simple=1, lineno=366, col_offset=12, end_lineno=366, end_col_offset=37), For(target=Name(id='term', ctx=Store(), lineno=367, col_offset=16, end_lineno=367, end_col_offset=20), iter=Call(func=Name(id='toks', ctx=Load(), lineno=367, col_offset=24, end_lineno=367, end_col_offset=28), args=[BoolOp(op=Or(), values=[Name(id='body', ctx=Load(), lineno=367, col_offset=29, end_lineno=367, end_col_offset=33), Constant(value='', lineno=367, col_offset=37, end_lineno=367, end_col_offset=39)], lineno=367, col_offset=29, end_lineno=367, end_col_offset=39)], lineno=367, col_offset=24, end_lineno=367, end_col_offset=40), body=[Assign(targets=[Subscript(value=Name(id='tf', ctx=Load(), lineno=368, col_offset=16, end_lineno=368, end_col_offset=18), slice=Name(id='term', ctx=Load(), lineno=368, col_offset=19, end_lineno=368, end_col_offset=23), ctx=Store(), lineno=368, col_offset=16, end_lineno=368, end_col_offset=24)], value=BinOp(left=Call(func=Attribute(value=Name(id='tf', ctx=Load(), lineno=368, col_offset=27, end_lineno=368, end_col_offset=29), attr='get', ctx=Load(), lineno=368, col_offset=27, end_lineno=368, end_col_offset=33), args=[Name(id='term', ctx=Load(), lineno=368, col_offset=34, end_lineno=368, end_col_offset=38), Constant(value=0.0, lineno=368, col_offset=40, end_lineno=368, end_col_offset=43)], lineno=368, col_offset=27, end_lineno=368, end_col_offset=44), op=Add(), right=Constant(value=1.0, lineno=368, col_offset=47, end_lineno=368, end_col_offset=50), lineno=368, col_offset=27, end_lineno=368, end_col_offset=50), lineno=368, col_offset=16, end_lineno=368, end_col_offset=50)], lineno=367, col_offset=12, end_lineno=368, end_col_offset=50), For(target=Name(id='term', ctx=Store(), lineno=369, col_offset=16, end_lineno=369, end_col_offset=20), iter=Call(func=Name(id='toks', ctx=Load(), lineno=369, col_offset=24, end_lineno=369, end_col_offset=28), args=[BoolOp(op=Or(), values=[Name(id='title', ctx=Load(), lineno=369, col_offset=29, end_lineno=369, end_col_offset=34), Constant(value='', lineno=369, col_offset=38, end_lineno=369, end_col_offset=40)], lineno=369, col_offset=29, end_lineno=369, end_col_offset=40)], lineno=369, col_offset=24, end_lineno=369, end_col_offset=41), body=[Assign(targets=[Subscript(value=Name(id='tf', ctx=Load(), lineno=370, col_offset=16, end_lineno=370, end_col_offset=18), slice=Name(id='term', ctx=Load(), lineno=370, col_offset=19, end_lineno=370, end_col_offset=23), ctx=Store(), lineno=370, col_offset=16, end_lineno=370, end_col_offset=24)], value=BinOp(left=Call(func=Attribute(value=Name(id='tf', ctx=Load(), lineno=370, col_offset=27, end_lineno=370, end_col_offset=29), attr='get', ctx=Load(), lineno=370, col_offset=27, end_lineno=370, end_col_offset=33), args=[Name(id='term', ctx=Load(), lineno=370, col_offset=34, end_lineno=370, end_col_offset=38), Constant(value=0.0, lineno=370, col_offset=40, end_lineno=370, end_col_offset=43)], lineno=370, col_offset=27, end_lineno=370, end_col_offset=44), op=Add(), right=Constant(value=2.0, lineno=370, col_offset=47, end_lineno=370, end_col_offset=50), lineno=370, col_offset=27, end_lineno=370, end_col_offset=50), lineno=370, col_offset=16, end_lineno=370, end_col_offset=50)], lineno=369, col_offset=12, end_lineno=370, end_col_offset=50), For(target=Name(id='term', ctx=Store(), lineno=371, col_offset=16, end_lineno=371, end_col_offset=20), iter=Call(func=Name(id='toks', ctx=Load(), lineno=371, col_offset=24, end_lineno=371, end_col_offset=28), args=[BoolOp(op=Or(), values=[Name(id='section', ctx=Load(), lineno=371, col_offset=29, end_lineno=371, end_col_offset=36), Constant(value='', lineno=371, col_offset=40, end_lineno=371, end_col_offset=42)], lineno=371, col_offset=29, end_lineno=371, end_col_offset=42)], lineno=371, col_offset=24, end_lineno=371, end_col_offset=43), body=[Assign(targets=[Subscript(value=Name(id='tf', ctx=Load(), lineno=372, col_offset=16, end_lineno=372, end_col_offset=18), slice=Name(id='term', ctx=Load(), lineno=372, col_offset=19, end_lineno=372, end_col_offset=23), ctx=Store(), lineno=372, col_offset=16, end_lineno=372, end_col_offset=24)], value=BinOp(left=Call(func=Attribute(value=Name(id='tf', ctx=Load(), lineno=372, col_offset=27, end_lineno=372, end_col_offset=29), attr='get', ctx=Load(), lineno=372, col_offset=27, end_lineno=372, end_col_offset=33), args=[Name(id='term', ctx=Load(), lineno=372, col_offset=34, end_lineno=372, end_col_offset=38), Constant(value=0.0, lineno=372, col_offset=40, end_lineno=372, end_col_offset=43)], lineno=372, col_offset=27, end_lineno=372, end_col_offset=44), op=Add(), right=Constant(value=1.2, lineno=372, col_offset=47, end_lineno=372, end_col_offset=50), lineno=372, col_offset=27, end_lineno=372, end_col_offset=50), lineno=372, col_offset=16, end_lineno=372, end_col_offset=50)], lineno=371, col_offset=12, end_lineno=372, end_col_offset=50), Assign(targets=[Name(id='dl', ctx=Store(), lineno=373, col_offset=12, end_lineno=373, end_col_offset=14)], value=Call(func=Name(id='sum', ctx=Load(), lineno=373, col_offset=17, end_lineno=373, end_col_offset=20), args=[Call(func=Attribute(value=Name(id='tf', ctx=Load(), lineno=373, col_offset=21, end_lineno=373, end_col_offset=23), attr='values', ctx=Load(), lineno=373, col_offset=21, end_lineno=373, end_col_offset=30), lineno=373, col_offset=21, end_lineno=373, end_col_offset=32)], lineno=373, col_offset=17, end_lineno=373, end_col_offset=33), lineno=373, col_offset=12, end_lineno=373, end_col_offset=33), Expr(value=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=374, col_offset=12, end_lineno=374, end_col_offset=16), attr='docs', ctx=Load(), lineno=374, col_offset=12, end_lineno=374, end_col_offset=21), attr='append', ctx=Load(), lineno=374, col_offset=12, end_lineno=374, end_col_offset=28), args=[Call(func=Name(id='BM25Doc', ctx=Load(), lineno=375, col_offset=16, end_lineno=375, end_col_offset=23), keywords=[keyword(arg='chunk_id', value=Name(id='chunk_id', ctx=Load(), lineno=376, col_offset=29, end_lineno=376, end_col_offset=37), lineno=376, col_offset=20, end_lineno=376, end_col_offset=37), keyword(arg='doc_id', value=BoolOp(op=Or(), values=[Name(id='doc_id', ctx=Load(), lineno=377, col_offset=27, end_lineno=377, end_col_offset=33), Constant(value='urn:doc:fixture', lineno=377, col_offset=37, end_lineno=377, end_col_offset=54)], lineno=377, col_offset=27, end_lineno=377, end_col_offset=54), lineno=377, col_offset=20, end_lineno=377, end_col_offset=54), keyword(arg='title', value=BoolOp(op=Or(), values=[Name(id='title', ctx=Load(), lineno=378, col_offset=26, end_lineno=378, end_col_offset=31), Constant(value='Fixture', lineno=378, col_offset=35, end_lineno=378, end_col_offset=44)], lineno=378, col_offset=26, end_lineno=378, end_col_offset=44), lineno=378, col_offset=20, end_lineno=378, end_col_offset=44), keyword(arg='section', value=BoolOp(op=Or(), values=[Name(id='section', ctx=Load(), lineno=379, col_offset=28, end_lineno=379, end_col_offset=35), Constant(value='', lineno=379, col_offset=39, end_lineno=379, end_col_offset=41)], lineno=379, col_offset=28, end_lineno=379, end_col_offset=41), lineno=379, col_offset=20, end_lineno=379, end_col_offset=41), keyword(arg='tf', value=Name(id='tf', ctx=Load(), lineno=380, col_offset=23, end_lineno=380, end_col_offset=25), lineno=380, col_offset=20, end_lineno=380, end_col_offset=25), keyword(arg='dl', value=Name(id='dl', ctx=Load(), lineno=381, col_offset=23, end_lineno=381, end_col_offset=25), lineno=381, col_offset=20, end_lineno=381, end_col_offset=25)], lineno=375, col_offset=16, end_lineno=382, end_col_offset=17)], lineno=374, col_offset=12, end_lineno=383, end_col_offset=13), lineno=374, col_offset=12, end_lineno=383, end_col_offset=13), AugAssign(target=Name(id='dl_sum', ctx=Store(), lineno=384, col_offset=12, end_lineno=384, end_col_offset=18), op=Add(), value=Name(id='dl', ctx=Load(), lineno=384, col_offset=22, end_lineno=384, end_col_offset=24), lineno=384, col_offset=12, end_lineno=384, end_col_offset=24), For(target=Name(id='term', ctx=Store(), lineno=385, col_offset=16, end_lineno=385, end_col_offset=20), iter=Call(func=Name(id='set', ctx=Load(), lineno=385, col_offset=24, end_lineno=385, end_col_offset=27), args=[Call(func=Attribute(value=Name(id='tf', ctx=Load(), lineno=385, col_offset=28, end_lineno=385, end_col_offset=30), attr='keys', ctx=Load(), lineno=385, col_offset=28, end_lineno=385, end_col_offset=35), lineno=385, col_offset=28, end_lineno=385, end_col_offset=37)], lineno=385, col_offset=24, end_lineno=385, end_col_offset=38), body=[Assign(targets=[Subscript(value=Attribute(value=Name(id='self', ctx=Load(), lineno=386, col_offset=16, end_lineno=386, end_col_offset=20), attr='df', ctx=Load(), lineno=386, col_offset=16, end_lineno=386, end_col_offset=23), slice=Name(id='term', ctx=Load(), lineno=386, col_offset=24, end_lineno=386, end_col_offset=28), ctx=Store(), lineno=386, col_offset=16, end_lineno=386, end_col_offset=29)], value=BinOp(left=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=386, col_offset=32, end_lineno=386, end_col_offset=36), attr='df', ctx=Load(), lineno=386, col_offset=32, end_lineno=386, end_col_offset=39), attr='get', ctx=Load(), lineno=386, col_offset=32, end_lineno=386, end_col_offset=43), args=[Name(id='term', ctx=Load(), lineno=386, col_offset=44, end_lineno=386, end_col_offset=48), Constant(value=0, lineno=386, col_offset=50, end_lineno=386, end_col_offset=51)], lineno=386, col_offset=32, end_lineno=386, end_col_offset=52), op=Add(), right=Constant(value=1, lineno=386, col_offset=55, end_lineno=386, end_col_offset=56), lineno=386, col_offset=32, end_lineno=386, end_col_offset=56), lineno=386, col_offset=16, end_lineno=386, end_col_offset=56)], lineno=385, col_offset=12, end_lineno=386, end_col_offset=56)], lineno=365, col_offset=8, end_lineno=386, end_col_offset=56), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=387, col_offset=8, end_lineno=387, end_col_offset=12), attr='N', ctx=Store(), lineno=387, col_offset=8, end_lineno=387, end_col_offset=14)], value=Call(func=Name(id='len', ctx=Load(), lineno=387, col_offset=17, end_lineno=387, end_col_offset=20), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=387, col_offset=21, end_lineno=387, end_col_offset=25), attr='docs', ctx=Load(), lineno=387, col_offset=21, end_lineno=387, end_col_offset=30)], lineno=387, col_offset=17, end_lineno=387, end_col_offset=31), lineno=387, col_offset=8, end_lineno=387, end_col_offset=31), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=388, col_offset=8, end_lineno=388, end_col_offset=12), attr='avgdl', ctx=Store(), lineno=388, col_offset=8, end_lineno=388, end_col_offset=18)], value=IfExp(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=388, col_offset=42, end_lineno=388, end_col_offset=46), attr='N', ctx=Load(), lineno=388, col_offset=42, end_lineno=388, end_col_offset=48), ops=[Gt()], comparators=[Constant(value=0, lineno=388, col_offset=51, end_lineno=388, end_col_offset=52)], lineno=388, col_offset=42, end_lineno=388, end_col_offset=52), body=BinOp(left=Name(id='dl_sum', ctx=Load(), lineno=388, col_offset=22, end_lineno=388, end_col_offset=28), op=Div(), right=Attribute(value=Name(id='self', ctx=Load(), lineno=388, col_offset=31, end_lineno=388, end_col_offset=35), attr='N', ctx=Load(), lineno=388, col_offset=31, end_lineno=388, end_col_offset=37), lineno=388, col_offset=22, end_lineno=388, end_col_offset=37), orelse=Constant(value=0.0, lineno=388, col_offset=58, end_lineno=388, end_col_offset=61), lineno=388, col_offset=21, end_lineno=388, end_col_offset=61), lineno=388, col_offset=8, end_lineno=388, end_col_offset=61)], returns=Constant(value=None, lineno=342, col_offset=72, end_lineno=342, end_col_offset=76), lineno=342, col_offset=4, end_lineno=388, end_col_offset=61), FunctionDef(name='from_parquet', args=arguments(args=[arg(arg='cls', lineno=391, col_offset=21, end_lineno=391, end_col_offset=24), arg(arg='path', annotation=Name(id='str', ctx=Load(), lineno=391, col_offset=32, end_lineno=391, end_col_offset=35), lineno=391, col_offset=26, end_lineno=391, end_col_offset=35)], kwonlyargs=[arg(arg='k1', annotation=Name(id='float', ctx=Load(), lineno=391, col_offset=44, end_lineno=391, end_col_offset=49), lineno=391, col_offset=40, end_lineno=391, end_col_offset=49), arg(arg='b', annotation=Name(id='float', ctx=Load(), lineno=391, col_offset=60, end_lineno=391, end_col_offset=65), lineno=391, col_offset=57, end_lineno=391, end_col_offset=65)], kw_defaults=[Constant(value=0.9, lineno=391, col_offset=52, end_lineno=391, end_col_offset=55), Constant(value=0.4, lineno=391, col_offset=68, end_lineno=391, end_col_offset=71)]), body=[Expr(value=Constant(value='Build BM25 index from a single parquet file.\n\n        Creates a BM25 index by reading document chunks from a parquet file.\n        Uses DuckDB to read the parquet file and extracts chunk_id, doc_id,\n        section, and text fields for indexing.\n\n        Parameters\n        ----------\n        path : str\n            Path to parquet file containing document chunks. Must exist and be\n            within allowed directories (validated to prevent path traversal).\n        k1 : float, optional\n            Term frequency saturation parameter. Defaults to 0.9.\n        b : float, optional\n            Document length normalization parameter. Defaults to 0.4.\n\n        Returns\n        -------\n        BM25Index\n            Initialized BM25 index with documents loaded from parquet file.\n\n        Notes\n        -----\n        Path validation prevents path traversal attacks. The method uses an\n        in-memory DuckDB connection to read the parquet file. Title fields are\n        not included from parquet (defaults to empty string). Errors raised by\n        :func:`_validate_parquet_path` propagate unchanged.\n        ', lineno=392, col_offset=8, end_lineno=419, end_col_offset=11), lineno=392, col_offset=8, end_lineno=419, end_col_offset=11), Assign(targets=[Name(id='index', ctx=Store(), lineno=420, col_offset=8, end_lineno=420, end_col_offset=13)], value=Call(func=Name(id='cls', ctx=Load(), lineno=420, col_offset=16, end_lineno=420, end_col_offset=19), keywords=[keyword(arg='k1', value=Name(id='k1', ctx=Load(), lineno=420, col_offset=23, end_lineno=420, end_col_offset=25), lineno=420, col_offset=20, end_lineno=420, end_col_offset=25), keyword(arg='b', value=Name(id='b', ctx=Load(), lineno=420, col_offset=29, end_lineno=420, end_col_offset=30), lineno=420, col_offset=27, end_lineno=420, end_col_offset=30)], lineno=420, col_offset=16, end_lineno=420, end_col_offset=31), lineno=420, col_offset=8, end_lineno=420, end_col_offset=31), Assign(targets=[Name(id='con', ctx=Store(), lineno=421, col_offset=8, end_lineno=421, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='duckdb', ctx=Load(), lineno=421, col_offset=14, end_lineno=421, end_col_offset=20), attr='connect', ctx=Load(), lineno=421, col_offset=14, end_lineno=421, end_col_offset=28), keywords=[keyword(arg='database', value=Constant(value=':memory:', lineno=421, col_offset=38, end_lineno=421, end_col_offset=48), lineno=421, col_offset=29, end_lineno=421, end_col_offset=48)], lineno=421, col_offset=14, end_lineno=421, end_col_offset=49), lineno=421, col_offset=8, end_lineno=421, end_col_offset=49), Try(body=[Assign(targets=[Name(id='resolved_path', ctx=Store(), lineno=424, col_offset=12, end_lineno=424, end_col_offset=25)], value=Call(func=Name(id='_validate_parquet_path', ctx=Load(), lineno=424, col_offset=28, end_lineno=424, end_col_offset=50), args=[Name(id='path', ctx=Load(), lineno=424, col_offset=51, end_lineno=424, end_col_offset=55)], lineno=424, col_offset=28, end_lineno=424, end_col_offset=56), lineno=424, col_offset=12, end_lineno=424, end_col_offset=56), Assign(targets=[Name(id='sql', ctx=Store(), lineno=425, col_offset=12, end_lineno=425, end_col_offset=15)], value=Constant(value="\n                SELECT chunk_id,\n                       coalesce(doc_id, chunk_id) AS doc_id,\n                       coalesce(section,'') AS section,\n                       text,\n                       '' AS title\n                FROM read_parquet(?, union_by_name=true)\n            ", lineno=425, col_offset=18, end_lineno=432, end_col_offset=15), lineno=425, col_offset=12, end_lineno=432, end_col_offset=15), Assign(targets=[Name(id='rows', ctx=Store(), lineno=433, col_offset=12, end_lineno=433, end_col_offset=16)], value=Call(func=Name(id='fetch_all', ctx=Load(), lineno=433, col_offset=19, end_lineno=433, end_col_offset=28), args=[Name(id='con', ctx=Load(), lineno=433, col_offset=29, end_lineno=433, end_col_offset=32), Name(id='sql', ctx=Load(), lineno=433, col_offset=34, end_lineno=433, end_col_offset=37), List(elts=[Call(func=Name(id='str', ctx=Load(), lineno=433, col_offset=40, end_lineno=433, end_col_offset=43), args=[Name(id='resolved_path', ctx=Load(), lineno=433, col_offset=44, end_lineno=433, end_col_offset=57)], lineno=433, col_offset=40, end_lineno=433, end_col_offset=58)], ctx=Load(), lineno=433, col_offset=39, end_lineno=433, end_col_offset=59)], lineno=433, col_offset=19, end_lineno=433, end_col_offset=60), lineno=433, col_offset=12, end_lineno=433, end_col_offset=60), AnnAssign(target=Name(id='typed_rows', ctx=Store(), lineno=434, col_offset=12, end_lineno=434, end_col_offset=22), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=434, col_offset=24, end_lineno=434, end_col_offset=28), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=434, col_offset=29, end_lineno=434, end_col_offset=34), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=434, col_offset=35, end_lineno=434, end_col_offset=38), Name(id='str', ctx=Load(), lineno=434, col_offset=40, end_lineno=434, end_col_offset=43), Name(id='str', ctx=Load(), lineno=434, col_offset=45, end_lineno=434, end_col_offset=48), Name(id='str', ctx=Load(), lineno=434, col_offset=50, end_lineno=434, end_col_offset=53), Name(id='str', ctx=Load(), lineno=434, col_offset=55, end_lineno=434, end_col_offset=58)], ctx=Load(), lineno=434, col_offset=35, end_lineno=434, end_col_offset=58), ctx=Load(), lineno=434, col_offset=29, end_lineno=434, end_col_offset=59), ctx=Load(), lineno=434, col_offset=24, end_lineno=434, end_col_offset=60), value=ListComp(elt=Tuple(elts=[Call(func=Name(id='_as_str', ctx=Load(), lineno=436, col_offset=20, end_lineno=436, end_col_offset=27), args=[Name(id='chunk_id_val', ctx=Load(), lineno=436, col_offset=28, end_lineno=436, end_col_offset=40)], lineno=436, col_offset=20, end_lineno=436, end_col_offset=41), Call(func=Name(id='_as_str', ctx=Load(), lineno=437, col_offset=20, end_lineno=437, end_col_offset=27), args=[Name(id='doc_id_val', ctx=Load(), lineno=437, col_offset=28, end_lineno=437, end_col_offset=38)], lineno=437, col_offset=20, end_lineno=437, end_col_offset=39), Call(func=Name(id='_as_str', ctx=Load(), lineno=438, col_offset=20, end_lineno=438, end_col_offset=27), args=[Name(id='section_val', ctx=Load(), lineno=438, col_offset=28, end_lineno=438, end_col_offset=39)], lineno=438, col_offset=20, end_lineno=438, end_col_offset=40), Call(func=Name(id='_as_str', ctx=Load(), lineno=439, col_offset=20, end_lineno=439, end_col_offset=27), args=[Name(id='text_val', ctx=Load(), lineno=439, col_offset=28, end_lineno=439, end_col_offset=36)], lineno=439, col_offset=20, end_lineno=439, end_col_offset=37), Constant(value='', lineno=440, col_offset=20, end_lineno=440, end_col_offset=22)], ctx=Load(), lineno=435, col_offset=16, end_lineno=441, end_col_offset=17), generators=[comprehension(target=Tuple(elts=[Name(id='chunk_id_val', ctx=Store(), lineno=442, col_offset=20, end_lineno=442, end_col_offset=32), Name(id='doc_id_val', ctx=Store(), lineno=442, col_offset=34, end_lineno=442, end_col_offset=44), Name(id='section_val', ctx=Store(), lineno=442, col_offset=46, end_lineno=442, end_col_offset=57), Name(id='text_val', ctx=Store(), lineno=442, col_offset=59, end_lineno=442, end_col_offset=67), Starred(value=Name(id='_', ctx=Store(), lineno=442, col_offset=70, end_lineno=442, end_col_offset=71), ctx=Store(), lineno=442, col_offset=69, end_lineno=442, end_col_offset=71)], ctx=Store(), lineno=442, col_offset=20, end_lineno=442, end_col_offset=71), iter=Name(id='rows', ctx=Load(), lineno=442, col_offset=75, end_lineno=442, end_col_offset=79), is_async=0)], lineno=434, col_offset=63, end_lineno=443, end_col_offset=13), simple=1, lineno=434, col_offset=12, end_lineno=443, end_col_offset=13)], finalbody=[Expr(value=Call(func=Attribute(value=Name(id='con', ctx=Load(), lineno=445, col_offset=12, end_lineno=445, end_col_offset=15), attr='close', ctx=Load(), lineno=445, col_offset=12, end_lineno=445, end_col_offset=21), lineno=445, col_offset=12, end_lineno=445, end_col_offset=23), lineno=445, col_offset=12, end_lineno=445, end_col_offset=23)], lineno=422, col_offset=8, end_lineno=445, end_col_offset=23), Expr(value=Call(func=Attribute(value=Name(id='index', ctx=Load(), lineno=446, col_offset=8, end_lineno=446, end_col_offset=13), attr='_build', ctx=Load(), lineno=446, col_offset=8, end_lineno=446, end_col_offset=20), args=[Name(id='typed_rows', ctx=Load(), lineno=446, col_offset=21, end_lineno=446, end_col_offset=31)], lineno=446, col_offset=8, end_lineno=446, end_col_offset=32), lineno=446, col_offset=8, end_lineno=446, end_col_offset=32), Return(value=Name(id='index', ctx=Load(), lineno=447, col_offset=15, end_lineno=447, end_col_offset=20), lineno=447, col_offset=8, end_lineno=447, end_col_offset=20)], decorator_list=[Name(id='classmethod', ctx=Load(), lineno=390, col_offset=5, end_lineno=390, end_col_offset=16)], returns=Name(id='BM25Index', ctx=Load(), lineno=391, col_offset=76, end_lineno=391, end_col_offset=85), lineno=391, col_offset=4, end_lineno=447, end_col_offset=20), FunctionDef(name='save', args=arguments(args=[arg(arg='self', lineno=449, col_offset=13, end_lineno=449, end_col_offset=17), arg(arg='path', annotation=Name(id='str', ctx=Load(), lineno=449, col_offset=25, end_lineno=449, end_col_offset=28), lineno=449, col_offset=19, end_lineno=449, end_col_offset=28)]), body=[Expr(value=Constant(value='Save BM25 index metadata to JSON with schema validation and checksum.\n\n        Serializes index metadata (parameters, document frequencies, and document\n        list) to JSON format, validates it against the BM25 metadata schema, and\n        writes a SHA256 checksum file for integrity verification.\n\n        Parameters\n        ----------\n        path : str\n            Output file path for JSON metadata. A `.sha256` checksum file will\n            be written alongside it.\n\n        Notes\n        -----\n        The serialized payload includes: k1, b, N (document count), avgdl (average\n        document length), df (document frequency dictionary), and docs (list of\n        BM25Doc data dictionaries). Exceptions raised by :func:`serialize_json`\n        propagate unchanged.\n\n        Examples\n        --------\n        >>> index = BM25Index(k1=0.9, b=0.4)\n        >>> index.N = 100\n        >>> index.save("/tmp/index.json")\n        ', lineno=450, col_offset=8, end_lineno=474, end_col_offset=11), lineno=450, col_offset=8, end_lineno=474, end_col_offset=11), Assign(targets=[Name(id='path_obj', ctx=Store(), lineno=475, col_offset=8, end_lineno=475, end_col_offset=16)], value=Call(func=Name(id='Path', ctx=Load(), lineno=475, col_offset=19, end_lineno=475, end_col_offset=23), args=[Name(id='path', ctx=Load(), lineno=475, col_offset=24, end_lineno=475, end_col_offset=28)], lineno=475, col_offset=19, end_lineno=475, end_col_offset=29), lineno=475, col_offset=8, end_lineno=475, end_col_offset=29), Assign(targets=[Name(id='schema_path', ctx=Store(), lineno=476, col_offset=8, end_lineno=476, end_col_offset=19)], value=BinOp(left=BinOp(left=BinOp(left=Attribute(value=Attribute(value=Attribute(value=Call(func=Name(id='Path', ctx=Load(), lineno=477, col_offset=12, end_lineno=477, end_col_offset=16), args=[Name(id='__file__', ctx=Load(), lineno=477, col_offset=17, end_lineno=477, end_col_offset=25)], lineno=477, col_offset=12, end_lineno=477, end_col_offset=26), attr='parent', ctx=Load(), lineno=477, col_offset=12, end_lineno=477, end_col_offset=33), attr='parent', ctx=Load(), lineno=477, col_offset=12, end_lineno=477, end_col_offset=40), attr='parent', ctx=Load(), lineno=477, col_offset=12, end_lineno=477, end_col_offset=47), op=Div(), right=Constant(value='schema', lineno=477, col_offset=50, end_lineno=477, end_col_offset=58), lineno=477, col_offset=12, end_lineno=477, end_col_offset=58), op=Div(), right=Constant(value='models', lineno=477, col_offset=61, end_lineno=477, end_col_offset=69), lineno=477, col_offset=12, end_lineno=477, end_col_offset=69), op=Div(), right=Constant(value='bm25_metadata.v1.json', lineno=477, col_offset=72, end_lineno=477, end_col_offset=95), lineno=477, col_offset=12, end_lineno=477, end_col_offset=95), lineno=476, col_offset=8, end_lineno=478, end_col_offset=9), Assign(targets=[Name(id='docs_data', ctx=Store(), lineno=480, col_offset=8, end_lineno=480, end_col_offset=17)], value=ListComp(elt=Dict(keys=[Constant(value='chunk_id', lineno=482, col_offset=16, end_lineno=482, end_col_offset=26), Constant(value='doc_id', lineno=483, col_offset=16, end_lineno=483, end_col_offset=24), Constant(value='title', lineno=484, col_offset=16, end_lineno=484, end_col_offset=23), Constant(value='section', lineno=485, col_offset=16, end_lineno=485, end_col_offset=25), Constant(value='tf', lineno=486, col_offset=16, end_lineno=486, end_col_offset=20), Constant(value='dl', lineno=487, col_offset=16, end_lineno=487, end_col_offset=20)], values=[Attribute(value=Name(id='doc', ctx=Load(), lineno=482, col_offset=28, end_lineno=482, end_col_offset=31), attr='chunk_id', ctx=Load(), lineno=482, col_offset=28, end_lineno=482, end_col_offset=40), Attribute(value=Name(id='doc', ctx=Load(), lineno=483, col_offset=26, end_lineno=483, end_col_offset=29), attr='doc_id', ctx=Load(), lineno=483, col_offset=26, end_lineno=483, end_col_offset=36), Attribute(value=Name(id='doc', ctx=Load(), lineno=484, col_offset=25, end_lineno=484, end_col_offset=28), attr='title', ctx=Load(), lineno=484, col_offset=25, end_lineno=484, end_col_offset=34), Attribute(value=Name(id='doc', ctx=Load(), lineno=485, col_offset=27, end_lineno=485, end_col_offset=30), attr='section', ctx=Load(), lineno=485, col_offset=27, end_lineno=485, end_col_offset=38), Attribute(value=Name(id='doc', ctx=Load(), lineno=486, col_offset=22, end_lineno=486, end_col_offset=25), attr='tf', ctx=Load(), lineno=486, col_offset=22, end_lineno=486, end_col_offset=28), Attribute(value=Name(id='doc', ctx=Load(), lineno=487, col_offset=22, end_lineno=487, end_col_offset=25), attr='dl', ctx=Load(), lineno=487, col_offset=22, end_lineno=487, end_col_offset=28)], lineno=481, col_offset=12, end_lineno=488, end_col_offset=13), generators=[comprehension(target=Name(id='doc', ctx=Store(), lineno=489, col_offset=16, end_lineno=489, end_col_offset=19), iter=Attribute(value=Name(id='self', ctx=Load(), lineno=489, col_offset=23, end_lineno=489, end_col_offset=27), attr='docs', ctx=Load(), lineno=489, col_offset=23, end_lineno=489, end_col_offset=32), is_async=0)], lineno=480, col_offset=20, end_lineno=490, end_col_offset=9), lineno=480, col_offset=8, end_lineno=490, end_col_offset=9), Assign(targets=[Name(id='payload', ctx=Store(), lineno=491, col_offset=8, end_lineno=491, end_col_offset=15)], value=Dict(keys=[Constant(value='k1', lineno=492, col_offset=12, end_lineno=492, end_col_offset=16), Constant(value='b', lineno=493, col_offset=12, end_lineno=493, end_col_offset=15), Constant(value='N', lineno=494, col_offset=12, end_lineno=494, end_col_offset=15), Constant(value='avgdl', lineno=495, col_offset=12, end_lineno=495, end_col_offset=19), Constant(value='df', lineno=496, col_offset=12, end_lineno=496, end_col_offset=16), Constant(value='docs', lineno=497, col_offset=12, end_lineno=497, end_col_offset=18)], values=[Attribute(value=Name(id='self', ctx=Load(), lineno=492, col_offset=18, end_lineno=492, end_col_offset=22), attr='k1', ctx=Load(), lineno=492, col_offset=18, end_lineno=492, end_col_offset=25), Attribute(value=Name(id='self', ctx=Load(), lineno=493, col_offset=17, end_lineno=493, end_col_offset=21), attr='b', ctx=Load(), lineno=493, col_offset=17, end_lineno=493, end_col_offset=23), Attribute(value=Name(id='self', ctx=Load(), lineno=494, col_offset=17, end_lineno=494, end_col_offset=21), attr='N', ctx=Load(), lineno=494, col_offset=17, end_lineno=494, end_col_offset=23), Attribute(value=Name(id='self', ctx=Load(), lineno=495, col_offset=21, end_lineno=495, end_col_offset=25), attr='avgdl', ctx=Load(), lineno=495, col_offset=21, end_lineno=495, end_col_offset=31), Attribute(value=Name(id='self', ctx=Load(), lineno=496, col_offset=18, end_lineno=496, end_col_offset=22), attr='df', ctx=Load(), lineno=496, col_offset=18, end_lineno=496, end_col_offset=25), Name(id='docs_data', ctx=Load(), lineno=497, col_offset=20, end_lineno=497, end_col_offset=29)], lineno=491, col_offset=18, end_lineno=498, end_col_offset=9), lineno=491, col_offset=8, end_lineno=498, end_col_offset=9), Expr(value=Call(func=Name(id='serialize_json', ctx=Load(), lineno=499, col_offset=8, end_lineno=499, end_col_offset=22), args=[Name(id='payload', ctx=Load(), lineno=499, col_offset=23, end_lineno=499, end_col_offset=30), Name(id='schema_path', ctx=Load(), lineno=499, col_offset=32, end_lineno=499, end_col_offset=43), Name(id='path_obj', ctx=Load(), lineno=499, col_offset=45, end_lineno=499, end_col_offset=53)], lineno=499, col_offset=8, end_lineno=499, end_col_offset=54), lineno=499, col_offset=8, end_lineno=499, end_col_offset=54)], returns=Constant(value=None, lineno=449, col_offset=33, end_lineno=449, end_col_offset=37), lineno=449, col_offset=4, end_lineno=499, end_col_offset=54), FunctionDef(name='load', args=arguments(args=[arg(arg='cls', lineno=502, col_offset=13, end_lineno=502, end_col_offset=16), arg(arg='path', annotation=Name(id='str', ctx=Load(), lineno=502, col_offset=24, end_lineno=502, end_col_offset=27), lineno=502, col_offset=18, end_lineno=502, end_col_offset=27)]), body=[Expr(value=Constant(value='Load BM25 index metadata from JSON with schema validation and checksum verification.\n\n        Deserializes index metadata from JSON, verifies the SHA256 checksum (if\n        present), validates against the BM25 metadata schema, and reconstructs\n        the index instance. Supports legacy pickle format as fallback.\n\n        Parameters\n        ----------\n        path : str\n            Path to JSON metadata file. A `.sha256` checksum file will be\n            verified if present.\n\n        Returns\n        -------\n        BM25Index\n            Reconstructed BM25 index instance with all metadata loaded.\n\n        Notes\n        -----\n        The method attempts to load from JSON first. If the file has a `.pkl`\n        extension and JSON loading fails, it falls back to legacy pickle format\n        (with validation). All document frequencies, term frequencies, and\n        document metadata are reconstructed from the payload. Exceptions raised\n        by :func:`deserialize_json` or legacy payload loaders propagate\n        unchanged.\n\n        Examples\n        --------\n        >>> index = BM25Index.load("/tmp/index.json")\n        >>> assert index.N > 0\n        ', lineno=503, col_offset=8, end_lineno=533, end_col_offset=11), lineno=503, col_offset=8, end_lineno=533, end_col_offset=11), Assign(targets=[Name(id='path_obj', ctx=Store(), lineno=534, col_offset=8, end_lineno=534, end_col_offset=16)], value=Call(func=Name(id='Path', ctx=Load(), lineno=534, col_offset=19, end_lineno=534, end_col_offset=23), args=[Name(id='path', ctx=Load(), lineno=534, col_offset=24, end_lineno=534, end_col_offset=28)], lineno=534, col_offset=19, end_lineno=534, end_col_offset=29), lineno=534, col_offset=8, end_lineno=534, end_col_offset=29), Assign(targets=[Name(id='schema_path', ctx=Store(), lineno=535, col_offset=8, end_lineno=535, end_col_offset=19)], value=BinOp(left=BinOp(left=BinOp(left=Attribute(value=Attribute(value=Attribute(value=Call(func=Name(id='Path', ctx=Load(), lineno=536, col_offset=12, end_lineno=536, end_col_offset=16), args=[Name(id='__file__', ctx=Load(), lineno=536, col_offset=17, end_lineno=536, end_col_offset=25)], lineno=536, col_offset=12, end_lineno=536, end_col_offset=26), attr='parent', ctx=Load(), lineno=536, col_offset=12, end_lineno=536, end_col_offset=33), attr='parent', ctx=Load(), lineno=536, col_offset=12, end_lineno=536, end_col_offset=40), attr='parent', ctx=Load(), lineno=536, col_offset=12, end_lineno=536, end_col_offset=47), op=Div(), right=Constant(value='schema', lineno=536, col_offset=50, end_lineno=536, end_col_offset=58), lineno=536, col_offset=12, end_lineno=536, end_col_offset=58), op=Div(), right=Constant(value='models', lineno=536, col_offset=61, end_lineno=536, end_col_offset=69), lineno=536, col_offset=12, end_lineno=536, end_col_offset=69), op=Div(), right=Constant(value='bm25_metadata.v1.json', lineno=536, col_offset=72, end_lineno=536, end_col_offset=95), lineno=536, col_offset=12, end_lineno=536, end_col_offset=95), lineno=535, col_offset=8, end_lineno=537, end_col_offset=9), Assign(targets=[Name(id='payload', ctx=Store(), lineno=538, col_offset=8, end_lineno=538, end_col_offset=15)], value=Call(func=Attribute(value=Name(id='cls', ctx=Load(), lineno=538, col_offset=18, end_lineno=538, end_col_offset=21), attr='_load_payload', ctx=Load(), lineno=538, col_offset=18, end_lineno=538, end_col_offset=35), args=[Name(id='path_obj', ctx=Load(), lineno=538, col_offset=36, end_lineno=538, end_col_offset=44), Name(id='schema_path', ctx=Load(), lineno=538, col_offset=46, end_lineno=538, end_col_offset=57)], lineno=538, col_offset=18, end_lineno=538, end_col_offset=58), lineno=538, col_offset=8, end_lineno=538, end_col_offset=58), Return(value=Call(func=Attribute(value=Name(id='cls', ctx=Load(), lineno=539, col_offset=15, end_lineno=539, end_col_offset=18), attr='_index_from_payload', ctx=Load(), lineno=539, col_offset=15, end_lineno=539, end_col_offset=38), args=[Name(id='payload', ctx=Load(), lineno=539, col_offset=39, end_lineno=539, end_col_offset=46)], lineno=539, col_offset=15, end_lineno=539, end_col_offset=47), lineno=539, col_offset=8, end_lineno=539, end_col_offset=47)], decorator_list=[Name(id='classmethod', ctx=Load(), lineno=501, col_offset=5, end_lineno=501, end_col_offset=16)], returns=Name(id='BM25Index', ctx=Load(), lineno=502, col_offset=32, end_lineno=502, end_col_offset=41), lineno=502, col_offset=4, end_lineno=539, end_col_offset=47), FunctionDef(name='_coerce_payload', args=arguments(args=[arg(arg='raw', annotation=Name(id='object', ctx=Load(), lineno=542, col_offset=29, end_lineno=542, end_col_offset=35), lineno=542, col_offset=24, end_lineno=542, end_col_offset=35)]), body=[If(test=UnaryOp(op=Not(), operand=Call(func=Name(id='isinstance', ctx=Load(), lineno=543, col_offset=15, end_lineno=543, end_col_offset=25), args=[Name(id='raw', ctx=Load(), lineno=543, col_offset=26, end_lineno=543, end_col_offset=29), Name(id='dict', ctx=Load(), lineno=543, col_offset=31, end_lineno=543, end_col_offset=35)], lineno=543, col_offset=15, end_lineno=543, end_col_offset=36), lineno=543, col_offset=11, end_lineno=543, end_col_offset=36), body=[Return(value=Dict(lineno=544, col_offset=19, end_lineno=544, end_col_offset=21), lineno=544, col_offset=12, end_lineno=544, end_col_offset=21)], lineno=543, col_offset=8, end_lineno=544, end_col_offset=21), Return(value=Call(func=Name(id='cast', ctx=Load(), lineno=545, col_offset=15, end_lineno=545, end_col_offset=19), args=[Constant(value='dict[str, JsonValue]', lineno=545, col_offset=20, end_lineno=545, end_col_offset=42), Name(id='raw', ctx=Load(), lineno=545, col_offset=44, end_lineno=545, end_col_offset=47)], lineno=545, col_offset=15, end_lineno=545, end_col_offset=48), lineno=545, col_offset=8, end_lineno=545, end_col_offset=48)], decorator_list=[Name(id='staticmethod', ctx=Load(), lineno=541, col_offset=5, end_lineno=541, end_col_offset=17)], returns=Subscript(value=Name(id='dict', ctx=Load(), lineno=542, col_offset=40, end_lineno=542, end_col_offset=44), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=542, col_offset=45, end_lineno=542, end_col_offset=48), Name(id='JsonValue', ctx=Load(), lineno=542, col_offset=50, end_lineno=542, end_col_offset=59)], ctx=Load(), lineno=542, col_offset=45, end_lineno=542, end_col_offset=59), ctx=Load(), lineno=542, col_offset=40, end_lineno=542, end_col_offset=60), lineno=542, col_offset=4, end_lineno=545, end_col_offset=48), FunctionDef(name='_load_payload', args=arguments(args=[arg(arg='cls', lineno=548, col_offset=22, end_lineno=548, end_col_offset=25), arg(arg='metadata_path', annotation=Name(id='Path', ctx=Load(), lineno=548, col_offset=42, end_lineno=548, end_col_offset=46), lineno=548, col_offset=27, end_lineno=548, end_col_offset=46), arg(arg='schema_path', annotation=Name(id='Path', ctx=Load(), lineno=548, col_offset=61, end_lineno=548, end_col_offset=65), lineno=548, col_offset=48, end_lineno=548, end_col_offset=65)]), body=[Try(body=[Return(value=Call(func=Attribute(value=Name(id='cls', ctx=Load(), lineno=550, col_offset=19, end_lineno=550, end_col_offset=22), attr='_coerce_payload', ctx=Load(), lineno=550, col_offset=19, end_lineno=550, end_col_offset=38), args=[Call(func=Name(id='deserialize_json', ctx=Load(), lineno=550, col_offset=39, end_lineno=550, end_col_offset=55), args=[Name(id='metadata_path', ctx=Load(), lineno=550, col_offset=56, end_lineno=550, end_col_offset=69), Name(id='schema_path', ctx=Load(), lineno=550, col_offset=71, end_lineno=550, end_col_offset=82)], lineno=550, col_offset=39, end_lineno=550, end_col_offset=83)], lineno=550, col_offset=19, end_lineno=550, end_col_offset=84), lineno=550, col_offset=12, end_lineno=550, end_col_offset=84)], handlers=[ExceptHandler(type=Name(id='DeserializationError', ctx=Load(), lineno=551, col_offset=15, end_lineno=551, end_col_offset=35), body=[If(test=Compare(left=Attribute(value=Name(id='metadata_path', ctx=Load(), lineno=552, col_offset=15, end_lineno=552, end_col_offset=28), attr='suffix', ctx=Load(), lineno=552, col_offset=15, end_lineno=552, end_col_offset=35), ops=[NotEq()], comparators=[Constant(value='.pkl', lineno=552, col_offset=39, end_lineno=552, end_col_offset=45)], lineno=552, col_offset=15, end_lineno=552, end_col_offset=45), body=[Raise(lineno=553, col_offset=16, end_lineno=553, end_col_offset=21)], lineno=552, col_offset=12, end_lineno=553, end_col_offset=21), Return(value=Call(func=Attribute(value=Name(id='cls', ctx=Load(), lineno=554, col_offset=19, end_lineno=554, end_col_offset=22), attr='_load_legacy_payload', ctx=Load(), lineno=554, col_offset=19, end_lineno=554, end_col_offset=43), args=[Name(id='metadata_path', ctx=Load(), lineno=554, col_offset=44, end_lineno=554, end_col_offset=57)], lineno=554, col_offset=19, end_lineno=554, end_col_offset=58), lineno=554, col_offset=12, end_lineno=554, end_col_offset=58)], lineno=551, col_offset=8, end_lineno=554, end_col_offset=58)], lineno=549, col_offset=8, end_lineno=554, end_col_offset=58)], decorator_list=[Name(id='classmethod', ctx=Load(), lineno=547, col_offset=5, end_lineno=547, end_col_offset=16)], returns=Subscript(value=Name(id='dict', ctx=Load(), lineno=548, col_offset=70, end_lineno=548, end_col_offset=74), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=548, col_offset=75, end_lineno=548, end_col_offset=78), Name(id='JsonValue', ctx=Load(), lineno=548, col_offset=80, end_lineno=548, end_col_offset=89)], ctx=Load(), lineno=548, col_offset=75, end_lineno=548, end_col_offset=89), ctx=Load(), lineno=548, col_offset=70, end_lineno=548, end_col_offset=90), lineno=548, col_offset=4, end_lineno=554, end_col_offset=58), FunctionDef(name='_load_legacy_payload', args=arguments(args=[arg(arg='cls', lineno=557, col_offset=29, end_lineno=557, end_col_offset=32), arg(arg='metadata_path', annotation=Name(id='Path', ctx=Load(), lineno=557, col_offset=49, end_lineno=557, end_col_offset=53), lineno=557, col_offset=34, end_lineno=557, end_col_offset=53)]), body=[With(items=[withitem(context_expr=Call(func=Attribute(value=Name(id='metadata_path', ctx=Load(), lineno=558, col_offset=13, end_lineno=558, end_col_offset=26), attr='open', ctx=Load(), lineno=558, col_offset=13, end_lineno=558, end_col_offset=31), args=[Constant(value='rb', lineno=558, col_offset=32, end_lineno=558, end_col_offset=36)], lineno=558, col_offset=13, end_lineno=558, end_col_offset=37), optional_vars=Name(id='handle', ctx=Store(), lineno=558, col_offset=41, end_lineno=558, end_col_offset=47))], body=[Try(body=[AnnAssign(target=Name(id='legacy_payload_raw', ctx=Store(), lineno=560, col_offset=16, end_lineno=560, end_col_offset=34), annotation=Name(id='object', ctx=Load(), lineno=560, col_offset=36, end_lineno=560, end_col_offset=42), value=Call(func=Name(id='load_unsigned_legacy', ctx=Load(), lineno=560, col_offset=45, end_lineno=560, end_col_offset=65), args=[Name(id='handle', ctx=Load(), lineno=560, col_offset=66, end_lineno=560, end_col_offset=72)], lineno=560, col_offset=45, end_lineno=560, end_col_offset=73), simple=1, lineno=560, col_offset=16, end_lineno=560, end_col_offset=73)], handlers=[ExceptHandler(type=Name(id='UnsafeSerializationError', ctx=Load(), lineno=561, col_offset=19, end_lineno=561, end_col_offset=43), name='legacy_exc', body=[Assign(targets=[Name(id='message', ctx=Store(), lineno=562, col_offset=16, end_lineno=562, end_col_offset=23)], value=JoinedStr(values=[Constant(value='Legacy BM25 pickle failed validation: ', lineno=562, col_offset=28, end_lineno=562, end_col_offset=66), FormattedValue(value=Name(id='legacy_exc', ctx=Load(), lineno=562, col_offset=67, end_lineno=562, end_col_offset=77), conversion=-1, lineno=562, col_offset=66, end_lineno=562, end_col_offset=78)], lineno=562, col_offset=26, end_lineno=562, end_col_offset=79), lineno=562, col_offset=16, end_lineno=562, end_col_offset=79), Raise(exc=Call(func=Name(id='DeserializationError', ctx=Load(), lineno=563, col_offset=22, end_lineno=563, end_col_offset=42), args=[Name(id='message', ctx=Load(), lineno=563, col_offset=43, end_lineno=563, end_col_offset=50)], lineno=563, col_offset=22, end_lineno=563, end_col_offset=51), cause=Name(id='legacy_exc', ctx=Load(), lineno=563, col_offset=57, end_lineno=563, end_col_offset=67), lineno=563, col_offset=16, end_lineno=563, end_col_offset=67)], lineno=561, col_offset=12, end_lineno=563, end_col_offset=67)], lineno=559, col_offset=12, end_lineno=563, end_col_offset=67)], lineno=558, col_offset=8, end_lineno=563, end_col_offset=67), Return(value=Call(func=Attribute(value=Name(id='cls', ctx=Load(), lineno=564, col_offset=15, end_lineno=564, end_col_offset=18), attr='_coerce_payload', ctx=Load(), lineno=564, col_offset=15, end_lineno=564, end_col_offset=34), args=[Name(id='legacy_payload_raw', ctx=Load(), lineno=564, col_offset=35, end_lineno=564, end_col_offset=53)], lineno=564, col_offset=15, end_lineno=564, end_col_offset=54), lineno=564, col_offset=8, end_lineno=564, end_col_offset=54)], decorator_list=[Name(id='classmethod', ctx=Load(), lineno=556, col_offset=5, end_lineno=556, end_col_offset=16)], returns=Subscript(value=Name(id='dict', ctx=Load(), lineno=557, col_offset=58, end_lineno=557, end_col_offset=62), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=557, col_offset=63, end_lineno=557, end_col_offset=66), Name(id='JsonValue', ctx=Load(), lineno=557, col_offset=68, end_lineno=557, end_col_offset=77)], ctx=Load(), lineno=557, col_offset=63, end_lineno=557, end_col_offset=77), ctx=Load(), lineno=557, col_offset=58, end_lineno=557, end_col_offset=78), lineno=557, col_offset=4, end_lineno=564, end_col_offset=54), FunctionDef(name='_index_from_payload', args=arguments(args=[arg(arg='cls', lineno=567, col_offset=28, end_lineno=567, end_col_offset=31), arg(arg='payload', annotation=Subscript(value=Name(id='dict', ctx=Load(), lineno=567, col_offset=42, end_lineno=567, end_col_offset=46), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=567, col_offset=47, end_lineno=567, end_col_offset=50), Name(id='JsonValue', ctx=Load(), lineno=567, col_offset=52, end_lineno=567, end_col_offset=61)], ctx=Load(), lineno=567, col_offset=47, end_lineno=567, end_col_offset=61), ctx=Load(), lineno=567, col_offset=42, end_lineno=567, end_col_offset=62), lineno=567, col_offset=33, end_lineno=567, end_col_offset=62)]), body=[Assign(targets=[Name(id='k1_val', ctx=Store(), lineno=568, col_offset=8, end_lineno=568, end_col_offset=14)], value=Call(func=Attribute(value=Name(id='payload', ctx=Load(), lineno=568, col_offset=17, end_lineno=568, end_col_offset=24), attr='get', ctx=Load(), lineno=568, col_offset=17, end_lineno=568, end_col_offset=28), args=[Constant(value='k1', lineno=568, col_offset=29, end_lineno=568, end_col_offset=33), Constant(value=0.9, lineno=568, col_offset=35, end_lineno=568, end_col_offset=38)], lineno=568, col_offset=17, end_lineno=568, end_col_offset=39), lineno=568, col_offset=8, end_lineno=568, end_col_offset=39), Assign(targets=[Name(id='b_val', ctx=Store(), lineno=569, col_offset=8, end_lineno=569, end_col_offset=13)], value=Call(func=Attribute(value=Name(id='payload', ctx=Load(), lineno=569, col_offset=16, end_lineno=569, end_col_offset=23), attr='get', ctx=Load(), lineno=569, col_offset=16, end_lineno=569, end_col_offset=27), args=[Constant(value='b', lineno=569, col_offset=28, end_lineno=569, end_col_offset=31), Constant(value=0.4, lineno=569, col_offset=33, end_lineno=569, end_col_offset=36)], lineno=569, col_offset=16, end_lineno=569, end_col_offset=37), lineno=569, col_offset=8, end_lineno=569, end_col_offset=37), Assign(targets=[Name(id='index', ctx=Store(), lineno=570, col_offset=8, end_lineno=570, end_col_offset=13)], value=Call(func=Name(id='cls', ctx=Load(), lineno=570, col_offset=16, end_lineno=570, end_col_offset=19), keywords=[keyword(arg='k1', value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=571, col_offset=32, end_lineno=571, end_col_offset=42), args=[Name(id='k1_val', ctx=Load(), lineno=571, col_offset=43, end_lineno=571, end_col_offset=49), Tuple(elts=[Name(id='int', ctx=Load(), lineno=571, col_offset=52, end_lineno=571, end_col_offset=55), Name(id='float', ctx=Load(), lineno=571, col_offset=57, end_lineno=571, end_col_offset=62)], ctx=Load(), lineno=571, col_offset=51, end_lineno=571, end_col_offset=63)], lineno=571, col_offset=32, end_lineno=571, end_col_offset=64), body=Call(func=Name(id='float', ctx=Load(), lineno=571, col_offset=15, end_lineno=571, end_col_offset=20), args=[Name(id='k1_val', ctx=Load(), lineno=571, col_offset=21, end_lineno=571, end_col_offset=27)], lineno=571, col_offset=15, end_lineno=571, end_col_offset=28), orelse=Constant(value=0.9, lineno=571, col_offset=70, end_lineno=571, end_col_offset=73), lineno=571, col_offset=15, end_lineno=571, end_col_offset=73), lineno=571, col_offset=12, end_lineno=571, end_col_offset=73), keyword(arg='b', value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=572, col_offset=30, end_lineno=572, end_col_offset=40), args=[Name(id='b_val', ctx=Load(), lineno=572, col_offset=41, end_lineno=572, end_col_offset=46), Tuple(elts=[Name(id='int', ctx=Load(), lineno=572, col_offset=49, end_lineno=572, end_col_offset=52), Name(id='float', ctx=Load(), lineno=572, col_offset=54, end_lineno=572, end_col_offset=59)], ctx=Load(), lineno=572, col_offset=48, end_lineno=572, end_col_offset=60)], lineno=572, col_offset=30, end_lineno=572, end_col_offset=61), body=Call(func=Name(id='float', ctx=Load(), lineno=572, col_offset=14, end_lineno=572, end_col_offset=19), args=[Name(id='b_val', ctx=Load(), lineno=572, col_offset=20, end_lineno=572, end_col_offset=25)], lineno=572, col_offset=14, end_lineno=572, end_col_offset=26), orelse=Constant(value=0.4, lineno=572, col_offset=67, end_lineno=572, end_col_offset=70), lineno=572, col_offset=14, end_lineno=572, end_col_offset=70), lineno=572, col_offset=12, end_lineno=572, end_col_offset=70)], lineno=570, col_offset=16, end_lineno=573, end_col_offset=9), lineno=570, col_offset=8, end_lineno=573, end_col_offset=9), Assign(targets=[Name(id='n_val', ctx=Store(), lineno=574, col_offset=8, end_lineno=574, end_col_offset=13)], value=Call(func=Attribute(value=Name(id='payload', ctx=Load(), lineno=574, col_offset=16, end_lineno=574, end_col_offset=23), attr='get', ctx=Load(), lineno=574, col_offset=16, end_lineno=574, end_col_offset=27), args=[Constant(value='N', lineno=574, col_offset=28, end_lineno=574, end_col_offset=31), Constant(value=0, lineno=574, col_offset=33, end_lineno=574, end_col_offset=34)], lineno=574, col_offset=16, end_lineno=574, end_col_offset=35), lineno=574, col_offset=8, end_lineno=574, end_col_offset=35), Assign(targets=[Name(id='avgdl_val', ctx=Store(), lineno=575, col_offset=8, end_lineno=575, end_col_offset=17)], value=Call(func=Attribute(value=Name(id='payload', ctx=Load(), lineno=575, col_offset=20, end_lineno=575, end_col_offset=27), attr='get', ctx=Load(), lineno=575, col_offset=20, end_lineno=575, end_col_offset=31), args=[Constant(value='avgdl', lineno=575, col_offset=32, end_lineno=575, end_col_offset=39), Constant(value=0.0, lineno=575, col_offset=41, end_lineno=575, end_col_offset=44)], lineno=575, col_offset=20, end_lineno=575, end_col_offset=45), lineno=575, col_offset=8, end_lineno=575, end_col_offset=45), Assign(targets=[Attribute(value=Name(id='index', ctx=Load(), lineno=576, col_offset=8, end_lineno=576, end_col_offset=13), attr='N', ctx=Store(), lineno=576, col_offset=8, end_lineno=576, end_col_offset=15)], value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=576, col_offset=32, end_lineno=576, end_col_offset=42), args=[Name(id='n_val', ctx=Load(), lineno=576, col_offset=43, end_lineno=576, end_col_offset=48), Tuple(elts=[Name(id='int', ctx=Load(), lineno=576, col_offset=51, end_lineno=576, end_col_offset=54), Name(id='float', ctx=Load(), lineno=576, col_offset=56, end_lineno=576, end_col_offset=61)], ctx=Load(), lineno=576, col_offset=50, end_lineno=576, end_col_offset=62)], lineno=576, col_offset=32, end_lineno=576, end_col_offset=63), body=Call(func=Name(id='int', ctx=Load(), lineno=576, col_offset=18, end_lineno=576, end_col_offset=21), args=[Name(id='n_val', ctx=Load(), lineno=576, col_offset=22, end_lineno=576, end_col_offset=27)], lineno=576, col_offset=18, end_lineno=576, end_col_offset=28), orelse=Constant(value=0, lineno=576, col_offset=69, end_lineno=576, end_col_offset=70), lineno=576, col_offset=18, end_lineno=576, end_col_offset=70), lineno=576, col_offset=8, end_lineno=576, end_col_offset=70), Assign(targets=[Attribute(value=Name(id='index', ctx=Load(), lineno=577, col_offset=8, end_lineno=577, end_col_offset=13), attr='avgdl', ctx=Store(), lineno=577, col_offset=8, end_lineno=577, end_col_offset=19)], value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=577, col_offset=42, end_lineno=577, end_col_offset=52), args=[Name(id='avgdl_val', ctx=Load(), lineno=577, col_offset=53, end_lineno=577, end_col_offset=62), Tuple(elts=[Name(id='int', ctx=Load(), lineno=577, col_offset=65, end_lineno=577, end_col_offset=68), Name(id='float', ctx=Load(), lineno=577, col_offset=70, end_lineno=577, end_col_offset=75)], ctx=Load(), lineno=577, col_offset=64, end_lineno=577, end_col_offset=76)], lineno=577, col_offset=42, end_lineno=577, end_col_offset=77), body=Call(func=Name(id='float', ctx=Load(), lineno=577, col_offset=22, end_lineno=577, end_col_offset=27), args=[Name(id='avgdl_val', ctx=Load(), lineno=577, col_offset=28, end_lineno=577, end_col_offset=37)], lineno=577, col_offset=22, end_lineno=577, end_col_offset=38), orelse=Constant(value=0.0, lineno=577, col_offset=83, end_lineno=577, end_col_offset=86), lineno=577, col_offset=22, end_lineno=577, end_col_offset=86), lineno=577, col_offset=8, end_lineno=577, end_col_offset=86), Assign(targets=[Name(id='df_val', ctx=Store(), lineno=579, col_offset=8, end_lineno=579, end_col_offset=14)], value=Call(func=Attribute(value=Name(id='payload', ctx=Load(), lineno=579, col_offset=17, end_lineno=579, end_col_offset=24), attr='get', ctx=Load(), lineno=579, col_offset=17, end_lineno=579, end_col_offset=28), args=[Constant(value='df', lineno=579, col_offset=29, end_lineno=579, end_col_offset=33), Dict(lineno=579, col_offset=35, end_lineno=579, end_col_offset=37)], lineno=579, col_offset=17, end_lineno=579, end_col_offset=38), lineno=579, col_offset=8, end_lineno=579, end_col_offset=38), Assign(targets=[Attribute(value=Name(id='index', ctx=Load(), lineno=580, col_offset=8, end_lineno=580, end_col_offset=13), attr='df', ctx=Store(), lineno=580, col_offset=8, end_lineno=580, end_col_offset=16)], value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=582, col_offset=15, end_lineno=582, end_col_offset=25), args=[Name(id='df_val', ctx=Load(), lineno=582, col_offset=26, end_lineno=582, end_col_offset=32), Name(id='dict', ctx=Load(), lineno=582, col_offset=34, end_lineno=582, end_col_offset=38)], lineno=582, col_offset=15, end_lineno=582, end_col_offset=39), body=DictComp(key=Name(id='k', ctx=Load(), lineno=581, col_offset=13, end_lineno=581, end_col_offset=14), value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=581, col_offset=26, end_lineno=581, end_col_offset=36), args=[Name(id='v', ctx=Load(), lineno=581, col_offset=37, end_lineno=581, end_col_offset=38), Tuple(elts=[Name(id='int', ctx=Load(), lineno=581, col_offset=41, end_lineno=581, end_col_offset=44), Name(id='float', ctx=Load(), lineno=581, col_offset=46, end_lineno=581, end_col_offset=51)], ctx=Load(), lineno=581, col_offset=40, end_lineno=581, end_col_offset=52)], lineno=581, col_offset=26, end_lineno=581, end_col_offset=53), body=Call(func=Name(id='int', ctx=Load(), lineno=581, col_offset=16, end_lineno=581, end_col_offset=19), args=[Name(id='v', ctx=Load(), lineno=581, col_offset=20, end_lineno=581, end_col_offset=21)], lineno=581, col_offset=16, end_lineno=581, end_col_offset=22), orelse=Constant(value=0, lineno=581, col_offset=59, end_lineno=581, end_col_offset=60), lineno=581, col_offset=16, end_lineno=581, end_col_offset=60), generators=[comprehension(target=Tuple(elts=[Name(id='k', ctx=Store(), lineno=581, col_offset=65, end_lineno=581, end_col_offset=66), Name(id='v', ctx=Store(), lineno=581, col_offset=68, end_lineno=581, end_col_offset=69)], ctx=Store(), lineno=581, col_offset=65, end_lineno=581, end_col_offset=69), iter=Call(func=Attribute(value=Name(id='df_val', ctx=Load(), lineno=581, col_offset=73, end_lineno=581, end_col_offset=79), attr='items', ctx=Load(), lineno=581, col_offset=73, end_lineno=581, end_col_offset=85), lineno=581, col_offset=73, end_lineno=581, end_col_offset=87), is_async=0)], lineno=581, col_offset=12, end_lineno=581, end_col_offset=88), orelse=Dict(lineno=583, col_offset=17, end_lineno=583, end_col_offset=19), lineno=581, col_offset=12, end_lineno=583, end_col_offset=19), lineno=580, col_offset=8, end_lineno=584, end_col_offset=9), Assign(targets=[Attribute(value=Name(id='index', ctx=Load(), lineno=586, col_offset=8, end_lineno=586, end_col_offset=13), attr='docs', ctx=Store(), lineno=586, col_offset=8, end_lineno=586, end_col_offset=18)], value=Call(func=Attribute(value=Name(id='cls', ctx=Load(), lineno=586, col_offset=21, end_lineno=586, end_col_offset=24), attr='_docs_from_payload', ctx=Load(), lineno=586, col_offset=21, end_lineno=586, end_col_offset=43), args=[Call(func=Attribute(value=Name(id='payload', ctx=Load(), lineno=586, col_offset=44, end_lineno=586, end_col_offset=51), attr='get', ctx=Load(), lineno=586, col_offset=44, end_lineno=586, end_col_offset=55), args=[Constant(value='docs', lineno=586, col_offset=56, end_lineno=586, end_col_offset=62), List(ctx=Load(), lineno=586, col_offset=64, end_lineno=586, end_col_offset=66)], lineno=586, col_offset=44, end_lineno=586, end_col_offset=67)], lineno=586, col_offset=21, end_lineno=586, end_col_offset=68), lineno=586, col_offset=8, end_lineno=586, end_col_offset=68), Return(value=Name(id='index', ctx=Load(), lineno=587, col_offset=15, end_lineno=587, end_col_offset=20), lineno=587, col_offset=8, end_lineno=587, end_col_offset=20)], decorator_list=[Name(id='classmethod', ctx=Load(), lineno=566, col_offset=5, end_lineno=566, end_col_offset=16)], returns=Name(id='BM25Index', ctx=Load(), lineno=567, col_offset=67, end_lineno=567, end_col_offset=76), lineno=567, col_offset=4, end_lineno=587, end_col_offset=20), FunctionDef(name='_docs_from_payload', args=arguments(args=[arg(arg='raw_docs', annotation=Name(id='object', ctx=Load(), lineno=590, col_offset=37, end_lineno=590, end_col_offset=43), lineno=590, col_offset=27, end_lineno=590, end_col_offset=43)]), body=[If(test=UnaryOp(op=Not(), operand=Call(func=Name(id='isinstance', ctx=Load(), lineno=591, col_offset=15, end_lineno=591, end_col_offset=25), args=[Name(id='raw_docs', ctx=Load(), lineno=591, col_offset=26, end_lineno=591, end_col_offset=34), Name(id='list', ctx=Load(), lineno=591, col_offset=36, end_lineno=591, end_col_offset=40)], lineno=591, col_offset=15, end_lineno=591, end_col_offset=41), lineno=591, col_offset=11, end_lineno=591, end_col_offset=41), body=[Return(value=List(ctx=Load(), lineno=592, col_offset=19, end_lineno=592, end_col_offset=21), lineno=592, col_offset=12, end_lineno=592, end_col_offset=21)], lineno=591, col_offset=8, end_lineno=592, end_col_offset=21), AnnAssign(target=Name(id='docs', ctx=Store(), lineno=594, col_offset=8, end_lineno=594, end_col_offset=12), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=594, col_offset=14, end_lineno=594, end_col_offset=18), slice=Name(id='BM25Doc', ctx=Load(), lineno=594, col_offset=19, end_lineno=594, end_col_offset=26), ctx=Load(), lineno=594, col_offset=14, end_lineno=594, end_col_offset=27), value=List(ctx=Load(), lineno=594, col_offset=30, end_lineno=594, end_col_offset=32), simple=1, lineno=594, col_offset=8, end_lineno=594, end_col_offset=32), For(target=Name(id='entry', ctx=Store(), lineno=595, col_offset=12, end_lineno=595, end_col_offset=17), iter=Name(id='raw_docs', ctx=Load(), lineno=595, col_offset=21, end_lineno=595, end_col_offset=29), body=[If(test=UnaryOp(op=Not(), operand=Call(func=Name(id='isinstance', ctx=Load(), lineno=596, col_offset=19, end_lineno=596, end_col_offset=29), args=[Name(id='entry', ctx=Load(), lineno=596, col_offset=30, end_lineno=596, end_col_offset=35), Name(id='dict', ctx=Load(), lineno=596, col_offset=37, end_lineno=596, end_col_offset=41)], lineno=596, col_offset=19, end_lineno=596, end_col_offset=42), lineno=596, col_offset=15, end_lineno=596, end_col_offset=42), body=[Continue(lineno=597, col_offset=16, end_lineno=597, end_col_offset=24)], lineno=596, col_offset=12, end_lineno=597, end_col_offset=24), Assign(targets=[Name(id='chunk_id', ctx=Store(), lineno=598, col_offset=12, end_lineno=598, end_col_offset=20)], value=Call(func=Attribute(value=Name(id='entry', ctx=Load(), lineno=598, col_offset=23, end_lineno=598, end_col_offset=28), attr='get', ctx=Load(), lineno=598, col_offset=23, end_lineno=598, end_col_offset=32), args=[Constant(value='chunk_id', lineno=598, col_offset=33, end_lineno=598, end_col_offset=43), Constant(value='', lineno=598, col_offset=45, end_lineno=598, end_col_offset=47)], lineno=598, col_offset=23, end_lineno=598, end_col_offset=48), lineno=598, col_offset=12, end_lineno=598, end_col_offset=48), Assign(targets=[Name(id='doc_id', ctx=Store(), lineno=599, col_offset=12, end_lineno=599, end_col_offset=18)], value=Call(func=Attribute(value=Name(id='entry', ctx=Load(), lineno=599, col_offset=21, end_lineno=599, end_col_offset=26), attr='get', ctx=Load(), lineno=599, col_offset=21, end_lineno=599, end_col_offset=30), args=[Constant(value='doc_id', lineno=599, col_offset=31, end_lineno=599, end_col_offset=39), Constant(value='', lineno=599, col_offset=41, end_lineno=599, end_col_offset=43)], lineno=599, col_offset=21, end_lineno=599, end_col_offset=44), lineno=599, col_offset=12, end_lineno=599, end_col_offset=44), Assign(targets=[Name(id='title', ctx=Store(), lineno=600, col_offset=12, end_lineno=600, end_col_offset=17)], value=Call(func=Attribute(value=Name(id='entry', ctx=Load(), lineno=600, col_offset=20, end_lineno=600, end_col_offset=25), attr='get', ctx=Load(), lineno=600, col_offset=20, end_lineno=600, end_col_offset=29), args=[Constant(value='title', lineno=600, col_offset=30, end_lineno=600, end_col_offset=37), Constant(value='', lineno=600, col_offset=39, end_lineno=600, end_col_offset=41)], lineno=600, col_offset=20, end_lineno=600, end_col_offset=42), lineno=600, col_offset=12, end_lineno=600, end_col_offset=42), Assign(targets=[Name(id='section', ctx=Store(), lineno=601, col_offset=12, end_lineno=601, end_col_offset=19)], value=Call(func=Attribute(value=Name(id='entry', ctx=Load(), lineno=601, col_offset=22, end_lineno=601, end_col_offset=27), attr='get', ctx=Load(), lineno=601, col_offset=22, end_lineno=601, end_col_offset=31), args=[Constant(value='section', lineno=601, col_offset=32, end_lineno=601, end_col_offset=41), Constant(value='', lineno=601, col_offset=43, end_lineno=601, end_col_offset=45)], lineno=601, col_offset=22, end_lineno=601, end_col_offset=46), lineno=601, col_offset=12, end_lineno=601, end_col_offset=46), AnnAssign(target=Name(id='tf_value', ctx=Store(), lineno=602, col_offset=12, end_lineno=602, end_col_offset=20), annotation=Name(id='object', ctx=Load(), lineno=602, col_offset=22, end_lineno=602, end_col_offset=28), value=Call(func=Attribute(value=Name(id='entry', ctx=Load(), lineno=602, col_offset=31, end_lineno=602, end_col_offset=36), attr='get', ctx=Load(), lineno=602, col_offset=31, end_lineno=602, end_col_offset=40), args=[Constant(value='tf', lineno=602, col_offset=41, end_lineno=602, end_col_offset=45), Dict(lineno=602, col_offset=47, end_lineno=602, end_col_offset=49)], lineno=602, col_offset=31, end_lineno=602, end_col_offset=50), simple=1, lineno=602, col_offset=12, end_lineno=602, end_col_offset=50), Assign(targets=[Name(id='doc_length', ctx=Store(), lineno=603, col_offset=12, end_lineno=603, end_col_offset=22)], value=Call(func=Attribute(value=Name(id='entry', ctx=Load(), lineno=603, col_offset=25, end_lineno=603, end_col_offset=30), attr='get', ctx=Load(), lineno=603, col_offset=25, end_lineno=603, end_col_offset=34), args=[Constant(value='dl', lineno=603, col_offset=35, end_lineno=603, end_col_offset=39), Constant(value=0.0, lineno=603, col_offset=41, end_lineno=603, end_col_offset=44)], lineno=603, col_offset=25, end_lineno=603, end_col_offset=45), lineno=603, col_offset=12, end_lineno=603, end_col_offset=45), Expr(value=Call(func=Attribute(value=Name(id='docs', ctx=Load(), lineno=604, col_offset=12, end_lineno=604, end_col_offset=16), attr='append', ctx=Load(), lineno=604, col_offset=12, end_lineno=604, end_col_offset=23), args=[Call(func=Name(id='BM25Doc', ctx=Load(), lineno=605, col_offset=16, end_lineno=605, end_col_offset=23), keywords=[keyword(arg='chunk_id', value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=606, col_offset=46, end_lineno=606, end_col_offset=56), args=[Name(id='chunk_id', ctx=Load(), lineno=606, col_offset=57, end_lineno=606, end_col_offset=65), Name(id='str', ctx=Load(), lineno=606, col_offset=67, end_lineno=606, end_col_offset=70)], lineno=606, col_offset=46, end_lineno=606, end_col_offset=71), body=Call(func=Name(id='str', ctx=Load(), lineno=606, col_offset=29, end_lineno=606, end_col_offset=32), args=[Name(id='chunk_id', ctx=Load(), lineno=606, col_offset=33, end_lineno=606, end_col_offset=41)], lineno=606, col_offset=29, end_lineno=606, end_col_offset=42), orelse=Constant(value='', lineno=606, col_offset=77, end_lineno=606, end_col_offset=79), lineno=606, col_offset=29, end_lineno=606, end_col_offset=79), lineno=606, col_offset=20, end_lineno=606, end_col_offset=79), keyword(arg='doc_id', value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=607, col_offset=42, end_lineno=607, end_col_offset=52), args=[Name(id='doc_id', ctx=Load(), lineno=607, col_offset=53, end_lineno=607, end_col_offset=59), Name(id='str', ctx=Load(), lineno=607, col_offset=61, end_lineno=607, end_col_offset=64)], lineno=607, col_offset=42, end_lineno=607, end_col_offset=65), body=Call(func=Name(id='str', ctx=Load(), lineno=607, col_offset=27, end_lineno=607, end_col_offset=30), args=[Name(id='doc_id', ctx=Load(), lineno=607, col_offset=31, end_lineno=607, end_col_offset=37)], lineno=607, col_offset=27, end_lineno=607, end_col_offset=38), orelse=Constant(value='', lineno=607, col_offset=71, end_lineno=607, end_col_offset=73), lineno=607, col_offset=27, end_lineno=607, end_col_offset=73), lineno=607, col_offset=20, end_lineno=607, end_col_offset=73), keyword(arg='title', value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=608, col_offset=40, end_lineno=608, end_col_offset=50), args=[Name(id='title', ctx=Load(), lineno=608, col_offset=51, end_lineno=608, end_col_offset=56), Name(id='str', ctx=Load(), lineno=608, col_offset=58, end_lineno=608, end_col_offset=61)], lineno=608, col_offset=40, end_lineno=608, end_col_offset=62), body=Call(func=Name(id='str', ctx=Load(), lineno=608, col_offset=26, end_lineno=608, end_col_offset=29), args=[Name(id='title', ctx=Load(), lineno=608, col_offset=30, end_lineno=608, end_col_offset=35)], lineno=608, col_offset=26, end_lineno=608, end_col_offset=36), orelse=Constant(value='', lineno=608, col_offset=68, end_lineno=608, end_col_offset=70), lineno=608, col_offset=26, end_lineno=608, end_col_offset=70), lineno=608, col_offset=20, end_lineno=608, end_col_offset=70), keyword(arg='section', value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=609, col_offset=44, end_lineno=609, end_col_offset=54), args=[Name(id='section', ctx=Load(), lineno=609, col_offset=55, end_lineno=609, end_col_offset=62), Name(id='str', ctx=Load(), lineno=609, col_offset=64, end_lineno=609, end_col_offset=67)], lineno=609, col_offset=44, end_lineno=609, end_col_offset=68), body=Call(func=Name(id='str', ctx=Load(), lineno=609, col_offset=28, end_lineno=609, end_col_offset=31), args=[Name(id='section', ctx=Load(), lineno=609, col_offset=32, end_lineno=609, end_col_offset=39)], lineno=609, col_offset=28, end_lineno=609, end_col_offset=40), orelse=Constant(value='', lineno=609, col_offset=74, end_lineno=609, end_col_offset=76), lineno=609, col_offset=28, end_lineno=609, end_col_offset=76), lineno=609, col_offset=20, end_lineno=609, end_col_offset=76), keyword(arg='tf', value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=610, col_offset=62, end_lineno=610, end_col_offset=72), args=[Name(id='tf_value', ctx=Load(), lineno=610, col_offset=73, end_lineno=610, end_col_offset=81), Name(id='dict', ctx=Load(), lineno=610, col_offset=83, end_lineno=610, end_col_offset=87)], lineno=610, col_offset=62, end_lineno=610, end_col_offset=88), body=Call(func=Name(id='cast', ctx=Load(), lineno=610, col_offset=24, end_lineno=610, end_col_offset=28), args=[Constant(value='dict[str, float]', lineno=610, col_offset=29, end_lineno=610, end_col_offset=47), Name(id='tf_value', ctx=Load(), lineno=610, col_offset=49, end_lineno=610, end_col_offset=57)], lineno=610, col_offset=24, end_lineno=610, end_col_offset=58), orelse=Dict(lineno=610, col_offset=94, end_lineno=610, end_col_offset=96), lineno=610, col_offset=24, end_lineno=610, end_col_offset=96), lineno=610, col_offset=20, end_lineno=610, end_col_offset=97), keyword(arg='dl', value=IfExp(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=611, col_offset=45, end_lineno=611, end_col_offset=55), args=[Name(id='doc_length', ctx=Load(), lineno=611, col_offset=56, end_lineno=611, end_col_offset=66), Tuple(elts=[Name(id='int', ctx=Load(), lineno=611, col_offset=69, end_lineno=611, end_col_offset=72), Name(id='float', ctx=Load(), lineno=611, col_offset=74, end_lineno=611, end_col_offset=79)], ctx=Load(), lineno=611, col_offset=68, end_lineno=611, end_col_offset=80)], lineno=611, col_offset=45, end_lineno=611, end_col_offset=81), body=Call(func=Name(id='float', ctx=Load(), lineno=611, col_offset=24, end_lineno=611, end_col_offset=29), args=[Name(id='doc_length', ctx=Load(), lineno=611, col_offset=30, end_lineno=611, end_col_offset=40)], lineno=611, col_offset=24, end_lineno=611, end_col_offset=41), orelse=Constant(value=0.0, lineno=611, col_offset=87, end_lineno=611, end_col_offset=90), lineno=611, col_offset=24, end_lineno=611, end_col_offset=90), lineno=611, col_offset=20, end_lineno=611, end_col_offset=91)], lineno=605, col_offset=16, end_lineno=612, end_col_offset=17)], lineno=604, col_offset=12, end_lineno=613, end_col_offset=13), lineno=604, col_offset=12, end_lineno=613, end_col_offset=13)], lineno=595, col_offset=8, end_lineno=613, end_col_offset=13), Return(value=Name(id='docs', ctx=Load(), lineno=614, col_offset=15, end_lineno=614, end_col_offset=19), lineno=614, col_offset=8, end_lineno=614, end_col_offset=19)], decorator_list=[Name(id='staticmethod', ctx=Load(), lineno=589, col_offset=5, end_lineno=589, end_col_offset=17)], returns=Subscript(value=Name(id='list', ctx=Load(), lineno=590, col_offset=48, end_lineno=590, end_col_offset=52), slice=Name(id='BM25Doc', ctx=Load(), lineno=590, col_offset=53, end_lineno=590, end_col_offset=60), ctx=Load(), lineno=590, col_offset=48, end_lineno=590, end_col_offset=61), lineno=590, col_offset=4, end_lineno=614, end_col_offset=19), FunctionDef(name='_idf', args=arguments(args=[arg(arg='self', lineno=616, col_offset=13, end_lineno=616, end_col_offset=17), arg(arg='term', annotation=Name(id='str', ctx=Load(), lineno=616, col_offset=25, end_lineno=616, end_col_offset=28), lineno=616, col_offset=19, end_lineno=616, end_col_offset=28)]), body=[Expr(value=Constant(value='Compute inverse document frequency (IDF) for a term.\n\n        Calculates IDF using the formula: log((N - df + 0.5) / (df + 0.5) + 1.0)\n        where N is the total number of documents and df is the document frequency.\n\n        Parameters\n        ----------\n        term : str\n            Token string to compute IDF for.\n\n        Returns\n        -------\n        float\n            IDF score for the term. Returns 0.0 if term is not in any document\n            or if the index is empty.\n\n        Notes\n        -----\n        Uses the standard BM25 IDF formula with smoothing to avoid division by\n        zero. The 0.5 smoothing factor prevents negative IDF values for terms\n        appearing in all documents.\n        ', lineno=617, col_offset=8, end_lineno=638, end_col_offset=11), lineno=617, col_offset=8, end_lineno=638, end_col_offset=11), Assign(targets=[Name(id='df', ctx=Store(), lineno=639, col_offset=8, end_lineno=639, end_col_offset=10)], value=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=639, col_offset=13, end_lineno=639, end_col_offset=17), attr='df', ctx=Load(), lineno=639, col_offset=13, end_lineno=639, end_col_offset=20), attr='get', ctx=Load(), lineno=639, col_offset=13, end_lineno=639, end_col_offset=24), args=[Name(id='term', ctx=Load(), lineno=639, col_offset=25, end_lineno=639, end_col_offset=29), Constant(value=0, lineno=639, col_offset=31, end_lineno=639, end_col_offset=32)], lineno=639, col_offset=13, end_lineno=639, end_col_offset=33), lineno=639, col_offset=8, end_lineno=639, end_col_offset=33), If(test=BoolOp(op=Or(), values=[Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=640, col_offset=11, end_lineno=640, end_col_offset=15), attr='N', ctx=Load(), lineno=640, col_offset=11, end_lineno=640, end_col_offset=17), ops=[Eq()], comparators=[Constant(value=0, lineno=640, col_offset=21, end_lineno=640, end_col_offset=22)], lineno=640, col_offset=11, end_lineno=640, end_col_offset=22), Compare(left=Name(id='df', ctx=Load(), lineno=640, col_offset=26, end_lineno=640, end_col_offset=28), ops=[Eq()], comparators=[Constant(value=0, lineno=640, col_offset=32, end_lineno=640, end_col_offset=33)], lineno=640, col_offset=26, end_lineno=640, end_col_offset=33)], lineno=640, col_offset=11, end_lineno=640, end_col_offset=33), body=[Return(value=Constant(value=0.0, lineno=641, col_offset=19, end_lineno=641, end_col_offset=22), lineno=641, col_offset=12, end_lineno=641, end_col_offset=22)], lineno=640, col_offset=8, end_lineno=641, end_col_offset=22), Return(value=Call(func=Attribute(value=Name(id='math', ctx=Load(), lineno=642, col_offset=15, end_lineno=642, end_col_offset=19), attr='log', ctx=Load(), lineno=642, col_offset=15, end_lineno=642, end_col_offset=23), args=[BinOp(left=BinOp(left=BinOp(left=BinOp(left=Attribute(value=Name(id='self', ctx=Load(), lineno=642, col_offset=25, end_lineno=642, end_col_offset=29), attr='N', ctx=Load(), lineno=642, col_offset=25, end_lineno=642, end_col_offset=31), op=Sub(), right=Name(id='df', ctx=Load(), lineno=642, col_offset=34, end_lineno=642, end_col_offset=36), lineno=642, col_offset=25, end_lineno=642, end_col_offset=36), op=Add(), right=Constant(value=0.5, lineno=642, col_offset=39, end_lineno=642, end_col_offset=42), lineno=642, col_offset=25, end_lineno=642, end_col_offset=42), op=Div(), right=BinOp(left=Name(id='df', ctx=Load(), lineno=642, col_offset=47, end_lineno=642, end_col_offset=49), op=Add(), right=Constant(value=0.5, lineno=642, col_offset=52, end_lineno=642, end_col_offset=55), lineno=642, col_offset=47, end_lineno=642, end_col_offset=55), lineno=642, col_offset=24, end_lineno=642, end_col_offset=56), op=Add(), right=Constant(value=1.0, lineno=642, col_offset=59, end_lineno=642, end_col_offset=62), lineno=642, col_offset=24, end_lineno=642, end_col_offset=62)], lineno=642, col_offset=15, end_lineno=642, end_col_offset=63), lineno=642, col_offset=8, end_lineno=642, end_col_offset=63)], returns=Name(id='float', ctx=Load(), lineno=616, col_offset=33, end_lineno=616, end_col_offset=38), lineno=616, col_offset=4, end_lineno=642, end_col_offset=63), FunctionDef(name='search', args=arguments(args=[arg(arg='self', lineno=644, col_offset=15, end_lineno=644, end_col_offset=19), arg(arg='query', annotation=Name(id='str', ctx=Load(), lineno=644, col_offset=28, end_lineno=644, end_col_offset=31), lineno=644, col_offset=21, end_lineno=644, end_col_offset=31), arg(arg='k', annotation=Name(id='int', ctx=Load(), lineno=644, col_offset=36, end_lineno=644, end_col_offset=39), lineno=644, col_offset=33, end_lineno=644, end_col_offset=39)], defaults=[Constant(value=10, lineno=644, col_offset=42, end_lineno=644, end_col_offset=44)]), body=[Expr(value=Constant(value='Search index and return top-k results ranked by BM25 score.\n\n        Tokenizes the query, computes BM25 relevance scores for all documents,\n        and returns the top-k results sorted by score in descending order.\n\n        Parameters\n        ----------\n        query : str\n            Search query string to tokenize and match against documents.\n        k : int, optional\n            Maximum number of results to return. Defaults to 10.\n\n        Returns\n        -------\n        list[tuple[str, float]]\n            List of (chunk_id, score) tuples sorted by score descending. Only\n            includes documents with score > 0.0. Returns empty list if index is\n            empty or no documents match.\n\n        Notes\n        -----\n        BM25 scoring combines term frequency (TF), inverse document frequency\n        (IDF), and document length normalization. Documents with higher scores\n        are more relevant to the query.\n        ', lineno=645, col_offset=8, end_lineno=669, end_col_offset=11), lineno=645, col_offset=8, end_lineno=669, end_col_offset=11), If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=670, col_offset=11, end_lineno=670, end_col_offset=15), attr='N', ctx=Load(), lineno=670, col_offset=11, end_lineno=670, end_col_offset=17), ops=[Eq()], comparators=[Constant(value=0, lineno=670, col_offset=21, end_lineno=670, end_col_offset=22)], lineno=670, col_offset=11, end_lineno=670, end_col_offset=22), body=[Return(value=List(ctx=Load(), lineno=671, col_offset=19, end_lineno=671, end_col_offset=21), lineno=671, col_offset=12, end_lineno=671, end_col_offset=21)], lineno=670, col_offset=8, end_lineno=671, end_col_offset=21), Assign(targets=[Name(id='terms', ctx=Store(), lineno=672, col_offset=8, end_lineno=672, end_col_offset=13)], value=Call(func=Name(id='toks', ctx=Load(), lineno=672, col_offset=16, end_lineno=672, end_col_offset=20), args=[Name(id='query', ctx=Load(), lineno=672, col_offset=21, end_lineno=672, end_col_offset=26)], lineno=672, col_offset=16, end_lineno=672, end_col_offset=27), lineno=672, col_offset=8, end_lineno=672, end_col_offset=27), Assign(targets=[Name(id='scores', ctx=Store(), lineno=673, col_offset=8, end_lineno=673, end_col_offset=14)], value=BinOp(left=List(elts=[Constant(value=0.0, lineno=673, col_offset=18, end_lineno=673, end_col_offset=21)], ctx=Load(), lineno=673, col_offset=17, end_lineno=673, end_col_offset=22), op=Mult(), right=Attribute(value=Name(id='self', ctx=Load(), lineno=673, col_offset=25, end_lineno=673, end_col_offset=29), attr='N', ctx=Load(), lineno=673, col_offset=25, end_lineno=673, end_col_offset=31), lineno=673, col_offset=17, end_lineno=673, end_col_offset=31), lineno=673, col_offset=8, end_lineno=673, end_col_offset=31), For(target=Tuple(elts=[Name(id='i', ctx=Store(), lineno=674, col_offset=12, end_lineno=674, end_col_offset=13), Name(id='doc', ctx=Store(), lineno=674, col_offset=15, end_lineno=674, end_col_offset=18)], ctx=Store(), lineno=674, col_offset=12, end_lineno=674, end_col_offset=18), iter=Call(func=Name(id='enumerate', ctx=Load(), lineno=674, col_offset=22, end_lineno=674, end_col_offset=31), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=674, col_offset=32, end_lineno=674, end_col_offset=36), attr='docs', ctx=Load(), lineno=674, col_offset=32, end_lineno=674, end_col_offset=41)], lineno=674, col_offset=22, end_lineno=674, end_col_offset=42), body=[Assign(targets=[Name(id='score', ctx=Store(), lineno=675, col_offset=12, end_lineno=675, end_col_offset=17)], value=Constant(value=0.0, lineno=675, col_offset=20, end_lineno=675, end_col_offset=23), lineno=675, col_offset=12, end_lineno=675, end_col_offset=23), For(target=Name(id='term', ctx=Store(), lineno=676, col_offset=16, end_lineno=676, end_col_offset=20), iter=Name(id='terms', ctx=Load(), lineno=676, col_offset=24, end_lineno=676, end_col_offset=29), body=[Assign(targets=[Name(id='tf', ctx=Store(), lineno=677, col_offset=16, end_lineno=677, end_col_offset=18)], value=Call(func=Attribute(value=Attribute(value=Name(id='doc', ctx=Load(), lineno=677, col_offset=21, end_lineno=677, end_col_offset=24), attr='tf', ctx=Load(), lineno=677, col_offset=21, end_lineno=677, end_col_offset=27), attr='get', ctx=Load(), lineno=677, col_offset=21, end_lineno=677, end_col_offset=31), args=[Name(id='term', ctx=Load(), lineno=677, col_offset=32, end_lineno=677, end_col_offset=36), Constant(value=0.0, lineno=677, col_offset=38, end_lineno=677, end_col_offset=41)], lineno=677, col_offset=21, end_lineno=677, end_col_offset=42), lineno=677, col_offset=16, end_lineno=677, end_col_offset=42), If(test=Compare(left=Name(id='tf', ctx=Load(), lineno=678, col_offset=19, end_lineno=678, end_col_offset=21), ops=[LtE()], comparators=[Constant(value=0.0, lineno=678, col_offset=25, end_lineno=678, end_col_offset=28)], lineno=678, col_offset=19, end_lineno=678, end_col_offset=28), body=[Continue(lineno=679, col_offset=20, end_lineno=679, end_col_offset=28)], lineno=678, col_offset=16, end_lineno=679, end_col_offset=28), Assign(targets=[Name(id='idf', ctx=Store(), lineno=680, col_offset=16, end_lineno=680, end_col_offset=19)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=680, col_offset=22, end_lineno=680, end_col_offset=26), attr='_idf', ctx=Load(), lineno=680, col_offset=22, end_lineno=680, end_col_offset=31), args=[Name(id='term', ctx=Load(), lineno=680, col_offset=32, end_lineno=680, end_col_offset=36)], lineno=680, col_offset=22, end_lineno=680, end_col_offset=37), lineno=680, col_offset=16, end_lineno=680, end_col_offset=37), Assign(targets=[Name(id='denom', ctx=Store(), lineno=681, col_offset=16, end_lineno=681, end_col_offset=21)], value=BinOp(left=Name(id='tf', ctx=Load(), lineno=681, col_offset=24, end_lineno=681, end_col_offset=26), op=Add(), right=BinOp(left=Attribute(value=Name(id='self', ctx=Load(), lineno=681, col_offset=29, end_lineno=681, end_col_offset=33), attr='k1', ctx=Load(), lineno=681, col_offset=29, end_lineno=681, end_col_offset=36), op=Mult(), right=BinOp(left=BinOp(left=Constant(value=1.0, lineno=681, col_offset=40, end_lineno=681, end_col_offset=43), op=Sub(), right=Attribute(value=Name(id='self', ctx=Load(), lineno=681, col_offset=46, end_lineno=681, end_col_offset=50), attr='b', ctx=Load(), lineno=681, col_offset=46, end_lineno=681, end_col_offset=52), lineno=681, col_offset=40, end_lineno=681, end_col_offset=52), op=Add(), right=BinOp(left=Attribute(value=Name(id='self', ctx=Load(), lineno=681, col_offset=55, end_lineno=681, end_col_offset=59), attr='b', ctx=Load(), lineno=681, col_offset=55, end_lineno=681, end_col_offset=61), op=Mult(), right=BinOp(left=Attribute(value=Name(id='doc', ctx=Load(), lineno=681, col_offset=65, end_lineno=681, end_col_offset=68), attr='dl', ctx=Load(), lineno=681, col_offset=65, end_lineno=681, end_col_offset=71), op=Div(), right=BoolOp(op=Or(), values=[Attribute(value=Name(id='self', ctx=Load(), lineno=681, col_offset=75, end_lineno=681, end_col_offset=79), attr='avgdl', ctx=Load(), lineno=681, col_offset=75, end_lineno=681, end_col_offset=85), Constant(value=1.0, lineno=681, col_offset=89, end_lineno=681, end_col_offset=92)], lineno=681, col_offset=75, end_lineno=681, end_col_offset=92), lineno=681, col_offset=65, end_lineno=681, end_col_offset=93), lineno=681, col_offset=55, end_lineno=681, end_col_offset=94), lineno=681, col_offset=40, end_lineno=681, end_col_offset=94), lineno=681, col_offset=29, end_lineno=681, end_col_offset=95), lineno=681, col_offset=24, end_lineno=681, end_col_offset=95), lineno=681, col_offset=16, end_lineno=681, end_col_offset=95), AugAssign(target=Name(id='score', ctx=Store(), lineno=682, col_offset=16, end_lineno=682, end_col_offset=21), op=Add(), value=BinOp(left=Name(id='idf', ctx=Load(), lineno=682, col_offset=25, end_lineno=682, end_col_offset=28), op=Mult(), right=BinOp(left=BinOp(left=Name(id='tf', ctx=Load(), lineno=682, col_offset=33, end_lineno=682, end_col_offset=35), op=Mult(), right=BinOp(left=Attribute(value=Name(id='self', ctx=Load(), lineno=682, col_offset=39, end_lineno=682, end_col_offset=43), attr='k1', ctx=Load(), lineno=682, col_offset=39, end_lineno=682, end_col_offset=46), op=Add(), right=Constant(value=1.0, lineno=682, col_offset=49, end_lineno=682, end_col_offset=52), lineno=682, col_offset=39, end_lineno=682, end_col_offset=52), lineno=682, col_offset=33, end_lineno=682, end_col_offset=53), op=Div(), right=Name(id='denom', ctx=Load(), lineno=682, col_offset=57, end_lineno=682, end_col_offset=62), lineno=682, col_offset=32, end_lineno=682, end_col_offset=62), lineno=682, col_offset=25, end_lineno=682, end_col_offset=63), lineno=682, col_offset=16, end_lineno=682, end_col_offset=63)], lineno=676, col_offset=12, end_lineno=682, end_col_offset=63), Assign(targets=[Subscript(value=Name(id='scores', ctx=Load(), lineno=683, col_offset=12, end_lineno=683, end_col_offset=18), slice=Name(id='i', ctx=Load(), lineno=683, col_offset=19, end_lineno=683, end_col_offset=20), ctx=Store(), lineno=683, col_offset=12, end_lineno=683, end_col_offset=21)], value=Name(id='score', ctx=Load(), lineno=683, col_offset=24, end_lineno=683, end_col_offset=29), lineno=683, col_offset=12, end_lineno=683, end_col_offset=29)], lineno=674, col_offset=8, end_lineno=683, end_col_offset=29), FunctionDef(name='key_func', args=arguments(args=[arg(arg='item', annotation=Subscript(value=Name(id='tuple', ctx=Load(), lineno=686, col_offset=27, end_lineno=686, end_col_offset=32), slice=Tuple(elts=[Name(id='int', ctx=Load(), lineno=686, col_offset=33, end_lineno=686, end_col_offset=36), Name(id='float', ctx=Load(), lineno=686, col_offset=38, end_lineno=686, end_col_offset=43)], ctx=Load(), lineno=686, col_offset=33, end_lineno=686, end_col_offset=43), ctx=Load(), lineno=686, col_offset=27, end_lineno=686, end_col_offset=44), lineno=686, col_offset=21, end_lineno=686, end_col_offset=44)]), body=[Expr(value=Constant(value='Extract score from (index, score) tuple for sorting.\n\n            Parameters\n            ----------\n            item : tuple[int, float]\n                Tuple of (index, score).\n\n            Returns\n            -------\n            float\n                Score value.\n            ', lineno=687, col_offset=12, end_lineno=698, end_col_offset=15), lineno=687, col_offset=12, end_lineno=698, end_col_offset=15), Return(value=Subscript(value=Name(id='item', ctx=Load(), lineno=699, col_offset=19, end_lineno=699, end_col_offset=23), slice=Constant(value=1, lineno=699, col_offset=24, end_lineno=699, end_col_offset=25), ctx=Load(), lineno=699, col_offset=19, end_lineno=699, end_col_offset=26), lineno=699, col_offset=12, end_lineno=699, end_col_offset=26)], returns=Name(id='float', ctx=Load(), lineno=686, col_offset=49, end_lineno=686, end_col_offset=54), lineno=686, col_offset=8, end_lineno=699, end_col_offset=26), AnnAssign(target=Name(id='ranked', ctx=Store(), lineno=701, col_offset=8, end_lineno=701, end_col_offset=14), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=701, col_offset=16, end_lineno=701, end_col_offset=20), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=701, col_offset=21, end_lineno=701, end_col_offset=26), slice=Tuple(elts=[Name(id='int', ctx=Load(), lineno=701, col_offset=27, end_lineno=701, end_col_offset=30), Name(id='float', ctx=Load(), lineno=701, col_offset=32, end_lineno=701, end_col_offset=37)], ctx=Load(), lineno=701, col_offset=27, end_lineno=701, end_col_offset=37), ctx=Load(), lineno=701, col_offset=21, end_lineno=701, end_col_offset=38), ctx=Load(), lineno=701, col_offset=16, end_lineno=701, end_col_offset=39), value=Call(func=Name(id='sorted', ctx=Load(), lineno=701, col_offset=42, end_lineno=701, end_col_offset=48), args=[Call(func=Name(id='enumerate', ctx=Load(), lineno=701, col_offset=49, end_lineno=701, end_col_offset=58), args=[Name(id='scores', ctx=Load(), lineno=701, col_offset=59, end_lineno=701, end_col_offset=65)], lineno=701, col_offset=49, end_lineno=701, end_col_offset=66)], keywords=[keyword(arg='key', value=Name(id='key_func', ctx=Load(), lineno=701, col_offset=72, end_lineno=701, end_col_offset=80), lineno=701, col_offset=68, end_lineno=701, end_col_offset=80), keyword(arg='reverse', value=Constant(value=True, lineno=701, col_offset=90, end_lineno=701, end_col_offset=94), lineno=701, col_offset=82, end_lineno=701, end_col_offset=94)], lineno=701, col_offset=42, end_lineno=701, end_col_offset=95), simple=1, lineno=701, col_offset=8, end_lineno=701, end_col_offset=95), Return(value=ListComp(elt=Tuple(elts=[Attribute(value=Subscript(value=Attribute(value=Name(id='self', ctx=Load(), lineno=702, col_offset=17, end_lineno=702, end_col_offset=21), attr='docs', ctx=Load(), lineno=702, col_offset=17, end_lineno=702, end_col_offset=26), slice=Name(id='index', ctx=Load(), lineno=702, col_offset=27, end_lineno=702, end_col_offset=32), ctx=Load(), lineno=702, col_offset=17, end_lineno=702, end_col_offset=33), attr='chunk_id', ctx=Load(), lineno=702, col_offset=17, end_lineno=702, end_col_offset=42), Name(id='score', ctx=Load(), lineno=702, col_offset=44, end_lineno=702, end_col_offset=49)], ctx=Load(), lineno=702, col_offset=16, end_lineno=702, end_col_offset=50), generators=[comprehension(target=Tuple(elts=[Name(id='index', ctx=Store(), lineno=702, col_offset=55, end_lineno=702, end_col_offset=60), Name(id='score', ctx=Store(), lineno=702, col_offset=62, end_lineno=702, end_col_offset=67)], ctx=Store(), lineno=702, col_offset=55, end_lineno=702, end_col_offset=67), iter=Subscript(value=Name(id='ranked', ctx=Load(), lineno=702, col_offset=71, end_lineno=702, end_col_offset=77), slice=Slice(upper=Name(id='k', ctx=Load(), lineno=702, col_offset=79, end_lineno=702, end_col_offset=80), lineno=702, col_offset=78, end_lineno=702, end_col_offset=80), ctx=Load(), lineno=702, col_offset=71, end_lineno=702, end_col_offset=81), ifs=[Compare(left=Name(id='score', ctx=Load(), lineno=702, col_offset=85, end_lineno=702, end_col_offset=90), ops=[Gt()], comparators=[Constant(value=0.0, lineno=702, col_offset=93, end_lineno=702, end_col_offset=96)], lineno=702, col_offset=85, end_lineno=702, end_col_offset=96)], is_async=0)], lineno=702, col_offset=15, end_lineno=702, end_col_offset=97), lineno=702, col_offset=8, end_lineno=702, end_col_offset=97)], returns=Subscript(value=Name(id='list', ctx=Load(), lineno=644, col_offset=49, end_lineno=644, end_col_offset=53), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=644, col_offset=54, end_lineno=644, end_col_offset=59), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=644, col_offset=60, end_lineno=644, end_col_offset=63), Name(id='float', ctx=Load(), lineno=644, col_offset=65, end_lineno=644, end_col_offset=70)], ctx=Load(), lineno=644, col_offset=60, end_lineno=644, end_col_offset=70), ctx=Load(), lineno=644, col_offset=54, end_lineno=644, end_col_offset=71), ctx=Load(), lineno=644, col_offset=49, end_lineno=644, end_col_offset=72), lineno=644, col_offset=4, end_lineno=702, end_col_offset=97), FunctionDef(name='doc', args=arguments(args=[arg(arg='self', lineno=704, col_offset=12, end_lineno=704, end_col_offset=16), arg(arg='index', annotation=Name(id='int', ctx=Load(), lineno=704, col_offset=25, end_lineno=704, end_col_offset=28), lineno=704, col_offset=18, end_lineno=704, end_col_offset=28)]), body=[Expr(value=Constant(value='Get document at the specified index.\n\n        Parameters\n        ----------\n        index : int\n            Zero-based index of the document to retrieve.\n\n        Returns\n        -------\n        BM25Doc\n            Document at the specified index.\n\n        Raises\n        ------\n        IndexError\n            If index is out of range (negative or >= len(docs)).\n        ', lineno=705, col_offset=8, end_lineno=721, end_col_offset=11), lineno=705, col_offset=8, end_lineno=721, end_col_offset=11), If(test=BoolOp(op=Or(), values=[Compare(left=Name(id='index', ctx=Load(), lineno=722, col_offset=11, end_lineno=722, end_col_offset=16), ops=[Lt()], comparators=[Constant(value=0, lineno=722, col_offset=19, end_lineno=722, end_col_offset=20)], lineno=722, col_offset=11, end_lineno=722, end_col_offset=20), Compare(left=Name(id='index', ctx=Load(), lineno=722, col_offset=24, end_lineno=722, end_col_offset=29), ops=[GtE()], comparators=[Call(func=Name(id='len', ctx=Load(), lineno=722, col_offset=33, end_lineno=722, end_col_offset=36), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=722, col_offset=37, end_lineno=722, end_col_offset=41), attr='docs', ctx=Load(), lineno=722, col_offset=37, end_lineno=722, end_col_offset=46)], lineno=722, col_offset=33, end_lineno=722, end_col_offset=47)], lineno=722, col_offset=24, end_lineno=722, end_col_offset=47)], lineno=722, col_offset=11, end_lineno=722, end_col_offset=47), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=723, col_offset=12, end_lineno=723, end_col_offset=15)], value=JoinedStr(values=[Constant(value='Document index ', lineno=723, col_offset=20, end_lineno=723, end_col_offset=35), FormattedValue(value=Name(id='index', ctx=Load(), lineno=723, col_offset=36, end_lineno=723, end_col_offset=41), conversion=-1, lineno=723, col_offset=35, end_lineno=723, end_col_offset=42), Constant(value=' out of range for ', lineno=723, col_offset=42, end_lineno=723, end_col_offset=60), FormattedValue(value=Call(func=Name(id='len', ctx=Load(), lineno=723, col_offset=61, end_lineno=723, end_col_offset=64), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=723, col_offset=65, end_lineno=723, end_col_offset=69), attr='docs', ctx=Load(), lineno=723, col_offset=65, end_lineno=723, end_col_offset=74)], lineno=723, col_offset=61, end_lineno=723, end_col_offset=75), conversion=-1, lineno=723, col_offset=60, end_lineno=723, end_col_offset=76), Constant(value=' documents', lineno=723, col_offset=76, end_lineno=723, end_col_offset=86)], lineno=723, col_offset=18, end_lineno=723, end_col_offset=87), lineno=723, col_offset=12, end_lineno=723, end_col_offset=87), Raise(exc=Call(func=Name(id='IndexError', ctx=Load(), lineno=724, col_offset=18, end_lineno=724, end_col_offset=28), args=[Name(id='msg', ctx=Load(), lineno=724, col_offset=29, end_lineno=724, end_col_offset=32)], lineno=724, col_offset=18, end_lineno=724, end_col_offset=33), lineno=724, col_offset=12, end_lineno=724, end_col_offset=33)], lineno=722, col_offset=8, end_lineno=724, end_col_offset=33), Return(value=Subscript(value=Attribute(value=Name(id='self', ctx=Load(), lineno=725, col_offset=15, end_lineno=725, end_col_offset=19), attr='docs', ctx=Load(), lineno=725, col_offset=15, end_lineno=725, end_col_offset=24), slice=Name(id='index', ctx=Load(), lineno=725, col_offset=25, end_lineno=725, end_col_offset=30), ctx=Load(), lineno=725, col_offset=15, end_lineno=725, end_col_offset=31), lineno=725, col_offset=8, end_lineno=725, end_col_offset=31)], returns=Name(id='BM25Doc', ctx=Load(), lineno=704, col_offset=33, end_lineno=704, end_col_offset=40), lineno=704, col_offset=4, end_lineno=725, end_col_offset=31)], lineno=227, col_offset=0, end_lineno=725, end_col_offset=31)])