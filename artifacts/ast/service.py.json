Module(body=[Expr(value=Constant(value='Search service layer for orchestration and ranking.\n\nThis module provides typed service-layer functions for search operations, including reciprocal rank\nfusion, knowledge graph boosting, and result deduplication. All functions include structured logging\nand metrics.\n', lineno=1, col_offset=0, end_lineno=6, end_col_offset=3), lineno=1, col_offset=0, end_lineno=6, end_col_offset=3), ImportFrom(module='__future__', names=[alias(name='annotations', lineno=10, col_offset=23, end_lineno=10, end_col_offset=34)], level=0, lineno=10, col_offset=0, end_lineno=10, end_col_offset=34), Import(names=[alias(name='time', lineno=12, col_offset=7, end_lineno=12, end_col_offset=11)], lineno=12, col_offset=0, end_lineno=12, end_col_offset=11), ImportFrom(module='typing', names=[alias(name='TYPE_CHECKING', lineno=13, col_offset=19, end_lineno=13, end_col_offset=32)], level=0, lineno=13, col_offset=0, end_lineno=13, end_col_offset=32), ImportFrom(module='kgfoundry_common.errors.exceptions', names=[alias(name='VectorSearchError', lineno=15, col_offset=47, end_lineno=15, end_col_offset=64)], level=0, lineno=15, col_offset=0, end_lineno=15, end_col_offset=64), ImportFrom(module='kgfoundry_common.logging', names=[alias(name='get_logger', lineno=16, col_offset=37, end_lineno=16, end_col_offset=47), alias(name='with_fields', lineno=16, col_offset=49, end_lineno=16, end_col_offset=60)], level=0, lineno=16, col_offset=0, end_lineno=16, end_col_offset=60), ImportFrom(module='kgfoundry_common.navmap_loader', names=[alias(name='load_nav_metadata', lineno=17, col_offset=43, end_lineno=17, end_col_offset=60)], level=0, lineno=17, col_offset=0, end_lineno=17, end_col_offset=60), ImportFrom(module='kgfoundry_common.observability', names=[alias(name='MetricsProvider', lineno=18, col_offset=43, end_lineno=18, end_col_offset=58), alias(name='observe_duration', lineno=18, col_offset=60, end_lineno=18, end_col_offset=76)], level=0, lineno=18, col_offset=0, end_lineno=18, end_col_offset=76), If(test=Name(id='TYPE_CHECKING', ctx=Load(), lineno=20, col_offset=3, end_lineno=20, end_col_offset=16), body=[ImportFrom(module='collections.abc', names=[alias(name='Mapping', lineno=21, col_offset=32, end_lineno=21, end_col_offset=39)], level=0, lineno=21, col_offset=4, end_lineno=21, end_col_offset=39), ImportFrom(module='kgfoundry_common.problem_details', names=[alias(name='JsonValue', lineno=23, col_offset=49, end_lineno=23, end_col_offset=58)], level=0, lineno=23, col_offset=4, end_lineno=23, end_col_offset=58), ImportFrom(module='search_api.types', names=[alias(name='AgentSearchResponse', lineno=24, col_offset=33, end_lineno=24, end_col_offset=52), alias(name='VectorSearchResultTypedDict', lineno=24, col_offset=54, end_lineno=24, end_col_offset=81)], level=0, lineno=24, col_offset=4, end_lineno=24, end_col_offset=81)], lineno=20, col_offset=0, end_lineno=24, end_col_offset=81), Assign(targets=[Name(id='__all__', ctx=Store(), lineno=26, col_offset=0, end_lineno=26, end_col_offset=7)], value=List(elts=[Constant(value='apply_kg_boosts', lineno=27, col_offset=4, end_lineno=27, end_col_offset=21), Constant(value='mmr_deduplicate', lineno=28, col_offset=4, end_lineno=28, end_col_offset=21), Constant(value='rrf_fuse', lineno=29, col_offset=4, end_lineno=29, end_col_offset=14), Constant(value='search_service', lineno=30, col_offset=4, end_lineno=30, end_col_offset=20)], ctx=Load(), lineno=26, col_offset=10, end_lineno=31, end_col_offset=1), lineno=26, col_offset=0, end_lineno=31, end_col_offset=1), Assign(targets=[Name(id='__navmap__', ctx=Store(), lineno=32, col_offset=0, end_lineno=32, end_col_offset=10)], value=Call(func=Name(id='load_nav_metadata', ctx=Load(), lineno=32, col_offset=13, end_lineno=32, end_col_offset=30), args=[Name(id='__name__', ctx=Load(), lineno=32, col_offset=31, end_lineno=32, end_col_offset=39), Call(func=Name(id='tuple', ctx=Load(), lineno=32, col_offset=41, end_lineno=32, end_col_offset=46), args=[Name(id='__all__', ctx=Load(), lineno=32, col_offset=47, end_lineno=32, end_col_offset=54)], lineno=32, col_offset=41, end_lineno=32, end_col_offset=55)], lineno=32, col_offset=13, end_lineno=32, end_col_offset=56), lineno=32, col_offset=0, end_lineno=32, end_col_offset=56), Assign(targets=[Name(id='logger', ctx=Store(), lineno=34, col_offset=0, end_lineno=34, end_col_offset=6)], value=Call(func=Name(id='get_logger', ctx=Load(), lineno=34, col_offset=9, end_lineno=34, end_col_offset=19), args=[Name(id='__name__', ctx=Load(), lineno=34, col_offset=20, end_lineno=34, end_col_offset=28)], lineno=34, col_offset=9, end_lineno=34, end_col_offset=29), lineno=34, col_offset=0, end_lineno=34, end_col_offset=29), FunctionDef(name='rrf_fuse', args=arguments(args=[arg(arg='rankers', annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=38, col_offset=22, end_lineno=38, end_col_offset=26), slice=Subscript(value=Name(id='list', ctx=Load(), lineno=38, col_offset=27, end_lineno=38, end_col_offset=31), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=38, col_offset=32, end_lineno=38, end_col_offset=37), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=38, col_offset=38, end_lineno=38, end_col_offset=41), Name(id='float', ctx=Load(), lineno=38, col_offset=43, end_lineno=38, end_col_offset=48)], ctx=Load(), lineno=38, col_offset=38, end_lineno=38, end_col_offset=48), ctx=Load(), lineno=38, col_offset=32, end_lineno=38, end_col_offset=49), ctx=Load(), lineno=38, col_offset=27, end_lineno=38, end_col_offset=50), ctx=Load(), lineno=38, col_offset=22, end_lineno=38, end_col_offset=51), lineno=38, col_offset=13, end_lineno=38, end_col_offset=51), arg(arg='k_rrf', annotation=Name(id='int', ctx=Load(), lineno=38, col_offset=60, end_lineno=38, end_col_offset=63), lineno=38, col_offset=53, end_lineno=38, end_col_offset=63)], defaults=[Constant(value=60, lineno=38, col_offset=66, end_lineno=38, end_col_offset=68)]), body=[Expr(value=Constant(value='Fuse multiple ranked lists using Reciprocal Rank Fusion (RRF).\n\n    Combines multiple ranked lists into a single ranked list using RRF scoring.\n    Each item\'s score is the sum of 1 / (k_rrf + rank) across all rankers.\n\n    Parameters\n    ----------\n    rankers : list[list[tuple[str, float]]]\n        List of ranked lists, where each list contains (item_id, score) tuples.\n    k_rrf : int, optional\n        RRF constant parameter (higher = more weight to top ranks).\n        Defaults to 60.\n\n    Returns\n    -------\n    dict[str, float]\n        Dictionary mapping item IDs to fused RRF scores.\n\n    Examples\n    --------\n    >>> dense = [("doc1", 0.9), ("doc2", 0.8)]\n    >>> sparse = [("doc2", 0.85), ("doc1", 0.75)]\n    >>> fused = rrf_fuse([dense, sparse], k_rrf=60)\n    >>> "doc1" in fused and "doc2" in fused\n    True\n    ', lineno=39, col_offset=4, end_lineno=64, end_col_offset=7), lineno=39, col_offset=4, end_lineno=64, end_col_offset=7), With(items=[withitem(context_expr=Call(func=Name(id='with_fields', ctx=Load(), lineno=65, col_offset=9, end_lineno=65, end_col_offset=20), args=[Name(id='logger', ctx=Load(), lineno=65, col_offset=21, end_lineno=65, end_col_offset=27)], keywords=[keyword(arg='operation', value=Constant(value='rrf_fuse', lineno=65, col_offset=39, end_lineno=65, end_col_offset=49), lineno=65, col_offset=29, end_lineno=65, end_col_offset=49), keyword(arg='k_rrf', value=Name(id='k_rrf', ctx=Load(), lineno=65, col_offset=57, end_lineno=65, end_col_offset=62), lineno=65, col_offset=51, end_lineno=65, end_col_offset=62), keyword(arg='num_rankers', value=Call(func=Name(id='len', ctx=Load(), lineno=65, col_offset=76, end_lineno=65, end_col_offset=79), args=[Name(id='rankers', ctx=Load(), lineno=65, col_offset=80, end_lineno=65, end_col_offset=87)], lineno=65, col_offset=76, end_lineno=65, end_col_offset=88), lineno=65, col_offset=64, end_lineno=65, end_col_offset=88)], lineno=65, col_offset=9, end_lineno=65, end_col_offset=89))], body=[AnnAssign(target=Name(id='scores', ctx=Store(), lineno=66, col_offset=8, end_lineno=66, end_col_offset=14), annotation=Subscript(value=Name(id='dict', ctx=Load(), lineno=66, col_offset=16, end_lineno=66, end_col_offset=20), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=66, col_offset=21, end_lineno=66, end_col_offset=24), Name(id='float', ctx=Load(), lineno=66, col_offset=26, end_lineno=66, end_col_offset=31)], ctx=Load(), lineno=66, col_offset=21, end_lineno=66, end_col_offset=31), ctx=Load(), lineno=66, col_offset=16, end_lineno=66, end_col_offset=32), value=Dict(lineno=66, col_offset=35, end_lineno=66, end_col_offset=37), simple=1, lineno=66, col_offset=8, end_lineno=66, end_col_offset=37), For(target=Name(id='ranked', ctx=Store(), lineno=67, col_offset=12, end_lineno=67, end_col_offset=18), iter=Name(id='rankers', ctx=Load(), lineno=67, col_offset=22, end_lineno=67, end_col_offset=29), body=[For(target=Tuple(elts=[Name(id='rank', ctx=Store(), lineno=68, col_offset=16, end_lineno=68, end_col_offset=20), Tuple(elts=[Name(id='item_id', ctx=Store(), lineno=68, col_offset=23, end_lineno=68, end_col_offset=30), Name(id='_score', ctx=Store(), lineno=68, col_offset=32, end_lineno=68, end_col_offset=38)], ctx=Store(), lineno=68, col_offset=22, end_lineno=68, end_col_offset=39)], ctx=Store(), lineno=68, col_offset=16, end_lineno=68, end_col_offset=39), iter=Call(func=Name(id='enumerate', ctx=Load(), lineno=68, col_offset=43, end_lineno=68, end_col_offset=52), args=[Name(id='ranked', ctx=Load(), lineno=68, col_offset=53, end_lineno=68, end_col_offset=59)], keywords=[keyword(arg='start', value=Constant(value=1, lineno=68, col_offset=67, end_lineno=68, end_col_offset=68), lineno=68, col_offset=61, end_lineno=68, end_col_offset=68)], lineno=68, col_offset=43, end_lineno=68, end_col_offset=69), body=[Assign(targets=[Subscript(value=Name(id='scores', ctx=Load(), lineno=69, col_offset=16, end_lineno=69, end_col_offset=22), slice=Name(id='item_id', ctx=Load(), lineno=69, col_offset=23, end_lineno=69, end_col_offset=30), ctx=Store(), lineno=69, col_offset=16, end_lineno=69, end_col_offset=31)], value=BinOp(left=Call(func=Attribute(value=Name(id='scores', ctx=Load(), lineno=69, col_offset=34, end_lineno=69, end_col_offset=40), attr='get', ctx=Load(), lineno=69, col_offset=34, end_lineno=69, end_col_offset=44), args=[Name(id='item_id', ctx=Load(), lineno=69, col_offset=45, end_lineno=69, end_col_offset=52), Constant(value=0.0, lineno=69, col_offset=54, end_lineno=69, end_col_offset=57)], lineno=69, col_offset=34, end_lineno=69, end_col_offset=58), op=Add(), right=BinOp(left=Constant(value=1.0, lineno=69, col_offset=61, end_lineno=69, end_col_offset=64), op=Div(), right=BinOp(left=Name(id='k_rrf', ctx=Load(), lineno=69, col_offset=68, end_lineno=69, end_col_offset=73), op=Add(), right=Name(id='rank', ctx=Load(), lineno=69, col_offset=76, end_lineno=69, end_col_offset=80), lineno=69, col_offset=68, end_lineno=69, end_col_offset=80), lineno=69, col_offset=61, end_lineno=69, end_col_offset=81), lineno=69, col_offset=34, end_lineno=69, end_col_offset=81), lineno=69, col_offset=16, end_lineno=69, end_col_offset=81)], lineno=68, col_offset=12, end_lineno=69, end_col_offset=81)], lineno=67, col_offset=8, end_lineno=69, end_col_offset=81), Expr(value=Call(func=Attribute(value=Name(id='logger', ctx=Load(), lineno=70, col_offset=8, end_lineno=70, end_col_offset=14), attr='debug', ctx=Load(), lineno=70, col_offset=8, end_lineno=70, end_col_offset=20), args=[Constant(value='RRF fusion completed', lineno=70, col_offset=21, end_lineno=70, end_col_offset=43)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='num_items', lineno=70, col_offset=52, end_lineno=70, end_col_offset=63)], values=[Call(func=Name(id='len', ctx=Load(), lineno=70, col_offset=65, end_lineno=70, end_col_offset=68), args=[Name(id='scores', ctx=Load(), lineno=70, col_offset=69, end_lineno=70, end_col_offset=75)], lineno=70, col_offset=65, end_lineno=70, end_col_offset=76)], lineno=70, col_offset=51, end_lineno=70, end_col_offset=77), lineno=70, col_offset=45, end_lineno=70, end_col_offset=77)], lineno=70, col_offset=8, end_lineno=70, end_col_offset=78), lineno=70, col_offset=8, end_lineno=70, end_col_offset=78), Return(value=Name(id='scores', ctx=Load(), lineno=71, col_offset=15, end_lineno=71, end_col_offset=21), lineno=71, col_offset=8, end_lineno=71, end_col_offset=21)], lineno=65, col_offset=4, end_lineno=71, end_col_offset=21)], returns=Subscript(value=Name(id='dict', ctx=Load(), lineno=38, col_offset=73, end_lineno=38, end_col_offset=77), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=38, col_offset=78, end_lineno=38, end_col_offset=81), Name(id='float', ctx=Load(), lineno=38, col_offset=83, end_lineno=38, end_col_offset=88)], ctx=Load(), lineno=38, col_offset=78, end_lineno=38, end_col_offset=88), ctx=Load(), lineno=38, col_offset=73, end_lineno=38, end_col_offset=89), lineno=38, col_offset=0, end_lineno=71, end_col_offset=21), FunctionDef(name='apply_kg_boosts', args=arguments(args=[arg(arg='cands', annotation=Subscript(value=Name(id='dict', ctx=Load(), lineno=76, col_offset=11, end_lineno=76, end_col_offset=15), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=76, col_offset=16, end_lineno=76, end_col_offset=19), Name(id='float', ctx=Load(), lineno=76, col_offset=21, end_lineno=76, end_col_offset=26)], ctx=Load(), lineno=76, col_offset=16, end_lineno=76, end_col_offset=26), ctx=Load(), lineno=76, col_offset=11, end_lineno=76, end_col_offset=27), lineno=76, col_offset=4, end_lineno=76, end_col_offset=27), arg(arg='query', annotation=Name(id='str', ctx=Load(), lineno=77, col_offset=11, end_lineno=77, end_col_offset=14), lineno=77, col_offset=4, end_lineno=77, end_col_offset=14), arg(arg='direct', annotation=Name(id='float', ctx=Load(), lineno=78, col_offset=12, end_lineno=78, end_col_offset=17), lineno=78, col_offset=4, end_lineno=78, end_col_offset=17), arg(arg='one_hop', annotation=Name(id='float', ctx=Load(), lineno=79, col_offset=13, end_lineno=79, end_col_offset=18), lineno=79, col_offset=4, end_lineno=79, end_col_offset=18)], kwonlyargs=[arg(arg='kg_concepts', annotation=BinOp(left=Subscript(value=Name(id='Mapping', ctx=Load(), lineno=81, col_offset=17, end_lineno=81, end_col_offset=24), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=81, col_offset=25, end_lineno=81, end_col_offset=28), Subscript(value=Name(id='set', ctx=Load(), lineno=81, col_offset=30, end_lineno=81, end_col_offset=33), slice=Name(id='str', ctx=Load(), lineno=81, col_offset=34, end_lineno=81, end_col_offset=37), ctx=Load(), lineno=81, col_offset=30, end_lineno=81, end_col_offset=38)], ctx=Load(), lineno=81, col_offset=25, end_lineno=81, end_col_offset=38), ctx=Load(), lineno=81, col_offset=17, end_lineno=81, end_col_offset=39), op=BitOr(), right=Constant(value=None, lineno=81, col_offset=42, end_lineno=81, end_col_offset=46), lineno=81, col_offset=17, end_lineno=81, end_col_offset=46), lineno=81, col_offset=4, end_lineno=81, end_col_offset=46)], kw_defaults=[Constant(value=None, lineno=81, col_offset=49, end_lineno=81, end_col_offset=53)], defaults=[Constant(value=0.08, lineno=78, col_offset=20, end_lineno=78, end_col_offset=24), Constant(value=0.04, lineno=79, col_offset=21, end_lineno=79, end_col_offset=25)]), body=[Expr(value=Constant(value='Apply knowledge graph boosts to candidate scores.\n\n    Boosts scores for candidates that have direct or one-hop concept matches\n    with the query. If kg_concepts is None, returns candidates unchanged.\n\n    Parameters\n    ----------\n    cands : dict[str, float]\n        Dictionary mapping candidate IDs to base scores.\n    query : str\n        Query text (used to extract concept mentions).\n    direct : float, optional\n        Boost amount for direct concept matches. Defaults to 0.08.\n    one_hop : float, optional\n        Boost amount for one-hop concept matches. Defaults to 0.04.\n    kg_concepts : Mapping[str, set[str]] | None, optional\n        Mapping from candidate IDs to sets of concept IDs.\n        If None, no boosts are applied. Defaults to None.\n\n    Returns\n    -------\n    dict[str, float]\n        Dictionary mapping candidate IDs to boosted scores.\n\n    Examples\n    --------\n    >>> cands = {"doc1": 0.8, "doc2": 0.7}\n    >>> boosted = apply_kg_boosts(cands, "test query", kg_concepts={"doc1": {"C:42"}})\n    >>> boosted["doc1"] > cands["doc1"]\n    True\n    ', lineno=83, col_offset=4, end_lineno=113, end_col_offset=7), lineno=83, col_offset=4, end_lineno=113, end_col_offset=7), With(items=[withitem(context_expr=Call(func=Name(id='with_fields', ctx=Load(), lineno=114, col_offset=9, end_lineno=114, end_col_offset=20), args=[Name(id='logger', ctx=Load(), lineno=114, col_offset=21, end_lineno=114, end_col_offset=27)], keywords=[keyword(arg='operation', value=Constant(value='apply_kg_boosts', lineno=114, col_offset=39, end_lineno=114, end_col_offset=56), lineno=114, col_offset=29, end_lineno=114, end_col_offset=56), keyword(arg='query', value=Subscript(value=Name(id='query', ctx=Load(), lineno=114, col_offset=64, end_lineno=114, end_col_offset=69), slice=Slice(upper=Constant(value=50, lineno=114, col_offset=71, end_lineno=114, end_col_offset=73), lineno=114, col_offset=70, end_lineno=114, end_col_offset=73), ctx=Load(), lineno=114, col_offset=64, end_lineno=114, end_col_offset=74), lineno=114, col_offset=58, end_lineno=114, end_col_offset=74)], lineno=114, col_offset=9, end_lineno=114, end_col_offset=75))], body=[If(test=Compare(left=Name(id='kg_concepts', ctx=Load(), lineno=115, col_offset=11, end_lineno=115, end_col_offset=22), ops=[Is()], comparators=[Constant(value=None, lineno=115, col_offset=26, end_lineno=115, end_col_offset=30)], lineno=115, col_offset=11, end_lineno=115, end_col_offset=30), body=[Expr(value=Call(func=Attribute(value=Name(id='logger', ctx=Load(), lineno=116, col_offset=12, end_lineno=116, end_col_offset=18), attr='debug', ctx=Load(), lineno=116, col_offset=12, end_lineno=116, end_col_offset=24), args=[Constant(value='No KG concepts provided, skipping boosts', lineno=116, col_offset=25, end_lineno=116, end_col_offset=67)], lineno=116, col_offset=12, end_lineno=116, end_col_offset=68), lineno=116, col_offset=12, end_lineno=116, end_col_offset=68), Return(value=Name(id='cands', ctx=Load(), lineno=117, col_offset=19, end_lineno=117, end_col_offset=24), lineno=117, col_offset=12, end_lineno=117, end_col_offset=24)], lineno=115, col_offset=8, end_lineno=117, end_col_offset=24), AnnAssign(target=Name(id='q_concepts', ctx=Store(), lineno=120, col_offset=8, end_lineno=120, end_col_offset=18), annotation=Subscript(value=Name(id='set', ctx=Load(), lineno=120, col_offset=20, end_lineno=120, end_col_offset=23), slice=Name(id='str', ctx=Load(), lineno=120, col_offset=24, end_lineno=120, end_col_offset=27), ctx=Load(), lineno=120, col_offset=20, end_lineno=120, end_col_offset=28), value=Call(func=Name(id='set', ctx=Load(), lineno=120, col_offset=31, end_lineno=120, end_col_offset=34), lineno=120, col_offset=31, end_lineno=120, end_col_offset=36), simple=1, lineno=120, col_offset=8, end_lineno=120, end_col_offset=36), For(target=Name(id='word', ctx=Store(), lineno=121, col_offset=12, end_lineno=121, end_col_offset=16), iter=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='query', ctx=Load(), lineno=121, col_offset=20, end_lineno=121, end_col_offset=25), attr='lower', ctx=Load(), lineno=121, col_offset=20, end_lineno=121, end_col_offset=31), lineno=121, col_offset=20, end_lineno=121, end_col_offset=33), attr='split', ctx=Load(), lineno=121, col_offset=20, end_lineno=121, end_col_offset=39), lineno=121, col_offset=20, end_lineno=121, end_col_offset=41), body=[If(test=Call(func=Attribute(value=Name(id='word', ctx=Load(), lineno=122, col_offset=15, end_lineno=122, end_col_offset=19), attr='startswith', ctx=Load(), lineno=122, col_offset=15, end_lineno=122, end_col_offset=30), args=[Constant(value='concept', lineno=122, col_offset=31, end_lineno=122, end_col_offset=40)], lineno=122, col_offset=15, end_lineno=122, end_col_offset=41), body=[Expr(value=Call(func=Attribute(value=Name(id='q_concepts', ctx=Load(), lineno=123, col_offset=16, end_lineno=123, end_col_offset=26), attr='add', ctx=Load(), lineno=123, col_offset=16, end_lineno=123, end_col_offset=30), args=[JoinedStr(values=[Constant(value='C:', lineno=123, col_offset=33, end_lineno=123, end_col_offset=35), FormattedValue(value=Call(func=Attribute(value=Name(id='word', ctx=Load(), lineno=123, col_offset=36, end_lineno=123, end_col_offset=40), attr='replace', ctx=Load(), lineno=123, col_offset=36, end_lineno=123, end_col_offset=48), args=[Constant(value='concept', lineno=123, col_offset=49, end_lineno=123, end_col_offset=58), Constant(value='', lineno=123, col_offset=60, end_lineno=123, end_col_offset=62)], lineno=123, col_offset=36, end_lineno=123, end_col_offset=63), conversion=-1, lineno=123, col_offset=35, end_lineno=123, end_col_offset=64)], lineno=123, col_offset=31, end_lineno=123, end_col_offset=65)], lineno=123, col_offset=16, end_lineno=123, end_col_offset=66), lineno=123, col_offset=16, end_lineno=123, end_col_offset=66)], lineno=122, col_offset=12, end_lineno=123, end_col_offset=66)], lineno=121, col_offset=8, end_lineno=123, end_col_offset=66), Assign(targets=[Name(id='boosted', ctx=Store(), lineno=125, col_offset=8, end_lineno=125, end_col_offset=15)], value=Call(func=Name(id='dict', ctx=Load(), lineno=125, col_offset=18, end_lineno=125, end_col_offset=22), args=[Name(id='cands', ctx=Load(), lineno=125, col_offset=23, end_lineno=125, end_col_offset=28)], lineno=125, col_offset=18, end_lineno=125, end_col_offset=29), lineno=125, col_offset=8, end_lineno=125, end_col_offset=29), Assign(targets=[Name(id='boost_count', ctx=Store(), lineno=126, col_offset=8, end_lineno=126, end_col_offset=19)], value=Constant(value=0, lineno=126, col_offset=22, end_lineno=126, end_col_offset=23), lineno=126, col_offset=8, end_lineno=126, end_col_offset=23), For(target=Tuple(elts=[Name(id='cand_id', ctx=Store(), lineno=127, col_offset=12, end_lineno=127, end_col_offset=19), Name(id='base_score', ctx=Store(), lineno=127, col_offset=21, end_lineno=127, end_col_offset=31)], ctx=Store(), lineno=127, col_offset=12, end_lineno=127, end_col_offset=31), iter=Call(func=Attribute(value=Name(id='cands', ctx=Load(), lineno=127, col_offset=35, end_lineno=127, end_col_offset=40), attr='items', ctx=Load(), lineno=127, col_offset=35, end_lineno=127, end_col_offset=46), lineno=127, col_offset=35, end_lineno=127, end_col_offset=48), body=[Assign(targets=[Name(id='linked', ctx=Store(), lineno=128, col_offset=12, end_lineno=128, end_col_offset=18)], value=Call(func=Attribute(value=Name(id='kg_concepts', ctx=Load(), lineno=128, col_offset=21, end_lineno=128, end_col_offset=32), attr='get', ctx=Load(), lineno=128, col_offset=21, end_lineno=128, end_col_offset=36), args=[Name(id='cand_id', ctx=Load(), lineno=128, col_offset=37, end_lineno=128, end_col_offset=44), Call(func=Name(id='set', ctx=Load(), lineno=128, col_offset=46, end_lineno=128, end_col_offset=49), lineno=128, col_offset=46, end_lineno=128, end_col_offset=51)], lineno=128, col_offset=21, end_lineno=128, end_col_offset=52), lineno=128, col_offset=12, end_lineno=128, end_col_offset=52), Assign(targets=[Name(id='boost', ctx=Store(), lineno=129, col_offset=12, end_lineno=129, end_col_offset=17)], value=Constant(value=0.0, lineno=129, col_offset=20, end_lineno=129, end_col_offset=23), lineno=129, col_offset=12, end_lineno=129, end_col_offset=23), If(test=BinOp(left=Name(id='linked', ctx=Load(), lineno=130, col_offset=15, end_lineno=130, end_col_offset=21), op=BitAnd(), right=Name(id='q_concepts', ctx=Load(), lineno=130, col_offset=24, end_lineno=130, end_col_offset=34), lineno=130, col_offset=15, end_lineno=130, end_col_offset=34), body=[AugAssign(target=Name(id='boost', ctx=Store(), lineno=131, col_offset=16, end_lineno=131, end_col_offset=21), op=Add(), value=Name(id='direct', ctx=Load(), lineno=131, col_offset=25, end_lineno=131, end_col_offset=31), lineno=131, col_offset=16, end_lineno=131, end_col_offset=31)], orelse=[For(target=Name(id='concept', ctx=Store(), lineno=133, col_offset=20, end_lineno=133, end_col_offset=27), iter=Name(id='linked', ctx=Load(), lineno=133, col_offset=31, end_lineno=133, end_col_offset=37), body=[If(test=Compare(left=Name(id='concept', ctx=Load(), lineno=135, col_offset=23, end_lineno=135, end_col_offset=30), ops=[In()], comparators=[Name(id='q_concepts', ctx=Load(), lineno=135, col_offset=34, end_lineno=135, end_col_offset=44)], lineno=135, col_offset=23, end_lineno=135, end_col_offset=44), body=[AugAssign(target=Name(id='boost', ctx=Store(), lineno=136, col_offset=24, end_lineno=136, end_col_offset=29), op=Add(), value=Name(id='one_hop', ctx=Load(), lineno=136, col_offset=33, end_lineno=136, end_col_offset=40), lineno=136, col_offset=24, end_lineno=136, end_col_offset=40), Break(lineno=137, col_offset=24, end_lineno=137, end_col_offset=29)], lineno=135, col_offset=20, end_lineno=137, end_col_offset=29)], lineno=133, col_offset=16, end_lineno=137, end_col_offset=29)], lineno=130, col_offset=12, end_lineno=137, end_col_offset=29), If(test=Compare(left=Name(id='boost', ctx=Load(), lineno=138, col_offset=15, end_lineno=138, end_col_offset=20), ops=[Gt()], comparators=[Constant(value=0, lineno=138, col_offset=23, end_lineno=138, end_col_offset=24)], lineno=138, col_offset=15, end_lineno=138, end_col_offset=24), body=[AugAssign(target=Name(id='boost_count', ctx=Store(), lineno=139, col_offset=16, end_lineno=139, end_col_offset=27), op=Add(), value=Constant(value=1, lineno=139, col_offset=31, end_lineno=139, end_col_offset=32), lineno=139, col_offset=16, end_lineno=139, end_col_offset=32)], lineno=138, col_offset=12, end_lineno=139, end_col_offset=32), Assign(targets=[Subscript(value=Name(id='boosted', ctx=Load(), lineno=140, col_offset=12, end_lineno=140, end_col_offset=19), slice=Name(id='cand_id', ctx=Load(), lineno=140, col_offset=20, end_lineno=140, end_col_offset=27), ctx=Store(), lineno=140, col_offset=12, end_lineno=140, end_col_offset=28)], value=BinOp(left=Name(id='base_score', ctx=Load(), lineno=140, col_offset=31, end_lineno=140, end_col_offset=41), op=Add(), right=Name(id='boost', ctx=Load(), lineno=140, col_offset=44, end_lineno=140, end_col_offset=49), lineno=140, col_offset=31, end_lineno=140, end_col_offset=49), lineno=140, col_offset=12, end_lineno=140, end_col_offset=49)], lineno=127, col_offset=8, end_lineno=140, end_col_offset=49), Expr(value=Call(func=Attribute(value=Name(id='logger', ctx=Load(), lineno=142, col_offset=8, end_lineno=142, end_col_offset=14), attr='debug', ctx=Load(), lineno=142, col_offset=8, end_lineno=142, end_col_offset=20), args=[Constant(value='KG boosts applied', lineno=143, col_offset=12, end_lineno=143, end_col_offset=31)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='boosted_count', lineno=144, col_offset=19, end_lineno=144, end_col_offset=34), Constant(value='total_candidates', lineno=144, col_offset=49, end_lineno=144, end_col_offset=67)], values=[Name(id='boost_count', ctx=Load(), lineno=144, col_offset=36, end_lineno=144, end_col_offset=47), Call(func=Name(id='len', ctx=Load(), lineno=144, col_offset=69, end_lineno=144, end_col_offset=72), args=[Name(id='cands', ctx=Load(), lineno=144, col_offset=73, end_lineno=144, end_col_offset=78)], lineno=144, col_offset=69, end_lineno=144, end_col_offset=79)], lineno=144, col_offset=18, end_lineno=144, end_col_offset=80), lineno=144, col_offset=12, end_lineno=144, end_col_offset=80)], lineno=142, col_offset=8, end_lineno=145, end_col_offset=9), lineno=142, col_offset=8, end_lineno=145, end_col_offset=9), Return(value=Name(id='boosted', ctx=Load(), lineno=146, col_offset=15, end_lineno=146, end_col_offset=22), lineno=146, col_offset=8, end_lineno=146, end_col_offset=22)], lineno=114, col_offset=4, end_lineno=146, end_col_offset=22)], returns=Subscript(value=Name(id='dict', ctx=Load(), lineno=82, col_offset=5, end_lineno=82, end_col_offset=9), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=82, col_offset=10, end_lineno=82, end_col_offset=13), Name(id='float', ctx=Load(), lineno=82, col_offset=15, end_lineno=82, end_col_offset=20)], ctx=Load(), lineno=82, col_offset=10, end_lineno=82, end_col_offset=20), ctx=Load(), lineno=82, col_offset=5, end_lineno=82, end_col_offset=21), lineno=75, col_offset=0, end_lineno=146, end_col_offset=22), FunctionDef(name='mmr_deduplicate', args=arguments(args=[arg(arg='results', annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=151, col_offset=13, end_lineno=151, end_col_offset=17), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=151, col_offset=18, end_lineno=151, end_col_offset=23), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=151, col_offset=24, end_lineno=151, end_col_offset=27), Name(id='float', ctx=Load(), lineno=151, col_offset=29, end_lineno=151, end_col_offset=34)], ctx=Load(), lineno=151, col_offset=24, end_lineno=151, end_col_offset=34), ctx=Load(), lineno=151, col_offset=18, end_lineno=151, end_col_offset=35), ctx=Load(), lineno=151, col_offset=13, end_lineno=151, end_col_offset=36), lineno=151, col_offset=4, end_lineno=151, end_col_offset=36), arg(arg='lambda_mmr', annotation=Name(id='float', ctx=Load(), lineno=151, col_offset=50, end_lineno=151, end_col_offset=55), lineno=151, col_offset=38, end_lineno=151, end_col_offset=55)], defaults=[Constant(value=0.7, lineno=151, col_offset=58, end_lineno=151, end_col_offset=61)]), body=[Expr(value=Constant(value='Deduplicate results using Maximal Marginal Relevance (MMR).\n\n    Removes duplicate items while preserving diversity. Currently returns\n    results unchanged; full MMR implementation requires document embeddings.\n\n    Parameters\n    ----------\n    results : list[tuple[str, float]]\n        List of (item_id, score) tuples, sorted by score descending.\n    lambda_mmr : float, optional\n        MMR lambda parameter (0.0 = pure relevance, 1.0 = pure diversity).\n        Defaults to 0.7.\n\n    Returns\n    -------\n    list[tuple[str, float]]\n        Deduplicated list of (item_id, score) tuples.\n\n    Examples\n    --------\n    >>> results = [("doc1", 0.9), ("doc2", 0.8), ("doc1", 0.7)]\n    >>> deduped = mmr_deduplicate(results)\n    >>> len(deduped) <= len(results)\n    True\n    ', lineno=153, col_offset=4, end_lineno=177, end_col_offset=7), lineno=153, col_offset=4, end_lineno=177, end_col_offset=7), With(items=[withitem(context_expr=Call(func=Name(id='with_fields', ctx=Load(), lineno=178, col_offset=9, end_lineno=178, end_col_offset=20), args=[Name(id='logger', ctx=Load(), lineno=178, col_offset=21, end_lineno=178, end_col_offset=27)], keywords=[keyword(arg='operation', value=Constant(value='mmr_deduplicate', lineno=178, col_offset=39, end_lineno=178, end_col_offset=56), lineno=178, col_offset=29, end_lineno=178, end_col_offset=56), keyword(arg='lambda_mmr', value=Name(id='lambda_mmr', ctx=Load(), lineno=178, col_offset=69, end_lineno=178, end_col_offset=79), lineno=178, col_offset=58, end_lineno=178, end_col_offset=79)], lineno=178, col_offset=9, end_lineno=178, end_col_offset=80))], body=[AnnAssign(target=Name(id='seen', ctx=Store(), lineno=180, col_offset=8, end_lineno=180, end_col_offset=12), annotation=Subscript(value=Name(id='set', ctx=Load(), lineno=180, col_offset=14, end_lineno=180, end_col_offset=17), slice=Name(id='str', ctx=Load(), lineno=180, col_offset=18, end_lineno=180, end_col_offset=21), ctx=Load(), lineno=180, col_offset=14, end_lineno=180, end_col_offset=22), value=Call(func=Name(id='set', ctx=Load(), lineno=180, col_offset=25, end_lineno=180, end_col_offset=28), lineno=180, col_offset=25, end_lineno=180, end_col_offset=30), simple=1, lineno=180, col_offset=8, end_lineno=180, end_col_offset=30), AnnAssign(target=Name(id='deduped', ctx=Store(), lineno=181, col_offset=8, end_lineno=181, end_col_offset=15), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=181, col_offset=17, end_lineno=181, end_col_offset=21), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=181, col_offset=22, end_lineno=181, end_col_offset=27), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=181, col_offset=28, end_lineno=181, end_col_offset=31), Name(id='float', ctx=Load(), lineno=181, col_offset=33, end_lineno=181, end_col_offset=38)], ctx=Load(), lineno=181, col_offset=28, end_lineno=181, end_col_offset=38), ctx=Load(), lineno=181, col_offset=22, end_lineno=181, end_col_offset=39), ctx=Load(), lineno=181, col_offset=17, end_lineno=181, end_col_offset=40), value=List(ctx=Load(), lineno=181, col_offset=43, end_lineno=181, end_col_offset=45), simple=1, lineno=181, col_offset=8, end_lineno=181, end_col_offset=45), For(target=Tuple(elts=[Name(id='item_id', ctx=Store(), lineno=182, col_offset=12, end_lineno=182, end_col_offset=19), Name(id='score', ctx=Store(), lineno=182, col_offset=21, end_lineno=182, end_col_offset=26)], ctx=Store(), lineno=182, col_offset=12, end_lineno=182, end_col_offset=26), iter=Name(id='results', ctx=Load(), lineno=182, col_offset=30, end_lineno=182, end_col_offset=37), body=[If(test=Compare(left=Name(id='item_id', ctx=Load(), lineno=183, col_offset=15, end_lineno=183, end_col_offset=22), ops=[NotIn()], comparators=[Name(id='seen', ctx=Load(), lineno=183, col_offset=30, end_lineno=183, end_col_offset=34)], lineno=183, col_offset=15, end_lineno=183, end_col_offset=34), body=[Expr(value=Call(func=Attribute(value=Name(id='seen', ctx=Load(), lineno=184, col_offset=16, end_lineno=184, end_col_offset=20), attr='add', ctx=Load(), lineno=184, col_offset=16, end_lineno=184, end_col_offset=24), args=[Name(id='item_id', ctx=Load(), lineno=184, col_offset=25, end_lineno=184, end_col_offset=32)], lineno=184, col_offset=16, end_lineno=184, end_col_offset=33), lineno=184, col_offset=16, end_lineno=184, end_col_offset=33), Expr(value=Call(func=Attribute(value=Name(id='deduped', ctx=Load(), lineno=185, col_offset=16, end_lineno=185, end_col_offset=23), attr='append', ctx=Load(), lineno=185, col_offset=16, end_lineno=185, end_col_offset=30), args=[Tuple(elts=[Name(id='item_id', ctx=Load(), lineno=185, col_offset=32, end_lineno=185, end_col_offset=39), Name(id='score', ctx=Load(), lineno=185, col_offset=41, end_lineno=185, end_col_offset=46)], ctx=Load(), lineno=185, col_offset=31, end_lineno=185, end_col_offset=47)], lineno=185, col_offset=16, end_lineno=185, end_col_offset=48), lineno=185, col_offset=16, end_lineno=185, end_col_offset=48)], lineno=183, col_offset=12, end_lineno=185, end_col_offset=48)], lineno=182, col_offset=8, end_lineno=185, end_col_offset=48), Expr(value=Call(func=Attribute(value=Name(id='logger', ctx=Load(), lineno=187, col_offset=8, end_lineno=187, end_col_offset=14), attr='debug', ctx=Load(), lineno=187, col_offset=8, end_lineno=187, end_col_offset=20), args=[Constant(value='MMR deduplication completed', lineno=188, col_offset=12, end_lineno=188, end_col_offset=41)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='original_count', lineno=189, col_offset=19, end_lineno=189, end_col_offset=35), Constant(value='deduped_count', lineno=189, col_offset=51, end_lineno=189, end_col_offset=66)], values=[Call(func=Name(id='len', ctx=Load(), lineno=189, col_offset=37, end_lineno=189, end_col_offset=40), args=[Name(id='results', ctx=Load(), lineno=189, col_offset=41, end_lineno=189, end_col_offset=48)], lineno=189, col_offset=37, end_lineno=189, end_col_offset=49), Call(func=Name(id='len', ctx=Load(), lineno=189, col_offset=68, end_lineno=189, end_col_offset=71), args=[Name(id='deduped', ctx=Load(), lineno=189, col_offset=72, end_lineno=189, end_col_offset=79)], lineno=189, col_offset=68, end_lineno=189, end_col_offset=80)], lineno=189, col_offset=18, end_lineno=189, end_col_offset=81), lineno=189, col_offset=12, end_lineno=189, end_col_offset=81)], lineno=187, col_offset=8, end_lineno=190, end_col_offset=9), lineno=187, col_offset=8, end_lineno=190, end_col_offset=9), Return(value=Name(id='deduped', ctx=Load(), lineno=191, col_offset=15, end_lineno=191, end_col_offset=22), lineno=191, col_offset=8, end_lineno=191, end_col_offset=22)], lineno=178, col_offset=4, end_lineno=191, end_col_offset=22)], returns=Subscript(value=Name(id='list', ctx=Load(), lineno=152, col_offset=5, end_lineno=152, end_col_offset=9), slice=Subscript(value=Name(id='tuple', ctx=Load(), lineno=152, col_offset=10, end_lineno=152, end_col_offset=15), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=152, col_offset=16, end_lineno=152, end_col_offset=19), Name(id='float', ctx=Load(), lineno=152, col_offset=21, end_lineno=152, end_col_offset=26)], ctx=Load(), lineno=152, col_offset=16, end_lineno=152, end_col_offset=26), ctx=Load(), lineno=152, col_offset=10, end_lineno=152, end_col_offset=27), ctx=Load(), lineno=152, col_offset=5, end_lineno=152, end_col_offset=28), lineno=150, col_offset=0, end_lineno=191, end_col_offset=22), FunctionDef(name='search_service', args=arguments(args=[arg(arg='results', annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=196, col_offset=13, end_lineno=196, end_col_offset=17), slice=Name(id='VectorSearchResultTypedDict', ctx=Load(), lineno=196, col_offset=18, end_lineno=196, end_col_offset=45), ctx=Load(), lineno=196, col_offset=13, end_lineno=196, end_col_offset=46), lineno=196, col_offset=4, end_lineno=196, end_col_offset=46)], kwonlyargs=[arg(arg='metrics', annotation=BinOp(left=Name(id='MetricsProvider', ctx=Load(), lineno=198, col_offset=13, end_lineno=198, end_col_offset=28), op=BitOr(), right=Constant(value=None, lineno=198, col_offset=31, end_lineno=198, end_col_offset=35), lineno=198, col_offset=13, end_lineno=198, end_col_offset=35), lineno=198, col_offset=4, end_lineno=198, end_col_offset=35)], kw_defaults=[Constant(value=None, lineno=198, col_offset=38, end_lineno=198, end_col_offset=42)]), body=[Expr(value=Constant(value='Create typed search response from results.\n\n    Wraps search results in an AgentSearchResponse envelope with metadata\n    and metrics. Includes structured logging and duration tracking.\n\n    Parameters\n    ----------\n    results : list[VectorSearchResultTypedDict]\n        List of typed search results.\n    metrics : MetricsProvider | None, optional\n        Metrics provider for recording search metrics.\n        If None, uses default provider. Defaults to None.\n\n    Returns\n    -------\n    AgentSearchResponse\n        Typed search response with results and metadata.\n\n    Raises\n    ------\n    VectorSearchError\n        Raised when result packaging or instrumentation fails. The original\n        exception is chained for diagnostics.\n    RuntimeError\n        Raised if instrumentation completes without producing a response.\n\n    Notes\n    -----\n    Exceptions raised during processing propagate after logging and metrics\n    collection complete.\n    ', lineno=200, col_offset=4, end_lineno=230, end_col_offset=7), lineno=200, col_offset=4, end_lineno=230, end_col_offset=7), Assign(targets=[Name(id='active_metrics', ctx=Store(), lineno=231, col_offset=4, end_lineno=231, end_col_offset=18)], value=BoolOp(op=Or(), values=[Name(id='metrics', ctx=Load(), lineno=231, col_offset=21, end_lineno=231, end_col_offset=28), Call(func=Attribute(value=Name(id='MetricsProvider', ctx=Load(), lineno=231, col_offset=32, end_lineno=231, end_col_offset=47), attr='default', ctx=Load(), lineno=231, col_offset=32, end_lineno=231, end_col_offset=55), lineno=231, col_offset=32, end_lineno=231, end_col_offset=57)], lineno=231, col_offset=21, end_lineno=231, end_col_offset=57), lineno=231, col_offset=4, end_lineno=231, end_col_offset=57), Assign(targets=[Name(id='start_time', ctx=Store(), lineno=232, col_offset=4, end_lineno=232, end_col_offset=14)], value=Call(func=Attribute(value=Name(id='time', ctx=Load(), lineno=232, col_offset=17, end_lineno=232, end_col_offset=21), attr='time', ctx=Load(), lineno=232, col_offset=17, end_lineno=232, end_col_offset=26), lineno=232, col_offset=17, end_lineno=232, end_col_offset=28), lineno=232, col_offset=4, end_lineno=232, end_col_offset=28), AnnAssign(target=Name(id='response', ctx=Store(), lineno=234, col_offset=4, end_lineno=234, end_col_offset=12), annotation=BinOp(left=Name(id='AgentSearchResponse', ctx=Load(), lineno=234, col_offset=14, end_lineno=234, end_col_offset=33), op=BitOr(), right=Constant(value=None, lineno=234, col_offset=36, end_lineno=234, end_col_offset=40), lineno=234, col_offset=14, end_lineno=234, end_col_offset=40), value=Constant(value=None, lineno=234, col_offset=43, end_lineno=234, end_col_offset=47), simple=1, lineno=234, col_offset=4, end_lineno=234, end_col_offset=47), With(items=[withitem(context_expr=Call(func=Name(id='with_fields', ctx=Load(), lineno=236, col_offset=8, end_lineno=236, end_col_offset=19), args=[Name(id='logger', ctx=Load(), lineno=236, col_offset=20, end_lineno=236, end_col_offset=26)], keywords=[keyword(arg='operation', value=Constant(value='search_service', lineno=236, col_offset=38, end_lineno=236, end_col_offset=54), lineno=236, col_offset=28, end_lineno=236, end_col_offset=54)], lineno=236, col_offset=8, end_lineno=236, end_col_offset=55), optional_vars=Name(id='log_adapter', ctx=Store(), lineno=236, col_offset=59, end_lineno=236, end_col_offset=70)), withitem(context_expr=Call(func=Name(id='observe_duration', ctx=Load(), lineno=237, col_offset=8, end_lineno=237, end_col_offset=24), args=[Name(id='active_metrics', ctx=Load(), lineno=237, col_offset=25, end_lineno=237, end_col_offset=39), Constant(value='search', lineno=237, col_offset=41, end_lineno=237, end_col_offset=49)], keywords=[keyword(arg='component', value=Constant(value='search_api', lineno=237, col_offset=61, end_lineno=237, end_col_offset=73), lineno=237, col_offset=51, end_lineno=237, end_col_offset=73)], lineno=237, col_offset=8, end_lineno=237, end_col_offset=74), optional_vars=Name(id='obs', ctx=Store(), lineno=237, col_offset=78, end_lineno=237, end_col_offset=81))], body=[Try(body=[Assign(targets=[Name(id='took_ms', ctx=Store(), lineno=240, col_offset=12, end_lineno=240, end_col_offset=19)], value=Call(func=Name(id='int', ctx=Load(), lineno=240, col_offset=22, end_lineno=240, end_col_offset=25), args=[BinOp(left=BinOp(left=Call(func=Attribute(value=Name(id='time', ctx=Load(), lineno=240, col_offset=27, end_lineno=240, end_col_offset=31), attr='time', ctx=Load(), lineno=240, col_offset=27, end_lineno=240, end_col_offset=36), lineno=240, col_offset=27, end_lineno=240, end_col_offset=38), op=Sub(), right=Name(id='start_time', ctx=Load(), lineno=240, col_offset=41, end_lineno=240, end_col_offset=51), lineno=240, col_offset=27, end_lineno=240, end_col_offset=51), op=Mult(), right=Constant(value=1000, lineno=240, col_offset=55, end_lineno=240, end_col_offset=59), lineno=240, col_offset=26, end_lineno=240, end_col_offset=59)], lineno=240, col_offset=22, end_lineno=240, end_col_offset=60), lineno=240, col_offset=12, end_lineno=240, end_col_offset=60), AnnAssign(target=Name(id='metadata', ctx=Store(), lineno=241, col_offset=12, end_lineno=241, end_col_offset=20), annotation=Subscript(value=Name(id='Mapping', ctx=Load(), lineno=241, col_offset=22, end_lineno=241, end_col_offset=29), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=241, col_offset=30, end_lineno=241, end_col_offset=33), Name(id='JsonValue', ctx=Load(), lineno=241, col_offset=35, end_lineno=241, end_col_offset=44)], ctx=Load(), lineno=241, col_offset=30, end_lineno=241, end_col_offset=44), ctx=Load(), lineno=241, col_offset=22, end_lineno=241, end_col_offset=45), value=Dict(keys=[Constant(value='backend', lineno=242, col_offset=16, end_lineno=242, end_col_offset=25), Constant(value='result_count', lineno=243, col_offset=16, end_lineno=243, end_col_offset=30)], values=[Constant(value='search_api', lineno=242, col_offset=27, end_lineno=242, end_col_offset=39), Call(func=Name(id='len', ctx=Load(), lineno=243, col_offset=32, end_lineno=243, end_col_offset=35), args=[Name(id='results', ctx=Load(), lineno=243, col_offset=36, end_lineno=243, end_col_offset=43)], lineno=243, col_offset=32, end_lineno=243, end_col_offset=44)], lineno=241, col_offset=48, end_lineno=244, end_col_offset=13), simple=1, lineno=241, col_offset=12, end_lineno=244, end_col_offset=13), Assign(targets=[Name(id='response', ctx=Store(), lineno=245, col_offset=12, end_lineno=245, end_col_offset=20)], value=Dict(keys=[Constant(value='results', lineno=246, col_offset=16, end_lineno=246, end_col_offset=25), Constant(value='total', lineno=247, col_offset=16, end_lineno=247, end_col_offset=23), Constant(value='took_ms', lineno=248, col_offset=16, end_lineno=248, end_col_offset=25), Constant(value='metadata', lineno=249, col_offset=16, end_lineno=249, end_col_offset=26)], values=[Name(id='results', ctx=Load(), lineno=246, col_offset=27, end_lineno=246, end_col_offset=34), Call(func=Name(id='len', ctx=Load(), lineno=247, col_offset=25, end_lineno=247, end_col_offset=28), args=[Name(id='results', ctx=Load(), lineno=247, col_offset=29, end_lineno=247, end_col_offset=36)], lineno=247, col_offset=25, end_lineno=247, end_col_offset=37), Name(id='took_ms', ctx=Load(), lineno=248, col_offset=27, end_lineno=248, end_col_offset=34), Name(id='metadata', ctx=Load(), lineno=249, col_offset=28, end_lineno=249, end_col_offset=36)], lineno=245, col_offset=23, end_lineno=250, end_col_offset=13), lineno=245, col_offset=12, end_lineno=250, end_col_offset=13), Expr(value=Call(func=Attribute(value=Name(id='log_adapter', ctx=Load(), lineno=252, col_offset=12, end_lineno=252, end_col_offset=23), attr='info', ctx=Load(), lineno=252, col_offset=12, end_lineno=252, end_col_offset=28), args=[Constant(value='Search service completed', lineno=253, col_offset=16, end_lineno=253, end_col_offset=42)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='status', lineno=255, col_offset=20, end_lineno=255, end_col_offset=28), Constant(value='result_count', lineno=256, col_offset=20, end_lineno=256, end_col_offset=34), Constant(value='took_ms', lineno=257, col_offset=20, end_lineno=257, end_col_offset=29)], values=[Constant(value='success', lineno=255, col_offset=30, end_lineno=255, end_col_offset=39), Call(func=Name(id='len', ctx=Load(), lineno=256, col_offset=36, end_lineno=256, end_col_offset=39), args=[Name(id='results', ctx=Load(), lineno=256, col_offset=40, end_lineno=256, end_col_offset=47)], lineno=256, col_offset=36, end_lineno=256, end_col_offset=48), Name(id='took_ms', ctx=Load(), lineno=257, col_offset=31, end_lineno=257, end_col_offset=38)], lineno=254, col_offset=22, end_lineno=258, end_col_offset=17), lineno=254, col_offset=16, end_lineno=258, end_col_offset=17)], lineno=252, col_offset=12, end_lineno=259, end_col_offset=13), lineno=252, col_offset=12, end_lineno=259, end_col_offset=13), Expr(value=Call(func=Attribute(value=Name(id='obs', ctx=Load(), lineno=260, col_offset=12, end_lineno=260, end_col_offset=15), attr='success', ctx=Load(), lineno=260, col_offset=12, end_lineno=260, end_col_offset=23), lineno=260, col_offset=12, end_lineno=260, end_col_offset=25), lineno=260, col_offset=12, end_lineno=260, end_col_offset=25)], handlers=[ExceptHandler(type=Name(id='Exception', ctx=Load(), lineno=261, col_offset=15, end_lineno=261, end_col_offset=24), name='error', body=[Expr(value=Call(func=Attribute(value=Name(id='log_adapter', ctx=Load(), lineno=262, col_offset=12, end_lineno=262, end_col_offset=23), attr='exception', ctx=Load(), lineno=262, col_offset=12, end_lineno=262, end_col_offset=33), args=[Constant(value='Search service failed', lineno=262, col_offset=34, end_lineno=262, end_col_offset=57)], keywords=[keyword(arg='exc_info', value=Name(id='error', ctx=Load(), lineno=262, col_offset=68, end_lineno=262, end_col_offset=73), lineno=262, col_offset=59, end_lineno=262, end_col_offset=73)], lineno=262, col_offset=12, end_lineno=262, end_col_offset=74), lineno=262, col_offset=12, end_lineno=262, end_col_offset=74), Expr(value=Call(func=Attribute(value=Name(id='obs', ctx=Load(), lineno=263, col_offset=12, end_lineno=263, end_col_offset=15), attr='error', ctx=Load(), lineno=263, col_offset=12, end_lineno=263, end_col_offset=21), lineno=263, col_offset=12, end_lineno=263, end_col_offset=23), lineno=263, col_offset=12, end_lineno=263, end_col_offset=23), Assign(targets=[Name(id='context', ctx=Store(), lineno=264, col_offset=12, end_lineno=264, end_col_offset=19)], value=Dict(keys=[Constant(value='result_count', lineno=264, col_offset=23, end_lineno=264, end_col_offset=37)], values=[Call(func=Name(id='len', ctx=Load(), lineno=264, col_offset=39, end_lineno=264, end_col_offset=42), args=[Name(id='results', ctx=Load(), lineno=264, col_offset=43, end_lineno=264, end_col_offset=50)], lineno=264, col_offset=39, end_lineno=264, end_col_offset=51)], lineno=264, col_offset=22, end_lineno=264, end_col_offset=52), lineno=264, col_offset=12, end_lineno=264, end_col_offset=52), Assign(targets=[Name(id='message', ctx=Store(), lineno=265, col_offset=12, end_lineno=265, end_col_offset=19)], value=Constant(value='Search service failed to package results', lineno=265, col_offset=22, end_lineno=265, end_col_offset=64), lineno=265, col_offset=12, end_lineno=265, end_col_offset=64), Raise(exc=Call(func=Name(id='VectorSearchError', ctx=Load(), lineno=266, col_offset=18, end_lineno=266, end_col_offset=35), args=[Name(id='message', ctx=Load(), lineno=266, col_offset=36, end_lineno=266, end_col_offset=43)], keywords=[keyword(arg='cause', value=Name(id='error', ctx=Load(), lineno=266, col_offset=51, end_lineno=266, end_col_offset=56), lineno=266, col_offset=45, end_lineno=266, end_col_offset=56), keyword(arg='context', value=Name(id='context', ctx=Load(), lineno=266, col_offset=66, end_lineno=266, end_col_offset=73), lineno=266, col_offset=58, end_lineno=266, end_col_offset=73)], lineno=266, col_offset=18, end_lineno=266, end_col_offset=74), cause=Name(id='error', ctx=Load(), lineno=266, col_offset=80, end_lineno=266, end_col_offset=85), lineno=266, col_offset=12, end_lineno=266, end_col_offset=85)], lineno=261, col_offset=8, end_lineno=266, end_col_offset=85)], lineno=239, col_offset=8, end_lineno=266, end_col_offset=85)], lineno=235, col_offset=4, end_lineno=266, end_col_offset=85), If(test=Compare(left=Name(id='response', ctx=Load(), lineno=267, col_offset=7, end_lineno=267, end_col_offset=15), ops=[Is()], comparators=[Constant(value=None, lineno=267, col_offset=19, end_lineno=267, end_col_offset=23)], lineno=267, col_offset=7, end_lineno=267, end_col_offset=23), body=[Assign(targets=[Name(id='message', ctx=Store(), lineno=268, col_offset=8, end_lineno=268, end_col_offset=15)], value=Constant(value='Search service failed to produce a response', lineno=268, col_offset=18, end_lineno=268, end_col_offset=63), lineno=268, col_offset=8, end_lineno=268, end_col_offset=63), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=269, col_offset=14, end_lineno=269, end_col_offset=26), args=[Name(id='message', ctx=Load(), lineno=269, col_offset=27, end_lineno=269, end_col_offset=34)], lineno=269, col_offset=14, end_lineno=269, end_col_offset=35), lineno=269, col_offset=8, end_lineno=269, end_col_offset=35)], lineno=267, col_offset=4, end_lineno=269, end_col_offset=35), Return(value=Name(id='response', ctx=Load(), lineno=270, col_offset=11, end_lineno=270, end_col_offset=19), lineno=270, col_offset=4, end_lineno=270, end_col_offset=19)], returns=Name(id='AgentSearchResponse', ctx=Load(), lineno=199, col_offset=5, end_lineno=199, end_col_offset=24), lineno=195, col_offset=0, end_lineno=270, end_col_offset=19)])