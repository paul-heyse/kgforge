Module(body=[ImportFrom(module='__future__', names=[alias(name='annotations', lineno=1, col_offset=23, end_lineno=1, end_col_offset=34)], level=0, lineno=1, col_offset=0, end_lineno=1, end_col_offset=34), Import(names=[alias(name='time', lineno=3, col_offset=7, end_lineno=3, end_col_offset=11)], lineno=3, col_offset=0, end_lineno=3, end_col_offset=11), Import(names=[alias(name='pytest', lineno=5, col_offset=7, end_lineno=5, end_col_offset=13)], lineno=5, col_offset=0, end_lineno=5, end_col_offset=13), ImportFrom(module='codeintel_rev.retrieval.telemetry', names=[alias(name='StageTiming', lineno=7, col_offset=4, end_lineno=7, end_col_offset=15), alias(name='record_stage_decision', lineno=8, col_offset=4, end_lineno=8, end_col_offset=25), alias(name='track_stage', lineno=9, col_offset=4, end_lineno=9, end_col_offset=15)], level=0, lineno=6, col_offset=0, end_lineno=10, end_col_offset=1), ImportFrom(module='codeintel_rev.retrieval.types', names=[alias(name='StageDecision', lineno=11, col_offset=42, end_lineno=11, end_col_offset=55)], level=0, lineno=11, col_offset=0, end_lineno=11, end_col_offset=55), ImportFrom(module='prometheus_client', names=[alias(name='CollectorRegistry', lineno=12, col_offset=30, end_lineno=12, end_col_offset=47)], level=0, lineno=12, col_offset=0, end_lineno=12, end_col_offset=47), ImportFrom(module='kgfoundry_common.prometheus', names=[alias(name='build_counter', lineno=14, col_offset=40, end_lineno=14, end_col_offset=53)], level=0, lineno=14, col_offset=0, end_lineno=14, end_col_offset=53), FunctionDef(name='test_track_stage_records_duration_and_budget_flag', args=arguments(), body=[With(items=[withitem(context_expr=Call(func=Name(id='track_stage', ctx=Load(), lineno=18, col_offset=9, end_lineno=18, end_col_offset=20), args=[Constant(value='stage', lineno=18, col_offset=21, end_lineno=18, end_col_offset=28)], keywords=[keyword(arg='budget_ms', value=Constant(value=1, lineno=18, col_offset=40, end_lineno=18, end_col_offset=41), lineno=18, col_offset=30, end_lineno=18, end_col_offset=41)], lineno=18, col_offset=9, end_lineno=18, end_col_offset=42), optional_vars=Name(id='timer', ctx=Store(), lineno=18, col_offset=46, end_lineno=18, end_col_offset=51))], body=[Expr(value=Call(func=Attribute(value=Name(id='time', ctx=Load(), lineno=19, col_offset=8, end_lineno=19, end_col_offset=12), attr='sleep', ctx=Load(), lineno=19, col_offset=8, end_lineno=19, end_col_offset=18), args=[Constant(value=0.002, lineno=19, col_offset=19, end_lineno=19, end_col_offset=24)], lineno=19, col_offset=8, end_lineno=19, end_col_offset=25), lineno=19, col_offset=8, end_lineno=19, end_col_offset=25)], lineno=18, col_offset=4, end_lineno=19, end_col_offset=25), Assign(targets=[Name(id='snapshot', ctx=Store(), lineno=20, col_offset=4, end_lineno=20, end_col_offset=12)], value=Call(func=Attribute(value=Name(id='timer', ctx=Load(), lineno=20, col_offset=15, end_lineno=20, end_col_offset=20), attr='snapshot', ctx=Load(), lineno=20, col_offset=15, end_lineno=20, end_col_offset=29), lineno=20, col_offset=15, end_lineno=20, end_col_offset=31), lineno=20, col_offset=4, end_lineno=20, end_col_offset=31), Assert(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=21, col_offset=11, end_lineno=21, end_col_offset=21), args=[Name(id='snapshot', ctx=Load(), lineno=21, col_offset=22, end_lineno=21, end_col_offset=30), Name(id='StageTiming', ctx=Load(), lineno=21, col_offset=32, end_lineno=21, end_col_offset=43)], lineno=21, col_offset=11, end_lineno=21, end_col_offset=44), lineno=21, col_offset=4, end_lineno=21, end_col_offset=44), Assert(test=Compare(left=Attribute(value=Name(id='snapshot', ctx=Load(), lineno=22, col_offset=11, end_lineno=22, end_col_offset=19), attr='name', ctx=Load(), lineno=22, col_offset=11, end_lineno=22, end_col_offset=24), ops=[Eq()], comparators=[Constant(value='stage', lineno=22, col_offset=28, end_lineno=22, end_col_offset=35)], lineno=22, col_offset=11, end_lineno=22, end_col_offset=35), lineno=22, col_offset=4, end_lineno=22, end_col_offset=35), Assert(test=Compare(left=Attribute(value=Name(id='snapshot', ctx=Load(), lineno=23, col_offset=11, end_lineno=23, end_col_offset=19), attr='duration_ms', ctx=Load(), lineno=23, col_offset=11, end_lineno=23, end_col_offset=31), ops=[Gt()], comparators=[Constant(value=0, lineno=23, col_offset=34, end_lineno=23, end_col_offset=35)], lineno=23, col_offset=11, end_lineno=23, end_col_offset=35), lineno=23, col_offset=4, end_lineno=23, end_col_offset=35), Assert(test=Attribute(value=Name(id='snapshot', ctx=Load(), lineno=24, col_offset=11, end_lineno=24, end_col_offset=19), attr='exceeded_budget', ctx=Load(), lineno=24, col_offset=11, end_lineno=24, end_col_offset=35), lineno=24, col_offset=4, end_lineno=24, end_col_offset=35), Assign(targets=[Name(id='payload', ctx=Store(), lineno=25, col_offset=4, end_lineno=25, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='snapshot', ctx=Load(), lineno=25, col_offset=14, end_lineno=25, end_col_offset=22), attr='as_payload', ctx=Load(), lineno=25, col_offset=14, end_lineno=25, end_col_offset=33), lineno=25, col_offset=14, end_lineno=25, end_col_offset=35), lineno=25, col_offset=4, end_lineno=25, end_col_offset=35), Assert(test=Compare(left=Subscript(value=Name(id='payload', ctx=Load(), lineno=26, col_offset=11, end_lineno=26, end_col_offset=18), slice=Constant(value='name', lineno=26, col_offset=19, end_lineno=26, end_col_offset=25), ctx=Load(), lineno=26, col_offset=11, end_lineno=26, end_col_offset=26), ops=[Eq()], comparators=[Constant(value='stage', lineno=26, col_offset=30, end_lineno=26, end_col_offset=37)], lineno=26, col_offset=11, end_lineno=26, end_col_offset=37), lineno=26, col_offset=4, end_lineno=26, end_col_offset=37)], returns=Constant(value=None, lineno=17, col_offset=59, end_lineno=17, end_col_offset=63), lineno=17, col_offset=0, end_lineno=26, end_col_offset=37), FunctionDef(name='test_record_stage_decision_emits_counter', args=arguments(args=[arg(arg='monkeypatch', annotation=Attribute(value=Name(id='pytest', ctx=Load(), lineno=29, col_offset=58, end_lineno=29, end_col_offset=64), attr='MonkeyPatch', ctx=Load(), lineno=29, col_offset=58, end_lineno=29, end_col_offset=76), lineno=29, col_offset=45, end_lineno=29, end_col_offset=76)]), body=[Assign(targets=[Name(id='registry', ctx=Store(), lineno=30, col_offset=4, end_lineno=30, end_col_offset=12)], value=Call(func=Name(id='CollectorRegistry', ctx=Load(), lineno=30, col_offset=15, end_lineno=30, end_col_offset=32), lineno=30, col_offset=15, end_lineno=30, end_col_offset=34), lineno=30, col_offset=4, end_lineno=30, end_col_offset=34), Assign(targets=[Name(id='counter', ctx=Store(), lineno=31, col_offset=4, end_lineno=31, end_col_offset=11)], value=Call(func=Name(id='build_counter', ctx=Load(), lineno=31, col_offset=14, end_lineno=31, end_col_offset=27), args=[Constant(value='kgfoundry_stage_decisions_total', lineno=32, col_offset=8, end_lineno=32, end_col_offset=41), Constant(value='Stage gating outcomes grouped by component, stage, and decision type.', lineno=33, col_offset=8, end_lineno=33, end_col_offset=79), Tuple(elts=[Constant(value='component', lineno=34, col_offset=9, end_lineno=34, end_col_offset=20), Constant(value='stage', lineno=34, col_offset=22, end_lineno=34, end_col_offset=29), Constant(value='decision', lineno=34, col_offset=31, end_lineno=34, end_col_offset=41)], ctx=Load(), lineno=34, col_offset=8, end_lineno=34, end_col_offset=42)], keywords=[keyword(arg='registry', value=Name(id='registry', ctx=Load(), lineno=35, col_offset=17, end_lineno=35, end_col_offset=25), lineno=35, col_offset=8, end_lineno=35, end_col_offset=25)], lineno=31, col_offset=14, end_lineno=36, end_col_offset=5), lineno=31, col_offset=4, end_lineno=36, end_col_offset=5), ImportFrom(module='codeintel_rev.retrieval', names=[alias(name='telemetry', asname='telemetry_module', lineno=37, col_offset=40, end_lineno=37, end_col_offset=69)], level=0, lineno=37, col_offset=4, end_lineno=37, end_col_offset=69), Expr(value=Call(func=Attribute(value=Name(id='monkeypatch', ctx=Load(), lineno=39, col_offset=4, end_lineno=39, end_col_offset=15), attr='setattr', ctx=Load(), lineno=39, col_offset=4, end_lineno=39, end_col_offset=23), args=[Name(id='telemetry_module', ctx=Load(), lineno=40, col_offset=8, end_lineno=40, end_col_offset=24), Constant(value='_STAGE_DECISION_COUNTER', lineno=41, col_offset=8, end_lineno=41, end_col_offset=33), Name(id='counter', ctx=Load(), lineno=42, col_offset=8, end_lineno=42, end_col_offset=15)], keywords=[keyword(arg='raising', value=Constant(value=False, lineno=43, col_offset=16, end_lineno=43, end_col_offset=21), lineno=43, col_offset=8, end_lineno=43, end_col_offset=21)], lineno=39, col_offset=4, end_lineno=44, end_col_offset=5), lineno=39, col_offset=4, end_lineno=44, end_col_offset=5), Expr(value=Call(func=Name(id='record_stage_decision', ctx=Load(), lineno=46, col_offset=4, end_lineno=46, end_col_offset=25), args=[Constant(value='component', lineno=47, col_offset=8, end_lineno=47, end_col_offset=19), Constant(value='stage', lineno=48, col_offset=8, end_lineno=48, end_col_offset=15)], keywords=[keyword(arg='decision', value=Call(func=Name(id='StageDecision', ctx=Load(), lineno=49, col_offset=17, end_lineno=49, end_col_offset=30), keywords=[keyword(arg='should_run', value=Constant(value=False, lineno=49, col_offset=42, end_lineno=49, end_col_offset=47), lineno=49, col_offset=31, end_lineno=49, end_col_offset=47), keyword(arg='reason', value=Constant(value='disabled', lineno=49, col_offset=56, end_lineno=49, end_col_offset=66), lineno=49, col_offset=49, end_lineno=49, end_col_offset=66)], lineno=49, col_offset=17, end_lineno=49, end_col_offset=67), lineno=49, col_offset=8, end_lineno=49, end_col_offset=67)], lineno=46, col_offset=4, end_lineno=50, end_col_offset=5), lineno=46, col_offset=4, end_lineno=50, end_col_offset=5), Assign(targets=[Name(id='value', ctx=Store(), lineno=51, col_offset=4, end_lineno=51, end_col_offset=9)], value=Call(func=Attribute(value=Name(id='registry', ctx=Load(), lineno=51, col_offset=12, end_lineno=51, end_col_offset=20), attr='get_sample_value', ctx=Load(), lineno=51, col_offset=12, end_lineno=51, end_col_offset=37), args=[Constant(value='kgfoundry_stage_decisions_total', lineno=52, col_offset=8, end_lineno=52, end_col_offset=41), Dict(keys=[Constant(value='component', lineno=53, col_offset=9, end_lineno=53, end_col_offset=20), Constant(value='stage', lineno=53, col_offset=35, end_lineno=53, end_col_offset=42), Constant(value='decision', lineno=53, col_offset=53, end_lineno=53, end_col_offset=63)], values=[Constant(value='component', lineno=53, col_offset=22, end_lineno=53, end_col_offset=33), Constant(value='stage', lineno=53, col_offset=44, end_lineno=53, end_col_offset=51), Constant(value='skip:disabled', lineno=53, col_offset=65, end_lineno=53, end_col_offset=80)], lineno=53, col_offset=8, end_lineno=53, end_col_offset=81)], lineno=51, col_offset=12, end_lineno=54, end_col_offset=5), lineno=51, col_offset=4, end_lineno=54, end_col_offset=5), Assert(test=Compare(left=Name(id='value', ctx=Load(), lineno=55, col_offset=11, end_lineno=55, end_col_offset=16), ops=[Eq()], comparators=[Call(func=Attribute(value=Name(id='pytest', ctx=Load(), lineno=55, col_offset=20, end_lineno=55, end_col_offset=26), attr='approx', ctx=Load(), lineno=55, col_offset=20, end_lineno=55, end_col_offset=33), args=[Constant(value=1.0, lineno=55, col_offset=34, end_lineno=55, end_col_offset=37)], lineno=55, col_offset=20, end_lineno=55, end_col_offset=38)], lineno=55, col_offset=11, end_lineno=55, end_col_offset=38), lineno=55, col_offset=4, end_lineno=55, end_col_offset=38)], returns=Constant(value=None, lineno=29, col_offset=81, end_lineno=29, end_col_offset=85), lineno=29, col_offset=0, end_lineno=55, end_col_offset=38)])