Module(body=[Expr(value=Constant(value='Adaptive gating helpers for multi-stage retrieval pipelines.', lineno=1, col_offset=0, end_lineno=1, end_col_offset=66), lineno=1, col_offset=0, end_lineno=1, end_col_offset=66), ImportFrom(module='__future__', names=[alias(name='annotations', lineno=3, col_offset=23, end_lineno=3, end_col_offset=34)], level=0, lineno=3, col_offset=0, end_lineno=3, end_col_offset=34), ImportFrom(module='dataclasses', names=[alias(name='dataclass', lineno=5, col_offset=24, end_lineno=5, end_col_offset=33)], level=0, lineno=5, col_offset=0, end_lineno=5, end_col_offset=33), ImportFrom(module='codeintel_rev.retrieval.types', names=[alias(name='StageDecision', lineno=7, col_offset=42, end_lineno=7, end_col_offset=55), alias(name='StageSignals', lineno=7, col_offset=57, end_lineno=7, end_col_offset=69)], level=0, lineno=7, col_offset=0, end_lineno=7, end_col_offset=69), ClassDef(name='StageGateConfig', body=[Expr(value=Constant(value='Configuration inputs for deciding whether to invoke a follow-up stage.', lineno=12, col_offset=4, end_lineno=12, end_col_offset=80), lineno=12, col_offset=4, end_lineno=12, end_col_offset=80), AnnAssign(target=Name(id='min_candidates', ctx=Store(), lineno=14, col_offset=4, end_lineno=14, end_col_offset=18), annotation=Name(id='int', ctx=Load(), lineno=14, col_offset=20, end_lineno=14, end_col_offset=23), value=Constant(value=40, lineno=14, col_offset=26, end_lineno=14, end_col_offset=28), simple=1, lineno=14, col_offset=4, end_lineno=14, end_col_offset=28), AnnAssign(target=Name(id='margin_threshold', ctx=Store(), lineno=15, col_offset=4, end_lineno=15, end_col_offset=20), annotation=Name(id='float', ctx=Load(), lineno=15, col_offset=22, end_lineno=15, end_col_offset=27), value=Constant(value=0.1, lineno=15, col_offset=30, end_lineno=15, end_col_offset=33), simple=1, lineno=15, col_offset=4, end_lineno=15, end_col_offset=33), AnnAssign(target=Name(id='budget_ms', ctx=Store(), lineno=16, col_offset=4, end_lineno=16, end_col_offset=13), annotation=Name(id='int', ctx=Load(), lineno=16, col_offset=15, end_lineno=16, end_col_offset=18), value=Constant(value=150, lineno=16, col_offset=21, end_lineno=16, end_col_offset=24), simple=1, lineno=16, col_offset=4, end_lineno=16, end_col_offset=24)], decorator_list=[Call(func=Name(id='dataclass', ctx=Load(), lineno=10, col_offset=1, end_lineno=10, end_col_offset=10), keywords=[keyword(arg='slots', value=Constant(value=True, lineno=10, col_offset=17, end_lineno=10, end_col_offset=21), lineno=10, col_offset=11, end_lineno=10, end_col_offset=21), keyword(arg='frozen', value=Constant(value=True, lineno=10, col_offset=30, end_lineno=10, end_col_offset=34), lineno=10, col_offset=23, end_lineno=10, end_col_offset=34)], lineno=10, col_offset=1, end_lineno=10, end_col_offset=35)], lineno=11, col_offset=0, end_lineno=16, end_col_offset=24), FunctionDef(name='should_run_secondary_stage', args=arguments(args=[arg(arg='signals', annotation=Name(id='StageSignals', ctx=Load(), lineno=20, col_offset=13, end_lineno=20, end_col_offset=25), lineno=20, col_offset=4, end_lineno=20, end_col_offset=25), arg(arg='config', annotation=Name(id='StageGateConfig', ctx=Load(), lineno=21, col_offset=12, end_lineno=21, end_col_offset=27), lineno=21, col_offset=4, end_lineno=21, end_col_offset=27)]), body=[Expr(value=Constant(value='Return a gating decision for a downstream stage based on upstream signals.\n\n    Extended Summary\n    ----------------\n    This function implements adaptive gating logic for multi-stage retrieval pipelines,\n    deciding whether to run expensive secondary stages (e.g., reranking, late interaction)\n    based on upstream performance signals. It evaluates candidate count, elapsed time budget,\n    and score margin to determine if the secondary stage would provide sufficient value.\n    This prevents unnecessary computation when upstream results are already high-quality or\n    when time budgets are exceeded, improving overall pipeline efficiency.\n\n    Parameters\n    ----------\n    signals : StageSignals\n        Performance signals from the upstream stage, including candidate count, elapsed\n        time, and score distribution. Used to assess whether secondary stage is warranted.\n    config : StageGateConfig\n        Gating configuration specifying thresholds for candidate count, margin, and time\n        budget. Defines the decision criteria for running the secondary stage.\n\n    Returns\n    -------\n    StageDecision\n        Decision object describing whether the stage should run and why. Contains\n        should_run boolean, reason string, and optional notes explaining the decision.\n        Reasons include: "no_candidates", "insufficient_candidates", "upstream_budget_exceeded",\n        "high_margin", "within_budget".\n\n    Notes\n    -----\n    Time complexity O(1) for decision logic. Space complexity O(1) aside from the\n    StageDecision object. The function performs no I/O and has no side effects.\n    Thread-safe as it operates on input data only. Decision logic prioritizes:\n    1. Candidate availability (must have candidates)\n    2. Time budget (must not exceed budget)\n    3. Score margin (high margin suggests good results already)\n    ', lineno=23, col_offset=4, end_lineno=59, end_col_offset=7), lineno=23, col_offset=4, end_lineno=59, end_col_offset=7), AnnAssign(target=Name(id='notes', ctx=Store(), lineno=60, col_offset=4, end_lineno=60, end_col_offset=9), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=60, col_offset=11, end_lineno=60, end_col_offset=15), slice=Name(id='str', ctx=Load(), lineno=60, col_offset=16, end_lineno=60, end_col_offset=19), ctx=Load(), lineno=60, col_offset=11, end_lineno=60, end_col_offset=20), value=List(ctx=Load(), lineno=60, col_offset=23, end_lineno=60, end_col_offset=25), simple=1, lineno=60, col_offset=4, end_lineno=60, end_col_offset=25), If(test=Compare(left=Attribute(value=Name(id='signals', ctx=Load(), lineno=61, col_offset=7, end_lineno=61, end_col_offset=14), attr='candidate_count', ctx=Load(), lineno=61, col_offset=7, end_lineno=61, end_col_offset=30), ops=[LtE()], comparators=[Constant(value=0, lineno=61, col_offset=34, end_lineno=61, end_col_offset=35)], lineno=61, col_offset=7, end_lineno=61, end_col_offset=35), body=[Return(value=Call(func=Name(id='StageDecision', ctx=Load(), lineno=62, col_offset=15, end_lineno=62, end_col_offset=28), keywords=[keyword(arg='should_run', value=Constant(value=False, lineno=62, col_offset=40, end_lineno=62, end_col_offset=45), lineno=62, col_offset=29, end_lineno=62, end_col_offset=45), keyword(arg='reason', value=Constant(value='no_candidates', lineno=62, col_offset=54, end_lineno=62, end_col_offset=69), lineno=62, col_offset=47, end_lineno=62, end_col_offset=69)], lineno=62, col_offset=15, end_lineno=62, end_col_offset=70), lineno=62, col_offset=8, end_lineno=62, end_col_offset=70)], lineno=61, col_offset=4, end_lineno=62, end_col_offset=70), If(test=Compare(left=Attribute(value=Name(id='signals', ctx=Load(), lineno=63, col_offset=7, end_lineno=63, end_col_offset=14), attr='candidate_count', ctx=Load(), lineno=63, col_offset=7, end_lineno=63, end_col_offset=30), ops=[Lt()], comparators=[Attribute(value=Name(id='config', ctx=Load(), lineno=63, col_offset=33, end_lineno=63, end_col_offset=39), attr='min_candidates', ctx=Load(), lineno=63, col_offset=33, end_lineno=63, end_col_offset=54)], lineno=63, col_offset=7, end_lineno=63, end_col_offset=54), body=[Expr(value=Call(func=Attribute(value=Name(id='notes', ctx=Load(), lineno=64, col_offset=8, end_lineno=64, end_col_offset=13), attr='append', ctx=Load(), lineno=64, col_offset=8, end_lineno=64, end_col_offset=20), args=[JoinedStr(values=[FormattedValue(value=Attribute(value=Name(id='signals', ctx=Load(), lineno=64, col_offset=24, end_lineno=64, end_col_offset=31), attr='candidate_count', ctx=Load(), lineno=64, col_offset=24, end_lineno=64, end_col_offset=47), conversion=-1, lineno=64, col_offset=23, end_lineno=64, end_col_offset=48), Constant(value='/', lineno=64, col_offset=48, end_lineno=64, end_col_offset=49), FormattedValue(value=Attribute(value=Name(id='config', ctx=Load(), lineno=64, col_offset=50, end_lineno=64, end_col_offset=56), attr='min_candidates', ctx=Load(), lineno=64, col_offset=50, end_lineno=64, end_col_offset=71), conversion=-1, lineno=64, col_offset=49, end_lineno=64, end_col_offset=72), Constant(value=' candidates available', lineno=64, col_offset=72, end_lineno=64, end_col_offset=93)], lineno=64, col_offset=21, end_lineno=64, end_col_offset=94)], lineno=64, col_offset=8, end_lineno=64, end_col_offset=95), lineno=64, col_offset=8, end_lineno=64, end_col_offset=95), Return(value=Call(func=Name(id='StageDecision', ctx=Load(), lineno=65, col_offset=15, end_lineno=65, end_col_offset=28), keywords=[keyword(arg='should_run', value=Constant(value=False, lineno=65, col_offset=40, end_lineno=65, end_col_offset=45), lineno=65, col_offset=29, end_lineno=65, end_col_offset=45), keyword(arg='reason', value=Constant(value='insufficient_candidates', lineno=65, col_offset=54, end_lineno=65, end_col_offset=79), lineno=65, col_offset=47, end_lineno=65, end_col_offset=79), keyword(arg='notes', value=Call(func=Name(id='tuple', ctx=Load(), lineno=65, col_offset=87, end_lineno=65, end_col_offset=92), args=[Name(id='notes', ctx=Load(), lineno=65, col_offset=93, end_lineno=65, end_col_offset=98)], lineno=65, col_offset=87, end_lineno=65, end_col_offset=99), lineno=65, col_offset=81, end_lineno=65, end_col_offset=99)], lineno=65, col_offset=15, end_lineno=65, end_col_offset=100), lineno=65, col_offset=8, end_lineno=65, end_col_offset=100)], lineno=63, col_offset=4, end_lineno=65, end_col_offset=100), If(test=Compare(left=Attribute(value=Name(id='signals', ctx=Load(), lineno=67, col_offset=7, end_lineno=67, end_col_offset=14), attr='elapsed_ms', ctx=Load(), lineno=67, col_offset=7, end_lineno=67, end_col_offset=25), ops=[Gt()], comparators=[Attribute(value=Name(id='config', ctx=Load(), lineno=67, col_offset=28, end_lineno=67, end_col_offset=34), attr='budget_ms', ctx=Load(), lineno=67, col_offset=28, end_lineno=67, end_col_offset=44)], lineno=67, col_offset=7, end_lineno=67, end_col_offset=44), body=[Expr(value=Call(func=Attribute(value=Name(id='notes', ctx=Load(), lineno=68, col_offset=8, end_lineno=68, end_col_offset=13), attr='append', ctx=Load(), lineno=68, col_offset=8, end_lineno=68, end_col_offset=20), args=[JoinedStr(values=[Constant(value='stage elapsed ', lineno=68, col_offset=23, end_lineno=68, end_col_offset=37), FormattedValue(value=Attribute(value=Name(id='signals', ctx=Load(), lineno=68, col_offset=38, end_lineno=68, end_col_offset=45), attr='elapsed_ms', ctx=Load(), lineno=68, col_offset=38, end_lineno=68, end_col_offset=56), conversion=-1, format_spec=JoinedStr(values=[Constant(value='.1f', lineno=68, col_offset=57, end_lineno=68, end_col_offset=60)], lineno=68, col_offset=56, end_lineno=68, end_col_offset=60), lineno=68, col_offset=37, end_lineno=68, end_col_offset=61), Constant(value='ms > budget ', lineno=68, col_offset=61, end_lineno=68, end_col_offset=73), FormattedValue(value=Attribute(value=Name(id='config', ctx=Load(), lineno=68, col_offset=74, end_lineno=68, end_col_offset=80), attr='budget_ms', ctx=Load(), lineno=68, col_offset=74, end_lineno=68, end_col_offset=90), conversion=-1, lineno=68, col_offset=73, end_lineno=68, end_col_offset=91), Constant(value='ms', lineno=68, col_offset=91, end_lineno=68, end_col_offset=93)], lineno=68, col_offset=21, end_lineno=68, end_col_offset=94)], lineno=68, col_offset=8, end_lineno=68, end_col_offset=95), lineno=68, col_offset=8, end_lineno=68, end_col_offset=95), Return(value=Call(func=Name(id='StageDecision', ctx=Load(), lineno=69, col_offset=15, end_lineno=69, end_col_offset=28), keywords=[keyword(arg='should_run', value=Constant(value=False, lineno=70, col_offset=23, end_lineno=70, end_col_offset=28), lineno=70, col_offset=12, end_lineno=70, end_col_offset=28), keyword(arg='reason', value=Constant(value='upstream_budget_exceeded', lineno=70, col_offset=37, end_lineno=70, end_col_offset=63), lineno=70, col_offset=30, end_lineno=70, end_col_offset=63), keyword(arg='notes', value=Call(func=Name(id='tuple', ctx=Load(), lineno=70, col_offset=71, end_lineno=70, end_col_offset=76), args=[Name(id='notes', ctx=Load(), lineno=70, col_offset=77, end_lineno=70, end_col_offset=82)], lineno=70, col_offset=71, end_lineno=70, end_col_offset=83), lineno=70, col_offset=65, end_lineno=70, end_col_offset=83)], lineno=69, col_offset=15, end_lineno=71, end_col_offset=9), lineno=69, col_offset=8, end_lineno=71, end_col_offset=9)], lineno=67, col_offset=4, end_lineno=71, end_col_offset=9), Assign(targets=[Name(id='margin', ctx=Store(), lineno=73, col_offset=4, end_lineno=73, end_col_offset=10)], value=Call(func=Attribute(value=Name(id='signals', ctx=Load(), lineno=73, col_offset=13, end_lineno=73, end_col_offset=20), attr='margin', ctx=Load(), lineno=73, col_offset=13, end_lineno=73, end_col_offset=27), lineno=73, col_offset=13, end_lineno=73, end_col_offset=29), lineno=73, col_offset=4, end_lineno=73, end_col_offset=29), If(test=BoolOp(op=And(), values=[Compare(left=Name(id='margin', ctx=Load(), lineno=74, col_offset=7, end_lineno=74, end_col_offset=13), ops=[IsNot()], comparators=[Constant(value=None, lineno=74, col_offset=21, end_lineno=74, end_col_offset=25)], lineno=74, col_offset=7, end_lineno=74, end_col_offset=25), Compare(left=Name(id='margin', ctx=Load(), lineno=74, col_offset=30, end_lineno=74, end_col_offset=36), ops=[GtE(), Gt()], comparators=[Attribute(value=Name(id='config', ctx=Load(), lineno=74, col_offset=40, end_lineno=74, end_col_offset=46), attr='margin_threshold', ctx=Load(), lineno=74, col_offset=40, end_lineno=74, end_col_offset=63), Constant(value=0, lineno=74, col_offset=66, end_lineno=74, end_col_offset=67)], lineno=74, col_offset=30, end_lineno=74, end_col_offset=67)], lineno=74, col_offset=7, end_lineno=74, end_col_offset=67), body=[Expr(value=Call(func=Attribute(value=Name(id='notes', ctx=Load(), lineno=75, col_offset=8, end_lineno=75, end_col_offset=13), attr='append', ctx=Load(), lineno=75, col_offset=8, end_lineno=75, end_col_offset=20), args=[JoinedStr(values=[Constant(value='margin ', lineno=75, col_offset=23, end_lineno=75, end_col_offset=30), FormattedValue(value=Name(id='margin', ctx=Load(), lineno=75, col_offset=31, end_lineno=75, end_col_offset=37), conversion=-1, format_spec=JoinedStr(values=[Constant(value='.4f', lineno=75, col_offset=38, end_lineno=75, end_col_offset=41)], lineno=75, col_offset=37, end_lineno=75, end_col_offset=41), lineno=75, col_offset=30, end_lineno=75, end_col_offset=42), Constant(value=' >= threshold ', lineno=75, col_offset=42, end_lineno=75, end_col_offset=56), FormattedValue(value=Attribute(value=Name(id='config', ctx=Load(), lineno=75, col_offset=57, end_lineno=75, end_col_offset=63), attr='margin_threshold', ctx=Load(), lineno=75, col_offset=57, end_lineno=75, end_col_offset=80), conversion=-1, format_spec=JoinedStr(values=[Constant(value='.4f', lineno=75, col_offset=81, end_lineno=75, end_col_offset=84)], lineno=75, col_offset=80, end_lineno=75, end_col_offset=84), lineno=75, col_offset=56, end_lineno=75, end_col_offset=85)], lineno=75, col_offset=21, end_lineno=75, end_col_offset=86)], lineno=75, col_offset=8, end_lineno=75, end_col_offset=87), lineno=75, col_offset=8, end_lineno=75, end_col_offset=87), Return(value=Call(func=Name(id='StageDecision', ctx=Load(), lineno=76, col_offset=15, end_lineno=76, end_col_offset=28), keywords=[keyword(arg='should_run', value=Constant(value=False, lineno=76, col_offset=40, end_lineno=76, end_col_offset=45), lineno=76, col_offset=29, end_lineno=76, end_col_offset=45), keyword(arg='reason', value=Constant(value='high_margin', lineno=76, col_offset=54, end_lineno=76, end_col_offset=67), lineno=76, col_offset=47, end_lineno=76, end_col_offset=67), keyword(arg='notes', value=Call(func=Name(id='tuple', ctx=Load(), lineno=76, col_offset=75, end_lineno=76, end_col_offset=80), args=[Name(id='notes', ctx=Load(), lineno=76, col_offset=81, end_lineno=76, end_col_offset=86)], lineno=76, col_offset=75, end_lineno=76, end_col_offset=87), lineno=76, col_offset=69, end_lineno=76, end_col_offset=87)], lineno=76, col_offset=15, end_lineno=76, end_col_offset=88), lineno=76, col_offset=8, end_lineno=76, end_col_offset=88)], lineno=74, col_offset=4, end_lineno=76, end_col_offset=88), Return(value=Call(func=Name(id='StageDecision', ctx=Load(), lineno=78, col_offset=11, end_lineno=78, end_col_offset=24), keywords=[keyword(arg='should_run', value=Constant(value=True, lineno=78, col_offset=36, end_lineno=78, end_col_offset=40), lineno=78, col_offset=25, end_lineno=78, end_col_offset=40), keyword(arg='reason', value=Constant(value='within_budget', lineno=78, col_offset=49, end_lineno=78, end_col_offset=64), lineno=78, col_offset=42, end_lineno=78, end_col_offset=64), keyword(arg='notes', value=Call(func=Name(id='tuple', ctx=Load(), lineno=78, col_offset=72, end_lineno=78, end_col_offset=77), args=[Name(id='notes', ctx=Load(), lineno=78, col_offset=78, end_lineno=78, end_col_offset=83)], lineno=78, col_offset=72, end_lineno=78, end_col_offset=84), lineno=78, col_offset=66, end_lineno=78, end_col_offset=84)], lineno=78, col_offset=11, end_lineno=78, end_col_offset=85), lineno=78, col_offset=4, end_lineno=78, end_col_offset=85)], returns=Name(id='StageDecision', ctx=Load(), lineno=22, col_offset=5, end_lineno=22, end_col_offset=18), lineno=19, col_offset=0, end_lineno=78, end_col_offset=85), Assign(targets=[Name(id='__all__', ctx=Store(), lineno=81, col_offset=0, end_lineno=81, end_col_offset=7)], value=List(elts=[Constant(value='StageGateConfig', lineno=81, col_offset=11, end_lineno=81, end_col_offset=28), Constant(value='should_run_secondary_stage', lineno=81, col_offset=30, end_lineno=81, end_col_offset=58)], ctx=Load(), lineno=81, col_offset=10, end_lineno=81, end_col_offset=59), lineno=81, col_offset=0, end_lineno=81, end_col_offset=59)])