Module(body=[Expr(value=Constant(value='FAISS manager for GPU-accelerated vector search.\n\nManages adaptive FAISS indexes (Flat, IVFFlat, or IVF-PQ) with cuVS acceleration,\nCPU persistence, and GPU cloning. Index type is automatically selected based on\ncorpus size for optimal performance.\n', lineno=1, col_offset=0, end_lineno=6, end_col_offset=3), lineno=1, col_offset=0, end_lineno=6, end_col_offset=3), ImportFrom(module='__future__', names=[alias(name='annotations', lineno=8, col_offset=23, end_lineno=8, end_col_offset=34)], level=0, lineno=8, col_offset=0, end_lineno=8, end_col_offset=34), Import(names=[alias(name='importlib', lineno=10, col_offset=7, end_lineno=10, end_col_offset=16)], lineno=10, col_offset=0, end_lineno=10, end_col_offset=16), ImportFrom(module='collections.abc', names=[alias(name='Callable', lineno=11, col_offset=28, end_lineno=11, end_col_offset=36)], level=0, lineno=11, col_offset=0, end_lineno=11, end_col_offset=36), ImportFrom(module='pathlib', names=[alias(name='Path', lineno=12, col_offset=20, end_lineno=12, end_col_offset=24)], level=0, lineno=12, col_offset=0, end_lineno=12, end_col_offset=24), ImportFrom(module='typing', names=[alias(name='TYPE_CHECKING', lineno=13, col_offset=19, end_lineno=13, end_col_offset=32), alias(name='cast', lineno=13, col_offset=34, end_lineno=13, end_col_offset=38)], level=0, lineno=13, col_offset=0, end_lineno=13, end_col_offset=38), Import(names=[alias(name='numpy', asname='np', lineno=15, col_offset=7, end_lineno=15, end_col_offset=18)], lineno=15, col_offset=0, end_lineno=15, end_col_offset=18), ImportFrom(module='kgfoundry_common.logging', names=[alias(name='get_logger', lineno=17, col_offset=37, end_lineno=17, end_col_offset=47)], level=0, lineno=17, col_offset=0, end_lineno=17, end_col_offset=47), ImportFrom(module='kgfoundry_common.typing', names=[alias(name='gate_import', lineno=18, col_offset=36, end_lineno=18, end_col_offset=47)], level=0, lineno=18, col_offset=0, end_lineno=18, end_col_offset=47), If(test=Name(id='TYPE_CHECKING', ctx=Load(), lineno=20, col_offset=3, end_lineno=20, end_col_offset=16), body=[Import(names=[alias(name='faiss', asname='_faiss', lineno=21, col_offset=11, end_lineno=21, end_col_offset=26)], lineno=21, col_offset=4, end_lineno=21, end_col_offset=26)], lineno=20, col_offset=0, end_lineno=21, end_col_offset=26), Assign(targets=[Name(id='LOGGER', ctx=Store(), lineno=23, col_offset=0, end_lineno=23, end_col_offset=6)], value=Call(func=Name(id='get_logger', ctx=Load(), lineno=23, col_offset=9, end_lineno=23, end_col_offset=19), args=[Name(id='__name__', ctx=Load(), lineno=23, col_offset=20, end_lineno=23, end_col_offset=28)], lineno=23, col_offset=9, end_lineno=23, end_col_offset=29), lineno=23, col_offset=0, end_lineno=23, end_col_offset=29), Assign(targets=[Name(id='logger', ctx=Store(), lineno=24, col_offset=0, end_lineno=24, end_col_offset=6)], value=Name(id='LOGGER', ctx=Load(), lineno=24, col_offset=9, end_lineno=24, end_col_offset=15), lineno=24, col_offset=0, end_lineno=24, end_col_offset=15), Assign(targets=[Name(id='faiss', ctx=Store(), lineno=26, col_offset=0, end_lineno=26, end_col_offset=5)], value=Call(func=Name(id='cast', ctx=Load(), lineno=26, col_offset=8, end_lineno=26, end_col_offset=12), args=[Constant(value='_faiss', lineno=26, col_offset=13, end_lineno=26, end_col_offset=21), Call(func=Name(id='gate_import', ctx=Load(), lineno=26, col_offset=23, end_lineno=26, end_col_offset=34), args=[Constant(value='faiss', lineno=26, col_offset=35, end_lineno=26, end_col_offset=42), Constant(value='FAISS manager operations', lineno=26, col_offset=44, end_lineno=26, end_col_offset=70)], lineno=26, col_offset=23, end_lineno=26, end_col_offset=71)], lineno=26, col_offset=8, end_lineno=26, end_col_offset=72), lineno=26, col_offset=0, end_lineno=26, end_col_offset=72), FunctionDef(name='_has_faiss_gpu_support', args=arguments(), body=[Expr(value=Constant(value='Return ``True`` when FAISS exposes GPU bindings, otherwise ``False``.\n\n    Returns\n    -------\n    bool\n        ``True`` when GPU capabilities are available, otherwise ``False``.\n    ', lineno=30, col_offset=4, end_lineno=36, end_col_offset=7), lineno=30, col_offset=4, end_lineno=36, end_col_offset=7), Assign(targets=[Name(id='required_attrs', ctx=Store(), lineno=37, col_offset=4, end_lineno=37, end_col_offset=18)], value=Tuple(elts=[Constant(value='StandardGpuResources', lineno=37, col_offset=22, end_lineno=37, end_col_offset=44), Constant(value='GpuClonerOptions', lineno=37, col_offset=46, end_lineno=37, end_col_offset=64), Constant(value='index_cpu_to_gpu', lineno=37, col_offset=66, end_lineno=37, end_col_offset=84)], ctx=Load(), lineno=37, col_offset=21, end_lineno=37, end_col_offset=85), lineno=37, col_offset=4, end_lineno=37, end_col_offset=85), Return(value=Call(func=Name(id='all', ctx=Load(), lineno=38, col_offset=11, end_lineno=38, end_col_offset=14), args=[GeneratorExp(elt=Call(func=Name(id='hasattr', ctx=Load(), lineno=38, col_offset=15, end_lineno=38, end_col_offset=22), args=[Name(id='faiss', ctx=Load(), lineno=38, col_offset=23, end_lineno=38, end_col_offset=28), Name(id='attr', ctx=Load(), lineno=38, col_offset=30, end_lineno=38, end_col_offset=34)], lineno=38, col_offset=15, end_lineno=38, end_col_offset=35), generators=[comprehension(target=Name(id='attr', ctx=Store(), lineno=38, col_offset=40, end_lineno=38, end_col_offset=44), iter=Name(id='required_attrs', ctx=Load(), lineno=38, col_offset=48, end_lineno=38, end_col_offset=62), is_async=0)], lineno=38, col_offset=14, end_lineno=38, end_col_offset=63)], lineno=38, col_offset=11, end_lineno=38, end_col_offset=63), lineno=38, col_offset=4, end_lineno=38, end_col_offset=63)], returns=Name(id='bool', ctx=Load(), lineno=29, col_offset=32, end_lineno=29, end_col_offset=36), lineno=29, col_offset=0, end_lineno=38, end_col_offset=63), Assign(targets=[Name(id='_FAISS_GPU_AVAILABLE', ctx=Store(), lineno=41, col_offset=0, end_lineno=41, end_col_offset=20)], value=Call(func=Name(id='_has_faiss_gpu_support', ctx=Load(), lineno=41, col_offset=23, end_lineno=41, end_col_offset=45), lineno=41, col_offset=23, end_lineno=41, end_col_offset=47), lineno=41, col_offset=0, end_lineno=41, end_col_offset=47), Assign(targets=[Name(id='_SMALL_CORPUS_THRESHOLD', ctx=Store(), lineno=44, col_offset=0, end_lineno=44, end_col_offset=23)], value=Constant(value=5000, lineno=44, col_offset=26, end_lineno=44, end_col_offset=30), lineno=44, col_offset=0, end_lineno=44, end_col_offset=30), Assign(targets=[Name(id='_MEDIUM_CORPUS_THRESHOLD', ctx=Store(), lineno=45, col_offset=0, end_lineno=45, end_col_offset=24)], value=Constant(value=50000, lineno=45, col_offset=27, end_lineno=45, end_col_offset=32), lineno=45, col_offset=0, end_lineno=45, end_col_offset=32), AnnAssign(target=Name(id='_LOG_EXTRA_BASE', ctx=Store(), lineno=47, col_offset=0, end_lineno=47, end_col_offset=15), annotation=Subscript(value=Name(id='dict', ctx=Load(), lineno=47, col_offset=17, end_lineno=47, end_col_offset=21), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=47, col_offset=22, end_lineno=47, end_col_offset=25), Name(id='object', ctx=Load(), lineno=47, col_offset=27, end_lineno=47, end_col_offset=33)], ctx=Load(), lineno=47, col_offset=22, end_lineno=47, end_col_offset=33), ctx=Load(), lineno=47, col_offset=17, end_lineno=47, end_col_offset=34), value=Dict(keys=[Constant(value='component', lineno=47, col_offset=38, end_lineno=47, end_col_offset=49)], values=[Constant(value='faiss_manager', lineno=47, col_offset=51, end_lineno=47, end_col_offset=66)], lineno=47, col_offset=37, end_lineno=47, end_col_offset=67), simple=1, lineno=47, col_offset=0, end_lineno=47, end_col_offset=67), FunctionDef(name='_log_extra', args=arguments(kwarg=arg(arg='kwargs', annotation=Name(id='object', ctx=Load(), lineno=50, col_offset=25, end_lineno=50, end_col_offset=31), lineno=50, col_offset=17, end_lineno=50, end_col_offset=31)), body=[Expr(value=Constant(value='Build structured logging extras for FAISS manager events.\n\n    Parameters\n    ----------\n    **kwargs : object\n        Additional key-value pairs to include in logging extras. These are\n        merged with the base component name.\n\n    Returns\n    -------\n    dict[str, object]\n        Merged dictionary with component name and provided kwargs.\n    ', lineno=51, col_offset=4, end_lineno=63, end_col_offset=7), lineno=51, col_offset=4, end_lineno=63, end_col_offset=7), Return(value=Dict(keys=[None, None], values=[Name(id='_LOG_EXTRA_BASE', ctx=Load(), lineno=64, col_offset=14, end_lineno=64, end_col_offset=29), Name(id='kwargs', ctx=Load(), lineno=64, col_offset=33, end_lineno=64, end_col_offset=39)], lineno=64, col_offset=11, end_lineno=64, end_col_offset=40), lineno=64, col_offset=4, end_lineno=64, end_col_offset=40)], returns=Subscript(value=Name(id='dict', ctx=Load(), lineno=50, col_offset=36, end_lineno=50, end_col_offset=40), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=50, col_offset=41, end_lineno=50, end_col_offset=44), Name(id='object', ctx=Load(), lineno=50, col_offset=46, end_lineno=50, end_col_offset=52)], ctx=Load(), lineno=50, col_offset=41, end_lineno=50, end_col_offset=52), ctx=Load(), lineno=50, col_offset=36, end_lineno=50, end_col_offset=53), lineno=50, col_offset=0, end_lineno=64, end_col_offset=40), ClassDef(name='FAISSManager', body=[Expr(value=Constant(value="FAISS index manager with adaptive indexing, GPU support, and incremental updates.\n\n    Uses a dual-index architecture for fast incremental updates.\n\n    **Primary Index** (built via `build_index()`):\n    - Adaptive type selection based on corpus size\n    - Small (<5K vectors): Flat index for exact search\n    - Medium (5K-50K vectors): IVFFlat with dynamic nlist\n    - Large (>50K vectors): IVF-PQ with dynamic nlist\n    - Trained on initial corpus, expensive to rebuild\n\n    **Secondary Index** (updated via `update_index()`):\n    - Flat index (IndexFlatIP) for fast incremental additions\n    - No training required - instant updates (seconds)\n    - Used for new vectors added after initial build\n    - Automatically searched alongside primary index\n\n    **Architecture Diagram**:\n    ```\n    Search Query\n        |\n        ├─> Primary Index (IVF-PQ/IVFFlat/Flat)\n        |       └─> Returns top-k results\n        |\n        └─> Secondary Index (Flat) [if exists]\n                └─> Returns top-k results\n        |\n        └─> Merge Results by Score\n                └─> Return top-k combined results\n    ```\n\n    The secondary index is optional and controlled by usage of `update_index()`.\n    When `update_index()` is called, the secondary index is automatically created\n    if it doesn't exist. Use `merge_indexes()` periodically to merge secondary\n    into primary and rebuild for optimal performance.\n\n    Parameters\n    ----------\n    index_path : Path\n        Path to CPU index file.\n    vec_dim : int\n        Vector dimension.\n    nlist : int\n        Number of IVF centroids (used as fallback for large corpora if dynamic\n        calculation yields smaller value). For adaptive indexing, this parameter\n        is typically overridden by dynamic nlist calculation.\n    use_cuvs : bool\n        Enable cuVS acceleration.\n    ", lineno=68, col_offset=4, end_lineno=116, end_col_offset=7), lineno=68, col_offset=4, end_lineno=116, end_col_offset=7), FunctionDef(name='__init__', args=arguments(args=[arg(arg='self', lineno=119, col_offset=8, end_lineno=119, end_col_offset=12), arg(arg='index_path', annotation=Name(id='Path', ctx=Load(), lineno=120, col_offset=20, end_lineno=120, end_col_offset=24), lineno=120, col_offset=8, end_lineno=120, end_col_offset=24), arg(arg='vec_dim', annotation=Name(id='int', ctx=Load(), lineno=121, col_offset=17, end_lineno=121, end_col_offset=20), lineno=121, col_offset=8, end_lineno=121, end_col_offset=20), arg(arg='nlist', annotation=Name(id='int', ctx=Load(), lineno=122, col_offset=15, end_lineno=122, end_col_offset=18), lineno=122, col_offset=8, end_lineno=122, end_col_offset=18)], kwonlyargs=[arg(arg='use_cuvs', annotation=Name(id='bool', ctx=Load(), lineno=124, col_offset=18, end_lineno=124, end_col_offset=22), lineno=124, col_offset=8, end_lineno=124, end_col_offset=22)], kw_defaults=[Constant(value=True, lineno=124, col_offset=25, end_lineno=124, end_col_offset=29)], defaults=[Constant(value=2560, lineno=121, col_offset=23, end_lineno=121, end_col_offset=27), Constant(value=8192, lineno=122, col_offset=21, end_lineno=122, end_col_offset=25)]), body=[Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=126, col_offset=8, end_lineno=126, end_col_offset=12), attr='index_path', ctx=Store(), lineno=126, col_offset=8, end_lineno=126, end_col_offset=23)], value=Name(id='index_path', ctx=Load(), lineno=126, col_offset=26, end_lineno=126, end_col_offset=36), lineno=126, col_offset=8, end_lineno=126, end_col_offset=36), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=127, col_offset=8, end_lineno=127, end_col_offset=12), attr='vec_dim', ctx=Store(), lineno=127, col_offset=8, end_lineno=127, end_col_offset=20)], value=Name(id='vec_dim', ctx=Load(), lineno=127, col_offset=23, end_lineno=127, end_col_offset=30), lineno=127, col_offset=8, end_lineno=127, end_col_offset=30), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=128, col_offset=8, end_lineno=128, end_col_offset=12), attr='nlist', ctx=Store(), lineno=128, col_offset=8, end_lineno=128, end_col_offset=18)], value=Name(id='nlist', ctx=Load(), lineno=128, col_offset=21, end_lineno=128, end_col_offset=26), lineno=128, col_offset=8, end_lineno=128, end_col_offset=26), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=129, col_offset=8, end_lineno=129, end_col_offset=12), attr='use_cuvs', ctx=Store(), lineno=129, col_offset=8, end_lineno=129, end_col_offset=21)], value=Name(id='use_cuvs', ctx=Load(), lineno=129, col_offset=24, end_lineno=129, end_col_offset=32), lineno=129, col_offset=8, end_lineno=129, end_col_offset=32), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=130, col_offset=8, end_lineno=130, end_col_offset=12), attr='cpu_index', ctx=Store(), lineno=130, col_offset=8, end_lineno=130, end_col_offset=22), annotation=BinOp(left=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=130, col_offset=24, end_lineno=130, end_col_offset=30), attr='Index', ctx=Load(), lineno=130, col_offset=24, end_lineno=130, end_col_offset=36), op=BitOr(), right=Constant(value=None, lineno=130, col_offset=39, end_lineno=130, end_col_offset=43), lineno=130, col_offset=24, end_lineno=130, end_col_offset=43), value=Constant(value=None, lineno=130, col_offset=46, end_lineno=130, end_col_offset=50), simple=0, lineno=130, col_offset=8, end_lineno=130, end_col_offset=50), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=131, col_offset=8, end_lineno=131, end_col_offset=12), attr='gpu_index', ctx=Store(), lineno=131, col_offset=8, end_lineno=131, end_col_offset=22), annotation=BinOp(left=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=131, col_offset=24, end_lineno=131, end_col_offset=30), attr='Index', ctx=Load(), lineno=131, col_offset=24, end_lineno=131, end_col_offset=36), op=BitOr(), right=Constant(value=None, lineno=131, col_offset=39, end_lineno=131, end_col_offset=43), lineno=131, col_offset=24, end_lineno=131, end_col_offset=43), value=Constant(value=None, lineno=131, col_offset=46, end_lineno=131, end_col_offset=50), simple=0, lineno=131, col_offset=8, end_lineno=131, end_col_offset=50), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=132, col_offset=8, end_lineno=132, end_col_offset=12), attr='gpu_resources', ctx=Store(), lineno=132, col_offset=8, end_lineno=132, end_col_offset=26), annotation=BinOp(left=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=132, col_offset=28, end_lineno=132, end_col_offset=34), attr='StandardGpuResources', ctx=Load(), lineno=132, col_offset=28, end_lineno=132, end_col_offset=55), op=BitOr(), right=Constant(value=None, lineno=132, col_offset=58, end_lineno=132, end_col_offset=62), lineno=132, col_offset=28, end_lineno=132, end_col_offset=62), value=Constant(value=None, lineno=132, col_offset=65, end_lineno=132, end_col_offset=69), simple=0, lineno=132, col_offset=8, end_lineno=132, end_col_offset=69), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=133, col_offset=8, end_lineno=133, end_col_offset=12), attr='gpu_disabled_reason', ctx=Store(), lineno=133, col_offset=8, end_lineno=133, end_col_offset=32), annotation=BinOp(left=Name(id='str', ctx=Load(), lineno=133, col_offset=34, end_lineno=133, end_col_offset=37), op=BitOr(), right=Constant(value=None, lineno=133, col_offset=40, end_lineno=133, end_col_offset=44), lineno=133, col_offset=34, end_lineno=133, end_col_offset=44), value=Constant(value=None, lineno=133, col_offset=47, end_lineno=133, end_col_offset=51), simple=0, lineno=133, col_offset=8, end_lineno=133, end_col_offset=51), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=136, col_offset=8, end_lineno=136, end_col_offset=12), attr='secondary_index', ctx=Store(), lineno=136, col_offset=8, end_lineno=136, end_col_offset=28), annotation=BinOp(left=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=136, col_offset=30, end_lineno=136, end_col_offset=36), attr='Index', ctx=Load(), lineno=136, col_offset=30, end_lineno=136, end_col_offset=42), op=BitOr(), right=Constant(value=None, lineno=136, col_offset=45, end_lineno=136, end_col_offset=49), lineno=136, col_offset=30, end_lineno=136, end_col_offset=49), value=Constant(value=None, lineno=136, col_offset=52, end_lineno=136, end_col_offset=56), simple=0, lineno=136, col_offset=8, end_lineno=136, end_col_offset=56), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=137, col_offset=8, end_lineno=137, end_col_offset=12), attr='secondary_gpu_index', ctx=Store(), lineno=137, col_offset=8, end_lineno=137, end_col_offset=32), annotation=BinOp(left=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=137, col_offset=34, end_lineno=137, end_col_offset=40), attr='Index', ctx=Load(), lineno=137, col_offset=34, end_lineno=137, end_col_offset=46), op=BitOr(), right=Constant(value=None, lineno=137, col_offset=49, end_lineno=137, end_col_offset=53), lineno=137, col_offset=34, end_lineno=137, end_col_offset=53), value=Constant(value=None, lineno=137, col_offset=56, end_lineno=137, end_col_offset=60), simple=0, lineno=137, col_offset=8, end_lineno=137, end_col_offset=60), AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=138, col_offset=8, end_lineno=138, end_col_offset=12), attr='incremental_ids', ctx=Store(), lineno=138, col_offset=8, end_lineno=138, end_col_offset=28), annotation=Subscript(value=Name(id='set', ctx=Load(), lineno=138, col_offset=30, end_lineno=138, end_col_offset=33), slice=Name(id='int', ctx=Load(), lineno=138, col_offset=34, end_lineno=138, end_col_offset=37), ctx=Load(), lineno=138, col_offset=30, end_lineno=138, end_col_offset=38), value=Call(func=Name(id='set', ctx=Load(), lineno=138, col_offset=41, end_lineno=138, end_col_offset=44), lineno=138, col_offset=41, end_lineno=138, end_col_offset=46), simple=0, lineno=138, col_offset=8, end_lineno=138, end_col_offset=46), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=140, col_offset=8, end_lineno=140, end_col_offset=12), attr='secondary_index_path', ctx=Store(), lineno=140, col_offset=8, end_lineno=140, end_col_offset=33)], value=BinOp(left=Attribute(value=Name(id='index_path', ctx=Load(), lineno=141, col_offset=12, end_lineno=141, end_col_offset=22), attr='parent', ctx=Load(), lineno=141, col_offset=12, end_lineno=141, end_col_offset=29), op=Div(), right=JoinedStr(values=[FormattedValue(value=Attribute(value=Name(id='index_path', ctx=Load(), lineno=141, col_offset=35, end_lineno=141, end_col_offset=45), attr='stem', ctx=Load(), lineno=141, col_offset=35, end_lineno=141, end_col_offset=50), conversion=-1, lineno=141, col_offset=34, end_lineno=141, end_col_offset=51), Constant(value='.secondary', lineno=141, col_offset=51, end_lineno=141, end_col_offset=61), FormattedValue(value=Attribute(value=Name(id='index_path', ctx=Load(), lineno=141, col_offset=62, end_lineno=141, end_col_offset=72), attr='suffix', ctx=Load(), lineno=141, col_offset=62, end_lineno=141, end_col_offset=79), conversion=-1, lineno=141, col_offset=61, end_lineno=141, end_col_offset=80)], lineno=141, col_offset=32, end_lineno=141, end_col_offset=81), lineno=141, col_offset=12, end_lineno=141, end_col_offset=81), lineno=140, col_offset=8, end_lineno=142, end_col_offset=9)], returns=Constant(value=None, lineno=125, col_offset=9, end_lineno=125, end_col_offset=13), lineno=118, col_offset=4, end_lineno=142, end_col_offset=9), FunctionDef(name='build_index', args=arguments(args=[arg(arg='self', lineno=144, col_offset=20, end_lineno=144, end_col_offset=24), arg(arg='vectors', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=144, col_offset=35, end_lineno=144, end_col_offset=37), attr='ndarray', ctx=Load(), lineno=144, col_offset=35, end_lineno=144, end_col_offset=45), lineno=144, col_offset=26, end_lineno=144, end_col_offset=45)]), body=[Expr(value=Constant(value='Build and train FAISS index with adaptive type selection.\n\n        Chooses the optimal index type based on corpus size:\n        - Small corpus (<5K vectors): IndexFlatIP (exact search, no training)\n        - Medium corpus (5K-50K vectors): IVFFlat with dynamic nlist\n        - Large corpus (>50K vectors): IVF-PQ with dynamic nlist\n\n        This adaptive selection provides 10-100x faster training for small/medium\n        corpora while maintaining high recall (>95%) and search performance.\n\n        Parameters\n        ----------\n        vectors : np.ndarray\n            Training vectors of shape (n, vec_dim). Vectors are automatically\n            L2-normalized for cosine similarity.\n\n        Notes\n        -----\n        The index type is selected automatically based on the number of vectors.\n        Small corpora use flat indexes (exact search) for simplicity and speed.\n        Medium corpora use IVFFlat for balanced training time and recall.\n        Large corpora use IVF-PQ for memory efficiency and fast search.\n\n        Examples\n        --------\n        >>> manager = FAISSManager(index_path=Path("index.faiss"), vec_dim=2560)\n        >>> vectors = np.random.randn(1000, 2560).astype(np.float32)\n        >>> manager.build_index(vectors)\n        >>> # Uses IndexFlatIP for 1000 vectors (small corpus)\n        ', lineno=145, col_offset=8, end_lineno=174, end_col_offset=11), lineno=145, col_offset=8, end_lineno=174, end_col_offset=11), Expr(value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=176, col_offset=8, end_lineno=176, end_col_offset=13), attr='normalize_L2', ctx=Load(), lineno=176, col_offset=8, end_lineno=176, end_col_offset=26), args=[Name(id='vectors', ctx=Load(), lineno=176, col_offset=27, end_lineno=176, end_col_offset=34)], lineno=176, col_offset=8, end_lineno=176, end_col_offset=35), lineno=176, col_offset=8, end_lineno=176, end_col_offset=35), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=178, col_offset=8, end_lineno=178, end_col_offset=17)], value=Call(func=Name(id='len', ctx=Load(), lineno=178, col_offset=20, end_lineno=178, end_col_offset=23), args=[Name(id='vectors', ctx=Load(), lineno=178, col_offset=24, end_lineno=178, end_col_offset=31)], lineno=178, col_offset=20, end_lineno=178, end_col_offset=32), lineno=178, col_offset=8, end_lineno=178, end_col_offset=32), If(test=Compare(left=Name(id='n_vectors', ctx=Load(), lineno=180, col_offset=11, end_lineno=180, end_col_offset=20), ops=[Lt()], comparators=[Name(id='_SMALL_CORPUS_THRESHOLD', ctx=Load(), lineno=180, col_offset=23, end_lineno=180, end_col_offset=46)], lineno=180, col_offset=11, end_lineno=180, end_col_offset=46), body=[Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=182, col_offset=12, end_lineno=182, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=182, col_offset=24, end_lineno=182, end_col_offset=29), attr='IndexFlatIP', ctx=Load(), lineno=182, col_offset=24, end_lineno=182, end_col_offset=41), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=182, col_offset=42, end_lineno=182, end_col_offset=46), attr='vec_dim', ctx=Load(), lineno=182, col_offset=42, end_lineno=182, end_col_offset=54)], lineno=182, col_offset=24, end_lineno=182, end_col_offset=55), lineno=182, col_offset=12, end_lineno=182, end_col_offset=55), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=183, col_offset=12, end_lineno=183, end_col_offset=18), attr='info', ctx=Load(), lineno=183, col_offset=12, end_lineno=183, end_col_offset=23), args=[Constant(value='Using IndexFlatIP for small corpus', lineno=184, col_offset=16, end_lineno=184, end_col_offset=52)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=185, col_offset=22, end_lineno=185, end_col_offset=32), keywords=[keyword(arg='n_vectors', value=Name(id='n_vectors', ctx=Load(), lineno=185, col_offset=43, end_lineno=185, end_col_offset=52), lineno=185, col_offset=33, end_lineno=185, end_col_offset=52), keyword(arg='index_type', value=Constant(value='flat', lineno=185, col_offset=65, end_lineno=185, end_col_offset=71), lineno=185, col_offset=54, end_lineno=185, end_col_offset=71)], lineno=185, col_offset=22, end_lineno=185, end_col_offset=72), lineno=185, col_offset=16, end_lineno=185, end_col_offset=72)], lineno=183, col_offset=12, end_lineno=186, end_col_offset=13), lineno=183, col_offset=12, end_lineno=186, end_col_offset=13)], orelse=[If(test=Compare(left=Name(id='n_vectors', ctx=Load(), lineno=187, col_offset=13, end_lineno=187, end_col_offset=22), ops=[Lt()], comparators=[Name(id='_MEDIUM_CORPUS_THRESHOLD', ctx=Load(), lineno=187, col_offset=25, end_lineno=187, end_col_offset=49)], lineno=187, col_offset=13, end_lineno=187, end_col_offset=49), body=[Assign(targets=[Name(id='nlist', ctx=Store(), lineno=189, col_offset=12, end_lineno=189, end_col_offset=17)], value=Call(func=Name(id='min', ctx=Load(), lineno=189, col_offset=20, end_lineno=189, end_col_offset=23), args=[Call(func=Name(id='int', ctx=Load(), lineno=189, col_offset=24, end_lineno=189, end_col_offset=27), args=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=189, col_offset=28, end_lineno=189, end_col_offset=30), attr='sqrt', ctx=Load(), lineno=189, col_offset=28, end_lineno=189, end_col_offset=35), args=[Name(id='n_vectors', ctx=Load(), lineno=189, col_offset=36, end_lineno=189, end_col_offset=45)], lineno=189, col_offset=28, end_lineno=189, end_col_offset=46)], lineno=189, col_offset=24, end_lineno=189, end_col_offset=47), BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=189, col_offset=49, end_lineno=189, end_col_offset=58), op=FloorDiv(), right=Constant(value=39, lineno=189, col_offset=62, end_lineno=189, end_col_offset=64), lineno=189, col_offset=49, end_lineno=189, end_col_offset=64)], lineno=189, col_offset=20, end_lineno=189, end_col_offset=65), lineno=189, col_offset=12, end_lineno=189, end_col_offset=65), Assign(targets=[Name(id='nlist', ctx=Store(), lineno=190, col_offset=12, end_lineno=190, end_col_offset=17)], value=Call(func=Name(id='max', ctx=Load(), lineno=190, col_offset=20, end_lineno=190, end_col_offset=23), args=[Name(id='nlist', ctx=Load(), lineno=190, col_offset=24, end_lineno=190, end_col_offset=29), Constant(value=100, lineno=190, col_offset=31, end_lineno=190, end_col_offset=34)], lineno=190, col_offset=20, end_lineno=190, end_col_offset=35), lineno=190, col_offset=12, end_lineno=190, end_col_offset=35), Assign(targets=[Name(id='quantizer', ctx=Store(), lineno=192, col_offset=12, end_lineno=192, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=192, col_offset=24, end_lineno=192, end_col_offset=29), attr='IndexFlatIP', ctx=Load(), lineno=192, col_offset=24, end_lineno=192, end_col_offset=41), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=192, col_offset=42, end_lineno=192, end_col_offset=46), attr='vec_dim', ctx=Load(), lineno=192, col_offset=42, end_lineno=192, end_col_offset=54)], lineno=192, col_offset=24, end_lineno=192, end_col_offset=55), lineno=192, col_offset=12, end_lineno=192, end_col_offset=55), Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=193, col_offset=12, end_lineno=193, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=193, col_offset=24, end_lineno=193, end_col_offset=29), attr='IndexIVFFlat', ctx=Load(), lineno=193, col_offset=24, end_lineno=193, end_col_offset=42), args=[Name(id='quantizer', ctx=Load(), lineno=194, col_offset=16, end_lineno=194, end_col_offset=25), Attribute(value=Name(id='self', ctx=Load(), lineno=194, col_offset=27, end_lineno=194, end_col_offset=31), attr='vec_dim', ctx=Load(), lineno=194, col_offset=27, end_lineno=194, end_col_offset=39), Name(id='nlist', ctx=Load(), lineno=194, col_offset=41, end_lineno=194, end_col_offset=46), Attribute(value=Name(id='faiss', ctx=Load(), lineno=194, col_offset=48, end_lineno=194, end_col_offset=53), attr='METRIC_INNER_PRODUCT', ctx=Load(), lineno=194, col_offset=48, end_lineno=194, end_col_offset=74)], lineno=193, col_offset=24, end_lineno=195, end_col_offset=13), lineno=193, col_offset=12, end_lineno=195, end_col_offset=13), Expr(value=Call(func=Attribute(value=Name(id='cpu_index', ctx=Load(), lineno=196, col_offset=12, end_lineno=196, end_col_offset=21), attr='train', ctx=Load(), lineno=196, col_offset=12, end_lineno=196, end_col_offset=27), args=[Name(id='vectors', ctx=Load(), lineno=196, col_offset=28, end_lineno=196, end_col_offset=35)], lineno=196, col_offset=12, end_lineno=196, end_col_offset=36), lineno=196, col_offset=12, end_lineno=196, end_col_offset=36), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=197, col_offset=12, end_lineno=197, end_col_offset=18), attr='info', ctx=Load(), lineno=197, col_offset=12, end_lineno=197, end_col_offset=23), args=[Constant(value='Using IVFFlat for medium corpus', lineno=198, col_offset=16, end_lineno=198, end_col_offset=49)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=199, col_offset=22, end_lineno=199, end_col_offset=32), keywords=[keyword(arg='n_vectors', value=Name(id='n_vectors', ctx=Load(), lineno=199, col_offset=43, end_lineno=199, end_col_offset=52), lineno=199, col_offset=33, end_lineno=199, end_col_offset=52), keyword(arg='nlist', value=Name(id='nlist', ctx=Load(), lineno=199, col_offset=60, end_lineno=199, end_col_offset=65), lineno=199, col_offset=54, end_lineno=199, end_col_offset=65), keyword(arg='index_type', value=Constant(value='ivf_flat', lineno=199, col_offset=78, end_lineno=199, end_col_offset=88), lineno=199, col_offset=67, end_lineno=199, end_col_offset=88)], lineno=199, col_offset=22, end_lineno=199, end_col_offset=89), lineno=199, col_offset=16, end_lineno=199, end_col_offset=89)], lineno=197, col_offset=12, end_lineno=200, end_col_offset=13), lineno=197, col_offset=12, end_lineno=200, end_col_offset=13)], orelse=[Assign(targets=[Name(id='nlist', ctx=Store(), lineno=203, col_offset=12, end_lineno=203, end_col_offset=17)], value=Call(func=Name(id='int', ctx=Load(), lineno=203, col_offset=20, end_lineno=203, end_col_offset=23), args=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=203, col_offset=24, end_lineno=203, end_col_offset=26), attr='sqrt', ctx=Load(), lineno=203, col_offset=24, end_lineno=203, end_col_offset=31), args=[Name(id='n_vectors', ctx=Load(), lineno=203, col_offset=32, end_lineno=203, end_col_offset=41)], lineno=203, col_offset=24, end_lineno=203, end_col_offset=42)], lineno=203, col_offset=20, end_lineno=203, end_col_offset=43), lineno=203, col_offset=12, end_lineno=203, end_col_offset=43), Assign(targets=[Name(id='nlist', ctx=Store(), lineno=204, col_offset=12, end_lineno=204, end_col_offset=17)], value=Call(func=Name(id='max', ctx=Load(), lineno=204, col_offset=20, end_lineno=204, end_col_offset=23), args=[Name(id='nlist', ctx=Load(), lineno=204, col_offset=24, end_lineno=204, end_col_offset=29), Constant(value=1024, lineno=204, col_offset=31, end_lineno=204, end_col_offset=35)], lineno=204, col_offset=20, end_lineno=204, end_col_offset=36), lineno=204, col_offset=12, end_lineno=204, end_col_offset=36), Assign(targets=[Name(id='index_string', ctx=Store(), lineno=206, col_offset=12, end_lineno=206, end_col_offset=24)], value=JoinedStr(values=[Constant(value='OPQ64,IVF', lineno=206, col_offset=29, end_lineno=206, end_col_offset=38), FormattedValue(value=Name(id='nlist', ctx=Load(), lineno=206, col_offset=39, end_lineno=206, end_col_offset=44), conversion=-1, lineno=206, col_offset=38, end_lineno=206, end_col_offset=45), Constant(value=',PQ64', lineno=206, col_offset=45, end_lineno=206, end_col_offset=50)], lineno=206, col_offset=27, end_lineno=206, end_col_offset=51), lineno=206, col_offset=12, end_lineno=206, end_col_offset=51), Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=207, col_offset=12, end_lineno=207, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=207, col_offset=24, end_lineno=207, end_col_offset=29), attr='index_factory', ctx=Load(), lineno=207, col_offset=24, end_lineno=207, end_col_offset=43), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=207, col_offset=44, end_lineno=207, end_col_offset=48), attr='vec_dim', ctx=Load(), lineno=207, col_offset=44, end_lineno=207, end_col_offset=56), Name(id='index_string', ctx=Load(), lineno=207, col_offset=58, end_lineno=207, end_col_offset=70), Attribute(value=Name(id='faiss', ctx=Load(), lineno=207, col_offset=72, end_lineno=207, end_col_offset=77), attr='METRIC_INNER_PRODUCT', ctx=Load(), lineno=207, col_offset=72, end_lineno=207, end_col_offset=98)], lineno=207, col_offset=24, end_lineno=207, end_col_offset=99), lineno=207, col_offset=12, end_lineno=207, end_col_offset=99), Expr(value=Call(func=Attribute(value=Name(id='cpu_index', ctx=Load(), lineno=208, col_offset=12, end_lineno=208, end_col_offset=21), attr='train', ctx=Load(), lineno=208, col_offset=12, end_lineno=208, end_col_offset=27), args=[Name(id='vectors', ctx=Load(), lineno=208, col_offset=28, end_lineno=208, end_col_offset=35)], lineno=208, col_offset=12, end_lineno=208, end_col_offset=36), lineno=208, col_offset=12, end_lineno=208, end_col_offset=36), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=209, col_offset=12, end_lineno=209, end_col_offset=18), attr='info', ctx=Load(), lineno=209, col_offset=12, end_lineno=209, end_col_offset=23), args=[Constant(value='Using IVF-PQ for large corpus', lineno=210, col_offset=16, end_lineno=210, end_col_offset=47)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=211, col_offset=22, end_lineno=211, end_col_offset=32), keywords=[keyword(arg='n_vectors', value=Name(id='n_vectors', ctx=Load(), lineno=211, col_offset=43, end_lineno=211, end_col_offset=52), lineno=211, col_offset=33, end_lineno=211, end_col_offset=52), keyword(arg='nlist', value=Name(id='nlist', ctx=Load(), lineno=211, col_offset=60, end_lineno=211, end_col_offset=65), lineno=211, col_offset=54, end_lineno=211, end_col_offset=65), keyword(arg='index_type', value=Constant(value='ivf_pq', lineno=211, col_offset=78, end_lineno=211, end_col_offset=86), lineno=211, col_offset=67, end_lineno=211, end_col_offset=86)], lineno=211, col_offset=22, end_lineno=211, end_col_offset=87), lineno=211, col_offset=16, end_lineno=211, end_col_offset=87)], lineno=209, col_offset=12, end_lineno=212, end_col_offset=13), lineno=209, col_offset=12, end_lineno=212, end_col_offset=13)], lineno=187, col_offset=8, end_lineno=212, end_col_offset=13)], lineno=180, col_offset=8, end_lineno=212, end_col_offset=13), Assign(targets=[Name(id='mem_est', ctx=Store(), lineno=215, col_offset=8, end_lineno=215, end_col_offset=15)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=215, col_offset=18, end_lineno=215, end_col_offset=22), attr='estimate_memory_usage', ctx=Load(), lineno=215, col_offset=18, end_lineno=215, end_col_offset=44), args=[Name(id='n_vectors', ctx=Load(), lineno=215, col_offset=45, end_lineno=215, end_col_offset=54)], lineno=215, col_offset=18, end_lineno=215, end_col_offset=55), lineno=215, col_offset=8, end_lineno=215, end_col_offset=55), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=216, col_offset=8, end_lineno=216, end_col_offset=14), attr='info', ctx=Load(), lineno=216, col_offset=8, end_lineno=216, end_col_offset=19), args=[Constant(value='Memory estimate for index', lineno=217, col_offset=12, end_lineno=217, end_col_offset=39)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=218, col_offset=18, end_lineno=218, end_col_offset=28), keywords=[keyword(arg='n_vectors', value=Name(id='n_vectors', ctx=Load(), lineno=219, col_offset=26, end_lineno=219, end_col_offset=35), lineno=219, col_offset=16, end_lineno=219, end_col_offset=35), keyword(arg='cpu_index_bytes', value=Subscript(value=Name(id='mem_est', ctx=Load(), lineno=220, col_offset=32, end_lineno=220, end_col_offset=39), slice=Constant(value='cpu_index_bytes', lineno=220, col_offset=40, end_lineno=220, end_col_offset=57), ctx=Load(), lineno=220, col_offset=32, end_lineno=220, end_col_offset=58), lineno=220, col_offset=16, end_lineno=220, end_col_offset=58), keyword(arg='gpu_index_bytes', value=Subscript(value=Name(id='mem_est', ctx=Load(), lineno=221, col_offset=32, end_lineno=221, end_col_offset=39), slice=Constant(value='gpu_index_bytes', lineno=221, col_offset=40, end_lineno=221, end_col_offset=57), ctx=Load(), lineno=221, col_offset=32, end_lineno=221, end_col_offset=58), lineno=221, col_offset=16, end_lineno=221, end_col_offset=58), keyword(arg='total_bytes', value=Subscript(value=Name(id='mem_est', ctx=Load(), lineno=222, col_offset=28, end_lineno=222, end_col_offset=35), slice=Constant(value='total_bytes', lineno=222, col_offset=36, end_lineno=222, end_col_offset=49), ctx=Load(), lineno=222, col_offset=28, end_lineno=222, end_col_offset=50), lineno=222, col_offset=16, end_lineno=222, end_col_offset=50)], lineno=218, col_offset=18, end_lineno=223, end_col_offset=13), lineno=218, col_offset=12, end_lineno=223, end_col_offset=13)], lineno=216, col_offset=8, end_lineno=224, end_col_offset=9), lineno=216, col_offset=8, end_lineno=224, end_col_offset=9), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=227, col_offset=8, end_lineno=227, end_col_offset=12), attr='cpu_index', ctx=Store(), lineno=227, col_offset=8, end_lineno=227, end_col_offset=22)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=227, col_offset=25, end_lineno=227, end_col_offset=30), attr='IndexIDMap2', ctx=Load(), lineno=227, col_offset=25, end_lineno=227, end_col_offset=42), args=[Name(id='cpu_index', ctx=Load(), lineno=227, col_offset=43, end_lineno=227, end_col_offset=52)], lineno=227, col_offset=25, end_lineno=227, end_col_offset=53), lineno=227, col_offset=8, end_lineno=227, end_col_offset=53)], returns=Constant(value=None, lineno=144, col_offset=50, end_lineno=144, end_col_offset=54), lineno=144, col_offset=4, end_lineno=227, end_col_offset=53), FunctionDef(name='estimate_memory_usage', args=arguments(args=[arg(arg='self', lineno=229, col_offset=30, end_lineno=229, end_col_offset=34), arg(arg='n_vectors', annotation=Name(id='int', ctx=Load(), lineno=229, col_offset=47, end_lineno=229, end_col_offset=50), lineno=229, col_offset=36, end_lineno=229, end_col_offset=50)]), body=[Expr(value=Constant(value='Estimate memory usage in bytes for a given number of vectors.\n\n        Provides memory estimates for CPU and GPU indexes based on the adaptive\n        index type that would be selected for the given corpus size. This is useful\n        for capacity planning and resource allocation.\n\n        Parameters\n        ----------\n        n_vectors : int\n            Number of vectors to estimate memory for.\n\n        Returns\n        -------\n        dict[str, int]\n            Dictionary with memory estimates in bytes:\n            - ``cpu_index_bytes``: Estimated CPU index memory usage\n            - ``gpu_index_bytes``: Estimated GPU index memory usage (includes ~20% overhead)\n            - ``total_bytes``: Total estimated memory (CPU + GPU)\n\n        Examples\n        --------\n        >>> manager = FAISSManager(index_path=Path("index.faiss"), vec_dim=2560)\n        >>> estimates = manager.estimate_memory_usage(10000)\n        >>> print(f"CPU index: {estimates[\'cpu_index_bytes\'] / 1e9:.2f} GB")\n        CPU index: 0.26 GB\n        >>> print(f"Total: {estimates[\'total_bytes\'] / 1e9:.2f} GB")\n        Total: 0.57 GB\n\n        Notes\n        -----\n        Memory estimates are approximate and may vary based on:\n        - Actual index type selected (flat vs IVFFlat vs IVF-PQ)\n        - FAISS internal overhead\n        - GPU memory fragmentation\n        - Operating system memory management\n\n        Estimates are typically within ±20% of actual usage for most workloads.\n        ', lineno=230, col_offset=8, end_lineno=267, end_col_offset=11), lineno=230, col_offset=8, end_lineno=267, end_col_offset=11), Assign(targets=[Name(id='vec_size', ctx=Store(), lineno=268, col_offset=8, end_lineno=268, end_col_offset=16)], value=BinOp(left=Attribute(value=Name(id='self', ctx=Load(), lineno=268, col_offset=19, end_lineno=268, end_col_offset=23), attr='vec_dim', ctx=Load(), lineno=268, col_offset=19, end_lineno=268, end_col_offset=31), op=Mult(), right=Constant(value=4, lineno=268, col_offset=34, end_lineno=268, end_col_offset=35), lineno=268, col_offset=19, end_lineno=268, end_col_offset=35), lineno=268, col_offset=8, end_lineno=268, end_col_offset=35), If(test=Compare(left=Name(id='n_vectors', ctx=Load(), lineno=270, col_offset=11, end_lineno=270, end_col_offset=20), ops=[Lt()], comparators=[Name(id='_SMALL_CORPUS_THRESHOLD', ctx=Load(), lineno=270, col_offset=23, end_lineno=270, end_col_offset=46)], lineno=270, col_offset=11, end_lineno=270, end_col_offset=46), body=[Assign(targets=[Name(id='cpu_mem', ctx=Store(), lineno=272, col_offset=12, end_lineno=272, end_col_offset=19)], value=BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=272, col_offset=22, end_lineno=272, end_col_offset=31), op=Mult(), right=Name(id='vec_size', ctx=Load(), lineno=272, col_offset=34, end_lineno=272, end_col_offset=42), lineno=272, col_offset=22, end_lineno=272, end_col_offset=42), lineno=272, col_offset=12, end_lineno=272, end_col_offset=42)], orelse=[If(test=Compare(left=Name(id='n_vectors', ctx=Load(), lineno=273, col_offset=13, end_lineno=273, end_col_offset=22), ops=[Lt()], comparators=[Name(id='_MEDIUM_CORPUS_THRESHOLD', ctx=Load(), lineno=273, col_offset=25, end_lineno=273, end_col_offset=49)], lineno=273, col_offset=13, end_lineno=273, end_col_offset=49), body=[Assign(targets=[Name(id='nlist', ctx=Store(), lineno=275, col_offset=12, end_lineno=275, end_col_offset=17)], value=Call(func=Name(id='min', ctx=Load(), lineno=275, col_offset=20, end_lineno=275, end_col_offset=23), args=[Call(func=Name(id='int', ctx=Load(), lineno=275, col_offset=24, end_lineno=275, end_col_offset=27), args=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=275, col_offset=28, end_lineno=275, end_col_offset=30), attr='sqrt', ctx=Load(), lineno=275, col_offset=28, end_lineno=275, end_col_offset=35), args=[Name(id='n_vectors', ctx=Load(), lineno=275, col_offset=36, end_lineno=275, end_col_offset=45)], lineno=275, col_offset=28, end_lineno=275, end_col_offset=46)], lineno=275, col_offset=24, end_lineno=275, end_col_offset=47), BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=275, col_offset=49, end_lineno=275, end_col_offset=58), op=FloorDiv(), right=Constant(value=39, lineno=275, col_offset=62, end_lineno=275, end_col_offset=64), lineno=275, col_offset=49, end_lineno=275, end_col_offset=64)], lineno=275, col_offset=20, end_lineno=275, end_col_offset=65), lineno=275, col_offset=12, end_lineno=275, end_col_offset=65), Assign(targets=[Name(id='nlist', ctx=Store(), lineno=276, col_offset=12, end_lineno=276, end_col_offset=17)], value=Call(func=Name(id='max', ctx=Load(), lineno=276, col_offset=20, end_lineno=276, end_col_offset=23), args=[Name(id='nlist', ctx=Load(), lineno=276, col_offset=24, end_lineno=276, end_col_offset=29), Constant(value=100, lineno=276, col_offset=31, end_lineno=276, end_col_offset=34)], lineno=276, col_offset=20, end_lineno=276, end_col_offset=35), lineno=276, col_offset=12, end_lineno=276, end_col_offset=35), Assign(targets=[Name(id='cpu_mem', ctx=Store(), lineno=277, col_offset=12, end_lineno=277, end_col_offset=19)], value=BinOp(left=BinOp(left=Name(id='nlist', ctx=Load(), lineno=277, col_offset=23, end_lineno=277, end_col_offset=28), op=Mult(), right=Name(id='vec_size', ctx=Load(), lineno=277, col_offset=31, end_lineno=277, end_col_offset=39), lineno=277, col_offset=23, end_lineno=277, end_col_offset=39), op=Add(), right=BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=277, col_offset=44, end_lineno=277, end_col_offset=53), op=Mult(), right=Constant(value=8, lineno=277, col_offset=56, end_lineno=277, end_col_offset=57), lineno=277, col_offset=44, end_lineno=277, end_col_offset=57), lineno=277, col_offset=22, end_lineno=277, end_col_offset=58), lineno=277, col_offset=12, end_lineno=277, end_col_offset=58)], orelse=[Assign(targets=[Name(id='nlist', ctx=Store(), lineno=280, col_offset=12, end_lineno=280, end_col_offset=17)], value=Call(func=Name(id='int', ctx=Load(), lineno=280, col_offset=20, end_lineno=280, end_col_offset=23), args=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=280, col_offset=24, end_lineno=280, end_col_offset=26), attr='sqrt', ctx=Load(), lineno=280, col_offset=24, end_lineno=280, end_col_offset=31), args=[Name(id='n_vectors', ctx=Load(), lineno=280, col_offset=32, end_lineno=280, end_col_offset=41)], lineno=280, col_offset=24, end_lineno=280, end_col_offset=42)], lineno=280, col_offset=20, end_lineno=280, end_col_offset=43), lineno=280, col_offset=12, end_lineno=280, end_col_offset=43), Assign(targets=[Name(id='nlist', ctx=Store(), lineno=281, col_offset=12, end_lineno=281, end_col_offset=17)], value=Call(func=Name(id='max', ctx=Load(), lineno=281, col_offset=20, end_lineno=281, end_col_offset=23), args=[Name(id='nlist', ctx=Load(), lineno=281, col_offset=24, end_lineno=281, end_col_offset=29), Constant(value=1024, lineno=281, col_offset=31, end_lineno=281, end_col_offset=35)], lineno=281, col_offset=20, end_lineno=281, end_col_offset=36), lineno=281, col_offset=12, end_lineno=281, end_col_offset=36), Assign(targets=[Name(id='cpu_mem', ctx=Store(), lineno=282, col_offset=12, end_lineno=282, end_col_offset=19)], value=BinOp(left=BinOp(left=Name(id='nlist', ctx=Load(), lineno=282, col_offset=23, end_lineno=282, end_col_offset=28), op=Mult(), right=Name(id='vec_size', ctx=Load(), lineno=282, col_offset=31, end_lineno=282, end_col_offset=39), lineno=282, col_offset=23, end_lineno=282, end_col_offset=39), op=Add(), right=BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=282, col_offset=44, end_lineno=282, end_col_offset=53), op=Mult(), right=Constant(value=64, lineno=282, col_offset=56, end_lineno=282, end_col_offset=58), lineno=282, col_offset=44, end_lineno=282, end_col_offset=58), lineno=282, col_offset=22, end_lineno=282, end_col_offset=59), lineno=282, col_offset=12, end_lineno=282, end_col_offset=59)], lineno=273, col_offset=8, end_lineno=282, end_col_offset=59)], lineno=270, col_offset=8, end_lineno=282, end_col_offset=59), Assign(targets=[Name(id='gpu_mem', ctx=Store(), lineno=285, col_offset=8, end_lineno=285, end_col_offset=15)], value=Call(func=Name(id='int', ctx=Load(), lineno=285, col_offset=18, end_lineno=285, end_col_offset=21), args=[BinOp(left=Name(id='cpu_mem', ctx=Load(), lineno=285, col_offset=22, end_lineno=285, end_col_offset=29), op=Mult(), right=Constant(value=1.2, lineno=285, col_offset=32, end_lineno=285, end_col_offset=35), lineno=285, col_offset=22, end_lineno=285, end_col_offset=35)], lineno=285, col_offset=18, end_lineno=285, end_col_offset=36), lineno=285, col_offset=8, end_lineno=285, end_col_offset=36), Return(value=Dict(keys=[Constant(value='cpu_index_bytes', lineno=288, col_offset=12, end_lineno=288, end_col_offset=29), Constant(value='gpu_index_bytes', lineno=289, col_offset=12, end_lineno=289, end_col_offset=29), Constant(value='total_bytes', lineno=290, col_offset=12, end_lineno=290, end_col_offset=25)], values=[Name(id='cpu_mem', ctx=Load(), lineno=288, col_offset=31, end_lineno=288, end_col_offset=38), Name(id='gpu_mem', ctx=Load(), lineno=289, col_offset=31, end_lineno=289, end_col_offset=38), BinOp(left=Name(id='cpu_mem', ctx=Load(), lineno=290, col_offset=27, end_lineno=290, end_col_offset=34), op=Add(), right=Name(id='gpu_mem', ctx=Load(), lineno=290, col_offset=37, end_lineno=290, end_col_offset=44), lineno=290, col_offset=27, end_lineno=290, end_col_offset=44)], lineno=287, col_offset=15, end_lineno=291, end_col_offset=9), lineno=287, col_offset=8, end_lineno=291, end_col_offset=9)], returns=Subscript(value=Name(id='dict', ctx=Load(), lineno=229, col_offset=55, end_lineno=229, end_col_offset=59), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=229, col_offset=60, end_lineno=229, end_col_offset=63), Name(id='int', ctx=Load(), lineno=229, col_offset=65, end_lineno=229, end_col_offset=68)], ctx=Load(), lineno=229, col_offset=60, end_lineno=229, end_col_offset=68), ctx=Load(), lineno=229, col_offset=55, end_lineno=229, end_col_offset=69), lineno=229, col_offset=4, end_lineno=291, end_col_offset=9), FunctionDef(name='add_vectors', args=arguments(args=[arg(arg='self', lineno=293, col_offset=20, end_lineno=293, end_col_offset=24), arg(arg='vectors', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=293, col_offset=35, end_lineno=293, end_col_offset=37), attr='ndarray', ctx=Load(), lineno=293, col_offset=35, end_lineno=293, end_col_offset=45), lineno=293, col_offset=26, end_lineno=293, end_col_offset=45), arg(arg='ids', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=293, col_offset=52, end_lineno=293, end_col_offset=54), attr='ndarray', ctx=Load(), lineno=293, col_offset=52, end_lineno=293, end_col_offset=62), lineno=293, col_offset=47, end_lineno=293, end_col_offset=62)]), body=[Expr(value=Constant(value='Add vectors with IDs to the index.\n\n        Adds a batch of vectors to the FAISS index with their associated IDs.\n        The vectors are normalized for cosine similarity (L2 normalization) before\n        being added. IDs are used for retrieval - they should match the chunk IDs\n        stored in DuckDB.\n\n        This method requires that build_index() has been called first to create\n        and train the index structure.\n\n        Parameters\n        ----------\n        vectors : np.ndarray\n            Vectors to add, shape (n, vec_dim) where n is the number of vectors\n            and vec_dim matches the index dimension. Dtype should be float32.\n        ids : np.ndarray\n            Unique IDs for each vector, shape (n,). IDs are stored as int64 in\n            FAISS. These should correspond to chunk IDs from the indexing pipeline.\n\n        Raises\n        ------\n        RuntimeError\n            If the index has not been built yet. Call build_index() first.\n        ', lineno=294, col_offset=8, end_lineno=317, end_col_offset=11), lineno=294, col_offset=8, end_lineno=317, end_col_offset=11), Try(body=[Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=319, col_offset=12, end_lineno=319, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=319, col_offset=24, end_lineno=319, end_col_offset=28), attr='_require_cpu_index', ctx=Load(), lineno=319, col_offset=24, end_lineno=319, end_col_offset=47), lineno=319, col_offset=24, end_lineno=319, end_col_offset=49), lineno=319, col_offset=12, end_lineno=319, end_col_offset=49)], handlers=[ExceptHandler(type=Name(id='RuntimeError', ctx=Load(), lineno=320, col_offset=15, end_lineno=320, end_col_offset=27), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=321, col_offset=12, end_lineno=321, end_col_offset=15)], value=Constant(value='Cannot add vectors: FAISS index has not been built or loaded.', lineno=321, col_offset=18, end_lineno=321, end_col_offset=81), lineno=321, col_offset=12, end_lineno=321, end_col_offset=81), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=322, col_offset=18, end_lineno=322, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=322, col_offset=31, end_lineno=322, end_col_offset=34)], lineno=322, col_offset=18, end_lineno=322, end_col_offset=35), cause=Name(id='exc', ctx=Load(), lineno=322, col_offset=41, end_lineno=322, end_col_offset=44), lineno=322, col_offset=12, end_lineno=322, end_col_offset=44)], lineno=320, col_offset=8, end_lineno=322, end_col_offset=44)], lineno=318, col_offset=8, end_lineno=322, end_col_offset=44), Assign(targets=[Name(id='vectors_norm', ctx=Store(), lineno=325, col_offset=8, end_lineno=325, end_col_offset=20)], value=Call(func=Attribute(value=Name(id='vectors', ctx=Load(), lineno=325, col_offset=23, end_lineno=325, end_col_offset=30), attr='copy', ctx=Load(), lineno=325, col_offset=23, end_lineno=325, end_col_offset=35), lineno=325, col_offset=23, end_lineno=325, end_col_offset=37), lineno=325, col_offset=8, end_lineno=325, end_col_offset=37), Expr(value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=326, col_offset=8, end_lineno=326, end_col_offset=13), attr='normalize_L2', ctx=Load(), lineno=326, col_offset=8, end_lineno=326, end_col_offset=26), args=[Name(id='vectors_norm', ctx=Load(), lineno=326, col_offset=27, end_lineno=326, end_col_offset=39)], lineno=326, col_offset=8, end_lineno=326, end_col_offset=40), lineno=326, col_offset=8, end_lineno=326, end_col_offset=40), Expr(value=Call(func=Attribute(value=Name(id='cpu_index', ctx=Load(), lineno=329, col_offset=8, end_lineno=329, end_col_offset=17), attr='add_with_ids', ctx=Load(), lineno=329, col_offset=8, end_lineno=329, end_col_offset=30), args=[Name(id='vectors_norm', ctx=Load(), lineno=329, col_offset=31, end_lineno=329, end_col_offset=43), Call(func=Attribute(value=Name(id='ids', ctx=Load(), lineno=329, col_offset=45, end_lineno=329, end_col_offset=48), attr='astype', ctx=Load(), lineno=329, col_offset=45, end_lineno=329, end_col_offset=55), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=329, col_offset=56, end_lineno=329, end_col_offset=58), attr='int64', ctx=Load(), lineno=329, col_offset=56, end_lineno=329, end_col_offset=64)], lineno=329, col_offset=45, end_lineno=329, end_col_offset=65)], lineno=329, col_offset=8, end_lineno=329, end_col_offset=66), lineno=329, col_offset=8, end_lineno=329, end_col_offset=66)], returns=Constant(value=None, lineno=293, col_offset=67, end_lineno=293, end_col_offset=71), lineno=293, col_offset=4, end_lineno=329, end_col_offset=66), FunctionDef(name='update_index', args=arguments(args=[arg(arg='self', lineno=331, col_offset=21, end_lineno=331, end_col_offset=25), arg(arg='new_vectors', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=331, col_offset=40, end_lineno=331, end_col_offset=42), attr='ndarray', ctx=Load(), lineno=331, col_offset=40, end_lineno=331, end_col_offset=50), lineno=331, col_offset=27, end_lineno=331, end_col_offset=50), arg(arg='new_ids', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=331, col_offset=61, end_lineno=331, end_col_offset=63), attr='ndarray', ctx=Load(), lineno=331, col_offset=61, end_lineno=331, end_col_offset=71), lineno=331, col_offset=52, end_lineno=331, end_col_offset=71)]), body=[Expr(value=Constant(value='Add new vectors to secondary index for fast incremental updates.\n\n        Extended Summary\n        ----------------\n        This method adds new vectors to a secondary flat index (IndexFlatIP) which\n        requires no training and provides instant updates. This enables fast incremental\n        indexing without rebuilding the primary index. The method filters out vectors\n        that already exist in the primary index to avoid duplicates, then adds only\n        unique vectors to the secondary index. This is used for real-time index updates\n        during active codebase indexing workflows.\n\n        Parameters\n        ----------\n        new_vectors : np.ndarray\n            Array of new embedding vectors to add, shape (N, dim) where N is the number\n            of vectors and dim matches the index dimensionality. Must be float32 and\n            normalized if the index uses cosine similarity.\n        new_ids : np.ndarray\n            Array of document/chunk IDs corresponding to new_vectors, shape (N,).\n            Must be integer type. IDs that already exist in the primary index will be\n            filtered out before adding to the secondary index.\n\n        Raises\n        ------\n        RuntimeError\n            If the secondary index is unexpectedly missing during the update. This\n            indicates a configuration or initialization error that should be resolved\n            before attempting updates.\n\n        Notes\n        -----\n        Time complexity O(N * log(M)) where N is new_vectors count and M is existing\n        index size, due to duplicate checking. Space complexity O(N) for temporary\n        storage. The method performs I/O to update the FAISS index on disk. Thread-safe\n        if called sequentially; concurrent updates may cause race conditions.\n        ', lineno=332, col_offset=8, end_lineno=367, end_col_offset=11), lineno=332, col_offset=8, end_lineno=367, end_col_offset=11), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=368, col_offset=8, end_lineno=368, end_col_offset=12), attr='_ensure_secondary_index', ctx=Load(), lineno=368, col_offset=8, end_lineno=368, end_col_offset=36), lineno=368, col_offset=8, end_lineno=368, end_col_offset=38), lineno=368, col_offset=8, end_lineno=368, end_col_offset=38), Assign(targets=[Name(id='primary_contains', ctx=Store(), lineno=369, col_offset=8, end_lineno=369, end_col_offset=24)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=369, col_offset=27, end_lineno=369, end_col_offset=31), attr='_build_primary_contains', ctx=Load(), lineno=369, col_offset=27, end_lineno=369, end_col_offset=55), lineno=369, col_offset=27, end_lineno=369, end_col_offset=57), lineno=369, col_offset=8, end_lineno=369, end_col_offset=57), Assign(targets=[Name(id='unique_indices', ctx=Store(), lineno=370, col_offset=8, end_lineno=370, end_col_offset=22)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=370, col_offset=25, end_lineno=370, end_col_offset=29), attr='_collect_unique_indices', ctx=Load(), lineno=370, col_offset=25, end_lineno=370, end_col_offset=53), args=[Name(id='new_ids', ctx=Load(), lineno=370, col_offset=54, end_lineno=370, end_col_offset=61), Name(id='primary_contains', ctx=Load(), lineno=370, col_offset=63, end_lineno=370, end_col_offset=79)], lineno=370, col_offset=25, end_lineno=370, end_col_offset=80), lineno=370, col_offset=8, end_lineno=370, end_col_offset=80), If(test=UnaryOp(op=Not(), operand=Name(id='unique_indices', ctx=Load(), lineno=372, col_offset=15, end_lineno=372, end_col_offset=29), lineno=372, col_offset=11, end_lineno=372, end_col_offset=29), body=[Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=373, col_offset=12, end_lineno=373, end_col_offset=18), attr='info', ctx=Load(), lineno=373, col_offset=12, end_lineno=373, end_col_offset=23), args=[Constant(value='All vectors already indexed in secondary index', lineno=374, col_offset=16, end_lineno=374, end_col_offset=64)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=375, col_offset=22, end_lineno=375, end_col_offset=32), keywords=[keyword(arg='total', value=Call(func=Name(id='len', ctx=Load(), lineno=375, col_offset=39, end_lineno=375, end_col_offset=42), args=[Name(id='new_ids', ctx=Load(), lineno=375, col_offset=43, end_lineno=375, end_col_offset=50)], lineno=375, col_offset=39, end_lineno=375, end_col_offset=51), lineno=375, col_offset=33, end_lineno=375, end_col_offset=51)], lineno=375, col_offset=22, end_lineno=375, end_col_offset=52), lineno=375, col_offset=16, end_lineno=375, end_col_offset=52)], lineno=373, col_offset=12, end_lineno=376, end_col_offset=13), lineno=373, col_offset=12, end_lineno=376, end_col_offset=13), Return(lineno=377, col_offset=12, end_lineno=377, end_col_offset=18)], lineno=372, col_offset=8, end_lineno=377, end_col_offset=18), Assign(targets=[Name(id='unique_vectors', ctx=Store(), lineno=379, col_offset=8, end_lineno=379, end_col_offset=22)], value=Subscript(value=Name(id='new_vectors', ctx=Load(), lineno=379, col_offset=25, end_lineno=379, end_col_offset=36), slice=Name(id='unique_indices', ctx=Load(), lineno=379, col_offset=37, end_lineno=379, end_col_offset=51), ctx=Load(), lineno=379, col_offset=25, end_lineno=379, end_col_offset=52), lineno=379, col_offset=8, end_lineno=379, end_col_offset=52), Assign(targets=[Name(id='unique_ids', ctx=Store(), lineno=380, col_offset=8, end_lineno=380, end_col_offset=18)], value=Subscript(value=Name(id='new_ids', ctx=Load(), lineno=380, col_offset=21, end_lineno=380, end_col_offset=28), slice=Name(id='unique_indices', ctx=Load(), lineno=380, col_offset=29, end_lineno=380, end_col_offset=43), ctx=Load(), lineno=380, col_offset=21, end_lineno=380, end_col_offset=44), lineno=380, col_offset=8, end_lineno=380, end_col_offset=44), Assign(targets=[Name(id='vectors_norm', ctx=Store(), lineno=382, col_offset=8, end_lineno=382, end_col_offset=20)], value=Call(func=Attribute(value=Name(id='unique_vectors', ctx=Load(), lineno=382, col_offset=23, end_lineno=382, end_col_offset=37), attr='copy', ctx=Load(), lineno=382, col_offset=23, end_lineno=382, end_col_offset=42), lineno=382, col_offset=23, end_lineno=382, end_col_offset=44), lineno=382, col_offset=8, end_lineno=382, end_col_offset=44), Expr(value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=383, col_offset=8, end_lineno=383, end_col_offset=13), attr='normalize_L2', ctx=Load(), lineno=383, col_offset=8, end_lineno=383, end_col_offset=26), args=[Name(id='vectors_norm', ctx=Load(), lineno=383, col_offset=27, end_lineno=383, end_col_offset=39)], lineno=383, col_offset=8, end_lineno=383, end_col_offset=40), lineno=383, col_offset=8, end_lineno=383, end_col_offset=40), Assign(targets=[Name(id='secondary_index', ctx=Store(), lineno=385, col_offset=8, end_lineno=385, end_col_offset=23)], value=Attribute(value=Name(id='self', ctx=Load(), lineno=385, col_offset=26, end_lineno=385, end_col_offset=30), attr='secondary_index', ctx=Load(), lineno=385, col_offset=26, end_lineno=385, end_col_offset=46), lineno=385, col_offset=8, end_lineno=385, end_col_offset=46), If(test=Compare(left=Name(id='secondary_index', ctx=Load(), lineno=386, col_offset=11, end_lineno=386, end_col_offset=26), ops=[Is()], comparators=[Constant(value=None, lineno=386, col_offset=30, end_lineno=386, end_col_offset=34)], lineno=386, col_offset=11, end_lineno=386, end_col_offset=34), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=387, col_offset=12, end_lineno=387, end_col_offset=15)], value=Constant(value='Secondary index missing during update_index', lineno=387, col_offset=18, end_lineno=387, end_col_offset=63), lineno=387, col_offset=12, end_lineno=387, end_col_offset=63), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=388, col_offset=18, end_lineno=388, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=388, col_offset=31, end_lineno=388, end_col_offset=34)], lineno=388, col_offset=18, end_lineno=388, end_col_offset=35), lineno=388, col_offset=12, end_lineno=388, end_col_offset=35)], lineno=386, col_offset=8, end_lineno=388, end_col_offset=35), Expr(value=Call(func=Attribute(value=Name(id='secondary_index', ctx=Load(), lineno=389, col_offset=8, end_lineno=389, end_col_offset=23), attr='add_with_ids', ctx=Load(), lineno=389, col_offset=8, end_lineno=389, end_col_offset=36), args=[Name(id='vectors_norm', ctx=Load(), lineno=389, col_offset=37, end_lineno=389, end_col_offset=49), Call(func=Attribute(value=Name(id='unique_ids', ctx=Load(), lineno=389, col_offset=51, end_lineno=389, end_col_offset=61), attr='astype', ctx=Load(), lineno=389, col_offset=51, end_lineno=389, end_col_offset=68), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=389, col_offset=69, end_lineno=389, end_col_offset=71), attr='int64', ctx=Load(), lineno=389, col_offset=69, end_lineno=389, end_col_offset=77)], lineno=389, col_offset=51, end_lineno=389, end_col_offset=78)], lineno=389, col_offset=8, end_lineno=389, end_col_offset=79), lineno=389, col_offset=8, end_lineno=389, end_col_offset=79), Expr(value=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=390, col_offset=8, end_lineno=390, end_col_offset=12), attr='incremental_ids', ctx=Load(), lineno=390, col_offset=8, end_lineno=390, end_col_offset=28), attr='update', ctx=Load(), lineno=390, col_offset=8, end_lineno=390, end_col_offset=35), args=[Call(func=Attribute(value=Name(id='unique_ids', ctx=Load(), lineno=390, col_offset=36, end_lineno=390, end_col_offset=46), attr='tolist', ctx=Load(), lineno=390, col_offset=36, end_lineno=390, end_col_offset=53), lineno=390, col_offset=36, end_lineno=390, end_col_offset=55)], lineno=390, col_offset=8, end_lineno=390, end_col_offset=56), lineno=390, col_offset=8, end_lineno=390, end_col_offset=56), Assign(targets=[Name(id='skipped', ctx=Store(), lineno=392, col_offset=8, end_lineno=392, end_col_offset=15)], value=BinOp(left=Call(func=Name(id='len', ctx=Load(), lineno=392, col_offset=18, end_lineno=392, end_col_offset=21), args=[Name(id='new_ids', ctx=Load(), lineno=392, col_offset=22, end_lineno=392, end_col_offset=29)], lineno=392, col_offset=18, end_lineno=392, end_col_offset=30), op=Sub(), right=Call(func=Name(id='len', ctx=Load(), lineno=392, col_offset=33, end_lineno=392, end_col_offset=36), args=[Name(id='unique_ids', ctx=Load(), lineno=392, col_offset=37, end_lineno=392, end_col_offset=47)], lineno=392, col_offset=33, end_lineno=392, end_col_offset=48), lineno=392, col_offset=18, end_lineno=392, end_col_offset=48), lineno=392, col_offset=8, end_lineno=392, end_col_offset=48), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=393, col_offset=8, end_lineno=393, end_col_offset=12), attr='_log_secondary_added', ctx=Load(), lineno=393, col_offset=8, end_lineno=393, end_col_offset=33), keywords=[keyword(arg='added', value=Call(func=Name(id='len', ctx=Load(), lineno=394, col_offset=18, end_lineno=394, end_col_offset=21), args=[Name(id='unique_ids', ctx=Load(), lineno=394, col_offset=22, end_lineno=394, end_col_offset=32)], lineno=394, col_offset=18, end_lineno=394, end_col_offset=33), lineno=394, col_offset=12, end_lineno=394, end_col_offset=33), keyword(arg='total_secondary_vectors', value=Call(func=Name(id='len', ctx=Load(), lineno=395, col_offset=36, end_lineno=395, end_col_offset=39), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=395, col_offset=40, end_lineno=395, end_col_offset=44), attr='incremental_ids', ctx=Load(), lineno=395, col_offset=40, end_lineno=395, end_col_offset=60)], lineno=395, col_offset=36, end_lineno=395, end_col_offset=61), lineno=395, col_offset=12, end_lineno=395, end_col_offset=61), keyword(arg='skipped_duplicates', value=Name(id='skipped', ctx=Load(), lineno=396, col_offset=31, end_lineno=396, end_col_offset=38), lineno=396, col_offset=12, end_lineno=396, end_col_offset=38)], lineno=393, col_offset=8, end_lineno=397, end_col_offset=9), lineno=393, col_offset=8, end_lineno=397, end_col_offset=9)], returns=Constant(value=None, lineno=331, col_offset=76, end_lineno=331, end_col_offset=80), lineno=331, col_offset=4, end_lineno=397, end_col_offset=9), FunctionDef(name='_ensure_secondary_index', args=arguments(args=[arg(arg='self', lineno=399, col_offset=32, end_lineno=399, end_col_offset=36)]), body=[If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=400, col_offset=11, end_lineno=400, end_col_offset=15), attr='secondary_index', ctx=Load(), lineno=400, col_offset=11, end_lineno=400, end_col_offset=31), ops=[IsNot()], comparators=[Constant(value=None, lineno=400, col_offset=39, end_lineno=400, end_col_offset=43)], lineno=400, col_offset=11, end_lineno=400, end_col_offset=43), body=[Return(lineno=401, col_offset=12, end_lineno=401, end_col_offset=18)], lineno=400, col_offset=8, end_lineno=401, end_col_offset=18), Assign(targets=[Name(id='flat_index', ctx=Store(), lineno=402, col_offset=8, end_lineno=402, end_col_offset=18)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=402, col_offset=21, end_lineno=402, end_col_offset=26), attr='IndexFlatIP', ctx=Load(), lineno=402, col_offset=21, end_lineno=402, end_col_offset=38), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=402, col_offset=39, end_lineno=402, end_col_offset=43), attr='vec_dim', ctx=Load(), lineno=402, col_offset=39, end_lineno=402, end_col_offset=51)], lineno=402, col_offset=21, end_lineno=402, end_col_offset=52), lineno=402, col_offset=8, end_lineno=402, end_col_offset=52), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=403, col_offset=8, end_lineno=403, end_col_offset=12), attr='secondary_index', ctx=Store(), lineno=403, col_offset=8, end_lineno=403, end_col_offset=28)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=403, col_offset=31, end_lineno=403, end_col_offset=36), attr='IndexIDMap2', ctx=Load(), lineno=403, col_offset=31, end_lineno=403, end_col_offset=48), args=[Name(id='flat_index', ctx=Load(), lineno=403, col_offset=49, end_lineno=403, end_col_offset=59)], lineno=403, col_offset=31, end_lineno=403, end_col_offset=60), lineno=403, col_offset=8, end_lineno=403, end_col_offset=60), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=404, col_offset=8, end_lineno=404, end_col_offset=14), attr='info', ctx=Load(), lineno=404, col_offset=8, end_lineno=404, end_col_offset=19), args=[Constant(value='Created secondary flat index for incremental updates', lineno=405, col_offset=12, end_lineno=405, end_col_offset=66)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=406, col_offset=18, end_lineno=406, end_col_offset=28), keywords=[keyword(arg='event', value=Constant(value='secondary_index_created', lineno=406, col_offset=35, end_lineno=406, end_col_offset=60), lineno=406, col_offset=29, end_lineno=406, end_col_offset=60)], lineno=406, col_offset=18, end_lineno=406, end_col_offset=61), lineno=406, col_offset=12, end_lineno=406, end_col_offset=61)], lineno=404, col_offset=8, end_lineno=407, end_col_offset=9), lineno=404, col_offset=8, end_lineno=407, end_col_offset=9)], returns=Constant(value=None, lineno=399, col_offset=41, end_lineno=399, end_col_offset=45), lineno=399, col_offset=4, end_lineno=407, end_col_offset=9), FunctionDef(name='_build_primary_contains', args=arguments(args=[arg(arg='self', lineno=409, col_offset=32, end_lineno=409, end_col_offset=36)]), body=[Try(body=[Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=411, col_offset=12, end_lineno=411, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=411, col_offset=24, end_lineno=411, end_col_offset=28), attr='_require_cpu_index', ctx=Load(), lineno=411, col_offset=24, end_lineno=411, end_col_offset=47), lineno=411, col_offset=24, end_lineno=411, end_col_offset=49), lineno=411, col_offset=12, end_lineno=411, end_col_offset=49)], handlers=[ExceptHandler(type=Name(id='RuntimeError', ctx=Load(), lineno=412, col_offset=15, end_lineno=412, end_col_offset=27), body=[Return(value=Lambda(args=arguments(args=[arg(arg='_id', lineno=413, col_offset=26, end_lineno=413, end_col_offset=29)]), body=Constant(value=False, lineno=413, col_offset=31, end_lineno=413, end_col_offset=36), lineno=413, col_offset=19, end_lineno=413, end_col_offset=36), lineno=413, col_offset=12, end_lineno=413, end_col_offset=36)], lineno=412, col_offset=8, end_lineno=413, end_col_offset=36)], lineno=410, col_offset=8, end_lineno=413, end_col_offset=36), Assign(targets=[Name(id='id_map_obj', ctx=Store(), lineno=415, col_offset=8, end_lineno=415, end_col_offset=18)], value=Call(func=Name(id='getattr', ctx=Load(), lineno=415, col_offset=21, end_lineno=415, end_col_offset=28), args=[Name(id='cpu_index', ctx=Load(), lineno=415, col_offset=29, end_lineno=415, end_col_offset=38), Constant(value='id_map', lineno=415, col_offset=40, end_lineno=415, end_col_offset=48), Constant(value=None, lineno=415, col_offset=50, end_lineno=415, end_col_offset=54)], lineno=415, col_offset=21, end_lineno=415, end_col_offset=55), lineno=415, col_offset=8, end_lineno=415, end_col_offset=55), If(test=Compare(left=Name(id='id_map_obj', ctx=Load(), lineno=416, col_offset=11, end_lineno=416, end_col_offset=21), ops=[Is()], comparators=[Constant(value=None, lineno=416, col_offset=25, end_lineno=416, end_col_offset=29)], lineno=416, col_offset=11, end_lineno=416, end_col_offset=29), body=[Return(value=Lambda(args=arguments(args=[arg(arg='_id', lineno=417, col_offset=26, end_lineno=417, end_col_offset=29)]), body=Constant(value=False, lineno=417, col_offset=31, end_lineno=417, end_col_offset=36), lineno=417, col_offset=19, end_lineno=417, end_col_offset=36), lineno=417, col_offset=12, end_lineno=417, end_col_offset=36)], lineno=416, col_offset=8, end_lineno=417, end_col_offset=36), For(target=Tuple(elts=[Name(id='attr', ctx=Store(), lineno=419, col_offset=12, end_lineno=419, end_col_offset=16), Name(id='builder', ctx=Store(), lineno=419, col_offset=18, end_lineno=419, end_col_offset=25)], ctx=Store(), lineno=419, col_offset=12, end_lineno=419, end_col_offset=25), iter=Tuple(elts=[Tuple(elts=[Constant(value='contains', lineno=420, col_offset=13, end_lineno=420, end_col_offset=23), Attribute(value=Name(id='self', ctx=Load(), lineno=420, col_offset=25, end_lineno=420, end_col_offset=29), attr='_wrap_bool_contains', ctx=Load(), lineno=420, col_offset=25, end_lineno=420, end_col_offset=49)], ctx=Load(), lineno=420, col_offset=12, end_lineno=420, end_col_offset=50), Tuple(elts=[Constant(value='search', lineno=421, col_offset=13, end_lineno=421, end_col_offset=21), Attribute(value=Name(id='self', ctx=Load(), lineno=421, col_offset=23, end_lineno=421, end_col_offset=27), attr='_wrap_index_contains', ctx=Load(), lineno=421, col_offset=23, end_lineno=421, end_col_offset=48)], ctx=Load(), lineno=421, col_offset=12, end_lineno=421, end_col_offset=49), Tuple(elts=[Constant(value='find', lineno=422, col_offset=13, end_lineno=422, end_col_offset=19), Attribute(value=Name(id='self', ctx=Load(), lineno=422, col_offset=21, end_lineno=422, end_col_offset=25), attr='_wrap_index_contains', ctx=Load(), lineno=422, col_offset=21, end_lineno=422, end_col_offset=46)], ctx=Load(), lineno=422, col_offset=12, end_lineno=422, end_col_offset=47)], ctx=Load(), lineno=419, col_offset=29, end_lineno=423, end_col_offset=9), body=[Assign(targets=[Name(id='raw', ctx=Store(), lineno=424, col_offset=12, end_lineno=424, end_col_offset=15)], value=Call(func=Name(id='getattr', ctx=Load(), lineno=424, col_offset=18, end_lineno=424, end_col_offset=25), args=[Name(id='id_map_obj', ctx=Load(), lineno=424, col_offset=26, end_lineno=424, end_col_offset=36), Name(id='attr', ctx=Load(), lineno=424, col_offset=38, end_lineno=424, end_col_offset=42), Constant(value=None, lineno=424, col_offset=44, end_lineno=424, end_col_offset=48)], lineno=424, col_offset=18, end_lineno=424, end_col_offset=49), lineno=424, col_offset=12, end_lineno=424, end_col_offset=49), If(test=Call(func=Name(id='callable', ctx=Load(), lineno=425, col_offset=15, end_lineno=425, end_col_offset=23), args=[Name(id='raw', ctx=Load(), lineno=425, col_offset=24, end_lineno=425, end_col_offset=27)], lineno=425, col_offset=15, end_lineno=425, end_col_offset=28), body=[Return(value=Call(func=Name(id='builder', ctx=Load(), lineno=426, col_offset=23, end_lineno=426, end_col_offset=30), args=[Call(func=Name(id='cast', ctx=Load(), lineno=426, col_offset=31, end_lineno=426, end_col_offset=35), args=[Constant(value='Callable[[int], object]', lineno=426, col_offset=36, end_lineno=426, end_col_offset=61), Name(id='raw', ctx=Load(), lineno=426, col_offset=63, end_lineno=426, end_col_offset=66)], lineno=426, col_offset=31, end_lineno=426, end_col_offset=67)], lineno=426, col_offset=23, end_lineno=426, end_col_offset=68), lineno=426, col_offset=16, end_lineno=426, end_col_offset=68)], lineno=425, col_offset=12, end_lineno=426, end_col_offset=68)], lineno=419, col_offset=8, end_lineno=426, end_col_offset=68), Assign(targets=[Name(id='existing_ids', ctx=Store(), lineno=428, col_offset=8, end_lineno=428, end_col_offset=20)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=428, col_offset=23, end_lineno=428, end_col_offset=27), attr='_build_existing_ids_set', ctx=Load(), lineno=428, col_offset=23, end_lineno=428, end_col_offset=51), args=[Name(id='cpu_index', ctx=Load(), lineno=428, col_offset=52, end_lineno=428, end_col_offset=61), Name(id='id_map_obj', ctx=Load(), lineno=428, col_offset=63, end_lineno=428, end_col_offset=73)], lineno=428, col_offset=23, end_lineno=428, end_col_offset=74), lineno=428, col_offset=8, end_lineno=428, end_col_offset=74), Return(value=Lambda(args=arguments(args=[arg(arg='id_val', lineno=429, col_offset=22, end_lineno=429, end_col_offset=28)]), body=Compare(left=Call(func=Name(id='int', ctx=Load(), lineno=429, col_offset=30, end_lineno=429, end_col_offset=33), args=[Name(id='id_val', ctx=Load(), lineno=429, col_offset=34, end_lineno=429, end_col_offset=40)], lineno=429, col_offset=30, end_lineno=429, end_col_offset=41), ops=[In()], comparators=[Name(id='existing_ids', ctx=Load(), lineno=429, col_offset=45, end_lineno=429, end_col_offset=57)], lineno=429, col_offset=30, end_lineno=429, end_col_offset=57), lineno=429, col_offset=15, end_lineno=429, end_col_offset=57), lineno=429, col_offset=8, end_lineno=429, end_col_offset=57)], returns=Subscript(value=Name(id='Callable', ctx=Load(), lineno=409, col_offset=41, end_lineno=409, end_col_offset=49), slice=Tuple(elts=[List(elts=[Name(id='int', ctx=Load(), lineno=409, col_offset=51, end_lineno=409, end_col_offset=54)], ctx=Load(), lineno=409, col_offset=50, end_lineno=409, end_col_offset=55), Name(id='bool', ctx=Load(), lineno=409, col_offset=57, end_lineno=409, end_col_offset=61)], ctx=Load(), lineno=409, col_offset=50, end_lineno=409, end_col_offset=61), ctx=Load(), lineno=409, col_offset=41, end_lineno=409, end_col_offset=62), lineno=409, col_offset=4, end_lineno=429, end_col_offset=57), FunctionDef(name='_wrap_bool_contains', args=arguments(args=[arg(arg='raw', annotation=Subscript(value=Name(id='Callable', ctx=Load(), lineno=432, col_offset=33, end_lineno=432, end_col_offset=41), slice=Tuple(elts=[List(elts=[Name(id='int', ctx=Load(), lineno=432, col_offset=43, end_lineno=432, end_col_offset=46)], ctx=Load(), lineno=432, col_offset=42, end_lineno=432, end_col_offset=47), Name(id='object', ctx=Load(), lineno=432, col_offset=49, end_lineno=432, end_col_offset=55)], ctx=Load(), lineno=432, col_offset=42, end_lineno=432, end_col_offset=55), ctx=Load(), lineno=432, col_offset=33, end_lineno=432, end_col_offset=56), lineno=432, col_offset=28, end_lineno=432, end_col_offset=56)]), body=[FunctionDef(name='contains', args=arguments(args=[arg(arg='id_val', annotation=Name(id='int', ctx=Load(), lineno=433, col_offset=29, end_lineno=433, end_col_offset=32), lineno=433, col_offset=21, end_lineno=433, end_col_offset=32)]), body=[Try(body=[Return(value=Call(func=Name(id='bool', ctx=Load(), lineno=435, col_offset=23, end_lineno=435, end_col_offset=27), args=[Call(func=Name(id='raw', ctx=Load(), lineno=435, col_offset=28, end_lineno=435, end_col_offset=31), args=[Call(func=Name(id='int', ctx=Load(), lineno=435, col_offset=32, end_lineno=435, end_col_offset=35), args=[Name(id='id_val', ctx=Load(), lineno=435, col_offset=36, end_lineno=435, end_col_offset=42)], lineno=435, col_offset=32, end_lineno=435, end_col_offset=43)], lineno=435, col_offset=28, end_lineno=435, end_col_offset=44)], lineno=435, col_offset=23, end_lineno=435, end_col_offset=45), lineno=435, col_offset=16, end_lineno=435, end_col_offset=45)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='TypeError', ctx=Load(), lineno=436, col_offset=20, end_lineno=436, end_col_offset=29), Name(id='ValueError', ctx=Load(), lineno=436, col_offset=31, end_lineno=436, end_col_offset=41)], ctx=Load(), lineno=436, col_offset=19, end_lineno=436, end_col_offset=42), body=[Return(value=Constant(value=False, lineno=437, col_offset=23, end_lineno=437, end_col_offset=28), lineno=437, col_offset=16, end_lineno=437, end_col_offset=28)], lineno=436, col_offset=12, end_lineno=437, end_col_offset=28)], lineno=434, col_offset=12, end_lineno=437, end_col_offset=28)], returns=Name(id='bool', ctx=Load(), lineno=433, col_offset=37, end_lineno=433, end_col_offset=41), lineno=433, col_offset=8, end_lineno=437, end_col_offset=28), Return(value=Name(id='contains', ctx=Load(), lineno=439, col_offset=15, end_lineno=439, end_col_offset=23), lineno=439, col_offset=8, end_lineno=439, end_col_offset=23)], decorator_list=[Name(id='staticmethod', ctx=Load(), lineno=431, col_offset=5, end_lineno=431, end_col_offset=17)], returns=Subscript(value=Name(id='Callable', ctx=Load(), lineno=432, col_offset=61, end_lineno=432, end_col_offset=69), slice=Tuple(elts=[List(elts=[Name(id='int', ctx=Load(), lineno=432, col_offset=71, end_lineno=432, end_col_offset=74)], ctx=Load(), lineno=432, col_offset=70, end_lineno=432, end_col_offset=75), Name(id='bool', ctx=Load(), lineno=432, col_offset=77, end_lineno=432, end_col_offset=81)], ctx=Load(), lineno=432, col_offset=70, end_lineno=432, end_col_offset=81), ctx=Load(), lineno=432, col_offset=61, end_lineno=432, end_col_offset=82), lineno=432, col_offset=4, end_lineno=439, end_col_offset=23), FunctionDef(name='_wrap_index_contains', args=arguments(args=[arg(arg='raw', annotation=Subscript(value=Name(id='Callable', ctx=Load(), lineno=442, col_offset=34, end_lineno=442, end_col_offset=42), slice=Tuple(elts=[List(elts=[Name(id='int', ctx=Load(), lineno=442, col_offset=44, end_lineno=442, end_col_offset=47)], ctx=Load(), lineno=442, col_offset=43, end_lineno=442, end_col_offset=48), Name(id='object', ctx=Load(), lineno=442, col_offset=50, end_lineno=442, end_col_offset=56)], ctx=Load(), lineno=442, col_offset=43, end_lineno=442, end_col_offset=56), ctx=Load(), lineno=442, col_offset=34, end_lineno=442, end_col_offset=57), lineno=442, col_offset=29, end_lineno=442, end_col_offset=57)]), body=[FunctionDef(name='contains', args=arguments(args=[arg(arg='id_val', annotation=Name(id='int', ctx=Load(), lineno=443, col_offset=29, end_lineno=443, end_col_offset=32), lineno=443, col_offset=21, end_lineno=443, end_col_offset=32)]), body=[Try(body=[Assign(targets=[Name(id='result', ctx=Store(), lineno=445, col_offset=16, end_lineno=445, end_col_offset=22)], value=Call(func=Name(id='raw', ctx=Load(), lineno=445, col_offset=25, end_lineno=445, end_col_offset=28), args=[Call(func=Name(id='int', ctx=Load(), lineno=445, col_offset=29, end_lineno=445, end_col_offset=32), args=[Name(id='id_val', ctx=Load(), lineno=445, col_offset=33, end_lineno=445, end_col_offset=39)], lineno=445, col_offset=29, end_lineno=445, end_col_offset=40)], lineno=445, col_offset=25, end_lineno=445, end_col_offset=41), lineno=445, col_offset=16, end_lineno=445, end_col_offset=41)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='TypeError', ctx=Load(), lineno=446, col_offset=20, end_lineno=446, end_col_offset=29), Name(id='ValueError', ctx=Load(), lineno=446, col_offset=31, end_lineno=446, end_col_offset=41)], ctx=Load(), lineno=446, col_offset=19, end_lineno=446, end_col_offset=42), body=[Return(value=Constant(value=False, lineno=447, col_offset=23, end_lineno=447, end_col_offset=28), lineno=447, col_offset=16, end_lineno=447, end_col_offset=28)], lineno=446, col_offset=12, end_lineno=447, end_col_offset=28)], lineno=444, col_offset=12, end_lineno=447, end_col_offset=28), Return(value=Compare(left=Call(func=Name(id='_coerce_to_int', ctx=Load(), lineno=449, col_offset=19, end_lineno=449, end_col_offset=33), args=[Name(id='result', ctx=Load(), lineno=449, col_offset=34, end_lineno=449, end_col_offset=40)], lineno=449, col_offset=19, end_lineno=449, end_col_offset=41), ops=[GtE()], comparators=[Constant(value=0, lineno=449, col_offset=45, end_lineno=449, end_col_offset=46)], lineno=449, col_offset=19, end_lineno=449, end_col_offset=46), lineno=449, col_offset=12, end_lineno=449, end_col_offset=46)], returns=Name(id='bool', ctx=Load(), lineno=443, col_offset=37, end_lineno=443, end_col_offset=41), lineno=443, col_offset=8, end_lineno=449, end_col_offset=46), Return(value=Name(id='contains', ctx=Load(), lineno=451, col_offset=15, end_lineno=451, end_col_offset=23), lineno=451, col_offset=8, end_lineno=451, end_col_offset=23)], decorator_list=[Name(id='staticmethod', ctx=Load(), lineno=441, col_offset=5, end_lineno=441, end_col_offset=17)], returns=Subscript(value=Name(id='Callable', ctx=Load(), lineno=442, col_offset=62, end_lineno=442, end_col_offset=70), slice=Tuple(elts=[List(elts=[Name(id='int', ctx=Load(), lineno=442, col_offset=72, end_lineno=442, end_col_offset=75)], ctx=Load(), lineno=442, col_offset=71, end_lineno=442, end_col_offset=76), Name(id='bool', ctx=Load(), lineno=442, col_offset=78, end_lineno=442, end_col_offset=82)], ctx=Load(), lineno=442, col_offset=71, end_lineno=442, end_col_offset=82), ctx=Load(), lineno=442, col_offset=62, end_lineno=442, end_col_offset=83), lineno=442, col_offset=4, end_lineno=451, end_col_offset=23), FunctionDef(name='_build_existing_ids_set', args=arguments(args=[arg(arg='cpu_index', annotation=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=454, col_offset=43, end_lineno=454, end_col_offset=49), attr='Index', ctx=Load(), lineno=454, col_offset=43, end_lineno=454, end_col_offset=55), lineno=454, col_offset=32, end_lineno=454, end_col_offset=55), arg(arg='id_map_obj', annotation=Name(id='object', ctx=Load(), lineno=454, col_offset=69, end_lineno=454, end_col_offset=75), lineno=454, col_offset=57, end_lineno=454, end_col_offset=75)]), body=[Try(body=[Assign(targets=[Name(id='n_total', ctx=Store(), lineno=456, col_offset=12, end_lineno=456, end_col_offset=19)], value=Attribute(value=Name(id='cpu_index', ctx=Load(), lineno=456, col_offset=22, end_lineno=456, end_col_offset=31), attr='ntotal', ctx=Load(), lineno=456, col_offset=22, end_lineno=456, end_col_offset=38), lineno=456, col_offset=12, end_lineno=456, end_col_offset=38)], handlers=[ExceptHandler(type=Name(id='AttributeError', ctx=Load(), lineno=457, col_offset=15, end_lineno=457, end_col_offset=29), body=[Return(value=Call(func=Name(id='set', ctx=Load(), lineno=458, col_offset=19, end_lineno=458, end_col_offset=22), lineno=458, col_offset=19, end_lineno=458, end_col_offset=24), lineno=458, col_offset=12, end_lineno=458, end_col_offset=24)], lineno=457, col_offset=8, end_lineno=458, end_col_offset=24)], lineno=455, col_offset=8, end_lineno=458, end_col_offset=24), Try(body=[If(test=Compare(left=Name(id='id_map_obj', ctx=Load(), lineno=461, col_offset=15, end_lineno=461, end_col_offset=25), ops=[Is()], comparators=[Constant(value=None, lineno=461, col_offset=29, end_lineno=461, end_col_offset=33)], lineno=461, col_offset=15, end_lineno=461, end_col_offset=33), body=[Return(value=Call(func=Name(id='set', ctx=Load(), lineno=462, col_offset=23, end_lineno=462, end_col_offset=26), lineno=462, col_offset=23, end_lineno=462, end_col_offset=28), lineno=462, col_offset=16, end_lineno=462, end_col_offset=28)], lineno=461, col_offset=12, end_lineno=462, end_col_offset=28), Assign(targets=[Name(id='at_raw', ctx=Store(), lineno=463, col_offset=12, end_lineno=463, end_col_offset=18)], value=Call(func=Name(id='getattr', ctx=Load(), lineno=463, col_offset=21, end_lineno=463, end_col_offset=28), args=[Name(id='id_map_obj', ctx=Load(), lineno=463, col_offset=29, end_lineno=463, end_col_offset=39), Constant(value='at', lineno=463, col_offset=41, end_lineno=463, end_col_offset=45), Constant(value=None, lineno=463, col_offset=47, end_lineno=463, end_col_offset=51)], lineno=463, col_offset=21, end_lineno=463, end_col_offset=52), lineno=463, col_offset=12, end_lineno=463, end_col_offset=52), If(test=UnaryOp(op=Not(), operand=Call(func=Name(id='callable', ctx=Load(), lineno=464, col_offset=19, end_lineno=464, end_col_offset=27), args=[Name(id='at_raw', ctx=Load(), lineno=464, col_offset=28, end_lineno=464, end_col_offset=34)], lineno=464, col_offset=19, end_lineno=464, end_col_offset=35), lineno=464, col_offset=15, end_lineno=464, end_col_offset=35), body=[Return(value=Call(func=Name(id='set', ctx=Load(), lineno=465, col_offset=23, end_lineno=465, end_col_offset=26), lineno=465, col_offset=23, end_lineno=465, end_col_offset=28), lineno=465, col_offset=16, end_lineno=465, end_col_offset=28)], lineno=464, col_offset=12, end_lineno=465, end_col_offset=28), Assign(targets=[Name(id='at_callable', ctx=Store(), lineno=466, col_offset=12, end_lineno=466, end_col_offset=23)], value=Call(func=Name(id='cast', ctx=Load(), lineno=466, col_offset=26, end_lineno=466, end_col_offset=30), args=[Constant(value='Callable[[int], int]', lineno=466, col_offset=31, end_lineno=466, end_col_offset=53), Name(id='at_raw', ctx=Load(), lineno=466, col_offset=55, end_lineno=466, end_col_offset=61)], lineno=466, col_offset=26, end_lineno=466, end_col_offset=62), lineno=466, col_offset=12, end_lineno=466, end_col_offset=62), Return(value=SetComp(elt=Call(func=Name(id='int', ctx=Load(), lineno=467, col_offset=20, end_lineno=467, end_col_offset=23), args=[Call(func=Name(id='at_callable', ctx=Load(), lineno=467, col_offset=24, end_lineno=467, end_col_offset=35), args=[Name(id='idx', ctx=Load(), lineno=467, col_offset=36, end_lineno=467, end_col_offset=39)], lineno=467, col_offset=24, end_lineno=467, end_col_offset=40)], lineno=467, col_offset=20, end_lineno=467, end_col_offset=41), generators=[comprehension(target=Name(id='idx', ctx=Store(), lineno=467, col_offset=46, end_lineno=467, end_col_offset=49), iter=Call(func=Name(id='range', ctx=Load(), lineno=467, col_offset=53, end_lineno=467, end_col_offset=58), args=[Name(id='n_total', ctx=Load(), lineno=467, col_offset=59, end_lineno=467, end_col_offset=66)], lineno=467, col_offset=53, end_lineno=467, end_col_offset=67), is_async=0)], lineno=467, col_offset=19, end_lineno=467, end_col_offset=68), lineno=467, col_offset=12, end_lineno=467, end_col_offset=68)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='AttributeError', ctx=Load(), lineno=468, col_offset=16, end_lineno=468, end_col_offset=30), Name(id='TypeError', ctx=Load(), lineno=468, col_offset=32, end_lineno=468, end_col_offset=41), Name(id='ValueError', ctx=Load(), lineno=468, col_offset=43, end_lineno=468, end_col_offset=53)], ctx=Load(), lineno=468, col_offset=15, end_lineno=468, end_col_offset=54), body=[Return(value=Call(func=Name(id='set', ctx=Load(), lineno=469, col_offset=19, end_lineno=469, end_col_offset=22), lineno=469, col_offset=19, end_lineno=469, end_col_offset=24), lineno=469, col_offset=12, end_lineno=469, end_col_offset=24)], lineno=468, col_offset=8, end_lineno=469, end_col_offset=24)], lineno=460, col_offset=8, end_lineno=469, end_col_offset=24)], decorator_list=[Name(id='staticmethod', ctx=Load(), lineno=453, col_offset=5, end_lineno=453, end_col_offset=17)], returns=Subscript(value=Name(id='set', ctx=Load(), lineno=454, col_offset=80, end_lineno=454, end_col_offset=83), slice=Name(id='int', ctx=Load(), lineno=454, col_offset=84, end_lineno=454, end_col_offset=87), ctx=Load(), lineno=454, col_offset=80, end_lineno=454, end_col_offset=88), lineno=454, col_offset=4, end_lineno=469, end_col_offset=24), FunctionDef(name='_collect_unique_indices', args=arguments(args=[arg(arg='self', lineno=472, col_offset=8, end_lineno=472, end_col_offset=12), arg(arg='new_ids', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=472, col_offset=23, end_lineno=472, end_col_offset=25), attr='ndarray', ctx=Load(), lineno=472, col_offset=23, end_lineno=472, end_col_offset=33), lineno=472, col_offset=14, end_lineno=472, end_col_offset=33), arg(arg='primary_contains', annotation=Subscript(value=Name(id='Callable', ctx=Load(), lineno=472, col_offset=53, end_lineno=472, end_col_offset=61), slice=Tuple(elts=[List(elts=[Name(id='int', ctx=Load(), lineno=472, col_offset=63, end_lineno=472, end_col_offset=66)], ctx=Load(), lineno=472, col_offset=62, end_lineno=472, end_col_offset=67), Name(id='bool', ctx=Load(), lineno=472, col_offset=69, end_lineno=472, end_col_offset=73)], ctx=Load(), lineno=472, col_offset=62, end_lineno=472, end_col_offset=73), ctx=Load(), lineno=472, col_offset=53, end_lineno=472, end_col_offset=74), lineno=472, col_offset=35, end_lineno=472, end_col_offset=74)]), body=[AnnAssign(target=Name(id='unique_indices', ctx=Store(), lineno=474, col_offset=8, end_lineno=474, end_col_offset=22), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=474, col_offset=24, end_lineno=474, end_col_offset=28), slice=Name(id='int', ctx=Load(), lineno=474, col_offset=29, end_lineno=474, end_col_offset=32), ctx=Load(), lineno=474, col_offset=24, end_lineno=474, end_col_offset=33), value=List(ctx=Load(), lineno=474, col_offset=36, end_lineno=474, end_col_offset=38), simple=1, lineno=474, col_offset=8, end_lineno=474, end_col_offset=38), AnnAssign(target=Name(id='seen_in_batch', ctx=Store(), lineno=475, col_offset=8, end_lineno=475, end_col_offset=21), annotation=Subscript(value=Name(id='set', ctx=Load(), lineno=475, col_offset=23, end_lineno=475, end_col_offset=26), slice=Name(id='int', ctx=Load(), lineno=475, col_offset=27, end_lineno=475, end_col_offset=30), ctx=Load(), lineno=475, col_offset=23, end_lineno=475, end_col_offset=31), value=Call(func=Name(id='set', ctx=Load(), lineno=475, col_offset=34, end_lineno=475, end_col_offset=37), lineno=475, col_offset=34, end_lineno=475, end_col_offset=39), simple=1, lineno=475, col_offset=8, end_lineno=475, end_col_offset=39), For(target=Tuple(elts=[Name(id='offset', ctx=Store(), lineno=477, col_offset=12, end_lineno=477, end_col_offset=18), Name(id='id_val', ctx=Store(), lineno=477, col_offset=20, end_lineno=477, end_col_offset=26)], ctx=Store(), lineno=477, col_offset=12, end_lineno=477, end_col_offset=26), iter=Call(func=Name(id='enumerate', ctx=Load(), lineno=477, col_offset=30, end_lineno=477, end_col_offset=39), args=[Call(func=Attribute(value=Name(id='new_ids', ctx=Load(), lineno=477, col_offset=40, end_lineno=477, end_col_offset=47), attr='tolist', ctx=Load(), lineno=477, col_offset=40, end_lineno=477, end_col_offset=54), lineno=477, col_offset=40, end_lineno=477, end_col_offset=56)], lineno=477, col_offset=30, end_lineno=477, end_col_offset=57), body=[Assign(targets=[Name(id='id_int', ctx=Store(), lineno=478, col_offset=12, end_lineno=478, end_col_offset=18)], value=Call(func=Name(id='int', ctx=Load(), lineno=478, col_offset=21, end_lineno=478, end_col_offset=24), args=[Name(id='id_val', ctx=Load(), lineno=478, col_offset=25, end_lineno=478, end_col_offset=31)], lineno=478, col_offset=21, end_lineno=478, end_col_offset=32), lineno=478, col_offset=12, end_lineno=478, end_col_offset=32), If(test=Compare(left=Name(id='id_int', ctx=Load(), lineno=479, col_offset=15, end_lineno=479, end_col_offset=21), ops=[In()], comparators=[Name(id='seen_in_batch', ctx=Load(), lineno=479, col_offset=25, end_lineno=479, end_col_offset=38)], lineno=479, col_offset=15, end_lineno=479, end_col_offset=38), body=[Continue(lineno=480, col_offset=16, end_lineno=480, end_col_offset=24)], lineno=479, col_offset=12, end_lineno=480, end_col_offset=24), Expr(value=Call(func=Attribute(value=Name(id='seen_in_batch', ctx=Load(), lineno=481, col_offset=12, end_lineno=481, end_col_offset=25), attr='add', ctx=Load(), lineno=481, col_offset=12, end_lineno=481, end_col_offset=29), args=[Name(id='id_int', ctx=Load(), lineno=481, col_offset=30, end_lineno=481, end_col_offset=36)], lineno=481, col_offset=12, end_lineno=481, end_col_offset=37), lineno=481, col_offset=12, end_lineno=481, end_col_offset=37), If(test=Compare(left=Name(id='id_int', ctx=Load(), lineno=482, col_offset=15, end_lineno=482, end_col_offset=21), ops=[In()], comparators=[Attribute(value=Name(id='self', ctx=Load(), lineno=482, col_offset=25, end_lineno=482, end_col_offset=29), attr='incremental_ids', ctx=Load(), lineno=482, col_offset=25, end_lineno=482, end_col_offset=45)], lineno=482, col_offset=15, end_lineno=482, end_col_offset=45), body=[Continue(lineno=483, col_offset=16, end_lineno=483, end_col_offset=24)], lineno=482, col_offset=12, end_lineno=483, end_col_offset=24), If(test=Call(func=Name(id='primary_contains', ctx=Load(), lineno=484, col_offset=15, end_lineno=484, end_col_offset=31), args=[Name(id='id_int', ctx=Load(), lineno=484, col_offset=32, end_lineno=484, end_col_offset=38)], lineno=484, col_offset=15, end_lineno=484, end_col_offset=39), body=[Continue(lineno=485, col_offset=16, end_lineno=485, end_col_offset=24)], lineno=484, col_offset=12, end_lineno=485, end_col_offset=24), Expr(value=Call(func=Attribute(value=Name(id='unique_indices', ctx=Load(), lineno=486, col_offset=12, end_lineno=486, end_col_offset=26), attr='append', ctx=Load(), lineno=486, col_offset=12, end_lineno=486, end_col_offset=33), args=[Name(id='offset', ctx=Load(), lineno=486, col_offset=34, end_lineno=486, end_col_offset=40)], lineno=486, col_offset=12, end_lineno=486, end_col_offset=41), lineno=486, col_offset=12, end_lineno=486, end_col_offset=41)], lineno=477, col_offset=8, end_lineno=486, end_col_offset=41), Return(value=Name(id='unique_indices', ctx=Load(), lineno=488, col_offset=15, end_lineno=488, end_col_offset=29), lineno=488, col_offset=8, end_lineno=488, end_col_offset=29)], returns=Subscript(value=Name(id='list', ctx=Load(), lineno=473, col_offset=9, end_lineno=473, end_col_offset=13), slice=Name(id='int', ctx=Load(), lineno=473, col_offset=14, end_lineno=473, end_col_offset=17), ctx=Load(), lineno=473, col_offset=9, end_lineno=473, end_col_offset=18), lineno=471, col_offset=4, end_lineno=488, end_col_offset=29), FunctionDef(name='_log_secondary_added', args=arguments(kwonlyargs=[arg(arg='added', annotation=Name(id='int', ctx=Load(), lineno=493, col_offset=15, end_lineno=493, end_col_offset=18), lineno=493, col_offset=8, end_lineno=493, end_col_offset=18), arg(arg='total_secondary_vectors', annotation=Name(id='int', ctx=Load(), lineno=494, col_offset=33, end_lineno=494, end_col_offset=36), lineno=494, col_offset=8, end_lineno=494, end_col_offset=36), arg(arg='skipped_duplicates', annotation=Name(id='int', ctx=Load(), lineno=495, col_offset=28, end_lineno=495, end_col_offset=31), lineno=495, col_offset=8, end_lineno=495, end_col_offset=31)], kw_defaults=[None, None, None]), body=[Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=497, col_offset=8, end_lineno=497, end_col_offset=14), attr='info', ctx=Load(), lineno=497, col_offset=8, end_lineno=497, end_col_offset=19), args=[Constant(value='Added vectors to secondary index', lineno=498, col_offset=12, end_lineno=498, end_col_offset=46)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=499, col_offset=18, end_lineno=499, end_col_offset=28), keywords=[keyword(arg='added', value=Name(id='added', ctx=Load(), lineno=500, col_offset=22, end_lineno=500, end_col_offset=27), lineno=500, col_offset=16, end_lineno=500, end_col_offset=27), keyword(arg='total_secondary_vectors', value=Name(id='total_secondary_vectors', ctx=Load(), lineno=501, col_offset=40, end_lineno=501, end_col_offset=63), lineno=501, col_offset=16, end_lineno=501, end_col_offset=63), keyword(arg='skipped_duplicates', value=Name(id='skipped_duplicates', ctx=Load(), lineno=502, col_offset=35, end_lineno=502, end_col_offset=53), lineno=502, col_offset=16, end_lineno=502, end_col_offset=53)], lineno=499, col_offset=18, end_lineno=503, end_col_offset=13), lineno=499, col_offset=12, end_lineno=503, end_col_offset=13)], lineno=497, col_offset=8, end_lineno=504, end_col_offset=9), lineno=497, col_offset=8, end_lineno=504, end_col_offset=9)], decorator_list=[Name(id='staticmethod', ctx=Load(), lineno=490, col_offset=5, end_lineno=490, end_col_offset=17)], returns=Constant(value=None, lineno=496, col_offset=9, end_lineno=496, end_col_offset=13), lineno=491, col_offset=4, end_lineno=504, end_col_offset=9), FunctionDef(name='save_cpu_index', args=arguments(args=[arg(arg='self', lineno=506, col_offset=23, end_lineno=506, end_col_offset=27)]), body=[Expr(value=Constant(value="Save CPU index to disk for persistence.\n\n        Writes the current CPU index to the file specified by index_path. The\n        index can be loaded later with load_cpu_index() to avoid rebuilding.\n        The parent directory is created if it doesn't exist.\n\n        The saved index includes all vectors and IDs that have been added. This\n        is the CPU version - GPU indexes are cloned on-demand and not persisted.\n\n        Raises\n        ------\n        RuntimeError\n            If the index has not been built yet. Call build_index() first.\n        ", lineno=507, col_offset=8, end_lineno=520, end_col_offset=11), lineno=507, col_offset=8, end_lineno=520, end_col_offset=11), Try(body=[Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=522, col_offset=12, end_lineno=522, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=522, col_offset=24, end_lineno=522, end_col_offset=28), attr='_require_cpu_index', ctx=Load(), lineno=522, col_offset=24, end_lineno=522, end_col_offset=47), lineno=522, col_offset=24, end_lineno=522, end_col_offset=49), lineno=522, col_offset=12, end_lineno=522, end_col_offset=49)], handlers=[ExceptHandler(type=Name(id='RuntimeError', ctx=Load(), lineno=523, col_offset=15, end_lineno=523, end_col_offset=27), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=524, col_offset=12, end_lineno=524, end_col_offset=15)], value=Constant(value='Cannot save index: FAISS index has not been built or loaded.', lineno=524, col_offset=18, end_lineno=524, end_col_offset=80), lineno=524, col_offset=12, end_lineno=524, end_col_offset=80), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=525, col_offset=18, end_lineno=525, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=525, col_offset=31, end_lineno=525, end_col_offset=34)], lineno=525, col_offset=18, end_lineno=525, end_col_offset=35), cause=Name(id='exc', ctx=Load(), lineno=525, col_offset=41, end_lineno=525, end_col_offset=44), lineno=525, col_offset=12, end_lineno=525, end_col_offset=44)], lineno=523, col_offset=8, end_lineno=525, end_col_offset=44)], lineno=521, col_offset=8, end_lineno=525, end_col_offset=44), Expr(value=Call(func=Attribute(value=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=527, col_offset=8, end_lineno=527, end_col_offset=12), attr='index_path', ctx=Load(), lineno=527, col_offset=8, end_lineno=527, end_col_offset=23), attr='parent', ctx=Load(), lineno=527, col_offset=8, end_lineno=527, end_col_offset=30), attr='mkdir', ctx=Load(), lineno=527, col_offset=8, end_lineno=527, end_col_offset=36), keywords=[keyword(arg='parents', value=Constant(value=True, lineno=527, col_offset=45, end_lineno=527, end_col_offset=49), lineno=527, col_offset=37, end_lineno=527, end_col_offset=49), keyword(arg='exist_ok', value=Constant(value=True, lineno=527, col_offset=60, end_lineno=527, end_col_offset=64), lineno=527, col_offset=51, end_lineno=527, end_col_offset=64)], lineno=527, col_offset=8, end_lineno=527, end_col_offset=65), lineno=527, col_offset=8, end_lineno=527, end_col_offset=65), Expr(value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=528, col_offset=8, end_lineno=528, end_col_offset=13), attr='write_index', ctx=Load(), lineno=528, col_offset=8, end_lineno=528, end_col_offset=25), args=[Name(id='cpu_index', ctx=Load(), lineno=528, col_offset=26, end_lineno=528, end_col_offset=35), Call(func=Name(id='str', ctx=Load(), lineno=528, col_offset=37, end_lineno=528, end_col_offset=40), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=528, col_offset=41, end_lineno=528, end_col_offset=45), attr='index_path', ctx=Load(), lineno=528, col_offset=41, end_lineno=528, end_col_offset=56)], lineno=528, col_offset=37, end_lineno=528, end_col_offset=57)], lineno=528, col_offset=8, end_lineno=528, end_col_offset=58), lineno=528, col_offset=8, end_lineno=528, end_col_offset=58)], returns=Constant(value=None, lineno=506, col_offset=32, end_lineno=506, end_col_offset=36), lineno=506, col_offset=4, end_lineno=528, end_col_offset=58), FunctionDef(name='load_cpu_index', args=arguments(args=[arg(arg='self', lineno=530, col_offset=23, end_lineno=530, end_col_offset=27)]), body=[Expr(value=Constant(value='Load CPU index from disk.\n\n        Reads a previously saved FAISS index from index_path and loads it into\n        memory. This allows reusing an index without rebuilding it, which is much\n        faster for large indexes.\n\n        After loading, you can call clone_to_gpu() to create a GPU version for\n        faster search, or use search() directly with the CPU index.\n\n        Raises\n        ------\n        FileNotFoundError\n            If the index file does not exist at index_path. Ensure the index was\n            saved with save_cpu_index() or that the path is correct.\n        ', lineno=531, col_offset=8, end_lineno=545, end_col_offset=11), lineno=531, col_offset=8, end_lineno=545, end_col_offset=11), If(test=UnaryOp(op=Not(), operand=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=546, col_offset=15, end_lineno=546, end_col_offset=19), attr='index_path', ctx=Load(), lineno=546, col_offset=15, end_lineno=546, end_col_offset=30), attr='exists', ctx=Load(), lineno=546, col_offset=15, end_lineno=546, end_col_offset=37), lineno=546, col_offset=15, end_lineno=546, end_col_offset=39), lineno=546, col_offset=11, end_lineno=546, end_col_offset=39), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=547, col_offset=12, end_lineno=547, end_col_offset=15)], value=JoinedStr(values=[Constant(value='Index not found: ', lineno=547, col_offset=20, end_lineno=547, end_col_offset=37), FormattedValue(value=Attribute(value=Name(id='self', ctx=Load(), lineno=547, col_offset=38, end_lineno=547, end_col_offset=42), attr='index_path', ctx=Load(), lineno=547, col_offset=38, end_lineno=547, end_col_offset=53), conversion=-1, lineno=547, col_offset=37, end_lineno=547, end_col_offset=54)], lineno=547, col_offset=18, end_lineno=547, end_col_offset=55), lineno=547, col_offset=12, end_lineno=547, end_col_offset=55), Raise(exc=Call(func=Name(id='FileNotFoundError', ctx=Load(), lineno=548, col_offset=18, end_lineno=548, end_col_offset=35), args=[Name(id='msg', ctx=Load(), lineno=548, col_offset=36, end_lineno=548, end_col_offset=39)], lineno=548, col_offset=18, end_lineno=548, end_col_offset=40), lineno=548, col_offset=12, end_lineno=548, end_col_offset=40)], lineno=546, col_offset=8, end_lineno=548, end_col_offset=40), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=550, col_offset=8, end_lineno=550, end_col_offset=12), attr='cpu_index', ctx=Store(), lineno=550, col_offset=8, end_lineno=550, end_col_offset=22)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=550, col_offset=25, end_lineno=550, end_col_offset=30), attr='read_index', ctx=Load(), lineno=550, col_offset=25, end_lineno=550, end_col_offset=41), args=[Call(func=Name(id='str', ctx=Load(), lineno=550, col_offset=42, end_lineno=550, end_col_offset=45), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=550, col_offset=46, end_lineno=550, end_col_offset=50), attr='index_path', ctx=Load(), lineno=550, col_offset=46, end_lineno=550, end_col_offset=61)], lineno=550, col_offset=42, end_lineno=550, end_col_offset=62)], lineno=550, col_offset=25, end_lineno=550, end_col_offset=63), lineno=550, col_offset=8, end_lineno=550, end_col_offset=63)], returns=Constant(value=None, lineno=530, col_offset=32, end_lineno=530, end_col_offset=36), lineno=530, col_offset=4, end_lineno=550, end_col_offset=63), FunctionDef(name='save_secondary_index', args=arguments(args=[arg(arg='self', lineno=552, col_offset=29, end_lineno=552, end_col_offset=33)]), body=[Expr(value=Constant(value='Save secondary index to disk.\n\n        Writes the current secondary index (if it exists) to a separate file\n        alongside the primary index. The secondary index file uses the same\n        name as the primary index with a `.secondary` suffix.\n\n        This allows persisting incremental updates so they can be restored\n        after restart. The secondary index is saved independently from the\n        primary index.\n\n        Raises\n        ------\n        RuntimeError\n            If the secondary index has not been created yet. Call update_index()\n            first to create the secondary index.\n        ', lineno=553, col_offset=8, end_lineno=568, end_col_offset=11), lineno=553, col_offset=8, end_lineno=568, end_col_offset=11), If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=569, col_offset=11, end_lineno=569, end_col_offset=15), attr='secondary_index', ctx=Load(), lineno=569, col_offset=11, end_lineno=569, end_col_offset=31), ops=[Is()], comparators=[Constant(value=None, lineno=569, col_offset=35, end_lineno=569, end_col_offset=39)], lineno=569, col_offset=11, end_lineno=569, end_col_offset=39), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=570, col_offset=12, end_lineno=570, end_col_offset=15)], value=Constant(value='Cannot save secondary index: secondary index has not been created.', lineno=570, col_offset=18, end_lineno=570, end_col_offset=86), lineno=570, col_offset=12, end_lineno=570, end_col_offset=86), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=571, col_offset=18, end_lineno=571, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=571, col_offset=31, end_lineno=571, end_col_offset=34)], lineno=571, col_offset=18, end_lineno=571, end_col_offset=35), lineno=571, col_offset=12, end_lineno=571, end_col_offset=35)], lineno=569, col_offset=8, end_lineno=571, end_col_offset=35), Expr(value=Call(func=Attribute(value=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=573, col_offset=8, end_lineno=573, end_col_offset=12), attr='secondary_index_path', ctx=Load(), lineno=573, col_offset=8, end_lineno=573, end_col_offset=33), attr='parent', ctx=Load(), lineno=573, col_offset=8, end_lineno=573, end_col_offset=40), attr='mkdir', ctx=Load(), lineno=573, col_offset=8, end_lineno=573, end_col_offset=46), keywords=[keyword(arg='parents', value=Constant(value=True, lineno=573, col_offset=55, end_lineno=573, end_col_offset=59), lineno=573, col_offset=47, end_lineno=573, end_col_offset=59), keyword(arg='exist_ok', value=Constant(value=True, lineno=573, col_offset=70, end_lineno=573, end_col_offset=74), lineno=573, col_offset=61, end_lineno=573, end_col_offset=74)], lineno=573, col_offset=8, end_lineno=573, end_col_offset=75), lineno=573, col_offset=8, end_lineno=573, end_col_offset=75), Expr(value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=574, col_offset=8, end_lineno=574, end_col_offset=13), attr='write_index', ctx=Load(), lineno=574, col_offset=8, end_lineno=574, end_col_offset=25), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=574, col_offset=26, end_lineno=574, end_col_offset=30), attr='secondary_index', ctx=Load(), lineno=574, col_offset=26, end_lineno=574, end_col_offset=46), Call(func=Name(id='str', ctx=Load(), lineno=574, col_offset=48, end_lineno=574, end_col_offset=51), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=574, col_offset=52, end_lineno=574, end_col_offset=56), attr='secondary_index_path', ctx=Load(), lineno=574, col_offset=52, end_lineno=574, end_col_offset=77)], lineno=574, col_offset=48, end_lineno=574, end_col_offset=78)], lineno=574, col_offset=8, end_lineno=574, end_col_offset=79), lineno=574, col_offset=8, end_lineno=574, end_col_offset=79), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=575, col_offset=8, end_lineno=575, end_col_offset=14), attr='info', ctx=Load(), lineno=575, col_offset=8, end_lineno=575, end_col_offset=19), args=[Constant(value='Persisted secondary FAISS index', lineno=576, col_offset=12, end_lineno=576, end_col_offset=45)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=577, col_offset=18, end_lineno=577, end_col_offset=28), keywords=[keyword(arg='path', value=Call(func=Name(id='str', ctx=Load(), lineno=577, col_offset=34, end_lineno=577, end_col_offset=37), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=577, col_offset=38, end_lineno=577, end_col_offset=42), attr='secondary_index_path', ctx=Load(), lineno=577, col_offset=38, end_lineno=577, end_col_offset=63)], lineno=577, col_offset=34, end_lineno=577, end_col_offset=64), lineno=577, col_offset=29, end_lineno=577, end_col_offset=64)], lineno=577, col_offset=18, end_lineno=577, end_col_offset=65), lineno=577, col_offset=12, end_lineno=577, end_col_offset=65)], lineno=575, col_offset=8, end_lineno=578, end_col_offset=9), lineno=575, col_offset=8, end_lineno=578, end_col_offset=9)], returns=Constant(value=None, lineno=552, col_offset=38, end_lineno=552, end_col_offset=42), lineno=552, col_offset=4, end_lineno=578, end_col_offset=9), FunctionDef(name='load_secondary_index', args=arguments(args=[arg(arg='self', lineno=580, col_offset=29, end_lineno=580, end_col_offset=33)]), body=[Expr(value=Constant(value='Load secondary index from disk.\n\n        Reads a previously saved secondary FAISS index from disk and loads it\n        into memory. This restores incremental updates that were made in a\n        previous session.\n\n        After loading, the secondary index will be automatically searched\n        alongside the primary index when using search(). The incremental_ids\n        set is restored from the index contents.\n\n        Raises\n        ------\n        FileNotFoundError\n            If the secondary index file does not exist. This is normal if no\n            incremental updates have been made yet.\n        ', lineno=581, col_offset=8, end_lineno=596, end_col_offset=11), lineno=581, col_offset=8, end_lineno=596, end_col_offset=11), If(test=UnaryOp(op=Not(), operand=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=597, col_offset=15, end_lineno=597, end_col_offset=19), attr='secondary_index_path', ctx=Load(), lineno=597, col_offset=15, end_lineno=597, end_col_offset=40), attr='exists', ctx=Load(), lineno=597, col_offset=15, end_lineno=597, end_col_offset=47), lineno=597, col_offset=15, end_lineno=597, end_col_offset=49), lineno=597, col_offset=11, end_lineno=597, end_col_offset=49), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=598, col_offset=12, end_lineno=598, end_col_offset=15)], value=JoinedStr(values=[Constant(value='Secondary index not found: ', lineno=598, col_offset=20, end_lineno=598, end_col_offset=47), FormattedValue(value=Attribute(value=Name(id='self', ctx=Load(), lineno=598, col_offset=48, end_lineno=598, end_col_offset=52), attr='secondary_index_path', ctx=Load(), lineno=598, col_offset=48, end_lineno=598, end_col_offset=73), conversion=-1, lineno=598, col_offset=47, end_lineno=598, end_col_offset=74)], lineno=598, col_offset=18, end_lineno=598, end_col_offset=75), lineno=598, col_offset=12, end_lineno=598, end_col_offset=75), Raise(exc=Call(func=Name(id='FileNotFoundError', ctx=Load(), lineno=599, col_offset=18, end_lineno=599, end_col_offset=35), args=[Name(id='msg', ctx=Load(), lineno=599, col_offset=36, end_lineno=599, end_col_offset=39)], lineno=599, col_offset=18, end_lineno=599, end_col_offset=40), lineno=599, col_offset=12, end_lineno=599, end_col_offset=40)], lineno=597, col_offset=8, end_lineno=599, end_col_offset=40), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=601, col_offset=8, end_lineno=601, end_col_offset=12), attr='secondary_index', ctx=Store(), lineno=601, col_offset=8, end_lineno=601, end_col_offset=28)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=601, col_offset=31, end_lineno=601, end_col_offset=36), attr='read_index', ctx=Load(), lineno=601, col_offset=31, end_lineno=601, end_col_offset=47), args=[Call(func=Name(id='str', ctx=Load(), lineno=601, col_offset=48, end_lineno=601, end_col_offset=51), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=601, col_offset=52, end_lineno=601, end_col_offset=56), attr='secondary_index_path', ctx=Load(), lineno=601, col_offset=52, end_lineno=601, end_col_offset=77)], lineno=601, col_offset=48, end_lineno=601, end_col_offset=78)], lineno=601, col_offset=31, end_lineno=601, end_col_offset=79), lineno=601, col_offset=8, end_lineno=601, end_col_offset=79), If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=604, col_offset=11, end_lineno=604, end_col_offset=15), attr='secondary_index', ctx=Load(), lineno=604, col_offset=11, end_lineno=604, end_col_offset=31), ops=[IsNot()], comparators=[Constant(value=None, lineno=604, col_offset=39, end_lineno=604, end_col_offset=43)], lineno=604, col_offset=11, end_lineno=604, end_col_offset=43), body=[Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=605, col_offset=12, end_lineno=605, end_col_offset=21)], value=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=605, col_offset=24, end_lineno=605, end_col_offset=28), attr='secondary_index', ctx=Load(), lineno=605, col_offset=24, end_lineno=605, end_col_offset=44), attr='ntotal', ctx=Load(), lineno=605, col_offset=24, end_lineno=605, end_col_offset=51), lineno=605, col_offset=12, end_lineno=605, end_col_offset=51), Assign(targets=[Name(id='id_map_obj', ctx=Store(), lineno=606, col_offset=12, end_lineno=606, end_col_offset=22)], value=Call(func=Name(id='getattr', ctx=Load(), lineno=606, col_offset=25, end_lineno=606, end_col_offset=32), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=606, col_offset=33, end_lineno=606, end_col_offset=37), attr='secondary_index', ctx=Load(), lineno=606, col_offset=33, end_lineno=606, end_col_offset=53), Constant(value='id_map', lineno=606, col_offset=55, end_lineno=606, end_col_offset=63), Constant(value=None, lineno=606, col_offset=65, end_lineno=606, end_col_offset=69)], lineno=606, col_offset=25, end_lineno=606, end_col_offset=70), lineno=606, col_offset=12, end_lineno=606, end_col_offset=70), If(test=BoolOp(op=And(), values=[Compare(left=Name(id='id_map_obj', ctx=Load(), lineno=607, col_offset=15, end_lineno=607, end_col_offset=25), ops=[IsNot()], comparators=[Constant(value=None, lineno=607, col_offset=33, end_lineno=607, end_col_offset=37)], lineno=607, col_offset=15, end_lineno=607, end_col_offset=37), Call(func=Name(id='callable', ctx=Load(), lineno=607, col_offset=42, end_lineno=607, end_col_offset=50), args=[Call(func=Name(id='getattr', ctx=Load(), lineno=607, col_offset=51, end_lineno=607, end_col_offset=58), args=[Name(id='id_map_obj', ctx=Load(), lineno=607, col_offset=59, end_lineno=607, end_col_offset=69), Constant(value='at', lineno=607, col_offset=71, end_lineno=607, end_col_offset=75), Constant(value=None, lineno=607, col_offset=77, end_lineno=607, end_col_offset=81)], lineno=607, col_offset=51, end_lineno=607, end_col_offset=82)], lineno=607, col_offset=42, end_lineno=607, end_col_offset=83)], lineno=607, col_offset=15, end_lineno=607, end_col_offset=83), body=[Assign(targets=[Name(id='at_callable', ctx=Store(), lineno=608, col_offset=16, end_lineno=608, end_col_offset=27)], value=Call(func=Name(id='cast', ctx=Load(), lineno=608, col_offset=30, end_lineno=608, end_col_offset=34), args=[Constant(value='Callable[[int], int]', lineno=608, col_offset=35, end_lineno=608, end_col_offset=57), Attribute(value=Name(id='id_map_obj', ctx=Load(), lineno=608, col_offset=59, end_lineno=608, end_col_offset=69), attr='at', ctx=Load(), lineno=608, col_offset=59, end_lineno=608, end_col_offset=72)], lineno=608, col_offset=30, end_lineno=608, end_col_offset=73), lineno=608, col_offset=16, end_lineno=608, end_col_offset=73), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=609, col_offset=16, end_lineno=609, end_col_offset=20), attr='incremental_ids', ctx=Store(), lineno=609, col_offset=16, end_lineno=609, end_col_offset=36)], value=SetComp(elt=Call(func=Name(id='at_callable', ctx=Load(), lineno=609, col_offset=40, end_lineno=609, end_col_offset=51), args=[Name(id='i', ctx=Load(), lineno=609, col_offset=52, end_lineno=609, end_col_offset=53)], lineno=609, col_offset=40, end_lineno=609, end_col_offset=54), generators=[comprehension(target=Name(id='i', ctx=Store(), lineno=609, col_offset=59, end_lineno=609, end_col_offset=60), iter=Call(func=Name(id='range', ctx=Load(), lineno=609, col_offset=64, end_lineno=609, end_col_offset=69), args=[Name(id='n_vectors', ctx=Load(), lineno=609, col_offset=70, end_lineno=609, end_col_offset=79)], lineno=609, col_offset=64, end_lineno=609, end_col_offset=80), is_async=0)], lineno=609, col_offset=39, end_lineno=609, end_col_offset=81), lineno=609, col_offset=16, end_lineno=609, end_col_offset=81)], orelse=[Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=611, col_offset=16, end_lineno=611, end_col_offset=20), attr='incremental_ids', ctx=Store(), lineno=611, col_offset=16, end_lineno=611, end_col_offset=36)], value=Call(func=Name(id='set', ctx=Load(), lineno=611, col_offset=39, end_lineno=611, end_col_offset=42), args=[Call(func=Name(id='range', ctx=Load(), lineno=611, col_offset=43, end_lineno=611, end_col_offset=48), args=[Name(id='n_vectors', ctx=Load(), lineno=611, col_offset=49, end_lineno=611, end_col_offset=58)], lineno=611, col_offset=43, end_lineno=611, end_col_offset=59)], lineno=611, col_offset=39, end_lineno=611, end_col_offset=60), lineno=611, col_offset=16, end_lineno=611, end_col_offset=60)], lineno=607, col_offset=12, end_lineno=611, end_col_offset=60)], lineno=604, col_offset=8, end_lineno=611, end_col_offset=60), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=613, col_offset=8, end_lineno=613, end_col_offset=14), attr='info', ctx=Load(), lineno=613, col_offset=8, end_lineno=613, end_col_offset=19), args=[Constant(value='Loaded secondary FAISS index', lineno=614, col_offset=12, end_lineno=614, end_col_offset=42)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=615, col_offset=18, end_lineno=615, end_col_offset=28), keywords=[keyword(arg='path', value=Call(func=Name(id='str', ctx=Load(), lineno=616, col_offset=21, end_lineno=616, end_col_offset=24), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=616, col_offset=25, end_lineno=616, end_col_offset=29), attr='secondary_index_path', ctx=Load(), lineno=616, col_offset=25, end_lineno=616, end_col_offset=50)], lineno=616, col_offset=21, end_lineno=616, end_col_offset=51), lineno=616, col_offset=16, end_lineno=616, end_col_offset=51), keyword(arg='vectors', value=Call(func=Name(id='len', ctx=Load(), lineno=617, col_offset=24, end_lineno=617, end_col_offset=27), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=617, col_offset=28, end_lineno=617, end_col_offset=32), attr='incremental_ids', ctx=Load(), lineno=617, col_offset=28, end_lineno=617, end_col_offset=48)], lineno=617, col_offset=24, end_lineno=617, end_col_offset=49), lineno=617, col_offset=16, end_lineno=617, end_col_offset=49)], lineno=615, col_offset=18, end_lineno=618, end_col_offset=13), lineno=615, col_offset=12, end_lineno=618, end_col_offset=13)], lineno=613, col_offset=8, end_lineno=619, end_col_offset=9), lineno=613, col_offset=8, end_lineno=619, end_col_offset=9)], returns=Constant(value=None, lineno=580, col_offset=38, end_lineno=580, end_col_offset=42), lineno=580, col_offset=4, end_lineno=619, end_col_offset=9), FunctionDef(name='clone_to_gpu', args=arguments(args=[arg(arg='self', lineno=621, col_offset=21, end_lineno=621, end_col_offset=25), arg(arg='device', annotation=Name(id='int', ctx=Load(), lineno=621, col_offset=35, end_lineno=621, end_col_offset=38), lineno=621, col_offset=27, end_lineno=621, end_col_offset=38)], defaults=[Constant(value=0, lineno=621, col_offset=41, end_lineno=621, end_col_offset=42)]), body=[Expr(value=Constant(value='Clone CPU index to GPU for accelerated search.\n\n        Creates a GPU-resident copy of the CPU index for faster search operations.\n        The GPU index uses the same structure (IVF-PQ) but runs on GPU hardware\n        for 10-100x speedup on large indexes.\n\n        If cuVS acceleration is enabled (use_cuvs=True), the function attempts to\n        use optimized cuVS kernels. If cuVS is unavailable, it falls back to\n        standard FAISS GPU operations.\n\n        The GPU index is kept in memory alongside the CPU index. Both can be\n        used for search, but GPU is preferred when available.\n\n        Parameters\n        ----------\n        device : int, optional\n            CUDA device ID to use (default: 0). Use device 0 for single-GPU systems.\n            For multi-GPU, specify the device ID (0, 1, 2, etc.).\n\n        Returns\n        -------\n        bool\n            ``True`` when GPU acceleration is available. ``False`` when GPU\n            initialization fails and the manager falls back to the CPU index.\n\n        Raises\n        ------\n        RuntimeError\n            If the CPU index has not been loaded yet. Call load_cpu_index() or\n            build_index() first.\n        ', lineno=622, col_offset=8, end_lineno=652, end_col_offset=11), lineno=622, col_offset=8, end_lineno=652, end_col_offset=11), Try(body=[Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=654, col_offset=12, end_lineno=654, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=654, col_offset=24, end_lineno=654, end_col_offset=28), attr='_require_cpu_index', ctx=Load(), lineno=654, col_offset=24, end_lineno=654, end_col_offset=47), lineno=654, col_offset=24, end_lineno=654, end_col_offset=49), lineno=654, col_offset=12, end_lineno=654, end_col_offset=49)], handlers=[ExceptHandler(type=Name(id='RuntimeError', ctx=Load(), lineno=655, col_offset=15, end_lineno=655, end_col_offset=27), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=656, col_offset=12, end_lineno=656, end_col_offset=15)], value=Constant(value='Cannot clone index to GPU before building or loading it.', lineno=656, col_offset=18, end_lineno=656, end_col_offset=76), lineno=656, col_offset=12, end_lineno=656, end_col_offset=76), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=657, col_offset=18, end_lineno=657, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=657, col_offset=31, end_lineno=657, end_col_offset=34)], lineno=657, col_offset=18, end_lineno=657, end_col_offset=35), cause=Name(id='exc', ctx=Load(), lineno=657, col_offset=41, end_lineno=657, end_col_offset=44), lineno=657, col_offset=12, end_lineno=657, end_col_offset=44)], lineno=655, col_offset=8, end_lineno=657, end_col_offset=44)], lineno=653, col_offset=8, end_lineno=657, end_col_offset=44), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=659, col_offset=8, end_lineno=659, end_col_offset=12), attr='gpu_disabled_reason', ctx=Store(), lineno=659, col_offset=8, end_lineno=659, end_col_offset=32)], value=Constant(value=None, lineno=659, col_offset=35, end_lineno=659, end_col_offset=39), lineno=659, col_offset=8, end_lineno=659, end_col_offset=39), If(test=UnaryOp(op=Not(), operand=Name(id='_FAISS_GPU_AVAILABLE', ctx=Load(), lineno=661, col_offset=15, end_lineno=661, end_col_offset=35), lineno=661, col_offset=11, end_lineno=661, end_col_offset=35), body=[Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=662, col_offset=12, end_lineno=662, end_col_offset=16), attr='gpu_disabled_reason', ctx=Store(), lineno=662, col_offset=12, end_lineno=662, end_col_offset=36)], value=Constant(value='FAISS GPU symbols unavailable - running in CPU mode', lineno=662, col_offset=39, end_lineno=662, end_col_offset=92), lineno=662, col_offset=12, end_lineno=662, end_col_offset=92), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=663, col_offset=12, end_lineno=663, end_col_offset=18), attr='info', ctx=Load(), lineno=663, col_offset=12, end_lineno=663, end_col_offset=23), args=[Constant(value='Skipping GPU clone; FAISS GPU symbols unavailable', lineno=664, col_offset=16, end_lineno=664, end_col_offset=67)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=665, col_offset=22, end_lineno=665, end_col_offset=32), keywords=[keyword(arg='reason', value=Attribute(value=Name(id='self', ctx=Load(), lineno=665, col_offset=40, end_lineno=665, end_col_offset=44), attr='gpu_disabled_reason', ctx=Load(), lineno=665, col_offset=40, end_lineno=665, end_col_offset=64), lineno=665, col_offset=33, end_lineno=665, end_col_offset=64), keyword(arg='device', value=Name(id='device', ctx=Load(), lineno=665, col_offset=73, end_lineno=665, end_col_offset=79), lineno=665, col_offset=66, end_lineno=665, end_col_offset=79)], lineno=665, col_offset=22, end_lineno=665, end_col_offset=80), lineno=665, col_offset=16, end_lineno=665, end_col_offset=80)], lineno=663, col_offset=12, end_lineno=666, end_col_offset=13), lineno=663, col_offset=12, end_lineno=666, end_col_offset=13), Return(value=Constant(value=False, lineno=667, col_offset=19, end_lineno=667, end_col_offset=24), lineno=667, col_offset=12, end_lineno=667, end_col_offset=24)], lineno=661, col_offset=8, end_lineno=667, end_col_offset=24), Try(body=[Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=671, col_offset=12, end_lineno=671, end_col_offset=16), attr='gpu_resources', ctx=Store(), lineno=671, col_offset=12, end_lineno=671, end_col_offset=30)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=671, col_offset=33, end_lineno=671, end_col_offset=38), attr='StandardGpuResources', ctx=Load(), lineno=671, col_offset=33, end_lineno=671, end_col_offset=59), lineno=671, col_offset=33, end_lineno=671, end_col_offset=61), lineno=671, col_offset=12, end_lineno=671, end_col_offset=61), Assign(targets=[Name(id='co', ctx=Store(), lineno=674, col_offset=12, end_lineno=674, end_col_offset=14)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=674, col_offset=17, end_lineno=674, end_col_offset=22), attr='GpuClonerOptions', ctx=Load(), lineno=674, col_offset=17, end_lineno=674, end_col_offset=39), lineno=674, col_offset=17, end_lineno=674, end_col_offset=41), lineno=674, col_offset=12, end_lineno=674, end_col_offset=41), Assign(targets=[Attribute(value=Name(id='co', ctx=Load(), lineno=675, col_offset=12, end_lineno=675, end_col_offset=14), attr='useFloat16', ctx=Store(), lineno=675, col_offset=12, end_lineno=675, end_col_offset=25)], value=Constant(value=False, lineno=675, col_offset=28, end_lineno=675, end_col_offset=33), lineno=675, col_offset=12, end_lineno=675, end_col_offset=33), Assign(targets=[Attribute(value=Name(id='co', ctx=Load(), lineno=678, col_offset=12, end_lineno=678, end_col_offset=14), attr='use_cuvs', ctx=Store(), lineno=678, col_offset=12, end_lineno=678, end_col_offset=23)], value=Constant(value=False, lineno=678, col_offset=26, end_lineno=678, end_col_offset=31), lineno=678, col_offset=12, end_lineno=678, end_col_offset=31), If(test=Attribute(value=Name(id='self', ctx=Load(), lineno=679, col_offset=15, end_lineno=679, end_col_offset=19), attr='use_cuvs', ctx=Load(), lineno=679, col_offset=15, end_lineno=679, end_col_offset=28), body=[Try(body=[Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=681, col_offset=20, end_lineno=681, end_col_offset=24), attr='_try_load_cuvs', ctx=Load(), lineno=681, col_offset=20, end_lineno=681, end_col_offset=39), lineno=681, col_offset=20, end_lineno=681, end_col_offset=41), lineno=681, col_offset=20, end_lineno=681, end_col_offset=41)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='ImportError', ctx=Load(), lineno=682, col_offset=24, end_lineno=682, end_col_offset=35), Name(id='RuntimeError', ctx=Load(), lineno=682, col_offset=37, end_lineno=682, end_col_offset=49), Name(id='AttributeError', ctx=Load(), lineno=682, col_offset=51, end_lineno=682, end_col_offset=65)], ctx=Load(), lineno=682, col_offset=23, end_lineno=682, end_col_offset=66), name='exc', body=[Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=683, col_offset=20, end_lineno=683, end_col_offset=26), attr='warning', ctx=Load(), lineno=683, col_offset=20, end_lineno=683, end_col_offset=34), args=[Constant(value='cuVS acceleration unavailable', lineno=684, col_offset=24, end_lineno=684, end_col_offset=55)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=685, col_offset=30, end_lineno=685, end_col_offset=40), keywords=[keyword(arg='reason', value=Call(func=Name(id='str', ctx=Load(), lineno=685, col_offset=48, end_lineno=685, end_col_offset=51), args=[Name(id='exc', ctx=Load(), lineno=685, col_offset=52, end_lineno=685, end_col_offset=55)], lineno=685, col_offset=48, end_lineno=685, end_col_offset=56), lineno=685, col_offset=41, end_lineno=685, end_col_offset=56)], lineno=685, col_offset=30, end_lineno=685, end_col_offset=57), lineno=685, col_offset=24, end_lineno=685, end_col_offset=57)], lineno=683, col_offset=20, end_lineno=686, end_col_offset=21), lineno=683, col_offset=20, end_lineno=686, end_col_offset=21)], lineno=682, col_offset=16, end_lineno=686, end_col_offset=21)], orelse=[Assign(targets=[Attribute(value=Name(id='co', ctx=Load(), lineno=688, col_offset=20, end_lineno=688, end_col_offset=22), attr='use_cuvs', ctx=Store(), lineno=688, col_offset=20, end_lineno=688, end_col_offset=31)], value=Constant(value=True, lineno=688, col_offset=34, end_lineno=688, end_col_offset=38), lineno=688, col_offset=20, end_lineno=688, end_col_offset=38)], lineno=680, col_offset=16, end_lineno=688, end_col_offset=38)], lineno=679, col_offset=12, end_lineno=688, end_col_offset=38), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=690, col_offset=12, end_lineno=690, end_col_offset=16), attr='gpu_index', ctx=Store(), lineno=690, col_offset=12, end_lineno=690, end_col_offset=26)], value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=690, col_offset=29, end_lineno=690, end_col_offset=34), attr='index_cpu_to_gpu', ctx=Load(), lineno=690, col_offset=29, end_lineno=690, end_col_offset=51), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=690, col_offset=52, end_lineno=690, end_col_offset=56), attr='gpu_resources', ctx=Load(), lineno=690, col_offset=52, end_lineno=690, end_col_offset=70), Name(id='device', ctx=Load(), lineno=690, col_offset=72, end_lineno=690, end_col_offset=78), Name(id='cpu_index', ctx=Load(), lineno=690, col_offset=80, end_lineno=690, end_col_offset=89), Name(id='co', ctx=Load(), lineno=690, col_offset=91, end_lineno=690, end_col_offset=93)], lineno=690, col_offset=29, end_lineno=690, end_col_offset=94), lineno=690, col_offset=12, end_lineno=690, end_col_offset=94)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='RuntimeError', ctx=Load(), lineno=691, col_offset=16, end_lineno=691, end_col_offset=28), Name(id='ValueError', ctx=Load(), lineno=691, col_offset=30, end_lineno=691, end_col_offset=40), Name(id='OSError', ctx=Load(), lineno=691, col_offset=42, end_lineno=691, end_col_offset=49), Name(id='AttributeError', ctx=Load(), lineno=691, col_offset=51, end_lineno=691, end_col_offset=65)], ctx=Load(), lineno=691, col_offset=15, end_lineno=691, end_col_offset=66), name='exc', body=[Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=692, col_offset=12, end_lineno=692, end_col_offset=16), attr='gpu_resources', ctx=Store(), lineno=692, col_offset=12, end_lineno=692, end_col_offset=30)], value=Constant(value=None, lineno=692, col_offset=33, end_lineno=692, end_col_offset=37), lineno=692, col_offset=12, end_lineno=692, end_col_offset=37), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=693, col_offset=12, end_lineno=693, end_col_offset=16), attr='gpu_index', ctx=Store(), lineno=693, col_offset=12, end_lineno=693, end_col_offset=26)], value=Constant(value=None, lineno=693, col_offset=29, end_lineno=693, end_col_offset=33), lineno=693, col_offset=12, end_lineno=693, end_col_offset=33), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=694, col_offset=12, end_lineno=694, end_col_offset=16), attr='gpu_disabled_reason', ctx=Store(), lineno=694, col_offset=12, end_lineno=694, end_col_offset=36)], value=JoinedStr(values=[Constant(value='FAISS GPU disabled - using CPU: ', lineno=694, col_offset=41, end_lineno=694, end_col_offset=73), FormattedValue(value=Name(id='exc', ctx=Load(), lineno=694, col_offset=74, end_lineno=694, end_col_offset=77), conversion=-1, lineno=694, col_offset=73, end_lineno=694, end_col_offset=78)], lineno=694, col_offset=39, end_lineno=694, end_col_offset=79), lineno=694, col_offset=12, end_lineno=694, end_col_offset=79), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=695, col_offset=12, end_lineno=695, end_col_offset=18), attr='warning', ctx=Load(), lineno=695, col_offset=12, end_lineno=695, end_col_offset=26), args=[Constant(value='FAISS GPU initialization failed; continuing with CPU index', lineno=696, col_offset=16, end_lineno=696, end_col_offset=76)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=697, col_offset=22, end_lineno=697, end_col_offset=32), keywords=[keyword(arg='reason', value=Call(func=Name(id='str', ctx=Load(), lineno=697, col_offset=40, end_lineno=697, end_col_offset=43), args=[Name(id='exc', ctx=Load(), lineno=697, col_offset=44, end_lineno=697, end_col_offset=47)], lineno=697, col_offset=40, end_lineno=697, end_col_offset=48), lineno=697, col_offset=33, end_lineno=697, end_col_offset=48), keyword(arg='device', value=Name(id='device', ctx=Load(), lineno=697, col_offset=57, end_lineno=697, end_col_offset=63), lineno=697, col_offset=50, end_lineno=697, end_col_offset=63)], lineno=697, col_offset=22, end_lineno=697, end_col_offset=64), lineno=697, col_offset=16, end_lineno=697, end_col_offset=64), keyword(arg='exc_info', value=Constant(value=True, lineno=698, col_offset=25, end_lineno=698, end_col_offset=29), lineno=698, col_offset=16, end_lineno=698, end_col_offset=29)], lineno=695, col_offset=12, end_lineno=699, end_col_offset=13), lineno=695, col_offset=12, end_lineno=699, end_col_offset=13), Return(value=Constant(value=False, lineno=700, col_offset=19, end_lineno=700, end_col_offset=24), lineno=700, col_offset=12, end_lineno=700, end_col_offset=24)], lineno=691, col_offset=8, end_lineno=700, end_col_offset=24)], lineno=669, col_offset=8, end_lineno=700, end_col_offset=24), Return(value=Constant(value=True, lineno=702, col_offset=15, end_lineno=702, end_col_offset=19), lineno=702, col_offset=8, end_lineno=702, end_col_offset=19)], returns=Name(id='bool', ctx=Load(), lineno=621, col_offset=47, end_lineno=621, end_col_offset=51), lineno=621, col_offset=4, end_lineno=702, end_col_offset=19), FunctionDef(name='search', args=arguments(args=[arg(arg='self', lineno=705, col_offset=8, end_lineno=705, end_col_offset=12), arg(arg='query', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=705, col_offset=21, end_lineno=705, end_col_offset=23), attr='ndarray', ctx=Load(), lineno=705, col_offset=21, end_lineno=705, end_col_offset=31), lineno=705, col_offset=14, end_lineno=705, end_col_offset=31), arg(arg='k', annotation=Name(id='int', ctx=Load(), lineno=705, col_offset=36, end_lineno=705, end_col_offset=39), lineno=705, col_offset=33, end_lineno=705, end_col_offset=39), arg(arg='nprobe', annotation=Name(id='int', ctx=Load(), lineno=705, col_offset=54, end_lineno=705, end_col_offset=57), lineno=705, col_offset=46, end_lineno=705, end_col_offset=57)], defaults=[Constant(value=50, lineno=705, col_offset=42, end_lineno=705, end_col_offset=44), Constant(value=128, lineno=705, col_offset=60, end_lineno=705, end_col_offset=63)]), body=[Expr(value=Constant(value='Search for nearest neighbors using cosine similarity with dual-index support.\n\n        Performs approximate nearest neighbor search using the FAISS index(es).\n        When a secondary index exists (from incremental updates), searches both\n        the primary and secondary indexes, then merges results by score to return\n        the top-k most similar vectors overall.\n\n        The function automatically uses the GPU index if available (faster),\n        otherwise falls back to CPU. The nprobe parameter controls the trade-off\n        between search speed and recall - higher values search more cells and\n        improve recall but slow down search.\n\n        Parameters\n        ----------\n        query : np.ndarray\n            Query vector(s) of shape (n_queries, vec_dim) or (vec_dim,) for\n            single query. Dtype should be float32. Vectors are automatically\n            normalized for cosine similarity.\n        k : int, optional\n            Number of nearest neighbors to return per query (default: 50).\n            Higher k improves recall but increases computation and memory usage.\n        nprobe : int, optional\n            Number of IVF cells to probe during search (default: 128). Higher\n            values improve recall but slow down search. Should match or be less\n            than the nlist parameter used during index construction. Only applies\n            to primary index (secondary index is flat, no nprobe).\n\n        Returns\n        -------\n        tuple[np.ndarray, np.ndarray]\n            Tuple of (distances, ids) arrays:\n            - distances: shape (n_queries, k), cosine similarity scores (higher\n              is more similar, range typically 0-1 after normalization)\n            - ids: shape (n_queries, k), chunk IDs of the nearest neighbors.\n              IDs correspond to the ids passed to add_vectors() or update_index().\n\n        Notes\n        -----\n        When both primary and secondary indexes exist, the method:\n        1. Searches primary index with nprobe parameter\n        2. Searches secondary index (flat, no nprobe)\n        3. Merges results by score (inner product distance)\n        4. Returns top-k combined results\n\n        This ensures incremental updates are immediately searchable without\n        rebuilding the primary index.\n\n        Raises RuntimeError (propagated from `search_primary()` and\n        `search_secondary()`) if no index is available or if search fails\n        (e.g., dimension mismatch, invalid nprobe value).\n        ', lineno=707, col_offset=8, end_lineno=757, end_col_offset=11), lineno=707, col_offset=8, end_lineno=757, end_col_offset=11), Assign(targets=[Tuple(elts=[Name(id='primary_dists', ctx=Store(), lineno=759, col_offset=8, end_lineno=759, end_col_offset=21), Name(id='primary_ids', ctx=Store(), lineno=759, col_offset=23, end_lineno=759, end_col_offset=34)], ctx=Store(), lineno=759, col_offset=8, end_lineno=759, end_col_offset=34)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=759, col_offset=37, end_lineno=759, end_col_offset=41), attr='search_primary', ctx=Load(), lineno=759, col_offset=37, end_lineno=759, end_col_offset=56), args=[Name(id='query', ctx=Load(), lineno=759, col_offset=57, end_lineno=759, end_col_offset=62), Name(id='k', ctx=Load(), lineno=759, col_offset=64, end_lineno=759, end_col_offset=65), Name(id='nprobe', ctx=Load(), lineno=759, col_offset=67, end_lineno=759, end_col_offset=73)], lineno=759, col_offset=37, end_lineno=759, end_col_offset=74), lineno=759, col_offset=8, end_lineno=759, end_col_offset=74), If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=762, col_offset=11, end_lineno=762, end_col_offset=15), attr='secondary_index', ctx=Load(), lineno=762, col_offset=11, end_lineno=762, end_col_offset=31), ops=[IsNot()], comparators=[Constant(value=None, lineno=762, col_offset=39, end_lineno=762, end_col_offset=43)], lineno=762, col_offset=11, end_lineno=762, end_col_offset=43), body=[Assign(targets=[Tuple(elts=[Name(id='secondary_dists', ctx=Store(), lineno=763, col_offset=12, end_lineno=763, end_col_offset=27), Name(id='secondary_ids', ctx=Store(), lineno=763, col_offset=29, end_lineno=763, end_col_offset=42)], ctx=Store(), lineno=763, col_offset=12, end_lineno=763, end_col_offset=42)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=763, col_offset=45, end_lineno=763, end_col_offset=49), attr='search_secondary', ctx=Load(), lineno=763, col_offset=45, end_lineno=763, end_col_offset=66), args=[Name(id='query', ctx=Load(), lineno=763, col_offset=67, end_lineno=763, end_col_offset=72), Name(id='k', ctx=Load(), lineno=763, col_offset=74, end_lineno=763, end_col_offset=75)], lineno=763, col_offset=45, end_lineno=763, end_col_offset=76), lineno=763, col_offset=12, end_lineno=763, end_col_offset=76), Assign(targets=[Tuple(elts=[Name(id='merged_dists', ctx=Store(), lineno=765, col_offset=12, end_lineno=765, end_col_offset=24), Name(id='merged_ids', ctx=Store(), lineno=765, col_offset=26, end_lineno=765, end_col_offset=36)], ctx=Store(), lineno=765, col_offset=12, end_lineno=765, end_col_offset=36)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=765, col_offset=39, end_lineno=765, end_col_offset=43), attr='_merge_results', ctx=Load(), lineno=765, col_offset=39, end_lineno=765, end_col_offset=58), args=[Name(id='primary_dists', ctx=Load(), lineno=766, col_offset=16, end_lineno=766, end_col_offset=29), Name(id='primary_ids', ctx=Load(), lineno=766, col_offset=31, end_lineno=766, end_col_offset=42), Name(id='secondary_dists', ctx=Load(), lineno=766, col_offset=44, end_lineno=766, end_col_offset=59), Name(id='secondary_ids', ctx=Load(), lineno=766, col_offset=61, end_lineno=766, end_col_offset=74), Name(id='k', ctx=Load(), lineno=766, col_offset=76, end_lineno=766, end_col_offset=77)], lineno=765, col_offset=39, end_lineno=767, end_col_offset=13), lineno=765, col_offset=12, end_lineno=767, end_col_offset=13), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=768, col_offset=12, end_lineno=768, end_col_offset=18), attr='debug', ctx=Load(), lineno=768, col_offset=12, end_lineno=768, end_col_offset=24), args=[Constant(value='Dual-index search completed', lineno=769, col_offset=16, end_lineno=769, end_col_offset=45)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=770, col_offset=22, end_lineno=770, end_col_offset=32), keywords=[keyword(arg='primary_results', value=Subscript(value=Attribute(value=Name(id='primary_dists', ctx=Load(), lineno=771, col_offset=36, end_lineno=771, end_col_offset=49), attr='shape', ctx=Load(), lineno=771, col_offset=36, end_lineno=771, end_col_offset=55), slice=Constant(value=1, lineno=771, col_offset=56, end_lineno=771, end_col_offset=57), ctx=Load(), lineno=771, col_offset=36, end_lineno=771, end_col_offset=58), lineno=771, col_offset=20, end_lineno=771, end_col_offset=58), keyword(arg='secondary_results', value=Subscript(value=Attribute(value=Name(id='secondary_dists', ctx=Load(), lineno=772, col_offset=38, end_lineno=772, end_col_offset=53), attr='shape', ctx=Load(), lineno=772, col_offset=38, end_lineno=772, end_col_offset=59), slice=Constant(value=1, lineno=772, col_offset=60, end_lineno=772, end_col_offset=61), ctx=Load(), lineno=772, col_offset=38, end_lineno=772, end_col_offset=62), lineno=772, col_offset=20, end_lineno=772, end_col_offset=62), keyword(arg='merged_results', value=Subscript(value=Attribute(value=Name(id='merged_dists', ctx=Load(), lineno=773, col_offset=35, end_lineno=773, end_col_offset=47), attr='shape', ctx=Load(), lineno=773, col_offset=35, end_lineno=773, end_col_offset=53), slice=Constant(value=1, lineno=773, col_offset=54, end_lineno=773, end_col_offset=55), ctx=Load(), lineno=773, col_offset=35, end_lineno=773, end_col_offset=56), lineno=773, col_offset=20, end_lineno=773, end_col_offset=56)], lineno=770, col_offset=22, end_lineno=774, end_col_offset=17), lineno=770, col_offset=16, end_lineno=774, end_col_offset=17)], lineno=768, col_offset=12, end_lineno=775, end_col_offset=13), lineno=768, col_offset=12, end_lineno=775, end_col_offset=13), Return(value=Tuple(elts=[Name(id='merged_dists', ctx=Load(), lineno=776, col_offset=19, end_lineno=776, end_col_offset=31), Name(id='merged_ids', ctx=Load(), lineno=776, col_offset=33, end_lineno=776, end_col_offset=43)], ctx=Load(), lineno=776, col_offset=19, end_lineno=776, end_col_offset=43), lineno=776, col_offset=12, end_lineno=776, end_col_offset=43)], lineno=762, col_offset=8, end_lineno=776, end_col_offset=43), Return(value=Tuple(elts=[Name(id='primary_dists', ctx=Load(), lineno=779, col_offset=15, end_lineno=779, end_col_offset=28), Name(id='primary_ids', ctx=Load(), lineno=779, col_offset=30, end_lineno=779, end_col_offset=41)], ctx=Load(), lineno=779, col_offset=15, end_lineno=779, end_col_offset=41), lineno=779, col_offset=8, end_lineno=779, end_col_offset=41)], returns=Subscript(value=Name(id='tuple', ctx=Load(), lineno=706, col_offset=9, end_lineno=706, end_col_offset=14), slice=Tuple(elts=[Attribute(value=Name(id='np', ctx=Load(), lineno=706, col_offset=15, end_lineno=706, end_col_offset=17), attr='ndarray', ctx=Load(), lineno=706, col_offset=15, end_lineno=706, end_col_offset=25), Attribute(value=Name(id='np', ctx=Load(), lineno=706, col_offset=27, end_lineno=706, end_col_offset=29), attr='ndarray', ctx=Load(), lineno=706, col_offset=27, end_lineno=706, end_col_offset=37)], ctx=Load(), lineno=706, col_offset=15, end_lineno=706, end_col_offset=37), ctx=Load(), lineno=706, col_offset=9, end_lineno=706, end_col_offset=38), lineno=704, col_offset=4, end_lineno=779, end_col_offset=41), FunctionDef(name='search_primary', args=arguments(args=[arg(arg='self', lineno=782, col_offset=8, end_lineno=782, end_col_offset=12), arg(arg='query', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=782, col_offset=21, end_lineno=782, end_col_offset=23), attr='ndarray', ctx=Load(), lineno=782, col_offset=21, end_lineno=782, end_col_offset=31), lineno=782, col_offset=14, end_lineno=782, end_col_offset=31), arg(arg='k', annotation=Name(id='int', ctx=Load(), lineno=782, col_offset=36, end_lineno=782, end_col_offset=39), lineno=782, col_offset=33, end_lineno=782, end_col_offset=39), arg(arg='nprobe', annotation=Name(id='int', ctx=Load(), lineno=782, col_offset=49, end_lineno=782, end_col_offset=52), lineno=782, col_offset=41, end_lineno=782, end_col_offset=52)]), body=[Expr(value=Constant(value='Search the primary index (adaptive type: Flat/IVFFlat/IVF-PQ).\n\n        This method is public for testing and advanced use cases where\n        separate primary/secondary search results are needed.\n\n        Parameters\n        ----------\n        query : np.ndarray\n            Query vector(s), shape (n_queries, vec_dim) or (vec_dim,).\n        k : int\n            Number of nearest neighbors to return.\n        nprobe : int\n            Number of IVF cells to probe (for IVF indexes).\n\n        Returns\n        -------\n        tuple[np.ndarray, np.ndarray]\n            Tuple of (distances, ids) from primary index search.\n\n        Notes\n        -----\n        Flat indexes (``IndexFlat*``) do not expose the ``nprobe`` attribute.\n        The method checks for attribute support before assigning so that flat\n        indexes skip the IVF-only parameter while IVF indexes continue to use\n        ``nprobe`` for recall control.\n\n        Raises\n        ------\n        RuntimeError\n            If primary index is not available.\n        ', lineno=784, col_offset=8, end_lineno=814, end_col_offset=11), lineno=784, col_offset=8, end_lineno=814, end_col_offset=11), Try(body=[Assign(targets=[Name(id='index', ctx=Store(), lineno=816, col_offset=12, end_lineno=816, end_col_offset=17)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=816, col_offset=20, end_lineno=816, end_col_offset=24), attr='_active_index', ctx=Load(), lineno=816, col_offset=20, end_lineno=816, end_col_offset=38), lineno=816, col_offset=20, end_lineno=816, end_col_offset=40), lineno=816, col_offset=12, end_lineno=816, end_col_offset=40)], handlers=[ExceptHandler(type=Name(id='RuntimeError', ctx=Load(), lineno=817, col_offset=15, end_lineno=817, end_col_offset=27), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=818, col_offset=12, end_lineno=818, end_col_offset=15)], value=Constant(value='Cannot search primary index: no FAISS index is available.', lineno=818, col_offset=18, end_lineno=818, end_col_offset=77), lineno=818, col_offset=12, end_lineno=818, end_col_offset=77), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=819, col_offset=18, end_lineno=819, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=819, col_offset=31, end_lineno=819, end_col_offset=34)], lineno=819, col_offset=18, end_lineno=819, end_col_offset=35), cause=Name(id='exc', ctx=Load(), lineno=819, col_offset=41, end_lineno=819, end_col_offset=44), lineno=819, col_offset=12, end_lineno=819, end_col_offset=44)], lineno=817, col_offset=8, end_lineno=819, end_col_offset=44)], lineno=815, col_offset=8, end_lineno=819, end_col_offset=44), If(test=Call(func=Name(id='hasattr', ctx=Load(), lineno=822, col_offset=11, end_lineno=822, end_col_offset=18), args=[Name(id='index', ctx=Load(), lineno=822, col_offset=19, end_lineno=822, end_col_offset=24), Constant(value='nprobe', lineno=822, col_offset=26, end_lineno=822, end_col_offset=34)], lineno=822, col_offset=11, end_lineno=822, end_col_offset=35), body=[Assign(targets=[Attribute(value=Name(id='index', ctx=Load(), lineno=823, col_offset=12, end_lineno=823, end_col_offset=17), attr='nprobe', ctx=Store(), lineno=823, col_offset=12, end_lineno=823, end_col_offset=24)], value=Name(id='nprobe', ctx=Load(), lineno=823, col_offset=27, end_lineno=823, end_col_offset=33), lineno=823, col_offset=12, end_lineno=823, end_col_offset=33)], lineno=822, col_offset=8, end_lineno=823, end_col_offset=33), If(test=Compare(left=Attribute(value=Name(id='query', ctx=Load(), lineno=826, col_offset=11, end_lineno=826, end_col_offset=16), attr='ndim', ctx=Load(), lineno=826, col_offset=11, end_lineno=826, end_col_offset=21), ops=[Eq()], comparators=[Constant(value=1, lineno=826, col_offset=25, end_lineno=826, end_col_offset=26)], lineno=826, col_offset=11, end_lineno=826, end_col_offset=26), body=[Assign(targets=[Name(id='query', ctx=Store(), lineno=827, col_offset=12, end_lineno=827, end_col_offset=17)], value=Call(func=Attribute(value=Name(id='query', ctx=Load(), lineno=827, col_offset=20, end_lineno=827, end_col_offset=25), attr='reshape', ctx=Load(), lineno=827, col_offset=20, end_lineno=827, end_col_offset=33), args=[Constant(value=1, lineno=827, col_offset=34, end_lineno=827, end_col_offset=35), UnaryOp(op=USub(), operand=Constant(value=1, lineno=827, col_offset=38, end_lineno=827, end_col_offset=39), lineno=827, col_offset=37, end_lineno=827, end_col_offset=39)], lineno=827, col_offset=20, end_lineno=827, end_col_offset=40), lineno=827, col_offset=12, end_lineno=827, end_col_offset=40)], lineno=826, col_offset=8, end_lineno=827, end_col_offset=40), Assign(targets=[Name(id='query_norm', ctx=Store(), lineno=830, col_offset=8, end_lineno=830, end_col_offset=18)], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='query', ctx=Load(), lineno=830, col_offset=21, end_lineno=830, end_col_offset=26), attr='copy', ctx=Load(), lineno=830, col_offset=21, end_lineno=830, end_col_offset=31), lineno=830, col_offset=21, end_lineno=830, end_col_offset=33), attr='astype', ctx=Load(), lineno=830, col_offset=21, end_lineno=830, end_col_offset=40), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=830, col_offset=41, end_lineno=830, end_col_offset=43), attr='float32', ctx=Load(), lineno=830, col_offset=41, end_lineno=830, end_col_offset=51)], lineno=830, col_offset=21, end_lineno=830, end_col_offset=52), lineno=830, col_offset=8, end_lineno=830, end_col_offset=52), Expr(value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=831, col_offset=8, end_lineno=831, end_col_offset=13), attr='normalize_L2', ctx=Load(), lineno=831, col_offset=8, end_lineno=831, end_col_offset=26), args=[Name(id='query_norm', ctx=Load(), lineno=831, col_offset=27, end_lineno=831, end_col_offset=37)], lineno=831, col_offset=8, end_lineno=831, end_col_offset=38), lineno=831, col_offset=8, end_lineno=831, end_col_offset=38), Return(value=Call(func=Attribute(value=Name(id='index', ctx=Load(), lineno=834, col_offset=15, end_lineno=834, end_col_offset=20), attr='search', ctx=Load(), lineno=834, col_offset=15, end_lineno=834, end_col_offset=27), args=[Name(id='query_norm', ctx=Load(), lineno=834, col_offset=28, end_lineno=834, end_col_offset=38), Name(id='k', ctx=Load(), lineno=834, col_offset=40, end_lineno=834, end_col_offset=41)], lineno=834, col_offset=15, end_lineno=834, end_col_offset=42), lineno=834, col_offset=8, end_lineno=834, end_col_offset=42)], returns=Subscript(value=Name(id='tuple', ctx=Load(), lineno=783, col_offset=9, end_lineno=783, end_col_offset=14), slice=Tuple(elts=[Attribute(value=Name(id='np', ctx=Load(), lineno=783, col_offset=15, end_lineno=783, end_col_offset=17), attr='ndarray', ctx=Load(), lineno=783, col_offset=15, end_lineno=783, end_col_offset=25), Attribute(value=Name(id='np', ctx=Load(), lineno=783, col_offset=27, end_lineno=783, end_col_offset=29), attr='ndarray', ctx=Load(), lineno=783, col_offset=27, end_lineno=783, end_col_offset=37)], ctx=Load(), lineno=783, col_offset=15, end_lineno=783, end_col_offset=37), ctx=Load(), lineno=783, col_offset=9, end_lineno=783, end_col_offset=38), lineno=781, col_offset=4, end_lineno=834, end_col_offset=42), FunctionDef(name='search_secondary', args=arguments(args=[arg(arg='self', lineno=836, col_offset=25, end_lineno=836, end_col_offset=29), arg(arg='query', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=836, col_offset=38, end_lineno=836, end_col_offset=40), attr='ndarray', ctx=Load(), lineno=836, col_offset=38, end_lineno=836, end_col_offset=48), lineno=836, col_offset=31, end_lineno=836, end_col_offset=48), arg(arg='k', annotation=Name(id='int', ctx=Load(), lineno=836, col_offset=53, end_lineno=836, end_col_offset=56), lineno=836, col_offset=50, end_lineno=836, end_col_offset=56)]), body=[Expr(value=Constant(value='Search the secondary index (flat, no training required).\n\n        This method is public for testing and advanced use cases where\n        separate primary/secondary search results are needed.\n\n        Parameters\n        ----------\n        query : np.ndarray\n            Query vector(s), shape (n_queries, vec_dim) or (vec_dim,).\n        k : int\n            Number of nearest neighbors to return.\n\n        Returns\n        -------\n        tuple[np.ndarray, np.ndarray]\n            Tuple of (distances, ids) from secondary index search.\n\n        Raises\n        ------\n        RuntimeError\n            If secondary index is not available (should not happen if called\n            from search() after checking existence).\n        ', lineno=837, col_offset=8, end_lineno=859, end_col_offset=11), lineno=837, col_offset=8, end_lineno=859, end_col_offset=11), If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=860, col_offset=11, end_lineno=860, end_col_offset=15), attr='secondary_index', ctx=Load(), lineno=860, col_offset=11, end_lineno=860, end_col_offset=31), ops=[Is()], comparators=[Constant(value=None, lineno=860, col_offset=35, end_lineno=860, end_col_offset=39)], lineno=860, col_offset=11, end_lineno=860, end_col_offset=39), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=861, col_offset=12, end_lineno=861, end_col_offset=15)], value=Constant(value='Cannot search secondary index: secondary index not initialized.', lineno=861, col_offset=18, end_lineno=861, end_col_offset=83), lineno=861, col_offset=12, end_lineno=861, end_col_offset=83), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=862, col_offset=18, end_lineno=862, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=862, col_offset=31, end_lineno=862, end_col_offset=34)], lineno=862, col_offset=18, end_lineno=862, end_col_offset=35), lineno=862, col_offset=12, end_lineno=862, end_col_offset=35)], lineno=860, col_offset=8, end_lineno=862, end_col_offset=35), If(test=Compare(left=Attribute(value=Name(id='query', ctx=Load(), lineno=865, col_offset=11, end_lineno=865, end_col_offset=16), attr='ndim', ctx=Load(), lineno=865, col_offset=11, end_lineno=865, end_col_offset=21), ops=[Eq()], comparators=[Constant(value=1, lineno=865, col_offset=25, end_lineno=865, end_col_offset=26)], lineno=865, col_offset=11, end_lineno=865, end_col_offset=26), body=[Assign(targets=[Name(id='query', ctx=Store(), lineno=866, col_offset=12, end_lineno=866, end_col_offset=17)], value=Call(func=Attribute(value=Name(id='query', ctx=Load(), lineno=866, col_offset=20, end_lineno=866, end_col_offset=25), attr='reshape', ctx=Load(), lineno=866, col_offset=20, end_lineno=866, end_col_offset=33), args=[Constant(value=1, lineno=866, col_offset=34, end_lineno=866, end_col_offset=35), UnaryOp(op=USub(), operand=Constant(value=1, lineno=866, col_offset=38, end_lineno=866, end_col_offset=39), lineno=866, col_offset=37, end_lineno=866, end_col_offset=39)], lineno=866, col_offset=20, end_lineno=866, end_col_offset=40), lineno=866, col_offset=12, end_lineno=866, end_col_offset=40)], lineno=865, col_offset=8, end_lineno=866, end_col_offset=40), Assign(targets=[Name(id='query_norm', ctx=Store(), lineno=869, col_offset=8, end_lineno=869, end_col_offset=18)], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='query', ctx=Load(), lineno=869, col_offset=21, end_lineno=869, end_col_offset=26), attr='copy', ctx=Load(), lineno=869, col_offset=21, end_lineno=869, end_col_offset=31), lineno=869, col_offset=21, end_lineno=869, end_col_offset=33), attr='astype', ctx=Load(), lineno=869, col_offset=21, end_lineno=869, end_col_offset=40), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=869, col_offset=41, end_lineno=869, end_col_offset=43), attr='float32', ctx=Load(), lineno=869, col_offset=41, end_lineno=869, end_col_offset=51)], lineno=869, col_offset=21, end_lineno=869, end_col_offset=52), lineno=869, col_offset=8, end_lineno=869, end_col_offset=52), Expr(value=Call(func=Attribute(value=Name(id='faiss', ctx=Load(), lineno=870, col_offset=8, end_lineno=870, end_col_offset=13), attr='normalize_L2', ctx=Load(), lineno=870, col_offset=8, end_lineno=870, end_col_offset=26), args=[Name(id='query_norm', ctx=Load(), lineno=870, col_offset=27, end_lineno=870, end_col_offset=37)], lineno=870, col_offset=8, end_lineno=870, end_col_offset=38), lineno=870, col_offset=8, end_lineno=870, end_col_offset=38), Return(value=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=873, col_offset=15, end_lineno=873, end_col_offset=19), attr='secondary_index', ctx=Load(), lineno=873, col_offset=15, end_lineno=873, end_col_offset=35), attr='search', ctx=Load(), lineno=873, col_offset=15, end_lineno=873, end_col_offset=42), args=[Name(id='query_norm', ctx=Load(), lineno=873, col_offset=43, end_lineno=873, end_col_offset=53), Name(id='k', ctx=Load(), lineno=873, col_offset=55, end_lineno=873, end_col_offset=56)], lineno=873, col_offset=15, end_lineno=873, end_col_offset=57), lineno=873, col_offset=8, end_lineno=873, end_col_offset=57)], returns=Subscript(value=Name(id='tuple', ctx=Load(), lineno=836, col_offset=61, end_lineno=836, end_col_offset=66), slice=Tuple(elts=[Attribute(value=Name(id='np', ctx=Load(), lineno=836, col_offset=67, end_lineno=836, end_col_offset=69), attr='ndarray', ctx=Load(), lineno=836, col_offset=67, end_lineno=836, end_col_offset=77), Attribute(value=Name(id='np', ctx=Load(), lineno=836, col_offset=79, end_lineno=836, end_col_offset=81), attr='ndarray', ctx=Load(), lineno=836, col_offset=79, end_lineno=836, end_col_offset=89)], ctx=Load(), lineno=836, col_offset=67, end_lineno=836, end_col_offset=89), ctx=Load(), lineno=836, col_offset=61, end_lineno=836, end_col_offset=90), lineno=836, col_offset=4, end_lineno=873, end_col_offset=57), FunctionDef(name='_merge_results', args=arguments(args=[arg(arg='dists1', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=877, col_offset=16, end_lineno=877, end_col_offset=18), attr='ndarray', ctx=Load(), lineno=877, col_offset=16, end_lineno=877, end_col_offset=26), lineno=877, col_offset=8, end_lineno=877, end_col_offset=26), arg(arg='ids1', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=878, col_offset=14, end_lineno=878, end_col_offset=16), attr='ndarray', ctx=Load(), lineno=878, col_offset=14, end_lineno=878, end_col_offset=24), lineno=878, col_offset=8, end_lineno=878, end_col_offset=24), arg(arg='dists2', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=879, col_offset=16, end_lineno=879, end_col_offset=18), attr='ndarray', ctx=Load(), lineno=879, col_offset=16, end_lineno=879, end_col_offset=26), lineno=879, col_offset=8, end_lineno=879, end_col_offset=26), arg(arg='ids2', annotation=Attribute(value=Name(id='np', ctx=Load(), lineno=880, col_offset=14, end_lineno=880, end_col_offset=16), attr='ndarray', ctx=Load(), lineno=880, col_offset=14, end_lineno=880, end_col_offset=24), lineno=880, col_offset=8, end_lineno=880, end_col_offset=24), arg(arg='k', annotation=Name(id='int', ctx=Load(), lineno=881, col_offset=11, end_lineno=881, end_col_offset=14), lineno=881, col_offset=8, end_lineno=881, end_col_offset=14)]), body=[Expr(value=Constant(value='Merge search results from two indexes by score.\n\n        Combines results from primary and secondary indexes, sorts by distance\n        (inner product, higher is better), and returns the top-k combined results.\n\n        Parameters\n        ----------\n        dists1 : np.ndarray\n            Distances from first index, shape (n_queries, k1).\n        ids1 : np.ndarray\n            IDs from first index, shape (n_queries, k1).\n        dists2 : np.ndarray\n            Distances from second index, shape (n_queries, k2).\n        ids2 : np.ndarray\n            IDs from second index, shape (n_queries, k2).\n        k : int\n            Number of top results to return after merging.\n\n        Returns\n        -------\n        tuple[np.ndarray, np.ndarray]\n            Tuple of (merged_distances, merged_ids), both shape (n_queries, k).\n            Results are sorted by distance (descending for inner product).\n\n        Notes\n        -----\n        Uses inner product distance (cosine similarity after normalization),\n        where higher values indicate better matches. Results are sorted in\n        descending order and top-k is selected.\n        ', lineno=883, col_offset=8, end_lineno=912, end_col_offset=11), lineno=883, col_offset=8, end_lineno=912, end_col_offset=11), Assign(targets=[Name(id='all_dists', ctx=Store(), lineno=914, col_offset=8, end_lineno=914, end_col_offset=17)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=914, col_offset=20, end_lineno=914, end_col_offset=22), attr='concatenate', ctx=Load(), lineno=914, col_offset=20, end_lineno=914, end_col_offset=34), args=[List(elts=[Name(id='dists1', ctx=Load(), lineno=914, col_offset=36, end_lineno=914, end_col_offset=42), Name(id='dists2', ctx=Load(), lineno=914, col_offset=44, end_lineno=914, end_col_offset=50)], ctx=Load(), lineno=914, col_offset=35, end_lineno=914, end_col_offset=51)], keywords=[keyword(arg='axis', value=Constant(value=1, lineno=914, col_offset=58, end_lineno=914, end_col_offset=59), lineno=914, col_offset=53, end_lineno=914, end_col_offset=59)], lineno=914, col_offset=20, end_lineno=914, end_col_offset=60), lineno=914, col_offset=8, end_lineno=914, end_col_offset=60), Assign(targets=[Name(id='all_ids', ctx=Store(), lineno=915, col_offset=8, end_lineno=915, end_col_offset=15)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=915, col_offset=18, end_lineno=915, end_col_offset=20), attr='concatenate', ctx=Load(), lineno=915, col_offset=18, end_lineno=915, end_col_offset=32), args=[List(elts=[Name(id='ids1', ctx=Load(), lineno=915, col_offset=34, end_lineno=915, end_col_offset=38), Name(id='ids2', ctx=Load(), lineno=915, col_offset=40, end_lineno=915, end_col_offset=44)], ctx=Load(), lineno=915, col_offset=33, end_lineno=915, end_col_offset=45)], keywords=[keyword(arg='axis', value=Constant(value=1, lineno=915, col_offset=52, end_lineno=915, end_col_offset=53), lineno=915, col_offset=47, end_lineno=915, end_col_offset=53)], lineno=915, col_offset=18, end_lineno=915, end_col_offset=54), lineno=915, col_offset=8, end_lineno=915, end_col_offset=54), Assign(targets=[Name(id='sorted_indices', ctx=Store(), lineno=918, col_offset=8, end_lineno=918, end_col_offset=22)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=918, col_offset=25, end_lineno=918, end_col_offset=27), attr='argsort', ctx=Load(), lineno=918, col_offset=25, end_lineno=918, end_col_offset=35), args=[UnaryOp(op=USub(), operand=Name(id='all_dists', ctx=Load(), lineno=918, col_offset=37, end_lineno=918, end_col_offset=46), lineno=918, col_offset=36, end_lineno=918, end_col_offset=46)], keywords=[keyword(arg='axis', value=Constant(value=1, lineno=918, col_offset=53, end_lineno=918, end_col_offset=54), lineno=918, col_offset=48, end_lineno=918, end_col_offset=54)], lineno=918, col_offset=25, end_lineno=918, end_col_offset=55), lineno=918, col_offset=8, end_lineno=918, end_col_offset=55), Assign(targets=[Name(id='n_queries', ctx=Store(), lineno=920, col_offset=8, end_lineno=920, end_col_offset=17)], value=Subscript(value=Attribute(value=Name(id='all_dists', ctx=Load(), lineno=920, col_offset=20, end_lineno=920, end_col_offset=29), attr='shape', ctx=Load(), lineno=920, col_offset=20, end_lineno=920, end_col_offset=35), slice=Constant(value=0, lineno=920, col_offset=36, end_lineno=920, end_col_offset=37), ctx=Load(), lineno=920, col_offset=20, end_lineno=920, end_col_offset=38), lineno=920, col_offset=8, end_lineno=920, end_col_offset=38), Assign(targets=[Name(id='filler', ctx=Store(), lineno=921, col_offset=8, end_lineno=921, end_col_offset=14)], value=Attribute(value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=921, col_offset=17, end_lineno=921, end_col_offset=19), attr='finfo', ctx=Load(), lineno=921, col_offset=17, end_lineno=921, end_col_offset=25), args=[Attribute(value=Name(id='all_dists', ctx=Load(), lineno=921, col_offset=26, end_lineno=921, end_col_offset=35), attr='dtype', ctx=Load(), lineno=921, col_offset=26, end_lineno=921, end_col_offset=41)], lineno=921, col_offset=17, end_lineno=921, end_col_offset=42), attr='min', ctx=Load(), lineno=921, col_offset=17, end_lineno=921, end_col_offset=46), lineno=921, col_offset=8, end_lineno=921, end_col_offset=46), Assign(targets=[Name(id='merged_dists', ctx=Store(), lineno=922, col_offset=8, end_lineno=922, end_col_offset=20)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=922, col_offset=23, end_lineno=922, end_col_offset=25), attr='full', ctx=Load(), lineno=922, col_offset=23, end_lineno=922, end_col_offset=30), args=[Tuple(elts=[Name(id='n_queries', ctx=Load(), lineno=922, col_offset=32, end_lineno=922, end_col_offset=41), Name(id='k', ctx=Load(), lineno=922, col_offset=43, end_lineno=922, end_col_offset=44)], ctx=Load(), lineno=922, col_offset=31, end_lineno=922, end_col_offset=45), Name(id='filler', ctx=Load(), lineno=922, col_offset=47, end_lineno=922, end_col_offset=53)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='all_dists', ctx=Load(), lineno=922, col_offset=61, end_lineno=922, end_col_offset=70), attr='dtype', ctx=Load(), lineno=922, col_offset=61, end_lineno=922, end_col_offset=76), lineno=922, col_offset=55, end_lineno=922, end_col_offset=76)], lineno=922, col_offset=23, end_lineno=922, end_col_offset=77), lineno=922, col_offset=8, end_lineno=922, end_col_offset=77), Assign(targets=[Name(id='merged_ids', ctx=Store(), lineno=923, col_offset=8, end_lineno=923, end_col_offset=18)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=923, col_offset=21, end_lineno=923, end_col_offset=23), attr='full', ctx=Load(), lineno=923, col_offset=21, end_lineno=923, end_col_offset=28), args=[Tuple(elts=[Name(id='n_queries', ctx=Load(), lineno=923, col_offset=30, end_lineno=923, end_col_offset=39), Name(id='k', ctx=Load(), lineno=923, col_offset=41, end_lineno=923, end_col_offset=42)], ctx=Load(), lineno=923, col_offset=29, end_lineno=923, end_col_offset=43), UnaryOp(op=USub(), operand=Constant(value=1, lineno=923, col_offset=46, end_lineno=923, end_col_offset=47), lineno=923, col_offset=45, end_lineno=923, end_col_offset=47)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='all_ids', ctx=Load(), lineno=923, col_offset=55, end_lineno=923, end_col_offset=62), attr='dtype', ctx=Load(), lineno=923, col_offset=55, end_lineno=923, end_col_offset=68), lineno=923, col_offset=49, end_lineno=923, end_col_offset=68)], lineno=923, col_offset=21, end_lineno=923, end_col_offset=69), lineno=923, col_offset=8, end_lineno=923, end_col_offset=69), For(target=Name(id='query_idx', ctx=Store(), lineno=925, col_offset=12, end_lineno=925, end_col_offset=21), iter=Call(func=Name(id='range', ctx=Load(), lineno=925, col_offset=25, end_lineno=925, end_col_offset=30), args=[Name(id='n_queries', ctx=Load(), lineno=925, col_offset=31, end_lineno=925, end_col_offset=40)], lineno=925, col_offset=25, end_lineno=925, end_col_offset=41), body=[AnnAssign(target=Name(id='seen', ctx=Store(), lineno=926, col_offset=12, end_lineno=926, end_col_offset=16), annotation=Subscript(value=Name(id='set', ctx=Load(), lineno=926, col_offset=18, end_lineno=926, end_col_offset=21), slice=Name(id='int', ctx=Load(), lineno=926, col_offset=22, end_lineno=926, end_col_offset=25), ctx=Load(), lineno=926, col_offset=18, end_lineno=926, end_col_offset=26), value=Call(func=Name(id='set', ctx=Load(), lineno=926, col_offset=29, end_lineno=926, end_col_offset=32), lineno=926, col_offset=29, end_lineno=926, end_col_offset=34), simple=1, lineno=926, col_offset=12, end_lineno=926, end_col_offset=34), Assign(targets=[Name(id='out_pos', ctx=Store(), lineno=927, col_offset=12, end_lineno=927, end_col_offset=19)], value=Constant(value=0, lineno=927, col_offset=22, end_lineno=927, end_col_offset=23), lineno=927, col_offset=12, end_lineno=927, end_col_offset=23), For(target=Name(id='candidate_idx', ctx=Store(), lineno=928, col_offset=16, end_lineno=928, end_col_offset=29), iter=Subscript(value=Name(id='sorted_indices', ctx=Load(), lineno=928, col_offset=33, end_lineno=928, end_col_offset=47), slice=Name(id='query_idx', ctx=Load(), lineno=928, col_offset=48, end_lineno=928, end_col_offset=57), ctx=Load(), lineno=928, col_offset=33, end_lineno=928, end_col_offset=58), body=[Assign(targets=[Name(id='candidate_id', ctx=Store(), lineno=929, col_offset=16, end_lineno=929, end_col_offset=28)], value=Call(func=Name(id='int', ctx=Load(), lineno=929, col_offset=31, end_lineno=929, end_col_offset=34), args=[Subscript(value=Name(id='all_ids', ctx=Load(), lineno=929, col_offset=35, end_lineno=929, end_col_offset=42), slice=Tuple(elts=[Name(id='query_idx', ctx=Load(), lineno=929, col_offset=43, end_lineno=929, end_col_offset=52), Name(id='candidate_idx', ctx=Load(), lineno=929, col_offset=54, end_lineno=929, end_col_offset=67)], ctx=Load(), lineno=929, col_offset=43, end_lineno=929, end_col_offset=67), ctx=Load(), lineno=929, col_offset=35, end_lineno=929, end_col_offset=68)], lineno=929, col_offset=31, end_lineno=929, end_col_offset=69), lineno=929, col_offset=16, end_lineno=929, end_col_offset=69), If(test=BoolOp(op=Or(), values=[Compare(left=Name(id='candidate_id', ctx=Load(), lineno=930, col_offset=19, end_lineno=930, end_col_offset=31), ops=[Lt()], comparators=[Constant(value=0, lineno=930, col_offset=34, end_lineno=930, end_col_offset=35)], lineno=930, col_offset=19, end_lineno=930, end_col_offset=35), Compare(left=Name(id='candidate_id', ctx=Load(), lineno=930, col_offset=39, end_lineno=930, end_col_offset=51), ops=[In()], comparators=[Name(id='seen', ctx=Load(), lineno=930, col_offset=55, end_lineno=930, end_col_offset=59)], lineno=930, col_offset=39, end_lineno=930, end_col_offset=59)], lineno=930, col_offset=19, end_lineno=930, end_col_offset=59), body=[Continue(lineno=931, col_offset=20, end_lineno=931, end_col_offset=28)], lineno=930, col_offset=16, end_lineno=931, end_col_offset=28), Expr(value=Call(func=Attribute(value=Name(id='seen', ctx=Load(), lineno=932, col_offset=16, end_lineno=932, end_col_offset=20), attr='add', ctx=Load(), lineno=932, col_offset=16, end_lineno=932, end_col_offset=24), args=[Name(id='candidate_id', ctx=Load(), lineno=932, col_offset=25, end_lineno=932, end_col_offset=37)], lineno=932, col_offset=16, end_lineno=932, end_col_offset=38), lineno=932, col_offset=16, end_lineno=932, end_col_offset=38), Assign(targets=[Subscript(value=Name(id='merged_dists', ctx=Load(), lineno=933, col_offset=16, end_lineno=933, end_col_offset=28), slice=Tuple(elts=[Name(id='query_idx', ctx=Load(), lineno=933, col_offset=29, end_lineno=933, end_col_offset=38), Name(id='out_pos', ctx=Load(), lineno=933, col_offset=40, end_lineno=933, end_col_offset=47)], ctx=Load(), lineno=933, col_offset=29, end_lineno=933, end_col_offset=47), ctx=Store(), lineno=933, col_offset=16, end_lineno=933, end_col_offset=48)], value=Subscript(value=Name(id='all_dists', ctx=Load(), lineno=933, col_offset=51, end_lineno=933, end_col_offset=60), slice=Tuple(elts=[Name(id='query_idx', ctx=Load(), lineno=933, col_offset=61, end_lineno=933, end_col_offset=70), Name(id='candidate_idx', ctx=Load(), lineno=933, col_offset=72, end_lineno=933, end_col_offset=85)], ctx=Load(), lineno=933, col_offset=61, end_lineno=933, end_col_offset=85), ctx=Load(), lineno=933, col_offset=51, end_lineno=933, end_col_offset=86), lineno=933, col_offset=16, end_lineno=933, end_col_offset=86), Assign(targets=[Subscript(value=Name(id='merged_ids', ctx=Load(), lineno=934, col_offset=16, end_lineno=934, end_col_offset=26), slice=Tuple(elts=[Name(id='query_idx', ctx=Load(), lineno=934, col_offset=27, end_lineno=934, end_col_offset=36), Name(id='out_pos', ctx=Load(), lineno=934, col_offset=38, end_lineno=934, end_col_offset=45)], ctx=Load(), lineno=934, col_offset=27, end_lineno=934, end_col_offset=45), ctx=Store(), lineno=934, col_offset=16, end_lineno=934, end_col_offset=46)], value=Name(id='candidate_id', ctx=Load(), lineno=934, col_offset=49, end_lineno=934, end_col_offset=61), lineno=934, col_offset=16, end_lineno=934, end_col_offset=61), AugAssign(target=Name(id='out_pos', ctx=Store(), lineno=935, col_offset=16, end_lineno=935, end_col_offset=23), op=Add(), value=Constant(value=1, lineno=935, col_offset=27, end_lineno=935, end_col_offset=28), lineno=935, col_offset=16, end_lineno=935, end_col_offset=28), If(test=Compare(left=Name(id='out_pos', ctx=Load(), lineno=936, col_offset=19, end_lineno=936, end_col_offset=26), ops=[Eq()], comparators=[Name(id='k', ctx=Load(), lineno=936, col_offset=30, end_lineno=936, end_col_offset=31)], lineno=936, col_offset=19, end_lineno=936, end_col_offset=31), body=[Break(lineno=937, col_offset=20, end_lineno=937, end_col_offset=25)], lineno=936, col_offset=16, end_lineno=937, end_col_offset=25)], lineno=928, col_offset=12, end_lineno=937, end_col_offset=25)], lineno=925, col_offset=8, end_lineno=937, end_col_offset=25), Return(value=Tuple(elts=[Name(id='merged_dists', ctx=Load(), lineno=939, col_offset=15, end_lineno=939, end_col_offset=27), Name(id='merged_ids', ctx=Load(), lineno=939, col_offset=29, end_lineno=939, end_col_offset=39)], ctx=Load(), lineno=939, col_offset=15, end_lineno=939, end_col_offset=39), lineno=939, col_offset=8, end_lineno=939, end_col_offset=39)], decorator_list=[Name(id='staticmethod', ctx=Load(), lineno=875, col_offset=5, end_lineno=875, end_col_offset=17)], returns=Subscript(value=Name(id='tuple', ctx=Load(), lineno=882, col_offset=9, end_lineno=882, end_col_offset=14), slice=Tuple(elts=[Attribute(value=Name(id='np', ctx=Load(), lineno=882, col_offset=15, end_lineno=882, end_col_offset=17), attr='ndarray', ctx=Load(), lineno=882, col_offset=15, end_lineno=882, end_col_offset=25), Attribute(value=Name(id='np', ctx=Load(), lineno=882, col_offset=27, end_lineno=882, end_col_offset=29), attr='ndarray', ctx=Load(), lineno=882, col_offset=27, end_lineno=882, end_col_offset=37)], ctx=Load(), lineno=882, col_offset=15, end_lineno=882, end_col_offset=37), ctx=Load(), lineno=882, col_offset=9, end_lineno=882, end_col_offset=38), lineno=876, col_offset=4, end_lineno=939, end_col_offset=39), FunctionDef(name='merge_indexes', args=arguments(args=[arg(arg='self', lineno=941, col_offset=22, end_lineno=941, end_col_offset=26)]), body=[Expr(value=Constant(value='Merge secondary index into primary index (periodic rebuild).\n\n        Rebuilds the primary index to include all vectors from both the primary\n        and secondary indexes. After merging, the secondary index is cleared,\n        allowing for a fresh start for future incremental updates.\n\n        This operation is expensive (requires rebuilding the primary index) but\n        should be performed periodically to maintain optimal search performance.\n        After merging, search operations will only query the primary index,\n        which is faster than dual-index search.\n\n        The merge process:\n        1. Extracts all vectors and IDs from both primary and secondary indexes\n        2. Combines them into a single dataset\n        3. Rebuilds the primary index with adaptive type selection\n        4. Adds all vectors to the rebuilt primary index\n        5. Clears the secondary index and incremental IDs\n\n        Notes\n        -----\n        This method requires that vectors can be reconstructed from the indexes.\n        For IVF-PQ indexes, reconstruction may be approximate (quantized).\n        The method will raise RuntimeError if reconstruction is not supported.\n\n        Examples\n        --------\n        >>> manager = FAISSManager(index_path=Path("index.faiss"), vec_dim=2560)\n        >>> manager.build_index(initial_vectors)\n        >>> manager.update_index(new_vectors, new_ids)  # Add incrementally\n        >>> # Periodically merge to optimize performance\n        >>> manager.merge_indexes()  # Rebuilds primary with all vectors\n\n        Raises\n        ------\n        RuntimeError\n            If the primary index is not available, or if vector extraction fails\n            (e.g., index does not support reconstruction or ID mapping).\n        ', lineno=942, col_offset=8, end_lineno=979, end_col_offset=11), lineno=942, col_offset=8, end_lineno=979, end_col_offset=11), If(test=BoolOp(op=Or(), values=[Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=980, col_offset=11, end_lineno=980, end_col_offset=15), attr='secondary_index', ctx=Load(), lineno=980, col_offset=11, end_lineno=980, end_col_offset=31), ops=[Is()], comparators=[Constant(value=None, lineno=980, col_offset=35, end_lineno=980, end_col_offset=39)], lineno=980, col_offset=11, end_lineno=980, end_col_offset=39), Compare(left=Call(func=Name(id='len', ctx=Load(), lineno=980, col_offset=43, end_lineno=980, end_col_offset=46), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=980, col_offset=47, end_lineno=980, end_col_offset=51), attr='incremental_ids', ctx=Load(), lineno=980, col_offset=47, end_lineno=980, end_col_offset=67)], lineno=980, col_offset=43, end_lineno=980, end_col_offset=68), ops=[Eq()], comparators=[Constant(value=0, lineno=980, col_offset=72, end_lineno=980, end_col_offset=73)], lineno=980, col_offset=43, end_lineno=980, end_col_offset=73)], lineno=980, col_offset=11, end_lineno=980, end_col_offset=73), body=[Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=981, col_offset=12, end_lineno=981, end_col_offset=18), attr='info', ctx=Load(), lineno=981, col_offset=12, end_lineno=981, end_col_offset=23), args=[Constant(value='No secondary index to merge - skipping merge operation', lineno=982, col_offset=16, end_lineno=982, end_col_offset=72)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=983, col_offset=22, end_lineno=983, end_col_offset=32), keywords=[keyword(arg='secondary_size', value=Call(func=Name(id='len', ctx=Load(), lineno=983, col_offset=48, end_lineno=983, end_col_offset=51), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=983, col_offset=52, end_lineno=983, end_col_offset=56), attr='incremental_ids', ctx=Load(), lineno=983, col_offset=52, end_lineno=983, end_col_offset=72)], lineno=983, col_offset=48, end_lineno=983, end_col_offset=73), lineno=983, col_offset=33, end_lineno=983, end_col_offset=73)], lineno=983, col_offset=22, end_lineno=983, end_col_offset=74), lineno=983, col_offset=16, end_lineno=983, end_col_offset=74)], lineno=981, col_offset=12, end_lineno=984, end_col_offset=13), lineno=981, col_offset=12, end_lineno=984, end_col_offset=13), Return(lineno=985, col_offset=12, end_lineno=985, end_col_offset=18)], lineno=980, col_offset=8, end_lineno=985, end_col_offset=18), Try(body=[Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=988, col_offset=12, end_lineno=988, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=988, col_offset=24, end_lineno=988, end_col_offset=28), attr='_require_cpu_index', ctx=Load(), lineno=988, col_offset=24, end_lineno=988, end_col_offset=47), lineno=988, col_offset=24, end_lineno=988, end_col_offset=49), lineno=988, col_offset=12, end_lineno=988, end_col_offset=49)], handlers=[ExceptHandler(type=Name(id='RuntimeError', ctx=Load(), lineno=989, col_offset=15, end_lineno=989, end_col_offset=27), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=990, col_offset=12, end_lineno=990, end_col_offset=15)], value=Constant(value='Cannot merge indexes: primary index not available.', lineno=990, col_offset=18, end_lineno=990, end_col_offset=70), lineno=990, col_offset=12, end_lineno=990, end_col_offset=70), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=991, col_offset=18, end_lineno=991, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=991, col_offset=31, end_lineno=991, end_col_offset=34)], lineno=991, col_offset=18, end_lineno=991, end_col_offset=35), cause=Name(id='exc', ctx=Load(), lineno=991, col_offset=41, end_lineno=991, end_col_offset=44), lineno=991, col_offset=12, end_lineno=991, end_col_offset=44)], lineno=989, col_offset=8, end_lineno=991, end_col_offset=44)], lineno=987, col_offset=8, end_lineno=991, end_col_offset=44), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=994, col_offset=8, end_lineno=994, end_col_offset=14), attr='info', ctx=Load(), lineno=994, col_offset=8, end_lineno=994, end_col_offset=19), args=[Constant(value='Extracting vectors from primary and secondary indexes', lineno=995, col_offset=12, end_lineno=995, end_col_offset=67)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=996, col_offset=18, end_lineno=996, end_col_offset=28), keywords=[keyword(arg='secondary_vectors', value=Call(func=Name(id='len', ctx=Load(), lineno=996, col_offset=47, end_lineno=996, end_col_offset=50), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=996, col_offset=51, end_lineno=996, end_col_offset=55), attr='incremental_ids', ctx=Load(), lineno=996, col_offset=51, end_lineno=996, end_col_offset=71)], lineno=996, col_offset=47, end_lineno=996, end_col_offset=72), lineno=996, col_offset=29, end_lineno=996, end_col_offset=72)], lineno=996, col_offset=18, end_lineno=996, end_col_offset=73), lineno=996, col_offset=12, end_lineno=996, end_col_offset=73)], lineno=994, col_offset=8, end_lineno=997, end_col_offset=9), lineno=994, col_offset=8, end_lineno=997, end_col_offset=9), Assign(targets=[Tuple(elts=[Name(id='primary_vectors', ctx=Store(), lineno=998, col_offset=8, end_lineno=998, end_col_offset=23), Name(id='primary_ids', ctx=Store(), lineno=998, col_offset=25, end_lineno=998, end_col_offset=36)], ctx=Store(), lineno=998, col_offset=8, end_lineno=998, end_col_offset=36)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=998, col_offset=39, end_lineno=998, end_col_offset=43), attr='_extract_all_vectors', ctx=Load(), lineno=998, col_offset=39, end_lineno=998, end_col_offset=64), args=[Name(id='cpu_index', ctx=Load(), lineno=998, col_offset=65, end_lineno=998, end_col_offset=74)], lineno=998, col_offset=39, end_lineno=998, end_col_offset=75), lineno=998, col_offset=8, end_lineno=998, end_col_offset=75), Assign(targets=[Tuple(elts=[Name(id='secondary_vectors', ctx=Store(), lineno=999, col_offset=8, end_lineno=999, end_col_offset=25), Name(id='secondary_ids', ctx=Store(), lineno=999, col_offset=27, end_lineno=999, end_col_offset=40)], ctx=Store(), lineno=999, col_offset=8, end_lineno=999, end_col_offset=40)], value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=999, col_offset=43, end_lineno=999, end_col_offset=47), attr='_extract_all_vectors', ctx=Load(), lineno=999, col_offset=43, end_lineno=999, end_col_offset=68), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=999, col_offset=69, end_lineno=999, end_col_offset=73), attr='secondary_index', ctx=Load(), lineno=999, col_offset=69, end_lineno=999, end_col_offset=89)], lineno=999, col_offset=43, end_lineno=999, end_col_offset=90), lineno=999, col_offset=8, end_lineno=999, end_col_offset=90), Assign(targets=[Name(id='all_vectors', ctx=Store(), lineno=1002, col_offset=8, end_lineno=1002, end_col_offset=19)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=1002, col_offset=22, end_lineno=1002, end_col_offset=24), attr='vstack', ctx=Load(), lineno=1002, col_offset=22, end_lineno=1002, end_col_offset=31), args=[List(elts=[Name(id='primary_vectors', ctx=Load(), lineno=1002, col_offset=33, end_lineno=1002, end_col_offset=48), Name(id='secondary_vectors', ctx=Load(), lineno=1002, col_offset=50, end_lineno=1002, end_col_offset=67)], ctx=Load(), lineno=1002, col_offset=32, end_lineno=1002, end_col_offset=68)], lineno=1002, col_offset=22, end_lineno=1002, end_col_offset=69), lineno=1002, col_offset=8, end_lineno=1002, end_col_offset=69), Assign(targets=[Name(id='all_ids', ctx=Store(), lineno=1003, col_offset=8, end_lineno=1003, end_col_offset=15)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=1003, col_offset=18, end_lineno=1003, end_col_offset=20), attr='concatenate', ctx=Load(), lineno=1003, col_offset=18, end_lineno=1003, end_col_offset=32), args=[List(elts=[Name(id='primary_ids', ctx=Load(), lineno=1003, col_offset=34, end_lineno=1003, end_col_offset=45), Name(id='secondary_ids', ctx=Load(), lineno=1003, col_offset=47, end_lineno=1003, end_col_offset=60)], ctx=Load(), lineno=1003, col_offset=33, end_lineno=1003, end_col_offset=61)], lineno=1003, col_offset=18, end_lineno=1003, end_col_offset=62), lineno=1003, col_offset=8, end_lineno=1003, end_col_offset=62), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=1005, col_offset=8, end_lineno=1005, end_col_offset=14), attr='info', ctx=Load(), lineno=1005, col_offset=8, end_lineno=1005, end_col_offset=19), args=[Constant(value='Merging indexes', lineno=1006, col_offset=12, end_lineno=1006, end_col_offset=29)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=1007, col_offset=18, end_lineno=1007, end_col_offset=28), keywords=[keyword(arg='primary_vectors', value=Call(func=Name(id='len', ctx=Load(), lineno=1008, col_offset=32, end_lineno=1008, end_col_offset=35), args=[Name(id='primary_ids', ctx=Load(), lineno=1008, col_offset=36, end_lineno=1008, end_col_offset=47)], lineno=1008, col_offset=32, end_lineno=1008, end_col_offset=48), lineno=1008, col_offset=16, end_lineno=1008, end_col_offset=48), keyword(arg='secondary_vectors', value=Call(func=Name(id='len', ctx=Load(), lineno=1009, col_offset=34, end_lineno=1009, end_col_offset=37), args=[Name(id='secondary_ids', ctx=Load(), lineno=1009, col_offset=38, end_lineno=1009, end_col_offset=51)], lineno=1009, col_offset=34, end_lineno=1009, end_col_offset=52), lineno=1009, col_offset=16, end_lineno=1009, end_col_offset=52), keyword(arg='total_vectors', value=Call(func=Name(id='len', ctx=Load(), lineno=1010, col_offset=30, end_lineno=1010, end_col_offset=33), args=[Name(id='all_ids', ctx=Load(), lineno=1010, col_offset=34, end_lineno=1010, end_col_offset=41)], lineno=1010, col_offset=30, end_lineno=1010, end_col_offset=42), lineno=1010, col_offset=16, end_lineno=1010, end_col_offset=42)], lineno=1007, col_offset=18, end_lineno=1011, end_col_offset=13), lineno=1007, col_offset=12, end_lineno=1011, end_col_offset=13)], lineno=1005, col_offset=8, end_lineno=1012, end_col_offset=9), lineno=1005, col_offset=8, end_lineno=1012, end_col_offset=9), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=1016, col_offset=8, end_lineno=1016, end_col_offset=12), attr='build_index', ctx=Load(), lineno=1016, col_offset=8, end_lineno=1016, end_col_offset=24), args=[Name(id='all_vectors', ctx=Load(), lineno=1016, col_offset=25, end_lineno=1016, end_col_offset=36)], lineno=1016, col_offset=8, end_lineno=1016, end_col_offset=37), lineno=1016, col_offset=8, end_lineno=1016, end_col_offset=37), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load(), lineno=1017, col_offset=8, end_lineno=1017, end_col_offset=12), attr='add_vectors', ctx=Load(), lineno=1017, col_offset=8, end_lineno=1017, end_col_offset=24), args=[Name(id='all_vectors', ctx=Load(), lineno=1017, col_offset=25, end_lineno=1017, end_col_offset=36), Name(id='all_ids', ctx=Load(), lineno=1017, col_offset=38, end_lineno=1017, end_col_offset=45)], lineno=1017, col_offset=8, end_lineno=1017, end_col_offset=46), lineno=1017, col_offset=8, end_lineno=1017, end_col_offset=46), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=1020, col_offset=8, end_lineno=1020, end_col_offset=12), attr='secondary_index', ctx=Store(), lineno=1020, col_offset=8, end_lineno=1020, end_col_offset=28)], value=Constant(value=None, lineno=1020, col_offset=31, end_lineno=1020, end_col_offset=35), lineno=1020, col_offset=8, end_lineno=1020, end_col_offset=35), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=1021, col_offset=8, end_lineno=1021, end_col_offset=12), attr='secondary_gpu_index', ctx=Store(), lineno=1021, col_offset=8, end_lineno=1021, end_col_offset=32)], value=Constant(value=None, lineno=1021, col_offset=35, end_lineno=1021, end_col_offset=39), lineno=1021, col_offset=8, end_lineno=1021, end_col_offset=39), Expr(value=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=1022, col_offset=8, end_lineno=1022, end_col_offset=12), attr='incremental_ids', ctx=Load(), lineno=1022, col_offset=8, end_lineno=1022, end_col_offset=28), attr='clear', ctx=Load(), lineno=1022, col_offset=8, end_lineno=1022, end_col_offset=34), lineno=1022, col_offset=8, end_lineno=1022, end_col_offset=36), lineno=1022, col_offset=8, end_lineno=1022, end_col_offset=36), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=1024, col_offset=8, end_lineno=1024, end_col_offset=14), attr='info', ctx=Load(), lineno=1024, col_offset=8, end_lineno=1024, end_col_offset=19), args=[Constant(value='Successfully merged secondary vectors into primary index', lineno=1025, col_offset=12, end_lineno=1025, end_col_offset=70)], keywords=[keyword(arg='extra', value=Call(func=Name(id='_log_extra', ctx=Load(), lineno=1026, col_offset=18, end_lineno=1026, end_col_offset=28), keywords=[keyword(arg='merged_secondary', value=Call(func=Name(id='len', ctx=Load(), lineno=1027, col_offset=33, end_lineno=1027, end_col_offset=36), args=[Name(id='secondary_ids', ctx=Load(), lineno=1027, col_offset=37, end_lineno=1027, end_col_offset=50)], lineno=1027, col_offset=33, end_lineno=1027, end_col_offset=51), lineno=1027, col_offset=16, end_lineno=1027, end_col_offset=51), keyword(arg='total_vectors', value=Call(func=Name(id='len', ctx=Load(), lineno=1028, col_offset=30, end_lineno=1028, end_col_offset=33), args=[Name(id='all_ids', ctx=Load(), lineno=1028, col_offset=34, end_lineno=1028, end_col_offset=41)], lineno=1028, col_offset=30, end_lineno=1028, end_col_offset=42), lineno=1028, col_offset=16, end_lineno=1028, end_col_offset=42), keyword(arg='primary_vectors', value=Call(func=Name(id='len', ctx=Load(), lineno=1029, col_offset=32, end_lineno=1029, end_col_offset=35), args=[Name(id='primary_ids', ctx=Load(), lineno=1029, col_offset=36, end_lineno=1029, end_col_offset=47)], lineno=1029, col_offset=32, end_lineno=1029, end_col_offset=48), lineno=1029, col_offset=16, end_lineno=1029, end_col_offset=48)], lineno=1026, col_offset=18, end_lineno=1030, end_col_offset=13), lineno=1026, col_offset=12, end_lineno=1030, end_col_offset=13)], lineno=1024, col_offset=8, end_lineno=1031, end_col_offset=9), lineno=1024, col_offset=8, end_lineno=1031, end_col_offset=9)], returns=Constant(value=None, lineno=941, col_offset=31, end_lineno=941, end_col_offset=35), lineno=941, col_offset=4, end_lineno=1031, end_col_offset=9), FunctionDef(name='_extract_all_vectors', args=arguments(args=[arg(arg='self', lineno=1033, col_offset=29, end_lineno=1033, end_col_offset=33), arg(arg='index', annotation=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=1033, col_offset=42, end_lineno=1033, end_col_offset=48), attr='Index', ctx=Load(), lineno=1033, col_offset=42, end_lineno=1033, end_col_offset=54), lineno=1033, col_offset=35, end_lineno=1033, end_col_offset=54)]), body=[Expr(value=Constant(value="Extract all vectors and IDs from a FAISS index.\n\n        Reconstructs vectors from the index and retrieves their associated IDs.\n        For quantized indexes (e.g., IVF-PQ), reconstruction returns approximate\n        vectors (dequantized from the codebook).\n\n        Parameters\n        ----------\n        index : _faiss.Index\n            FAISS index to extract vectors from. Must support `reconstruct()` and\n            have an `id_map` attribute (IndexIDMap2 wrapper).\n\n        Returns\n        -------\n        tuple[np.ndarray, np.ndarray]\n            Tuple of (vectors, ids):\n            - vectors: shape (n_vectors, vec_dim), dtype float32\n            - ids: shape (n_vectors,), dtype int64\n\n        Raises\n        ------\n        RuntimeError\n            If the index does not support vector reconstruction or ID mapping.\n            This can occur with certain index types or if the index is not wrapped\n            with IndexIDMap2.\n        TypeError\n            If the index's ``id_map`` interface is invalid (missing ``at`` or not callable),\n            or if the id_map interface is missing required methods.\n        ", lineno=1034, col_offset=8, end_lineno=1062, end_col_offset=11), lineno=1034, col_offset=8, end_lineno=1062, end_col_offset=11), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=1063, col_offset=8, end_lineno=1063, end_col_offset=17)], value=Attribute(value=Name(id='index', ctx=Load(), lineno=1063, col_offset=20, end_lineno=1063, end_col_offset=25), attr='ntotal', ctx=Load(), lineno=1063, col_offset=20, end_lineno=1063, end_col_offset=32), lineno=1063, col_offset=8, end_lineno=1063, end_col_offset=32), If(test=Compare(left=Name(id='n_vectors', ctx=Load(), lineno=1064, col_offset=11, end_lineno=1064, end_col_offset=20), ops=[Eq()], comparators=[Constant(value=0, lineno=1064, col_offset=24, end_lineno=1064, end_col_offset=25)], lineno=1064, col_offset=11, end_lineno=1064, end_col_offset=25), body=[Return(value=Tuple(elts=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=1065, col_offset=19, end_lineno=1065, end_col_offset=21), attr='empty', ctx=Load(), lineno=1065, col_offset=19, end_lineno=1065, end_col_offset=27), args=[Tuple(elts=[Constant(value=0, lineno=1065, col_offset=29, end_lineno=1065, end_col_offset=30), Attribute(value=Name(id='self', ctx=Load(), lineno=1065, col_offset=32, end_lineno=1065, end_col_offset=36), attr='vec_dim', ctx=Load(), lineno=1065, col_offset=32, end_lineno=1065, end_col_offset=44)], ctx=Load(), lineno=1065, col_offset=28, end_lineno=1065, end_col_offset=45)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=1065, col_offset=53, end_lineno=1065, end_col_offset=55), attr='float32', ctx=Load(), lineno=1065, col_offset=53, end_lineno=1065, end_col_offset=63), lineno=1065, col_offset=47, end_lineno=1065, end_col_offset=63)], lineno=1065, col_offset=19, end_lineno=1065, end_col_offset=64), Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=1065, col_offset=66, end_lineno=1065, end_col_offset=68), attr='empty', ctx=Load(), lineno=1065, col_offset=66, end_lineno=1065, end_col_offset=74), args=[Constant(value=0, lineno=1065, col_offset=75, end_lineno=1065, end_col_offset=76)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=1065, col_offset=84, end_lineno=1065, end_col_offset=86), attr='int64', ctx=Load(), lineno=1065, col_offset=84, end_lineno=1065, end_col_offset=92), lineno=1065, col_offset=78, end_lineno=1065, end_col_offset=92)], lineno=1065, col_offset=66, end_lineno=1065, end_col_offset=93)], ctx=Load(), lineno=1065, col_offset=19, end_lineno=1065, end_col_offset=93), lineno=1065, col_offset=12, end_lineno=1065, end_col_offset=93)], lineno=1064, col_offset=8, end_lineno=1065, end_col_offset=93), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=1067, col_offset=8, end_lineno=1067, end_col_offset=15)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=1067, col_offset=18, end_lineno=1067, end_col_offset=20), attr='empty', ctx=Load(), lineno=1067, col_offset=18, end_lineno=1067, end_col_offset=26), args=[Tuple(elts=[Name(id='n_vectors', ctx=Load(), lineno=1067, col_offset=28, end_lineno=1067, end_col_offset=37), Attribute(value=Name(id='self', ctx=Load(), lineno=1067, col_offset=39, end_lineno=1067, end_col_offset=43), attr='vec_dim', ctx=Load(), lineno=1067, col_offset=39, end_lineno=1067, end_col_offset=51)], ctx=Load(), lineno=1067, col_offset=27, end_lineno=1067, end_col_offset=52)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=1067, col_offset=60, end_lineno=1067, end_col_offset=62), attr='float32', ctx=Load(), lineno=1067, col_offset=60, end_lineno=1067, end_col_offset=70), lineno=1067, col_offset=54, end_lineno=1067, end_col_offset=70)], lineno=1067, col_offset=18, end_lineno=1067, end_col_offset=71), lineno=1067, col_offset=8, end_lineno=1067, end_col_offset=71), Assign(targets=[Name(id='ids', ctx=Store(), lineno=1068, col_offset=8, end_lineno=1068, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=1068, col_offset=14, end_lineno=1068, end_col_offset=16), attr='empty', ctx=Load(), lineno=1068, col_offset=14, end_lineno=1068, end_col_offset=22), args=[Name(id='n_vectors', ctx=Load(), lineno=1068, col_offset=23, end_lineno=1068, end_col_offset=32)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=1068, col_offset=40, end_lineno=1068, end_col_offset=42), attr='int64', ctx=Load(), lineno=1068, col_offset=40, end_lineno=1068, end_col_offset=48), lineno=1068, col_offset=34, end_lineno=1068, end_col_offset=48)], lineno=1068, col_offset=14, end_lineno=1068, end_col_offset=49), lineno=1068, col_offset=8, end_lineno=1068, end_col_offset=49), If(test=UnaryOp(op=Not(), operand=Call(func=Name(id='hasattr', ctx=Load(), lineno=1071, col_offset=15, end_lineno=1071, end_col_offset=22), args=[Name(id='index', ctx=Load(), lineno=1071, col_offset=23, end_lineno=1071, end_col_offset=28), Constant(value='id_map', lineno=1071, col_offset=30, end_lineno=1071, end_col_offset=38)], lineno=1071, col_offset=15, end_lineno=1071, end_col_offset=39), lineno=1071, col_offset=11, end_lineno=1071, end_col_offset=39), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=1072, col_offset=12, end_lineno=1072, end_col_offset=15)], value=JoinedStr(values=[Constant(value='Index type ', lineno=1073, col_offset=18, end_lineno=1073, end_col_offset=29), FormattedValue(value=Attribute(value=Call(func=Name(id='type', ctx=Load(), lineno=1073, col_offset=30, end_lineno=1073, end_col_offset=34), args=[Name(id='index', ctx=Load(), lineno=1073, col_offset=35, end_lineno=1073, end_col_offset=40)], lineno=1073, col_offset=30, end_lineno=1073, end_col_offset=41), attr='__name__', ctx=Load(), lineno=1073, col_offset=30, end_lineno=1073, end_col_offset=50), conversion=-1, lineno=1073, col_offset=29, end_lineno=1073, end_col_offset=51), Constant(value=' does not support ID mapping. Index must be wrapped with IndexIDMap2.', lineno=1073, col_offset=51, end_lineno=1074, end_col_offset=57)], lineno=1073, col_offset=16, end_lineno=1074, end_col_offset=57), lineno=1072, col_offset=12, end_lineno=1075, end_col_offset=13), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=1076, col_offset=18, end_lineno=1076, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=1076, col_offset=31, end_lineno=1076, end_col_offset=34)], lineno=1076, col_offset=18, end_lineno=1076, end_col_offset=35), lineno=1076, col_offset=12, end_lineno=1076, end_col_offset=35)], lineno=1071, col_offset=8, end_lineno=1076, end_col_offset=35), Assign(targets=[Name(id='id_map_obj', ctx=Store(), lineno=1079, col_offset=8, end_lineno=1079, end_col_offset=18)], value=Call(func=Name(id='getattr', ctx=Load(), lineno=1079, col_offset=21, end_lineno=1079, end_col_offset=28), args=[Name(id='index', ctx=Load(), lineno=1079, col_offset=29, end_lineno=1079, end_col_offset=34), Constant(value='id_map', lineno=1079, col_offset=36, end_lineno=1079, end_col_offset=44), Constant(value=None, lineno=1079, col_offset=46, end_lineno=1079, end_col_offset=50)], lineno=1079, col_offset=21, end_lineno=1079, end_col_offset=51), lineno=1079, col_offset=8, end_lineno=1079, end_col_offset=51), If(test=BoolOp(op=Or(), values=[Compare(left=Name(id='id_map_obj', ctx=Load(), lineno=1080, col_offset=11, end_lineno=1080, end_col_offset=21), ops=[Is()], comparators=[Constant(value=None, lineno=1080, col_offset=25, end_lineno=1080, end_col_offset=29)], lineno=1080, col_offset=11, end_lineno=1080, end_col_offset=29), UnaryOp(op=Not(), operand=Call(func=Name(id='callable', ctx=Load(), lineno=1080, col_offset=37, end_lineno=1080, end_col_offset=45), args=[Call(func=Name(id='getattr', ctx=Load(), lineno=1080, col_offset=46, end_lineno=1080, end_col_offset=53), args=[Name(id='id_map_obj', ctx=Load(), lineno=1080, col_offset=54, end_lineno=1080, end_col_offset=64), Constant(value='at', lineno=1080, col_offset=66, end_lineno=1080, end_col_offset=70), Constant(value=None, lineno=1080, col_offset=72, end_lineno=1080, end_col_offset=76)], lineno=1080, col_offset=46, end_lineno=1080, end_col_offset=77)], lineno=1080, col_offset=37, end_lineno=1080, end_col_offset=78), lineno=1080, col_offset=33, end_lineno=1080, end_col_offset=78)], lineno=1080, col_offset=11, end_lineno=1080, end_col_offset=78), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=1081, col_offset=12, end_lineno=1081, end_col_offset=15)], value=JoinedStr(values=[Constant(value='Index type ', lineno=1081, col_offset=20, end_lineno=1081, end_col_offset=31), FormattedValue(value=Attribute(value=Call(func=Name(id='type', ctx=Load(), lineno=1081, col_offset=32, end_lineno=1081, end_col_offset=36), args=[Name(id='index', ctx=Load(), lineno=1081, col_offset=37, end_lineno=1081, end_col_offset=42)], lineno=1081, col_offset=32, end_lineno=1081, end_col_offset=43), attr='__name__', ctx=Load(), lineno=1081, col_offset=32, end_lineno=1081, end_col_offset=52), conversion=-1, lineno=1081, col_offset=31, end_lineno=1081, end_col_offset=53), Constant(value=' has invalid id_map interface.', lineno=1081, col_offset=53, end_lineno=1081, end_col_offset=83)], lineno=1081, col_offset=18, end_lineno=1081, end_col_offset=84), lineno=1081, col_offset=12, end_lineno=1081, end_col_offset=84), Raise(exc=Call(func=Name(id='TypeError', ctx=Load(), lineno=1082, col_offset=18, end_lineno=1082, end_col_offset=27), args=[Name(id='msg', ctx=Load(), lineno=1082, col_offset=28, end_lineno=1082, end_col_offset=31)], lineno=1082, col_offset=18, end_lineno=1082, end_col_offset=32), lineno=1082, col_offset=12, end_lineno=1082, end_col_offset=32)], lineno=1080, col_offset=8, end_lineno=1082, end_col_offset=32), Assign(targets=[Name(id='at_callable', ctx=Store(), lineno=1083, col_offset=8, end_lineno=1083, end_col_offset=19)], value=Call(func=Name(id='cast', ctx=Load(), lineno=1083, col_offset=22, end_lineno=1083, end_col_offset=26), args=[Constant(value='Callable[[int], int]', lineno=1083, col_offset=27, end_lineno=1083, end_col_offset=49), Attribute(value=Name(id='id_map_obj', ctx=Load(), lineno=1083, col_offset=51, end_lineno=1083, end_col_offset=61), attr='at', ctx=Load(), lineno=1083, col_offset=51, end_lineno=1083, end_col_offset=64)], lineno=1083, col_offset=22, end_lineno=1083, end_col_offset=65), lineno=1083, col_offset=8, end_lineno=1083, end_col_offset=65), For(target=Name(id='i', ctx=Store(), lineno=1085, col_offset=12, end_lineno=1085, end_col_offset=13), iter=Call(func=Name(id='range', ctx=Load(), lineno=1085, col_offset=17, end_lineno=1085, end_col_offset=22), args=[Name(id='n_vectors', ctx=Load(), lineno=1085, col_offset=23, end_lineno=1085, end_col_offset=32)], lineno=1085, col_offset=17, end_lineno=1085, end_col_offset=33), body=[Try(body=[Assign(targets=[Subscript(value=Name(id='vectors', ctx=Load(), lineno=1087, col_offset=16, end_lineno=1087, end_col_offset=23), slice=Name(id='i', ctx=Load(), lineno=1087, col_offset=24, end_lineno=1087, end_col_offset=25), ctx=Store(), lineno=1087, col_offset=16, end_lineno=1087, end_col_offset=26)], value=Call(func=Attribute(value=Name(id='index', ctx=Load(), lineno=1087, col_offset=29, end_lineno=1087, end_col_offset=34), attr='reconstruct', ctx=Load(), lineno=1087, col_offset=29, end_lineno=1087, end_col_offset=46), args=[Name(id='i', ctx=Load(), lineno=1087, col_offset=47, end_lineno=1087, end_col_offset=48)], lineno=1087, col_offset=29, end_lineno=1087, end_col_offset=49), lineno=1087, col_offset=16, end_lineno=1087, end_col_offset=49), Assign(targets=[Subscript(value=Name(id='ids', ctx=Load(), lineno=1088, col_offset=16, end_lineno=1088, end_col_offset=19), slice=Name(id='i', ctx=Load(), lineno=1088, col_offset=20, end_lineno=1088, end_col_offset=21), ctx=Store(), lineno=1088, col_offset=16, end_lineno=1088, end_col_offset=22)], value=Call(func=Name(id='at_callable', ctx=Load(), lineno=1088, col_offset=25, end_lineno=1088, end_col_offset=36), args=[Name(id='i', ctx=Load(), lineno=1088, col_offset=37, end_lineno=1088, end_col_offset=38)], lineno=1088, col_offset=25, end_lineno=1088, end_col_offset=39), lineno=1088, col_offset=16, end_lineno=1088, end_col_offset=39)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='AttributeError', ctx=Load(), lineno=1089, col_offset=20, end_lineno=1089, end_col_offset=34), Name(id='RuntimeError', ctx=Load(), lineno=1089, col_offset=36, end_lineno=1089, end_col_offset=48)], ctx=Load(), lineno=1089, col_offset=19, end_lineno=1089, end_col_offset=49), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=1090, col_offset=16, end_lineno=1090, end_col_offset=19)], value=JoinedStr(values=[Constant(value='Failed to extract vector at index ', lineno=1090, col_offset=24, end_lineno=1090, end_col_offset=58), FormattedValue(value=Name(id='i', ctx=Load(), lineno=1090, col_offset=59, end_lineno=1090, end_col_offset=60), conversion=-1, lineno=1090, col_offset=58, end_lineno=1090, end_col_offset=61), Constant(value=': ', lineno=1090, col_offset=61, end_lineno=1090, end_col_offset=63), FormattedValue(value=Name(id='exc', ctx=Load(), lineno=1090, col_offset=64, end_lineno=1090, end_col_offset=67), conversion=-1, lineno=1090, col_offset=63, end_lineno=1090, end_col_offset=68)], lineno=1090, col_offset=22, end_lineno=1090, end_col_offset=69), lineno=1090, col_offset=16, end_lineno=1090, end_col_offset=69), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=1091, col_offset=22, end_lineno=1091, end_col_offset=34), args=[Name(id='msg', ctx=Load(), lineno=1091, col_offset=35, end_lineno=1091, end_col_offset=38)], lineno=1091, col_offset=22, end_lineno=1091, end_col_offset=39), cause=Name(id='exc', ctx=Load(), lineno=1091, col_offset=45, end_lineno=1091, end_col_offset=48), lineno=1091, col_offset=16, end_lineno=1091, end_col_offset=48)], lineno=1089, col_offset=12, end_lineno=1091, end_col_offset=48)], lineno=1086, col_offset=12, end_lineno=1091, end_col_offset=48)], lineno=1085, col_offset=8, end_lineno=1091, end_col_offset=48), Return(value=Tuple(elts=[Name(id='vectors', ctx=Load(), lineno=1093, col_offset=15, end_lineno=1093, end_col_offset=22), Name(id='ids', ctx=Load(), lineno=1093, col_offset=24, end_lineno=1093, end_col_offset=27)], ctx=Load(), lineno=1093, col_offset=15, end_lineno=1093, end_col_offset=27), lineno=1093, col_offset=8, end_lineno=1093, end_col_offset=27)], returns=Subscript(value=Name(id='tuple', ctx=Load(), lineno=1033, col_offset=59, end_lineno=1033, end_col_offset=64), slice=Tuple(elts=[Attribute(value=Name(id='np', ctx=Load(), lineno=1033, col_offset=65, end_lineno=1033, end_col_offset=67), attr='ndarray', ctx=Load(), lineno=1033, col_offset=65, end_lineno=1033, end_col_offset=75), Attribute(value=Name(id='np', ctx=Load(), lineno=1033, col_offset=77, end_lineno=1033, end_col_offset=79), attr='ndarray', ctx=Load(), lineno=1033, col_offset=77, end_lineno=1033, end_col_offset=87)], ctx=Load(), lineno=1033, col_offset=65, end_lineno=1033, end_col_offset=87), ctx=Load(), lineno=1033, col_offset=59, end_lineno=1033, end_col_offset=88), lineno=1033, col_offset=4, end_lineno=1093, end_col_offset=27), FunctionDef(name='_try_load_cuvs', args=arguments(), body=[Expr(value=Constant(value='Load cuVS acceleration library if available.\n\n        Raises\n        ------\n        ImportError\n            If the optional pylibcuvs package is not installed.\n        RuntimeError\n            If the cuVS shared library cannot be loaded.\n        ', lineno=1097, col_offset=8, end_lineno=1105, end_col_offset=11), lineno=1097, col_offset=8, end_lineno=1105, end_col_offset=11), Try(body=[Assign(targets=[Name(id='pylibcuvs', ctx=Store(), lineno=1107, col_offset=12, end_lineno=1107, end_col_offset=21)], value=Call(func=Attribute(value=Name(id='importlib', ctx=Load(), lineno=1107, col_offset=24, end_lineno=1107, end_col_offset=33), attr='import_module', ctx=Load(), lineno=1107, col_offset=24, end_lineno=1107, end_col_offset=47), args=[Constant(value='pylibcuvs', lineno=1107, col_offset=48, end_lineno=1107, end_col_offset=59)], lineno=1107, col_offset=24, end_lineno=1107, end_col_offset=60), lineno=1107, col_offset=12, end_lineno=1107, end_col_offset=60)], handlers=[ExceptHandler(type=Name(id='ImportError', ctx=Load(), lineno=1108, col_offset=15, end_lineno=1108, end_col_offset=26), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=1109, col_offset=12, end_lineno=1109, end_col_offset=15)], value=Constant(value='pylibcuvs is required for cuVS acceleration', lineno=1109, col_offset=18, end_lineno=1109, end_col_offset=63), lineno=1109, col_offset=12, end_lineno=1109, end_col_offset=63), Raise(exc=Call(func=Name(id='ImportError', ctx=Load(), lineno=1110, col_offset=18, end_lineno=1110, end_col_offset=29), args=[Name(id='msg', ctx=Load(), lineno=1110, col_offset=30, end_lineno=1110, end_col_offset=33)], lineno=1110, col_offset=18, end_lineno=1110, end_col_offset=34), cause=Name(id='exc', ctx=Load(), lineno=1110, col_offset=40, end_lineno=1110, end_col_offset=43), lineno=1110, col_offset=12, end_lineno=1110, end_col_offset=43)], lineno=1108, col_offset=8, end_lineno=1110, end_col_offset=43)], lineno=1106, col_offset=8, end_lineno=1110, end_col_offset=43), Try(body=[Assign(targets=[Name(id='load_library', ctx=Store(), lineno=1113, col_offset=12, end_lineno=1113, end_col_offset=24)], value=Attribute(value=Name(id='pylibcuvs', ctx=Load(), lineno=1113, col_offset=27, end_lineno=1113, end_col_offset=36), attr='load_library', ctx=Load(), lineno=1113, col_offset=27, end_lineno=1113, end_col_offset=49), lineno=1113, col_offset=12, end_lineno=1113, end_col_offset=49)], handlers=[ExceptHandler(type=Name(id='AttributeError', ctx=Load(), lineno=1114, col_offset=15, end_lineno=1114, end_col_offset=29), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=1115, col_offset=12, end_lineno=1115, end_col_offset=15)], value=Constant(value='pylibcuvs does not expose load_library()', lineno=1115, col_offset=18, end_lineno=1115, end_col_offset=60), lineno=1115, col_offset=12, end_lineno=1115, end_col_offset=60), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=1116, col_offset=18, end_lineno=1116, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=1116, col_offset=31, end_lineno=1116, end_col_offset=34)], lineno=1116, col_offset=18, end_lineno=1116, end_col_offset=35), cause=Name(id='exc', ctx=Load(), lineno=1116, col_offset=41, end_lineno=1116, end_col_offset=44), lineno=1116, col_offset=12, end_lineno=1116, end_col_offset=44)], lineno=1114, col_offset=8, end_lineno=1116, end_col_offset=44)], lineno=1112, col_offset=8, end_lineno=1116, end_col_offset=44), Try(body=[Expr(value=Call(func=Name(id='load_library', ctx=Load(), lineno=1119, col_offset=12, end_lineno=1119, end_col_offset=24), lineno=1119, col_offset=12, end_lineno=1119, end_col_offset=26), lineno=1119, col_offset=12, end_lineno=1119, end_col_offset=26)], handlers=[ExceptHandler(type=Name(id='OSError', ctx=Load(), lineno=1120, col_offset=15, end_lineno=1120, end_col_offset=22), name='exc', body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=1121, col_offset=12, end_lineno=1121, end_col_offset=15)], value=Constant(value='Failed to load cuVS shared libraries', lineno=1121, col_offset=18, end_lineno=1121, end_col_offset=56), lineno=1121, col_offset=12, end_lineno=1121, end_col_offset=56), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=1122, col_offset=18, end_lineno=1122, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=1122, col_offset=31, end_lineno=1122, end_col_offset=34)], lineno=1122, col_offset=18, end_lineno=1122, end_col_offset=35), cause=Name(id='exc', ctx=Load(), lineno=1122, col_offset=41, end_lineno=1122, end_col_offset=44), lineno=1122, col_offset=12, end_lineno=1122, end_col_offset=44)], lineno=1120, col_offset=8, end_lineno=1122, end_col_offset=44)], lineno=1118, col_offset=8, end_lineno=1122, end_col_offset=44)], decorator_list=[Name(id='staticmethod', ctx=Load(), lineno=1095, col_offset=5, end_lineno=1095, end_col_offset=17)], returns=Constant(value=None, lineno=1096, col_offset=28, end_lineno=1096, end_col_offset=32), lineno=1096, col_offset=4, end_lineno=1122, end_col_offset=44), FunctionDef(name='_require_cpu_index', args=arguments(args=[arg(arg='self', lineno=1124, col_offset=27, end_lineno=1124, end_col_offset=31)]), body=[Expr(value=Constant(value='Return the CPU index if initialized.\n\n        Returns\n        -------\n        _faiss.Index\n            Initialized CPU FAISS index.\n\n        Raises\n        ------\n        RuntimeError\n            If the index has not been built or loaded yet.\n        ', lineno=1125, col_offset=8, end_lineno=1136, end_col_offset=11), lineno=1125, col_offset=8, end_lineno=1136, end_col_offset=11), If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=1137, col_offset=11, end_lineno=1137, end_col_offset=15), attr='cpu_index', ctx=Load(), lineno=1137, col_offset=11, end_lineno=1137, end_col_offset=25), ops=[Is()], comparators=[Constant(value=None, lineno=1137, col_offset=29, end_lineno=1137, end_col_offset=33)], lineno=1137, col_offset=11, end_lineno=1137, end_col_offset=33), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=1138, col_offset=12, end_lineno=1138, end_col_offset=15)], value=Constant(value='Index not built', lineno=1138, col_offset=18, end_lineno=1138, end_col_offset=35), lineno=1138, col_offset=12, end_lineno=1138, end_col_offset=35), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=1139, col_offset=18, end_lineno=1139, end_col_offset=30), args=[Name(id='msg', ctx=Load(), lineno=1139, col_offset=31, end_lineno=1139, end_col_offset=34)], lineno=1139, col_offset=18, end_lineno=1139, end_col_offset=35), lineno=1139, col_offset=12, end_lineno=1139, end_col_offset=35)], lineno=1137, col_offset=8, end_lineno=1139, end_col_offset=35), Return(value=Attribute(value=Name(id='self', ctx=Load(), lineno=1140, col_offset=15, end_lineno=1140, end_col_offset=19), attr='cpu_index', ctx=Load(), lineno=1140, col_offset=15, end_lineno=1140, end_col_offset=29), lineno=1140, col_offset=8, end_lineno=1140, end_col_offset=29)], returns=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=1124, col_offset=36, end_lineno=1124, end_col_offset=42), attr='Index', ctx=Load(), lineno=1124, col_offset=36, end_lineno=1124, end_col_offset=48), lineno=1124, col_offset=4, end_lineno=1140, end_col_offset=29), FunctionDef(name='_active_index', args=arguments(args=[arg(arg='self', lineno=1142, col_offset=22, end_lineno=1142, end_col_offset=26)]), body=[Expr(value=Constant(value='Return the best available search index.\n\n        Returns\n        -------\n        _faiss.Index\n            GPU-backed index when available, otherwise the CPU index.\n\n        Raises\n        ------\n        RuntimeError\n            If neither CPU nor GPU indexes are available.\n        ', lineno=1143, col_offset=8, end_lineno=1154, end_col_offset=11), lineno=1143, col_offset=8, end_lineno=1154, end_col_offset=11), If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=1155, col_offset=11, end_lineno=1155, end_col_offset=15), attr='gpu_index', ctx=Load(), lineno=1155, col_offset=11, end_lineno=1155, end_col_offset=25), ops=[IsNot()], comparators=[Constant(value=None, lineno=1155, col_offset=33, end_lineno=1155, end_col_offset=37)], lineno=1155, col_offset=11, end_lineno=1155, end_col_offset=37), body=[Return(value=Attribute(value=Name(id='self', ctx=Load(), lineno=1156, col_offset=19, end_lineno=1156, end_col_offset=23), attr='gpu_index', ctx=Load(), lineno=1156, col_offset=19, end_lineno=1156, end_col_offset=33), lineno=1156, col_offset=12, end_lineno=1156, end_col_offset=33)], lineno=1155, col_offset=8, end_lineno=1156, end_col_offset=33), If(test=Compare(left=Attribute(value=Name(id='self', ctx=Load(), lineno=1157, col_offset=11, end_lineno=1157, end_col_offset=15), attr='cpu_index', ctx=Load(), lineno=1157, col_offset=11, end_lineno=1157, end_col_offset=25), ops=[IsNot()], comparators=[Constant(value=None, lineno=1157, col_offset=33, end_lineno=1157, end_col_offset=37)], lineno=1157, col_offset=11, end_lineno=1157, end_col_offset=37), body=[Return(value=Attribute(value=Name(id='self', ctx=Load(), lineno=1158, col_offset=19, end_lineno=1158, end_col_offset=23), attr='cpu_index', ctx=Load(), lineno=1158, col_offset=19, end_lineno=1158, end_col_offset=33), lineno=1158, col_offset=12, end_lineno=1158, end_col_offset=33)], lineno=1157, col_offset=8, end_lineno=1158, end_col_offset=33), Assign(targets=[Name(id='msg', ctx=Store(), lineno=1159, col_offset=8, end_lineno=1159, end_col_offset=11)], value=Constant(value='No index available', lineno=1159, col_offset=14, end_lineno=1159, end_col_offset=34), lineno=1159, col_offset=8, end_lineno=1159, end_col_offset=34), Raise(exc=Call(func=Name(id='RuntimeError', ctx=Load(), lineno=1160, col_offset=14, end_lineno=1160, end_col_offset=26), args=[Name(id='msg', ctx=Load(), lineno=1160, col_offset=27, end_lineno=1160, end_col_offset=30)], lineno=1160, col_offset=14, end_lineno=1160, end_col_offset=31), lineno=1160, col_offset=8, end_lineno=1160, end_col_offset=31)], returns=Attribute(value=Name(id='_faiss', ctx=Load(), lineno=1142, col_offset=31, end_lineno=1142, end_col_offset=37), attr='Index', ctx=Load(), lineno=1142, col_offset=31, end_lineno=1142, end_col_offset=43), lineno=1142, col_offset=4, end_lineno=1160, end_col_offset=31)], lineno=67, col_offset=0, end_lineno=1160, end_col_offset=31), FunctionDef(name='_coerce_to_int', args=arguments(args=[arg(arg='value', annotation=Name(id='object', ctx=Load(), lineno=1163, col_offset=26, end_lineno=1163, end_col_offset=32), lineno=1163, col_offset=19, end_lineno=1163, end_col_offset=32), arg(arg='default', annotation=Name(id='int', ctx=Load(), lineno=1163, col_offset=43, end_lineno=1163, end_col_offset=46), lineno=1163, col_offset=34, end_lineno=1163, end_col_offset=46)], defaults=[UnaryOp(op=USub(), operand=Constant(value=1, lineno=1163, col_offset=50, end_lineno=1163, end_col_offset=51), lineno=1163, col_offset=49, end_lineno=1163, end_col_offset=51)]), body=[Expr(value=Constant(value='Safely round arbitrary objects to integers for index comparisons.\n\n    Parameters\n    ----------\n    value : object\n        Candidate value that might be converted to an integer.\n    default : int\n        Fallback value when conversion is not possible.\n\n    Returns\n    -------\n    int\n        Converted integer or the provided default.\n    ', lineno=1164, col_offset=4, end_lineno=1177, end_col_offset=7), lineno=1164, col_offset=4, end_lineno=1177, end_col_offset=7), If(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=1178, col_offset=7, end_lineno=1178, end_col_offset=17), args=[Name(id='value', ctx=Load(), lineno=1178, col_offset=18, end_lineno=1178, end_col_offset=23), Tuple(elts=[Name(id='int', ctx=Load(), lineno=1178, col_offset=26, end_lineno=1178, end_col_offset=29), Name(id='float', ctx=Load(), lineno=1178, col_offset=31, end_lineno=1178, end_col_offset=36), Name(id='str', ctx=Load(), lineno=1178, col_offset=38, end_lineno=1178, end_col_offset=41)], ctx=Load(), lineno=1178, col_offset=25, end_lineno=1178, end_col_offset=42)], lineno=1178, col_offset=7, end_lineno=1178, end_col_offset=43), body=[Try(body=[Return(value=Call(func=Name(id='int', ctx=Load(), lineno=1180, col_offset=19, end_lineno=1180, end_col_offset=22), args=[Name(id='value', ctx=Load(), lineno=1180, col_offset=23, end_lineno=1180, end_col_offset=28)], lineno=1180, col_offset=19, end_lineno=1180, end_col_offset=29), lineno=1180, col_offset=12, end_lineno=1180, end_col_offset=29)], handlers=[ExceptHandler(type=Tuple(elts=[Name(id='TypeError', ctx=Load(), lineno=1181, col_offset=16, end_lineno=1181, end_col_offset=25), Name(id='ValueError', ctx=Load(), lineno=1181, col_offset=27, end_lineno=1181, end_col_offset=37)], ctx=Load(), lineno=1181, col_offset=15, end_lineno=1181, end_col_offset=38), body=[Return(value=Name(id='default', ctx=Load(), lineno=1182, col_offset=19, end_lineno=1182, end_col_offset=26), lineno=1182, col_offset=12, end_lineno=1182, end_col_offset=26)], lineno=1181, col_offset=8, end_lineno=1182, end_col_offset=26)], lineno=1179, col_offset=8, end_lineno=1182, end_col_offset=26)], lineno=1178, col_offset=4, end_lineno=1182, end_col_offset=26), Return(value=Name(id='default', ctx=Load(), lineno=1183, col_offset=11, end_lineno=1183, end_col_offset=18), lineno=1183, col_offset=4, end_lineno=1183, end_col_offset=18)], returns=Name(id='int', ctx=Load(), lineno=1163, col_offset=56, end_lineno=1163, end_col_offset=59), lineno=1163, col_offset=0, end_lineno=1183, end_col_offset=18), Assign(targets=[Name(id='__all__', ctx=Store(), lineno=1186, col_offset=0, end_lineno=1186, end_col_offset=7)], value=List(elts=[Constant(value='FAISSManager', lineno=1186, col_offset=11, end_lineno=1186, end_col_offset=25)], ctx=Load(), lineno=1186, col_offset=10, end_lineno=1186, end_col_offset=26), lineno=1186, col_offset=0, end_lineno=1186, end_col_offset=26)])