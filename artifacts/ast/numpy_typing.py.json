Module(body=[Expr(value=Constant(value='Typed NumPy helpers shared across vector search modules.', lineno=1, col_offset=0, end_lineno=1, end_col_offset=62), lineno=1, col_offset=0, end_lineno=1, end_col_offset=62), ImportFrom(module='__future__', names=[alias(name='annotations', lineno=5, col_offset=23, end_lineno=5, end_col_offset=34)], level=0, lineno=5, col_offset=0, end_lineno=5, end_col_offset=34), ImportFrom(module='typing', names=[alias(name='TYPE_CHECKING', lineno=7, col_offset=19, end_lineno=7, end_col_offset=32), alias(name='Final', lineno=7, col_offset=34, end_lineno=7, end_col_offset=39), alias(name='cast', lineno=7, col_offset=41, end_lineno=7, end_col_offset=45)], level=0, lineno=7, col_offset=0, end_lineno=7, end_col_offset=45), Import(names=[alias(name='numpy', asname='np', lineno=9, col_offset=7, end_lineno=9, end_col_offset=18)], lineno=9, col_offset=0, end_lineno=9, end_col_offset=18), ImportFrom(module='kgfoundry_common.navmap_loader', names=[alias(name='load_nav_metadata', lineno=11, col_offset=43, end_lineno=11, end_col_offset=60)], level=0, lineno=11, col_offset=0, end_lineno=11, end_col_offset=60), If(test=Name(id='TYPE_CHECKING', ctx=Load(), lineno=13, col_offset=3, end_lineno=13, end_col_offset=16), body=[Import(names=[alias(name='numpy.typing', asname='npt', lineno=14, col_offset=11, end_lineno=14, end_col_offset=30)], lineno=14, col_offset=4, end_lineno=14, end_col_offset=30), TypeAlias(name=Name(id='FloatMatrix', ctx=Store(), lineno=16, col_offset=9, end_lineno=16, end_col_offset=20), value=Subscript(value=Attribute(value=Name(id='npt', ctx=Load(), lineno=16, col_offset=23, end_lineno=16, end_col_offset=26), attr='NDArray', ctx=Load(), lineno=16, col_offset=23, end_lineno=16, end_col_offset=34), slice=Attribute(value=Name(id='np', ctx=Load(), lineno=16, col_offset=35, end_lineno=16, end_col_offset=37), attr='float32', ctx=Load(), lineno=16, col_offset=35, end_lineno=16, end_col_offset=45), ctx=Load(), lineno=16, col_offset=23, end_lineno=16, end_col_offset=46), lineno=16, col_offset=4, end_lineno=16, end_col_offset=46), TypeAlias(name=Name(id='FloatVector', ctx=Store(), lineno=17, col_offset=9, end_lineno=17, end_col_offset=20), value=Subscript(value=Attribute(value=Name(id='npt', ctx=Load(), lineno=17, col_offset=23, end_lineno=17, end_col_offset=26), attr='NDArray', ctx=Load(), lineno=17, col_offset=23, end_lineno=17, end_col_offset=34), slice=Attribute(value=Name(id='np', ctx=Load(), lineno=17, col_offset=35, end_lineno=17, end_col_offset=37), attr='float32', ctx=Load(), lineno=17, col_offset=35, end_lineno=17, end_col_offset=45), ctx=Load(), lineno=17, col_offset=23, end_lineno=17, end_col_offset=46), lineno=17, col_offset=4, end_lineno=17, end_col_offset=46), TypeAlias(name=Name(id='IntVector', ctx=Store(), lineno=18, col_offset=9, end_lineno=18, end_col_offset=18), value=Subscript(value=Attribute(value=Name(id='npt', ctx=Load(), lineno=18, col_offset=21, end_lineno=18, end_col_offset=24), attr='NDArray', ctx=Load(), lineno=18, col_offset=21, end_lineno=18, end_col_offset=32), slice=Attribute(value=Name(id='np', ctx=Load(), lineno=18, col_offset=33, end_lineno=18, end_col_offset=35), attr='int64', ctx=Load(), lineno=18, col_offset=33, end_lineno=18, end_col_offset=41), ctx=Load(), lineno=18, col_offset=21, end_lineno=18, end_col_offset=42), lineno=18, col_offset=4, end_lineno=18, end_col_offset=42), TypeAlias(name=Name(id='Float64Matrix', ctx=Store(), lineno=19, col_offset=9, end_lineno=19, end_col_offset=22), value=Subscript(value=Attribute(value=Name(id='npt', ctx=Load(), lineno=19, col_offset=25, end_lineno=19, end_col_offset=28), attr='NDArray', ctx=Load(), lineno=19, col_offset=25, end_lineno=19, end_col_offset=36), slice=Attribute(value=Name(id='np', ctx=Load(), lineno=19, col_offset=37, end_lineno=19, end_col_offset=39), attr='float64', ctx=Load(), lineno=19, col_offset=37, end_lineno=19, end_col_offset=47), ctx=Load(), lineno=19, col_offset=25, end_lineno=19, end_col_offset=48), lineno=19, col_offset=4, end_lineno=19, end_col_offset=48)], orelse=[Assign(targets=[Name(id='FloatMatrix', ctx=Store(), lineno=21, col_offset=4, end_lineno=21, end_col_offset=15)], value=Attribute(value=Name(id='np', ctx=Load(), lineno=21, col_offset=18, end_lineno=21, end_col_offset=20), attr='ndarray', ctx=Load(), lineno=21, col_offset=18, end_lineno=21, end_col_offset=28), lineno=21, col_offset=4, end_lineno=21, end_col_offset=28), Assign(targets=[Name(id='FloatVector', ctx=Store(), lineno=22, col_offset=4, end_lineno=22, end_col_offset=15)], value=Attribute(value=Name(id='np', ctx=Load(), lineno=22, col_offset=18, end_lineno=22, end_col_offset=20), attr='ndarray', ctx=Load(), lineno=22, col_offset=18, end_lineno=22, end_col_offset=28), lineno=22, col_offset=4, end_lineno=22, end_col_offset=28), Assign(targets=[Name(id='IntVector', ctx=Store(), lineno=23, col_offset=4, end_lineno=23, end_col_offset=13)], value=Attribute(value=Name(id='np', ctx=Load(), lineno=23, col_offset=16, end_lineno=23, end_col_offset=18), attr='ndarray', ctx=Load(), lineno=23, col_offset=16, end_lineno=23, end_col_offset=26), lineno=23, col_offset=4, end_lineno=23, end_col_offset=26), Assign(targets=[Name(id='Float64Matrix', ctx=Store(), lineno=24, col_offset=4, end_lineno=24, end_col_offset=17)], value=Attribute(value=Name(id='np', ctx=Load(), lineno=24, col_offset=20, end_lineno=24, end_col_offset=22), attr='ndarray', ctx=Load(), lineno=24, col_offset=20, end_lineno=24, end_col_offset=30), lineno=24, col_offset=4, end_lineno=24, end_col_offset=30)], lineno=13, col_offset=0, end_lineno=24, end_col_offset=30), AnnAssign(target=Name(id='MIN_EPSILON', ctx=Store(), lineno=27, col_offset=0, end_lineno=27, end_col_offset=11), annotation=Subscript(value=Name(id='Final', ctx=Load(), lineno=27, col_offset=13, end_lineno=27, end_col_offset=18), slice=Name(id='float', ctx=Load(), lineno=27, col_offset=19, end_lineno=27, end_col_offset=24), ctx=Load(), lineno=27, col_offset=13, end_lineno=27, end_col_offset=25), value=Constant(value=1e-09, lineno=27, col_offset=28, end_lineno=27, end_col_offset=32), simple=1, lineno=27, col_offset=0, end_lineno=27, end_col_offset=32), Expr(value=Constant(value='Lower bound used to prevent division by zero during normalisation.', lineno=28, col_offset=0, end_lineno=28, end_col_offset=72), lineno=28, col_offset=0, end_lineno=28, end_col_offset=72), FunctionDef(name='normalize_l2', args=arguments(args=[arg(arg='matrix', annotation=Name(id='FloatMatrix', ctx=Load(), lineno=33, col_offset=12, end_lineno=33, end_col_offset=23), lineno=33, col_offset=4, end_lineno=33, end_col_offset=23)], kwonlyargs=[arg(arg='axis', annotation=Name(id='int', ctx=Load(), lineno=35, col_offset=10, end_lineno=35, end_col_offset=13), lineno=35, col_offset=4, end_lineno=35, end_col_offset=13), arg(arg='epsilon', annotation=Name(id='float', ctx=Load(), lineno=36, col_offset=13, end_lineno=36, end_col_offset=18), lineno=36, col_offset=4, end_lineno=36, end_col_offset=18)], kw_defaults=[Constant(value=1, lineno=35, col_offset=16, end_lineno=35, end_col_offset=17), Name(id='MIN_EPSILON', ctx=Load(), lineno=36, col_offset=21, end_lineno=36, end_col_offset=32)]), body=[Expr(value=Constant(value='Return an L2-normalised copy of ``matrix`` with numerical safeguards.\n\n    Parameters\n    ----------\n    matrix : FloatMatrix\n        Input vectors that are expected to be contiguous ``float32`` values.\n    axis : int, optional\n        Axis along which norms are computed. Defaults to ``1`` for row vectors.\n    epsilon : float, optional\n        Minimum norm value to clamp to for zero or denormalised rows.\n        Defaults to MIN_EPSILON.\n\n    Returns\n    -------\n    FloatMatrix\n        L2-normalized matrix with same shape as input.\n\n    Examples\n    --------\n    >>> import numpy as np\n    >>> from kgfoundry_common.numpy_typing import normalize_l2\n    >>> mat = np.array([[3.0, 4.0], [0.0, 0.0]], dtype=np.float32)\n    >>> normalize_l2(mat)\n    array([[0.6, 0.8],\n           [0. , 0. ]], dtype=float32)\n\n    >>> normalize_l2(np.zeros((1, 4), dtype=np.float32))\n    array([[0., 0., 0., 0.]], dtype=float32)\n    ', lineno=38, col_offset=4, end_lineno=66, end_col_offset=7), lineno=38, col_offset=4, end_lineno=66, end_col_offset=7), AnnAssign(target=Name(id='matrix_f32', ctx=Store(), lineno=67, col_offset=4, end_lineno=67, end_col_offset=14), annotation=Name(id='FloatMatrix', ctx=Load(), lineno=67, col_offset=16, end_lineno=67, end_col_offset=27), value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=67, col_offset=30, end_lineno=67, end_col_offset=32), attr='asarray', ctx=Load(), lineno=67, col_offset=30, end_lineno=67, end_col_offset=40), args=[Name(id='matrix', ctx=Load(), lineno=67, col_offset=41, end_lineno=67, end_col_offset=47)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=67, col_offset=55, end_lineno=67, end_col_offset=57), attr='float32', ctx=Load(), lineno=67, col_offset=55, end_lineno=67, end_col_offset=65), lineno=67, col_offset=49, end_lineno=67, end_col_offset=65), keyword(arg='order', value=Constant(value='C', lineno=67, col_offset=73, end_lineno=67, end_col_offset=76), lineno=67, col_offset=67, end_lineno=67, end_col_offset=76)], lineno=67, col_offset=30, end_lineno=67, end_col_offset=77), simple=1, lineno=67, col_offset=4, end_lineno=67, end_col_offset=77), AnnAssign(target=Name(id='norms_untyped', ctx=Store(), lineno=68, col_offset=4, end_lineno=68, end_col_offset=17), annotation=Name(id='Float64Matrix', ctx=Load(), lineno=68, col_offset=19, end_lineno=68, end_col_offset=32), value=Call(func=Attribute(value=Attribute(value=Name(id='np', ctx=Load(), lineno=68, col_offset=35, end_lineno=68, end_col_offset=37), attr='linalg', ctx=Load(), lineno=68, col_offset=35, end_lineno=68, end_col_offset=44), attr='norm', ctx=Load(), lineno=68, col_offset=35, end_lineno=68, end_col_offset=49), args=[Name(id='matrix_f32', ctx=Load(), lineno=68, col_offset=50, end_lineno=68, end_col_offset=60)], keywords=[keyword(arg='axis', value=Name(id='axis', ctx=Load(), lineno=68, col_offset=67, end_lineno=68, end_col_offset=71), lineno=68, col_offset=62, end_lineno=68, end_col_offset=71), keyword(arg='keepdims', value=Constant(value=True, lineno=68, col_offset=82, end_lineno=68, end_col_offset=86), lineno=68, col_offset=73, end_lineno=68, end_col_offset=86)], lineno=68, col_offset=35, end_lineno=68, end_col_offset=87), simple=1, lineno=68, col_offset=4, end_lineno=68, end_col_offset=87), AnnAssign(target=Name(id='norms', ctx=Store(), lineno=69, col_offset=4, end_lineno=69, end_col_offset=9), annotation=Name(id='FloatMatrix', ctx=Load(), lineno=69, col_offset=11, end_lineno=69, end_col_offset=22), value=Call(func=Attribute(value=Name(id='norms_untyped', ctx=Load(), lineno=69, col_offset=25, end_lineno=69, end_col_offset=38), attr='astype', ctx=Load(), lineno=69, col_offset=25, end_lineno=69, end_col_offset=45), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=69, col_offset=46, end_lineno=69, end_col_offset=48), attr='float32', ctx=Load(), lineno=69, col_offset=46, end_lineno=69, end_col_offset=56)], keywords=[keyword(arg='copy', value=Constant(value=False, lineno=69, col_offset=63, end_lineno=69, end_col_offset=68), lineno=69, col_offset=58, end_lineno=69, end_col_offset=68)], lineno=69, col_offset=25, end_lineno=69, end_col_offset=69), simple=1, lineno=69, col_offset=4, end_lineno=69, end_col_offset=69), Expr(value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=70, col_offset=4, end_lineno=70, end_col_offset=6), attr='maximum', ctx=Load(), lineno=70, col_offset=4, end_lineno=70, end_col_offset=14), args=[Name(id='norms', ctx=Load(), lineno=70, col_offset=15, end_lineno=70, end_col_offset=20), Name(id='epsilon', ctx=Load(), lineno=70, col_offset=22, end_lineno=70, end_col_offset=29)], keywords=[keyword(arg='out', value=Name(id='norms', ctx=Load(), lineno=70, col_offset=35, end_lineno=70, end_col_offset=40), lineno=70, col_offset=31, end_lineno=70, end_col_offset=40)], lineno=70, col_offset=4, end_lineno=70, end_col_offset=41), lineno=70, col_offset=4, end_lineno=70, end_col_offset=41), Expr(value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=71, col_offset=4, end_lineno=71, end_col_offset=6), attr='divide', ctx=Load(), lineno=71, col_offset=4, end_lineno=71, end_col_offset=13), args=[Name(id='matrix_f32', ctx=Load(), lineno=71, col_offset=14, end_lineno=71, end_col_offset=24), Name(id='norms', ctx=Load(), lineno=71, col_offset=26, end_lineno=71, end_col_offset=31)], keywords=[keyword(arg='out', value=Name(id='matrix_f32', ctx=Load(), lineno=71, col_offset=37, end_lineno=71, end_col_offset=47), lineno=71, col_offset=33, end_lineno=71, end_col_offset=47)], lineno=71, col_offset=4, end_lineno=71, end_col_offset=48), lineno=71, col_offset=4, end_lineno=71, end_col_offset=48), Return(value=Name(id='matrix_f32', ctx=Load(), lineno=72, col_offset=11, end_lineno=72, end_col_offset=21), lineno=72, col_offset=4, end_lineno=72, end_col_offset=21)], returns=Name(id='FloatMatrix', ctx=Load(), lineno=37, col_offset=5, end_lineno=37, end_col_offset=16), lineno=32, col_offset=0, end_lineno=72, end_col_offset=21), FunctionDef(name='safe_argpartition', args=arguments(args=[arg(arg='values', annotation=Name(id='FloatVector', ctx=Load(), lineno=76, col_offset=30, end_lineno=76, end_col_offset=41), lineno=76, col_offset=22, end_lineno=76, end_col_offset=41), arg(arg='k', annotation=Name(id='int', ctx=Load(), lineno=76, col_offset=46, end_lineno=76, end_col_offset=49), lineno=76, col_offset=43, end_lineno=76, end_col_offset=49)]), body=[Expr(value=Constant(value='Return indices of the smallest ``k`` values with predictable ordering.\n\n    Parameters\n    ----------\n    values : FloatVector\n        Input vector to partition.\n    k : int\n        Number of smallest values to select.\n\n    Returns\n    -------\n    IntVector\n        Indices of the smallest k values, sorted.\n\n    Raises\n    ------\n    ValueError\n        If k is negative.\n    ', lineno=77, col_offset=4, end_lineno=95, end_col_offset=7), lineno=77, col_offset=4, end_lineno=95, end_col_offset=7), If(test=Compare(left=Name(id='k', ctx=Load(), lineno=96, col_offset=7, end_lineno=96, end_col_offset=8), ops=[Lt()], comparators=[Constant(value=0, lineno=96, col_offset=11, end_lineno=96, end_col_offset=12)], lineno=96, col_offset=7, end_lineno=96, end_col_offset=12), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=97, col_offset=8, end_lineno=97, end_col_offset=11)], value=Constant(value='k must be non-negative', lineno=97, col_offset=14, end_lineno=97, end_col_offset=38), lineno=97, col_offset=8, end_lineno=97, end_col_offset=38), Raise(exc=Call(func=Name(id='ValueError', ctx=Load(), lineno=98, col_offset=14, end_lineno=98, end_col_offset=24), args=[Name(id='msg', ctx=Load(), lineno=98, col_offset=25, end_lineno=98, end_col_offset=28)], lineno=98, col_offset=14, end_lineno=98, end_col_offset=29), lineno=98, col_offset=8, end_lineno=98, end_col_offset=29)], lineno=96, col_offset=4, end_lineno=98, end_col_offset=29), AnnAssign(target=Name(id='values_array', ctx=Store(), lineno=100, col_offset=4, end_lineno=100, end_col_offset=16), annotation=Name(id='FloatVector', ctx=Load(), lineno=100, col_offset=18, end_lineno=100, end_col_offset=29), value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=100, col_offset=32, end_lineno=100, end_col_offset=34), attr='asarray', ctx=Load(), lineno=100, col_offset=32, end_lineno=100, end_col_offset=42), args=[Name(id='values', ctx=Load(), lineno=100, col_offset=43, end_lineno=100, end_col_offset=49)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=100, col_offset=57, end_lineno=100, end_col_offset=59), attr='float32', ctx=Load(), lineno=100, col_offset=57, end_lineno=100, end_col_offset=67), lineno=100, col_offset=51, end_lineno=100, end_col_offset=67), keyword(arg='order', value=Constant(value='C', lineno=100, col_offset=75, end_lineno=100, end_col_offset=78), lineno=100, col_offset=69, end_lineno=100, end_col_offset=78)], lineno=100, col_offset=32, end_lineno=100, end_col_offset=79), simple=1, lineno=100, col_offset=4, end_lineno=100, end_col_offset=79), If(test=BoolOp(op=Or(), values=[Compare(left=Name(id='k', ctx=Load(), lineno=101, col_offset=7, end_lineno=101, end_col_offset=8), ops=[Eq()], comparators=[Constant(value=0, lineno=101, col_offset=12, end_lineno=101, end_col_offset=13)], lineno=101, col_offset=7, end_lineno=101, end_col_offset=13), Compare(left=Attribute(value=Name(id='values_array', ctx=Load(), lineno=101, col_offset=17, end_lineno=101, end_col_offset=29), attr='size', ctx=Load(), lineno=101, col_offset=17, end_lineno=101, end_col_offset=34), ops=[Eq()], comparators=[Constant(value=0, lineno=101, col_offset=38, end_lineno=101, end_col_offset=39)], lineno=101, col_offset=17, end_lineno=101, end_col_offset=39)], lineno=101, col_offset=7, end_lineno=101, end_col_offset=39), body=[Return(value=Call(func=Name(id='cast', ctx=Load(), lineno=102, col_offset=15, end_lineno=102, end_col_offset=19), args=[Constant(value='IntVector', lineno=102, col_offset=20, end_lineno=102, end_col_offset=31), Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=102, col_offset=33, end_lineno=102, end_col_offset=35), attr='empty', ctx=Load(), lineno=102, col_offset=33, end_lineno=102, end_col_offset=41), args=[Constant(value=0, lineno=102, col_offset=42, end_lineno=102, end_col_offset=43)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=102, col_offset=51, end_lineno=102, end_col_offset=53), attr='int64', ctx=Load(), lineno=102, col_offset=51, end_lineno=102, end_col_offset=59), lineno=102, col_offset=45, end_lineno=102, end_col_offset=59)], lineno=102, col_offset=33, end_lineno=102, end_col_offset=60)], lineno=102, col_offset=15, end_lineno=102, end_col_offset=61), lineno=102, col_offset=8, end_lineno=102, end_col_offset=61)], lineno=101, col_offset=4, end_lineno=102, end_col_offset=61), Assign(targets=[Name(id='trimmed_k', ctx=Store(), lineno=104, col_offset=4, end_lineno=104, end_col_offset=13)], value=Call(func=Name(id='min', ctx=Load(), lineno=104, col_offset=16, end_lineno=104, end_col_offset=19), args=[Name(id='k', ctx=Load(), lineno=104, col_offset=20, end_lineno=104, end_col_offset=21), Attribute(value=Name(id='values_array', ctx=Load(), lineno=104, col_offset=23, end_lineno=104, end_col_offset=35), attr='size', ctx=Load(), lineno=104, col_offset=23, end_lineno=104, end_col_offset=40)], lineno=104, col_offset=16, end_lineno=104, end_col_offset=41), lineno=104, col_offset=4, end_lineno=104, end_col_offset=41), Assign(targets=[Name(id='partition', ctx=Store(), lineno=105, col_offset=4, end_lineno=105, end_col_offset=13)], value=Subscript(value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=105, col_offset=16, end_lineno=105, end_col_offset=18), attr='argpartition', ctx=Load(), lineno=105, col_offset=16, end_lineno=105, end_col_offset=31), args=[Name(id='values_array', ctx=Load(), lineno=105, col_offset=32, end_lineno=105, end_col_offset=44), BinOp(left=Name(id='trimmed_k', ctx=Load(), lineno=105, col_offset=46, end_lineno=105, end_col_offset=55), op=Sub(), right=Constant(value=1, lineno=105, col_offset=58, end_lineno=105, end_col_offset=59), lineno=105, col_offset=46, end_lineno=105, end_col_offset=59)], lineno=105, col_offset=16, end_lineno=105, end_col_offset=60), slice=Slice(upper=Name(id='trimmed_k', ctx=Load(), lineno=105, col_offset=62, end_lineno=105, end_col_offset=71), lineno=105, col_offset=61, end_lineno=105, end_col_offset=71), ctx=Load(), lineno=105, col_offset=16, end_lineno=105, end_col_offset=72), lineno=105, col_offset=4, end_lineno=105, end_col_offset=72), Return(value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=106, col_offset=11, end_lineno=106, end_col_offset=13), attr='sort', ctx=Load(), lineno=106, col_offset=11, end_lineno=106, end_col_offset=18), args=[Name(id='partition', ctx=Load(), lineno=106, col_offset=19, end_lineno=106, end_col_offset=28)], lineno=106, col_offset=11, end_lineno=106, end_col_offset=29), attr='astype', ctx=Load(), lineno=106, col_offset=11, end_lineno=106, end_col_offset=36), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=106, col_offset=37, end_lineno=106, end_col_offset=39), attr='int64', ctx=Load(), lineno=106, col_offset=37, end_lineno=106, end_col_offset=45)], keywords=[keyword(arg='copy', value=Constant(value=False, lineno=106, col_offset=52, end_lineno=106, end_col_offset=57), lineno=106, col_offset=47, end_lineno=106, end_col_offset=57)], lineno=106, col_offset=11, end_lineno=106, end_col_offset=58), lineno=106, col_offset=4, end_lineno=106, end_col_offset=58)], returns=Name(id='IntVector', ctx=Load(), lineno=76, col_offset=54, end_lineno=76, end_col_offset=63), lineno=76, col_offset=0, end_lineno=106, end_col_offset=58), FunctionDef(name='topk_indices', args=arguments(args=[arg(arg='scores', annotation=Name(id='FloatVector', ctx=Load(), lineno=110, col_offset=25, end_lineno=110, end_col_offset=36), lineno=110, col_offset=17, end_lineno=110, end_col_offset=36), arg(arg='k', annotation=Name(id='int', ctx=Load(), lineno=110, col_offset=41, end_lineno=110, end_col_offset=44), lineno=110, col_offset=38, end_lineno=110, end_col_offset=44)]), body=[Expr(value=Constant(value='Return indices of the top ``k`` scores sorted by descending score.\n\n    Parameters\n    ----------\n    scores : FloatVector\n        Input score vector.\n    k : int\n        Number of top scores to select.\n\n    Returns\n    -------\n    IntVector\n        Indices of the top k scores, sorted by descending score.\n\n    Raises\n    ------\n    ValueError\n        If k is not positive.\n    ', lineno=111, col_offset=4, end_lineno=129, end_col_offset=7), lineno=111, col_offset=4, end_lineno=129, end_col_offset=7), If(test=Compare(left=Name(id='k', ctx=Load(), lineno=130, col_offset=7, end_lineno=130, end_col_offset=8), ops=[LtE()], comparators=[Constant(value=0, lineno=130, col_offset=12, end_lineno=130, end_col_offset=13)], lineno=130, col_offset=7, end_lineno=130, end_col_offset=13), body=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=131, col_offset=8, end_lineno=131, end_col_offset=11)], value=Constant(value='k must be positive', lineno=131, col_offset=14, end_lineno=131, end_col_offset=34), lineno=131, col_offset=8, end_lineno=131, end_col_offset=34), Raise(exc=Call(func=Name(id='ValueError', ctx=Load(), lineno=132, col_offset=14, end_lineno=132, end_col_offset=24), args=[Name(id='msg', ctx=Load(), lineno=132, col_offset=25, end_lineno=132, end_col_offset=28)], lineno=132, col_offset=14, end_lineno=132, end_col_offset=29), lineno=132, col_offset=8, end_lineno=132, end_col_offset=29)], lineno=130, col_offset=4, end_lineno=132, end_col_offset=29), AnnAssign(target=Name(id='scores_array', ctx=Store(), lineno=134, col_offset=4, end_lineno=134, end_col_offset=16), annotation=Name(id='FloatVector', ctx=Load(), lineno=134, col_offset=18, end_lineno=134, end_col_offset=29), value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=134, col_offset=32, end_lineno=134, end_col_offset=34), attr='asarray', ctx=Load(), lineno=134, col_offset=32, end_lineno=134, end_col_offset=42), args=[Name(id='scores', ctx=Load(), lineno=134, col_offset=43, end_lineno=134, end_col_offset=49)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=134, col_offset=57, end_lineno=134, end_col_offset=59), attr='float32', ctx=Load(), lineno=134, col_offset=57, end_lineno=134, end_col_offset=67), lineno=134, col_offset=51, end_lineno=134, end_col_offset=67), keyword(arg='order', value=Constant(value='C', lineno=134, col_offset=75, end_lineno=134, end_col_offset=78), lineno=134, col_offset=69, end_lineno=134, end_col_offset=78)], lineno=134, col_offset=32, end_lineno=134, end_col_offset=79), simple=1, lineno=134, col_offset=4, end_lineno=134, end_col_offset=79), Assign(targets=[Name(id='total', ctx=Store(), lineno=135, col_offset=4, end_lineno=135, end_col_offset=9)], value=Attribute(value=Name(id='scores_array', ctx=Load(), lineno=135, col_offset=12, end_lineno=135, end_col_offset=24), attr='size', ctx=Load(), lineno=135, col_offset=12, end_lineno=135, end_col_offset=29), lineno=135, col_offset=4, end_lineno=135, end_col_offset=29), If(test=Compare(left=Name(id='total', ctx=Load(), lineno=136, col_offset=7, end_lineno=136, end_col_offset=12), ops=[Eq()], comparators=[Constant(value=0, lineno=136, col_offset=16, end_lineno=136, end_col_offset=17)], lineno=136, col_offset=7, end_lineno=136, end_col_offset=17), body=[Return(value=Call(func=Name(id='cast', ctx=Load(), lineno=137, col_offset=15, end_lineno=137, end_col_offset=19), args=[Constant(value='IntVector', lineno=137, col_offset=20, end_lineno=137, end_col_offset=31), Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=137, col_offset=33, end_lineno=137, end_col_offset=35), attr='empty', ctx=Load(), lineno=137, col_offset=33, end_lineno=137, end_col_offset=41), args=[Constant(value=0, lineno=137, col_offset=42, end_lineno=137, end_col_offset=43)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=137, col_offset=51, end_lineno=137, end_col_offset=53), attr='int64', ctx=Load(), lineno=137, col_offset=51, end_lineno=137, end_col_offset=59), lineno=137, col_offset=45, end_lineno=137, end_col_offset=59)], lineno=137, col_offset=33, end_lineno=137, end_col_offset=60)], lineno=137, col_offset=15, end_lineno=137, end_col_offset=61), lineno=137, col_offset=8, end_lineno=137, end_col_offset=61)], lineno=136, col_offset=4, end_lineno=137, end_col_offset=61), Assign(targets=[Name(id='trimmed_k', ctx=Store(), lineno=139, col_offset=4, end_lineno=139, end_col_offset=13)], value=Call(func=Name(id='min', ctx=Load(), lineno=139, col_offset=16, end_lineno=139, end_col_offset=19), args=[Name(id='k', ctx=Load(), lineno=139, col_offset=20, end_lineno=139, end_col_offset=21), Name(id='total', ctx=Load(), lineno=139, col_offset=23, end_lineno=139, end_col_offset=28)], lineno=139, col_offset=16, end_lineno=139, end_col_offset=29), lineno=139, col_offset=4, end_lineno=139, end_col_offset=29), Assign(targets=[Name(id='score_list', ctx=Store(), lineno=140, col_offset=4, end_lineno=140, end_col_offset=14)], value=Call(func=Name(id='cast', ctx=Load(), lineno=140, col_offset=17, end_lineno=140, end_col_offset=21), args=[Constant(value='list[float]', lineno=140, col_offset=22, end_lineno=140, end_col_offset=35), Call(func=Attribute(value=Call(func=Attribute(value=Name(id='scores_array', ctx=Load(), lineno=140, col_offset=37, end_lineno=140, end_col_offset=49), attr='astype', ctx=Load(), lineno=140, col_offset=37, end_lineno=140, end_col_offset=56), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=140, col_offset=57, end_lineno=140, end_col_offset=59), attr='float64', ctx=Load(), lineno=140, col_offset=57, end_lineno=140, end_col_offset=67)], keywords=[keyword(arg='copy', value=Constant(value=False, lineno=140, col_offset=74, end_lineno=140, end_col_offset=79), lineno=140, col_offset=69, end_lineno=140, end_col_offset=79)], lineno=140, col_offset=37, end_lineno=140, end_col_offset=80), attr='tolist', ctx=Load(), lineno=140, col_offset=37, end_lineno=140, end_col_offset=87), lineno=140, col_offset=37, end_lineno=140, end_col_offset=89)], lineno=140, col_offset=17, end_lineno=140, end_col_offset=90), lineno=140, col_offset=4, end_lineno=140, end_col_offset=90), FunctionDef(name='sort_key', args=arguments(args=[arg(arg='idx', annotation=Name(id='int', ctx=Load(), lineno=142, col_offset=22, end_lineno=142, end_col_offset=25), lineno=142, col_offset=17, end_lineno=142, end_col_offset=25)]), body=[Expr(value=Constant(value='Return sort key tuple for index ranking.\n\n        Parameters\n        ----------\n        idx : int\n            Index into score_list.\n\n        Returns\n        -------\n        tuple[float, int]\n            Tuple of (score, negative_index) for stable sorting.\n        ', lineno=143, col_offset=8, end_lineno=154, end_col_offset=11), lineno=143, col_offset=8, end_lineno=154, end_col_offset=11), Return(value=Tuple(elts=[Call(func=Name(id='float', ctx=Load(), lineno=155, col_offset=16, end_lineno=155, end_col_offset=21), args=[Subscript(value=Name(id='score_list', ctx=Load(), lineno=155, col_offset=22, end_lineno=155, end_col_offset=32), slice=Name(id='idx', ctx=Load(), lineno=155, col_offset=33, end_lineno=155, end_col_offset=36), ctx=Load(), lineno=155, col_offset=22, end_lineno=155, end_col_offset=37)], lineno=155, col_offset=16, end_lineno=155, end_col_offset=38), UnaryOp(op=USub(), operand=Name(id='idx', ctx=Load(), lineno=155, col_offset=41, end_lineno=155, end_col_offset=44), lineno=155, col_offset=40, end_lineno=155, end_col_offset=44)], ctx=Load(), lineno=155, col_offset=15, end_lineno=155, end_col_offset=45), lineno=155, col_offset=8, end_lineno=155, end_col_offset=45)], returns=Subscript(value=Name(id='tuple', ctx=Load(), lineno=142, col_offset=30, end_lineno=142, end_col_offset=35), slice=Tuple(elts=[Name(id='float', ctx=Load(), lineno=142, col_offset=36, end_lineno=142, end_col_offset=41), Name(id='int', ctx=Load(), lineno=142, col_offset=43, end_lineno=142, end_col_offset=46)], ctx=Load(), lineno=142, col_offset=36, end_lineno=142, end_col_offset=46), ctx=Load(), lineno=142, col_offset=30, end_lineno=142, end_col_offset=47), lineno=142, col_offset=4, end_lineno=155, end_col_offset=45), Assign(targets=[Name(id='ranked', ctx=Store(), lineno=157, col_offset=4, end_lineno=157, end_col_offset=10)], value=Subscript(value=Call(func=Name(id='sorted', ctx=Load(), lineno=157, col_offset=13, end_lineno=157, end_col_offset=19), args=[Call(func=Name(id='range', ctx=Load(), lineno=157, col_offset=20, end_lineno=157, end_col_offset=25), args=[Name(id='total', ctx=Load(), lineno=157, col_offset=26, end_lineno=157, end_col_offset=31)], lineno=157, col_offset=20, end_lineno=157, end_col_offset=32)], keywords=[keyword(arg='key', value=Name(id='sort_key', ctx=Load(), lineno=157, col_offset=38, end_lineno=157, end_col_offset=46), lineno=157, col_offset=34, end_lineno=157, end_col_offset=46), keyword(arg='reverse', value=Constant(value=True, lineno=157, col_offset=56, end_lineno=157, end_col_offset=60), lineno=157, col_offset=48, end_lineno=157, end_col_offset=60)], lineno=157, col_offset=13, end_lineno=157, end_col_offset=61), slice=Slice(upper=Name(id='trimmed_k', ctx=Load(), lineno=157, col_offset=63, end_lineno=157, end_col_offset=72), lineno=157, col_offset=62, end_lineno=157, end_col_offset=72), ctx=Load(), lineno=157, col_offset=13, end_lineno=157, end_col_offset=73), lineno=157, col_offset=4, end_lineno=157, end_col_offset=73), AnnAssign(target=Name(id='ranked_array', ctx=Store(), lineno=158, col_offset=4, end_lineno=158, end_col_offset=16), annotation=Name(id='IntVector', ctx=Load(), lineno=158, col_offset=18, end_lineno=158, end_col_offset=27), value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=158, col_offset=30, end_lineno=158, end_col_offset=32), attr='asarray', ctx=Load(), lineno=158, col_offset=30, end_lineno=158, end_col_offset=40), args=[Name(id='ranked', ctx=Load(), lineno=158, col_offset=41, end_lineno=158, end_col_offset=47)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=158, col_offset=55, end_lineno=158, end_col_offset=57), attr='int64', ctx=Load(), lineno=158, col_offset=55, end_lineno=158, end_col_offset=63), lineno=158, col_offset=49, end_lineno=158, end_col_offset=63)], lineno=158, col_offset=30, end_lineno=158, end_col_offset=64), simple=1, lineno=158, col_offset=4, end_lineno=158, end_col_offset=64), Return(value=Name(id='ranked_array', ctx=Load(), lineno=159, col_offset=11, end_lineno=159, end_col_offset=23), lineno=159, col_offset=4, end_lineno=159, end_col_offset=23)], returns=Name(id='IntVector', ctx=Load(), lineno=110, col_offset=49, end_lineno=110, end_col_offset=58), lineno=110, col_offset=0, end_lineno=159, end_col_offset=23), Assign(targets=[Name(id='__all__', ctx=Store(), lineno=162, col_offset=0, end_lineno=162, end_col_offset=7)], value=List(elts=[Constant(value='MIN_EPSILON', lineno=163, col_offset=4, end_lineno=163, end_col_offset=17), Constant(value='FloatMatrix', lineno=164, col_offset=4, end_lineno=164, end_col_offset=17), Constant(value='FloatVector', lineno=165, col_offset=4, end_lineno=165, end_col_offset=17), Constant(value='IntVector', lineno=166, col_offset=4, end_lineno=166, end_col_offset=15), Constant(value='normalize_l2', lineno=167, col_offset=4, end_lineno=167, end_col_offset=18), Constant(value='safe_argpartition', lineno=168, col_offset=4, end_lineno=168, end_col_offset=23), Constant(value='topk_indices', lineno=169, col_offset=4, end_lineno=169, end_col_offset=18)], ctx=Load(), lineno=162, col_offset=10, end_lineno=170, end_col_offset=1), lineno=162, col_offset=0, end_lineno=170, end_col_offset=1), Assign(targets=[Name(id='__navmap__', ctx=Store(), lineno=171, col_offset=0, end_lineno=171, end_col_offset=10)], value=Call(func=Name(id='load_nav_metadata', ctx=Load(), lineno=171, col_offset=13, end_lineno=171, end_col_offset=30), args=[Name(id='__name__', ctx=Load(), lineno=171, col_offset=31, end_lineno=171, end_col_offset=39), Call(func=Name(id='tuple', ctx=Load(), lineno=171, col_offset=41, end_lineno=171, end_col_offset=46), args=[Name(id='__all__', ctx=Load(), lineno=171, col_offset=47, end_lineno=171, end_col_offset=54)], lineno=171, col_offset=41, end_lineno=171, end_col_offset=55)], lineno=171, col_offset=13, end_lineno=171, end_col_offset=56), lineno=171, col_offset=0, end_lineno=171, end_col_offset=56)])