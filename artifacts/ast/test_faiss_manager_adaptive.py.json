Module(body=[Expr(value=Constant(value='Tests for adaptive FAISS index selection.\n\nTests verify that FAISSManager automatically selects the optimal index type\nbased on corpus size, providing faster training for small/medium corpora\nwhile maintaining high recall (>95%).\n\nThese are lightweight unit tests using small vector counts (100 vectors max)\nand reduced dimensions (256) to validate logic without expensive training.\nFor stress tests with large corpora, see test_faiss_manager_stress.py.\n', lineno=1, col_offset=0, end_lineno=10, end_col_offset=3), lineno=1, col_offset=0, end_lineno=10, end_col_offset=3), ImportFrom(module='__future__', names=[alias(name='annotations', lineno=12, col_offset=23, end_lineno=12, end_col_offset=34)], level=0, lineno=12, col_offset=0, end_lineno=12, end_col_offset=34), ImportFrom(module='pathlib', names=[alias(name='Path', lineno=14, col_offset=20, end_lineno=14, end_col_offset=24)], level=0, lineno=14, col_offset=0, end_lineno=14, end_col_offset=24), ImportFrom(module='typing', names=[alias(name='TYPE_CHECKING', lineno=15, col_offset=19, end_lineno=15, end_col_offset=32), alias(name='Any', lineno=15, col_offset=34, end_lineno=15, end_col_offset=37), alias(name='cast', lineno=15, col_offset=39, end_lineno=15, end_col_offset=43)], level=0, lineno=15, col_offset=0, end_lineno=15, end_col_offset=43), Import(names=[alias(name='numpy', asname='np', lineno=17, col_offset=7, end_lineno=17, end_col_offset=18)], lineno=17, col_offset=0, end_lineno=17, end_col_offset=18), Import(names=[alias(name='pytest', lineno=18, col_offset=7, end_lineno=18, end_col_offset=13)], lineno=18, col_offset=0, end_lineno=18, end_col_offset=13), ImportFrom(module='codeintel_rev.io.faiss_manager', names=[alias(name='FAISSManager', lineno=19, col_offset=43, end_lineno=19, end_col_offset=55)], level=0, lineno=19, col_offset=0, end_lineno=19, end_col_offset=55), ImportFrom(module='tests.conftest', names=[alias(name='FAISS_MODULE', lineno=21, col_offset=27, end_lineno=21, end_col_offset=39), alias(name='HAS_FAISS_SUPPORT', lineno=21, col_offset=41, end_lineno=21, end_col_offset=58)], level=0, lineno=21, col_offset=0, end_lineno=21, end_col_offset=58), If(test=Name(id='TYPE_CHECKING', ctx=Load(), lineno=23, col_offset=3, end_lineno=23, end_col_offset=16), body=[Import(names=[alias(name='faiss', lineno=24, col_offset=11, end_lineno=24, end_col_offset=16)], lineno=24, col_offset=4, end_lineno=24, end_col_offset=16)], lineno=23, col_offset=0, end_lineno=24, end_col_offset=16), If(test=UnaryOp(op=Not(), operand=Name(id='HAS_FAISS_SUPPORT', ctx=Load(), lineno=26, col_offset=7, end_lineno=26, end_col_offset=24), lineno=26, col_offset=3, end_lineno=26, end_col_offset=24), body=[Assign(targets=[Name(id='pytestmark', ctx=Store(), lineno=27, col_offset=4, end_lineno=27, end_col_offset=14)], value=Call(func=Attribute(value=Attribute(value=Name(id='pytest', ctx=Load(), lineno=27, col_offset=17, end_lineno=27, end_col_offset=23), attr='mark', ctx=Load(), lineno=27, col_offset=17, end_lineno=27, end_col_offset=28), attr='skip', ctx=Load(), lineno=27, col_offset=17, end_lineno=27, end_col_offset=33), keywords=[keyword(arg='reason', value=Constant(value='FAISS bindings unavailable on this host', lineno=28, col_offset=15, end_lineno=28, end_col_offset=56), lineno=28, col_offset=8, end_lineno=28, end_col_offset=56)], lineno=27, col_offset=17, end_lineno=29, end_col_offset=5), lineno=27, col_offset=4, end_lineno=29, end_col_offset=5)], lineno=26, col_offset=0, end_lineno=29, end_col_offset=5), If(test=Compare(left=Name(id='FAISS_MODULE', ctx=Load(), lineno=32, col_offset=3, end_lineno=32, end_col_offset=15), ops=[Is()], comparators=[Constant(value=None, lineno=32, col_offset=19, end_lineno=32, end_col_offset=23)], lineno=32, col_offset=3, end_lineno=32, end_col_offset=23), body=[Expr(value=Call(func=Attribute(value=Name(id='pytest', ctx=Load(), lineno=33, col_offset=4, end_lineno=33, end_col_offset=10), attr='skip', ctx=Load(), lineno=33, col_offset=4, end_lineno=33, end_col_offset=15), args=[Constant(value='FAISS bindings unavailable on this host', lineno=33, col_offset=16, end_lineno=33, end_col_offset=57)], keywords=[keyword(arg='allow_module_level', value=Constant(value=True, lineno=33, col_offset=78, end_lineno=33, end_col_offset=82), lineno=33, col_offset=59, end_lineno=33, end_col_offset=82)], lineno=33, col_offset=4, end_lineno=33, end_col_offset=83), lineno=33, col_offset=4, end_lineno=33, end_col_offset=83)], lineno=32, col_offset=0, end_lineno=33, end_col_offset=83), AnnAssign(target=Name(id='faiss_module', ctx=Store(), lineno=34, col_offset=0, end_lineno=34, end_col_offset=12), annotation=Name(id='Any', ctx=Load(), lineno=34, col_offset=14, end_lineno=34, end_col_offset=17), value=Name(id='FAISS_MODULE', ctx=Load(), lineno=34, col_offset=20, end_lineno=34, end_col_offset=32), simple=1, lineno=34, col_offset=0, end_lineno=34, end_col_offset=32), FunctionDef(name='_get_underlying_index', args=arguments(args=[arg(arg='cpu_index', annotation=Name(id='Any', ctx=Load(), lineno=37, col_offset=37, end_lineno=37, end_col_offset=40), lineno=37, col_offset=26, end_lineno=37, end_col_offset=40)]), body=[Expr(value=Constant(value='Return the underlying FAISS index from an ID map wrapper.\n\n    Returns\n    -------\n    Any\n        Underlying FAISS index instance.\n    ', lineno=38, col_offset=4, end_lineno=44, end_col_offset=7), lineno=38, col_offset=4, end_lineno=44, end_col_offset=7), Assert(test=Call(func=Name(id='hasattr', ctx=Load(), lineno=45, col_offset=11, end_lineno=45, end_col_offset=18), args=[Name(id='cpu_index', ctx=Load(), lineno=45, col_offset=19, end_lineno=45, end_col_offset=28), Constant(value='index', lineno=45, col_offset=30, end_lineno=45, end_col_offset=37)], lineno=45, col_offset=11, end_lineno=45, end_col_offset=38), msg=Constant(value='Expected FAISS index wrapper to expose `index` attribute', lineno=45, col_offset=40, end_lineno=45, end_col_offset=98), lineno=45, col_offset=4, end_lineno=45, end_col_offset=98), Assign(targets=[Name(id='index_map', ctx=Store(), lineno=46, col_offset=4, end_lineno=46, end_col_offset=13)], value=Call(func=Name(id='cast', ctx=Load(), lineno=46, col_offset=16, end_lineno=46, end_col_offset=20), args=[Constant(value='faiss.IndexIDMap2', lineno=46, col_offset=21, end_lineno=46, end_col_offset=40), Name(id='cpu_index', ctx=Load(), lineno=46, col_offset=42, end_lineno=46, end_col_offset=51)], lineno=46, col_offset=16, end_lineno=46, end_col_offset=52), lineno=46, col_offset=4, end_lineno=46, end_col_offset=52), Return(value=Attribute(value=Name(id='index_map', ctx=Load(), lineno=47, col_offset=11, end_lineno=47, end_col_offset=20), attr='index', ctx=Load(), lineno=47, col_offset=11, end_lineno=47, end_col_offset=26), lineno=47, col_offset=4, end_lineno=47, end_col_offset=26)], returns=Name(id='Any', ctx=Load(), lineno=37, col_offset=45, end_lineno=37, end_col_offset=48), lineno=37, col_offset=0, end_lineno=47, end_col_offset=26), Assign(targets=[Name(id='_rng', ctx=Store(), lineno=51, col_offset=0, end_lineno=51, end_col_offset=4)], value=Call(func=Attribute(value=Attribute(value=Name(id='np', ctx=Load(), lineno=51, col_offset=7, end_lineno=51, end_col_offset=9), attr='random', ctx=Load(), lineno=51, col_offset=7, end_lineno=51, end_col_offset=16), attr='default_rng', ctx=Load(), lineno=51, col_offset=7, end_lineno=51, end_col_offset=28), args=[Constant(value=42, lineno=51, col_offset=29, end_lineno=51, end_col_offset=31)], lineno=51, col_offset=7, end_lineno=51, end_col_offset=32), lineno=51, col_offset=0, end_lineno=51, end_col_offset=32), Assign(targets=[Name(id='_UNIT_TEST_VEC_DIM', ctx=Store(), lineno=54, col_offset=0, end_lineno=54, end_col_offset=18)], value=Constant(value=256, lineno=54, col_offset=21, end_lineno=54, end_col_offset=24), lineno=54, col_offset=0, end_lineno=54, end_col_offset=24), FunctionDef(name='tmp_index_path', args=arguments(args=[arg(arg='tmp_path', annotation=Name(id='Path', ctx=Load(), lineno=58, col_offset=29, end_lineno=58, end_col_offset=33), lineno=58, col_offset=19, end_lineno=58, end_col_offset=33)]), body=[Expr(value=Constant(value='Create a temporary index path for testing.\n\n    Parameters\n    ----------\n    tmp_path : Path\n        Temporary directory fixture.\n\n    Returns\n    -------\n    Path\n        Path to temporary FAISS index file.\n    ', lineno=59, col_offset=4, end_lineno=70, end_col_offset=7), lineno=59, col_offset=4, end_lineno=70, end_col_offset=7), Return(value=BinOp(left=Name(id='tmp_path', ctx=Load(), lineno=71, col_offset=11, end_lineno=71, end_col_offset=19), op=Div(), right=Constant(value='test_index.faiss', lineno=71, col_offset=22, end_lineno=71, end_col_offset=40), lineno=71, col_offset=11, end_lineno=71, end_col_offset=40), lineno=71, col_offset=4, end_lineno=71, end_col_offset=40)], decorator_list=[Attribute(value=Name(id='pytest', ctx=Load(), lineno=57, col_offset=1, end_lineno=57, end_col_offset=7), attr='fixture', ctx=Load(), lineno=57, col_offset=1, end_lineno=57, end_col_offset=15)], returns=Name(id='Path', ctx=Load(), lineno=58, col_offset=38, end_lineno=58, end_col_offset=42), lineno=58, col_offset=0, end_lineno=71, end_col_offset=40), FunctionDef(name='test_adaptive_index_selection', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=84, col_offset=50, end_lineno=84, end_col_offset=54), lineno=84, col_offset=34, end_lineno=84, end_col_offset=54), arg(arg='n_vectors', annotation=Name(id='int', ctx=Load(), lineno=84, col_offset=67, end_lineno=84, end_col_offset=70), lineno=84, col_offset=56, end_lineno=84, end_col_offset=70), arg(arg='expected_type', annotation=Name(id='str', ctx=Load(), lineno=84, col_offset=87, end_lineno=84, end_col_offset=90), lineno=84, col_offset=72, end_lineno=84, end_col_offset=90)]), body=[Expr(value=Constant(value='Test that index type is selected based on corpus size.\n\n    Uses reduced dimensions (256) for fast unit test execution.\n    Tests only small/medium corpora (<50K vectors) to avoid expensive\n    IVF-PQ training. For large corpus tests, see test_large_corpus_ivf_pq_nlist.\n\n    Parameters\n    ----------\n    tmp_index_path : Path\n        Temporary index path.\n    n_vectors : int\n        Number of vectors to test with.\n    expected_type : str\n        Expected index type ("flat" or "ivf_flat").\n\n    Raises\n    ------\n    AssertionError\n        If the index type does not match the expected type for the given\n        corpus size.\n    ', lineno=85, col_offset=4, end_lineno=105, end_col_offset=7), lineno=85, col_offset=4, end_lineno=105, end_col_offset=7), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=106, col_offset=4, end_lineno=106, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=106, col_offset=14, end_lineno=106, end_col_offset=32), lineno=106, col_offset=4, end_lineno=106, end_col_offset=32), Assign(targets=[Name(id='manager', ctx=Store(), lineno=107, col_offset=4, end_lineno=107, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=107, col_offset=14, end_lineno=107, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=107, col_offset=38, end_lineno=107, end_col_offset=52), lineno=107, col_offset=27, end_lineno=107, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=107, col_offset=62, end_lineno=107, end_col_offset=69), lineno=107, col_offset=54, end_lineno=107, end_col_offset=69)], lineno=107, col_offset=14, end_lineno=107, end_col_offset=70), lineno=107, col_offset=4, end_lineno=107, end_col_offset=70), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=112, col_offset=4, end_lineno=112, end_col_offset=11)], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='_rng', ctx=Load(), lineno=112, col_offset=14, end_lineno=112, end_col_offset=18), attr='normal', ctx=Load(), lineno=112, col_offset=14, end_lineno=112, end_col_offset=25), args=[Constant(value=0.5, lineno=112, col_offset=26, end_lineno=112, end_col_offset=29), Constant(value=0.15, lineno=112, col_offset=31, end_lineno=112, end_col_offset=35), Tuple(elts=[Name(id='n_vectors', ctx=Load(), lineno=112, col_offset=38, end_lineno=112, end_col_offset=47), Name(id='vec_dim', ctx=Load(), lineno=112, col_offset=49, end_lineno=112, end_col_offset=56)], ctx=Load(), lineno=112, col_offset=37, end_lineno=112, end_col_offset=57)], lineno=112, col_offset=14, end_lineno=112, end_col_offset=58), attr='astype', ctx=Load(), lineno=112, col_offset=14, end_lineno=112, end_col_offset=65), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=112, col_offset=66, end_lineno=112, end_col_offset=68), attr='float32', ctx=Load(), lineno=112, col_offset=66, end_lineno=112, end_col_offset=76)], lineno=112, col_offset=14, end_lineno=112, end_col_offset=77), lineno=112, col_offset=4, end_lineno=112, end_col_offset=77), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=113, col_offset=4, end_lineno=113, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=113, col_offset=14, end_lineno=113, end_col_offset=16), attr='clip', ctx=Load(), lineno=113, col_offset=14, end_lineno=113, end_col_offset=21), args=[Name(id='vectors', ctx=Load(), lineno=113, col_offset=22, end_lineno=113, end_col_offset=29), Constant(value=0.0, lineno=113, col_offset=31, end_lineno=113, end_col_offset=34), Constant(value=1.0, lineno=113, col_offset=36, end_lineno=113, end_col_offset=39)], lineno=113, col_offset=14, end_lineno=113, end_col_offset=40), lineno=113, col_offset=4, end_lineno=113, end_col_offset=40), Expr(value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=116, col_offset=4, end_lineno=116, end_col_offset=11), attr='build_index', ctx=Load(), lineno=116, col_offset=4, end_lineno=116, end_col_offset=23), args=[Name(id='vectors', ctx=Load(), lineno=116, col_offset=24, end_lineno=116, end_col_offset=31)], lineno=116, col_offset=4, end_lineno=116, end_col_offset=32), lineno=116, col_offset=4, end_lineno=116, end_col_offset=32), Assert(test=Compare(left=Attribute(value=Name(id='manager', ctx=Load(), lineno=119, col_offset=11, end_lineno=119, end_col_offset=18), attr='cpu_index', ctx=Load(), lineno=119, col_offset=11, end_lineno=119, end_col_offset=28), ops=[IsNot()], comparators=[Constant(value=None, lineno=119, col_offset=36, end_lineno=119, end_col_offset=40)], lineno=119, col_offset=11, end_lineno=119, end_col_offset=40), lineno=119, col_offset=4, end_lineno=119, end_col_offset=40), Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=120, col_offset=4, end_lineno=120, end_col_offset=13)], value=Attribute(value=Name(id='manager', ctx=Load(), lineno=120, col_offset=16, end_lineno=120, end_col_offset=23), attr='cpu_index', ctx=Load(), lineno=120, col_offset=16, end_lineno=120, end_col_offset=33), lineno=120, col_offset=4, end_lineno=120, end_col_offset=33), Assert(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=123, col_offset=11, end_lineno=123, end_col_offset=21), args=[Name(id='cpu_index', ctx=Load(), lineno=123, col_offset=22, end_lineno=123, end_col_offset=31), Attribute(value=Name(id='faiss_module', ctx=Load(), lineno=123, col_offset=33, end_lineno=123, end_col_offset=45), attr='IndexIDMap2', ctx=Load(), lineno=123, col_offset=33, end_lineno=123, end_col_offset=57)], lineno=123, col_offset=11, end_lineno=123, end_col_offset=58), lineno=123, col_offset=4, end_lineno=123, end_col_offset=58), Assign(targets=[Name(id='underlying', ctx=Store(), lineno=124, col_offset=4, end_lineno=124, end_col_offset=14)], value=Call(func=Name(id='_get_underlying_index', ctx=Load(), lineno=124, col_offset=17, end_lineno=124, end_col_offset=38), args=[Name(id='cpu_index', ctx=Load(), lineno=124, col_offset=39, end_lineno=124, end_col_offset=48)], lineno=124, col_offset=17, end_lineno=124, end_col_offset=49), lineno=124, col_offset=4, end_lineno=124, end_col_offset=49), Assign(targets=[Name(id='underlying_type', ctx=Store(), lineno=127, col_offset=4, end_lineno=127, end_col_offset=19)], value=Call(func=Name(id='type', ctx=Load(), lineno=127, col_offset=22, end_lineno=127, end_col_offset=26), args=[Name(id='underlying', ctx=Load(), lineno=127, col_offset=27, end_lineno=127, end_col_offset=37)], lineno=127, col_offset=22, end_lineno=127, end_col_offset=38), lineno=127, col_offset=4, end_lineno=127, end_col_offset=38), Assign(targets=[Name(id='underlying_type_name', ctx=Store(), lineno=128, col_offset=4, end_lineno=128, end_col_offset=24)], value=Attribute(value=Name(id='underlying_type', ctx=Load(), lineno=128, col_offset=27, end_lineno=128, end_col_offset=42), attr='__name__', ctx=Load(), lineno=128, col_offset=27, end_lineno=128, end_col_offset=51), lineno=128, col_offset=4, end_lineno=128, end_col_offset=51), Assign(targets=[Name(id='underlying_mro', ctx=Store(), lineno=129, col_offset=4, end_lineno=129, end_col_offset=18)], value=ListComp(elt=Attribute(value=Name(id='c', ctx=Load(), lineno=129, col_offset=22, end_lineno=129, end_col_offset=23), attr='__name__', ctx=Load(), lineno=129, col_offset=22, end_lineno=129, end_col_offset=32), generators=[comprehension(target=Name(id='c', ctx=Store(), lineno=129, col_offset=37, end_lineno=129, end_col_offset=38), iter=Attribute(value=Name(id='underlying_type', ctx=Load(), lineno=129, col_offset=42, end_lineno=129, end_col_offset=57), attr='__mro__', ctx=Load(), lineno=129, col_offset=42, end_lineno=129, end_col_offset=65), is_async=0)], lineno=129, col_offset=21, end_lineno=129, end_col_offset=66), lineno=129, col_offset=4, end_lineno=129, end_col_offset=66), Assign(targets=[Name(id='has_metric_type', ctx=Store(), lineno=132, col_offset=4, end_lineno=132, end_col_offset=19)], value=Call(func=Name(id='hasattr', ctx=Load(), lineno=132, col_offset=22, end_lineno=132, end_col_offset=29), args=[Name(id='underlying', ctx=Load(), lineno=132, col_offset=30, end_lineno=132, end_col_offset=40), Constant(value='metric_type', lineno=132, col_offset=42, end_lineno=132, end_col_offset=55)], lineno=132, col_offset=22, end_lineno=132, end_col_offset=56), lineno=132, col_offset=4, end_lineno=132, end_col_offset=56), Assign(targets=[Name(id='metric_type', ctx=Store(), lineno=133, col_offset=4, end_lineno=133, end_col_offset=15)], value=IfExp(test=Name(id='has_metric_type', ctx=Load(), lineno=133, col_offset=62, end_lineno=133, end_col_offset=77), body=Call(func=Name(id='getattr', ctx=Load(), lineno=133, col_offset=18, end_lineno=133, end_col_offset=25), args=[Name(id='underlying', ctx=Load(), lineno=133, col_offset=26, end_lineno=133, end_col_offset=36), Constant(value='metric_type', lineno=133, col_offset=38, end_lineno=133, end_col_offset=51), Constant(value=None, lineno=133, col_offset=53, end_lineno=133, end_col_offset=57)], lineno=133, col_offset=18, end_lineno=133, end_col_offset=58), orelse=Constant(value=None, lineno=133, col_offset=83, end_lineno=133, end_col_offset=87), lineno=133, col_offset=18, end_lineno=133, end_col_offset=87), lineno=133, col_offset=4, end_lineno=133, end_col_offset=87), Assign(targets=[Name(id='has_nlist', ctx=Store(), lineno=136, col_offset=4, end_lineno=136, end_col_offset=13)], value=Call(func=Name(id='hasattr', ctx=Load(), lineno=136, col_offset=16, end_lineno=136, end_col_offset=23), args=[Name(id='underlying', ctx=Load(), lineno=136, col_offset=24, end_lineno=136, end_col_offset=34), Constant(value='nlist', lineno=136, col_offset=36, end_lineno=136, end_col_offset=43)], lineno=136, col_offset=16, end_lineno=136, end_col_offset=44), lineno=136, col_offset=4, end_lineno=136, end_col_offset=44), Expr(value=Call(func=Name(id='print', ctx=Load(), lineno=139, col_offset=4, end_lineno=139, end_col_offset=9), args=[JoinedStr(values=[Constant(value='\n[TELEMETRY] n_vectors=', lineno=139, col_offset=12, end_lineno=139, end_col_offset=36), FormattedValue(value=Name(id='n_vectors', ctx=Load(), lineno=139, col_offset=37, end_lineno=139, end_col_offset=46), conversion=-1, lineno=139, col_offset=36, end_lineno=139, end_col_offset=47), Constant(value=', expected_type=', lineno=139, col_offset=47, end_lineno=139, end_col_offset=63), FormattedValue(value=Name(id='expected_type', ctx=Load(), lineno=139, col_offset=64, end_lineno=139, end_col_offset=77), conversion=-1, lineno=139, col_offset=63, end_lineno=139, end_col_offset=78)], lineno=139, col_offset=10, end_lineno=139, end_col_offset=79)], lineno=139, col_offset=4, end_lineno=139, end_col_offset=80), lineno=139, col_offset=4, end_lineno=139, end_col_offset=80), Expr(value=Call(func=Name(id='print', ctx=Load(), lineno=140, col_offset=4, end_lineno=140, end_col_offset=9), args=[JoinedStr(values=[Constant(value='[TELEMETRY] underlying_type_name=', lineno=140, col_offset=12, end_lineno=140, end_col_offset=45), FormattedValue(value=Name(id='underlying_type_name', ctx=Load(), lineno=140, col_offset=46, end_lineno=140, end_col_offset=66), conversion=-1, lineno=140, col_offset=45, end_lineno=140, end_col_offset=67)], lineno=140, col_offset=10, end_lineno=140, end_col_offset=68)], lineno=140, col_offset=4, end_lineno=140, end_col_offset=69), lineno=140, col_offset=4, end_lineno=140, end_col_offset=69), Expr(value=Call(func=Name(id='print', ctx=Load(), lineno=141, col_offset=4, end_lineno=141, end_col_offset=9), args=[JoinedStr(values=[Constant(value='[TELEMETRY] underlying_mro=', lineno=141, col_offset=12, end_lineno=141, end_col_offset=39), FormattedValue(value=Name(id='underlying_mro', ctx=Load(), lineno=141, col_offset=40, end_lineno=141, end_col_offset=54), conversion=-1, lineno=141, col_offset=39, end_lineno=141, end_col_offset=55)], lineno=141, col_offset=10, end_lineno=141, end_col_offset=56)], lineno=141, col_offset=4, end_lineno=141, end_col_offset=57), lineno=141, col_offset=4, end_lineno=141, end_col_offset=57), Expr(value=Call(func=Name(id='print', ctx=Load(), lineno=142, col_offset=4, end_lineno=142, end_col_offset=9), args=[JoinedStr(values=[Constant(value='[TELEMETRY] has_metric_type=', lineno=142, col_offset=12, end_lineno=142, end_col_offset=40), FormattedValue(value=Name(id='has_metric_type', ctx=Load(), lineno=142, col_offset=41, end_lineno=142, end_col_offset=56), conversion=-1, lineno=142, col_offset=40, end_lineno=142, end_col_offset=57), Constant(value=', metric_type=', lineno=142, col_offset=57, end_lineno=142, end_col_offset=71), FormattedValue(value=Name(id='metric_type', ctx=Load(), lineno=142, col_offset=72, end_lineno=142, end_col_offset=83), conversion=-1, lineno=142, col_offset=71, end_lineno=142, end_col_offset=84)], lineno=142, col_offset=10, end_lineno=142, end_col_offset=85)], lineno=142, col_offset=4, end_lineno=142, end_col_offset=86), lineno=142, col_offset=4, end_lineno=142, end_col_offset=86), Expr(value=Call(func=Name(id='print', ctx=Load(), lineno=143, col_offset=4, end_lineno=143, end_col_offset=9), args=[JoinedStr(values=[Constant(value='[TELEMETRY] has_nlist=', lineno=143, col_offset=12, end_lineno=143, end_col_offset=34), FormattedValue(value=Name(id='has_nlist', ctx=Load(), lineno=143, col_offset=35, end_lineno=143, end_col_offset=44), conversion=-1, lineno=143, col_offset=34, end_lineno=143, end_col_offset=45)], lineno=143, col_offset=10, end_lineno=143, end_col_offset=46)], lineno=143, col_offset=4, end_lineno=143, end_col_offset=47), lineno=143, col_offset=4, end_lineno=143, end_col_offset=47), If(test=Compare(left=Name(id='expected_type', ctx=Load(), lineno=145, col_offset=7, end_lineno=145, end_col_offset=20), ops=[Eq()], comparators=[Constant(value='flat', lineno=145, col_offset=24, end_lineno=145, end_col_offset=30)], lineno=145, col_offset=7, end_lineno=145, end_col_offset=30), body=[Assert(test=Name(id='has_metric_type', ctx=Load(), lineno=148, col_offset=15, end_lineno=148, end_col_offset=30), msg=JoinedStr(values=[Constant(value='Expected flat index with metric_type, got ', lineno=148, col_offset=34, end_lineno=148, end_col_offset=76), FormattedValue(value=Name(id='underlying_type_name', ctx=Load(), lineno=148, col_offset=77, end_lineno=148, end_col_offset=97), conversion=-1, lineno=148, col_offset=76, end_lineno=148, end_col_offset=98)], lineno=148, col_offset=32, end_lineno=148, end_col_offset=99), lineno=148, col_offset=8, end_lineno=148, end_col_offset=99), Assert(test=UnaryOp(op=Not(), operand=Name(id='has_nlist', ctx=Load(), lineno=149, col_offset=19, end_lineno=149, end_col_offset=28), lineno=149, col_offset=15, end_lineno=149, end_col_offset=28), msg=JoinedStr(values=[Constant(value='Expected flat index without nlist, got ', lineno=149, col_offset=32, end_lineno=149, end_col_offset=71), FormattedValue(value=Name(id='underlying_type_name', ctx=Load(), lineno=149, col_offset=72, end_lineno=149, end_col_offset=92), conversion=-1, lineno=149, col_offset=71, end_lineno=149, end_col_offset=93)], lineno=149, col_offset=30, end_lineno=149, end_col_offset=94), lineno=149, col_offset=8, end_lineno=149, end_col_offset=94), If(test=Compare(left=Name(id='metric_type', ctx=Load(), lineno=150, col_offset=11, end_lineno=150, end_col_offset=22), ops=[IsNot()], comparators=[Constant(value=None, lineno=150, col_offset=30, end_lineno=150, end_col_offset=34)], lineno=150, col_offset=11, end_lineno=150, end_col_offset=34), body=[Assert(test=Compare(left=Name(id='metric_type', ctx=Load(), lineno=151, col_offset=19, end_lineno=151, end_col_offset=30), ops=[Eq()], comparators=[Attribute(value=Name(id='faiss_module', ctx=Load(), lineno=151, col_offset=34, end_lineno=151, end_col_offset=46), attr='METRIC_INNER_PRODUCT', ctx=Load(), lineno=151, col_offset=34, end_lineno=151, end_col_offset=67)], lineno=151, col_offset=19, end_lineno=151, end_col_offset=67), msg=JoinedStr(values=[Constant(value='Expected METRIC_INNER_PRODUCT, got ', lineno=152, col_offset=18, end_lineno=152, end_col_offset=53), FormattedValue(value=Name(id='metric_type', ctx=Load(), lineno=152, col_offset=54, end_lineno=152, end_col_offset=65), conversion=-1, lineno=152, col_offset=53, end_lineno=152, end_col_offset=66)], lineno=152, col_offset=16, end_lineno=152, end_col_offset=67), lineno=151, col_offset=12, end_lineno=153, end_col_offset=13)], lineno=150, col_offset=8, end_lineno=153, end_col_offset=13)], orelse=[If(test=Compare(left=Name(id='expected_type', ctx=Load(), lineno=154, col_offset=9, end_lineno=154, end_col_offset=22), ops=[Eq()], comparators=[Constant(value='ivf_flat', lineno=154, col_offset=26, end_lineno=154, end_col_offset=36)], lineno=154, col_offset=9, end_lineno=154, end_col_offset=36), body=[Assert(test=Name(id='has_nlist', ctx=Load(), lineno=156, col_offset=15, end_lineno=156, end_col_offset=24), msg=JoinedStr(values=[Constant(value='Expected IVFFlat index with nlist, got ', lineno=156, col_offset=28, end_lineno=156, end_col_offset=67), FormattedValue(value=Name(id='underlying_type_name', ctx=Load(), lineno=156, col_offset=68, end_lineno=156, end_col_offset=88), conversion=-1, lineno=156, col_offset=67, end_lineno=156, end_col_offset=89)], lineno=156, col_offset=26, end_lineno=156, end_col_offset=90), lineno=156, col_offset=8, end_lineno=156, end_col_offset=90), Assert(test=Name(id='has_metric_type', ctx=Load(), lineno=157, col_offset=15, end_lineno=157, end_col_offset=30), msg=JoinedStr(values=[Constant(value='Expected IVFFlat index with metric_type, got ', lineno=158, col_offset=14, end_lineno=158, end_col_offset=59), FormattedValue(value=Name(id='underlying_type_name', ctx=Load(), lineno=158, col_offset=60, end_lineno=158, end_col_offset=80), conversion=-1, lineno=158, col_offset=59, end_lineno=158, end_col_offset=81)], lineno=158, col_offset=12, end_lineno=158, end_col_offset=82), lineno=157, col_offset=8, end_lineno=159, end_col_offset=9), If(test=Compare(left=Name(id='metric_type', ctx=Load(), lineno=160, col_offset=11, end_lineno=160, end_col_offset=22), ops=[IsNot()], comparators=[Constant(value=None, lineno=160, col_offset=30, end_lineno=160, end_col_offset=34)], lineno=160, col_offset=11, end_lineno=160, end_col_offset=34), body=[Assert(test=Compare(left=Name(id='metric_type', ctx=Load(), lineno=161, col_offset=19, end_lineno=161, end_col_offset=30), ops=[Eq()], comparators=[Attribute(value=Name(id='faiss_module', ctx=Load(), lineno=161, col_offset=34, end_lineno=161, end_col_offset=46), attr='METRIC_INNER_PRODUCT', ctx=Load(), lineno=161, col_offset=34, end_lineno=161, end_col_offset=67)], lineno=161, col_offset=19, end_lineno=161, end_col_offset=67), msg=JoinedStr(values=[Constant(value='Expected METRIC_INNER_PRODUCT, got ', lineno=162, col_offset=18, end_lineno=162, end_col_offset=53), FormattedValue(value=Name(id='metric_type', ctx=Load(), lineno=162, col_offset=54, end_lineno=162, end_col_offset=65), conversion=-1, lineno=162, col_offset=53, end_lineno=162, end_col_offset=66)], lineno=162, col_offset=16, end_lineno=162, end_col_offset=67), lineno=161, col_offset=12, end_lineno=163, end_col_offset=13)], lineno=160, col_offset=8, end_lineno=163, end_col_offset=13)], orelse=[Assign(targets=[Name(id='msg', ctx=Store(), lineno=166, col_offset=8, end_lineno=166, end_col_offset=11)], value=JoinedStr(values=[Constant(value='Unexpected type ', lineno=166, col_offset=16, end_lineno=166, end_col_offset=32), FormattedValue(value=Name(id='expected_type', ctx=Load(), lineno=166, col_offset=33, end_lineno=166, end_col_offset=46), conversion=-1, lineno=166, col_offset=32, end_lineno=166, end_col_offset=47), Constant(value=' in parametrized test', lineno=166, col_offset=47, end_lineno=166, end_col_offset=68)], lineno=166, col_offset=14, end_lineno=166, end_col_offset=69), lineno=166, col_offset=8, end_lineno=166, end_col_offset=69), Raise(exc=Call(func=Name(id='AssertionError', ctx=Load(), lineno=167, col_offset=14, end_lineno=167, end_col_offset=28), args=[Name(id='msg', ctx=Load(), lineno=167, col_offset=29, end_lineno=167, end_col_offset=32)], lineno=167, col_offset=14, end_lineno=167, end_col_offset=33), lineno=167, col_offset=8, end_lineno=167, end_col_offset=33)], lineno=154, col_offset=4, end_lineno=167, end_col_offset=33)], lineno=145, col_offset=4, end_lineno=167, end_col_offset=33)], decorator_list=[Call(func=Attribute(value=Attribute(value=Name(id='pytest', ctx=Load(), lineno=74, col_offset=1, end_lineno=74, end_col_offset=7), attr='mark', ctx=Load(), lineno=74, col_offset=1, end_lineno=74, end_col_offset=12), attr='parametrize', ctx=Load(), lineno=74, col_offset=1, end_lineno=74, end_col_offset=24), args=[Tuple(elts=[Constant(value='n_vectors', lineno=75, col_offset=5, end_lineno=75, end_col_offset=16), Constant(value='expected_type', lineno=75, col_offset=18, end_lineno=75, end_col_offset=33)], ctx=Load(), lineno=75, col_offset=4, end_lineno=75, end_col_offset=34), List(elts=[Tuple(elts=[Constant(value=10, lineno=77, col_offset=9, end_lineno=77, end_col_offset=11), Constant(value='flat', lineno=77, col_offset=13, end_lineno=77, end_col_offset=19)], ctx=Load(), lineno=77, col_offset=8, end_lineno=77, end_col_offset=20), Tuple(elts=[Constant(value=100, lineno=78, col_offset=9, end_lineno=78, end_col_offset=12), Constant(value='flat', lineno=78, col_offset=14, end_lineno=78, end_col_offset=20)], ctx=Load(), lineno=78, col_offset=8, end_lineno=78, end_col_offset=21), Tuple(elts=[Constant(value=4999, lineno=79, col_offset=9, end_lineno=79, end_col_offset=13), Constant(value='flat', lineno=79, col_offset=15, end_lineno=79, end_col_offset=21)], ctx=Load(), lineno=79, col_offset=8, end_lineno=79, end_col_offset=22), Tuple(elts=[Constant(value=5000, lineno=80, col_offset=9, end_lineno=80, end_col_offset=13), Constant(value='ivf_flat', lineno=80, col_offset=15, end_lineno=80, end_col_offset=25)], ctx=Load(), lineno=80, col_offset=8, end_lineno=80, end_col_offset=26), Tuple(elts=[Constant(value=10000, lineno=81, col_offset=9, end_lineno=81, end_col_offset=14), Constant(value='ivf_flat', lineno=81, col_offset=16, end_lineno=81, end_col_offset=26)], ctx=Load(), lineno=81, col_offset=8, end_lineno=81, end_col_offset=27)], ctx=Load(), lineno=76, col_offset=4, end_lineno=82, end_col_offset=5)], lineno=74, col_offset=1, end_lineno=83, end_col_offset=1)], returns=Constant(value=None, lineno=84, col_offset=95, end_lineno=84, end_col_offset=99), lineno=84, col_offset=0, end_lineno=167, end_col_offset=33), FunctionDef(name='test_small_corpus_flat_index', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=170, col_offset=49, end_lineno=170, end_col_offset=53), lineno=170, col_offset=33, end_lineno=170, end_col_offset=53)]), body=[Expr(value=Constant(value="Test that small corpus (<5K) uses flat index with no training.\n\n    Flat indexes don't require training, so build_index should complete\n    immediately without training overhead.\n    ", lineno=171, col_offset=4, end_lineno=175, end_col_offset=7), lineno=171, col_offset=4, end_lineno=175, end_col_offset=7), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=176, col_offset=4, end_lineno=176, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=176, col_offset=14, end_lineno=176, end_col_offset=32), lineno=176, col_offset=4, end_lineno=176, end_col_offset=32), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=177, col_offset=4, end_lineno=177, end_col_offset=13)], value=Constant(value=100, lineno=177, col_offset=16, end_lineno=177, end_col_offset=19), lineno=177, col_offset=4, end_lineno=177, end_col_offset=19), Assign(targets=[Name(id='manager', ctx=Store(), lineno=178, col_offset=4, end_lineno=178, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=178, col_offset=14, end_lineno=178, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=178, col_offset=38, end_lineno=178, end_col_offset=52), lineno=178, col_offset=27, end_lineno=178, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=178, col_offset=62, end_lineno=178, end_col_offset=69), lineno=178, col_offset=54, end_lineno=178, end_col_offset=69)], lineno=178, col_offset=14, end_lineno=178, end_col_offset=70), lineno=178, col_offset=4, end_lineno=178, end_col_offset=70), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=183, col_offset=4, end_lineno=183, end_col_offset=11)], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='_rng', ctx=Load(), lineno=183, col_offset=14, end_lineno=183, end_col_offset=18), attr='normal', ctx=Load(), lineno=183, col_offset=14, end_lineno=183, end_col_offset=25), args=[Constant(value=0.5, lineno=183, col_offset=26, end_lineno=183, end_col_offset=29), Constant(value=0.15, lineno=183, col_offset=31, end_lineno=183, end_col_offset=35), Tuple(elts=[Name(id='n_vectors', ctx=Load(), lineno=183, col_offset=38, end_lineno=183, end_col_offset=47), Name(id='vec_dim', ctx=Load(), lineno=183, col_offset=49, end_lineno=183, end_col_offset=56)], ctx=Load(), lineno=183, col_offset=37, end_lineno=183, end_col_offset=57)], lineno=183, col_offset=14, end_lineno=183, end_col_offset=58), attr='astype', ctx=Load(), lineno=183, col_offset=14, end_lineno=183, end_col_offset=65), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=183, col_offset=66, end_lineno=183, end_col_offset=68), attr='float32', ctx=Load(), lineno=183, col_offset=66, end_lineno=183, end_col_offset=76)], lineno=183, col_offset=14, end_lineno=183, end_col_offset=77), lineno=183, col_offset=4, end_lineno=183, end_col_offset=77), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=184, col_offset=4, end_lineno=184, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=184, col_offset=14, end_lineno=184, end_col_offset=16), attr='clip', ctx=Load(), lineno=184, col_offset=14, end_lineno=184, end_col_offset=21), args=[Name(id='vectors', ctx=Load(), lineno=184, col_offset=22, end_lineno=184, end_col_offset=29), Constant(value=0.0, lineno=184, col_offset=31, end_lineno=184, end_col_offset=34), Constant(value=1.0, lineno=184, col_offset=36, end_lineno=184, end_col_offset=39)], lineno=184, col_offset=14, end_lineno=184, end_col_offset=40), lineno=184, col_offset=4, end_lineno=184, end_col_offset=40), Expr(value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=187, col_offset=4, end_lineno=187, end_col_offset=11), attr='build_index', ctx=Load(), lineno=187, col_offset=4, end_lineno=187, end_col_offset=23), args=[Name(id='vectors', ctx=Load(), lineno=187, col_offset=24, end_lineno=187, end_col_offset=31)], lineno=187, col_offset=4, end_lineno=187, end_col_offset=32), lineno=187, col_offset=4, end_lineno=187, end_col_offset=32), Assert(test=Compare(left=Attribute(value=Name(id='manager', ctx=Load(), lineno=190, col_offset=11, end_lineno=190, end_col_offset=18), attr='cpu_index', ctx=Load(), lineno=190, col_offset=11, end_lineno=190, end_col_offset=28), ops=[IsNot()], comparators=[Constant(value=None, lineno=190, col_offset=36, end_lineno=190, end_col_offset=40)], lineno=190, col_offset=11, end_lineno=190, end_col_offset=40), lineno=190, col_offset=4, end_lineno=190, end_col_offset=40), Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=191, col_offset=4, end_lineno=191, end_col_offset=13)], value=Attribute(value=Name(id='manager', ctx=Load(), lineno=191, col_offset=16, end_lineno=191, end_col_offset=23), attr='cpu_index', ctx=Load(), lineno=191, col_offset=16, end_lineno=191, end_col_offset=33), lineno=191, col_offset=4, end_lineno=191, end_col_offset=33), Assert(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=192, col_offset=11, end_lineno=192, end_col_offset=21), args=[Name(id='cpu_index', ctx=Load(), lineno=192, col_offset=22, end_lineno=192, end_col_offset=31), Attribute(value=Name(id='faiss_module', ctx=Load(), lineno=192, col_offset=33, end_lineno=192, end_col_offset=45), attr='IndexIDMap2', ctx=Load(), lineno=192, col_offset=33, end_lineno=192, end_col_offset=57)], lineno=192, col_offset=11, end_lineno=192, end_col_offset=58), lineno=192, col_offset=4, end_lineno=192, end_col_offset=58), Assign(targets=[Name(id='underlying', ctx=Store(), lineno=193, col_offset=4, end_lineno=193, end_col_offset=14)], value=Call(func=Name(id='_get_underlying_index', ctx=Load(), lineno=193, col_offset=17, end_lineno=193, end_col_offset=38), args=[Name(id='cpu_index', ctx=Load(), lineno=193, col_offset=39, end_lineno=193, end_col_offset=48)], lineno=193, col_offset=17, end_lineno=193, end_col_offset=49), lineno=193, col_offset=4, end_lineno=193, end_col_offset=49), Assert(test=Compare(left=Constant(value='FlatIP', lineno=195, col_offset=11, end_lineno=195, end_col_offset=19), ops=[In()], comparators=[Attribute(value=Call(func=Name(id='type', ctx=Load(), lineno=195, col_offset=23, end_lineno=195, end_col_offset=27), args=[Name(id='underlying', ctx=Load(), lineno=195, col_offset=28, end_lineno=195, end_col_offset=38)], lineno=195, col_offset=23, end_lineno=195, end_col_offset=39), attr='__name__', ctx=Load(), lineno=195, col_offset=23, end_lineno=195, end_col_offset=48)], lineno=195, col_offset=11, end_lineno=195, end_col_offset=48), msg=JoinedStr(values=[Constant(value='Expected FlatIP, got ', lineno=196, col_offset=10, end_lineno=196, end_col_offset=31), FormattedValue(value=Attribute(value=Call(func=Name(id='type', ctx=Load(), lineno=196, col_offset=32, end_lineno=196, end_col_offset=36), args=[Name(id='underlying', ctx=Load(), lineno=196, col_offset=37, end_lineno=196, end_col_offset=47)], lineno=196, col_offset=32, end_lineno=196, end_col_offset=48), attr='__name__', ctx=Load(), lineno=196, col_offset=32, end_lineno=196, end_col_offset=57), conversion=-1, lineno=196, col_offset=31, end_lineno=196, end_col_offset=58)], lineno=196, col_offset=8, end_lineno=196, end_col_offset=59), lineno=195, col_offset=4, end_lineno=197, end_col_offset=5)], returns=Constant(value=None, lineno=170, col_offset=58, end_lineno=170, end_col_offset=62), lineno=170, col_offset=0, end_lineno=197, end_col_offset=5), FunctionDef(name='test_small_corpus_search_returns_results', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=200, col_offset=61, end_lineno=200, end_col_offset=65), lineno=200, col_offset=45, end_lineno=200, end_col_offset=65)]), body=[Expr(value=Constant(value='Regression: searching flat indexes skips nprobe assignment and succeeds.', lineno=201, col_offset=4, end_lineno=201, end_col_offset=82), lineno=201, col_offset=4, end_lineno=201, end_col_offset=82), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=202, col_offset=4, end_lineno=202, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=202, col_offset=14, end_lineno=202, end_col_offset=32), lineno=202, col_offset=4, end_lineno=202, end_col_offset=32), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=203, col_offset=4, end_lineno=203, end_col_offset=13)], value=Constant(value=32, lineno=203, col_offset=16, end_lineno=203, end_col_offset=18), lineno=203, col_offset=4, end_lineno=203, end_col_offset=18), Assign(targets=[Name(id='manager', ctx=Store(), lineno=204, col_offset=4, end_lineno=204, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=204, col_offset=14, end_lineno=204, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=204, col_offset=38, end_lineno=204, end_col_offset=52), lineno=204, col_offset=27, end_lineno=204, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=204, col_offset=62, end_lineno=204, end_col_offset=69), lineno=204, col_offset=54, end_lineno=204, end_col_offset=69)], lineno=204, col_offset=14, end_lineno=204, end_col_offset=70), lineno=204, col_offset=4, end_lineno=204, end_col_offset=70), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=206, col_offset=4, end_lineno=206, end_col_offset=11)], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='_rng', ctx=Load(), lineno=206, col_offset=14, end_lineno=206, end_col_offset=18), attr='normal', ctx=Load(), lineno=206, col_offset=14, end_lineno=206, end_col_offset=25), args=[Constant(value=0.5, lineno=206, col_offset=26, end_lineno=206, end_col_offset=29), Constant(value=0.15, lineno=206, col_offset=31, end_lineno=206, end_col_offset=35), Tuple(elts=[Name(id='n_vectors', ctx=Load(), lineno=206, col_offset=38, end_lineno=206, end_col_offset=47), Name(id='vec_dim', ctx=Load(), lineno=206, col_offset=49, end_lineno=206, end_col_offset=56)], ctx=Load(), lineno=206, col_offset=37, end_lineno=206, end_col_offset=57)], lineno=206, col_offset=14, end_lineno=206, end_col_offset=58), attr='astype', ctx=Load(), lineno=206, col_offset=14, end_lineno=206, end_col_offset=65), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=206, col_offset=66, end_lineno=206, end_col_offset=68), attr='float32', ctx=Load(), lineno=206, col_offset=66, end_lineno=206, end_col_offset=76)], lineno=206, col_offset=14, end_lineno=206, end_col_offset=77), lineno=206, col_offset=4, end_lineno=206, end_col_offset=77), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=207, col_offset=4, end_lineno=207, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=207, col_offset=14, end_lineno=207, end_col_offset=16), attr='clip', ctx=Load(), lineno=207, col_offset=14, end_lineno=207, end_col_offset=21), args=[Name(id='vectors', ctx=Load(), lineno=207, col_offset=22, end_lineno=207, end_col_offset=29), Constant(value=0.0, lineno=207, col_offset=31, end_lineno=207, end_col_offset=34), Constant(value=1.0, lineno=207, col_offset=36, end_lineno=207, end_col_offset=39)], lineno=207, col_offset=14, end_lineno=207, end_col_offset=40), lineno=207, col_offset=4, end_lineno=207, end_col_offset=40), Expr(value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=209, col_offset=4, end_lineno=209, end_col_offset=11), attr='build_index', ctx=Load(), lineno=209, col_offset=4, end_lineno=209, end_col_offset=23), args=[Name(id='vectors', ctx=Load(), lineno=209, col_offset=24, end_lineno=209, end_col_offset=31)], lineno=209, col_offset=4, end_lineno=209, end_col_offset=32), lineno=209, col_offset=4, end_lineno=209, end_col_offset=32), Assign(targets=[Name(id='ids', ctx=Store(), lineno=211, col_offset=4, end_lineno=211, end_col_offset=7)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=211, col_offset=10, end_lineno=211, end_col_offset=12), attr='arange', ctx=Load(), lineno=211, col_offset=10, end_lineno=211, end_col_offset=19), args=[Name(id='n_vectors', ctx=Load(), lineno=211, col_offset=20, end_lineno=211, end_col_offset=29)], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='np', ctx=Load(), lineno=211, col_offset=37, end_lineno=211, end_col_offset=39), attr='int64', ctx=Load(), lineno=211, col_offset=37, end_lineno=211, end_col_offset=45), lineno=211, col_offset=31, end_lineno=211, end_col_offset=45)], lineno=211, col_offset=10, end_lineno=211, end_col_offset=46), lineno=211, col_offset=4, end_lineno=211, end_col_offset=46), Expr(value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=212, col_offset=4, end_lineno=212, end_col_offset=11), attr='add_vectors', ctx=Load(), lineno=212, col_offset=4, end_lineno=212, end_col_offset=23), args=[Name(id='vectors', ctx=Load(), lineno=212, col_offset=24, end_lineno=212, end_col_offset=31), Name(id='ids', ctx=Load(), lineno=212, col_offset=33, end_lineno=212, end_col_offset=36)], lineno=212, col_offset=4, end_lineno=212, end_col_offset=37), lineno=212, col_offset=4, end_lineno=212, end_col_offset=37), Assign(targets=[Name(id='query', ctx=Store(), lineno=214, col_offset=4, end_lineno=214, end_col_offset=9)], value=Subscript(value=Name(id='vectors', ctx=Load(), lineno=214, col_offset=12, end_lineno=214, end_col_offset=19), slice=Constant(value=0, lineno=214, col_offset=20, end_lineno=214, end_col_offset=21), ctx=Load(), lineno=214, col_offset=12, end_lineno=214, end_col_offset=22), lineno=214, col_offset=4, end_lineno=214, end_col_offset=22), Assign(targets=[Tuple(elts=[Name(id='distances', ctx=Store(), lineno=215, col_offset=4, end_lineno=215, end_col_offset=13), Name(id='retrieved_ids', ctx=Store(), lineno=215, col_offset=15, end_lineno=215, end_col_offset=28)], ctx=Store(), lineno=215, col_offset=4, end_lineno=215, end_col_offset=28)], value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=215, col_offset=31, end_lineno=215, end_col_offset=38), attr='search', ctx=Load(), lineno=215, col_offset=31, end_lineno=215, end_col_offset=45), args=[Name(id='query', ctx=Load(), lineno=215, col_offset=46, end_lineno=215, end_col_offset=51)], keywords=[keyword(arg='k', value=Constant(value=5, lineno=215, col_offset=55, end_lineno=215, end_col_offset=56), lineno=215, col_offset=53, end_lineno=215, end_col_offset=56)], lineno=215, col_offset=31, end_lineno=215, end_col_offset=57), lineno=215, col_offset=4, end_lineno=215, end_col_offset=57), Assert(test=Compare(left=Attribute(value=Name(id='distances', ctx=Load(), lineno=217, col_offset=11, end_lineno=217, end_col_offset=20), attr='shape', ctx=Load(), lineno=217, col_offset=11, end_lineno=217, end_col_offset=26), ops=[Eq()], comparators=[Tuple(elts=[Constant(value=1, lineno=217, col_offset=31, end_lineno=217, end_col_offset=32), Constant(value=5, lineno=217, col_offset=34, end_lineno=217, end_col_offset=35)], ctx=Load(), lineno=217, col_offset=30, end_lineno=217, end_col_offset=36)], lineno=217, col_offset=11, end_lineno=217, end_col_offset=36), lineno=217, col_offset=4, end_lineno=217, end_col_offset=36), Assert(test=Compare(left=Attribute(value=Name(id='retrieved_ids', ctx=Load(), lineno=218, col_offset=11, end_lineno=218, end_col_offset=24), attr='shape', ctx=Load(), lineno=218, col_offset=11, end_lineno=218, end_col_offset=30), ops=[Eq()], comparators=[Tuple(elts=[Constant(value=1, lineno=218, col_offset=35, end_lineno=218, end_col_offset=36), Constant(value=5, lineno=218, col_offset=38, end_lineno=218, end_col_offset=39)], ctx=Load(), lineno=218, col_offset=34, end_lineno=218, end_col_offset=40)], lineno=218, col_offset=11, end_lineno=218, end_col_offset=40), lineno=218, col_offset=4, end_lineno=218, end_col_offset=40), Assert(test=Compare(left=Subscript(value=Name(id='retrieved_ids', ctx=Load(), lineno=219, col_offset=11, end_lineno=219, end_col_offset=24), slice=Tuple(elts=[Constant(value=0, lineno=219, col_offset=25, end_lineno=219, end_col_offset=26), Constant(value=0, lineno=219, col_offset=28, end_lineno=219, end_col_offset=29)], ctx=Load(), lineno=219, col_offset=25, end_lineno=219, end_col_offset=29), ctx=Load(), lineno=219, col_offset=11, end_lineno=219, end_col_offset=30), ops=[Eq()], comparators=[Subscript(value=Name(id='ids', ctx=Load(), lineno=219, col_offset=34, end_lineno=219, end_col_offset=37), slice=Constant(value=0, lineno=219, col_offset=38, end_lineno=219, end_col_offset=39), ctx=Load(), lineno=219, col_offset=34, end_lineno=219, end_col_offset=40)], lineno=219, col_offset=11, end_lineno=219, end_col_offset=40), lineno=219, col_offset=4, end_lineno=219, end_col_offset=40)], returns=Constant(value=None, lineno=200, col_offset=70, end_lineno=200, end_col_offset=74), lineno=200, col_offset=0, end_lineno=219, end_col_offset=40), FunctionDef(name='test_medium_corpus_ivf_flat_nlist', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=222, col_offset=54, end_lineno=222, end_col_offset=58), lineno=222, col_offset=38, end_lineno=222, end_col_offset=58)]), body=[Expr(value=Constant(value='Test that medium corpus (5K-50K) uses IVFFlat with dynamic nlist.\n\n    Verifies that nlist is calculated correctly: min(sqrt(n), n//39) with\n    minimum of 100.\n    ', lineno=223, col_offset=4, end_lineno=227, end_col_offset=7), lineno=223, col_offset=4, end_lineno=227, end_col_offset=7), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=228, col_offset=4, end_lineno=228, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=228, col_offset=14, end_lineno=228, end_col_offset=32), lineno=228, col_offset=4, end_lineno=228, end_col_offset=32), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=229, col_offset=4, end_lineno=229, end_col_offset=13)], value=Constant(value=5000, lineno=229, col_offset=16, end_lineno=229, end_col_offset=20), lineno=229, col_offset=4, end_lineno=229, end_col_offset=20), Assign(targets=[Name(id='manager', ctx=Store(), lineno=230, col_offset=4, end_lineno=230, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=230, col_offset=14, end_lineno=230, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=230, col_offset=38, end_lineno=230, end_col_offset=52), lineno=230, col_offset=27, end_lineno=230, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=230, col_offset=62, end_lineno=230, end_col_offset=69), lineno=230, col_offset=54, end_lineno=230, end_col_offset=69)], lineno=230, col_offset=14, end_lineno=230, end_col_offset=70), lineno=230, col_offset=4, end_lineno=230, end_col_offset=70), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=235, col_offset=4, end_lineno=235, end_col_offset=11)], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='_rng', ctx=Load(), lineno=235, col_offset=14, end_lineno=235, end_col_offset=18), attr='normal', ctx=Load(), lineno=235, col_offset=14, end_lineno=235, end_col_offset=25), args=[Constant(value=0.5, lineno=235, col_offset=26, end_lineno=235, end_col_offset=29), Constant(value=0.15, lineno=235, col_offset=31, end_lineno=235, end_col_offset=35), Tuple(elts=[Name(id='n_vectors', ctx=Load(), lineno=235, col_offset=38, end_lineno=235, end_col_offset=47), Name(id='vec_dim', ctx=Load(), lineno=235, col_offset=49, end_lineno=235, end_col_offset=56)], ctx=Load(), lineno=235, col_offset=37, end_lineno=235, end_col_offset=57)], lineno=235, col_offset=14, end_lineno=235, end_col_offset=58), attr='astype', ctx=Load(), lineno=235, col_offset=14, end_lineno=235, end_col_offset=65), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=235, col_offset=66, end_lineno=235, end_col_offset=68), attr='float32', ctx=Load(), lineno=235, col_offset=66, end_lineno=235, end_col_offset=76)], lineno=235, col_offset=14, end_lineno=235, end_col_offset=77), lineno=235, col_offset=4, end_lineno=235, end_col_offset=77), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=236, col_offset=4, end_lineno=236, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=236, col_offset=14, end_lineno=236, end_col_offset=16), attr='clip', ctx=Load(), lineno=236, col_offset=14, end_lineno=236, end_col_offset=21), args=[Name(id='vectors', ctx=Load(), lineno=236, col_offset=22, end_lineno=236, end_col_offset=29), Constant(value=0.0, lineno=236, col_offset=31, end_lineno=236, end_col_offset=34), Constant(value=1.0, lineno=236, col_offset=36, end_lineno=236, end_col_offset=39)], lineno=236, col_offset=14, end_lineno=236, end_col_offset=40), lineno=236, col_offset=4, end_lineno=236, end_col_offset=40), Expr(value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=238, col_offset=4, end_lineno=238, end_col_offset=11), attr='build_index', ctx=Load(), lineno=238, col_offset=4, end_lineno=238, end_col_offset=23), args=[Name(id='vectors', ctx=Load(), lineno=238, col_offset=24, end_lineno=238, end_col_offset=31)], lineno=238, col_offset=4, end_lineno=238, end_col_offset=32), lineno=238, col_offset=4, end_lineno=238, end_col_offset=32), Assert(test=Compare(left=Attribute(value=Name(id='manager', ctx=Load(), lineno=241, col_offset=11, end_lineno=241, end_col_offset=18), attr='cpu_index', ctx=Load(), lineno=241, col_offset=11, end_lineno=241, end_col_offset=28), ops=[IsNot()], comparators=[Constant(value=None, lineno=241, col_offset=36, end_lineno=241, end_col_offset=40)], lineno=241, col_offset=11, end_lineno=241, end_col_offset=40), lineno=241, col_offset=4, end_lineno=241, end_col_offset=40), Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=242, col_offset=4, end_lineno=242, end_col_offset=13)], value=Attribute(value=Name(id='manager', ctx=Load(), lineno=242, col_offset=16, end_lineno=242, end_col_offset=23), attr='cpu_index', ctx=Load(), lineno=242, col_offset=16, end_lineno=242, end_col_offset=33), lineno=242, col_offset=4, end_lineno=242, end_col_offset=33), Assert(test=Compare(left=Name(id='FAISS_MODULE', ctx=Load(), lineno=243, col_offset=11, end_lineno=243, end_col_offset=23), ops=[IsNot()], comparators=[Constant(value=None, lineno=243, col_offset=31, end_lineno=243, end_col_offset=35)], lineno=243, col_offset=11, end_lineno=243, end_col_offset=35), lineno=243, col_offset=4, end_lineno=243, end_col_offset=35), Assert(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=244, col_offset=11, end_lineno=244, end_col_offset=21), args=[Name(id='cpu_index', ctx=Load(), lineno=244, col_offset=22, end_lineno=244, end_col_offset=31), Attribute(value=Name(id='FAISS_MODULE', ctx=Load(), lineno=244, col_offset=33, end_lineno=244, end_col_offset=45), attr='IndexIDMap2', ctx=Load(), lineno=244, col_offset=33, end_lineno=244, end_col_offset=57)], lineno=244, col_offset=11, end_lineno=244, end_col_offset=58), lineno=244, col_offset=4, end_lineno=244, end_col_offset=58), Assign(targets=[Name(id='underlying', ctx=Store(), lineno=245, col_offset=4, end_lineno=245, end_col_offset=14)], value=Call(func=Name(id='_get_underlying_index', ctx=Load(), lineno=245, col_offset=17, end_lineno=245, end_col_offset=38), args=[Name(id='cpu_index', ctx=Load(), lineno=245, col_offset=39, end_lineno=245, end_col_offset=48)], lineno=245, col_offset=17, end_lineno=245, end_col_offset=49), lineno=245, col_offset=4, end_lineno=245, end_col_offset=49), Assert(test=Compare(left=Constant(value='IVFFlat', lineno=247, col_offset=11, end_lineno=247, end_col_offset=20), ops=[In()], comparators=[Attribute(value=Call(func=Name(id='type', ctx=Load(), lineno=247, col_offset=24, end_lineno=247, end_col_offset=28), args=[Name(id='underlying', ctx=Load(), lineno=247, col_offset=29, end_lineno=247, end_col_offset=39)], lineno=247, col_offset=24, end_lineno=247, end_col_offset=40), attr='__name__', ctx=Load(), lineno=247, col_offset=24, end_lineno=247, end_col_offset=49)], lineno=247, col_offset=11, end_lineno=247, end_col_offset=49), msg=JoinedStr(values=[Constant(value='Expected IVFFlat, got ', lineno=248, col_offset=10, end_lineno=248, end_col_offset=32), FormattedValue(value=Attribute(value=Call(func=Name(id='type', ctx=Load(), lineno=248, col_offset=33, end_lineno=248, end_col_offset=37), args=[Name(id='underlying', ctx=Load(), lineno=248, col_offset=38, end_lineno=248, end_col_offset=48)], lineno=248, col_offset=33, end_lineno=248, end_col_offset=49), attr='__name__', ctx=Load(), lineno=248, col_offset=33, end_lineno=248, end_col_offset=58), conversion=-1, lineno=248, col_offset=32, end_lineno=248, end_col_offset=59)], lineno=248, col_offset=8, end_lineno=248, end_col_offset=60), lineno=247, col_offset=4, end_lineno=249, end_col_offset=5), Assign(targets=[Name(id='expected_nlist', ctx=Store(), lineno=252, col_offset=4, end_lineno=252, end_col_offset=18)], value=Call(func=Name(id='min', ctx=Load(), lineno=252, col_offset=21, end_lineno=252, end_col_offset=24), args=[Call(func=Name(id='int', ctx=Load(), lineno=252, col_offset=25, end_lineno=252, end_col_offset=28), args=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=252, col_offset=29, end_lineno=252, end_col_offset=31), attr='sqrt', ctx=Load(), lineno=252, col_offset=29, end_lineno=252, end_col_offset=36), args=[Name(id='n_vectors', ctx=Load(), lineno=252, col_offset=37, end_lineno=252, end_col_offset=46)], lineno=252, col_offset=29, end_lineno=252, end_col_offset=47)], lineno=252, col_offset=25, end_lineno=252, end_col_offset=48), BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=252, col_offset=50, end_lineno=252, end_col_offset=59), op=FloorDiv(), right=Constant(value=39, lineno=252, col_offset=63, end_lineno=252, end_col_offset=65), lineno=252, col_offset=50, end_lineno=252, end_col_offset=65)], lineno=252, col_offset=21, end_lineno=252, end_col_offset=66), lineno=252, col_offset=4, end_lineno=252, end_col_offset=66), Assign(targets=[Name(id='expected_nlist', ctx=Store(), lineno=253, col_offset=4, end_lineno=253, end_col_offset=18)], value=Call(func=Name(id='max', ctx=Load(), lineno=253, col_offset=21, end_lineno=253, end_col_offset=24), args=[Name(id='expected_nlist', ctx=Load(), lineno=253, col_offset=25, end_lineno=253, end_col_offset=39), Constant(value=100, lineno=253, col_offset=41, end_lineno=253, end_col_offset=44)], lineno=253, col_offset=21, end_lineno=253, end_col_offset=45), lineno=253, col_offset=4, end_lineno=253, end_col_offset=45), Assert(test=Compare(left=Attribute(value=Name(id='underlying', ctx=Load(), lineno=254, col_offset=11, end_lineno=254, end_col_offset=21), attr='nlist', ctx=Load(), lineno=254, col_offset=11, end_lineno=254, end_col_offset=27), ops=[Eq()], comparators=[Name(id='expected_nlist', ctx=Load(), lineno=254, col_offset=31, end_lineno=254, end_col_offset=45)], lineno=254, col_offset=11, end_lineno=254, end_col_offset=45), lineno=254, col_offset=4, end_lineno=254, end_col_offset=45)], returns=Constant(value=None, lineno=222, col_offset=63, end_lineno=222, end_col_offset=67), lineno=222, col_offset=0, end_lineno=254, end_col_offset=45), FunctionDef(name='test_large_corpus_ivf_pq_nlist', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=258, col_offset=51, end_lineno=258, end_col_offset=55), lineno=258, col_offset=35, end_lineno=258, end_col_offset=55)]), body=[Expr(value=Constant(value='Test that large corpus (>50K) uses IVF-PQ with dynamic nlist.\n\n    Verifies that nlist is calculated correctly: sqrt(n) with minimum of 1024.\n    Uses reduced dimensions for fast unit test execution.\n\n    **Note**: This test is marked with @pytest.mark.gpu because building\n    IVF-PQ indexes for large corpora is expensive on CPU. It will be\n    skipped unless GPU is available or explicitly requested with -m gpu.\n    ', lineno=259, col_offset=4, end_lineno=267, end_col_offset=7), lineno=259, col_offset=4, end_lineno=267, end_col_offset=7), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=268, col_offset=4, end_lineno=268, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=268, col_offset=14, end_lineno=268, end_col_offset=32), lineno=268, col_offset=4, end_lineno=268, end_col_offset=32), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=269, col_offset=4, end_lineno=269, end_col_offset=13)], value=Constant(value=50000, lineno=269, col_offset=16, end_lineno=269, end_col_offset=21), lineno=269, col_offset=4, end_lineno=269, end_col_offset=21), Assign(targets=[Name(id='manager', ctx=Store(), lineno=270, col_offset=4, end_lineno=270, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=270, col_offset=14, end_lineno=270, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=270, col_offset=38, end_lineno=270, end_col_offset=52), lineno=270, col_offset=27, end_lineno=270, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=270, col_offset=62, end_lineno=270, end_col_offset=69), lineno=270, col_offset=54, end_lineno=270, end_col_offset=69)], lineno=270, col_offset=14, end_lineno=270, end_col_offset=70), lineno=270, col_offset=4, end_lineno=270, end_col_offset=70), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=275, col_offset=4, end_lineno=275, end_col_offset=11)], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='_rng', ctx=Load(), lineno=275, col_offset=14, end_lineno=275, end_col_offset=18), attr='normal', ctx=Load(), lineno=275, col_offset=14, end_lineno=275, end_col_offset=25), args=[Constant(value=0.5, lineno=275, col_offset=26, end_lineno=275, end_col_offset=29), Constant(value=0.15, lineno=275, col_offset=31, end_lineno=275, end_col_offset=35), Tuple(elts=[Name(id='n_vectors', ctx=Load(), lineno=275, col_offset=38, end_lineno=275, end_col_offset=47), Name(id='vec_dim', ctx=Load(), lineno=275, col_offset=49, end_lineno=275, end_col_offset=56)], ctx=Load(), lineno=275, col_offset=37, end_lineno=275, end_col_offset=57)], lineno=275, col_offset=14, end_lineno=275, end_col_offset=58), attr='astype', ctx=Load(), lineno=275, col_offset=14, end_lineno=275, end_col_offset=65), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=275, col_offset=66, end_lineno=275, end_col_offset=68), attr='float32', ctx=Load(), lineno=275, col_offset=66, end_lineno=275, end_col_offset=76)], lineno=275, col_offset=14, end_lineno=275, end_col_offset=77), lineno=275, col_offset=4, end_lineno=275, end_col_offset=77), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=276, col_offset=4, end_lineno=276, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=276, col_offset=14, end_lineno=276, end_col_offset=16), attr='clip', ctx=Load(), lineno=276, col_offset=14, end_lineno=276, end_col_offset=21), args=[Name(id='vectors', ctx=Load(), lineno=276, col_offset=22, end_lineno=276, end_col_offset=29), Constant(value=0.0, lineno=276, col_offset=31, end_lineno=276, end_col_offset=34), Constant(value=1.0, lineno=276, col_offset=36, end_lineno=276, end_col_offset=39)], lineno=276, col_offset=14, end_lineno=276, end_col_offset=40), lineno=276, col_offset=4, end_lineno=276, end_col_offset=40), Expr(value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=278, col_offset=4, end_lineno=278, end_col_offset=11), attr='build_index', ctx=Load(), lineno=278, col_offset=4, end_lineno=278, end_col_offset=23), args=[Name(id='vectors', ctx=Load(), lineno=278, col_offset=24, end_lineno=278, end_col_offset=31)], lineno=278, col_offset=4, end_lineno=278, end_col_offset=32), lineno=278, col_offset=4, end_lineno=278, end_col_offset=32), Assert(test=Compare(left=Attribute(value=Name(id='manager', ctx=Load(), lineno=281, col_offset=11, end_lineno=281, end_col_offset=18), attr='cpu_index', ctx=Load(), lineno=281, col_offset=11, end_lineno=281, end_col_offset=28), ops=[IsNot()], comparators=[Constant(value=None, lineno=281, col_offset=36, end_lineno=281, end_col_offset=40)], lineno=281, col_offset=11, end_lineno=281, end_col_offset=40), lineno=281, col_offset=4, end_lineno=281, end_col_offset=40), Assign(targets=[Name(id='cpu_index', ctx=Store(), lineno=282, col_offset=4, end_lineno=282, end_col_offset=13)], value=Attribute(value=Name(id='manager', ctx=Load(), lineno=282, col_offset=16, end_lineno=282, end_col_offset=23), attr='cpu_index', ctx=Load(), lineno=282, col_offset=16, end_lineno=282, end_col_offset=33), lineno=282, col_offset=4, end_lineno=282, end_col_offset=33), Assert(test=Compare(left=Name(id='FAISS_MODULE', ctx=Load(), lineno=283, col_offset=11, end_lineno=283, end_col_offset=23), ops=[IsNot()], comparators=[Constant(value=None, lineno=283, col_offset=31, end_lineno=283, end_col_offset=35)], lineno=283, col_offset=11, end_lineno=283, end_col_offset=35), lineno=283, col_offset=4, end_lineno=283, end_col_offset=35), Assert(test=Call(func=Name(id='isinstance', ctx=Load(), lineno=284, col_offset=11, end_lineno=284, end_col_offset=21), args=[Name(id='cpu_index', ctx=Load(), lineno=284, col_offset=22, end_lineno=284, end_col_offset=31), Attribute(value=Name(id='FAISS_MODULE', ctx=Load(), lineno=284, col_offset=33, end_lineno=284, end_col_offset=45), attr='IndexIDMap2', ctx=Load(), lineno=284, col_offset=33, end_lineno=284, end_col_offset=57)], lineno=284, col_offset=11, end_lineno=284, end_col_offset=58), lineno=284, col_offset=4, end_lineno=284, end_col_offset=58), Assign(targets=[Name(id='underlying', ctx=Store(), lineno=285, col_offset=4, end_lineno=285, end_col_offset=14)], value=Call(func=Name(id='_get_underlying_index', ctx=Load(), lineno=285, col_offset=17, end_lineno=285, end_col_offset=38), args=[Name(id='cpu_index', ctx=Load(), lineno=285, col_offset=39, end_lineno=285, end_col_offset=48)], lineno=285, col_offset=17, end_lineno=285, end_col_offset=49), lineno=285, col_offset=4, end_lineno=285, end_col_offset=49), Assign(targets=[Name(id='expected_nlist', ctx=Store(), lineno=288, col_offset=4, end_lineno=288, end_col_offset=18)], value=Call(func=Name(id='int', ctx=Load(), lineno=288, col_offset=21, end_lineno=288, end_col_offset=24), args=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=288, col_offset=25, end_lineno=288, end_col_offset=27), attr='sqrt', ctx=Load(), lineno=288, col_offset=25, end_lineno=288, end_col_offset=32), args=[Name(id='n_vectors', ctx=Load(), lineno=288, col_offset=33, end_lineno=288, end_col_offset=42)], lineno=288, col_offset=25, end_lineno=288, end_col_offset=43)], lineno=288, col_offset=21, end_lineno=288, end_col_offset=44), lineno=288, col_offset=4, end_lineno=288, end_col_offset=44), Assign(targets=[Name(id='expected_nlist', ctx=Store(), lineno=289, col_offset=4, end_lineno=289, end_col_offset=18)], value=Call(func=Name(id='max', ctx=Load(), lineno=289, col_offset=21, end_lineno=289, end_col_offset=24), args=[Name(id='expected_nlist', ctx=Load(), lineno=289, col_offset=25, end_lineno=289, end_col_offset=39), Constant(value=1024, lineno=289, col_offset=41, end_lineno=289, end_col_offset=45)], lineno=289, col_offset=21, end_lineno=289, end_col_offset=46), lineno=289, col_offset=4, end_lineno=289, end_col_offset=46), Assert(test=Compare(left=Attribute(value=Name(id='underlying', ctx=Load(), lineno=290, col_offset=11, end_lineno=290, end_col_offset=21), attr='nlist', ctx=Load(), lineno=290, col_offset=11, end_lineno=290, end_col_offset=27), ops=[Eq()], comparators=[Name(id='expected_nlist', ctx=Load(), lineno=290, col_offset=31, end_lineno=290, end_col_offset=45)], lineno=290, col_offset=11, end_lineno=290, end_col_offset=45), lineno=290, col_offset=4, end_lineno=290, end_col_offset=45)], decorator_list=[Attribute(value=Attribute(value=Name(id='pytest', ctx=Load(), lineno=257, col_offset=1, end_lineno=257, end_col_offset=7), attr='mark', ctx=Load(), lineno=257, col_offset=1, end_lineno=257, end_col_offset=12), attr='gpu', ctx=Load(), lineno=257, col_offset=1, end_lineno=257, end_col_offset=16)], returns=Constant(value=None, lineno=258, col_offset=60, end_lineno=258, end_col_offset=64), lineno=258, col_offset=0, end_lineno=290, end_col_offset=45), FunctionDef(name='test_memory_estimation_small_corpus', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=293, col_offset=56, end_lineno=293, end_col_offset=60), lineno=293, col_offset=40, end_lineno=293, end_col_offset=60)]), body=[Expr(value=Constant(value='Test memory estimation for small corpus (flat index).\n\n    Parameters\n    ----------\n    tmp_index_path : Path\n        Temporary index path.\n    ', lineno=294, col_offset=4, end_lineno=300, end_col_offset=7), lineno=294, col_offset=4, end_lineno=300, end_col_offset=7), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=301, col_offset=4, end_lineno=301, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=301, col_offset=14, end_lineno=301, end_col_offset=32), lineno=301, col_offset=4, end_lineno=301, end_col_offset=32), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=302, col_offset=4, end_lineno=302, end_col_offset=13)], value=Constant(value=100, lineno=302, col_offset=16, end_lineno=302, end_col_offset=19), lineno=302, col_offset=4, end_lineno=302, end_col_offset=19), Assign(targets=[Name(id='manager', ctx=Store(), lineno=303, col_offset=4, end_lineno=303, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=303, col_offset=14, end_lineno=303, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=303, col_offset=38, end_lineno=303, end_col_offset=52), lineno=303, col_offset=27, end_lineno=303, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=303, col_offset=62, end_lineno=303, end_col_offset=69), lineno=303, col_offset=54, end_lineno=303, end_col_offset=69)], lineno=303, col_offset=14, end_lineno=303, end_col_offset=70), lineno=303, col_offset=4, end_lineno=303, end_col_offset=70), Assign(targets=[Name(id='estimates', ctx=Store(), lineno=305, col_offset=4, end_lineno=305, end_col_offset=13)], value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=305, col_offset=16, end_lineno=305, end_col_offset=23), attr='estimate_memory_usage', ctx=Load(), lineno=305, col_offset=16, end_lineno=305, end_col_offset=45), args=[Name(id='n_vectors', ctx=Load(), lineno=305, col_offset=46, end_lineno=305, end_col_offset=55)], lineno=305, col_offset=16, end_lineno=305, end_col_offset=56), lineno=305, col_offset=4, end_lineno=305, end_col_offset=56), Assign(targets=[Name(id='expected_cpu', ctx=Store(), lineno=308, col_offset=4, end_lineno=308, end_col_offset=16)], value=BinOp(left=BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=308, col_offset=19, end_lineno=308, end_col_offset=28), op=Mult(), right=Name(id='vec_dim', ctx=Load(), lineno=308, col_offset=31, end_lineno=308, end_col_offset=38), lineno=308, col_offset=19, end_lineno=308, end_col_offset=38), op=Mult(), right=Constant(value=4, lineno=308, col_offset=41, end_lineno=308, end_col_offset=42), lineno=308, col_offset=19, end_lineno=308, end_col_offset=42), lineno=308, col_offset=4, end_lineno=308, end_col_offset=42), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=309, col_offset=11, end_lineno=309, end_col_offset=20), slice=Constant(value='cpu_index_bytes', lineno=309, col_offset=21, end_lineno=309, end_col_offset=38), ctx=Load(), lineno=309, col_offset=11, end_lineno=309, end_col_offset=39), ops=[Eq()], comparators=[Name(id='expected_cpu', ctx=Load(), lineno=309, col_offset=43, end_lineno=309, end_col_offset=55)], lineno=309, col_offset=11, end_lineno=309, end_col_offset=55), lineno=309, col_offset=4, end_lineno=309, end_col_offset=55), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=310, col_offset=11, end_lineno=310, end_col_offset=20), slice=Constant(value='gpu_index_bytes', lineno=310, col_offset=21, end_lineno=310, end_col_offset=38), ctx=Load(), lineno=310, col_offset=11, end_lineno=310, end_col_offset=39), ops=[Eq()], comparators=[Call(func=Name(id='int', ctx=Load(), lineno=310, col_offset=43, end_lineno=310, end_col_offset=46), args=[BinOp(left=Name(id='expected_cpu', ctx=Load(), lineno=310, col_offset=47, end_lineno=310, end_col_offset=59), op=Mult(), right=Constant(value=1.2, lineno=310, col_offset=62, end_lineno=310, end_col_offset=65), lineno=310, col_offset=47, end_lineno=310, end_col_offset=65)], lineno=310, col_offset=43, end_lineno=310, end_col_offset=66)], lineno=310, col_offset=11, end_lineno=310, end_col_offset=66), lineno=310, col_offset=4, end_lineno=310, end_col_offset=66), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=311, col_offset=11, end_lineno=311, end_col_offset=20), slice=Constant(value='total_bytes', lineno=311, col_offset=21, end_lineno=311, end_col_offset=34), ctx=Load(), lineno=311, col_offset=11, end_lineno=311, end_col_offset=35), ops=[Eq()], comparators=[BinOp(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=311, col_offset=39, end_lineno=311, end_col_offset=48), slice=Constant(value='cpu_index_bytes', lineno=311, col_offset=49, end_lineno=311, end_col_offset=66), ctx=Load(), lineno=311, col_offset=39, end_lineno=311, end_col_offset=67), op=Add(), right=Subscript(value=Name(id='estimates', ctx=Load(), lineno=311, col_offset=70, end_lineno=311, end_col_offset=79), slice=Constant(value='gpu_index_bytes', lineno=311, col_offset=80, end_lineno=311, end_col_offset=97), ctx=Load(), lineno=311, col_offset=70, end_lineno=311, end_col_offset=98), lineno=311, col_offset=39, end_lineno=311, end_col_offset=98)], lineno=311, col_offset=11, end_lineno=311, end_col_offset=98), lineno=311, col_offset=4, end_lineno=311, end_col_offset=98)], returns=Constant(value=None, lineno=293, col_offset=65, end_lineno=293, end_col_offset=69), lineno=293, col_offset=0, end_lineno=311, end_col_offset=98), FunctionDef(name='test_memory_estimation_medium_corpus', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=314, col_offset=57, end_lineno=314, end_col_offset=61), lineno=314, col_offset=41, end_lineno=314, end_col_offset=61)]), body=[Expr(value=Constant(value='Test memory estimation for medium corpus (IVFFlat).\n\n    Parameters\n    ----------\n    tmp_index_path : Path\n        Temporary index path.\n    ', lineno=315, col_offset=4, end_lineno=321, end_col_offset=7), lineno=315, col_offset=4, end_lineno=321, end_col_offset=7), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=322, col_offset=4, end_lineno=322, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=322, col_offset=14, end_lineno=322, end_col_offset=32), lineno=322, col_offset=4, end_lineno=322, end_col_offset=32), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=323, col_offset=4, end_lineno=323, end_col_offset=13)], value=Constant(value=5000, lineno=323, col_offset=16, end_lineno=323, end_col_offset=20), lineno=323, col_offset=4, end_lineno=323, end_col_offset=20), Assign(targets=[Name(id='manager', ctx=Store(), lineno=324, col_offset=4, end_lineno=324, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=324, col_offset=14, end_lineno=324, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=324, col_offset=38, end_lineno=324, end_col_offset=52), lineno=324, col_offset=27, end_lineno=324, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=324, col_offset=62, end_lineno=324, end_col_offset=69), lineno=324, col_offset=54, end_lineno=324, end_col_offset=69)], lineno=324, col_offset=14, end_lineno=324, end_col_offset=70), lineno=324, col_offset=4, end_lineno=324, end_col_offset=70), Assign(targets=[Name(id='estimates', ctx=Store(), lineno=326, col_offset=4, end_lineno=326, end_col_offset=13)], value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=326, col_offset=16, end_lineno=326, end_col_offset=23), attr='estimate_memory_usage', ctx=Load(), lineno=326, col_offset=16, end_lineno=326, end_col_offset=45), args=[Name(id='n_vectors', ctx=Load(), lineno=326, col_offset=46, end_lineno=326, end_col_offset=55)], lineno=326, col_offset=16, end_lineno=326, end_col_offset=56), lineno=326, col_offset=4, end_lineno=326, end_col_offset=56), Assign(targets=[Name(id='nlist', ctx=Store(), lineno=329, col_offset=4, end_lineno=329, end_col_offset=9)], value=Call(func=Name(id='min', ctx=Load(), lineno=329, col_offset=12, end_lineno=329, end_col_offset=15), args=[Call(func=Name(id='int', ctx=Load(), lineno=329, col_offset=16, end_lineno=329, end_col_offset=19), args=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=329, col_offset=20, end_lineno=329, end_col_offset=22), attr='sqrt', ctx=Load(), lineno=329, col_offset=20, end_lineno=329, end_col_offset=27), args=[Name(id='n_vectors', ctx=Load(), lineno=329, col_offset=28, end_lineno=329, end_col_offset=37)], lineno=329, col_offset=20, end_lineno=329, end_col_offset=38)], lineno=329, col_offset=16, end_lineno=329, end_col_offset=39), BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=329, col_offset=41, end_lineno=329, end_col_offset=50), op=FloorDiv(), right=Constant(value=39, lineno=329, col_offset=54, end_lineno=329, end_col_offset=56), lineno=329, col_offset=41, end_lineno=329, end_col_offset=56)], lineno=329, col_offset=12, end_lineno=329, end_col_offset=57), lineno=329, col_offset=4, end_lineno=329, end_col_offset=57), Assign(targets=[Name(id='nlist', ctx=Store(), lineno=330, col_offset=4, end_lineno=330, end_col_offset=9)], value=Call(func=Name(id='max', ctx=Load(), lineno=330, col_offset=12, end_lineno=330, end_col_offset=15), args=[Name(id='nlist', ctx=Load(), lineno=330, col_offset=16, end_lineno=330, end_col_offset=21), Constant(value=100, lineno=330, col_offset=23, end_lineno=330, end_col_offset=26)], lineno=330, col_offset=12, end_lineno=330, end_col_offset=27), lineno=330, col_offset=4, end_lineno=330, end_col_offset=27), Assign(targets=[Name(id='expected_cpu', ctx=Store(), lineno=331, col_offset=4, end_lineno=331, end_col_offset=16)], value=BinOp(left=BinOp(left=BinOp(left=Name(id='nlist', ctx=Load(), lineno=331, col_offset=20, end_lineno=331, end_col_offset=25), op=Mult(), right=Name(id='vec_dim', ctx=Load(), lineno=331, col_offset=28, end_lineno=331, end_col_offset=35), lineno=331, col_offset=20, end_lineno=331, end_col_offset=35), op=Mult(), right=Constant(value=4, lineno=331, col_offset=38, end_lineno=331, end_col_offset=39), lineno=331, col_offset=20, end_lineno=331, end_col_offset=39), op=Add(), right=BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=331, col_offset=44, end_lineno=331, end_col_offset=53), op=Mult(), right=Constant(value=8, lineno=331, col_offset=56, end_lineno=331, end_col_offset=57), lineno=331, col_offset=44, end_lineno=331, end_col_offset=57), lineno=331, col_offset=19, end_lineno=331, end_col_offset=58), lineno=331, col_offset=4, end_lineno=331, end_col_offset=58), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=332, col_offset=11, end_lineno=332, end_col_offset=20), slice=Constant(value='cpu_index_bytes', lineno=332, col_offset=21, end_lineno=332, end_col_offset=38), ctx=Load(), lineno=332, col_offset=11, end_lineno=332, end_col_offset=39), ops=[Eq()], comparators=[Name(id='expected_cpu', ctx=Load(), lineno=332, col_offset=43, end_lineno=332, end_col_offset=55)], lineno=332, col_offset=11, end_lineno=332, end_col_offset=55), lineno=332, col_offset=4, end_lineno=332, end_col_offset=55), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=333, col_offset=11, end_lineno=333, end_col_offset=20), slice=Constant(value='gpu_index_bytes', lineno=333, col_offset=21, end_lineno=333, end_col_offset=38), ctx=Load(), lineno=333, col_offset=11, end_lineno=333, end_col_offset=39), ops=[Eq()], comparators=[Call(func=Name(id='int', ctx=Load(), lineno=333, col_offset=43, end_lineno=333, end_col_offset=46), args=[BinOp(left=Name(id='expected_cpu', ctx=Load(), lineno=333, col_offset=47, end_lineno=333, end_col_offset=59), op=Mult(), right=Constant(value=1.2, lineno=333, col_offset=62, end_lineno=333, end_col_offset=65), lineno=333, col_offset=47, end_lineno=333, end_col_offset=65)], lineno=333, col_offset=43, end_lineno=333, end_col_offset=66)], lineno=333, col_offset=11, end_lineno=333, end_col_offset=66), lineno=333, col_offset=4, end_lineno=333, end_col_offset=66)], returns=Constant(value=None, lineno=314, col_offset=66, end_lineno=314, end_col_offset=70), lineno=314, col_offset=0, end_lineno=333, end_col_offset=66), FunctionDef(name='test_memory_estimation_large_corpus', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=336, col_offset=56, end_lineno=336, end_col_offset=60), lineno=336, col_offset=40, end_lineno=336, end_col_offset=60)]), body=[Expr(value=Constant(value="Test memory estimation for large corpus (IVF-PQ).\n\n    This test only estimates memory (doesn't build index), so it's fast.\n\n    Parameters\n    ----------\n    tmp_index_path : Path\n        Temporary index path.\n    ", lineno=337, col_offset=4, end_lineno=345, end_col_offset=7), lineno=337, col_offset=4, end_lineno=345, end_col_offset=7), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=346, col_offset=4, end_lineno=346, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=346, col_offset=14, end_lineno=346, end_col_offset=32), lineno=346, col_offset=4, end_lineno=346, end_col_offset=32), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=347, col_offset=4, end_lineno=347, end_col_offset=13)], value=Constant(value=50000, lineno=347, col_offset=16, end_lineno=347, end_col_offset=21), lineno=347, col_offset=4, end_lineno=347, end_col_offset=21), Assign(targets=[Name(id='manager', ctx=Store(), lineno=348, col_offset=4, end_lineno=348, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=348, col_offset=14, end_lineno=348, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=348, col_offset=38, end_lineno=348, end_col_offset=52), lineno=348, col_offset=27, end_lineno=348, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=348, col_offset=62, end_lineno=348, end_col_offset=69), lineno=348, col_offset=54, end_lineno=348, end_col_offset=69)], lineno=348, col_offset=14, end_lineno=348, end_col_offset=70), lineno=348, col_offset=4, end_lineno=348, end_col_offset=70), Assign(targets=[Name(id='estimates', ctx=Store(), lineno=350, col_offset=4, end_lineno=350, end_col_offset=13)], value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=350, col_offset=16, end_lineno=350, end_col_offset=23), attr='estimate_memory_usage', ctx=Load(), lineno=350, col_offset=16, end_lineno=350, end_col_offset=45), args=[Name(id='n_vectors', ctx=Load(), lineno=350, col_offset=46, end_lineno=350, end_col_offset=55)], lineno=350, col_offset=16, end_lineno=350, end_col_offset=56), lineno=350, col_offset=4, end_lineno=350, end_col_offset=56), Assign(targets=[Name(id='nlist', ctx=Store(), lineno=353, col_offset=4, end_lineno=353, end_col_offset=9)], value=Call(func=Name(id='int', ctx=Load(), lineno=353, col_offset=12, end_lineno=353, end_col_offset=15), args=[Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=353, col_offset=16, end_lineno=353, end_col_offset=18), attr='sqrt', ctx=Load(), lineno=353, col_offset=16, end_lineno=353, end_col_offset=23), args=[Name(id='n_vectors', ctx=Load(), lineno=353, col_offset=24, end_lineno=353, end_col_offset=33)], lineno=353, col_offset=16, end_lineno=353, end_col_offset=34)], lineno=353, col_offset=12, end_lineno=353, end_col_offset=35), lineno=353, col_offset=4, end_lineno=353, end_col_offset=35), Assign(targets=[Name(id='nlist', ctx=Store(), lineno=354, col_offset=4, end_lineno=354, end_col_offset=9)], value=Call(func=Name(id='max', ctx=Load(), lineno=354, col_offset=12, end_lineno=354, end_col_offset=15), args=[Name(id='nlist', ctx=Load(), lineno=354, col_offset=16, end_lineno=354, end_col_offset=21), Constant(value=1024, lineno=354, col_offset=23, end_lineno=354, end_col_offset=27)], lineno=354, col_offset=12, end_lineno=354, end_col_offset=28), lineno=354, col_offset=4, end_lineno=354, end_col_offset=28), Assign(targets=[Name(id='expected_cpu', ctx=Store(), lineno=355, col_offset=4, end_lineno=355, end_col_offset=16)], value=BinOp(left=BinOp(left=BinOp(left=Name(id='nlist', ctx=Load(), lineno=355, col_offset=20, end_lineno=355, end_col_offset=25), op=Mult(), right=Name(id='vec_dim', ctx=Load(), lineno=355, col_offset=28, end_lineno=355, end_col_offset=35), lineno=355, col_offset=20, end_lineno=355, end_col_offset=35), op=Mult(), right=Constant(value=4, lineno=355, col_offset=38, end_lineno=355, end_col_offset=39), lineno=355, col_offset=20, end_lineno=355, end_col_offset=39), op=Add(), right=BinOp(left=Name(id='n_vectors', ctx=Load(), lineno=355, col_offset=44, end_lineno=355, end_col_offset=53), op=Mult(), right=Constant(value=64, lineno=355, col_offset=56, end_lineno=355, end_col_offset=58), lineno=355, col_offset=44, end_lineno=355, end_col_offset=58), lineno=355, col_offset=19, end_lineno=355, end_col_offset=59), lineno=355, col_offset=4, end_lineno=355, end_col_offset=59), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=356, col_offset=11, end_lineno=356, end_col_offset=20), slice=Constant(value='cpu_index_bytes', lineno=356, col_offset=21, end_lineno=356, end_col_offset=38), ctx=Load(), lineno=356, col_offset=11, end_lineno=356, end_col_offset=39), ops=[Eq()], comparators=[Name(id='expected_cpu', ctx=Load(), lineno=356, col_offset=43, end_lineno=356, end_col_offset=55)], lineno=356, col_offset=11, end_lineno=356, end_col_offset=55), lineno=356, col_offset=4, end_lineno=356, end_col_offset=55), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=357, col_offset=11, end_lineno=357, end_col_offset=20), slice=Constant(value='gpu_index_bytes', lineno=357, col_offset=21, end_lineno=357, end_col_offset=38), ctx=Load(), lineno=357, col_offset=11, end_lineno=357, end_col_offset=39), ops=[Eq()], comparators=[Call(func=Name(id='int', ctx=Load(), lineno=357, col_offset=43, end_lineno=357, end_col_offset=46), args=[BinOp(left=Name(id='expected_cpu', ctx=Load(), lineno=357, col_offset=47, end_lineno=357, end_col_offset=59), op=Mult(), right=Constant(value=1.2, lineno=357, col_offset=62, end_lineno=357, end_col_offset=65), lineno=357, col_offset=47, end_lineno=357, end_col_offset=65)], lineno=357, col_offset=43, end_lineno=357, end_col_offset=66)], lineno=357, col_offset=11, end_lineno=357, end_col_offset=66), lineno=357, col_offset=4, end_lineno=357, end_col_offset=66)], returns=Constant(value=None, lineno=336, col_offset=65, end_lineno=336, end_col_offset=69), lineno=336, col_offset=0, end_lineno=357, end_col_offset=66), FunctionDef(name='test_memory_estimation_accuracy', args=arguments(args=[arg(arg='tmp_index_path', annotation=Name(id='Path', ctx=Load(), lineno=360, col_offset=52, end_lineno=360, end_col_offset=56), lineno=360, col_offset=36, end_lineno=360, end_col_offset=56)]), body=[Expr(value=Constant(value='Test that memory estimates are reasonable (within 20% of actual).\n\n    This test builds an actual index and compares estimated vs actual memory\n    usage. Estimates should be within 20% of actual usage.\n\n    Uses a small corpus size (100 vectors) with reduced dimensions for fast\n    test execution while still verifying accuracy.\n\n    Parameters\n    ----------\n    tmp_index_path : Path\n        Temporary index path.\n    ', lineno=361, col_offset=4, end_lineno=373, end_col_offset=7), lineno=361, col_offset=4, end_lineno=373, end_col_offset=7), Assign(targets=[Name(id='vec_dim', ctx=Store(), lineno=374, col_offset=4, end_lineno=374, end_col_offset=11)], value=Name(id='_UNIT_TEST_VEC_DIM', ctx=Load(), lineno=374, col_offset=14, end_lineno=374, end_col_offset=32), lineno=374, col_offset=4, end_lineno=374, end_col_offset=32), Assign(targets=[Name(id='n_vectors', ctx=Store(), lineno=375, col_offset=4, end_lineno=375, end_col_offset=13)], value=Constant(value=100, lineno=375, col_offset=16, end_lineno=375, end_col_offset=19), lineno=375, col_offset=4, end_lineno=375, end_col_offset=19), Assign(targets=[Name(id='manager', ctx=Store(), lineno=376, col_offset=4, end_lineno=376, end_col_offset=11)], value=Call(func=Name(id='FAISSManager', ctx=Load(), lineno=376, col_offset=14, end_lineno=376, end_col_offset=26), keywords=[keyword(arg='index_path', value=Name(id='tmp_index_path', ctx=Load(), lineno=376, col_offset=38, end_lineno=376, end_col_offset=52), lineno=376, col_offset=27, end_lineno=376, end_col_offset=52), keyword(arg='vec_dim', value=Name(id='vec_dim', ctx=Load(), lineno=376, col_offset=62, end_lineno=376, end_col_offset=69), lineno=376, col_offset=54, end_lineno=376, end_col_offset=69)], lineno=376, col_offset=14, end_lineno=376, end_col_offset=70), lineno=376, col_offset=4, end_lineno=376, end_col_offset=70), Assign(targets=[Name(id='estimates', ctx=Store(), lineno=379, col_offset=4, end_lineno=379, end_col_offset=13)], value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=379, col_offset=16, end_lineno=379, end_col_offset=23), attr='estimate_memory_usage', ctx=Load(), lineno=379, col_offset=16, end_lineno=379, end_col_offset=45), args=[Name(id='n_vectors', ctx=Load(), lineno=379, col_offset=46, end_lineno=379, end_col_offset=55)], lineno=379, col_offset=16, end_lineno=379, end_col_offset=56), lineno=379, col_offset=4, end_lineno=379, end_col_offset=56), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=385, col_offset=4, end_lineno=385, end_col_offset=11)], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='_rng', ctx=Load(), lineno=385, col_offset=14, end_lineno=385, end_col_offset=18), attr='normal', ctx=Load(), lineno=385, col_offset=14, end_lineno=385, end_col_offset=25), args=[Constant(value=0.5, lineno=385, col_offset=26, end_lineno=385, end_col_offset=29), Constant(value=0.15, lineno=385, col_offset=31, end_lineno=385, end_col_offset=35), Tuple(elts=[Name(id='n_vectors', ctx=Load(), lineno=385, col_offset=38, end_lineno=385, end_col_offset=47), Name(id='vec_dim', ctx=Load(), lineno=385, col_offset=49, end_lineno=385, end_col_offset=56)], ctx=Load(), lineno=385, col_offset=37, end_lineno=385, end_col_offset=57)], lineno=385, col_offset=14, end_lineno=385, end_col_offset=58), attr='astype', ctx=Load(), lineno=385, col_offset=14, end_lineno=385, end_col_offset=65), args=[Attribute(value=Name(id='np', ctx=Load(), lineno=385, col_offset=66, end_lineno=385, end_col_offset=68), attr='float32', ctx=Load(), lineno=385, col_offset=66, end_lineno=385, end_col_offset=76)], lineno=385, col_offset=14, end_lineno=385, end_col_offset=77), lineno=385, col_offset=4, end_lineno=385, end_col_offset=77), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=386, col_offset=4, end_lineno=386, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='np', ctx=Load(), lineno=386, col_offset=14, end_lineno=386, end_col_offset=16), attr='clip', ctx=Load(), lineno=386, col_offset=14, end_lineno=386, end_col_offset=21), args=[Name(id='vectors', ctx=Load(), lineno=386, col_offset=22, end_lineno=386, end_col_offset=29), Constant(value=0.0, lineno=386, col_offset=31, end_lineno=386, end_col_offset=34), Constant(value=1.0, lineno=386, col_offset=36, end_lineno=386, end_col_offset=39)], lineno=386, col_offset=14, end_lineno=386, end_col_offset=40), lineno=386, col_offset=4, end_lineno=386, end_col_offset=40), Expr(value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=387, col_offset=4, end_lineno=387, end_col_offset=11), attr='build_index', ctx=Load(), lineno=387, col_offset=4, end_lineno=387, end_col_offset=23), args=[Name(id='vectors', ctx=Load(), lineno=387, col_offset=24, end_lineno=387, end_col_offset=31)], lineno=387, col_offset=4, end_lineno=387, end_col_offset=32), lineno=387, col_offset=4, end_lineno=387, end_col_offset=32), Expr(value=Call(func=Attribute(value=Name(id='manager', ctx=Load(), lineno=390, col_offset=4, end_lineno=390, end_col_offset=11), attr='save_cpu_index', ctx=Load(), lineno=390, col_offset=4, end_lineno=390, end_col_offset=26), lineno=390, col_offset=4, end_lineno=390, end_col_offset=28), lineno=390, col_offset=4, end_lineno=390, end_col_offset=28), Assign(targets=[Name(id='actual_size', ctx=Store(), lineno=391, col_offset=4, end_lineno=391, end_col_offset=15)], value=Attribute(value=Call(func=Attribute(value=Name(id='tmp_index_path', ctx=Load(), lineno=391, col_offset=18, end_lineno=391, end_col_offset=32), attr='stat', ctx=Load(), lineno=391, col_offset=18, end_lineno=391, end_col_offset=37), lineno=391, col_offset=18, end_lineno=391, end_col_offset=39), attr='st_size', ctx=Load(), lineno=391, col_offset=18, end_lineno=391, end_col_offset=47), lineno=391, col_offset=4, end_lineno=391, end_col_offset=47), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=396, col_offset=11, end_lineno=396, end_col_offset=20), slice=Constant(value='cpu_index_bytes', lineno=396, col_offset=21, end_lineno=396, end_col_offset=38), ctx=Load(), lineno=396, col_offset=11, end_lineno=396, end_col_offset=39), ops=[Gt()], comparators=[Constant(value=0, lineno=396, col_offset=42, end_lineno=396, end_col_offset=43)], lineno=396, col_offset=11, end_lineno=396, end_col_offset=43), lineno=396, col_offset=4, end_lineno=396, end_col_offset=43), Assert(test=Compare(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=397, col_offset=11, end_lineno=397, end_col_offset=20), slice=Constant(value='total_bytes', lineno=397, col_offset=21, end_lineno=397, end_col_offset=34), ctx=Load(), lineno=397, col_offset=11, end_lineno=397, end_col_offset=35), ops=[Gt()], comparators=[Constant(value=0, lineno=397, col_offset=38, end_lineno=397, end_col_offset=39)], lineno=397, col_offset=11, end_lineno=397, end_col_offset=39), lineno=397, col_offset=4, end_lineno=397, end_col_offset=39), Assert(test=Compare(left=Name(id='actual_size', ctx=Load(), lineno=399, col_offset=11, end_lineno=399, end_col_offset=22), ops=[GtE()], comparators=[BinOp(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=399, col_offset=26, end_lineno=399, end_col_offset=35), slice=Constant(value='cpu_index_bytes', lineno=399, col_offset=36, end_lineno=399, end_col_offset=53), ctx=Load(), lineno=399, col_offset=26, end_lineno=399, end_col_offset=54), op=Mult(), right=Constant(value=0.5, lineno=399, col_offset=57, end_lineno=399, end_col_offset=60), lineno=399, col_offset=26, end_lineno=399, end_col_offset=60)], lineno=399, col_offset=11, end_lineno=399, end_col_offset=60), lineno=399, col_offset=4, end_lineno=399, end_col_offset=60), Assert(test=Compare(left=Name(id='actual_size', ctx=Load(), lineno=400, col_offset=11, end_lineno=400, end_col_offset=22), ops=[LtE()], comparators=[BinOp(left=Subscript(value=Name(id='estimates', ctx=Load(), lineno=400, col_offset=26, end_lineno=400, end_col_offset=35), slice=Constant(value='cpu_index_bytes', lineno=400, col_offset=36, end_lineno=400, end_col_offset=53), ctx=Load(), lineno=400, col_offset=26, end_lineno=400, end_col_offset=54), op=Mult(), right=Constant(value=2.0, lineno=400, col_offset=57, end_lineno=400, end_col_offset=60), lineno=400, col_offset=26, end_lineno=400, end_col_offset=60)], lineno=400, col_offset=11, end_lineno=400, end_col_offset=60), lineno=400, col_offset=4, end_lineno=400, end_col_offset=60)], returns=Constant(value=None, lineno=360, col_offset=61, end_lineno=360, end_col_offset=65), lineno=360, col_offset=0, end_lineno=400, end_col_offset=60)])