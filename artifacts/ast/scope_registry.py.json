Module(body=[Expr(value=Constant(value='Session-scoped scope registry for CodeIntel MCP.\n\nThis module provides thread-safe in-memory storage for per-session query scopes.\nInstead of passing scope parameters with every query, clients call `set_scope` once\nand subsequent queries within the same session automatically apply those constraints.\n\nKey Components\n--------------\nScopeRegistry : class\n    Thread-safe registry mapping session IDs to ScopeIn dictionaries.\n\nDesign Principles\n-----------------\n- **Thread Safety**: Uses threading.RLock for concurrent access protection\n- **LRU Behavior**: Updates timestamps on access for activity-based expiration\n- **Immutable Results**: Returns copies of stored scopes to prevent mutation\n- **Fail-Safe**: Missing sessions return None rather than raising exceptions\n\nExample Usage\n-------------\nInitialize registry in application startup:\n\n>>> registry = ScopeRegistry()\n>>> app_context.scope_registry = registry\n\nStore scope for a session:\n\n>>> session_id = "abc123..."\n>>> scope = {"languages": ["python"], "include_globs": ["src/**"]}\n>>> registry.set_scope(session_id, scope)\n\nRetrieve scope in adapter:\n\n>>> scope = registry.get_scope(session_id)\n>>> if scope:\n...     # Apply scope filters\n...     include_globs = scope.get("include_globs")\n\nPrune expired sessions (background task):\n\n>>> pruned = registry.prune_expired(max_age_seconds=3600)\n>>> logger.info(f"Pruned {pruned} expired sessions")\n\nSee Also\n--------\ncodeintel_rev.app.middleware : Session ID extraction and ContextVar management\ncodeintel_rev.mcp_server.scope_utils : Scope merging and filtering utilities\n', lineno=1, col_offset=0, end_lineno=48, end_col_offset=3), lineno=1, col_offset=0, end_lineno=48, end_col_offset=3), ImportFrom(module='__future__', names=[alias(name='annotations', lineno=50, col_offset=23, end_lineno=50, end_col_offset=34)], level=0, lineno=50, col_offset=0, end_lineno=50, end_col_offset=34), Import(names=[alias(name='time', lineno=52, col_offset=7, end_lineno=52, end_col_offset=11)], lineno=52, col_offset=0, end_lineno=52, end_col_offset=11), ImportFrom(module='threading', names=[alias(name='RLock', lineno=53, col_offset=22, end_lineno=53, end_col_offset=27)], level=0, lineno=53, col_offset=0, end_lineno=53, end_col_offset=27), ImportFrom(module='typing', names=[alias(name='TYPE_CHECKING', lineno=54, col_offset=19, end_lineno=54, end_col_offset=32)], level=0, lineno=54, col_offset=0, end_lineno=54, end_col_offset=32), ImportFrom(module='kgfoundry_common.logging', names=[alias(name='get_logger', lineno=56, col_offset=37, end_lineno=56, end_col_offset=47)], level=0, lineno=56, col_offset=0, end_lineno=56, end_col_offset=47), If(test=Name(id='TYPE_CHECKING', ctx=Load(), lineno=58, col_offset=3, end_lineno=58, end_col_offset=16), body=[ImportFrom(module='codeintel_rev.mcp_server.schemas', names=[alias(name='ScopeIn', lineno=59, col_offset=49, end_lineno=59, end_col_offset=56)], level=0, lineno=59, col_offset=4, end_lineno=59, end_col_offset=56)], lineno=58, col_offset=0, end_lineno=59, end_col_offset=56), Assign(targets=[Name(id='LOGGER', ctx=Store(), lineno=61, col_offset=0, end_lineno=61, end_col_offset=6)], value=Call(func=Name(id='get_logger', ctx=Load(), lineno=61, col_offset=9, end_lineno=61, end_col_offset=19), args=[Name(id='__name__', ctx=Load(), lineno=61, col_offset=20, end_lineno=61, end_col_offset=28)], lineno=61, col_offset=9, end_lineno=61, end_col_offset=29), lineno=61, col_offset=0, end_lineno=61, end_col_offset=29), ClassDef(name='ScopeRegistry', body=[Expr(value=Constant(value='Thread-safe registry for session-scoped query scopes.\n\n    Maintains an in-memory mapping of session IDs to ScopeIn dictionaries with\n    last-accessed timestamps for LRU expiration. Designed for concurrent access\n    from FastAPI request handlers running in a threadpool.\n\n    Notes\n    -----\n    Internal State:\n    The registry maintains private state:\n    - ``_scopes``: dict mapping session_id to (scope, last_accessed_timestamp)\n    - ``_lock``: RLock protecting concurrent access to _scopes dict\n\n    The registry is NOT persistent—server restart clears all sessions. For\n    persistent scope storage, consider Redis or database backing (Phase 3+).\n\n    Performance characteristics:\n    - set_scope: O(1) with lock acquisition overhead (~1μs)\n    - get_scope: O(1) with lock acquisition + dict copy (~2μs)\n    - prune_expired: O(n) where n = active session count\n\n    Thread safety:\n    - All public methods acquire _lock before dict access.\n    - RLock prevents deadlocks when methods call each other.\n    - ContextVar in middleware ensures session ID isolation across threads.\n\n    Examples\n    --------\n    Create registry and store scope:\n\n    >>> registry = ScopeRegistry()\n    >>> session_id = "test-session-123"\n    >>> scope = {"languages": ["python"], "include_globs": ["**/*.py"]}\n    >>> registry.set_scope(session_id, scope)\n    >>> retrieved = registry.get_scope(session_id)\n    >>> retrieved == scope\n    True\n\n    Scope expiration:\n\n    >>> import time\n    >>> registry.set_scope("old-session", {"languages": ["python"]})\n    >>> time.sleep(2)\n    >>> pruned = registry.prune_expired(max_age_seconds=1)\n    >>> pruned\n    1\n    >>> registry.get_scope("old-session") is None\n    True\n    ', lineno=65, col_offset=4, end_lineno=113, end_col_offset=7), lineno=65, col_offset=4, end_lineno=113, end_col_offset=7), FunctionDef(name='__init__', args=arguments(args=[arg(arg='self', lineno=115, col_offset=17, end_lineno=115, end_col_offset=21)]), body=[AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=116, col_offset=8, end_lineno=116, end_col_offset=12), attr='_scopes', ctx=Store(), lineno=116, col_offset=8, end_lineno=116, end_col_offset=20), annotation=Subscript(value=Name(id='dict', ctx=Load(), lineno=116, col_offset=22, end_lineno=116, end_col_offset=26), slice=Tuple(elts=[Name(id='str', ctx=Load(), lineno=116, col_offset=27, end_lineno=116, end_col_offset=30), Subscript(value=Name(id='tuple', ctx=Load(), lineno=116, col_offset=32, end_lineno=116, end_col_offset=37), slice=Tuple(elts=[Name(id='ScopeIn', ctx=Load(), lineno=116, col_offset=38, end_lineno=116, end_col_offset=45), Name(id='float', ctx=Load(), lineno=116, col_offset=47, end_lineno=116, end_col_offset=52)], ctx=Load(), lineno=116, col_offset=38, end_lineno=116, end_col_offset=52), ctx=Load(), lineno=116, col_offset=32, end_lineno=116, end_col_offset=53)], ctx=Load(), lineno=116, col_offset=27, end_lineno=116, end_col_offset=53), ctx=Load(), lineno=116, col_offset=22, end_lineno=116, end_col_offset=54), value=Dict(lineno=116, col_offset=57, end_lineno=116, end_col_offset=59), simple=0, lineno=116, col_offset=8, end_lineno=116, end_col_offset=59), Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=117, col_offset=8, end_lineno=117, end_col_offset=12), attr='_lock', ctx=Store(), lineno=117, col_offset=8, end_lineno=117, end_col_offset=18)], value=Call(func=Name(id='RLock', ctx=Load(), lineno=117, col_offset=21, end_lineno=117, end_col_offset=26), lineno=117, col_offset=21, end_lineno=117, end_col_offset=28), lineno=117, col_offset=8, end_lineno=117, end_col_offset=28), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=118, col_offset=8, end_lineno=118, end_col_offset=14), attr='debug', ctx=Load(), lineno=118, col_offset=8, end_lineno=118, end_col_offset=20), args=[Constant(value='Initialized ScopeRegistry', lineno=118, col_offset=21, end_lineno=118, end_col_offset=48)], lineno=118, col_offset=8, end_lineno=118, end_col_offset=49), lineno=118, col_offset=8, end_lineno=118, end_col_offset=49)], returns=Constant(value=None, lineno=115, col_offset=26, end_lineno=115, end_col_offset=30), lineno=115, col_offset=4, end_lineno=118, end_col_offset=49), FunctionDef(name='set_scope', args=arguments(args=[arg(arg='self', lineno=120, col_offset=18, end_lineno=120, end_col_offset=22), arg(arg='session_id', annotation=Name(id='str', ctx=Load(), lineno=120, col_offset=36, end_lineno=120, end_col_offset=39), lineno=120, col_offset=24, end_lineno=120, end_col_offset=39), arg(arg='scope', annotation=Name(id='ScopeIn', ctx=Load(), lineno=120, col_offset=48, end_lineno=120, end_col_offset=55), lineno=120, col_offset=41, end_lineno=120, end_col_offset=55)]), body=[Expr(value=Constant(value='Store scope for session.\n\n        Creates or updates session entry with current timestamp. If session\n        already exists, overwrites previous scope (last-write-wins semantics).\n\n        Parameters\n        ----------\n        session_id : str\n            Unique session identifier (typically UUID from middleware).\n        scope : ScopeIn\n            Scope configuration to store. May contain repos, branches, globs,\n            languages. Empty dict is valid (means "no filters").\n\n        Examples\n        --------\n        >>> registry = ScopeRegistry()\n        >>> registry.set_scope("session1", {"languages": ["python"]})\n        >>> registry.set_scope("session2", {"include_globs": ["src/**"]})\n\n        Notes\n        -----\n        The method stores a reference to the scope dict. Callers should not\n        mutate the scope after passing it to set_scope. For safety, consider\n        passing a copy: `registry.set_scope(session_id, dict(scope))`.\n        ', lineno=121, col_offset=8, end_lineno=145, end_col_offset=11), lineno=121, col_offset=8, end_lineno=145, end_col_offset=11), Assign(targets=[Name(id='timestamp', ctx=Store(), lineno=146, col_offset=8, end_lineno=146, end_col_offset=17)], value=Call(func=Attribute(value=Name(id='time', ctx=Load(), lineno=146, col_offset=20, end_lineno=146, end_col_offset=24), attr='monotonic', ctx=Load(), lineno=146, col_offset=20, end_lineno=146, end_col_offset=34), lineno=146, col_offset=20, end_lineno=146, end_col_offset=36), lineno=146, col_offset=8, end_lineno=146, end_col_offset=36), With(items=[withitem(context_expr=Attribute(value=Name(id='self', ctx=Load(), lineno=147, col_offset=13, end_lineno=147, end_col_offset=17), attr='_lock', ctx=Load(), lineno=147, col_offset=13, end_lineno=147, end_col_offset=23))], body=[Assign(targets=[Subscript(value=Attribute(value=Name(id='self', ctx=Load(), lineno=148, col_offset=12, end_lineno=148, end_col_offset=16), attr='_scopes', ctx=Load(), lineno=148, col_offset=12, end_lineno=148, end_col_offset=24), slice=Name(id='session_id', ctx=Load(), lineno=148, col_offset=25, end_lineno=148, end_col_offset=35), ctx=Store(), lineno=148, col_offset=12, end_lineno=148, end_col_offset=36)], value=Tuple(elts=[Name(id='scope', ctx=Load(), lineno=148, col_offset=40, end_lineno=148, end_col_offset=45), Name(id='timestamp', ctx=Load(), lineno=148, col_offset=47, end_lineno=148, end_col_offset=56)], ctx=Load(), lineno=148, col_offset=39, end_lineno=148, end_col_offset=57), lineno=148, col_offset=12, end_lineno=148, end_col_offset=57)], lineno=147, col_offset=8, end_lineno=148, end_col_offset=57), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=150, col_offset=8, end_lineno=150, end_col_offset=14), attr='info', ctx=Load(), lineno=150, col_offset=8, end_lineno=150, end_col_offset=19), args=[Constant(value='Set scope for session', lineno=151, col_offset=12, end_lineno=151, end_col_offset=35)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='session_id', lineno=153, col_offset=16, end_lineno=153, end_col_offset=28), Constant(value='scope_fields', lineno=154, col_offset=16, end_lineno=154, end_col_offset=30), Constant(value='timestamp', lineno=155, col_offset=16, end_lineno=155, end_col_offset=27)], values=[Name(id='session_id', ctx=Load(), lineno=153, col_offset=30, end_lineno=153, end_col_offset=40), Call(func=Name(id='list', ctx=Load(), lineno=154, col_offset=32, end_lineno=154, end_col_offset=36), args=[Call(func=Attribute(value=Name(id='scope', ctx=Load(), lineno=154, col_offset=37, end_lineno=154, end_col_offset=42), attr='keys', ctx=Load(), lineno=154, col_offset=37, end_lineno=154, end_col_offset=47), lineno=154, col_offset=37, end_lineno=154, end_col_offset=49)], lineno=154, col_offset=32, end_lineno=154, end_col_offset=50), Name(id='timestamp', ctx=Load(), lineno=155, col_offset=29, end_lineno=155, end_col_offset=38)], lineno=152, col_offset=18, end_lineno=156, end_col_offset=13), lineno=152, col_offset=12, end_lineno=156, end_col_offset=13)], lineno=150, col_offset=8, end_lineno=157, end_col_offset=9), lineno=150, col_offset=8, end_lineno=157, end_col_offset=9)], returns=Constant(value=None, lineno=120, col_offset=60, end_lineno=120, end_col_offset=64), lineno=120, col_offset=4, end_lineno=157, end_col_offset=9), FunctionDef(name='get_scope', args=arguments(args=[arg(arg='self', lineno=159, col_offset=18, end_lineno=159, end_col_offset=22), arg(arg='session_id', annotation=Name(id='str', ctx=Load(), lineno=159, col_offset=36, end_lineno=159, end_col_offset=39), lineno=159, col_offset=24, end_lineno=159, end_col_offset=39)]), body=[Expr(value=Constant(value='Retrieve scope for session.\n\n        Returns a copy of the stored scope to prevent caller mutations from\n        affecting registry state. Updates last-accessed timestamp for LRU\n        tracking (accessed sessions are less likely to be pruned).\n\n        Parameters\n        ----------\n        session_id : str\n            Session identifier to look up.\n\n        Returns\n        -------\n        ScopeIn | None\n            Copy of stored scope if session exists, None otherwise.\n\n        Examples\n        --------\n        >>> registry = ScopeRegistry()\n        >>> registry.set_scope("session1", {"languages": ["python"]})\n        >>> scope = registry.get_scope("session1")\n        >>> scope\n        {\'languages\': [\'python\']}\n        >>> registry.get_scope("nonexistent") is None\n        True\n\n        Notes\n        -----\n        Returning None for missing sessions allows adapters to gracefully\n        fall back to "no scope" behavior without catching exceptions.\n        ', lineno=160, col_offset=8, end_lineno=190, end_col_offset=11), lineno=160, col_offset=8, end_lineno=190, end_col_offset=11), Assign(targets=[Name(id='timestamp', ctx=Store(), lineno=191, col_offset=8, end_lineno=191, end_col_offset=17)], value=Call(func=Attribute(value=Name(id='time', ctx=Load(), lineno=191, col_offset=20, end_lineno=191, end_col_offset=24), attr='monotonic', ctx=Load(), lineno=191, col_offset=20, end_lineno=191, end_col_offset=34), lineno=191, col_offset=20, end_lineno=191, end_col_offset=36), lineno=191, col_offset=8, end_lineno=191, end_col_offset=36), With(items=[withitem(context_expr=Attribute(value=Name(id='self', ctx=Load(), lineno=192, col_offset=13, end_lineno=192, end_col_offset=17), attr='_lock', ctx=Load(), lineno=192, col_offset=13, end_lineno=192, end_col_offset=23))], body=[Assign(targets=[Name(id='entry', ctx=Store(), lineno=193, col_offset=12, end_lineno=193, end_col_offset=17)], value=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=193, col_offset=20, end_lineno=193, end_col_offset=24), attr='_scopes', ctx=Load(), lineno=193, col_offset=20, end_lineno=193, end_col_offset=32), attr='get', ctx=Load(), lineno=193, col_offset=20, end_lineno=193, end_col_offset=36), args=[Name(id='session_id', ctx=Load(), lineno=193, col_offset=37, end_lineno=193, end_col_offset=47)], lineno=193, col_offset=20, end_lineno=193, end_col_offset=48), lineno=193, col_offset=12, end_lineno=193, end_col_offset=48), If(test=Compare(left=Name(id='entry', ctx=Load(), lineno=194, col_offset=15, end_lineno=194, end_col_offset=20), ops=[Is()], comparators=[Constant(value=None, lineno=194, col_offset=24, end_lineno=194, end_col_offset=28)], lineno=194, col_offset=15, end_lineno=194, end_col_offset=28), body=[Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=195, col_offset=16, end_lineno=195, end_col_offset=22), attr='debug', ctx=Load(), lineno=195, col_offset=16, end_lineno=195, end_col_offset=28), args=[Constant(value='Scope not found for session', lineno=195, col_offset=29, end_lineno=195, end_col_offset=58)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='session_id', lineno=195, col_offset=67, end_lineno=195, end_col_offset=79)], values=[Name(id='session_id', ctx=Load(), lineno=195, col_offset=81, end_lineno=195, end_col_offset=91)], lineno=195, col_offset=66, end_lineno=195, end_col_offset=92), lineno=195, col_offset=60, end_lineno=195, end_col_offset=92)], lineno=195, col_offset=16, end_lineno=195, end_col_offset=93), lineno=195, col_offset=16, end_lineno=195, end_col_offset=93), Return(value=Constant(value=None, lineno=196, col_offset=23, end_lineno=196, end_col_offset=27), lineno=196, col_offset=16, end_lineno=196, end_col_offset=27)], lineno=194, col_offset=12, end_lineno=196, end_col_offset=27), Assign(targets=[Tuple(elts=[Name(id='scope', ctx=Store(), lineno=198, col_offset=12, end_lineno=198, end_col_offset=17), Name(id='_old_timestamp', ctx=Store(), lineno=198, col_offset=19, end_lineno=198, end_col_offset=33)], ctx=Store(), lineno=198, col_offset=12, end_lineno=198, end_col_offset=33)], value=Name(id='entry', ctx=Load(), lineno=198, col_offset=36, end_lineno=198, end_col_offset=41), lineno=198, col_offset=12, end_lineno=198, end_col_offset=41), Assign(targets=[Subscript(value=Attribute(value=Name(id='self', ctx=Load(), lineno=200, col_offset=12, end_lineno=200, end_col_offset=16), attr='_scopes', ctx=Load(), lineno=200, col_offset=12, end_lineno=200, end_col_offset=24), slice=Name(id='session_id', ctx=Load(), lineno=200, col_offset=25, end_lineno=200, end_col_offset=35), ctx=Store(), lineno=200, col_offset=12, end_lineno=200, end_col_offset=36)], value=Tuple(elts=[Name(id='scope', ctx=Load(), lineno=200, col_offset=40, end_lineno=200, end_col_offset=45), Name(id='timestamp', ctx=Load(), lineno=200, col_offset=47, end_lineno=200, end_col_offset=56)], ctx=Load(), lineno=200, col_offset=39, end_lineno=200, end_col_offset=57), lineno=200, col_offset=12, end_lineno=200, end_col_offset=57), Assign(targets=[Name(id='scope_copy', ctx=Store(), lineno=203, col_offset=12, end_lineno=203, end_col_offset=22)], value=Call(func=Name(id='dict', ctx=Load(), lineno=203, col_offset=25, end_lineno=203, end_col_offset=29), args=[Name(id='scope', ctx=Load(), lineno=203, col_offset=30, end_lineno=203, end_col_offset=35)], lineno=203, col_offset=25, end_lineno=203, end_col_offset=36), lineno=203, col_offset=12, end_lineno=203, end_col_offset=36), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=205, col_offset=12, end_lineno=205, end_col_offset=18), attr='debug', ctx=Load(), lineno=205, col_offset=12, end_lineno=205, end_col_offset=24), args=[Constant(value='Retrieved scope for session', lineno=206, col_offset=16, end_lineno=206, end_col_offset=45)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='session_id', lineno=208, col_offset=20, end_lineno=208, end_col_offset=32), Constant(value='scope_fields', lineno=209, col_offset=20, end_lineno=209, end_col_offset=34)], values=[Name(id='session_id', ctx=Load(), lineno=208, col_offset=34, end_lineno=208, end_col_offset=44), Call(func=Name(id='list', ctx=Load(), lineno=209, col_offset=36, end_lineno=209, end_col_offset=40), args=[Call(func=Attribute(value=Name(id='scope_copy', ctx=Load(), lineno=209, col_offset=41, end_lineno=209, end_col_offset=51), attr='keys', ctx=Load(), lineno=209, col_offset=41, end_lineno=209, end_col_offset=56), lineno=209, col_offset=41, end_lineno=209, end_col_offset=58)], lineno=209, col_offset=36, end_lineno=209, end_col_offset=59)], lineno=207, col_offset=22, end_lineno=210, end_col_offset=17), lineno=207, col_offset=16, end_lineno=210, end_col_offset=17)], lineno=205, col_offset=12, end_lineno=211, end_col_offset=13), lineno=205, col_offset=12, end_lineno=211, end_col_offset=13), Return(value=Name(id='scope_copy', ctx=Load(), lineno=212, col_offset=19, end_lineno=212, end_col_offset=29), lineno=212, col_offset=12, end_lineno=212, end_col_offset=29)], lineno=192, col_offset=8, end_lineno=212, end_col_offset=29)], returns=BinOp(left=Name(id='ScopeIn', ctx=Load(), lineno=159, col_offset=44, end_lineno=159, end_col_offset=51), op=BitOr(), right=Constant(value=None, lineno=159, col_offset=54, end_lineno=159, end_col_offset=58), lineno=159, col_offset=44, end_lineno=159, end_col_offset=58), lineno=159, col_offset=4, end_lineno=212, end_col_offset=29), FunctionDef(name='clear_scope', args=arguments(args=[arg(arg='self', lineno=214, col_offset=20, end_lineno=214, end_col_offset=24), arg(arg='session_id', annotation=Name(id='str', ctx=Load(), lineno=214, col_offset=38, end_lineno=214, end_col_offset=41), lineno=214, col_offset=26, end_lineno=214, end_col_offset=41)]), body=[Expr(value=Constant(value='Remove scope for session.\n\n        Deletes session entry from registry. Subsequent get_scope calls for\n        this session will return None. Clearing non-existent sessions is a\n        no-op (does not raise exception).\n\n        Parameters\n        ----------\n        session_id : str\n            Session identifier to remove.\n\n        Examples\n        --------\n        >>> registry = ScopeRegistry()\n        >>> registry.set_scope("session1", {"languages": ["python"]})\n        >>> registry.clear_scope("session1")\n        >>> registry.get_scope("session1") is None\n        True\n        >>> registry.clear_scope("nonexistent")  # No error\n\n        Notes\n        -----\n        This method is useful for explicit session cleanup (e.g., user logout).\n        For automatic cleanup, use prune_expired() in a background task.\n        ', lineno=215, col_offset=8, end_lineno=239, end_col_offset=11), lineno=215, col_offset=8, end_lineno=239, end_col_offset=11), With(items=[withitem(context_expr=Attribute(value=Name(id='self', ctx=Load(), lineno=240, col_offset=13, end_lineno=240, end_col_offset=17), attr='_lock', ctx=Load(), lineno=240, col_offset=13, end_lineno=240, end_col_offset=23))], body=[If(test=Compare(left=Name(id='session_id', ctx=Load(), lineno=241, col_offset=15, end_lineno=241, end_col_offset=25), ops=[In()], comparators=[Attribute(value=Name(id='self', ctx=Load(), lineno=241, col_offset=29, end_lineno=241, end_col_offset=33), attr='_scopes', ctx=Load(), lineno=241, col_offset=29, end_lineno=241, end_col_offset=41)], lineno=241, col_offset=15, end_lineno=241, end_col_offset=41), body=[Delete(targets=[Subscript(value=Attribute(value=Name(id='self', ctx=Load(), lineno=242, col_offset=20, end_lineno=242, end_col_offset=24), attr='_scopes', ctx=Load(), lineno=242, col_offset=20, end_lineno=242, end_col_offset=32), slice=Name(id='session_id', ctx=Load(), lineno=242, col_offset=33, end_lineno=242, end_col_offset=43), ctx=Del(), lineno=242, col_offset=20, end_lineno=242, end_col_offset=44)], lineno=242, col_offset=16, end_lineno=242, end_col_offset=44), Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=243, col_offset=16, end_lineno=243, end_col_offset=22), attr='info', ctx=Load(), lineno=243, col_offset=16, end_lineno=243, end_col_offset=27), args=[Constant(value='Cleared scope for session', lineno=243, col_offset=28, end_lineno=243, end_col_offset=55)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='session_id', lineno=243, col_offset=64, end_lineno=243, end_col_offset=76)], values=[Name(id='session_id', ctx=Load(), lineno=243, col_offset=78, end_lineno=243, end_col_offset=88)], lineno=243, col_offset=63, end_lineno=243, end_col_offset=89), lineno=243, col_offset=57, end_lineno=243, end_col_offset=89)], lineno=243, col_offset=16, end_lineno=243, end_col_offset=90), lineno=243, col_offset=16, end_lineno=243, end_col_offset=90)], orelse=[Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=245, col_offset=16, end_lineno=245, end_col_offset=22), attr='debug', ctx=Load(), lineno=245, col_offset=16, end_lineno=245, end_col_offset=28), args=[Constant(value='Attempted to clear nonexistent session', lineno=246, col_offset=20, end_lineno=246, end_col_offset=60)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='session_id', lineno=247, col_offset=27, end_lineno=247, end_col_offset=39)], values=[Name(id='session_id', ctx=Load(), lineno=247, col_offset=41, end_lineno=247, end_col_offset=51)], lineno=247, col_offset=26, end_lineno=247, end_col_offset=52), lineno=247, col_offset=20, end_lineno=247, end_col_offset=52)], lineno=245, col_offset=16, end_lineno=248, end_col_offset=17), lineno=245, col_offset=16, end_lineno=248, end_col_offset=17)], lineno=241, col_offset=12, end_lineno=248, end_col_offset=17)], lineno=240, col_offset=8, end_lineno=248, end_col_offset=17)], returns=Constant(value=None, lineno=214, col_offset=46, end_lineno=214, end_col_offset=50), lineno=214, col_offset=4, end_lineno=248, end_col_offset=17), FunctionDef(name='prune_expired', args=arguments(args=[arg(arg='self', lineno=250, col_offset=22, end_lineno=250, end_col_offset=26), arg(arg='max_age_seconds', annotation=Name(id='int', ctx=Load(), lineno=250, col_offset=45, end_lineno=250, end_col_offset=48), lineno=250, col_offset=28, end_lineno=250, end_col_offset=48)]), body=[Expr(value=Constant(value='Remove sessions inactive for longer than max_age_seconds.\n\n        Iterates all sessions and removes those whose last-accessed timestamp\n        is older than threshold. This prevents memory leaks from abandoned\n        sessions (e.g., clients that crash without cleanup).\n\n        The method is designed to be called from a background task (e.g.,\n        every 10 minutes) rather than on every request for performance.\n\n        Parameters\n        ----------\n        max_age_seconds : int\n            Inactivity threshold in seconds. Sessions with (current_time -\n            last_accessed) > max_age_seconds are removed. Typical value: 3600\n            (1 hour).\n\n        Returns\n        -------\n        int\n            Number of sessions pruned.\n\n        Examples\n        --------\n        >>> registry = ScopeRegistry()\n        >>> registry.set_scope("session1", {"languages": ["python"]})\n        >>> import time\n        >>> time.sleep(2)\n        >>> pruned = registry.prune_expired(max_age_seconds=1)\n        >>> pruned\n        1\n        >>> registry.get_scope("session1") is None\n        True\n\n        Notes\n        -----\n        Time measurement uses time.monotonic() to avoid issues with system\n        clock adjustments (e.g., NTP corrections, daylight saving).\n\n        For large session counts (>10K), consider incremental pruning: remove\n        a fixed number of oldest sessions per invocation rather than iterating\n        all sessions at once.\n        ', lineno=251, col_offset=8, end_lineno=292, end_col_offset=11), lineno=251, col_offset=8, end_lineno=292, end_col_offset=11), Assign(targets=[Name(id='current_time', ctx=Store(), lineno=293, col_offset=8, end_lineno=293, end_col_offset=20)], value=Call(func=Attribute(value=Name(id='time', ctx=Load(), lineno=293, col_offset=23, end_lineno=293, end_col_offset=27), attr='monotonic', ctx=Load(), lineno=293, col_offset=23, end_lineno=293, end_col_offset=37), lineno=293, col_offset=23, end_lineno=293, end_col_offset=39), lineno=293, col_offset=8, end_lineno=293, end_col_offset=39), Assign(targets=[Name(id='pruned_count', ctx=Store(), lineno=294, col_offset=8, end_lineno=294, end_col_offset=20)], value=Constant(value=0, lineno=294, col_offset=23, end_lineno=294, end_col_offset=24), lineno=294, col_offset=8, end_lineno=294, end_col_offset=24), With(items=[withitem(context_expr=Attribute(value=Name(id='self', ctx=Load(), lineno=296, col_offset=13, end_lineno=296, end_col_offset=17), attr='_lock', ctx=Load(), lineno=296, col_offset=13, end_lineno=296, end_col_offset=23))], body=[Assign(targets=[Name(id='expired_sessions', ctx=Store(), lineno=298, col_offset=12, end_lineno=298, end_col_offset=28)], value=ListComp(elt=Name(id='session_id', ctx=Load(), lineno=299, col_offset=16, end_lineno=299, end_col_offset=26), generators=[comprehension(target=Tuple(elts=[Name(id='session_id', ctx=Store(), lineno=300, col_offset=20, end_lineno=300, end_col_offset=30), Tuple(elts=[Name(id='_', ctx=Store(), lineno=300, col_offset=33, end_lineno=300, end_col_offset=34), Name(id='timestamp', ctx=Store(), lineno=300, col_offset=36, end_lineno=300, end_col_offset=45)], ctx=Store(), lineno=300, col_offset=32, end_lineno=300, end_col_offset=46)], ctx=Store(), lineno=300, col_offset=20, end_lineno=300, end_col_offset=46), iter=Call(func=Attribute(value=Attribute(value=Name(id='self', ctx=Load(), lineno=300, col_offset=50, end_lineno=300, end_col_offset=54), attr='_scopes', ctx=Load(), lineno=300, col_offset=50, end_lineno=300, end_col_offset=62), attr='items', ctx=Load(), lineno=300, col_offset=50, end_lineno=300, end_col_offset=68), lineno=300, col_offset=50, end_lineno=300, end_col_offset=70), ifs=[Compare(left=BinOp(left=Name(id='current_time', ctx=Load(), lineno=301, col_offset=20, end_lineno=301, end_col_offset=32), op=Sub(), right=Name(id='timestamp', ctx=Load(), lineno=301, col_offset=35, end_lineno=301, end_col_offset=44), lineno=301, col_offset=20, end_lineno=301, end_col_offset=44), ops=[Gt()], comparators=[Name(id='max_age_seconds', ctx=Load(), lineno=301, col_offset=48, end_lineno=301, end_col_offset=63)], lineno=301, col_offset=19, end_lineno=301, end_col_offset=63)], is_async=0)], lineno=298, col_offset=31, end_lineno=302, end_col_offset=13), lineno=298, col_offset=12, end_lineno=302, end_col_offset=13), For(target=Name(id='session_id', ctx=Store(), lineno=305, col_offset=16, end_lineno=305, end_col_offset=26), iter=Name(id='expired_sessions', ctx=Load(), lineno=305, col_offset=30, end_lineno=305, end_col_offset=46), body=[Delete(targets=[Subscript(value=Attribute(value=Name(id='self', ctx=Load(), lineno=306, col_offset=20, end_lineno=306, end_col_offset=24), attr='_scopes', ctx=Load(), lineno=306, col_offset=20, end_lineno=306, end_col_offset=32), slice=Name(id='session_id', ctx=Load(), lineno=306, col_offset=33, end_lineno=306, end_col_offset=43), ctx=Del(), lineno=306, col_offset=20, end_lineno=306, end_col_offset=44)], lineno=306, col_offset=16, end_lineno=306, end_col_offset=44), AugAssign(target=Name(id='pruned_count', ctx=Store(), lineno=307, col_offset=16, end_lineno=307, end_col_offset=28), op=Add(), value=Constant(value=1, lineno=307, col_offset=32, end_lineno=307, end_col_offset=33), lineno=307, col_offset=16, end_lineno=307, end_col_offset=33)], lineno=305, col_offset=12, end_lineno=307, end_col_offset=33)], lineno=296, col_offset=8, end_lineno=307, end_col_offset=33), If(test=Compare(left=Name(id='pruned_count', ctx=Load(), lineno=309, col_offset=11, end_lineno=309, end_col_offset=23), ops=[Gt()], comparators=[Constant(value=0, lineno=309, col_offset=26, end_lineno=309, end_col_offset=27)], lineno=309, col_offset=11, end_lineno=309, end_col_offset=27), body=[Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=310, col_offset=12, end_lineno=310, end_col_offset=18), attr='info', ctx=Load(), lineno=310, col_offset=12, end_lineno=310, end_col_offset=23), args=[Constant(value='Pruned expired sessions', lineno=311, col_offset=16, end_lineno=311, end_col_offset=41)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='pruned_count', lineno=313, col_offset=20, end_lineno=313, end_col_offset=34), Constant(value='max_age_seconds', lineno=314, col_offset=20, end_lineno=314, end_col_offset=37), Constant(value='remaining_sessions', lineno=315, col_offset=20, end_lineno=315, end_col_offset=40)], values=[Name(id='pruned_count', ctx=Load(), lineno=313, col_offset=36, end_lineno=313, end_col_offset=48), Name(id='max_age_seconds', ctx=Load(), lineno=314, col_offset=39, end_lineno=314, end_col_offset=54), Call(func=Name(id='len', ctx=Load(), lineno=315, col_offset=42, end_lineno=315, end_col_offset=45), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=315, col_offset=46, end_lineno=315, end_col_offset=50), attr='_scopes', ctx=Load(), lineno=315, col_offset=46, end_lineno=315, end_col_offset=58)], lineno=315, col_offset=42, end_lineno=315, end_col_offset=59)], lineno=312, col_offset=22, end_lineno=316, end_col_offset=17), lineno=312, col_offset=16, end_lineno=316, end_col_offset=17)], lineno=310, col_offset=12, end_lineno=317, end_col_offset=13), lineno=310, col_offset=12, end_lineno=317, end_col_offset=13)], orelse=[Expr(value=Call(func=Attribute(value=Name(id='LOGGER', ctx=Load(), lineno=319, col_offset=12, end_lineno=319, end_col_offset=18), attr='debug', ctx=Load(), lineno=319, col_offset=12, end_lineno=319, end_col_offset=24), args=[Constant(value='No expired sessions to prune', lineno=320, col_offset=16, end_lineno=320, end_col_offset=46)], keywords=[keyword(arg='extra', value=Dict(keys=[Constant(value='max_age_seconds', lineno=321, col_offset=23, end_lineno=321, end_col_offset=40)], values=[Name(id='max_age_seconds', ctx=Load(), lineno=321, col_offset=42, end_lineno=321, end_col_offset=57)], lineno=321, col_offset=22, end_lineno=321, end_col_offset=58), lineno=321, col_offset=16, end_lineno=321, end_col_offset=58)], lineno=319, col_offset=12, end_lineno=322, end_col_offset=13), lineno=319, col_offset=12, end_lineno=322, end_col_offset=13)], lineno=309, col_offset=8, end_lineno=322, end_col_offset=13), Return(value=Name(id='pruned_count', ctx=Load(), lineno=324, col_offset=15, end_lineno=324, end_col_offset=27), lineno=324, col_offset=8, end_lineno=324, end_col_offset=27)], returns=Name(id='int', ctx=Load(), lineno=250, col_offset=53, end_lineno=250, end_col_offset=56), lineno=250, col_offset=4, end_lineno=324, end_col_offset=27), FunctionDef(name='get_session_count', args=arguments(args=[arg(arg='self', lineno=326, col_offset=26, end_lineno=326, end_col_offset=30)]), body=[Expr(value=Constant(value='Return number of active sessions.\n\n        Useful for monitoring and health checks. If count exceeds threshold\n        (e.g., 10,000), it may indicate pruning failure or attack (session\n        exhaustion).\n\n        Returns\n        -------\n        int\n            Number of sessions currently in registry.\n\n        Examples\n        --------\n        >>> registry = ScopeRegistry()\n        >>> registry.get_session_count()\n        0\n        >>> registry.set_scope("session1", {})\n        >>> registry.set_scope("session2", {})\n        >>> registry.get_session_count()\n        2\n        ', lineno=327, col_offset=8, end_lineno=347, end_col_offset=11), lineno=327, col_offset=8, end_lineno=347, end_col_offset=11), With(items=[withitem(context_expr=Attribute(value=Name(id='self', ctx=Load(), lineno=348, col_offset=13, end_lineno=348, end_col_offset=17), attr='_lock', ctx=Load(), lineno=348, col_offset=13, end_lineno=348, end_col_offset=23))], body=[Return(value=Call(func=Name(id='len', ctx=Load(), lineno=349, col_offset=19, end_lineno=349, end_col_offset=22), args=[Attribute(value=Name(id='self', ctx=Load(), lineno=349, col_offset=23, end_lineno=349, end_col_offset=27), attr='_scopes', ctx=Load(), lineno=349, col_offset=23, end_lineno=349, end_col_offset=35)], lineno=349, col_offset=19, end_lineno=349, end_col_offset=36), lineno=349, col_offset=12, end_lineno=349, end_col_offset=36)], lineno=348, col_offset=8, end_lineno=349, end_col_offset=36)], returns=Name(id='int', ctx=Load(), lineno=326, col_offset=35, end_lineno=326, end_col_offset=38), lineno=326, col_offset=4, end_lineno=349, end_col_offset=36)], lineno=64, col_offset=0, end_lineno=349, end_col_offset=36), Assign(targets=[Name(id='__all__', ctx=Store(), lineno=352, col_offset=0, end_lineno=352, end_col_offset=7)], value=List(elts=[Constant(value='ScopeRegistry', lineno=352, col_offset=11, end_lineno=352, end_col_offset=26)], ctx=Load(), lineno=352, col_offset=10, end_lineno=352, end_col_offset=27), lineno=352, col_offset=0, end_lineno=352, end_col_offset=27)])