Module(body=[ImportFrom(module='__future__', names=[alias(name='annotations', lineno=1, col_offset=23, end_lineno=1, end_col_offset=34)], level=0, lineno=1, col_offset=0, end_lineno=1, end_col_offset=34), ImportFrom(module='dataclasses', names=[alias(name='dataclass', lineno=3, col_offset=24, end_lineno=3, end_col_offset=33)], level=0, lineno=3, col_offset=0, end_lineno=3, end_col_offset=33), ImportFrom(module='types', names=[alias(name='SimpleNamespace', lineno=4, col_offset=18, end_lineno=4, end_col_offset=33)], level=0, lineno=4, col_offset=0, end_lineno=4, end_col_offset=33), Import(names=[alias(name='numpy', asname='np', lineno=6, col_offset=7, end_lineno=6, end_col_offset=18)], lineno=6, col_offset=0, end_lineno=6, end_col_offset=18), Import(names=[alias(name='pytest', lineno=7, col_offset=7, end_lineno=7, end_col_offset=13)], lineno=7, col_offset=0, end_lineno=7, end_col_offset=13), ImportFrom(module='codeintel_rev.io.coderank_embedder', names=[alias(name='CodeRankEmbedder', lineno=8, col_offset=47, end_lineno=8, end_col_offset=63)], level=0, lineno=8, col_offset=0, end_lineno=8, end_col_offset=63), ClassDef(name='_FakeModel', body=[FunctionDef(name='__init__', args=arguments(args=[arg(arg='self', lineno=12, col_offset=17, end_lineno=12, end_col_offset=21)]), body=[AnnAssign(target=Attribute(value=Name(id='self', ctx=Load(), lineno=13, col_offset=8, end_lineno=13, end_col_offset=12), attr='last_inputs', ctx=Store(), lineno=13, col_offset=8, end_lineno=13, end_col_offset=24), annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=13, col_offset=26, end_lineno=13, end_col_offset=30), slice=Name(id='str', ctx=Load(), lineno=13, col_offset=31, end_lineno=13, end_col_offset=34), ctx=Load(), lineno=13, col_offset=26, end_lineno=13, end_col_offset=35), value=List(ctx=Load(), lineno=13, col_offset=38, end_lineno=13, end_col_offset=40), simple=0, lineno=13, col_offset=8, end_lineno=13, end_col_offset=40)], returns=Constant(value=None, lineno=12, col_offset=26, end_lineno=12, end_col_offset=30), lineno=12, col_offset=4, end_lineno=13, end_col_offset=40), FunctionDef(name='encode', args=arguments(args=[arg(arg='self', lineno=15, col_offset=15, end_lineno=15, end_col_offset=19), arg(arg='texts', annotation=Subscript(value=Name(id='list', ctx=Load(), lineno=15, col_offset=28, end_lineno=15, end_col_offset=32), slice=Name(id='str', ctx=Load(), lineno=15, col_offset=33, end_lineno=15, end_col_offset=36), ctx=Load(), lineno=15, col_offset=28, end_lineno=15, end_col_offset=37), lineno=15, col_offset=21, end_lineno=15, end_col_offset=37)], kwarg=arg(arg='_', annotation=Name(id='object', ctx=Load(), lineno=15, col_offset=44, end_lineno=15, end_col_offset=50), lineno=15, col_offset=41, end_lineno=15, end_col_offset=50)), body=[Assign(targets=[Attribute(value=Name(id='self', ctx=Load(), lineno=16, col_offset=8, end_lineno=16, end_col_offset=12), attr='last_inputs', ctx=Store(), lineno=16, col_offset=8, end_lineno=16, end_col_offset=24)], value=Call(func=Name(id='list', ctx=Load(), lineno=16, col_offset=27, end_lineno=16, end_col_offset=31), args=[Name(id='texts', ctx=Load(), lineno=16, col_offset=32, end_lineno=16, end_col_offset=37)], lineno=16, col_offset=27, end_lineno=16, end_col_offset=38), lineno=16, col_offset=8, end_lineno=16, end_col_offset=38), Return(value=ListComp(elt=List(elts=[Constant(value=0.1, lineno=17, col_offset=17, end_lineno=17, end_col_offset=20), Constant(value=0.2, lineno=17, col_offset=22, end_lineno=17, end_col_offset=25)], ctx=Load(), lineno=17, col_offset=16, end_lineno=17, end_col_offset=26), generators=[comprehension(target=Name(id='_', ctx=Store(), lineno=17, col_offset=31, end_lineno=17, end_col_offset=32), iter=Name(id='texts', ctx=Load(), lineno=17, col_offset=36, end_lineno=17, end_col_offset=41), is_async=0)], lineno=17, col_offset=15, end_lineno=17, end_col_offset=42), lineno=17, col_offset=8, end_lineno=17, end_col_offset=42)], returns=Subscript(value=Name(id='list', ctx=Load(), lineno=15, col_offset=55, end_lineno=15, end_col_offset=59), slice=Subscript(value=Name(id='list', ctx=Load(), lineno=15, col_offset=60, end_lineno=15, end_col_offset=64), slice=Name(id='float', ctx=Load(), lineno=15, col_offset=65, end_lineno=15, end_col_offset=70), ctx=Load(), lineno=15, col_offset=60, end_lineno=15, end_col_offset=71), ctx=Load(), lineno=15, col_offset=55, end_lineno=15, end_col_offset=72), lineno=15, col_offset=4, end_lineno=17, end_col_offset=42)], lineno=11, col_offset=0, end_lineno=17, end_col_offset=42), FunctionDef(name='_patch_gate', args=arguments(args=[arg(arg='monkeypatch', annotation=Attribute(value=Name(id='pytest', ctx=Load(), lineno=20, col_offset=29, end_lineno=20, end_col_offset=35), attr='MonkeyPatch', ctx=Load(), lineno=20, col_offset=29, end_lineno=20, end_col_offset=47), lineno=20, col_offset=16, end_lineno=20, end_col_offset=47), arg(arg='fake_model', annotation=Name(id='_FakeModel', ctx=Load(), lineno=20, col_offset=61, end_lineno=20, end_col_offset=71), lineno=20, col_offset=49, end_lineno=20, end_col_offset=71)]), body=[FunctionDef(name='_build_model', args=arguments(vararg=arg(arg='_', annotation=Name(id='object', ctx=Load(), lineno=21, col_offset=25, end_lineno=21, end_col_offset=31), lineno=21, col_offset=22, end_lineno=21, end_col_offset=31), kwarg=arg(arg='__', annotation=Name(id='object', ctx=Load(), lineno=21, col_offset=39, end_lineno=21, end_col_offset=45), lineno=21, col_offset=35, end_lineno=21, end_col_offset=45)), body=[Return(value=Name(id='fake_model', ctx=Load(), lineno=22, col_offset=15, end_lineno=22, end_col_offset=25), lineno=22, col_offset=8, end_lineno=22, end_col_offset=25)], returns=Name(id='_FakeModel', ctx=Load(), lineno=21, col_offset=50, end_lineno=21, end_col_offset=60), lineno=21, col_offset=4, end_lineno=22, end_col_offset=25), Assign(targets=[Name(id='module', ctx=Store(), lineno=24, col_offset=4, end_lineno=24, end_col_offset=10)], value=Call(func=Name(id='SimpleNamespace', ctx=Load(), lineno=24, col_offset=13, end_lineno=24, end_col_offset=28), keywords=[keyword(arg='SentenceTransformer', value=Name(id='_build_model', ctx=Load(), lineno=24, col_offset=49, end_lineno=24, end_col_offset=61), lineno=24, col_offset=29, end_lineno=24, end_col_offset=61)], lineno=24, col_offset=13, end_lineno=24, end_col_offset=62), lineno=24, col_offset=4, end_lineno=24, end_col_offset=62), FunctionDef(name='_gate_import', args=arguments(vararg=arg(arg='_', annotation=Name(id='object', ctx=Load(), lineno=26, col_offset=25, end_lineno=26, end_col_offset=31), lineno=26, col_offset=22, end_lineno=26, end_col_offset=31), kwarg=arg(arg='__', annotation=Name(id='object', ctx=Load(), lineno=26, col_offset=39, end_lineno=26, end_col_offset=45), lineno=26, col_offset=35, end_lineno=26, end_col_offset=45)), body=[Return(value=Name(id='module', ctx=Load(), lineno=27, col_offset=15, end_lineno=27, end_col_offset=21), lineno=27, col_offset=8, end_lineno=27, end_col_offset=21)], returns=Name(id='SimpleNamespace', ctx=Load(), lineno=26, col_offset=50, end_lineno=26, end_col_offset=65), lineno=26, col_offset=4, end_lineno=27, end_col_offset=21), Expr(value=Call(func=Attribute(value=Name(id='monkeypatch', ctx=Load(), lineno=29, col_offset=4, end_lineno=29, end_col_offset=15), attr='setattr', ctx=Load(), lineno=29, col_offset=4, end_lineno=29, end_col_offset=23), args=[Constant(value='codeintel_rev.io.coderank_embedder.gate_import', lineno=30, col_offset=8, end_lineno=30, end_col_offset=56), Name(id='_gate_import', ctx=Load(), lineno=31, col_offset=8, end_lineno=31, end_col_offset=20)], lineno=29, col_offset=4, end_lineno=32, end_col_offset=5), lineno=29, col_offset=4, end_lineno=32, end_col_offset=5)], returns=Constant(value=None, lineno=20, col_offset=76, end_lineno=20, end_col_offset=80), lineno=20, col_offset=0, end_lineno=32, end_col_offset=5), FunctionDef(name='test_encode_queries_applies_instruction_prefix', args=arguments(args=[arg(arg='monkeypatch', annotation=Attribute(value=Name(id='pytest', ctx=Load(), lineno=35, col_offset=64, end_lineno=35, end_col_offset=70), attr='MonkeyPatch', ctx=Load(), lineno=35, col_offset=64, end_lineno=35, end_col_offset=82), lineno=35, col_offset=51, end_lineno=35, end_col_offset=82)]), body=[Assign(targets=[Name(id='fake_model', ctx=Store(), lineno=36, col_offset=4, end_lineno=36, end_col_offset=14)], value=Call(func=Name(id='_FakeModel', ctx=Load(), lineno=36, col_offset=17, end_lineno=36, end_col_offset=27), lineno=36, col_offset=17, end_lineno=36, end_col_offset=29), lineno=36, col_offset=4, end_lineno=36, end_col_offset=29), Expr(value=Call(func=Name(id='_patch_gate', ctx=Load(), lineno=37, col_offset=4, end_lineno=37, end_col_offset=15), args=[Name(id='monkeypatch', ctx=Load(), lineno=37, col_offset=16, end_lineno=37, end_col_offset=27), Name(id='fake_model', ctx=Load(), lineno=37, col_offset=29, end_lineno=37, end_col_offset=39)], lineno=37, col_offset=4, end_lineno=37, end_col_offset=40), lineno=37, col_offset=4, end_lineno=37, end_col_offset=40), Assign(targets=[Name(id='settings', ctx=Store(), lineno=39, col_offset=4, end_lineno=39, end_col_offset=12)], value=Call(func=Name(id='_EmbedderSettings', ctx=Load(), lineno=39, col_offset=15, end_lineno=39, end_col_offset=32), keywords=[keyword(arg='model_id', value=Constant(value='stub_queries', lineno=40, col_offset=17, end_lineno=40, end_col_offset=31), lineno=40, col_offset=8, end_lineno=40, end_col_offset=31), keyword(arg='device', value=Constant(value='cpu', lineno=41, col_offset=15, end_lineno=41, end_col_offset=20), lineno=41, col_offset=8, end_lineno=41, end_col_offset=20), keyword(arg='trust_remote_code', value=Constant(value=True, lineno=42, col_offset=26, end_lineno=42, end_col_offset=30), lineno=42, col_offset=8, end_lineno=42, end_col_offset=30), keyword(arg='query_prefix', value=Constant(value='Represent this query: ', lineno=43, col_offset=21, end_lineno=43, end_col_offset=45), lineno=43, col_offset=8, end_lineno=43, end_col_offset=45), keyword(arg='normalize', value=Constant(value=True, lineno=44, col_offset=18, end_lineno=44, end_col_offset=22), lineno=44, col_offset=8, end_lineno=44, end_col_offset=22), keyword(arg='batch_size', value=Constant(value=4, lineno=45, col_offset=19, end_lineno=45, end_col_offset=20), lineno=45, col_offset=8, end_lineno=45, end_col_offset=20)], lineno=39, col_offset=15, end_lineno=46, end_col_offset=5), lineno=39, col_offset=4, end_lineno=46, end_col_offset=5), Assign(targets=[Name(id='embedder', ctx=Store(), lineno=47, col_offset=4, end_lineno=47, end_col_offset=12)], value=Call(func=Name(id='CodeRankEmbedder', ctx=Load(), lineno=47, col_offset=15, end_lineno=47, end_col_offset=31), keywords=[keyword(arg='settings', value=Name(id='settings', ctx=Load(), lineno=47, col_offset=41, end_lineno=47, end_col_offset=49), lineno=47, col_offset=32, end_lineno=47, end_col_offset=49)], lineno=47, col_offset=15, end_lineno=47, end_col_offset=50), lineno=47, col_offset=4, end_lineno=47, end_col_offset=50), Assign(targets=[Name(id='vectors', ctx=Store(), lineno=48, col_offset=4, end_lineno=48, end_col_offset=11)], value=Call(func=Attribute(value=Name(id='embedder', ctx=Load(), lineno=48, col_offset=14, end_lineno=48, end_col_offset=22), attr='encode_queries', ctx=Load(), lineno=48, col_offset=14, end_lineno=48, end_col_offset=37), args=[List(elts=[Constant(value='search scope', lineno=48, col_offset=39, end_lineno=48, end_col_offset=53)], ctx=Load(), lineno=48, col_offset=38, end_lineno=48, end_col_offset=54)], lineno=48, col_offset=14, end_lineno=48, end_col_offset=55), lineno=48, col_offset=4, end_lineno=48, end_col_offset=55), Assert(test=Call(func=Attribute(value=Subscript(value=Attribute(value=Name(id='fake_model', ctx=Load(), lineno=50, col_offset=11, end_lineno=50, end_col_offset=21), attr='last_inputs', ctx=Load(), lineno=50, col_offset=11, end_lineno=50, end_col_offset=33), slice=Constant(value=0, lineno=50, col_offset=34, end_lineno=50, end_col_offset=35), ctx=Load(), lineno=50, col_offset=11, end_lineno=50, end_col_offset=36), attr='startswith', ctx=Load(), lineno=50, col_offset=11, end_lineno=50, end_col_offset=47), args=[Constant(value='Represent this query: ', lineno=50, col_offset=48, end_lineno=50, end_col_offset=72)], lineno=50, col_offset=11, end_lineno=50, end_col_offset=73), lineno=50, col_offset=4, end_lineno=50, end_col_offset=73), Assert(test=Compare(left=Attribute(value=Name(id='vectors', ctx=Load(), lineno=51, col_offset=11, end_lineno=51, end_col_offset=18), attr='shape', ctx=Load(), lineno=51, col_offset=11, end_lineno=51, end_col_offset=24), ops=[Eq()], comparators=[Tuple(elts=[Constant(value=1, lineno=51, col_offset=29, end_lineno=51, end_col_offset=30), Constant(value=2, lineno=51, col_offset=32, end_lineno=51, end_col_offset=33)], ctx=Load(), lineno=51, col_offset=28, end_lineno=51, end_col_offset=34)], lineno=51, col_offset=11, end_lineno=51, end_col_offset=34), lineno=51, col_offset=4, end_lineno=51, end_col_offset=34), Assert(test=Compare(left=Attribute(value=Name(id='vectors', ctx=Load(), lineno=52, col_offset=11, end_lineno=52, end_col_offset=18), attr='dtype', ctx=Load(), lineno=52, col_offset=11, end_lineno=52, end_col_offset=24), ops=[Eq()], comparators=[Attribute(value=Name(id='np', ctx=Load(), lineno=52, col_offset=28, end_lineno=52, end_col_offset=30), attr='float32', ctx=Load(), lineno=52, col_offset=28, end_lineno=52, end_col_offset=38)], lineno=52, col_offset=11, end_lineno=52, end_col_offset=38), lineno=52, col_offset=4, end_lineno=52, end_col_offset=38)], returns=Constant(value=None, lineno=35, col_offset=87, end_lineno=35, end_col_offset=91), lineno=35, col_offset=0, end_lineno=52, end_col_offset=38), FunctionDef(name='test_encode_codes_requires_input', args=arguments(args=[arg(arg='monkeypatch', annotation=Attribute(value=Name(id='pytest', ctx=Load(), lineno=55, col_offset=50, end_lineno=55, end_col_offset=56), attr='MonkeyPatch', ctx=Load(), lineno=55, col_offset=50, end_lineno=55, end_col_offset=68), lineno=55, col_offset=37, end_lineno=55, end_col_offset=68)]), body=[Assign(targets=[Name(id='fake_model', ctx=Store(), lineno=56, col_offset=4, end_lineno=56, end_col_offset=14)], value=Call(func=Name(id='_FakeModel', ctx=Load(), lineno=56, col_offset=17, end_lineno=56, end_col_offset=27), lineno=56, col_offset=17, end_lineno=56, end_col_offset=29), lineno=56, col_offset=4, end_lineno=56, end_col_offset=29), Expr(value=Call(func=Name(id='_patch_gate', ctx=Load(), lineno=57, col_offset=4, end_lineno=57, end_col_offset=15), args=[Name(id='monkeypatch', ctx=Load(), lineno=57, col_offset=16, end_lineno=57, end_col_offset=27), Name(id='fake_model', ctx=Load(), lineno=57, col_offset=29, end_lineno=57, end_col_offset=39)], lineno=57, col_offset=4, end_lineno=57, end_col_offset=40), lineno=57, col_offset=4, end_lineno=57, end_col_offset=40), Assign(targets=[Name(id='settings', ctx=Store(), lineno=58, col_offset=4, end_lineno=58, end_col_offset=12)], value=Call(func=Name(id='_EmbedderSettings', ctx=Load(), lineno=58, col_offset=15, end_lineno=58, end_col_offset=32), keywords=[keyword(arg='model_id', value=Constant(value='stub_codes', lineno=59, col_offset=17, end_lineno=59, end_col_offset=29), lineno=59, col_offset=8, end_lineno=59, end_col_offset=29), keyword(arg='device', value=Constant(value='cpu', lineno=60, col_offset=15, end_lineno=60, end_col_offset=20), lineno=60, col_offset=8, end_lineno=60, end_col_offset=20), keyword(arg='trust_remote_code', value=Constant(value=True, lineno=61, col_offset=26, end_lineno=61, end_col_offset=30), lineno=61, col_offset=8, end_lineno=61, end_col_offset=30), keyword(arg='query_prefix', value=Constant(value='prefix: ', lineno=62, col_offset=21, end_lineno=62, end_col_offset=31), lineno=62, col_offset=8, end_lineno=62, end_col_offset=31), keyword(arg='normalize', value=Constant(value=True, lineno=63, col_offset=18, end_lineno=63, end_col_offset=22), lineno=63, col_offset=8, end_lineno=63, end_col_offset=22), keyword(arg='batch_size', value=Constant(value=4, lineno=64, col_offset=19, end_lineno=64, end_col_offset=20), lineno=64, col_offset=8, end_lineno=64, end_col_offset=20)], lineno=58, col_offset=15, end_lineno=65, end_col_offset=5), lineno=58, col_offset=4, end_lineno=65, end_col_offset=5), Assign(targets=[Name(id='embedder', ctx=Store(), lineno=66, col_offset=4, end_lineno=66, end_col_offset=12)], value=Call(func=Name(id='CodeRankEmbedder', ctx=Load(), lineno=66, col_offset=15, end_lineno=66, end_col_offset=31), keywords=[keyword(arg='settings', value=Name(id='settings', ctx=Load(), lineno=66, col_offset=41, end_lineno=66, end_col_offset=49), lineno=66, col_offset=32, end_lineno=66, end_col_offset=49)], lineno=66, col_offset=15, end_lineno=66, end_col_offset=50), lineno=66, col_offset=4, end_lineno=66, end_col_offset=50), With(items=[withitem(context_expr=Call(func=Attribute(value=Name(id='pytest', ctx=Load(), lineno=68, col_offset=9, end_lineno=68, end_col_offset=15), attr='raises', ctx=Load(), lineno=68, col_offset=9, end_lineno=68, end_col_offset=22), args=[Name(id='ValueError', ctx=Load(), lineno=68, col_offset=23, end_lineno=68, end_col_offset=33)], keywords=[keyword(arg='match', value=Constant(value='code snippet', lineno=68, col_offset=41, end_lineno=68, end_col_offset=55), lineno=68, col_offset=35, end_lineno=68, end_col_offset=55)], lineno=68, col_offset=9, end_lineno=68, end_col_offset=56))], body=[Expr(value=Call(func=Attribute(value=Name(id='embedder', ctx=Load(), lineno=69, col_offset=8, end_lineno=69, end_col_offset=16), attr='encode_codes', ctx=Load(), lineno=69, col_offset=8, end_lineno=69, end_col_offset=29), args=[List(ctx=Load(), lineno=69, col_offset=30, end_lineno=69, end_col_offset=32)], lineno=69, col_offset=8, end_lineno=69, end_col_offset=33), lineno=69, col_offset=8, end_lineno=69, end_col_offset=33)], lineno=68, col_offset=4, end_lineno=69, end_col_offset=33)], returns=Constant(value=None, lineno=55, col_offset=73, end_lineno=55, end_col_offset=77), lineno=55, col_offset=0, end_lineno=69, end_col_offset=33), ClassDef(name='_EmbedderSettings', body=[AnnAssign(target=Name(id='model_id', ctx=Store(), lineno=74, col_offset=4, end_lineno=74, end_col_offset=12), annotation=Name(id='str', ctx=Load(), lineno=74, col_offset=14, end_lineno=74, end_col_offset=17), simple=1, lineno=74, col_offset=4, end_lineno=74, end_col_offset=17), AnnAssign(target=Name(id='device', ctx=Store(), lineno=75, col_offset=4, end_lineno=75, end_col_offset=10), annotation=Name(id='str', ctx=Load(), lineno=75, col_offset=12, end_lineno=75, end_col_offset=15), simple=1, lineno=75, col_offset=4, end_lineno=75, end_col_offset=15), AnnAssign(target=Name(id='trust_remote_code', ctx=Store(), lineno=76, col_offset=4, end_lineno=76, end_col_offset=21), annotation=Name(id='bool', ctx=Load(), lineno=76, col_offset=23, end_lineno=76, end_col_offset=27), simple=1, lineno=76, col_offset=4, end_lineno=76, end_col_offset=27), AnnAssign(target=Name(id='query_prefix', ctx=Store(), lineno=77, col_offset=4, end_lineno=77, end_col_offset=16), annotation=Name(id='str', ctx=Load(), lineno=77, col_offset=18, end_lineno=77, end_col_offset=21), simple=1, lineno=77, col_offset=4, end_lineno=77, end_col_offset=21), AnnAssign(target=Name(id='normalize', ctx=Store(), lineno=78, col_offset=4, end_lineno=78, end_col_offset=13), annotation=Name(id='bool', ctx=Load(), lineno=78, col_offset=15, end_lineno=78, end_col_offset=19), simple=1, lineno=78, col_offset=4, end_lineno=78, end_col_offset=19), AnnAssign(target=Name(id='batch_size', ctx=Store(), lineno=79, col_offset=4, end_lineno=79, end_col_offset=14), annotation=Name(id='int', ctx=Load(), lineno=79, col_offset=16, end_lineno=79, end_col_offset=19), simple=1, lineno=79, col_offset=4, end_lineno=79, end_col_offset=19)], decorator_list=[Name(id='dataclass', ctx=Load(), lineno=72, col_offset=1, end_lineno=72, end_col_offset=10)], lineno=73, col_offset=0, end_lineno=79, end_col_offset=19)])