BM25 Index Management
=====================

This document describes how BM25 corpora and Lucene indexes are built and
maintained inside the CodeIntel stack. The goal for Phase 1 (Baseline BM25
setup & maintenance) is to standardise the workflow, record metadata, and make
operations repeatable via the shared CLI tooling.

Overview
--------

CodeIntel uses Pyserini's Lucene indexer to materialise standard BM25 search
indexes from project corpora. The workflow is coordinated by the
``BM25IndexManager`` class in :mod:`codeintel_rev.io.bm25_manager`, which
provides two key surfaces:

Prepare corpus
    Converts a JSONL corpus (``{"id": "...", "contents": "..."}`` per line) into
    a Pyserini-compatible ``JsonCollection`` directory, deduplicating IDs,
    validating schema, and writing metadata about the run.

Build index
    Invokes ``pyserini.index.lucene`` with the appropriate flags to create a
    Lucene index, persisting index metadata and recording build statistics.

Both operations emit structured metadata files (``metadata.json``) alongside
their outputs so that later stages can audit corpus digests and index versions.

CLI Workflow
------------

The ``codeintel`` console script exposes a ``bm25`` subcommand that wraps both
operations in the shared CLI façade (``tools._shared.cli_runtime``). This allows
every run to produce a JSON envelope, emit Prometheus-compatible metrics, and
surface artefacts in observability dashboards.

.. code-block:: console

   # prepare a JsonCollection from data/corpus.jsonl
   codeintel bm25 prepare-corpus data/corpus.jsonl --output-dir data/jsonl

   # build a Lucene BM25 index from the prepared collection
   codeintel bm25 build-index --json-dir data/jsonl --threads 8

The CLI command routes are fully typed and wrapped with ``@cli_operation``,
which injects logging context and orchestrates envelope persistence under
``docs/_data/cli/bm25/...``.

Metadata Files
--------------

Every successful run produces a ``metadata.json`` file with a stable schema.

Corpus metadata (written to ``<corpus_dir>/metadata.json``):

* ``doc_count`` – number of docs written to the JsonCollection.
* ``source_path`` – repo-relative path to the JSONL source file.
* ``digest`` – SHA256 digest covering doc IDs and contents (for reproducibility).
* ``prepared_at`` – ISO timestamp when the corpus was prepared.
* ``generator`` – module responsible for the run
  (``codeintel_rev.io.bm25_manager``).

Index metadata (written to ``<index_dir>/metadata.json``):

* ``doc_count`` – documents indexed by Pyserini.
* ``built_at`` – ISO timestamp for the index build.
* ``corpus_digest`` – recorded digest from the corpus metadata.
* ``corpus_source`` – source path from the corpus metadata.
* ``pyserini_version`` – resolved Pyserini version at runtime.
* ``threads`` – thread count used during indexing.
* ``index_dir`` – absolute path to the Lucene index directory.
* ``index_size_bytes`` – size on disk (helps with capacity planning).
* ``generator`` – module responsible for the run.

Configuration
-------------

Settings for BM25 live under the ``bm25`` section of :mod:`codeintel_rev.config.settings.Settings`.
Environment variables are documented in :doc:`../CONFIGURATION` and control:

* ``BM25_JSONL_DIR`` – default location for the prepared JsonCollection.
* ``BM25_INDEX_DIR`` – default Lucene index output directory.
* ``BM25_THREADS`` – default thread count for Pyserini indexing.

These defaults are used when CLI callers omit explicit ``--json-dir`` and
``--index-dir`` arguments.

Operational Guidance
--------------------

* To rebuild an index, run ``prepare-corpus`` followed by ``build-index`` while
  pointing at the same ``--json-dir``. The second command overwrites the Lucene
  directory by default; pass ``--overwrite`` to control behaviour.
* Metadata files can be diffed during deployments to verify that a new index is
  materially different (changes in ``doc_count`` or ``digest``).
* Envelopes under ``docs/_data/cli`` include SHA256 digests for metadata files,
  making it easy to trace a CLI run back to the artefacts it produced.

Next Steps
------------

Phase 1 follow-ups:

* Wire CI/automation to call ``codeintel bm25`` for nightly rebuilds on fixture
  corpora.
* Capture observability metrics (duration, doc counts) in dashboards.
* Extend CLI helpers with validation commands to compare two metadata files.

