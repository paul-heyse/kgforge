## 1. Implementation
- [ ] 1.1 Audit serialization usage.
  - Locate all `pickle` imports via `rg "import pickle" -g"*.py" src`; categorize usage (read vs write, trusted vs untrusted sources).
  - Document payload types and boundaries (internal cache, external artifacts, etc.).
- [ ] 1.2 Implement secure serialization wrapper.
  - Create `kgfoundry_common.serialization.safe_pickle` with functions `dump(obj, path, *, allowlist, signer)` and `load(path, *, allowlist, signer)`.
  - Enforce allow-list of classes/modules; integrate optional HMAC signing using keys from configuration.
  - Provide JSON alternative serialization (`safe_json_dump/load`) for new payloads where feasible.
- [ ] 1.3 Migrate existing pickle usage.
  - Update embeddings, orchestration, and search modules to use `safe_pickle` or JSON alternatives.
  - Update tests to cover both valid and rejected payloads (tampered signature, disallowed class).
- [ ] 1.4 Document threat model.
  - Add `docs/security/serialization.md` outlining trusted/untrusted sources, signing approach, and rotation guidance.
  - Reference configuration variables for signing keys and allow-lists.
- [ ] 1.5 Enforce subprocess hygiene.
  - Identify subprocess calls via `rg "subprocess" src`; wrap them with helper `run_subprocess(cmd: list[str], *, timeout: int, cwd: Path | None, env: Mapping[str, str])`.
  - Sanitize paths using `pathlib.Path.resolve()` and ensure commands operate on whitelisted directories.
  - Add tests verifying timeouts trigger `SubprocessTimeoutError` with structured Problem Details.
- [ ] 1.6 Enforce network timeouts.
  - Update `search_client/client.py` and other network callers to require `timeout` arguments; expose defaults via configuration.
  - Add tests confirming timeouts propagate and Problem Details errors surface when exceeded.
- [ ] 1.7 Propagate ContextVars.
  - Extend async contexts (if present) to set `ContextVar` for request identifiers/timeouts; ensure asynchronous tasks fetch from context.
  - Add tests verifying context propagation in async flows.
- [ ] 1.8 Harden configuration validation.
  - Update `AppSettings` to include serialization/signing settings, timeout defaults, and path allow-lists.
  - Add validators ensuring env vars parse correctly (e.g., positive timeouts, existing paths).
- [ ] 1.9 Add smoke tests for config.
  - Create `tests/kgfoundry_common/test_config_smoke.py` verifying missing env vars raise `ConfigurationError` and invalid values produce descriptive messages.
  - Add table-driven tests covering common misconfigurations (missing signing key, negative timeout).
- [ ] 1.10 Update documentation and examples.
  - Refresh `docs/reference/config.md` with new env variables and defaults; include `.env.example` snippet.
  - Document subprocess/network safety guidelines in `docs/contributing/security.md`.
- [ ] 1.11 Execute iterative quality gates.
  - After serialization changes, run `uv run ruff check src/kgfoundry_common/serialization.py` and targeted tests.
  - After subprocess/network updates, run `uv run pytest -q tests/orchestration tests/search_client`.
  - Ensure `uv run pyrefly check` and `uv run mypy --config-file mypy.ini` remain clean.

## 2. Final Verification
- [ ] 2.1 Execute full command suite: `uv run ruff format && uv run ruff check --fix`, `uv run pyrefly check`, `uv run mypy --config-file mypy.ini`, `uv run pytest -q`, `make artifacts`.
- [ ] 2.2 Produce release notes summarizing serialization changes, timeout defaults, and configuration requirements; include migration checklist.

