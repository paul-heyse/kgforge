## 1. Implementation

- [ ] 1.1 Baseline the current FAISS integration.
  - Review `src/vectorstore_faiss/gpu.py`, `src/kgfoundry/vectorstore_faiss/gpu.py`, `src/search_api/faiss_adapter.py`, `src/search_api/faiss_gpu.py`, and `src/orchestration/cli.py` to map existing exports and missing aliases.
  - Record all Pyrefly/Mypy/Ruff failures linked to these modules for before/after comparison.
- [ ] 1.2 Define authoritative array aliases in `src/vectorstore_faiss/gpu.py`.
  - Import `numpy.typing.NDArray`, declare `FloatArray`, `IntArray`, `StrArray`, and `VecArray` with precise dtype/shape notes, add NumPy-style docstrings, and expose them via `__all__`.
- [ ] 1.3 Synchronise namespace bridge exports.
  - Update `src/kgfoundry/vectorstore_faiss/gpu.py` so `__all__` re-exports aliases in sorted order, refresh module docstrings with ownership notes, ensure `namespace_attach` populates each alias, and run `uv run ruff check` to confirm cleanliness.
- [ ] 1.4 Harden `search_api.faiss_adapter` typing.
  - Remove `# mypy: ignore-errors`, import aliases, replace raw `NDArray` typings, add explicit return annotations, and document raised exceptions (`IndexBuildError`, `VectorSearchError`).
- [ ] 1.5 Align FAISS protocols.
  - Update `src/search_api/types.py` so protocol signatures reference the aliases, rename helpers to satisfy Ruff naming, and expand docstrings covering normalized vectors and concurrency notes.
- [ ] 1.6 Refresh stub surfaces.
  - Update `stubs/vectorstore_faiss/gpu.pyi` and `stubs/search_api/faiss_adapter.pyi` with matching aliases/signatures, mirror docstrings, and run `uv run pyrefly check` on stub directories.
- [ ] 1.7 Introduce configuration models.
  - Add `FaissAdapterSettings`/`FaissBuildContext` dataclasses in `src/search_api/vectorstore_factory.py` capturing paths, metrics, accelerator preferences, timeout budgets, and registry injection; provide `.from_env()` helpers with validation.
- [ ] 1.8 Implement `FaissVectorstoreFactory`.
  - Encapsulate creation of `FaissAdapter` instances, GPU detection, operations (`build_index`, `load_or_build`, `save_manifest`, `close`), and ensure each raises typed exceptions with `raise ... from exc`.
- [ ] 1.9 Add manifest helpers.
  - Implement `write_manifest`/`validate_manifest` emitting JSON aligned with the schema and computing deterministic checksums; return immutable dataclasses for downstream use.
- [ ] 1.10 Refactor `orchestration.cli:index_faiss`.
  - Parse CLI args into settings, generate correlation IDs, instantiate structured `LoggerAdapter`, and delegate build/save logic to the factory while preserving user messaging.
- [ ] 1.11 Enforce timeout and idempotency.
  - Wrap build flow with `time.monotonic()` budgets, raise `IndexBuildError` on timeout, write artifacts atomically via temp files + `Path.replace`, and document retry semantics in the CLI docstring (with examples).
- [ ] 1.12 Instrument Prometheus metrics.
  - Register `kgfoundry_index_build_total` and `kgfoundry_index_build_duration_seconds`, emit metrics for start/success/error paths, and allow registry injection for deterministic tests.
- [ ] 1.13 Emit Problem Details payloads.
  - Create Problem Details example JSON, implement `build_index_problem_details`, and update CLI error handling to log with `exc_info=True`, print payload, and exit via `typer.Exit(1)` while preserving causes.
- [ ] 1.14 Define the FAISS manifest schema.
  - Author `schema/vectorstore/faiss-index-manifest.schema.json` (2020-12), include examples, register within schema indices, and wire runtime helpers to consume the canonical schema.
- [ ] 1.15 Update inline documentation.
  - Revise module docstrings/`__navmap__` metadata to mention factory, schema, metrics, and Problem Details; confirm NumPy-style sections and doctest-ready examples exist.
- [ ] 1.16 Run targeted quality gates before tests.
  - Execute `uv run ruff format && uv run ruff check` and `uv run pyrefly check`/`uv run mypy --config-file mypy.ini` scoped to `vectorstore_faiss`, `search_api`, and `orchestration` modules to ensure lint/type cleanliness before expanding tests.

## 2. Testing

- [ ] 2.1 Establish foundational fixtures.
  - Create `tests/vectorstore/conftest.py` providing normalized vector fixtures, temporary directories, Prometheus registries, mocked GPU contexts, and deterministic correlation ID generators.
- [ ] 2.2 Verify type alignment inside tests.
  - Mirror runtime aliases in tests, import `FloatArray`/`VecArray`, and run `uv run mypy --config-file mypy.ini tests/vectorstore` to confirm zero ignores.
- [ ] 2.3 Author CPU vs GPU parity tests.
  - Parameterize accelerator mode over `{"cpu", "gpu"}`, build indexes via the factory, assert result parity within tolerance, and skip GPU cases gracefully when bindings/hardware absent.
- [ ] 2.4 Exercise CLI behaviour end-to-end.
  - Use `typer.testing.CliRunner` to run `index_faiss`, capture stdout/stderr, assert structured completion logs, and verify failure paths emit Problem Details JSON with `typer.Exit(1)`.
- [ ] 2.5 Simulate timeout scenarios.
  - Monkeypatch factory components to exceed timeouts, assert metrics record `status="timeout"`, CLI exits with code `1`, Problem Details matches example JSON, and temporary artifacts are cleaned up.
- [ ] 2.6 Validate manifest schema round-trips.
  - After builds, load manifest JSON, validate against the schema via `jsonschema`, reload index through factory, and add negative tests for malformed manifests raising `VectorSearchError`.
- [ ] 2.7 Cover persistence and GPU failure modes.
  - Induce IO errors and GPU cloning failures, assert logs at `WARNING`, metrics increment `status="error"`, CPU fallback engages when appropriate, and typed exceptions preserve causes.
- [ ] 2.8 Inspect Prometheus metrics.
  - Scrape in-memory registries post-run to ensure counters/histograms use expected labels/buckets and detect duplicate registration attempts.
- [ ] 2.9 Validate docstrings and doctests.
  - Enable doctest/xdoctest for modified modules, ensure examples execute with provided fixtures, and adjust docstrings if setup is required.
- [ ] 2.10 Consolidate test-quality evidence.
  - Run `pytest -q` (GPU tests auto-skip when unsupported), collect logs/coverage demonstrating parity, schema validation, metrics, and Problem Details emission, and prep outputs for the PR checklist.
