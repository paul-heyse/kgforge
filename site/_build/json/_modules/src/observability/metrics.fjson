{"parents": [{"link": "../../../", "title": "Module code"}], "title": "src.observability.metrics", "body": "<h1>Source code for src.observability.metrics</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"linenos\"> 1</span><span class=\"sd\">&quot;&quot;&quot;Module for observability.metrics.&quot;&quot;&quot;</span>\n<span class=\"linenos\"> 2</span>\n<span class=\"linenos\"> 3</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">__future__</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">annotations</span>\n<span class=\"linenos\"> 4</span>\n<span class=\"linenos\"> 5</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">collections.abc</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Callable</span>\n<span class=\"linenos\"> 6</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">TYPE_CHECKING</span><span class=\"p\">,</span> <span class=\"n\">cast</span>\n<span class=\"linenos\"> 7</span>\n<span class=\"linenos\"> 8</span><span class=\"k\">if</span> <span class=\"n\">TYPE_CHECKING</span><span class=\"p\">:</span>  <span class=\"c1\"># pragma: no cover - import only for type checking</span>\n<span class=\"linenos\"> 9</span>    <span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">prometheus_client</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Counter</span> <span class=\"k\">as</span> <span class=\"n\">_CounterType</span>\n<span class=\"linenos\">10</span>    <span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">prometheus_client</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Gauge</span> <span class=\"k\">as</span> <span class=\"n\">_GaugeType</span>\n<span class=\"linenos\">11</span>    <span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">prometheus_client</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Histogram</span> <span class=\"k\">as</span> <span class=\"n\">_HistogramType</span>\n<span class=\"linenos\">12</span>\n<div class=\"viewcode-block\" id=\"CounterFactory\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/observability/metrics/#src.observability.metrics.CounterFactory\">[docs]</a>\n<span class=\"linenos\">13</span>    <span class=\"n\">CounterFactory</span> <span class=\"o\">=</span> <span class=\"n\">Callable</span><span class=\"p\">[</span><span class=\"o\">...</span><span class=\"p\">,</span> <span class=\"n\">_CounterType</span><span class=\"p\">]</span></div>\n\n<span class=\"linenos\">14</span>    <span class=\"n\">GaugeFactory</span> <span class=\"o\">=</span> <span class=\"n\">Callable</span><span class=\"p\">[</span><span class=\"o\">...</span><span class=\"p\">,</span> <span class=\"n\">_GaugeType</span><span class=\"p\">]</span>\n<span class=\"linenos\">15</span>    <span class=\"n\">HistogramFactory</span> <span class=\"o\">=</span> <span class=\"n\">Callable</span><span class=\"p\">[</span><span class=\"o\">...</span><span class=\"p\">,</span> <span class=\"n\">_HistogramType</span><span class=\"p\">]</span>\n<span class=\"linenos\">16</span><span class=\"k\">else</span><span class=\"p\">:</span>  <span class=\"c1\"># pragma: no cover - runtime fallback types</span>\n<span class=\"linenos\">17</span>    <span class=\"n\">CounterFactory</span> <span class=\"o\">=</span> <span class=\"n\">Callable</span><span class=\"p\">[</span><span class=\"o\">...</span><span class=\"p\">,</span> <span class=\"nb\">object</span><span class=\"p\">]</span>\n<span class=\"linenos\">18</span>    <span class=\"n\">GaugeFactory</span> <span class=\"o\">=</span> <span class=\"n\">Callable</span><span class=\"p\">[</span><span class=\"o\">...</span><span class=\"p\">,</span> <span class=\"nb\">object</span><span class=\"p\">]</span>\n<span class=\"linenos\">19</span>    <span class=\"n\">HistogramFactory</span> <span class=\"o\">=</span> <span class=\"n\">Callable</span><span class=\"p\">[</span><span class=\"o\">...</span><span class=\"p\">,</span> <span class=\"nb\">object</span><span class=\"p\">]</span>\n<span class=\"linenos\">20</span>\n<span class=\"linenos\">21</span><span class=\"k\">try</span><span class=\"p\">:</span>\n<span class=\"linenos\">22</span>    <span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">prometheus_client</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Counter</span> <span class=\"k\">as</span> <span class=\"n\">_PromCounter</span>\n<span class=\"linenos\">23</span>    <span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">prometheus_client</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Gauge</span> <span class=\"k\">as</span> <span class=\"n\">_PromGauge</span>\n<span class=\"linenos\">24</span>    <span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">prometheus_client</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Histogram</span> <span class=\"k\">as</span> <span class=\"n\">_PromHistogram</span>\n<span class=\"linenos\">25</span><span class=\"k\">except</span> <span class=\"ne\">Exception</span><span class=\"p\">:</span>  <span class=\"c1\"># pragma: no cover - minimal no-op fallbacks</span>\n<span class=\"linenos\">26</span>\n<span class=\"linenos\">27</span>    <span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">_NoopMetric</span><span class=\"p\">:</span>\n<span class=\"linenos\">28</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Minimal stand-in when Prometheus client is unavailable.&quot;&quot;&quot;</span>\n<span class=\"linenos\">29</span>\n<span class=\"linenos\">30</span>        <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">labels</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">_NoopMetric</span><span class=\"p\">:</span>\n<span class=\"linenos\">31</span><span class=\"w\">            </span><span class=\"sd\">&quot;&quot;&quot;Return self to mimic the Prometheus API.&quot;&quot;&quot;</span>\n<span class=\"linenos\">32</span>            <span class=\"k\">return</span> <span class=\"bp\">self</span>\n<span class=\"linenos\">33</span>\n<span class=\"linenos\">34</span>        <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">observe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<span class=\"linenos\">35</span><span class=\"w\">            </span><span class=\"sd\">&quot;&quot;&quot;Ignore observation calls.&quot;&quot;&quot;</span>\n<span class=\"linenos\">36</span>            <span class=\"k\">return</span>\n<span class=\"linenos\">37</span>\n<span class=\"linenos\">38</span>        <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">inc</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<span class=\"linenos\">39</span><span class=\"w\">            </span><span class=\"sd\">&quot;&quot;&quot;Ignore counter increments.&quot;&quot;&quot;</span>\n<span class=\"linenos\">40</span>            <span class=\"k\">return</span>\n<span class=\"linenos\">41</span>\n<span class=\"linenos\">42</span>        <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">set</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<span class=\"linenos\">43</span><span class=\"w\">            </span><span class=\"sd\">&quot;&quot;&quot;Ignore gauge updates.&quot;&quot;&quot;</span>\n<span class=\"linenos\">44</span>            <span class=\"k\">return</span>\n<span class=\"linenos\">45</span>\n<span class=\"linenos\">46</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">_make_noop_metric</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">:</span> <span class=\"nb\">object</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">_NoopMetric</span><span class=\"p\">:</span>\n<span class=\"linenos\">47</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Return a no-op metric when Prometheus is unavailable.&quot;&quot;&quot;</span>\n<span class=\"linenos\">48</span>        <span class=\"k\">return</span> <span class=\"n\">_NoopMetric</span><span class=\"p\">()</span>\n<span class=\"linenos\">49</span>\n<span class=\"linenos\">50</span>    <span class=\"n\">Counter</span> <span class=\"o\">=</span> <span class=\"n\">cast</span><span class=\"p\">(</span><span class=\"n\">CounterFactory</span><span class=\"p\">,</span> <span class=\"n\">_make_noop_metric</span><span class=\"p\">)</span>\n<span class=\"linenos\">51</span>    <span class=\"n\">Gauge</span> <span class=\"o\">=</span> <span class=\"n\">cast</span><span class=\"p\">(</span><span class=\"n\">GaugeFactory</span><span class=\"p\">,</span> <span class=\"n\">_make_noop_metric</span><span class=\"p\">)</span>\n<span class=\"linenos\">52</span>    <span class=\"n\">Histogram</span> <span class=\"o\">=</span> <span class=\"n\">cast</span><span class=\"p\">(</span><span class=\"n\">HistogramFactory</span><span class=\"p\">,</span> <span class=\"n\">_make_noop_metric</span><span class=\"p\">)</span>\n<span class=\"linenos\">53</span><span class=\"k\">else</span><span class=\"p\">:</span>\n<span class=\"linenos\">54</span>    <span class=\"n\">Counter</span> <span class=\"o\">=</span> <span class=\"n\">cast</span><span class=\"p\">(</span><span class=\"n\">CounterFactory</span><span class=\"p\">,</span> <span class=\"n\">_PromCounter</span><span class=\"p\">)</span>\n<span class=\"linenos\">55</span>    <span class=\"n\">Gauge</span> <span class=\"o\">=</span> <span class=\"n\">cast</span><span class=\"p\">(</span><span class=\"n\">GaugeFactory</span><span class=\"p\">,</span> <span class=\"n\">_PromGauge</span><span class=\"p\">)</span>\n<span class=\"linenos\">56</span>    <span class=\"n\">Histogram</span> <span class=\"o\">=</span> <span class=\"n\">cast</span><span class=\"p\">(</span><span class=\"n\">HistogramFactory</span><span class=\"p\">,</span> <span class=\"n\">_PromHistogram</span><span class=\"p\">)</span>\n<span class=\"linenos\">57</span>\n<div class=\"viewcode-block\" id=\"pdf_download_success_total\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/observability/metrics/#src.observability.metrics.pdf_download_success_total\">[docs]</a>\n<span class=\"linenos\">58</span><span class=\"n\">pdf_download_success_total</span> <span class=\"o\">=</span> <span class=\"n\">Counter</span><span class=\"p\">(</span><span class=\"s2\">&quot;pdf_download_success_total&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Successful OA PDF downloads&quot;</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"pdf_download_failure_total\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/observability/metrics/#src.observability.metrics.pdf_download_failure_total\">[docs]</a>\n<span class=\"linenos\">59</span><span class=\"n\">pdf_download_failure_total</span> <span class=\"o\">=</span> <span class=\"n\">Counter</span><span class=\"p\">(</span>\n<span class=\"linenos\">60</span>    <span class=\"s2\">&quot;pdf_download_failure_total&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Failed OA PDF downloads&quot;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s2\">&quot;reason&quot;</span><span class=\"p\">]</span>\n<span class=\"linenos\">61</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"search_total_latency_ms\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/observability/metrics/#src.observability.metrics.search_total_latency_ms\">[docs]</a>\n<span class=\"linenos\">62</span><span class=\"n\">search_total_latency_ms</span> <span class=\"o\">=</span> <span class=\"n\">Histogram</span><span class=\"p\">(</span><span class=\"s2\">&quot;search_total_latency_ms&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;End-to-end /search latency (ms)&quot;</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"faiss_search_latency_ms\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/observability/metrics/#src.observability.metrics.faiss_search_latency_ms\">[docs]</a>\n<span class=\"linenos\">63</span><span class=\"n\">faiss_search_latency_ms</span> <span class=\"o\">=</span> <span class=\"n\">Histogram</span><span class=\"p\">(</span><span class=\"s2\">&quot;faiss_search_latency_ms&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;FAISS search latency (ms)&quot;</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"bm25_queries_total\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/observability/metrics/#src.observability.metrics.bm25_queries_total\">[docs]</a>\n<span class=\"linenos\">64</span><span class=\"n\">bm25_queries_total</span> <span class=\"o\">=</span> <span class=\"n\">Counter</span><span class=\"p\">(</span><span class=\"s2\">&quot;bm25_queries_total&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;BM25 queries issued&quot;</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"splade_queries_total\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/observability/metrics/#src.observability.metrics.splade_queries_total\">[docs]</a>\n<span class=\"linenos\">65</span><span class=\"n\">splade_queries_total</span> <span class=\"o\">=</span> <span class=\"n\">Counter</span><span class=\"p\">(</span><span class=\"s2\">&quot;splade_queries_total&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;SPLADE queries issued&quot;</span><span class=\"p\">)</span></div>\n\n</pre></div>", "current_page_name": "_modules/src/observability/metrics", "sidebars": ["sidebar-nav-bs.html"], "alabaster_version": "1.0.0", "alabaster_version_info": [1, 0, 0], "theme_show_toc_level": 1, "generate_toctree_html": "<functools._lru_cache_wrapper object at 0x725743950250>", "generate_toc_html": "<functools._lru_cache_wrapper object at 0x725743950eb0>", "theme_version": "0.16.1", "theme_logo": {"image_relative": {}}}