
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../251025_FAISS_whl_overview/">
      
      
        <link rel="next" href="../numpy-docstring-migration/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>High-level architecture - kgfoundry</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementation-grade-architecture-overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="kgfoundry" class="md-header__button md-logo" aria-label="kgfoundry" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            kgfoundry
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              High-level architecture
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="kgfoundry" class="md-nav__button md-logo" aria-label="kgfoundry" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    kgfoundry
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../how-to/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    How-to
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            How-to
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/contributing-gallery-examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gallery workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/read-package-readmes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Read package READMEs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Explanations
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Explanations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../251025_FAISS_whl_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAISS wheel overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    High-level architecture
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    High-level architecture
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-big-picture-endtoend-singlebox" class="md-nav__link">
    <span class="md-ellipsis">
      0) Big picture (end‑to‑end, single‑box)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-design-principles-concretized" class="md-nav__link">
    <span class="md-ellipsis">
      1) Design principles (concretized)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-repository-layout-monorepo-independently-ownable-packages" class="md-nav__link">
    <span class="md-ellipsis">
      2) Repository layout (monorepo; independently ownable packages)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-core-data-contracts-pydantic-v2-contentaddressed-ids" class="md-nav__link">
    <span class="md-ellipsis">
      3) Core data contracts (Pydantic v2; content‑addressed IDs)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-storage-layers-adapters-ports" class="md-nav__link">
    <span class="md-ellipsis">
      4) Storage layers &amp; adapters (ports)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-orchestration-prefect-2x-all-local" class="md-nav__link">
    <span class="md-ellipsis">
      5) Orchestration (Prefect 2.x; all local)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-harvesters-pdf-download-pyalex-first-resilient-fallbacks" class="md-nav__link">
    <span class="md-ellipsis">
      6) Harvesters &amp; PDF download (PyAlex first; resilient fallbacks)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-pdf-doctags-docling-vlm-granitedocling" class="md-nav__link">
    <span class="md-ellipsis">
      7) PDF → DocTags (Docling VLM Granite‑Docling)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-chunking-docling-hybridchunker" class="md-nav__link">
    <span class="md-ellipsis">
      8) Chunking (Docling HybridChunker)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-dense-embeddings-qwen3embedding4b-2560dim-vllm" class="md-nav__link">
    <span class="md-ellipsis">
      9) Dense embeddings (Qwen3‑Embedding‑4B @ 2560‑dim, vLLM)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-sparse-embeddings-indices-spladev3-gpu-bm25" class="md-nav__link">
    <span class="md-ellipsis">
      10) Sparse embeddings &amp; indices (SPLADE‑v3 GPU + BM25)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-faiss-gpu-with-cuvs-cuda-13" class="md-nav__link">
    <span class="md-ellipsis">
      11) FAISS (GPU with cuVS), CUDA 13
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-ontology-ingestion-concept-encoders" class="md-nav__link">
    <span class="md-ellipsis">
      12) Ontology ingestion &amp; concept encoders
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-linker-chunkconcept-calibrated" class="md-nav__link">
    <span class="md-ellipsis">
      13) Linker (chunk→concept), calibrated
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-knowledge-graph-neo4j-local" class="md-nav__link">
    <span class="md-ellipsis">
      14) Knowledge Graph (Neo4j, local)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-hybrid-search-api-fastapi-local" class="md-nav__link">
    <span class="md-ellipsis">
      15) Hybrid search API (FastAPI, local)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-configuration-yaml-singlebox-defaults" class="md-nav__link">
    <span class="md-ellipsis">
      16) Configuration (YAML; single‑box defaults)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-duckdb-141-schema-views-full-fidelity" class="md-nav__link">
    <span class="md-ellipsis">
      17) DuckDB (≥ 1.4.1) schema &amp; views (full fidelity)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-vllm-nginx-single-logical-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      18) vLLM &amp; Nginx (single logical endpoint)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-implementation-skeletons-selected" class="md-nav__link">
    <span class="md-ellipsis">
      19) Implementation skeletons (selected)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19) Implementation skeletons (selected)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#191-downloader-pyalex-fallbacks" class="md-nav__link">
    <span class="md-ellipsis">
      19.1 Downloader (PyAlex + fallbacks)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#192-doctags-conversion" class="md-nav__link">
    <span class="md-ellipsis">
      19.2 DocTags conversion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#193-chunking" class="md-nav__link">
    <span class="md-ellipsis">
      19.3 Chunking
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#194-dense-embeddings-qwen3-2560d-via-vllm" class="md-nav__link">
    <span class="md-ellipsis">
      19.4 Dense embeddings (Qwen3 2560‑d via vLLM)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#195-spladev3-encoder-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      19.5 SPLADE‑v3 encoder (GPU)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#196-faiss-index-gpu-cuvs" class="md-nav__link">
    <span class="md-ellipsis">
      19.6 FAISS index (GPU + cuVS)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#197-hybrid-retrieval-rerank-search_api" class="md-nav__link">
    <span class="md-ellipsis">
      19.7 Hybrid retrieval &amp; rerank (search_api)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-quality-gates-evaluation-ci" class="md-nav__link">
    <span class="md-ellipsis">
      20) Quality gates, evaluation &amp; CI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-security-licensing-governance-local" class="md-nav__link">
    <span class="md-ellipsis">
      21) Security, licensing, governance (local)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-capacity-sizing-with-2560dim" class="md-nav__link">
    <span class="md-ellipsis">
      22) Capacity &amp; sizing with 2560‑dim
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-operational-runbooks" class="md-nav__link">
    <span class="md-ellipsis">
      23) Operational runbooks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-workstreams-implementation-plans-deliverables" class="md-nav__link">
    <span class="md-ellipsis">
      24) Workstreams (implementation plans &amp; deliverables)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#25-coding-standards-bestinclass-python-practices" class="md-nav__link">
    <span class="md-ellipsis">
      25) Coding standards &amp; best‑in‑class Python practices
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../numpy-docstring-migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NumPy docstring migration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../architecture/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Decision records
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Decision records
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/adr/0001-record-architecture-decisions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR 0001 – Record architecture decisions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/adr/0002-hexagonal-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR 0002 – Hexagonal architecture
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Policies
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Policies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/visibility-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visibility policy
    
  </span>
  
    
  
  
    <span class="md-status md-status--stable"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/graphs/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/test-matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Test matrix
    
  </span>
  

      </a>
    </li>
  

              
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Observability
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Observability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/observability/logs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/observability/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics catalog
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/observability/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tracing notes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/observability/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service configuration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Schemas
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/docling/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Docling
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Docling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/docling/canonicalizer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Canonicalizer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/docling/hybrid/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hybrid reader
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/docling/vlm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VLM adapters
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/download/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Download
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Download
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/download/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI tooling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/download/harvester/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Harvester
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/embeddings_dense/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Embeddings (dense)
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            Embeddings (dense)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/embeddings_dense/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/embeddings_dense/qwen3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qwen3 adapter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/embeddings_sparse/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Embeddings (sparse)
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            Embeddings (sparse)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/embeddings_sparse/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/embeddings_sparse/bm25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BM25 adapter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/embeddings_sparse/splade/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SPLADE adapter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kf_common/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KF Common
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/kg_builder/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    KG Builder
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_7" id="__nav_7_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_7">
            <span class="md-nav__icon md-icon"></span>
            KG Builder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kg_builder/mock_kg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mock KG
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kg_builder/neo4j_store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Neo4j store
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kgfoundry package
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/kgfoundry_common/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    kgfoundry_common
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_9" id="__nav_7_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_9">
            <span class="md-nav__icon md-icon"></span>
            kgfoundry_common
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry_common/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry_common/errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Error types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry_common/exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exceptions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry_common/ids/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Identifier models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry_common/logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry_common/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry_common/navmap_types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Navmap types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/kgfoundry_common/parquet_io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parquet IO helpers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/linking/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Linking
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_10" id="__nav_7_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_10">
            <span class="md-nav__icon md-icon"></span>
            Linking
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/linking/calibration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Calibration utilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/linking/linker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linker implementations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/observability/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Observability SDK
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_11" id="__nav_7_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_11">
            <span class="md-nav__icon md-icon"></span>
            Observability SDK
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/observability/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics helpers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_12" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/ontology/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Ontology
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_12" id="__nav_7_12_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_12">
            <span class="md-nav__icon md-icon"></span>
            Ontology
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/ontology/catalog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Catalog helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/ontology/loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Loader utilities
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_13" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/orchestration/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Orchestration
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_13" id="__nav_7_13_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_13">
            <span class="md-nav__icon md-icon"></span>
            Orchestration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI entry points
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/fixture_flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fixture flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/flows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flow helpers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_14" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/registry/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Registry
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_14" id="__nav_7_14_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_14">
            <span class="md-nav__icon md-icon"></span>
            Registry
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/registry/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/registry/duckdb_registry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DuckDB registry
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/registry/helper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Helper utilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/registry/migrate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migration helpers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_15" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/search_api/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Search API
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_15" id="__nav_7_15_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_15">
            <span class="md-nav__icon md-icon"></span>
            Search API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Application
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/bm25_index/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BM25 index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/faiss_adapter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAISS adapter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/fixture_index/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fixture index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/fusion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fusion helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/kg_mock/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge graph mock
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Schemas
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_api/splade_index/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SPLADE index
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_16" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/search_client/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Search client
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_16" id="__nav_7_16_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_16">
            <span class="md-nav__icon md-icon"></span>
            Search client
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search_client/client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Client API
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_17" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/tests/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Test harness
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_17" id="__nav_7_17_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_17">
            <span class="md-nav__icon md-icon"></span>
            Test harness
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tests/conftest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Conftest utilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tests/docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documentation helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tests/mock_servers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mock servers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tests/test_e2e_smoke/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    End-to-end smoke tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tests/test_imports/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Import tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tests/tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tooling helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tests/unit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unit tests
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_18" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/vectorstore_faiss/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Vectorstore FAISS
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_18" id="__nav_7_18_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_18">
            <span class="md-nav__icon md-icon"></span>
            Vectorstore FAISS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/vectorstore_faiss/gpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GPU adapter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-big-picture-endtoend-singlebox" class="md-nav__link">
    <span class="md-ellipsis">
      0) Big picture (end‑to‑end, single‑box)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-design-principles-concretized" class="md-nav__link">
    <span class="md-ellipsis">
      1) Design principles (concretized)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-repository-layout-monorepo-independently-ownable-packages" class="md-nav__link">
    <span class="md-ellipsis">
      2) Repository layout (monorepo; independently ownable packages)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-core-data-contracts-pydantic-v2-contentaddressed-ids" class="md-nav__link">
    <span class="md-ellipsis">
      3) Core data contracts (Pydantic v2; content‑addressed IDs)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-storage-layers-adapters-ports" class="md-nav__link">
    <span class="md-ellipsis">
      4) Storage layers &amp; adapters (ports)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-orchestration-prefect-2x-all-local" class="md-nav__link">
    <span class="md-ellipsis">
      5) Orchestration (Prefect 2.x; all local)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-harvesters-pdf-download-pyalex-first-resilient-fallbacks" class="md-nav__link">
    <span class="md-ellipsis">
      6) Harvesters &amp; PDF download (PyAlex first; resilient fallbacks)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-pdf-doctags-docling-vlm-granitedocling" class="md-nav__link">
    <span class="md-ellipsis">
      7) PDF → DocTags (Docling VLM Granite‑Docling)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-chunking-docling-hybridchunker" class="md-nav__link">
    <span class="md-ellipsis">
      8) Chunking (Docling HybridChunker)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-dense-embeddings-qwen3embedding4b-2560dim-vllm" class="md-nav__link">
    <span class="md-ellipsis">
      9) Dense embeddings (Qwen3‑Embedding‑4B @ 2560‑dim, vLLM)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-sparse-embeddings-indices-spladev3-gpu-bm25" class="md-nav__link">
    <span class="md-ellipsis">
      10) Sparse embeddings &amp; indices (SPLADE‑v3 GPU + BM25)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-faiss-gpu-with-cuvs-cuda-13" class="md-nav__link">
    <span class="md-ellipsis">
      11) FAISS (GPU with cuVS), CUDA 13
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-ontology-ingestion-concept-encoders" class="md-nav__link">
    <span class="md-ellipsis">
      12) Ontology ingestion &amp; concept encoders
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-linker-chunkconcept-calibrated" class="md-nav__link">
    <span class="md-ellipsis">
      13) Linker (chunk→concept), calibrated
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-knowledge-graph-neo4j-local" class="md-nav__link">
    <span class="md-ellipsis">
      14) Knowledge Graph (Neo4j, local)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-hybrid-search-api-fastapi-local" class="md-nav__link">
    <span class="md-ellipsis">
      15) Hybrid search API (FastAPI, local)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-configuration-yaml-singlebox-defaults" class="md-nav__link">
    <span class="md-ellipsis">
      16) Configuration (YAML; single‑box defaults)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-duckdb-141-schema-views-full-fidelity" class="md-nav__link">
    <span class="md-ellipsis">
      17) DuckDB (≥ 1.4.1) schema &amp; views (full fidelity)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-vllm-nginx-single-logical-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      18) vLLM &amp; Nginx (single logical endpoint)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-implementation-skeletons-selected" class="md-nav__link">
    <span class="md-ellipsis">
      19) Implementation skeletons (selected)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19) Implementation skeletons (selected)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#191-downloader-pyalex-fallbacks" class="md-nav__link">
    <span class="md-ellipsis">
      19.1 Downloader (PyAlex + fallbacks)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#192-doctags-conversion" class="md-nav__link">
    <span class="md-ellipsis">
      19.2 DocTags conversion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#193-chunking" class="md-nav__link">
    <span class="md-ellipsis">
      19.3 Chunking
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#194-dense-embeddings-qwen3-2560d-via-vllm" class="md-nav__link">
    <span class="md-ellipsis">
      19.4 Dense embeddings (Qwen3 2560‑d via vLLM)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#195-spladev3-encoder-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      19.5 SPLADE‑v3 encoder (GPU)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#196-faiss-index-gpu-cuvs" class="md-nav__link">
    <span class="md-ellipsis">
      19.6 FAISS index (GPU + cuVS)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#197-hybrid-retrieval-rerank-search_api" class="md-nav__link">
    <span class="md-ellipsis">
      19.7 Hybrid retrieval &amp; rerank (search_api)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-quality-gates-evaluation-ci" class="md-nav__link">
    <span class="md-ellipsis">
      20) Quality gates, evaluation &amp; CI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-security-licensing-governance-local" class="md-nav__link">
    <span class="md-ellipsis">
      21) Security, licensing, governance (local)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-capacity-sizing-with-2560dim" class="md-nav__link">
    <span class="md-ellipsis">
      22) Capacity &amp; sizing with 2560‑dim
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-operational-runbooks" class="md-nav__link">
    <span class="md-ellipsis">
      23) Operational runbooks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-workstreams-implementation-plans-deliverables" class="md-nav__link">
    <span class="md-ellipsis">
      24) Workstreams (implementation plans &amp; deliverables)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#25-coding-standards-bestinclass-python-practices" class="md-nav__link">
    <span class="md-ellipsis">
      25) Coding standards &amp; best‑in‑class Python practices
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="implementation-grade-architecture-overview">Implementation-Grade Architecture Overview</h1>
<p>Below is the <strong>fully elaborated, implementation‑grade architecture</strong> for your end‑to‑end, single‑machine system. It updates <strong>every topic</strong> from the original plan and adds all <strong>new constraints</strong> you set:</p>
<ul>
<li><strong>OS/Host</strong>: Ubuntu 24.04 (single box, no external servers).</li>
<li><strong>GPU</strong>: NVIDIA RTX 5090 (CUDA <strong>13.0</strong> toolchain).</li>
<li><strong>CPU/RAM</strong>: AMD 9950X (16 cores), 192 GB RAM.</li>
<li><strong>Python</strong>: <strong>3.13</strong>.</li>
<li><strong>PyTorch</strong>: <strong>2.9</strong> (CUDA 13 build).</li>
<li><strong>vLLM</strong>: latest <strong>pre‑release</strong> that supports CUDA 13.</li>
<li><strong>DuckDB</strong>: <strong>≥ 1.4.1</strong> (interpreting your “1.41” as <strong>1.4.1</strong>).</li>
<li><strong>Dense embeddings</strong>: <strong>Qwen3‑Embedding‑4B</strong> at <strong>2560‑dimensional</strong> output.</li>
<li><strong>Sparse embeddings</strong>: <strong>BM25</strong> + <strong>SPLADE‑v3</strong> (GPU).</li>
<li><strong>PDF→DocTags &amp; chunking</strong>: <strong>Docling VLM (Granite‑Docling)</strong> + <strong>Docling HybridChunker</strong>.</li>
<li><strong>All embeddings in Parquet</strong> (no JSONL at rest).</li>
<li><strong>Vector indexing &amp; ops</strong>: <strong>FAISS GPU</strong> with <strong>cuVS</strong> enabled.</li>
<li><strong>Model serving</strong>: a <strong>single logical endpoint</strong> fronting <strong>two local vLLM processes</strong> (Granite‑Docling VLM + Qwen3‑Embedding‑4B), routed by <strong>Nginx</strong> (necessary because one vLLM process ≙ one base model).</li>
<li><strong>Registry</strong>: all artifacts (PDFs, DocTags, chunks, embeddings, indices, ontologies, links) registered in local <strong>DuckDB</strong>.</li>
</ul>
<hr />
<h2 id="0-big-picture-endtoend-singlebox">0) Big picture (end‑to‑end, single‑box)</h2>
<pre><code>Topic → (PyAlex) Harvest &amp; OA PDF Download (with fallbacks)
     → Docling VLM (Granite‑Docling) → DocTags
     → Docling HybridChunker → Chunk Parquet
     → Dense (Qwen3‑Embedding‑4B, 2560‑d via vLLM) → Parquet → FAISS (GPU, cuVS)
     → Sparse (SPLADE‑v3, GPU → Parquet → Lucene impact) + BM25 (Lucene)
     → Ontology ingest → Concept catalog + embeddings (dense 2560‑d + SPLADE)
     → Chunk–Concept linker → Assertions (Parquet) → KG (Neo4j local)
     → Hybrid search API (FAISS + BM25 + SPLADE + KG‑aware rerank)
     → Everything registered in DuckDB (≥1.4.1)
</code></pre>
<p><strong>Architectural style</strong>: <strong>Ports &amp; Adapters (Hexagonal)</strong> + <strong>Domain contracts</strong> (Pydantic v2) + <strong>Plugin registry</strong> (entry points) + <strong>Immutable, content‑addressed artifacts</strong>. All heavy compute runs <strong>locally</strong> (no remote compute/storage).</p>
<hr />
<h2 id="1-design-principles-concretized">1) Design principles (concretized)</h2>
<ul>
<li><strong>Interface‑first</strong>: every subsystem exposes an ABC (Abstract Base Class). Impl classes are pluggable via entry‑points.</li>
<li><strong>Encapsulation &amp; cohesion</strong>: one public façade per package; internals hidden. Each module owns a single concern.</li>
<li><strong>Idempotency</strong>: outputs keyed by <strong>content hashes</strong>; re‑runs never duplicate artifacts.</li>
<li><strong>Determinism</strong>: global <code>seed=42</code>, fixed training samples for FAISS, fixed chunking parameters.</li>
<li><strong>All embeddings in Parquet</strong>: columnar, compressed with <strong>ZSTD=6</strong>, <strong>row_group=4096</strong>; <strong>no JSONL</strong> persisted.</li>
<li><strong>Observability from day one</strong>: OpenTelemetry traces; structured logs with artifact IDs; Prometheus counters/histograms.</li>
<li><strong>Local‑only</strong>: no remote indices or vector DBs; FAISS, Pyserini, Neo4j, DuckDB all on the box.</li>
<li><strong>Security (local)</strong>: vLLM bound to localhost; Nginx fronts a single endpoint; API‑key auth for the search API.</li>
</ul>
<hr />
<h2 id="2-repository-layout-monorepo-independently-ownable-packages">2) Repository layout (monorepo; independently ownable packages)</h2>
<pre><code>/src
  /kgfoundry_common            # contracts, IDs, hashing, config, utils
  /download                  # PyAlex harvester + OA PDF downloader + fallbacks
  /docling                   # VLM convert-to-DocTags + HybridChunker wrappers
  /embeddings_dense          # vLLM client, Qwen3-Embedding-4B (2560-d)
  /embeddings_sparse         # SPLADE-v3 GPU encoder (Parquet) + BM25/SPLADE indices (Pyserini)
  /vectorstore_faiss         # FAISS GPU/cuVS index build/search adapters
  /ontology                  # OWL/OBO/SKOS loaders, normalization, concept embeddings
  /linking                   # candidate gen, scoring, calibration, assertions
  /kg_builder                # Neo4j adapter; nodes/edges upsert
  /search_api                # FastAPI; hybrid retrieval + KG-aware rerank; OpenAPI
  /orchestration             # Prefect flows &amp; CLI commands (local)
  /registry                  # DuckDB schema, migrations, dataset registration
  /observability             # OTEL + Prometheus exporters
/tests
/config                      # YAML config(s), ngnix.conf, systemd units
/scripts                     # bootstrap &amp; build scripts (CUDA 13, FAISS+cuVS, vLLM)
</code></pre>
<p><strong>Packaging</strong>: <code>pyproject.toml</code> (Poetry or uv). <strong>Entry‑points</strong> register providers:</p>
<pre><code class="language-toml">[project.entry-points.kgfoundry.plugins]
dense.qwen3 = &quot;embeddings_dense.qwen3:Qwen3Embedder&quot;
sparse.splade_v3 = &quot;embeddings_sparse.splade:SPLADEv3Encoder&quot;
sparse.bm25 = &quot;embeddings_sparse.bm25:BM25Index&quot;
docling.vlm = &quot;docling.vlm:GraniteDoclingVLM&quot;
chunker.docling_hybrid = &quot;docling.hybrid:HybridChunker&quot;
vector.faiss_gpu = &quot;vectorstore_faiss.gpu:FaissGpuIndex&quot;
graph.neo4j = &quot;kg_builder.neo4j:Neo4jStore&quot;
ontology.loader = &quot;ontology.loader:OntologyLoader&quot;
</code></pre>
<hr />
<h2 id="3-core-data-contracts-pydantic-v2-contentaddressed-ids">3) Core data contracts (Pydantic v2; content‑addressed IDs)</h2>
<blockquote>
<p>Keep models lean. Payloads (large text, vectors) live in Parquet files; rows refer to them via IDs.</p>
</blockquote>
<pre><code class="language-python"># kgfoundry_common/models.py (Python 3.13, Pydantic v2)
from pydantic import BaseModel, Field, AwareDatetime
from typing import Optional, List, Dict, Literal
from dataclasses import dataclass

Id = str  # URN-like opaque IDs, stable and content-addressed

class Doc(BaseModel):
    id: Id                           # urn:doc:sha256:&lt;16b&gt;
    openalex_id: Optional[str] = None
    doi: Optional[str] = None
    arxiv_id: Optional[str] = None
    pmcid: Optional[str] = None
    title: str
    authors: List[str] = []
    pub_date: Optional[str] = None   # ISO8601
    license: Optional[str] = None
    language: Optional[str] = &quot;en&quot;
    pdf_uri: str                     # local path (e.g., /data/pdfs/&lt;id&gt;.pdf)
    source: str                      # 'openalex', 'arxiv', 'pmc', ...
    content_hash: str                # sha256 of canonical text (after DocTags-&gt;text)
    created_at: AwareDatetime

class DoctagsAsset(BaseModel):
    doc_id: Id
    doctags_uri: str                 # /data/doctags/&lt;doc_id&gt;.dt.json.zst
    pages: int
    vlm_model: str                   # granite-docling-258M
    vlm_revision: str                # 'untied' if used
    avg_logprob: Optional[float] = None
    created_at: AwareDatetime

class Chunk(BaseModel):
    id: Id                           # urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;
    doc_id: Id
    section: Optional[str]
    start_char: int
    end_char: int
    tokens: int
    doctags_span: Dict[str, int]     # {node_id, start, end}
    created_at: AwareDatetime
    dataset_id: str                  # backpointer to Parquet dataset

class DenseVectorMeta(BaseModel):
    chunk_id: Id
    model: str                       # 'Qwen3-Embedding-4B'
    run_id: str
    dim: int                         # 2560
    l2_norm: float
    created_at: AwareDatetime

class SparseVectorMeta(BaseModel):
    chunk_id: Id
    model: str                       # 'SPLADE-v3-distilbert'
    run_id: str
    nnz: int
    created_at: AwareDatetime

class Concept(BaseModel):
    id: Id                           # urn:concept:&lt;ontology&gt;:&lt;curie&gt;
    ontology: str
    pref_label: str
    alt_labels: List[str] = []
    definition: Optional[str] = None
    parents: List[Id] = []
    meta: Dict[str, str] = {}

class LinkAssertion(BaseModel):
    id: Id                           # urn:assert:&lt;chunk_id&gt;:&lt;concept_id&gt;@&lt;run_id&gt;
    chunk_id: Id
    concept_id: Id
    score: float
    decision: Literal['link','reject','uncertain']
    evidence_span: Optional[str] = None
    features: Dict[str, float] = {}  # dense_sim, sparse_sim, lexical_overlap, depth_bonus
    run_id: str
    created_at: AwareDatetime
</code></pre>
<p><strong>ID scheme (deterministic)</strong></p>
<ul>
<li><code>doc_id = urn:doc:sha256:&lt;first16 bytes of sha256 canonical_text, base32&gt;</code></li>
<li><code>chunk_id = urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;</code></li>
<li><code>dense vec id = urn:vec:&lt;chunk_id&gt;:qwen3@&lt;run_id&gt;</code></li>
<li><code>sparse id = urn:sparse:&lt;chunk_id&gt;:splade_v3@&lt;run_id&gt;</code></li>
<li><code>concept id = urn:concept:&lt;ontology&gt;:&lt;curie&gt;</code></li>
<li><code>assertion id = urn:assert:&lt;chunk_id&gt;:&lt;concept_id&gt;@&lt;run_id&gt;</code></li>
</ul>
<hr />
<h2 id="4-storage-layers-adapters-ports">4) Storage layers &amp; adapters (ports)</h2>
<p><strong>VectorStore (FAISS GPU + cuVS)</strong></p>
<pre><code class="language-python">class VectorStore(Protocol):
    def train(self, train_vectors: &quot;np.ndarray&quot;, **params) -&gt; None: ...
    def add(self, keys: list[str], vectors: &quot;np.ndarray&quot;) -&gt; None: ...
    def search(self, query: &quot;np.ndarray&quot;, k: int) -&gt; list[tuple[str, float]]: ...
    def save(self, index_uri: str, idmap_uri: str) -&gt; None: ...
    def load(self, index_uri: str, idmap_uri: str) -&gt; None: ...
</code></pre>
<p><strong>SparseIndex</strong></p>
<pre><code class="language-python">class SparseIndex(Protocol):
    def build(self, docs_iterable: &quot;Iterable[SparseDoc]&quot;) -&gt; None: ...
    def search(self, query: str, k: int, fields: dict|None=None) -&gt; list[tuple[str, float]]: ...
    def stats(self) -&gt; dict: ...
</code></pre>
<p>Implementations: <strong>BM25Index</strong> (Pyserini) and <strong>SpladeImpactIndex</strong> (Pyserini).</p>
<p><strong>GraphStore</strong></p>
<pre><code class="language-python">class GraphStore(Protocol):
    def upsert_nodes(self, docs: list[Doc], concepts: list[Concept], chunks: list[Chunk]) -&gt; None: ...
    def upsert_mentions(self, assertions: list[LinkAssertion]) -&gt; None: ...
    def neighbors(self, concept_id: str, depth:int=1) -&gt; list[str]: ...
    def linked_concepts(self, chunk_id: str) -&gt; list[str]: ...
</code></pre>
<p><strong>Registry (DuckDB ≥1.4.1)</strong></p>
<ul>
<li>Provides <strong>DDL/migrations</strong>, <strong>safe registration</strong> (two‑phase commit: write Parquet → atomically register).</li>
<li>Exposes <strong>views</strong> across Parquet datasets (union_by_name).</li>
<li>Threading: default <strong>PRAGMA threads=14</strong>.</li>
</ul>
<hr />
<h2 id="5-orchestration-prefect-2x-all-local">5) Orchestration (Prefect 2.x; all local)</h2>
<p><strong>Flows</strong> (idempotent, content‑hash keyed):</p>
<ol>
<li><code>harvest_and_download(topic, years, max_works)</code></li>
<li><code>convert_to_doctags(doc_ids[])</code></li>
<li><code>chunk_with_docling(doc_ids[])</code></li>
<li><code>embed_dense_qwen3(chunk_dataset_id)</code></li>
<li><code>encode_splade_v3(chunk_dataset_id)</code></li>
<li><code>build_bm25_index(chunk_dataset_id)</code></li>
<li><code>build_faiss_index(dense_run_id)</code></li>
<li><code>ingest_ontologies(ontology_specs[])</code></li>
<li><code>embed_concepts(ontology_id)</code></li>
<li><code>link_chunks_to_concepts(chunk_dataset_id, ontology_id)</code></li>
<li><code>upsert_kg(link_run_id)</code></li>
<li><code>serve_search_api()</code> (starts uvicorn if not already)</li>
</ol>
<p><strong>Events</strong> recorded in <code>registry.pipeline_events</code>: <code>DocumentIngested</code>, <code>DoctagsReady</code>, <code>ChunksCreated</code>, <code>DenseEmbedded</code>, <code>SpladeEncoded</code>, <code>BM25Built</code>, <code>FAISSBuilt</code>, <code>OntologyLoaded</code>, <code>ConceptEmbeddingsReady</code>, <code>LinkerRun</code>, <code>KGUpdated</code>.</p>
<p><strong>Concurrency defaults</strong>:</p>
<ul>
<li>Downloader 8 parallel fetches;</li>
<li>VLM 2 docs in flight;</li>
<li>Dense/SPLADE batchers tuned to ~80% VRAM;</li>
<li>FAISS build: 2 shards concurrently;</li>
<li>All others CPU‑bound threads = 14.</li>
</ul>
<hr />
<h2 id="6-harvesters-pdf-download-pyalex-first-resilient-fallbacks">6) Harvesters &amp; PDF download (PyAlex first; resilient fallbacks)</h2>
<p><strong>Workflow</strong></p>
<ul>
<li><strong>Search</strong>: PyAlex (OpenAlex) by <code>topic</code> across title/abstract/fulltext; filter OA flags; optionally by year range.</li>
<li>Extract candidate OA locations: <code>best_oa_location</code>, <code>primary_location</code>, <code>locations[]</code>, DOI, arXiv id, pmcid.</li>
<li>
<p><strong>Download resolution</strong> (in order):</p>
</li>
<li>
<p>OpenAlex <code>best_oa_location.pdf_url</code>.</p>
</li>
<li>Any <code>locations[].pdf_url</code> with <code>is_oa=true</code> favoring <code>publishedVersion</code> or <code>acceptedVersion</code>.</li>
<li><strong>Unpaywall</strong> by DOI (<code>url_for_pdf</code>) — requires configured contact email and rate limits.</li>
<li>
<p><strong>Source‑specific</strong>:</p>
<ul>
<li>arXiv → <code>https://arxiv.org/pdf/&lt;id&gt;.pdf</code></li>
<li>PubMed Central → <code>https://www.ncbi.nlm.nih.gov/pmc/articles/&lt;pmcid&gt;/pdf</code></li>
<li><strong>License guard</strong>: accept only OA‑compatible licenses; persist license string on <code>Doc</code>.</li>
<li><strong>Download</strong>: 8 concurrency; 60s timeout; 3 retries w/ exp backoff; <code>User-Agent</code> includes contact/email.</li>
<li><strong>Storage</strong>: <code>/data/pdfs/&lt;doc_id&gt;.pdf</code> where <code>doc_id</code> derived later from canonical text (post‑DocTags). Temporarily name by OpenAlex ID then rename after canonicalization.</li>
<li><strong>Registration</strong>: each successful PDF produces a <code>documents</code> row (openalex id, doi, license, pdf_uri, source).</li>
</ul>
</li>
</ul>
<hr />
<h2 id="7-pdf-doctags-docling-vlm-granitedocling">7) PDF → <strong>DocTags</strong> (Docling VLM Granite‑Docling)</h2>
<ul>
<li><strong>Serving</strong>: vLLM pre‑release (CUDA 13) process <strong>#1</strong> on localhost:8001.</li>
<li><strong>Router</strong>: Nginx exposes <code>/vlm/* → 8001</code>.</li>
<li><strong>Defaults</strong>: DPI=220, page_batch=8, bf16 if supported, fallback fp16.</li>
<li><strong>Quality gate</strong>: if avg token logprob &lt; 0.5 on a page → fallback OCR for that page; provenance notes retained.</li>
<li><strong>Timeouts</strong>: 120s per 100 pages; max 2000 pages.</li>
<li><strong>Outputs</strong>: <code>/data/doctags/&lt;doc_id&gt;.dt.json.zst</code>.</li>
<li><strong>Registration</strong>: DuckDB <code>doctags</code> with pages, model, revision (<code>untied</code> if applicable), avg_logprob.</li>
</ul>
<blockquote>
<p>We intentionally present one <strong>logical</strong> model endpoint via Nginx, but use <strong>two</strong> local vLLM processes (one model each) due to vLLM’s one‑model‑per‑process design.</p>
</blockquote>
<hr />
<h2 id="8-chunking-docling-hybridchunker">8) Chunking (Docling <strong>HybridChunker</strong>)</h2>
<ul>
<li><strong>Parameters</strong>: <code>target_tokens=400</code>, <code>overlap=80</code>, <code>min_tokens=120</code>, <code>max_tokens=480</code>.</li>
<li>Structure‑aware segmentation first; spillover via sliding windows.</li>
<li>Captures <code>doctags_span</code> and <code>start_char/end_char</code> for explainable highlights.</li>
<li><strong>Parquet dataset</strong>: <code>parquet/chunks/model=docling_hybrid/run=&lt;run_id&gt;/part-*.parquet</code>
  <strong>Schema</strong>:</li>
</ul>
<p><code>chunk_id: string
  doc_id: string
  section: string
  start_char: int32
  end_char: int32
  doctags_span: struct&lt;node_id:string,start:int32,end:int32&gt;
  text: string
  tokens: int32
  created_at: timestamp</code>
* Register resulting dataset in <code>registry.datasets</code> (kind='chunks') and each row in <code>chunks</code>.</p>
<hr />
<h2 id="9-dense-embeddings-qwen3embedding4b-2560dim-vllm">9) Dense embeddings (Qwen3‑Embedding‑4B @ <strong>2560‑dim</strong>, vLLM)</h2>
<ul>
<li><strong>Serving</strong>: vLLM pre‑release process <strong>#2</strong> on localhost:8002; router maps <code>/v1/embeddings → 8002</code>.</li>
<li><strong>Embedding length</strong>: <strong>2560</strong> (model supports 32–2560; set explicitly).</li>
<li><strong>Batching</strong>: automatic; target <strong>≤ 80%</strong> of available VRAM.</li>
<li><strong>Normalization</strong>: L2; store norm (float32).</li>
<li><strong>Parquet dataset</strong>: <code>parquet/dense/model=Qwen3-Embedding-4B/run=&lt;run_id&gt;/part-*.parquet</code>
  <strong>Schema</strong>:</li>
</ul>
<p><code>chunk_id: string
  model: string              -- 'Qwen3-Embedding-4B'
  run_id: string
  dim: int16                 -- 2560
  vector: list&lt;float&gt;        -- length==2560 (float32 on disk)
  l2_norm: float
  created_at: timestamp</code>
* <strong>Compression</strong>: ZSTD=6; row_group=4096; dictionary encoding on categorical cols.</p>
<hr />
<h2 id="10-sparse-embeddings-indices-spladev3-gpu-bm25">10) Sparse embeddings &amp; indices (SPLADE‑v3 <strong>GPU</strong> + BM25)</h2>
<ul>
<li>
<p><strong>SPLADE‑v3 encoder</strong>: <code>naver/splade-v3-distilbert</code></p>
</li>
<li>
<p>CUDA (Torch 2.9, cu130), AMP fp16, <code>max_seq_len=512</code>, <code>topK=256</code> nnz per chunk.</p>
</li>
<li>Tokenizer: distilbert WordPiece, <code>vocab_size=30522</code>.</li>
<li>
<p><strong>Parquet dataset</strong>: <code>parquet/sparse/model=SPLADE-v3-distilbert/run=&lt;run_id&gt;/part-*.parquet</code>
    <strong>Schema</strong>:</p>
<p><code>chunk_id: string
model: string
run_id: string
vocab_ids: list&lt;int32&gt;    -- sorted, unique
weights:   list&lt;float&gt;    -- same length as vocab_ids
nnz: int16
created_at: timestamp</code>
* <strong>Indexing</strong>: <strong>Lucene impact index</strong> (Pyserini).</p>
</li>
<li>
<p><strong>No JSONL at rest</strong>: a streaming adapter reads Parquet rows and writes directly to Lucene via Pyserini builders (any temporary files are ephemeral and excluded from registry).</p>
</li>
<li><strong>BM25</strong>: Pyserini (Lucene). Params: <strong>k1=0.9</strong>, <strong>b=0.4</strong>; field boosts <code>title^2.0, section^1.2, body^1.0</code>.</li>
</ul>
<hr />
<h2 id="11-faiss-gpu-with-cuvs-cuda-13">11) FAISS (GPU with <strong>cuVS</strong>), CUDA 13</h2>
<ul>
<li><strong>Install</strong>: Prefer <strong>GPU binary</strong> (wheel) built for CUDA 13 <strong>with cuVS enabled</strong>. If unavailable, build from source with <code>-DFAISS_ENABLE_GPU=ON -DFAISS_ENABLE_CUVS=ON</code>.</li>
<li><strong>Index factory (default)</strong>: <code>OPQ64,IVF8192,PQ64</code> (good for <strong>d=2560</strong>; OPQ pre‑rotation at 64; PQ m=64).</li>
<li><strong>Training</strong>: sample <strong>10M</strong> vectors or all (if fewer), seed=42.</li>
<li><strong>Search</strong>: <code>nprobe=64</code>. Codes 8‑bit per subvector.</li>
<li><strong>Memory</strong>: PQ codes ~<strong>64 B/vector</strong> (+ID/overhead ⇒ ~<strong>80–100 B/vector</strong> typical).</li>
<li><strong>Persistence</strong>: <code>.faiss</code> index + <code>.ids</code> idmap; shards ≤10M vectors each.</li>
<li><strong>Registration</strong>: rows in DuckDB <code>faiss_indexes</code> (logical index id groups shards).</li>
</ul>
<hr />
<h2 id="12-ontology-ingestion-concept-encoders">12) Ontology ingestion &amp; concept encoders</h2>
<ul>
<li><strong>Formats</strong>: OWL/RDF (TTL/RDF‑XML), OBO, SKOS.</li>
<li><strong>Normalization</strong>: lowercase, NFC, strip most punctuation, lemmatize EN, stopword‑smart; build surface forms from <code>pref_label</code>, <code>alt_labels</code>, <code>synonyms</code>, and <code>definition</code>.</li>
<li><strong>Dense concept embeddings</strong>: Qwen3‑Embedding‑4B with <strong>dim=2560</strong> (concat text: <code>pref_label | definition | 5 best synonyms</code>).</li>
<li><strong>Sparse concept embeddings</strong>: SPLADE‑v3 with <strong>topK=128</strong>.</li>
<li><strong>Parquet datasets</strong> mirroring chunk schemas; registered in <code>concept_embeddings</code>.</li>
</ul>
<hr />
<h2 id="13-linker-chunkconcept-calibrated">13) Linker (chunk→concept), calibrated</h2>
<p><strong>Candidate generation</strong></p>
<ul>
<li>SPLADE concept index <strong>@100</strong> using chunk text;</li>
<li>Lexical dictionary match <strong>@50</strong> (max phrase len=6 tokens, case‑folded).</li>
</ul>
<p><strong>Feature scoring</strong></p>
<ul>
<li><code>dense_sim</code> = cosine(qwen_chunk, qwen_concept)</li>
<li><code>sparse_sim</code> = normalized SPLADE (min–max per query)</li>
<li><code>lexical_overlap</code> = matched_chars / chunk_chars (clamp [0, 0.2])</li>
<li><code>depth_bonus</code> = +0.02 × levels from root (cap +0.10)</li>
</ul>
<p><strong>Fusion &amp; decision</strong></p>
<ul>
<li><code>score = 0.55*dense + 0.35*sparse + 0.10*lexical + depth_bonus</code></li>
<li>Thresholds: <strong>link ≥ 0.62</strong>, <strong>reject ≤ 0.35</strong>, else uncertain.</li>
<li><strong>Calibration</strong>: isotonic regression stored per linker run; output <code>LinkAssertion</code> Parquet.</li>
</ul>
<hr />
<h2 id="14-knowledge-graph-neo4j-local">14) Knowledge Graph (Neo4j, local)</h2>
<p><strong>Nodes</strong></p>
<ul>
<li><code>(:Doc {doc_id, title, year, license, source, source_id})</code></li>
<li><code>(:Chunk {chunk_id, section, start_char, end_char})</code></li>
<li><code>(:Concept {concept_id, ontology, pref_label})</code></li>
</ul>
<p><strong>Relationships</strong></p>
<ul>
<li><code>(:Doc)-[:HAS_CHUNK]-&gt;(:Chunk)</code></li>
<li><code>(:Chunk)-[:MENTIONS {score, run_id, evidence_span, created_at}]-&gt;(:Concept)</code></li>
<li><code>(:Concept)-[:IS_A]-&gt;(:Concept)</code> and <code>[:RELATED_TO]</code> (from ontology).</li>
</ul>
<p><strong>Constraints &amp; indexes</strong></p>
<ul>
<li>Uniqueness on <code>doc_id</code>, <code>chunk_id</code>, <code>concept_id</code>; B‑tree index on <code>MENTIONS.score</code> and <code>MENTIONS.run_id</code>.</li>
</ul>
<hr />
<h2 id="15-hybrid-search-api-fastapi-local">15) Hybrid search API (FastAPI, local)</h2>
<p><strong>Endpoints</strong></p>
<ul>
<li><code>POST /search</code>
  Body: <code>{query: str, k?: int=10, filters?: {...}, explain?: bool=false}</code>
  Returns top chunks &amp; doc rollups with dense/sparse scores, KG boosts, spans, linked concepts.</li>
<li><code>POST /graph/concepts</code> (browse ontology)</li>
<li><code>GET /healthz</code></li>
</ul>
<p><strong>Algorithm (fixed)</strong></p>
<ol>
<li>Query embedding via Qwen3 (2560‑d) + parse lexical concept mentions.</li>
<li>Retrieve <strong>dense@200</strong> (FAISS) + <strong>sparse@200</strong> (BM25 and SPLADE).</li>
<li>Fuse via <strong>RRF(k=60)</strong>.</li>
<li>KG boosts: +0.08 for direct concept match; +0.04 for one‑hop neighbor.</li>
<li><strong>MMR</strong> (λ=0.7) at doc level.</li>
<li>Return top‑k.</li>
</ol>
<hr />
<h2 id="16-configuration-yaml-singlebox-defaults">16) Configuration (YAML; single‑box defaults)</h2>
<pre><code class="language-yaml">system:
  os: ubuntu-24.04
  threads: 14
  seed: 42
  parquet_root: /data/parquet
  artifacts_root: /data/artifacts
  duckdb_path: /data/catalog/catalog.duckdb

runtime:
  python: &quot;3.13&quot;
  cuda: &quot;13.0&quot;
  torch: &quot;2.9&quot;
  duckdb_min: &quot;1.4.1&quot;
  vllm_channel: &quot;pre-release-cuda13&quot;

network:
  nginx_port: 80
  vlm_port: 8001
  emb_port: 8002
  api_port: 8080

harvest:
  provider: pyalex
  per_page: 200
  max_works: 20000
  years: &quot;&gt;=2018&quot;
  filters:
    is_oa: true
    has_oa_published_version: true
  fallbacks:
    unpaywall: true
    arxiv: true
    pmc: true
  concurrency: 8
  timeout_sec: 60
  retries: 3

doc_conversion:
  vlm_model: ibm-granite/granite-docling-258M
  vlm_revision: untied
  endpoint: http://localhost/vlm/
  dpi: 220
  page_batch: 8
  ocr_fallback: true
  max_pages: 2000
  timeout_sec: 120

chunking:
  engine: docling_hybrid
  target_tokens: 400
  overlap_tokens: 80
  min_tokens: 120
  max_tokens: 480

dense_embedding:
  model: Qwen/Qwen3-Embedding-4B
  endpoint: http://localhost/v1/embeddings
  output_dim: 2560
  parquet_out: ${system.parquet_root}/dense/model=Qwen3-Embedding-4B/run=${run_id}

sparse_embedding:
  splade:
    model: naver/splade-v3-distilbert
    device: cuda
    amp: fp16
    max_seq_len: 512
    topk: 256
    parquet_out: ${system.parquet_root}/sparse/model=SPLADE-v3-distilbert/run=${run_id}
  bm25:
    k1: 0.9
    b: 0.4
    field_boosts: { title: 2.0, section: 1.2, body: 1.0 }
    index_dir: /data/lucene/bm25

faiss:
  index_factory: OPQ64,IVF8192,PQ64
  nprobe: 64
  train_samples: 10000000
  shards:
    max_vectors_per_shard: 10000000
  gpu: true
  cuvs: true
  output_dir: /data/faiss/qwen3_ivfpq

ontology:
  inputs:
    - { ontology_id: mesh, format: obo, uri: /data/ontologies/mesh.obo }
    - { ontology_id: go,   format: obo, uri: /data/ontologies/go.obo }
  concept_embed:
    dense_model: Qwen3-Embedding-4B
    dense_dim: 2560
    splade_model: SPLADE-v3-distilbert
    splade_topk: 128

linker:
  candidates: { splade_topk: 100, lexicon_topk: 50 }
  fusion_weights: { dense: 0.55, sparse: 0.35, lexical: 0.10, depth_bonus_per_level: 0.02, depth_cap: 0.10 }
  thresholds: { high: 0.62, low: 0.35 }
  calibration: isotonic

graph:
  backend: neo4j
  uri: bolt://localhost:7687
  user: neo4j
  password_env: NEO4J_PASSWORD

search:
  k: 10
  dense_candidates: 200
  sparse_candidates: 200
  rrf_k: 60
  mmr_lambda: 0.7
  kg_boosts: { direct: 0.08, one_hop: 0.04 }
</code></pre>
<hr />
<h2 id="17-duckdb-141-schema-views-full-fidelity">17) DuckDB (≥ 1.4.1) schema &amp; views (full fidelity)</h2>
<p><strong>Tables (key ones)</strong></p>
<pre><code class="language-sql">CREATE TABLE model_registry (
  model_id TEXT,
  repo TEXT,
  revision TEXT,
  tokenizer TEXT,
  embedding_dim INT,      -- 2560 for Qwen3 embeddings
  vocab_size INT,         -- 30522 for SPLADE v3 tokenizer
  framework TEXT,         -- 'vllm'|'hf'
  framework_version TEXT,
  build_info JSON,        -- FAISS flags, CUDA, cuVS info
  PRIMARY KEY (model_id, revision)
);

CREATE TABLE runs (
  run_id TEXT PRIMARY KEY,
  purpose TEXT,           -- 'dense_embed'|'splade_encode'|'bm25_build'|'faiss_build'|...
  model_id TEXT,
  revision TEXT,
  started_at TIMESTAMP,
  finished_at TIMESTAMP,
  config JSON
);

CREATE TABLE documents (
  doc_id TEXT PRIMARY KEY,
  openalex_id TEXT, doi TEXT, arxiv_id TEXT, pmcid TEXT,
  title TEXT, authors JSON, pub_date TIMESTAMP,
  license TEXT, language TEXT,
  pdf_uri TEXT, source TEXT,
  content_hash TEXT,         -- canonical text hash (after DocTags→text)
  created_at TIMESTAMP
);

CREATE TABLE doctags (
  doc_id TEXT PRIMARY KEY REFERENCES documents(doc_id),
  doctags_uri TEXT, pages INT,
  vlm_model TEXT, vlm_revision TEXT,
  avg_logprob DOUBLE,
  created_at TIMESTAMP
);

CREATE TABLE datasets (
  dataset_id TEXT PRIMARY KEY,
  kind TEXT,                 -- 'chunks'|'dense'|'sparse'|'concepts'
  parquet_root TEXT,
  run_id TEXT REFERENCES runs(run_id),
  created_at TIMESTAMP
);

CREATE TABLE chunks (
  chunk_id TEXT PRIMARY KEY,
  doc_id TEXT REFERENCES documents(doc_id),
  section TEXT, start_char INT, end_char INT,
  doctags_span JSON, tokens INT,
  dataset_id TEXT REFERENCES datasets(dataset_id),
  created_at TIMESTAMP
);

CREATE TABLE dense_runs (
  run_id TEXT PRIMARY KEY REFERENCES runs(run_id),
  model TEXT, dim INT,       -- 2560
  parquet_root TEXT,
  created_at TIMESTAMP
);

CREATE TABLE sparse_runs (
  run_id TEXT PRIMARY KEY REFERENCES runs(run_id),
  model TEXT, vocab_size INT,
  parquet_root TEXT,
  created_at TIMESTAMP,
  backend TEXT               -- 'lucene-impact'|'lucene-bm25'
);

CREATE TABLE faiss_indexes (
  logical_index_id TEXT,     -- groups shards into a single logical index
  run_id TEXT REFERENCES dense_runs(run_id),
  shard_id INT,
  index_type TEXT, nlist INT, m INT, opq INT, nprobe INT,
  gpu BOOLEAN, cuvs BOOLEAN,
  index_uri TEXT, idmap_uri TEXT,
  created_at TIMESTAMP,
  PRIMARY KEY (logical_index_id, shard_id)
);

CREATE TABLE ontologies (
  ontology_id TEXT PRIMARY KEY,
  format TEXT, src_uri TEXT,
  loaded_at TIMESTAMP, concept_count INT
);

CREATE TABLE concept_embeddings (
  ontology_id TEXT REFERENCES ontologies(ontology_id),
  model TEXT, dim INT,
  parquet_root TEXT,
  created_at TIMESTAMP,
  PRIMARY KEY (ontology_id, model)
);

CREATE TABLE link_assertions (
  id TEXT PRIMARY KEY,
  chunk_id TEXT REFERENCES chunks(chunk_id),
  concept_id TEXT,
  score DOUBLE, decision TEXT,
  evidence_span TEXT,
  features JSON,
  run_id TEXT REFERENCES runs(run_id),
  created_at TIMESTAMP
);

CREATE TABLE pipeline_events (
  event_id TEXT PRIMARY KEY,
  event_name TEXT, subject_id TEXT, payload JSON,
  created_at TIMESTAMP
);

-- Helpful indexes
CREATE INDEX idx_chunks_doc ON chunks(doc_id);
CREATE INDEX idx_link_chunk ON link_assertions(chunk_id);
CREATE INDEX idx_link_concept ON link_assertions(concept_id);
</code></pre>
<p><strong>Views</strong> (Parquet unification)</p>
<pre><code class="language-sql">PRAGMA threads=14;

CREATE OR REPLACE VIEW dense_vectors_view AS
SELECT * FROM read_parquet(
  (SELECT parquet_root FROM dense_runs), union_by_name=true);

CREATE OR REPLACE VIEW splade_vectors_view AS
SELECT * FROM read_parquet(
  (SELECT parquet_root FROM sparse_runs WHERE backend='lucene-impact'), union_by_name=true);

CREATE OR REPLACE VIEW chunk_texts AS
SELECT * FROM read_parquet(
  (SELECT parquet_root FROM datasets WHERE kind='chunks'), union_by_name=true);
</code></pre>
<hr />
<h2 id="18-vllm-nginx-single-logical-endpoint">18) vLLM &amp; Nginx (single logical endpoint)</h2>
<p><strong>Nginx</strong> (local):</p>
<pre><code class="language-nginx">server {
  listen 80;
  server_name localhost;

  location /vlm/ {              # Docling VLM
    proxy_pass http://127.0.0.1:8001/;
  }
  location /v1/embeddings {     # Qwen3 embeddings (OpenAI-compatible)
    proxy_pass http://127.0.0.1:8002/v1/embeddings;
  }
  location /healthz {
    return 200 'ok\n';
  }
}
</code></pre>
<p><strong>vLLM processes (systemd units suggested)</strong></p>
<ul>
<li><strong>Granite‑Docling</strong>: <code>vllm serve ibm-granite/granite-docling-258M --revision untied --host 127.0.0.1 --port 8001 --dtype bfloat16</code></li>
<li><strong>Qwen3‑Embedding</strong>: <code>vllm serve Qwen/Qwen3-Embedding-4B --host 127.0.0.1 --port 8002 --dtype float16 --max-num-seqs 1024 --trust-remote-code</code></li>
</ul>
<p><em>(One model per vLLM process; router gives you a single host/endpoint.)</em></p>
<hr />
<h2 id="19-implementation-skeletons-selected">19) Implementation skeletons (selected)</h2>
<h3 id="191-downloader-pyalex-fallbacks">19.1 Downloader (PyAlex + fallbacks)</h3>
<pre><code class="language-python"># download/harvester.py
class OpenAccessHarvester:
    def __init__(self, cfg, http, unpaywall_client):
        ...

    def search_openalex(self, topic: str, years: str, max_works: int) -&gt; list[dict]:
        # paginate PyAlex queries; collect candidate OA PDF URLs + metadata
        ...

    def resolve_pdf(self, work: dict) -&gt; str | None:
        # try best_oa_location.pdf_url → locations[].pdf_url → unpaywall → arxiv/pmc
        ...

    def download_pdf(self, url: str, dest_path: str) -&gt; bool:
        # 60s timeout, 3 retries, 8 concurrent workers
        ...

    def run(self, topic: str, years: str, max_works: int) -&gt; list[Doc]:
        # returns registered documents (DuckDB insert)
        ...
</code></pre>
<h3 id="192-doctags-conversion">19.2 DocTags conversion</h3>
<pre><code class="language-python"># docling/vlm.py
class GraniteDoclingVLM:
    def __init__(self, endpoint: str, dpi: int, page_batch: int, timeout: int, ocr_fallback: bool):
        ...

    def to_doctags(self, pdf_path: str) -&gt; dict:
        # call vLLM endpoint; assemble DocTags JSON; OCR fallback per page if needed
        ...

    def persist(self, doc_id: str, doctags: dict) -&gt; str:
        # write to /data/doctags/&lt;doc_id&gt;.dt.json.zst, return URI
</code></pre>
<h3 id="193-chunking">19.3 Chunking</h3>
<pre><code class="language-python"># docling/hybrid.py
class HybridChunker:
    def __init__(self, target: int=400, overlap: int=80, min_tokens: int=120, max_tokens: int=480):
        ...
    def chunk(self, doctags_uri: str) -&gt; list[Chunk]:
        # parse, section-aware splitting, sliding windows, record spans/offsets
        ...
</code></pre>
<h3 id="194-dense-embeddings-qwen3-2560d-via-vllm">19.4 Dense embeddings (Qwen3 2560‑d via vLLM)</h3>
<pre><code class="language-python"># embeddings_dense/qwen3.py
class Qwen3Embedder:
    name = &quot;Qwen3-Embedding-4B&quot;
    dim = 2560
    def __init__(self, endpoint: str):
        ...
    def embed_texts(self, texts: list[str]) -&gt; &quot;np.ndarray&quot;:
        # call /v1/embeddings; enforce dim=2560; L2-normalize
        ...
</code></pre>
<h3 id="195-spladev3-encoder-gpu">19.5 SPLADE‑v3 encoder (GPU)</h3>
<pre><code class="language-python"># embeddings_sparse/splade.py
class SPLADEv3Encoder:
    def __init__(self, model_id: str, device=&quot;cuda&quot;, topk=256, max_seq_len=512):
        ...
    def encode(self, texts: list[str]) -&gt; list[tuple[list[int], list[float]]]:
        # torch.no_grad + autocast; prune to topK
        ...
</code></pre>
<h3 id="196-faiss-index-gpu-cuvs">19.6 FAISS index (GPU + cuVS)</h3>
<pre><code class="language-python"># vectorstore_faiss/gpu.py
class FaissGpuIndex:
    def __init__(self, factory: str, nprobe: int, gpu: bool=True, cuvs: bool=True):
        ...
    def train(self, train_vectors: &quot;np.ndarray&quot;) -&gt; None:
        ...
    def add(self, keys: list[str], vectors: &quot;np.ndarray&quot;) -&gt; None:
        ...
    def search(self, query: &quot;np.ndarray&quot;, k: int) -&gt; list[tuple[str, float]]:
        ...
    def save(self, index_uri: str, idmap_uri: str) -&gt; None:
        ...
</code></pre>
<h3 id="197-hybrid-retrieval-rerank-search_api">19.7 Hybrid retrieval &amp; rerank (search_api)</h3>
<pre><code class="language-python"># search_api/service.py
def hybrid_search(query: str, k: int) -&gt; list[dict]:
    q_vec = dense_embedder.embed_texts([query])[0]
    dense_hits = faiss.search(q_vec, k=200)
    sparse_hits = bm25.search(query, k=200) + splade.search(query, k=200)
    fused = rrf_fuse(dense_hits, sparse_hits, k=60)
    boosted = apply_kg_boosts(fused, query)
    results = mmr_deduplicate(boosted, lambda_=0.7)
    return explain(results, k)
</code></pre>
<hr />
<h2 id="20-quality-gates-evaluation-ci">20) Quality gates, evaluation &amp; CI</h2>
<ul>
<li><strong>Retrieval</strong>: nDCG@10 ≥ 0.50 (baseline), Recall@1K ≥ 0.85.</li>
<li><strong>Linker</strong>: F1 ≥ 0.70 on a labeled set; <strong>ECE ≤ 0.08</strong> after isotonic calibration.</li>
<li><strong>Latency</strong>: p95 search <strong>&lt; 300 ms</strong> (top‑10); p50 chunk→embed throughput tracked.</li>
<li><strong>CI</strong>: Unit tests (mypy, ruff), golden tests, nightly 1k‑doc mini‑pipeline; fail on regressions.</li>
</ul>
<hr />
<h2 id="21-security-licensing-governance-local">21) Security, licensing, governance (local)</h2>
<ul>
<li><strong>License guard</strong> at harvest; store license string in <code>documents.license</code>.</li>
<li>vLLM binds to <strong>localhost</strong> only; Nginx is the only front door; <strong>API‑key</strong> auth on search API.</li>
<li><strong>Secrets</strong> (if any) from environment; never persisted.</li>
<li><strong>Provenance</strong>: every artifact row includes <code>{run_id, model_id, revision, created_at}</code>.</li>
</ul>
<hr />
<h2 id="22-capacity-sizing-with-2560dim">22) Capacity &amp; sizing with <strong>2560‑dim</strong></h2>
<ul>
<li><strong>Dense Parquet</strong>: ≈ <strong>10 KB/chunk</strong> pre‑compression (2560 × 4 B).</li>
<li><strong>IVF‑PQ</strong> (PQ64) codes: ≈ <strong>64 B/vector</strong> (+ID/overhead ~80–100 B).</li>
<li><strong>SPLADE postings</strong>: ~<strong>2 KB/chunk</strong> before Lucene compression (256 nnz).</li>
<li>Scale by chunk count (e.g., 5M chunks → ~50 GB dense Parquet uncompressed; index is small enough for GPU).</li>
</ul>
<hr />
<h2 id="23-operational-runbooks">23) Operational runbooks</h2>
<ul>
<li><strong>CUDA 13 + Torch 2.9</strong>: install CUDA 13, confirm <code>nvcc --version</code>, install cu130 wheels.</li>
<li><strong>vLLM pre‑release</strong>: install channel with CUDA‑13 support; start two processes; verify health on <code>:8001</code>, <code>:8002</code>; Nginx routes.</li>
<li><strong>FAISS GPU + cuVS</strong>: install GPU binary (preferred); if needed, build from source with CMake flags enabling cuVS.</li>
<li>
<p><strong>Directories</strong>:</p>
</li>
<li>
<p>PDFs: <code>/data/pdfs</code></p>
</li>
<li>DocTags: <code>/data/doctags</code></li>
<li>Parquet: <code>/data/parquet</code></li>
<li>Lucene: <code>/data/lucene/{bm25,splade}</code></li>
<li>FAISS: <code>/data/faiss</code></li>
<li>DuckDB: <code>/data/catalog/catalog.duckdb</code></li>
<li><strong>Resource limits</strong>: <code>ulimit -n 65535</code>; I/O scheduler <code>mq-deadline</code>; set <code>PRAGMA threads=14</code> in DuckDB.</li>
</ul>
<hr />
<h2 id="24-workstreams-implementation-plans-deliverables">24) Workstreams (implementation plans &amp; deliverables)</h2>
<ol>
<li>
<p><strong>Downloader &amp; Harvester (PyAlex + fallbacks)</strong></p>
</li>
<li>
<p>PyAlex client; OA filters; DOI/ID extract; Unpaywall integration; robust downloader; license guard; DuckDB registration.</p>
</li>
<li>
<p>Deliverables: module, config, tests (mock HTTP), metrics (<code>pdf_download_success_total</code>, <code>oa_resolution_latency</code>).</p>
</li>
<li>
<p><strong>Docling VLM &amp; DocTags</strong></p>
</li>
<li>
<p>vLLM integration; page batching; OCR fallback; DocTags writer; quality metrics (avg logprob/page).</p>
</li>
<li>
<p>Deliverables: module, Nginx+vLLM configs, DDL updates, golden DocTags samples.</p>
</li>
<li>
<p><strong>Chunking (Docling Hybrid)</strong></p>
</li>
<li>
<p>Hybrid configuration; token accounting; offsets/spans; Parquet writer; golden chunk fixtures.</p>
</li>
<li>
<p><strong>Dense embeddings (Qwen3 2560‑d)</strong></p>
</li>
<li>
<p>vLLM client; batching &amp; normalization; Parquet writer; memory instrumentation; retries.</p>
</li>
<li>
<p><strong>SPLADE‑v3 GPU encoder + Pyserini indices</strong></p>
</li>
<li>
<p>Torch 2.9 encoder; Parquet encoder; streaming into Lucene (impact); BM25 build; query APIs.</p>
</li>
<li>
<p><strong>FAISS GPU/cuVS</strong></p>
</li>
<li>
<p>Binary installation or source build; index builder (OPQ64,IVF8192,PQ64); training sampler; shard manager; search adapter.</p>
</li>
<li>
<p><strong>Ontology &amp; concept embeddings</strong></p>
</li>
<li>
<p>Loaders (OWL/OBO/SKOS); normalization; concept Parquet; Qwen3(2560) + SPLADE encoders.</p>
</li>
<li>
<p><strong>Linker</strong></p>
</li>
<li>
<p>Candidate gen; fusion; calibration (isotonic); assertions Parquet; explainability; ablations.</p>
</li>
<li>
<p><strong>KG Builder (Neo4j)</strong></p>
</li>
<li>
<p>Node/edge upserts; constraints; indexes; maintenance; graph query helpers.</p>
</li>
<li>
<p><strong>Search API</strong></p>
<ul>
<li>FastAPI; hybrid retrieval; RRF; KG boosts; MMR; explanations; OpenAPI schema; auth.</li>
</ul>
</li>
<li>
<p><strong>Registry (DuckDB)</strong></p>
<ul>
<li>Migrations; registration helpers; views across Parquet; integrity checks; provenance guards.</li>
</ul>
</li>
<li>
<p><strong>Orchestration &amp; Observability</strong></p>
<ul>
<li>Prefect flows; retries; dashboards; tracing; alerting; local startup scripts.</li>
</ul>
</li>
</ol>
<hr />
<h2 id="25-coding-standards-bestinclass-python-practices">25) Coding standards &amp; best‑in‑class Python practices</h2>
<ul>
<li><strong>Static typing</strong> everywhere (<code>mypy --strict</code>).</li>
<li><strong>Pydantic v2</strong> for all externalized contracts; validate at boundaries only.</li>
<li><strong>Dataclasses/NamedTuples</strong> for internal‑only small records on hot paths.</li>
<li><strong>Pure functions</strong> for transformations; side effects behind adapters.</li>
<li><strong>Dependency inversion</strong>: constructors accept interfaces, not concretes.</li>
<li><strong>Factories</strong> resolve plugins from entry‑points; no <code>if/elif</code> on provider names in business logic.</li>
<li><strong>Error handling</strong>: wrap external calls in <code>Result[T, E]</code>‑like helpers (or <code>try/except</code> mapping to domain errors).</li>
<li><strong>Logging</strong>: structured (<code>json</code>); include <code>run_id</code>, <code>doc_id</code>, <code>chunk_id</code>.</li>
<li><strong>Testing</strong>: unit + contract tests per port; “fake” in‑memory providers; golden tests for DocTags/chunks; end‑to‑end smoke.</li>
<li><strong>Performance</strong>: vector ops on GPU; streaming I/O; Parquet row groups sized for cache locality; avoid pandas on hot paths.</li>
<li><strong>Docs</strong>: every public class/method has docstrings; README per package; ADRs for significant choices.</li>
</ul>
<hr />
<h1 id="addendum-additional-architecture-information">Addendum - additional architecture information</h1>
<h2 id="part-a-gap-analysis-whats-unspecified-resolutions-in-addendum">PART A — GAP ANALYSIS (WHAT’S UNSPECIFIED) → RESOLUTIONS IN ADDENDUM</h2>
<table>
<thead>
<tr>
<th>Area</th>
<th>Gap / ambiguity</th>
<th>Why it matters</th>
<th>Final specification (summary)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Canonical text &amp; ID hashing</strong></td>
<td>Exact <em>canonicalization</em> pipeline from DocTags to text (line breaks, whitespace, Unicode norms) not fixed; ID hashing step unclear.</td>
<td>Reproducibility; stable <code>doc_id</code>, <code>chunk_id</code>.</td>
<td>Define canonicalizer (NFC → collapse whitespace → normalize bullets/ligatures → Unix line endings). Hash <strong>canonical text</strong> SHA‑256, use first 16 bytes (base32) for URNs. (§B1)</td>
</tr>
<tr>
<td><strong>Tokenizer for chunk sizes</strong></td>
<td>Which tokenizer governs <code>target_tokens</code> not pinned.</td>
<td>Chunk consistency, embedding costs.</td>
<td>Use <strong>Qwen3‑Embedding tokenizer</strong> via HF <code>AutoTokenizer</code> for token counts. (§B2)</td>
</tr>
<tr>
<td><strong>DocTags fidelity</strong></td>
<td>Which DocTags nodes to include/exclude (headers/footers/refs), and OCR fallback merge rules unclear.</td>
<td>Content quality; linkability back to pages.</td>
<td>Include body, headings, tables, captions, figure text; exclude references by default. OCR per‑page fallback with provenance flag; page order preserved. (§B3)</td>
</tr>
<tr>
<td><strong>Downloader resolution order &amp; de‑dupe</strong></td>
<td>Ties between multiple OA locations; DOI/arXiv/PMCID overlaps; file dedup not specified.</td>
<td>Avoid duplicate processing and wasted space.</td>
<td>Stable priority list (OpenAlex best_oa → other locations → Unpaywall → source‑specific), MIME check; compute <code>pdf_sha256</code>; deduplicate by hash; symlink duplicate DoIs. (§B4)</td>
</tr>
<tr>
<td><strong>PyAlex topic query spec</strong></td>
<td>Which OpenAlex fields are searched; year filters and pagination; retries/timeouts not fixed.</td>
<td>Recall and reliability.</td>
<td>Search <code>title, abstract_inverted_index, fulltext</code> with AND semantics; filter by <code>from_year..to_year</code>; <code>per_page=200</code>; backoff retries 3×; http timeout 30 s; polite <code>User-Agent</code> and mailto. (§B4)</td>
</tr>
<tr>
<td><strong>Qwen3 embeddings 2560‑d</strong></td>
<td>Request parameter to enforce 2560 output; failure behavior if unsupported.</td>
<td>Index shape; FAISS train.</td>
<td>Request <code>dimension=2560</code>; assert response dim; if unsupported (model mismatch), <strong>fail fast</strong> and record incident. (§B5)</td>
</tr>
<tr>
<td><strong>SPLADE‑v3 GPU encoder</strong></td>
<td>Pre‑processing (lowercasing, punctuation), truncation, batching, AMP, and top‑K pruning details not pinned.</td>
<td>Index size and quality; repeatability.</td>
<td>Lowercase; strip control chars; keep punctuation; truncation at 512 WP tokens; AMP fp16; batch size auto‑tuned; top‑K=256 with stable tiebreaker (token id). (§B6)</td>
</tr>
<tr>
<td><strong>BM25 analyzer</strong></td>
<td>Analyzer pipeline (tokenizer, stopwords, stemming, casefold) not fixed.</td>
<td>Matching behavior and score comparability.</td>
<td>Lucene StandardTokenizer; English minimal stemming; lowercase; English stoplist; synonyms off by default (can be added per domain). (§B6)</td>
</tr>
<tr>
<td><strong>Parquet schemas &amp; partitioning</strong></td>
<td>Columns, dtypes, compression, row group size, directory partitioning not fully fixed.</td>
<td>IO performance; schema drift.</td>
<td>Fixed schemas listed; <strong>ZSTD=6</strong>, <code>row_group=4096</code>; partition by <code>model</code>, <code>run_id</code>, <code>shard</code>; filename <code>part-&lt;nnnnn&gt;.parquet</code>. (§B7)</td>
</tr>
<tr>
<td><strong>DuckDB catalog</strong></td>
<td>Migrations, integrity checks, FK behaviors, thread settings unspecified.</td>
<td>Registry reliability.</td>
<td>Versioned migrations (<code>registry/migrations/*.sql</code>), FK constraints, indexes, <code>PRAGMA threads=14</code>, two‑phase registration. (§B8)</td>
</tr>
<tr>
<td><strong>FAISS details (GPU+cuVS)</strong></td>
<td>Factory choice confirmed, but training sample selection, OPQ params, memory budgeting, shard policy not fully pinned.</td>
<td>Performance &amp; determinism.</td>
<td><code>OPQ64,IVF8192,PQ64</code>, train on 10M random (seed 42); <code>nprobe=64</code>; ≤10M vectors/shard; GPU add/search; save <code>.faiss</code> + <code>.ids</code>. (§B9)</td>
</tr>
<tr>
<td><strong>vLLM topology</strong></td>
<td>Routing is known, but request/response schemas, timeouts, retries, health checks not fully specified.</td>
<td>Client stability.</td>
<td>OpenAI‑compatible <code>/v1/embeddings</code>; per‑request timeout 30 s; 3× retries; health endpoints <code>/v1/models</code> &amp; <code>/health</code>; router (Nginx) config pinned; backpressure policy documented. (§B10)</td>
</tr>
<tr>
<td><strong>Ontology ingestion</strong></td>
<td>Supported predicates for labels/synonyms/defs, CURIE mapping, deprecations, and merges not fully specified.</td>
<td>Correct concept catalog and IDs.</td>
<td>Accept SKOS (<code>prefLabel</code>,<code>altLabel</code>), OBO (<code>hasExactSynonym</code>,<code>def</code>), RDFS labels; support <code>deprecated</code> and <code>replaced_by</code>; CURIE mapping table; normalize text; unique <code>urn:concept:&lt;ont&gt;:&lt;curie&gt;</code>. (§B11)</td>
</tr>
<tr>
<td><strong>Linker calibration</strong></td>
<td>Dev set size, fold policy, calibration storage, and runtime application not explicit.</td>
<td>Score interpretability.</td>
<td>Dev set 2,000 chunk‑concept pairs labeled; 5‑fold isotonic regression; parameters stored per <code>linker_run_id</code>; applied at runtime; ECE reported. (§B12)</td>
</tr>
<tr>
<td><strong>Hybrid fusion math</strong></td>
<td>RRF <code>k</code>, candidate pool sizes, KG boost exact math not completely fixed.</td>
<td>Deterministic results.</td>
<td>Dense@200 + Sparse@200; <strong>RRF(k=60)</strong>; KG boosts: direct +0.08, 1‑hop +0.04; MMR λ=0.7 at doc level. (§B13)</td>
</tr>
<tr>
<td><strong>API design</strong></td>
<td>Only endpoint sketch; errors, pagination, filters, sorting, rate limits, auth, and OpenAPI not fully specified.</td>
<td>Independent backend/frontend work.</td>
<td>Full <strong>OpenAPI</strong> spec, error schema, pagination, filters (year, source, license), API‑key auth, per‑key rate limits (local token bucket), JSON response formats. (§B14)</td>
</tr>
<tr>
<td><strong>End‑to‑end testing</strong></td>
<td>What E2E scenarios and fixtures to use; success criteria per stage unclear.</td>
<td>Integration confidence.</td>
<td>Provide seed corpora (10 docs), synthetic ontologies, golden outputs; E2E pipeline test that asserts all DDLs, artifact counts, index sizes, retrieval metrics over thresholds. (§B15)</td>
</tr>
<tr>
<td><strong>Observability</strong></td>
<td>Log schema, metric names, labels, exemplar traces, dashboards unspecified.</td>
<td>Ops readiness.</td>
<td>Define <strong>metrics</strong> (names, types), <strong>logs</strong> (JSON schema), <strong>traces</strong> (span names &amp; attributes); provide Grafana panels JSON. (§B16)</td>
</tr>
<tr>
<td><strong>Failure handling</strong></td>
<td>Error taxonomy, retry matrices, poison‑pill protocol, quarantine dirs not fixed.</td>
<td>Robustness under real corpora.</td>
<td>Standard error classes; retry/backoff tables; quarantine locations; incident log table and CLI. (§B17)</td>
</tr>
<tr>
<td><strong>Security &amp; licensing</strong></td>
<td>Key storage, license enforcement points, audit fields not formalized.</td>
<td>Compliance and reproducibility.</td>
<td><code>.env</code> for secrets; license filters in downloader; persist license string and OA source; audit table records provenance; API keys in env; localhost binding. (§B18)</td>
</tr>
<tr>
<td><strong>Project structure &amp; code quality</strong></td>
<td>Pre‑commit, linters, typing level, docstrings, ADRs, contribution workflow not locked.</td>
<td>Team velocity &amp; consistency.</td>
<td>Pre‑commit (ruff, black, mypy‑strict), conventional commits, ADR template, mkdocs site, contribution guide, codeowners. (§B19)</td>
</tr>
<tr>
<td><strong>Local dev &amp; bootstrap</strong></td>
<td>No exact bootstrap steps and Make targets.</td>
<td>Fast onboarding.</td>
<td>Provide <code>scripts/bootstrap.sh</code>, <code>Makefile</code> targets, systemd units for vLLM + Nginx, folder layout creation. (§B20)</td>
</tr>
<tr>
<td><strong>Performance SLAs</strong></td>
<td>Hard SLAs and perf targets partially stated.</td>
<td>Planning &amp; regression gates.</td>
<td>SLAs/SLOs formalized per stage; CI gates with thresholds; perf budgets by stage. (§B21)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="part-b-exhaustive-specifications-resolutions">PART B — EXHAUSTIVE SPECIFICATIONS (RESOLUTIONS)</h2>
<h3 id="b1-canonical-text-hashing-ids">B1. Canonical text, hashing &amp; IDs</h3>
<ul>
<li>
<p><strong>Canonicalizer</strong> (DocTags → text):</p>
</li>
<li>
<p>Decode UTF‑8; apply <strong>Unicode NFC</strong>.</p>
</li>
<li>Replace Windows/old Mac line breaks with <code>\n</code>.</li>
<li>Collapse runs of whitespace to a single space <strong>except</strong> keep single <code>\n</code> line breaks between block nodes (paragraph/heading/list/table caption).</li>
<li>Normalize bullets (<code>•</code>, <code>◦</code>, <code>–</code>) to <code>-</code>.</li>
<li>Strip page headers/footers using DocTags region types; <strong>exclude References</strong> section by default (configurable).</li>
<li>Retain figure/table captions, equations (inline LaTeX left as‑is), and footnotes (inlined at end of page).</li>
<li><strong>doc_id</strong>: <code>urn:doc:sha256:&lt;first16B base32&gt;</code> over <strong>canonical text</strong> (not PDF bytes).</li>
<li><strong>chunk_id</strong>: <code>urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;</code> using <strong>character offsets</strong> in canonical text (inclusive start, exclusive end).</li>
<li>Hashes computed with SHA‑256; extraction reproducible.</li>
</ul>
<h3 id="b2-tokenizer-chunking-quantization">B2. Tokenizer &amp; chunking quantization</h3>
<ul>
<li><strong>Tokenizer of record</strong>: HuggingFace tokenizer for <strong>Qwen/Qwen3‑Embedding‑4B</strong>.</li>
<li><strong>Chunker parameters (fixed defaults)</strong>: <code>target=400</code>, <code>overlap=80</code>, <code>min=120</code>, <code>max=480</code> <strong>Qwen tokens</strong>; stride=<code>target-overlap=320</code>.</li>
<li>If a section is shorter than 120 tokens and can be merged with its successor without exceeding 480, merge; otherwise leave standalone.</li>
<li>Sliding spill‑windows never cross major section boundaries (title/abstract/intro/methods/results/discussion).</li>
</ul>
<h3 id="b3-doctags-selection-ocr-fallback">B3. DocTags selection &amp; OCR fallback</h3>
<ul>
<li><strong>Include</strong>: title, authors, abstract, section headings, paragraphs, lists, tables, figures’ captions, equations.</li>
<li><strong>Exclude</strong> by default: acknowledgements, references; can enable via <code>config.doc_conversion.include_references=true</code>.</li>
<li><strong>OCR</strong>: page‑level fallback using Tesseract when Docling VLM avg logprob &lt; 0.5; OCR text anchored into DocTags page node with <code>provenance="ocr"</code>.</li>
<li><strong>Provenance</strong> fields in DoctagsAsset: <code>{avg_logprob, ocr_pages:[int]}</code>.</li>
</ul>
<h3 id="b4-harvester-downloader-pyalex-first-with-fallbacks">B4. Harvester &amp; downloader (PyAlex first, with fallbacks)</h3>
<ul>
<li>
<p><strong>PyAlex search</strong>:</p>
</li>
<li>
<p>Query compiled as AND of: <code>topic</code> (applied to <code>title</code>, <code>abstract_inverted_index</code>, <code>fulltext</code>), optional <code>year &gt;= from_year</code>, <code>is_oa=true OR has_oa_published_version=true OR has_oa_accepted_or_published_version=true</code>.</p>
</li>
<li>Pagination: <code>per_page=200</code>, resume with <code>cursor</code>, cap at <code>max_works</code>.</li>
<li>HTTP timeout=30 s, retries=3 (exponential 1.0/2.0/4.0 s), <code>User-Agent: kgfoundry/1.0 (+contact@example.com)</code>.</li>
<li>
<p><strong>Resolution priority</strong> (first success wins):</p>
</li>
<li>
<p><code>best_oa_location.pdf_url</code> (OpenAlex).</p>
</li>
<li>Any <code>locations[].pdf_url</code> with <code>is_oa=true</code> (prefer <code>publishedVersion</code> &gt; <code>acceptedVersion</code>).</li>
<li><strong>Unpaywall</strong> by DOI → <code>url_for_pdf</code>.</li>
<li>Source‑specific fallback: arXiv (<code>/pdf/&lt;id&gt;.pdf</code>), PMC article PDF.</li>
<li><strong>MIME + size checks</strong>: Require <code>application/pdf</code>; max size 100 MB (configurable).</li>
<li><strong>De‑dup</strong>: compute <code>pdf_sha256</code> of bytes; if duplicate of an existing doc, <strong>link</strong> new metadata to existing file and record alias (<code>openalex_id</code>, <code>doi</code>, etc.).</li>
<li><strong>Registration</strong>: Insert into <code>documents</code> with all source IDs, <code>pdf_uri</code>, license, OA source, and timestamp.</li>
</ul>
<h3 id="b5-dense-embeddings-qwen3-2560d">B5. Dense embeddings (Qwen3 2560‑d)</h3>
<ul>
<li><strong>API</strong>: OpenAI‑compatible <code>/v1/embeddings</code> with body:</li>
</ul>
<p><code>json
  {"model":"Qwen/Qwen3-Embedding-4B","input":[ "...chunk text..." ],"dimensions":2560}</code>
* <strong>Response validation</strong>: assert vector length 2560; otherwise <strong>fail run</strong> with incident record.
* <strong>Batching</strong>: dynamic batch size uses VRAM probe; keep <strong>≤80%</strong> VRAM.
* <strong>Normalization</strong>: client L2‑normalizes vector (float32) and stores original L2.
* <strong>Errors</strong>: HTTP 429/5xx → retries (3×); timeouts → retries; after 3 failures, quarantine batch.</p>
<h3 id="b6-sparse-spladev3-gpu-bm25-details">B6. Sparse (SPLADE‑v3 GPU) &amp; BM25 details</h3>
<ul>
<li>
<p><strong>SPLADE‑v3 encoder</strong>:</p>
</li>
<li>
<p>Pre‑proc: lowercase; strip control chars (<code>\x00</code>..<code>\x1f</code>), keep punctuation; whitespace collapse single space; no stopword removal.</p>
</li>
<li>Tokenization: DistilBERT WordPiece; <code>max_seq_len=512</code> (truncate tail).</li>
<li>AMP: <code>torch.autocast(device_type="cuda", dtype=torch.float16)</code>.</li>
<li>Batch size: auto‑tuned per GPU memory; cap at 2048 tokens/batch.</li>
<li>Top‑K pruning: select top 256 weights by value; tie‑break by <strong>token id asc</strong>; <strong>sort ascending</strong> token ids for indexer.</li>
<li>
<p><strong>BM25 (Pyserini/Lucene)</strong>:</p>
</li>
<li>
<p>Analyzer: StandardTokenizer → Lowercase → EnglishMinimalStemFilter → EnglishStopFilter.</p>
</li>
<li>Params: <code>k1=0.9</code>, <code>b=0.4</code>.</li>
<li>Fields: <code>title</code> (boost 2.0), <code>section</code> (1.2), <code>body</code> (1.0). Title from DocTags title node; section from chunk.section; body from chunk text.</li>
</ul>
<h3 id="b7-parquet-datasets-all-embeddings-and-chunks">B7. Parquet datasets (ALL embeddings and chunks)</h3>
<ul>
<li><strong>Common options</strong>: <code>compression="ZSTD"</code>, level=6; <code>row_group_size=4096</code>; <code>use_dictionary=True</code> for categorical columns (<code>model</code>, <code>run_id</code>, <code>doc_id</code>, <code>section</code>).</li>
<li><strong>Dense</strong>:</li>
</ul>
<p><code>chunk_id: string, model: string, run_id: string, dim: int16 (=2560),
  vector: list&lt;float&gt;, l2_norm: float, created_at: timestamp</code></p>
<p>Partitions: <code>model=Qwen3-Embedding-4B/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</code>.
* <strong>SPLADE</strong>:</p>
<p><code>chunk_id: string, model: string, run_id: string,
  vocab_ids: list&lt;int32&gt;, weights: list&lt;float&gt;, nnz: int16, created_at: timestamp</code></p>
<p>Partitions: <code>model=SPLADE-v3-distilbert/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</code>.
* <strong>Chunks</strong>:</p>
<p><code>chunk_id, doc_id, section, start_char:int32, end_char:int32,
  doctags_span: struct&lt;node_id:string,start:int32,end:int32&gt;,
  text:string, tokens:int32, created_at:timestamp</code></p>
<p>Partition: <code>model=docling_hybrid/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</code>.</p>
<h3 id="b8-duckdb-registry-141-migrations-guards">B8. DuckDB registry (≥ 1.4.1): migrations &amp; guards</h3>
<ul>
<li><strong>Migrations</strong>: SQL files in <code>/registry/migrations</code>, applied by <code>registry apply-migrations</code>. Each migration increments <code>schema_version</code> table.</li>
<li><strong>Two‑phase registration</strong>: write Parquet to temp dir → validate row counts &amp; schema → <code>BEGIN</code> → insert into <code>datasets</code>/<code>runs</code> → <code>COMMIT</code> → rename dir into place; on failure <code>ROLLBACK</code> and delete temp.</li>
<li><strong>Threading</strong>: <code>PRAGMA threads=14</code>; all read_parquet with <code>union_by_name=true</code>.</li>
<li><strong>Integrity</strong>: FKs and unique constraints as defined.</li>
<li><strong>Views</strong>: <code>dense_vectors_view</code>, <code>splade_vectors_view</code>, <code>chunk_texts</code> pre‑created.</li>
</ul>
<h3 id="b9-faiss-gpu-cuvs-cuda-13">B9. FAISS GPU + cuVS (CUDA 13)</h3>
<ul>
<li><strong>Factory</strong>: <code>OPQ64,IVF8192,PQ64</code> (for d=2560).</li>
<li><strong>Train</strong>: Random sample of <strong>min(10M, 100% of corpus)</strong> dense vectors; seed=42; normalize before train.</li>
<li><strong>Add</strong>: On GPU; batch of N where memory ≤ 80% VRAM; record adds per shard in DuckDB.</li>
<li><strong>Search</strong>: <code>nprobe=64</code>; return distances as <strong>IP or L2</strong> consistent with training (we use <strong>IP</strong> on normalized vectors → cosine).</li>
<li><strong>Persist</strong>: <code>.faiss</code> index + <code>.ids</code> idmap per shard; <code>faiss_indexes</code> table records <code>logical_index_id</code>, <code>shard_id</code>, file paths, config.</li>
<li><strong>Merge</strong>: logical index = set of shards; search fans out to shards, merges top‑K.</li>
</ul>
<h3 id="b10-vllm-servers-router">B10. vLLM servers &amp; router</h3>
<ul>
<li><strong>Granite‑Docling (VLM)</strong>: vLLM process #1 on <code>127.0.0.1:8001</code>.</li>
<li><strong>Qwen3 embeddings</strong>: vLLM process #2 on <code>127.0.0.1:8002</code>.</li>
<li><strong>Router</strong>: Nginx on <code>:80</code> maps <code>/vlm/*</code> → 8001 and <code>/v1/embeddings</code> → 8002.</li>
<li><strong>Health checks</strong>: <code>/healthz</code> on router; <code>/v1/models</code> on each vLLM.</li>
<li><strong>Client policy</strong>: per‑request timeout 30 s, retries ×3 (429/5xx), exponential backoff 1/2/4 s; circuit‑breaker opens after 10 consecutive failures (per‑service) for 30 s.</li>
</ul>
<h3 id="b11-ontology-ingestion-catalog">B11. Ontology ingestion &amp; catalog</h3>
<ul>
<li><strong>Formats</strong>: OBO, OWL/RDF (TTL, RDF/XML), SKOS (RDF).</li>
<li>
<p><strong>Predicates</strong>:</p>
</li>
<li>
<p>Labels: <code>rdfs:label</code>, <code>skos:prefLabel</code>.</p>
</li>
<li>Synonyms: <code>oboInOwl:hasExactSynonym</code>, <code>skos:altLabel</code>.</li>
<li>Definitions: <code>IAO:0000115</code>, <code>skos:definition</code>.</li>
<li>Hierarchy: <code>rdfs:subClassOf</code>, <code>skos:broader</code>, <code>BFO:part_of</code> (normalized to <code>IS_A</code> or <code>PART_OF</code>).</li>
<li>Deprecation: <code>owl:deprecated</code> true; replacements: <code>iao:0100001</code> or custom <code>replaced_by</code>.</li>
<li><strong>CURIEs</strong>: Provide <code>prefix → base IRI</code> map per ontology; compute <code>urn:concept:&lt;ont&gt;:&lt;CURIE&gt;</code>.</li>
<li><strong>Normalization</strong>: lowercased, NFC, punctuation trimmed (except hyphen and slash), English lemmatization.</li>
<li>
<p><strong>Concept embeddings</strong>:</p>
</li>
<li>
<p>Dense (Qwen3 2560‑d): text = <code>pref_label | definition | top5_synonyms</code>; same Parquet schema as chunks (swap <code>chunk_id → concept_id</code>).</p>
</li>
<li>Sparse (SPLADE): text same as above; topK=128.</li>
</ul>
<h3 id="b12-linker-calibration-decision-policy">B12. Linker calibration &amp; decision policy</h3>
<ul>
<li><strong>Labeling</strong>: 2,000 chunk‑concept candidate pairs labeled by domain curators.</li>
<li><strong>Splits</strong>: 5‑fold CV; train isotonic regression to map fused score → calibrated [0,1].</li>
<li><strong>Thresholds</strong>: <code>τ_high=0.62</code>, <code>τ_low=0.35</code> applied <strong>after calibration</strong>.</li>
<li><strong>Outputs</strong>: save calibration params in DuckDB as JSON attached to <code>run_id</code> (linker run).</li>
<li><strong>Metrics</strong>: precision/recall/F1; <strong>Expected Calibration Error</strong> (ECE).</li>
</ul>
<h3 id="b13-hybrid-retrieval-fusion-fixed-math">B13. Hybrid retrieval fusion (fixed math)</h3>
<ul>
<li><strong>Retrieval</strong>: <code>dense@200</code> (FAISS), <code>sparse@200</code> (BM25 and SPLADE each produce lists; we interleave by highest score then take top 200 combined sparse).</li>
<li><strong>RRF</strong>: <code>RRF_k = 60</code>. Score = <code>Σ 1/(k + rank_i)</code> over participating rankers (dense, bm25, splade).</li>
<li><strong>KG boost</strong>: +0.08 if any linked concept of chunk ∈ query concepts; +0.04 if within one ontology hop; max boost +0.12.</li>
<li><strong>MMR</strong>: doc‑level, <code>λ=0.7</code>; similarity measured by cosine of mean chunk vectors per doc.</li>
</ul>
<h3 id="b14-search-api-openapi-31-final">B14. Search API — <strong>OpenAPI 3.1</strong> (final)</h3>
<ul>
<li><strong>Auth</strong>: Bearer API key header <code>Authorization: Bearer &lt;token&gt;</code> (tokens read from env <code>SEARCH_API_KEYS</code>, comma‑separated).</li>
<li><strong>Rate limits</strong>: token‑bucket: 120 req/min per key; 1,000 req/day per key (in‑memory counters, process‑local).</li>
<li>
<p><strong>Endpoints</strong>:</p>
</li>
<li>
<p><code>POST /search</code></p>
<ul>
<li>Body:</li>
</ul>
<p><code>json
  {
    "query": "string",
    "k": 10,
    "filters": {"year_from": 2018, "year_to": 2025, "source": ["openalex","arxiv"], "license":["CC-BY","CC0"]},
    "explain": false
  }</code>
* 200 Response (per result):</p>
<p><code>json
  {
    "doc_id": "urn:doc:...",
    "chunk_id": "urn:chunk:...",
    "title": "string",
    "section": "Methods",
    "score": 2.381,
    "signals": {"dense": 0.73, "sparse": 0.61, "rrf": 0.025, "kg_boost": 0.08},
    "spans": {"start_char": 120, "end_char": 420},
    "concepts": [{"concept_id":"urn:concept:mesh:D012345","label":"...","match":"direct"}]
  }</code>
* Errors: <code>400</code> (bad input), <code>401</code> (auth), <code>429</code> (rate limit), <code>500</code> (server).
  * <code>POST /graph/concepts</code></p>
<ul>
<li>Body: <code>{"q":"string","limit":50}</code> → returns matching concept IDs + labels + paths to root.</li>
<li><code>GET /healthz</code> → <code>{status:"ok", components:{faiss:"ok", bm25:"ok", vllm_embeddings:"ok", neo4j:"ok"}}</code>.</li>
</ul>
</li>
</ul>
<h3 id="b15-endtoend-stage-testing">B15. End‑to‑end &amp; stage testing</h3>
<ul>
<li>
<p><strong>Seed fixtures</strong>:</p>
</li>
<li>
<p>10 OA PDFs (mix arXiv/PMC/journal) on disk for offline tests.</p>
</li>
<li>Tiny ontology (50 concepts, 2 levels) + MeSH subset (for integration).</li>
<li>Golden outputs: a) DocTags JSON; b) chunk Parquet; c) sample dense/sparse Parquets; d) FAISS index shards; e) SPLADE/BM25 Lucene dirs.</li>
<li>
<p><strong>E2E test</strong> (<code>pytest -m e2e</code>):</p>
</li>
<li>
<p>Harvest &amp; download (mock pyalex/unpaywall): expect N PDFs.</p>
</li>
<li>DocTags conversion: expect pages&gt;0, DocTags file exists, avg_logprob recorded.</li>
<li>Chunking: expect chunks&gt;0; token counts within bounds; offsets monotonic.</li>
<li>Dense embed: expect vectors dim=2560; Parquet rows==chunks.</li>
<li>SPLADE encode &amp; BM25 index: Lucene dirs exist; postings &gt;0.</li>
<li>FAISS build: index files exist; search for “topic” returns &gt;0 results.</li>
<li>Ontology ingest + concept embeddings: counts &gt;0; CURIEs valid.</li>
<li>Linker: assertions produced; at least X% linked.</li>
<li>KG upsert: node/edge counts as expected.</li>
<li>Search API: <code>/search</code> returns 200 and k results; latency p95 &lt; 300 ms on fixtures.</li>
<li><strong>Stage unit tests</strong>: contract tests per ABC; property‑based tests (idempotency; stable IDs); golden tests for DocTags/chunks; benchmarking tests for encoder throughput.</li>
</ul>
<h3 id="b16-observability-diagnostics">B16. Observability &amp; diagnostics</h3>
<ul>
<li><strong>Logs</strong>: JSON lines with fields: <code>ts, level, module, event, run_id, doc_id, chunk_id, duration_ms, err_code, message</code>.</li>
<li>
<p><strong>Metrics</strong> (Prometheus):</p>
</li>
<li>
<p>Counters: <code>pdf_download_success_total</code>, <code>pdf_download_failure_total{reason}</code>, <code>chunks_total</code>, <code>dense_vectors_total</code>, <code>splade_vectors_total</code>, <code>faiss_queries_total</code>, <code>bm25_queries_total</code>, <code>splade_queries_total</code>.</p>
</li>
<li>Histograms: <code>download_latency_ms</code>, <code>doctags_latency_ms</code>, <code>chunking_latency_ms</code>, <code>embed_dense_latency_ms</code>, <code>splade_encode_latency_ms</code>, <code>faiss_search_latency_ms</code>, <code>search_total_latency_ms</code>.</li>
<li>Gauges: <code>faiss_index_size_vectors</code>, <code>lucene_docs_count</code>, <code>duckdb_open_files</code>.</li>
<li>
<p><strong>Tracing</strong> (OpenTelemetry):</p>
</li>
<li>
<p>Spans: <code>harvest.search</code>, <code>download.pdf</code>, <code>docling.to_doctags</code>, <code>chunking.hybrid</code>, <code>embed.qwen3</code>, <code>encode.splade</code>, <code>index.faiss.add</code>, <code>index.lucene.build</code>, <code>linker.run</code>, <code>kg.upsert</code>, <code>api.search</code>.</p>
</li>
<li>Attributes: <code>{run_id, doc_id, shard_id, model, dim, nprobe, nnz}</code>.</li>
<li>
<p><strong>Dashboards</strong>: provide JSON exports for:</p>
</li>
<li>
<p><strong>Ingest Health</strong> (download rates/errors).</p>
</li>
<li><strong>Pipeline Throughput</strong> (chunks/min, embeddings/min).</li>
<li><strong>Search SLOs</strong> (p50/p95/p99 latency, error rate).</li>
<li><strong>Index Footprint</strong> (FAISS vectors, Lucene docs).</li>
</ul>
<h3 id="b17-failure-handling-resilience">B17. Failure handling &amp; resilience</h3>
<ul>
<li>
<p><strong>Error taxonomy</strong>:</p>
</li>
<li>
<p><code>DownloadError</code>, <code>UnsupportedMIMEError</code>, <code>DoclingError</code>, <code>OCRTimeout</code>, <code>ChunkingError</code>, <code>EmbeddingError</code>, <code>SpladeOOM</code>, <code>FaissOOM</code>, <code>IndexBuildError</code>, <code>OntologyParseError</code>, <code>LinkerCalibrationError</code>, <code>Neo4jError</code>.</p>
</li>
<li>
<p><strong>Retry/backoff</strong> table:</p>
</li>
<li>
<p>External HTTP (download, vLLM): retries=3, backoff 1/2/4 s.</p>
</li>
<li>GPU OOM: reduce batch by 50%, retry up to 2 times; if still fails → quarantine.</li>
<li>FAISS add error: split shard; retry once per split.</li>
<li>
<p><strong>Quarantine</strong>:</p>
</li>
<li>
<p>PDFs: <code>/data/quarantine/pdfs/…</code></p>
</li>
<li>Parquet batches: <code>/data/quarantine/parquet/…</code></li>
<li>Incidents table: <code>registry.incidents(event, subject_id, error_class, message, created_at)</code>.</li>
<li><strong>Poison pill</strong>: if a <code>doc_id</code> fails at stage X twice, mark <code>documents.status='poison'</code> and exclude from subsequent runs until manual override.</li>
</ul>
<h3 id="b18-security-licensing-config-secrets">B18. Security, licensing, config secrets</h3>
<ul>
<li><strong>Local‑only</strong> network binding for vLLM and Neo4j.</li>
<li><strong>API keys</strong> for Search API read from env <code>SEARCH_API_KEYS</code> (comma‑separated).</li>
<li><strong>Licenses</strong> stored verbatim from source; <code>documents.license</code> required for downstream processing; refuse embedding/indexing if missing or not OA.</li>
<li><strong>.env</strong> template for secrets and contact email; never commit real secrets.</li>
</ul>
<h3 id="b19-code-quality-governance">B19. Code quality &amp; governance</h3>
<ul>
<li><strong>Pre‑commit</strong>: <code>ruff</code>, <code>black</code>, <code>mypy --strict</code>, <code>pyupgrade</code>, <code>interrogate</code> (docstring coverage).</li>
<li><strong>Type discipline</strong>: <code>from __future__ import annotations</code>, Protocol/ABC for interfaces, <code>Final</code> constants.</li>
<li><strong>Docs</strong>: <code>mkdocs</code> site with API docs (pdoc or mkdocstrings), how‑to guides, and ADRs (<code>/docs/adr/0001-...md</code>).</li>
<li><strong>Conventional commits</strong> and <strong>semantic versioning</strong> per package.</li>
<li><strong>Codeowners</strong> by directory.</li>
</ul>
<h3 id="b20-bootstrap-devex">B20. Bootstrap &amp; DevEx</h3>
<ul>
<li>
<p><strong>Makefile</strong> targets:</p>
</li>
<li>
<p><code>make bootstrap</code> → create venv, install deps, install CUDA‑13 Torch wheels, build/install FAISS GPU/cuVS (or fetch wheel), install vLLM prerelease, create dirs under <code>/data/*</code>, apply migrations, install systemd units for vLLM and Nginx.</p>
</li>
<li><code>make run</code> → start router, start API, ensure vLLM services up.</li>
<li><code>make e2e</code> → run the full fixture pipeline &amp; API checks.</li>
<li><code>make clean</code> → remove indexes and temp outputs.</li>
<li><strong>Systemd</strong> units: <code>vllm-vlm.service</code>, <code>vllm-embed.service</code>, <code>nginx.service</code>, <code>search-api.service</code>.</li>
<li><strong>Directory layout</strong>:</li>
</ul>
<p><code>/data/pdfs
  /data/doctags
  /data/parquet/{chunks,dense,sparse,concepts}
  /data/lucene/{bm25,splade}
  /data/faiss
  /data/catalog/catalog.duckdb
  /data/quarantine/{pdfs,parquet}</code></p>
<h3 id="b21-slasslos-performance-budgets">B21. SLAs/SLOs &amp; performance budgets</h3>
<ul>
<li><strong>Downloader</strong>: ≥ 95% of accessible OA PDFs succeed within 60 s; retries included.</li>
<li><strong>DocTags</strong>: p95 ≤ 6 s/10 pages (Granite‑Docling, RTX 5090).</li>
<li><strong>Chunking</strong>: ≥ 5,000 chunks/min CPU.</li>
<li><strong>Dense embedding</strong>: ≥ 8,000 chunks/min (2560‑d) on RTX 5090 under 80% VRAM.</li>
<li><strong>SPLADE encoding</strong>: ≥ 5,000 chunks/min (AMP).</li>
<li><strong>FAISS search</strong>: p95 ≤ 40 ms for 200‑NN; build time ≤ 2 h per 10M vectors shard.</li>
<li><strong>Search API</strong>: p95 end‑to‑end ≤ 300 ms for <code>k=10</code>, concurrency 64.</li>
<li><strong>Linker run</strong>: ≥ 1M chunk‑concept candidate scorings/hour; ECE ≤ 0.08; F1 ≥ 0.70 on dev set.</li>
<li><strong>CI gates</strong>: fail if nDCG@10 drops &gt; 0.02 from last green or p95 latency ↑ &gt; 20%.</li>
</ul>
<hr />
<h2 id="part-c-interfaces-module-contracts-ready-for-coding">PART C — INTERFACES &amp; MODULE CONTRACTS (READY FOR CODING)</h2>
<p>Below are <strong>Python interface signatures</strong> (type‑checked; exceptions documented). All implementations must adhere to these contracts.</p>
<h3 id="c1-registry-duckdb-registryapipy">C1. Registry (DuckDB) — <code>registry/api.py</code></h3>
<pre><code class="language-python">class Registry(Protocol):
    def begin_dataset(self, kind: str, run_id: str) -&gt; str: ...
    def commit_dataset(self, dataset_id: str, parquet_root: str, rows: int) -&gt; None: ...
    def rollback_dataset(self, dataset_id: str) -&gt; None: ...

    def insert_run(self, purpose: str, model_id: str | None, revision: str | None, config: dict) -&gt; str: ...
    def close_run(self, run_id: str, success: bool, notes: str | None = None) -&gt; None: ...

    def register_documents(self, docs: list[Doc]) -&gt; None: ...
    def register_doctags(self, assets: list[DoctagsAsset]) -&gt; None: ...
    def register_chunks(self, dataset_id: str, chunk_rows: int) -&gt; None: ...
    def register_dense_run(self, run_id: str, model: str, dim: int, parquet_root: str) -&gt; None: ...
    def register_sparse_run(self, run_id: str, model: str, vocab_size: int, parquet_root: str, backend: str) -&gt; None: ...
    def register_faiss_shard(self, logical_index_id: str, run_id: str, shard_id: int, cfg: dict, index_uri: str, idmap_uri: str) -&gt; None: ...

    def emit_event(self, event_name: str, subject_id: str, payload: dict) -&gt; None: ...
    def incident(self, event: str, subject_id: str, error_class: str, message: str) -&gt; None: ...
</code></pre>
<h3 id="c2-downloader-downloadharvesterpy">C2. Downloader — <code>download/harvester.py</code></h3>
<pre><code class="language-python">class Harvester(Protocol):
    def search(self, topic: str, years: str, max_works: int) -&gt; list[dict]: ...
    def resolve_pdf(self, work: dict) -&gt; str | None: ...
    def download_pdf(self, url: str, target_path: str) -&gt; str: ...  # returns final path
    def run(self, topic: str, years: str, max_works: int) -&gt; list[Doc]: ...
</code></pre>
<p><strong>Exceptions</strong>: <code>DownloadError</code>, <code>UnsupportedMIMEError</code>.</p>
<h3 id="c3-doctags-chunking-doclingvlmpy-doclinghybridpy">C3. DocTags &amp; chunking — <code>docling/vlm.py</code>, <code>docling/hybrid.py</code></h3>
<pre><code class="language-python">class DocTagsConverter(Protocol):
    def to_doctags(self, pdf_path: str) -&gt; dict: ...
    def persist(self, doc_id: str, doctags: dict) -&gt; str: ...

class Chunker(Protocol):
    def chunk(self, doctags_uri: str) -&gt; list[Chunk]: ...
</code></pre>
<p><strong>Exceptions</strong>: <code>DoclingError</code>, <code>OCRTimeout</code>, <code>ChunkingError</code>.</p>
<h3 id="c4-embeddings-embeddings_denseqwen3py-embeddings_sparsespladepy-embeddings_sparsebm25py">C4. Embeddings — <code>embeddings_dense/qwen3.py</code>, <code>embeddings_sparse/splade.py</code>, <code>embeddings_sparse/bm25.py</code></h3>
<pre><code class="language-python">class DenseEmbedder(Protocol):
    name: str
    dim: int
    def embed_texts(self, texts: list[str]) -&gt; &quot;np.ndarray&quot;: ...

class SparseEncoder(Protocol):
    name: str
    def encode(self, texts: list[str]) -&gt; list[tuple[list[int], list[float]]]: ...

class SparseIndex(Protocol):
    def build(self, docs_iterable: &quot;Iterable[tuple[str, dict]]&quot;) -&gt; None: ...
    def search(self, query: str, k: int, fields: dict | None = None) -&gt; list[tuple[str, float]]: ...
</code></pre>
<p><strong>Exceptions</strong>: <code>EmbeddingError</code>, <code>SpladeOOM</code>, <code>IndexBuildError</code>.</p>
<h3 id="c5-vector-store-vectorstore_faissgpupy">C5. Vector store — <code>vectorstore_faiss/gpu.py</code></h3>
<pre><code class="language-python">class VectorStore(Protocol):
    def train(self, train_vectors: &quot;np.ndarray&quot;, *, factory: str, seed: int = 42) -&gt; None: ...
    def add(self, keys: list[str], vectors: &quot;np.ndarray&quot;) -&gt; None: ...
    def search(self, query: &quot;np.ndarray&quot;, k: int) -&gt; list[tuple[str, float]]: ...
    def save(self, index_uri: str, idmap_uri: str) -&gt; None: ...
    def load(self, index_uri: str, idmap_uri: str) -&gt; None: ...
</code></pre>
<p><strong>Exceptions</strong>: <code>FaissOOM</code>, <code>IndexBuildError</code>.</p>
<h3 id="c6-ontology-catalog-ontologyloaderpy">C6. Ontology &amp; catalog — <code>ontology/loader.py</code></h3>
<pre><code class="language-python">class OntologyCatalog(Protocol):
    def load(self, inputs: list[dict]) -&gt; list[Concept]: ...
    def neighbors(self, concept_id: str, depth: int = 1) -&gt; list[str]: ...
    def get(self, concept_id: str) -&gt; Concept | None: ...
</code></pre>
<h3 id="c7-linker-linkinglinkerpy">C7. Linker — <code>linking/linker.py</code></h3>
<pre><code class="language-python">class Linker(Protocol):
    def candidate_concepts(self, chunk_text: str, k_sparse: int, k_lex: int) -&gt; list[str]: ...
    def score(self, chunk_vec: &quot;np.ndarray&quot;, concept_vecs: dict[str, &quot;np.ndarray&quot;], features: dict) -&gt; float: ...
    def calibrate(self, devset: list[tuple[float, int]]) -&gt; dict: ...
    def link_chunk(self, chunk: Chunk) -&gt; list[LinkAssertion]: ...
</code></pre>
<h3 id="c8-kg-builder-kg_builderneo4jpy">C8. KG builder — <code>kg_builder/neo4j.py</code></h3>
<pre><code class="language-python">class GraphStore(Protocol):
    def upsert_docs(self, docs: list[Doc]) -&gt; None: ...
    def upsert_chunks(self, chunks: list[Chunk]) -&gt; None: ...
    def upsert_concepts(self, concepts: list[Concept]) -&gt; None: ...
    def upsert_mentions(self, assertions: list[LinkAssertion]) -&gt; None: ...
    def linked_concepts(self, chunk_id: str) -&gt; list[str]: ...
</code></pre>
<h3 id="c9-search-api-search_apiapppy">C9. Search API — <code>search_api/app.py</code></h3>
<ul>
<li>
<p>Bootstraps FAISS handle(s), BM25, SPLADE, OntologyCatalog, GraphStore, DenseEmbedder; exposes FastAPI app with routers:</p>
</li>
<li>
<p><code>/search</code>, <code>/graph/concepts</code>, <code>/healthz</code>.</p>
</li>
<li>All responses validated with <code>pydantic</code> models.</li>
</ul>
<hr />
<h2 id="part-d-orchestration-prefect-2x">PART D — ORCHESTRATION (PREFECT 2.x)</h2>
<h3 id="d1-flow-graph-idempotency-keys">D1. Flow graph &amp; idempotency keys</h3>
<pre><code>harvest_and_download → convert_to_doctags → chunk_with_docling → \
embed_dense_qwen3 ┐                                        \
encode_splade_v3  ├── build_bm25_index ┐                    \
                   └── build_faiss_index  → ingest_ontologies → embed_concepts \
                                                   → link_chunks_to_concepts → kg_upsert
</code></pre>
<ul>
<li>
<p><strong>Idempotency keys</strong>:</p>
</li>
<li>
<p>Harvest: <code>(topic, years, work_id)</code></p>
</li>
<li>DocTags: <code>pdf_sha256</code></li>
<li>Chunking: <code>(doc_id, chunker_version)</code></li>
<li>Dense: <code>(chunk_dataset_id, model=Qwen3, dim=2560)</code></li>
<li>SPLADE: <code>(chunk_dataset_id, model=SPLADE-v3, topk=256)</code></li>
<li>FAISS: <code>(dense_run_id, factory, nlist, m, nprobe)</code></li>
<li>Ontology: <code>(ontology_id, src_uri, loader_version)</code></li>
<li>Linker: <code>(chunk_dataset_id, ontology_id, linker_version)</code></li>
</ul>
<h3 id="d2-concurrency-retries">D2. Concurrency &amp; retries</h3>
<ul>
<li>Download: 8 workers, retry matrix as in §B17.</li>
<li>VLM/embeddings/SPLADE: GPU queue depth=2; batch auto‑tune; 3 retries on transient errors.</li>
<li>Index builds: FAISS shards in parallel up to 2; Lucene index single‑writer with merges at end.</li>
</ul>
<h3 id="d3-cli-commands-invoke-via-typer">D3. CLI commands (invoke via Typer)</h3>
<ul>
<li><code>kgf harvest --topic "LLM alignment" --years 2018..2025 --max 20000</code></li>
<li><code>kgf doctags --input /data/pdfs --out /data/doctags</code></li>
<li><code>kgf chunk --doctags /data/doctags --out /data/parquet/chunks</code></li>
<li><code>kgf embed-dense --chunks &lt;dataset_id&gt;</code></li>
<li><code>kgf encode-splade --chunks &lt;dataset_id&gt;</code></li>
<li><code>kgf index-bm25 --chunks &lt;dataset_id&gt;</code></li>
<li><code>kgf index-faiss --dense-run &lt;run_id&gt;</code></li>
<li><code>kgf ingest-ontology --id mesh --uri /data/ontologies/mesh.obo</code></li>
<li><code>kgf embed-concepts --ontology mesh</code></li>
<li><code>kgf link --chunks &lt;dataset_id&gt; --ontology mesh</code></li>
<li><code>kgf kg-upsert --link-run &lt;run_id&gt;</code></li>
<li><code>kgf api --port 8080</code></li>
</ul>
<hr />
<h2 id="part-e-endtoend-acceptance-criteria-per-workstream">PART E — END‑TO‑END ACCEPTANCE CRITERIA (PER WORKSTREAM)</h2>
<p><strong>Downloader</strong></p>
<ul>
<li>Given topic and year range, at least N documents discovered; ≥95% OA downloads succeed; duplicates deduped; license persisted.</li>
</ul>
<p><strong>DocTags</strong></p>
<ul>
<li>For each PDF, DocTags exists; pages count &gt; 0; avg_logprob recorded; OCR fallback pages tracked.</li>
</ul>
<p><strong>Chunking</strong></p>
<ul>
<li>For each <code>doc_id</code>, sum of chunk spans covers ≥90% of canonical text; token counts in [min,max]; offsets monotonic.</li>
</ul>
<p><strong>Dense embeddings</strong></p>
<ul>
<li>Row count == chunk rows; all vectors dim=2560; Parquet schema validated; L2 norms avg in [0.95,1.05] post‑norm.</li>
</ul>
<p><strong>SPLADE/BM25</strong></p>
<ul>
<li>SPLADE nnz distribution mean ≈ 220–260; Lucene impact index has postings; BM25 index doc count == chunk count.</li>
</ul>
<p><strong>FAISS</strong></p>
<ul>
<li>Trained index exists; top‑K search returns results; p95 latency ≤ 40 ms for K=200 on fixture set.</li>
</ul>
<p><strong>Ontology &amp; concepts</strong></p>
<ul>
<li>Loaded concepts &gt; 0; no duplicate CURIEs; concept embeddings Parquet rows == concepts; ontology edges inserted.</li>
</ul>
<p><strong>Linker</strong></p>
<ul>
<li>Produces assertions; on fixtures F1 ≥ 0.70; ECE ≤ 0.08; calibration saved and applied.</li>
</ul>
<p><strong>KG</strong></p>
<ul>
<li>Node uniqueness constraints enforced; edge counts match assertions; query <code>linked_concepts(chunk)</code> returns expected IDs.</li>
</ul>
<p><strong>Search API</strong></p>
<ul>
<li><code>/healthz</code> OK; <code>/search</code> returns k results with explanations; p95 ≤ 300 ms on fixtures.</li>
</ul>
<hr />
<h2 id="part-f-sample-openapi-excerpt">PART F — SAMPLE OPENAPI (EXCERPT)</h2>
<pre><code class="language-yaml">openapi: 3.1.0
info: {title: kgfoundry Search API, version: 1.0.0}
paths:
  /search:
    post:
      security: [{ApiKeyAuth: []}]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query: {type: string, minLength: 1}
                k: {type: integer, minimum: 1, maximum: 100, default: 10}
                filters:
                  type: object
                  properties:
                    year_from: {type: integer}
                    year_to: {type: integer}
                    source: {type: array, items: {type: string}}
                    license: {type: array, items: {type: string}}
                explain: {type: boolean, default: false}
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/Result'
        '400': {$ref: '#/components/responses/BadRequest'}
        '401': {$ref: '#/components/responses/Unauthorized'}
        '429': {$ref: '#/components/responses/TooManyRequests'}
        '500': {$ref: '#/components/responses/ServerError'}
components:
  securitySchemes:
    ApiKeyAuth:
      type: http
      scheme: bearer
  schemas:
    Result:
      type: object
      required: [doc_id, chunk_id, title, section, score]
      properties:
        doc_id: {type: string}
        chunk_id: {type: string}
        title: {type: string}
        section: {type: string}
        score: {type: number}
        signals:
          type: object
          properties:
            dense: {type: number}
            sparse: {type: number}
            rrf: {type: number}
            kg_boost: {type: number}
        spans:
          type: object
          properties:
            start_char: {type: integer}
            end_char: {type: integer}
        concepts:
          type: array
          items:
            type: object
            properties:
              concept_id: {type: string}
              label: {type: string}
              match: {type: string, enum: [direct,nearby]}
</code></pre>
<hr />
<h2 id="part-g-implementation-checklists-by-workstream">PART G — IMPLEMENTATION CHECKLISTS (BY WORKSTREAM)</h2>
<ol>
<li>
<p><strong>Download &amp; Harvest</strong></p>
</li>
<li>
<p>[ ] PyAlex client; config; retries; polite UA.</p>
</li>
<li>[ ] Fallback Unpaywall client; DOI resolver.</li>
<li>[ ] PDF validator; MIME/size checks; hash; dedup; storage path; registry insert.</li>
<li>
<p>[ ] Metrics/logs/tests; CLI command; E2E hooks.</p>
</li>
<li>
<p><strong>DocTags Conversion</strong></p>
</li>
<li>
<p>[ ] vLLM client; page batches; OCR fallback; canonicalizer; provenance.</p>
</li>
<li>
<p>[ ] Persist <code>.dt.json.zst</code>; register DoctagsAsset; golden tests.</p>
</li>
<li>
<p><strong>Hybrid Chunker</strong></p>
</li>
<li>
<p>[ ] Qwen tokenizer; section splitting; sliding windows; spans &amp; offsets.</p>
</li>
<li>
<p>[ ] Parquet writer; ID scheme; tests for bounds &amp; coverage.</p>
</li>
<li>
<p><strong>Dense Embedder (Qwen3 2560)</strong></p>
</li>
<li>
<p>[ ] OpenAI API client; dimension param; batching; normalization; retries.</p>
</li>
<li>
<p>[ ] Parquet writer; registry run; throughput metric; tests.</p>
</li>
<li>
<p><strong>SPLADE‑v3 &amp; BM25</strong></p>
</li>
<li>
<p>[ ] Torch encoder; AMP; top‑K; Parquet writer; impact index streaming.</p>
</li>
<li>
<p>[ ] BM25 analyzer config; indexer; search adapter; tests.</p>
</li>
<li>
<p><strong>FAISS GPU/cuVS</strong></p>
</li>
<li>
<p>[ ] Loader; training sampler; add &amp; search; shard manager; save/load.</p>
</li>
<li>
<p>[ ] Query adapter (top‑K); memory gauges; tests.</p>
</li>
<li>
<p><strong>Ontology &amp; Concepts</strong></p>
</li>
<li>
<p>[ ] Parsers (OBO/OWL/SKOS); normalization; CURIEs; edges.</p>
</li>
<li>
<p>[ ] Dense &amp; SPLADE embeddings for concepts; Parquet &amp; registry.</p>
</li>
<li>
<p><strong>Linker</strong></p>
</li>
<li>
<p>[ ] Candidate gen (SPLADE+lexicon); feature extractor; fusion; calibration; thresholds.</p>
</li>
<li>
<p>[ ] Assertions Parquet; metrics; tests.</p>
</li>
<li>
<p><strong>KG Builder (Neo4j)</strong></p>
</li>
<li>
<p>[ ] Node/edge upserts; uniqueness constraints; indexes.</p>
</li>
<li>
<p>[ ] Linked concept lookups; tests.</p>
</li>
<li>
<p><strong>Search API</strong></p>
<ul>
<li>[ ] Startup wiring; RRF; KG boosts; MMR; filters; auth; rate limits.</li>
<li>[ ] OpenAPI; integration tests; latency regression tests.</li>
</ul>
</li>
<li>
<p><strong>Registry &amp; Orchestration</strong></p>
<ul>
<li>[ ] Migrations; two‑phase dataset registration; events &amp; incidents.</li>
<li>[ ] Prefect flows; CLI; idempotency keys; dashboards.</li>
</ul>
</li>
<li>
<p><strong>Ops</strong></p>
<ul>
<li>[ ] systemd units; Nginx config; health checks; log rotation; backup scripts (Parquet+DuckDB).</li>
</ul>
</li>
</ol>
<hr />
<h2 id="part-h-example-config-final-ready-to-commit">PART H — EXAMPLE CONFIG (FINAL; READY TO COMMIT)</h2>
<pre><code class="language-yaml">system:
  os: ubuntu-24.04
  threads: 14
  seed: 42
  parquet_root: /data/parquet
  artifacts_root: /data/artifacts
  duckdb_path: /data/catalog/catalog.duckdb

runtime:
  python: &quot;3.13&quot;
  cuda: &quot;13.0&quot;
  torch: &quot;2.9&quot;
  duckdb_min: &quot;1.4.1&quot;
  vllm_channel: &quot;pre-release-cuda13&quot;

network:
  nginx_port: 80
  vlm_port: 8001
  emb_port: 8002
  api_port: 8080

harvest:
  provider: pyalex
  per_page: 200
  max_works: 20000
  years: &quot;&gt;=2018&quot;
  filters:
    is_oa: true
    has_oa_published_version: true
  fallbacks:
    unpaywall: true
    arxiv: true
    pmc: true
  concurrency: 8
  timeout_sec: 60
  retries: 3

doc_conversion:
  vlm_model: ibm-granite/granite-docling-258M
  vlm_revision: untied
  endpoint: http://localhost/vlm/
  dpi: 220
  page_batch: 8
  ocr_fallback: true
  max_pages: 2000
  timeout_sec: 120

chunking:
  engine: docling_hybrid
  target_tokens: 400
  overlap_tokens: 80
  min_tokens: 120
  max_tokens: 480

dense_embedding:
  model: Qwen/Qwen3-Embedding-4B
  endpoint: http://localhost/v1/embeddings
  output_dim: 2560
  parquet_out: ${system.parquet_root}/dense/model=Qwen3-Embedding-4B/run=${run_id}

sparse_embedding:
  splade:
    model: naver/splade-v3-distilbert
    device: cuda
    amp: fp16
    max_seq_len: 512
    topk: 256
    parquet_out: ${system.parquet_root}/sparse/model=SPLADE-v3-distilbert/run=${run_id}
  bm25:
    k1: 0.9
    b: 0.4
    field_boosts: { title: 2.0, section: 1.2, body: 1.0 }
    index_dir: /data/lucene/bm25

faiss:
  index_factory: OPQ64,IVF8192,PQ64
  nprobe: 64
  train_samples: 10000000
  shards:
    max_vectors_per_shard: 10000000
  gpu: true
  cuvs: true
  output_dir: /data/faiss/qwen3_ivfpq

ontology:
  inputs:
    - { ontology_id: mesh, format: obo, uri: /data/ontologies/mesh.obo }
    - { ontology_id: go,   format: obo, uri: /data/ontologies/go.obo }
  concept_embed:
    dense_model: Qwen3-Embedding-4B
    dense_dim: 2560
    splade_model: SPLADE-v3-distilbert
    splade_topk: 128

linker:
  candidates: { splade_topk: 100, lexicon_topk: 50 }
  fusion_weights: { dense: 0.55, sparse: 0.35, lexical: 0.10, depth_bonus_per_level: 0.02, depth_cap: 0.10 }
  thresholds: { high: 0.62, low: 0.35 }
  calibration: isotonic

graph:
  backend: neo4j
  uri: bolt://localhost:7687
  user: neo4j
  password_env: NEO4J_PASSWORD

search:
  k: 10
  dense_candidates: 200
  sparse_candidates: 200
  rrf_k: 60
  mmr_lambda: 0.7
  kg_boosts: { direct: 0.08, one_hop: 0.04 }
</code></pre>
<hr />
<h2 id="part-i-what-happens-next">PART I — WHAT HAPPENS NEXT</h2>
<p>With these <strong>resolved specifications</strong>:</p>
<ul>
<li>Each workstream has <strong>clear interfaces</strong>, <strong>error types</strong>, <strong>Parquet schemas</strong>, <strong>DuckDB DDL</strong>, <strong>router/API contracts</strong>, <strong>orchestration flows</strong>, <strong>observability</strong>, <strong>SLAs</strong>, and <strong>acceptance tests</strong>.</li>
<li>Teams can now draft <strong>detailed implementation plans</strong> and begin coding, confident that components will integrate cleanly on the single‑box target environment.</li>
</ul>
<p>If you want, I can generate <strong>skeleton packages</strong> (directories, ABCs, Pydantic models, Typer CLI, Prefect flows, Makefile, pre‑commit, and sample tests) to serve as the starting point for implementation.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.indexes"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>