# Hypercorn configuration for the CodeIntel MCP service.
# -----------------------------------------------------------------------------
# Topology A (default):
#   - NGINX terminates TLS/H3 on :443 and forwards HTTP/1.1 to 127.0.0.1:8080.
#   - Hypercorn stays on loopback and never handles certificates directly.
# Comment out the bind below and enable the second block to switch to Topology B.
# -----------------------------------------------------------------------------
bind = ["127.0.0.1:8080"]

# Worker/process tuning -------------------------------------------------------
workers = 2                          # match CPU cores for personal-scale hosts
worker_class = "asyncio"             # uvloop/trio can be enabled via CLI extras
graceful_timeout = 20
keep_alive_timeout = 75              # generous for SSE streaming
max_requests = 0                     # disable automatic worker cycling

# Logging & observability -----------------------------------------------------
accesslog = "-"
errorlog = "-"
loglevel = "info"

# HTTP2/H3 negotiation --------------------------------------------------------
alpn_protocols = ["h2", "http/1.1"]
alt_svc_headers = ["h3=\":443\"; ma=86400"]
h2_max_concurrent_streams = 128
websocket_max_message_size = 16777216
ssl_handshake_timeout = 60
server_names = ["mcp.example.com", "localhost"]

# -----------------------------------------------------------------------------
# Topology B (end-to-end HTTP/3 to Hypercorn):
#   1. Uncomment the block below.
#   2. Ensure UDP/TCP 443 (or 8443) are open to this host.
#   3. Point NGINX stream pass-through (ops/nginx/h3_passthrough.conf) at the
#      same port so QUIC remains end-to-end.
# -----------------------------------------------------------------------------
# bind = ["0.0.0.0:8443"]            # TCP/TLS for HTTP/1.1 + HTTP/2
# quic_bind = ["0.0.0.0:8443"]       # UDP/QUIC for HTTP/3
# certfile = "/etc/letsencrypt/live/mcp.example.com/fullchain.pem"
# keyfile = "/etc/letsencrypt/live/mcp.example.com/privkey.pem"
# verify_mode = "none"               # optional client-cert validation
