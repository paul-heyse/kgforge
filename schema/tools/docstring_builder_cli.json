{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://kgfoundry.dev/schema/docstring-builder-cli.json",
  "title": "DocstringBuilderCLIResult",
  "description": "Machine-readable response emitted by tools.docstring_builder.cli when invoked with --json.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "schemaId",
    "status",
    "generatedAt",
    "summary",
    "policy",
    "files",
    "errors"
  ],
  "properties": {
    "schemaVersion": {
      "description": "Semantic version of this schema.",
      "type": "string",
      "const": "1.0.0"
    },
    "schemaId": {
      "description": "Canonical identifier for this schema.",
      "type": "string",
      "const": "https://kgfoundry.dev/schema/docstring-builder-cli.json"
    },
    "status": {
      "$ref": "#/$defs/RunStatus"
    },
    "generatedAt": {
      "description": "ISO 8601 timestamp for when the payload was generated.",
      "type": "string",
      "format": "date-time"
    },
    "command": {
      "description": "Top-level command executed (update/check/fmt/harvest).",
      "type": "string"
    },
    "subcommand": {
      "description": "Specific subcommand invoked by the user.",
      "type": "string"
    },
    "durationSeconds": {
      "description": "Total runtime for the CLI invocation in seconds.",
      "type": "number",
      "minimum": 0
    },
    "files": {
      "description": "Per-file processing outcomes.",
      "type": "array",
      "items": {
        "$ref": "#/$defs/FileReport"
      }
    },
    "errors": {
      "description": "Top-level errors encountered during execution.",
      "type": "array",
      "items": {
        "$ref": "#/$defs/ErrorReport"
      }
    },
    "summary": {
      "$ref": "#/$defs/RunSummary"
    },
    "policy": {
      "$ref": "#/$defs/PolicyReport"
    },
    "baseline": {
      "description": "Reference revision or path used for baseline comparisons.",
      "type": "string"
    },
    "cache": {
      "$ref": "#/$defs/CacheSummary"
    },
    "inputs": {
      "description": "Mapping of processed file paths to hash metadata.",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/InputHash"
      }
    },
    "plugins": {
      "$ref": "#/$defs/PluginReport"
    },
    "docfacts": {
      "$ref": "#/$defs/DocfactsReport"
    },
    "observability": {
      "$ref": "#/$defs/ObservabilityReport"
    },
    "problem": {
      "$ref": "#/$defs/ProblemDetails"
    }
  },
  "$defs": {
    "RunStatus": {
      "description": "Aggregate run status.",
      "type": "string",
      "enum": [
        "success",
        "violation",
        "config",
        "error"
      ]
    },
    "FileStatus": {
      "description": "Status for a single processed file.",
      "type": "string",
      "enum": [
        "success",
        "violation",
        "config",
        "error"
      ]
    },
    "ProblemDetails": {
      "description": "RFC 9457 Problem Details payload used for error reporting.",
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "title",
        "status",
        "detail",
        "instance"
      ],
      "properties": {
        "type": {
          "type": "string",
          "format": "uri"
        },
        "title": {
          "type": "string"
        },
        "status": {
          "type": "integer",
          "minimum": 100,
          "maximum": 599
        },
        "detail": {
          "type": "string"
        },
        "instance": {
          "type": "string"
        },
        "extensions": {
          "description": "Domain-specific metadata attached to the problem.",
          "type": "object"
        }
      }
    },
    "FileReport": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "path",
        "status",
        "changed",
        "skipped",
        "cacheHit"
      ],
      "properties": {
        "path": {
          "type": "string"
        },
        "status": {
          "$ref": "#/$defs/FileStatus"
        },
        "changed": {
          "type": "boolean"
        },
        "skipped": {
          "type": "boolean"
        },
        "cacheHit": {
          "type": "boolean"
        },
        "message": {
          "type": "string"
        },
        "preview": {
          "type": "string"
        },
        "baseline": {
          "type": "string"
        },
        "problem": {
          "$ref": "#/$defs/ProblemDetails"
        }
      }
    },
    "ErrorReport": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "file",
        "status",
        "message"
      ],
      "properties": {
        "file": {
          "type": "string"
        },
        "status": {
          "$ref": "#/$defs/FileStatus"
        },
        "message": {
          "type": "string"
        },
        "problem": {
          "$ref": "#/$defs/ProblemDetails"
        }
      }
    },
    "PolicyViolation": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "rule",
        "symbol",
        "action",
        "message"
      ],
      "properties": {
        "rule": {
          "type": "string"
        },
        "symbol": {
          "type": "string"
        },
        "action": {
          "type": "string"
        },
        "message": {
          "type": "string"
        }
      }
    },
    "PolicyReport": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "coverage",
        "threshold",
        "violations"
      ],
      "properties": {
        "coverage": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "violations": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/PolicyViolation"
          }
        }
      }
    },
    "StatusCounts": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "success",
        "violation",
        "config",
        "error"
      ],
      "properties": {
        "success": {
          "type": "integer",
          "minimum": 0
        },
        "violation": {
          "type": "integer",
          "minimum": 0
        },
        "config": {
          "type": "integer",
          "minimum": 0
        },
        "error": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "RunSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "considered",
        "processed",
        "skipped",
        "changed",
        "status_counts",
        "docfacts_checked",
        "cache_hits",
        "cache_misses",
        "duration_seconds",
        "subcommand"
      ],
      "properties": {
        "considered": {
          "type": "integer",
          "minimum": 0
        },
        "processed": {
          "type": "integer",
          "minimum": 0
        },
        "skipped": {
          "type": "integer",
          "minimum": 0
        },
        "changed": {
          "type": "integer",
          "minimum": 0
        },
        "status_counts": {
          "$ref": "#/$defs/StatusCounts"
        },
        "docfacts_checked": {
          "type": "boolean"
        },
        "cache_hits": {
          "type": "integer",
          "minimum": 0
        },
        "cache_misses": {
          "type": "integer",
          "minimum": 0
        },
        "duration_seconds": {
          "type": "number",
          "minimum": 0
        },
        "subcommand": {
          "type": "string"
        }
      }
    },
    "CacheSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "path",
        "exists",
        "hits",
        "misses",
        "mtime"
      ],
      "properties": {
        "path": {
          "type": "string"
        },
        "exists": {
          "type": "boolean"
        },
        "hits": {
          "type": "integer",
          "minimum": 0
        },
        "misses": {
          "type": "integer",
          "minimum": 0
        },
        "mtime": {
          "type": [
            "string",
            "null"
          ],
          "description": "ISO 8601 timestamp for the cache file or null when missing."
        }
      }
    },
    "InputHash": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "hash",
        "mtime"
      ],
      "properties": {
        "hash": {
          "type": "string"
        },
        "mtime": {
          "type": [
            "string",
            "null"
          ]
        }
      }
    },
    "PluginReport": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "enabled",
        "available",
        "disabled",
        "skipped"
      ],
      "properties": {
        "enabled": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "available": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "disabled": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "skipped": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "DocfactsReport": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "path",
        "version",
        "validated"
      ],
      "properties": {
        "path": {
          "type": "string"
        },
        "version": {
          "type": "string"
        },
        "validated": {
          "type": "boolean"
        },
        "diff": {
          "type": [
            "string",
            "null"
          ]
        }
      }
    },
    "ObservabilityReport": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "status",
        "errors"
      ],
      "properties": {
        "status": {
          "$ref": "#/$defs/RunStatus"
        },
        "errors": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/ErrorReport"
          }
        },
        "driftPreviews": {
          "description": "Relative paths to generated drift preview artefacts.",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    }
  },
  "examples": [
    {
      "schemaVersion": "1.0.0",
      "schemaId": "https://kgfoundry.dev/schema/docstring-builder-cli.json",
      "status": "success",
      "generatedAt": "2025-10-30T12:00:00Z",
      "command": "update",
      "subcommand": "generate",
      "durationSeconds": 18.42,
      "files": [
        {
          "path": "src/docling/canonicalizer.py",
          "status": "success",
          "changed": true,
          "skipped": false,
          "cacheHit": false
        }
      ],
      "errors": [],
      "summary": {
        "considered": 12,
        "processed": 12,
        "skipped": 0,
        "changed": 2,
        "status_counts": {
          "success": 12,
          "violation": 0,
          "config": 0,
          "error": 0
        },
        "docfacts_checked": true,
        "cache_hits": 5,
        "cache_misses": 7,
        "duration_seconds": 18.42,
        "subcommand": "generate"
      },
      "policy": {
        "coverage": 0.94,
        "threshold": 0.9,
        "violations": []
      },
      "cache": {
        "path": ".cache/docstring_builder.json",
        "exists": true,
        "hits": 5,
        "misses": 7,
        "mtime": "2025-10-30T11:59:00Z"
      },
      "inputs": {
        "src/docling/canonicalizer.py": {
          "hash": "e3b0c44298fc1c149afbf4c8996fb924",
          "mtime": "2025-10-30T11:58:12Z"
        }
      },
      "plugins": {
        "enabled": [
          "summary_rewriter"
        ],
        "available": [
          "summary_rewriter",
          "dataclass_fields"
        ],
        "disabled": [],
        "skipped": []
      },
      "docfacts": {
        "path": "docs/_build/docfacts.json",
        "version": "2.0",
        "validated": true,
        "diff": null
      }
    },
    {
      "schemaVersion": "1.0.0",
      "schemaId": "https://kgfoundry.dev/schema/docstring-builder-cli.json",
      "status": "error",
      "generatedAt": "2025-10-30T12:05:00Z",
      "command": "check",
      "subcommand": "check",
      "durationSeconds": 4.01,
      "files": [
        {
          "path": "src/docling/canonicalizer.py",
          "status": "error",
          "changed": false,
          "skipped": false,
          "cacheHit": false,
          "problem": {
            "type": "https://kgfoundry.dev/problems/docbuilder/schema-mismatch",
            "title": "DocFacts schema validation failed",
            "status": 422,
            "detail": "Field anchors.endLine is missing",
            "instance": "urn:docbuilder:run:2025-10-30T12:05:00Z",
            "extensions": {
              "schemaVersion": "2.0.0",
              "symbol": "kg.module.function"
            }
          }
        }
      ],
      "errors": [
        {
          "file": "src/docling/canonicalizer.py",
          "status": "error",
          "message": "DocFacts schema validation failed.",
          "problem": {
            "type": "https://kgfoundry.dev/problems/docbuilder/schema-mismatch",
            "title": "DocFacts schema validation failed",
            "status": 422,
            "detail": "Field anchors.endLine is missing",
            "instance": "urn:docbuilder:run:2025-10-30T12:05:00Z",
            "extensions": {
              "schemaVersion": "2.0.0",
              "symbol": "kg.module.function"
            }
          }
        }
      ],
      "summary": {
        "considered": 1,
        "processed": 1,
        "skipped": 0,
        "changed": 0,
        "status_counts": {
          "success": 0,
          "violation": 0,
          "config": 0,
          "error": 1
        },
        "docfacts_checked": false,
        "cache_hits": 0,
        "cache_misses": 1,
        "duration_seconds": 4.01,
        "subcommand": "check"
      },
      "policy": {
        "coverage": 0.72,
        "threshold": 0.9,
        "violations": [
          {
            "rule": "missing-example",
            "symbol": "kg.module.function",
            "action": "error",
            "message": "Examples section missing."
          }
        ]
      },
      "problem": {
        "type": "https://kgfoundry.dev/problems/docbuilder/schema-mismatch",
        "title": "DocFacts schema validation failed",
        "status": 422,
        "detail": "Field anchors.endLine is missing",
        "instance": "urn:docbuilder:run:2025-10-30T12:05:00Z",
        "extensions": {
          "schemaVersion": "2.0.0",
          "docstringBuilderVersion": "1.6.0"
        }
      }
    }
  ]
}
