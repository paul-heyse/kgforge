{"parents": [{"link": "../", "title": "Explanations"}], "prev": {"link": "../", "title": "Explanations"}, "next": {"link": "../251025_FAISS_whl_overview/", "title": "Updated cuVS Addendum"}, "title": "Implementation-Grade Architecture Overview", "meta": {"wordcount": {"words": 3660, "minutes": 18}}, "body": "<section id=\"implementation-grade-architecture-overview\">\n<h1>Implementation-Grade Architecture Overview<a class=\"headerlink\" href=\"#implementation-grade-architecture-overview\" title=\"Link to this heading\">#</a></h1>\n<p>Below is the <strong>fully elaborated, implementation\u2011grade architecture</strong> for your end\u2011to\u2011end, single\u2011machine system. It updates <strong>every topic</strong> from the original plan and adds all <strong>new constraints</strong> you set:</p>\n<ul class=\"simple\">\n<li><p><strong>OS/Host</strong>: Ubuntu 24.04 (single box, no external servers).</p></li>\n<li><p><strong>GPU</strong>: NVIDIA RTX 5090 (CUDA <strong>13.0</strong> toolchain).</p></li>\n<li><p><strong>CPU/RAM</strong>: AMD 9950X (16 cores), 192\u202fGB RAM.</p></li>\n<li><p><strong>Python</strong>: <strong>3.13</strong>.</p></li>\n<li><p><strong>PyTorch</strong>: <strong>2.9</strong> (CUDA 13 build).</p></li>\n<li><p><strong>vLLM</strong>: latest <strong>pre\u2011release</strong> that supports CUDA 13.</p></li>\n<li><p><strong>DuckDB</strong>: <strong>\u2265\u202f1.4.1</strong> (interpreting your \u201c1.41\u201d as <strong>1.4.1</strong>).</p></li>\n<li><p><strong>Dense embeddings</strong>: <strong>Qwen3\u2011Embedding\u20114B</strong> at <strong>2560\u2011dimensional</strong> output.</p></li>\n<li><p><strong>Sparse embeddings</strong>: <strong>BM25</strong> + <strong>SPLADE\u2011v3</strong> (GPU).</p></li>\n<li><p><strong>PDF\u2192DocTags &amp; chunking</strong>: <strong>Docling VLM (Granite\u2011Docling)</strong> + <strong>Docling HybridChunker</strong>.</p></li>\n<li><p><strong>All embeddings in Parquet</strong> (no JSONL at rest).</p></li>\n<li><p><strong>Vector indexing &amp; ops</strong>: <strong>FAISS GPU</strong> with <strong>cuVS</strong> enabled.</p></li>\n<li><p><strong>Model serving</strong>: a <strong>single logical endpoint</strong> fronting <strong>two local vLLM processes</strong> (Granite\u2011Docling VLM + Qwen3\u2011Embedding\u20114B), routed by <strong>Nginx</strong> (necessary because one vLLM process \u2259 one base model).</p></li>\n<li><p><strong>Registry</strong>: all artifacts (PDFs, DocTags, chunks, embeddings, indices, ontologies, links) registered in local <strong>DuckDB</strong>.</p></li>\n</ul>\n<hr class=\"docutils\" />\n<section id=\"big-picture-endtoend-singlebox\">\n<h2>0) Big picture (end\u2011to\u2011end, single\u2011box)<a class=\"headerlink\" href=\"#big-picture-endtoend-singlebox\" title=\"Link to this heading\">#</a></h2>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span>Topic \u2192 (PyAlex) Harvest &amp; OA PDF Download (with fallbacks)\n     \u2192 Docling VLM (Granite\u2011Docling) \u2192 DocTags\n     \u2192 Docling HybridChunker \u2192 Chunk Parquet\n     \u2192 Dense (Qwen3\u2011Embedding\u20114B, 2560\u2011d via vLLM) \u2192 Parquet \u2192 FAISS (GPU, cuVS)\n     \u2192 Sparse (SPLADE\u2011v3, GPU \u2192 Parquet \u2192 Lucene impact) + BM25 (Lucene)\n     \u2192 Ontology ingest \u2192 Concept catalog + embeddings (dense 2560\u2011d + SPLADE)\n     \u2192 Chunk\u2013Concept linker \u2192 Assertions (Parquet) \u2192 KG (Neo4j local)\n     \u2192 Hybrid search API (FAISS + BM25 + SPLADE + KG\u2011aware rerank)\n     \u2192 Everything registered in DuckDB (\u22651.4.1)\n</pre></div>\n</div>\n<p><strong>Architectural style</strong>: <strong>Ports &amp; Adapters (Hexagonal)</strong> + <strong>Domain contracts</strong> (Pydantic v2) + <strong>Plugin registry</strong> (entry points) + <strong>Immutable, content\u2011addressed artifacts</strong>. All heavy compute runs <strong>locally</strong> (no remote compute/storage).</p>\n</section>\n<hr class=\"docutils\" />\n<section id=\"design-principles-concretized\">\n<h2>1) Design principles (concretized)<a class=\"headerlink\" href=\"#design-principles-concretized\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>Interface\u2011first</strong>: every subsystem exposes an ABC (Abstract Base Class). Impl classes are pluggable via entry\u2011points.</p></li>\n<li><p><strong>Encapsulation &amp; cohesion</strong>: one public fa\u00e7ade per package; internals hidden. Each module owns a single concern.</p></li>\n<li><p><strong>Idempotency</strong>: outputs keyed by <strong>content hashes</strong>; re\u2011runs never duplicate artifacts.</p></li>\n<li><p><strong>Determinism</strong>: global <code class=\"docutils literal notranslate\"><span class=\"pre\">seed=42</span></code>, fixed training samples for FAISS, fixed chunking parameters.</p></li>\n<li><p><strong>All embeddings in Parquet</strong>: columnar, compressed with <strong>ZSTD=6</strong>, <strong>row_group=4096</strong>; <strong>no JSONL</strong> persisted.</p></li>\n<li><p><strong>Observability from day one</strong>: OpenTelemetry traces; structured logs with artifact IDs; Prometheus counters/histograms.</p></li>\n<li><p><strong>Local\u2011only</strong>: no remote indices or vector DBs; FAISS, Pyserini, Neo4j, DuckDB all on the box.</p></li>\n<li><p><strong>Security (local)</strong>: vLLM bound to localhost; Nginx fronts a single endpoint; API\u2011key auth for the search API.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"repository-layout-monorepo-independently-ownable-packages\">\n<h2>2) Repository layout (monorepo; independently ownable packages)<a class=\"headerlink\" href=\"#repository-layout-monorepo-independently-ownable-packages\" title=\"Link to this heading\">#</a></h2>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"o\">/</span><span class=\"n\">src</span>\n  <span class=\"o\">/</span><span class=\"n\">kgfoundry_common</span>            <span class=\"c1\"># contracts, IDs, hashing, config, utils</span>\n  <span class=\"o\">/</span><span class=\"n\">download</span>                  <span class=\"c1\"># PyAlex harvester + OA PDF downloader + fallbacks</span>\n  <span class=\"o\">/</span><span class=\"n\">docling</span>                   <span class=\"c1\"># VLM convert-to-DocTags + HybridChunker wrappers</span>\n  <span class=\"o\">/</span><span class=\"n\">embeddings_dense</span>          <span class=\"c1\"># vLLM client, Qwen3-Embedding-4B (2560-d)</span>\n  <span class=\"o\">/</span><span class=\"n\">embeddings_sparse</span>         <span class=\"c1\"># SPLADE-v3 GPU encoder (Parquet) + BM25/SPLADE indices (Pyserini)</span>\n  <span class=\"o\">/</span><span class=\"n\">vectorstore_faiss</span>         <span class=\"c1\"># FAISS GPU/cuVS index build/search adapters</span>\n  <span class=\"o\">/</span><span class=\"n\">ontology</span>                  <span class=\"c1\"># OWL/OBO/SKOS loaders, normalization, concept embeddings</span>\n  <span class=\"o\">/</span><span class=\"n\">linking</span>                   <span class=\"c1\"># candidate gen, scoring, calibration, assertions</span>\n  <span class=\"o\">/</span><span class=\"n\">kg_builder</span>                <span class=\"c1\"># Neo4j adapter; nodes/edges upsert</span>\n  <span class=\"o\">/</span><span class=\"n\">search_api</span>                <span class=\"c1\"># FastAPI; hybrid retrieval + KG-aware rerank; OpenAPI</span>\n  <span class=\"o\">/</span><span class=\"n\">orchestration</span>             <span class=\"c1\"># Prefect flows &amp; CLI commands (local)</span>\n  <span class=\"o\">/</span><span class=\"n\">registry</span>                  <span class=\"c1\"># DuckDB schema, migrations, dataset registration</span>\n  <span class=\"o\">/</span><span class=\"n\">observability</span>             <span class=\"c1\"># OTEL + Prometheus exporters</span>\n<span class=\"o\">/</span><span class=\"n\">tests</span>\n<span class=\"o\">/</span><span class=\"n\">config</span>                      <span class=\"c1\"># YAML config(s), ngnix.conf, systemd units</span>\n<span class=\"o\">/</span><span class=\"n\">scripts</span>                     <span class=\"c1\"># bootstrap &amp; build scripts (CUDA 13, FAISS+cuVS, vLLM)</span>\n</pre></div>\n</div>\n<p><strong>Packaging</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">pyproject.toml</span></code> (Poetry or uv). <strong>Entry\u2011points</strong> register providers:</p>\n<div class=\"highlight-toml notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">[project.entry-points.kgfoundry.plugins]</span>\n<span class=\"n\">dense</span><span class=\"p\">.</span><span class=\"n\">qwen3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;embeddings_dense.qwen3:Qwen3Embedder&quot;</span>\n<span class=\"n\">sparse</span><span class=\"p\">.</span><span class=\"n\">splade_v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;embeddings_sparse.splade:SPLADEv3Encoder&quot;</span>\n<span class=\"n\">sparse</span><span class=\"p\">.</span><span class=\"n\">bm25</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;embeddings_sparse.bm25:BM25Index&quot;</span>\n<span class=\"n\">docling</span><span class=\"p\">.</span><span class=\"n\">vlm</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;docling.vlm:GraniteDoclingVLM&quot;</span>\n<span class=\"n\">chunker</span><span class=\"p\">.</span><span class=\"n\">docling_hybrid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;docling.hybrid:HybridChunker&quot;</span>\n<span class=\"n\">vector</span><span class=\"p\">.</span><span class=\"n\">faiss_gpu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;vectorstore_faiss.gpu:FaissGpuIndex&quot;</span>\n<span class=\"n\">graph</span><span class=\"p\">.</span><span class=\"n\">neo4j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;kg_builder.neo4j:Neo4jStore&quot;</span>\n<span class=\"n\">ontology</span><span class=\"p\">.</span><span class=\"n\">loader</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">&quot;ontology.loader:OntologyLoader&quot;</span>\n</pre></div>\n</div>\n</section>\n<hr class=\"docutils\" />\n<section id=\"core-data-contracts-pydantic-v2-contentaddressed-ids\">\n<h2>3) Core data contracts (Pydantic v2; content\u2011addressed IDs)<a class=\"headerlink\" href=\"#core-data-contracts-pydantic-v2-contentaddressed-ids\" title=\"Link to this heading\">#</a></h2>\n<blockquote>\n<div><p>Keep models lean. Payloads (large text, vectors) live in Parquet files; rows refer to them via IDs.</p>\n</div></blockquote>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># kgfoundry_common/models.py (Python 3.13, Pydantic v2)</span>\n<span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">pydantic</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">BaseModel</span><span class=\"p\">,</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">AwareDatetime</span>\n<span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Optional</span><span class=\"p\">,</span> <span class=\"n\">List</span><span class=\"p\">,</span> <span class=\"n\">Dict</span><span class=\"p\">,</span> <span class=\"n\">Literal</span>\n<span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">dataclasses</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">dataclass</span>\n\n<span class=\"n\">Id</span> <span class=\"o\">=</span> <span class=\"nb\">str</span>  <span class=\"c1\"># URN-like opaque IDs, stable and content-addressed</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Doc</span><span class=\"p\">(</span><span class=\"n\">BaseModel</span><span class=\"p\">):</span>\n    <span class=\"nb\">id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>                           <span class=\"c1\"># urn:doc:sha256:&lt;16b&gt;</span>\n    <span class=\"n\">openalex_id</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">doi</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">arxiv_id</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">pmcid</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">title</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n    <span class=\"n\">authors</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"n\">pub_date</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>   <span class=\"c1\"># ISO8601</span>\n    <span class=\"n\">license</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">language</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;en&quot;</span>\n    <span class=\"n\">pdf_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                     <span class=\"c1\"># local path (e.g., /data/pdfs/&lt;id&gt;.pdf)</span>\n    <span class=\"n\">source</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                      <span class=\"c1\"># &#39;openalex&#39;, &#39;arxiv&#39;, &#39;pmc&#39;, ...</span>\n    <span class=\"n\">content_hash</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                <span class=\"c1\"># sha256 of canonical text (after DocTags-&gt;text)</span>\n    <span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">AwareDatetime</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">DoctagsAsset</span><span class=\"p\">(</span><span class=\"n\">BaseModel</span><span class=\"p\">):</span>\n    <span class=\"n\">doc_id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>\n    <span class=\"n\">doctags_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                 <span class=\"c1\"># /data/doctags/&lt;doc_id&gt;.dt.json.zst</span>\n    <span class=\"n\">pages</span><span class=\"p\">:</span> <span class=\"nb\">int</span>\n    <span class=\"n\">vlm_model</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                   <span class=\"c1\"># granite-docling-258M</span>\n    <span class=\"n\">vlm_revision</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                <span class=\"c1\"># &#39;untied&#39; if used</span>\n    <span class=\"n\">avg_logprob</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">float</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">AwareDatetime</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Chunk</span><span class=\"p\">(</span><span class=\"n\">BaseModel</span><span class=\"p\">):</span>\n    <span class=\"nb\">id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>                           <span class=\"c1\"># urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;</span>\n    <span class=\"n\">doc_id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>\n    <span class=\"n\">section</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span>\n    <span class=\"n\">start_char</span><span class=\"p\">:</span> <span class=\"nb\">int</span>\n    <span class=\"n\">end_char</span><span class=\"p\">:</span> <span class=\"nb\">int</span>\n    <span class=\"n\">tokens</span><span class=\"p\">:</span> <span class=\"nb\">int</span>\n    <span class=\"n\">doctags_span</span><span class=\"p\">:</span> <span class=\"n\">Dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">]</span>     <span class=\"c1\"># {node_id, start, end}</span>\n    <span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">AwareDatetime</span>\n    <span class=\"n\">dataset_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                  <span class=\"c1\"># backpointer to Parquet dataset</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">DenseVectorMeta</span><span class=\"p\">(</span><span class=\"n\">BaseModel</span><span class=\"p\">):</span>\n    <span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>\n    <span class=\"n\">model</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                       <span class=\"c1\"># &#39;Qwen3-Embedding-4B&#39;</span>\n    <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n    <span class=\"n\">dim</span><span class=\"p\">:</span> <span class=\"nb\">int</span>                         <span class=\"c1\"># 2560</span>\n    <span class=\"n\">l2_norm</span><span class=\"p\">:</span> <span class=\"nb\">float</span>\n    <span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">AwareDatetime</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">SparseVectorMeta</span><span class=\"p\">(</span><span class=\"n\">BaseModel</span><span class=\"p\">):</span>\n    <span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>\n    <span class=\"n\">model</span><span class=\"p\">:</span> <span class=\"nb\">str</span>                       <span class=\"c1\"># &#39;SPLADE-v3-distilbert&#39;</span>\n    <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n    <span class=\"n\">nnz</span><span class=\"p\">:</span> <span class=\"nb\">int</span>\n    <span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">AwareDatetime</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Concept</span><span class=\"p\">(</span><span class=\"n\">BaseModel</span><span class=\"p\">):</span>\n    <span class=\"nb\">id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>                           <span class=\"c1\"># urn:concept:&lt;ontology&gt;:&lt;curie&gt;</span>\n    <span class=\"n\">ontology</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n    <span class=\"n\">pref_label</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n    <span class=\"n\">alt_labels</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"n\">definition</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">parents</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">Id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"n\">meta</span><span class=\"p\">:</span> <span class=\"n\">Dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">LinkAssertion</span><span class=\"p\">(</span><span class=\"n\">BaseModel</span><span class=\"p\">):</span>\n    <span class=\"nb\">id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>                           <span class=\"c1\"># urn:assert:&lt;chunk_id&gt;:&lt;concept_id&gt;@&lt;run_id&gt;</span>\n    <span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>\n    <span class=\"n\">concept_id</span><span class=\"p\">:</span> <span class=\"n\">Id</span>\n    <span class=\"n\">score</span><span class=\"p\">:</span> <span class=\"nb\">float</span>\n    <span class=\"n\">decision</span><span class=\"p\">:</span> <span class=\"n\">Literal</span><span class=\"p\">[</span><span class=\"s1\">&#39;link&#39;</span><span class=\"p\">,</span><span class=\"s1\">&#39;reject&#39;</span><span class=\"p\">,</span><span class=\"s1\">&#39;uncertain&#39;</span><span class=\"p\">]</span>\n    <span class=\"n\">evidence_span</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">features</span><span class=\"p\">:</span> <span class=\"n\">Dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>  <span class=\"c1\"># dense_sim, sparse_sim, lexical_overlap, depth_bonus</span>\n    <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n    <span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">AwareDatetime</span>\n</pre></div>\n</div>\n<p><strong>ID scheme (deterministic)</strong></p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">doc_id</span> <span class=\"pre\">=</span> <span class=\"pre\">urn:doc:sha256:&lt;first16</span> <span class=\"pre\">bytes</span> <span class=\"pre\">of</span> <span class=\"pre\">sha256</span> <span class=\"pre\">canonical_text,</span> <span class=\"pre\">base32&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">chunk_id</span> <span class=\"pre\">=</span> <span class=\"pre\">urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">dense</span> <span class=\"pre\">vec</span> <span class=\"pre\">id</span> <span class=\"pre\">=</span> <span class=\"pre\">urn:vec:&lt;chunk_id&gt;:qwen3&#64;&lt;run_id&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">sparse</span> <span class=\"pre\">id</span> <span class=\"pre\">=</span> <span class=\"pre\">urn:sparse:&lt;chunk_id&gt;:splade_v3&#64;&lt;run_id&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">concept</span> <span class=\"pre\">id</span> <span class=\"pre\">=</span> <span class=\"pre\">urn:concept:&lt;ontology&gt;:&lt;curie&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">assertion</span> <span class=\"pre\">id</span> <span class=\"pre\">=</span> <span class=\"pre\">urn:assert:&lt;chunk_id&gt;:&lt;concept_id&gt;&#64;&lt;run_id&gt;</span></code></p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"storage-layers-adapters-ports\">\n<h2>4) Storage layers &amp; adapters (ports)<a class=\"headerlink\" href=\"#storage-layers-adapters-ports\" title=\"Link to this heading\">#</a></h2>\n<p><strong>VectorStore (FAISS GPU + cuVS)</strong></p>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">VectorStore</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">train</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">train_vectors</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">params</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">add</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">keys</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">],</span> <span class=\"n\">vectors</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">search</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]]:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">index_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">idmap_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">load</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">index_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">idmap_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n<p><strong>SparseIndex</strong></p>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">SparseIndex</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">build</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">docs_iterable</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Iterable[SparseDoc]&quot;</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">search</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"o\">|</span><span class=\"kc\">None</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]]:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">stats</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">dict</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n<p>Implementations: <strong>BM25Index</strong> (Pyserini) and <strong>SpladeImpactIndex</strong> (Pyserini).</p>\n<p><strong>GraphStore</strong></p>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">GraphStore</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">upsert_nodes</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">docs</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Doc</span><span class=\"p\">],</span> <span class=\"n\">concepts</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Concept</span><span class=\"p\">],</span> <span class=\"n\">chunks</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Chunk</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">upsert_mentions</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">assertions</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">LinkAssertion</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">neighbors</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">concept_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">depth</span><span class=\"p\">:</span><span class=\"nb\">int</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">linked_concepts</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n<p><strong>Registry (DuckDB \u22651.4.1)</strong></p>\n<ul class=\"simple\">\n<li><p>Provides <strong>DDL/migrations</strong>, <strong>safe registration</strong> (two\u2011phase commit: write Parquet \u2192 atomically register).</p></li>\n<li><p>Exposes <strong>views</strong> across Parquet datasets (union_by_name).</p></li>\n<li><p>Threading: default <strong>PRAGMA threads=14</strong>.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"orchestration-prefect-2-x-all-local\">\n<h2>5) Orchestration (Prefect 2.x; all local)<a class=\"headerlink\" href=\"#orchestration-prefect-2-x-all-local\" title=\"Link to this heading\">#</a></h2>\n<p><strong>Flows</strong> (idempotent, content\u2011hash keyed):</p>\n<ol class=\"arabic simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">harvest_and_download(topic,</span> <span class=\"pre\">years,</span> <span class=\"pre\">max_works)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">convert_to_doctags(doc_ids[])</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">chunk_with_docling(doc_ids[])</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">embed_dense_qwen3(chunk_dataset_id)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">encode_splade_v3(chunk_dataset_id)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">build_bm25_index(chunk_dataset_id)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">build_faiss_index(dense_run_id)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">ingest_ontologies(ontology_specs[])</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">embed_concepts(ontology_id)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">link_chunks_to_concepts(chunk_dataset_id,</span> <span class=\"pre\">ontology_id)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">upsert_kg(link_run_id)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">serve_search_api()</span></code> (starts uvicorn if not already)</p></li>\n</ol>\n<p><strong>Events</strong> recorded in <code class=\"docutils literal notranslate\"><span class=\"pre\">registry.pipeline_events</span></code>: <code class=\"docutils literal notranslate\"><span class=\"pre\">DocumentIngested</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">DoctagsReady</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">ChunksCreated</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">DenseEmbedded</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">SpladeEncoded</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">BM25Built</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">FAISSBuilt</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">OntologyLoaded</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">ConceptEmbeddingsReady</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">LinkerRun</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">KGUpdated</span></code>.</p>\n<p><strong>Concurrency defaults</strong>:</p>\n<ul class=\"simple\">\n<li><p>Downloader 8 parallel fetches;</p></li>\n<li><p>VLM 2 docs in flight;</p></li>\n<li><p>Dense/SPLADE batchers tuned to ~80% VRAM;</p></li>\n<li><p>FAISS build: 2 shards concurrently;</p></li>\n<li><p>All others CPU\u2011bound threads = 14.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"harvesters-pdf-download-pyalex-first-resilient-fallbacks\">\n<h2>6) Harvesters &amp; PDF download (PyAlex first; resilient fallbacks)<a class=\"headerlink\" href=\"#harvesters-pdf-download-pyalex-first-resilient-fallbacks\" title=\"Link to this heading\">#</a></h2>\n<p><strong>Workflow</strong></p>\n<ul class=\"simple\">\n<li><p><strong>Search</strong>: PyAlex (OpenAlex) by <code class=\"docutils literal notranslate\"><span class=\"pre\">topic</span></code> across title/abstract/fulltext; filter OA flags; optionally by year range.</p></li>\n<li><p>Extract candidate OA locations: <code class=\"docutils literal notranslate\"><span class=\"pre\">best_oa_location</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">primary_location</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">locations[]</span></code>, DOI, arXiv id, pmcid.</p></li>\n<li><p><strong>Download resolution</strong> (in order):</p>\n<ol class=\"arabic simple\">\n<li><p>OpenAlex <code class=\"docutils literal notranslate\"><span class=\"pre\">best_oa_location.pdf_url</span></code>.</p></li>\n<li><p>Any <code class=\"docutils literal notranslate\"><span class=\"pre\">locations[].pdf_url</span></code> with <code class=\"docutils literal notranslate\"><span class=\"pre\">is_oa=true</span></code> favoring <code class=\"docutils literal notranslate\"><span class=\"pre\">publishedVersion</span></code> or <code class=\"docutils literal notranslate\"><span class=\"pre\">acceptedVersion</span></code>.</p></li>\n<li><p><strong>Unpaywall</strong> by DOI (<code class=\"docutils literal notranslate\"><span class=\"pre\">url_for_pdf</span></code>) \u2014 requires configured contact email and rate limits.</p></li>\n<li><p><strong>Source\u2011specific</strong>:</p>\n<ul>\n<li><p>arXiv \u2192 <code class=\"docutils literal notranslate\"><span class=\"pre\">https://arxiv.org/pdf/&lt;id&gt;.pdf</span></code></p></li>\n<li><p>PubMed Central \u2192 <code class=\"docutils literal notranslate\"><span class=\"pre\">https://www.ncbi.nlm.nih.gov/pmc/articles/&lt;pmcid&gt;/pdf</span></code></p></li>\n</ul>\n</li>\n</ol>\n</li>\n<li><p><strong>License guard</strong>: accept only OA\u2011compatible licenses; persist license string on <code class=\"docutils literal notranslate\"><span class=\"pre\">Doc</span></code>.</p></li>\n<li><p><strong>Download</strong>: 8 concurrency; 60s timeout; 3 retries w/ exp backoff; <code class=\"docutils literal notranslate\"><span class=\"pre\">User-Agent</span></code> includes contact/email.</p></li>\n<li><p><strong>Storage</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/pdfs/&lt;doc_id&gt;.pdf</span></code> where <code class=\"docutils literal notranslate\"><span class=\"pre\">doc_id</span></code> derived later from canonical text (post\u2011DocTags). Temporarily name by OpenAlex ID then rename after canonicalization.</p></li>\n<li><p><strong>Registration</strong>: each successful PDF produces a <code class=\"docutils literal notranslate\"><span class=\"pre\">documents</span></code> row (openalex id, doi, license, pdf_uri, source).</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"pdf-doctags-docling-vlm-granitedocling\">\n<h2>7) PDF \u2192 <strong>DocTags</strong> (Docling VLM Granite\u2011Docling)<a class=\"headerlink\" href=\"#pdf-doctags-docling-vlm-granitedocling\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>Serving</strong>: vLLM pre\u2011release (CUDA 13) process <strong>#1</strong> on localhost:8001.</p></li>\n<li><p><strong>Router</strong>: Nginx exposes <code class=\"docutils literal notranslate\"><span class=\"pre\">/vlm/*</span> <span class=\"pre\">\u2192</span> <span class=\"pre\">8001</span></code>.</p></li>\n<li><p><strong>Defaults</strong>: DPI=220, page_batch=8, bf16 if supported, fallback fp16.</p></li>\n<li><p><strong>Quality gate</strong>: if avg token logprob &lt; 0.5 on a page \u2192 fallback OCR for that page; provenance notes retained.</p></li>\n<li><p><strong>Timeouts</strong>: 120s per 100 pages; max 2000 pages.</p></li>\n<li><p><strong>Outputs</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/doctags/&lt;doc_id&gt;.dt.json.zst</span></code>.</p></li>\n<li><p><strong>Registration</strong>: DuckDB <code class=\"docutils literal notranslate\"><span class=\"pre\">doctags</span></code> with pages, model, revision (<code class=\"docutils literal notranslate\"><span class=\"pre\">untied</span></code> if applicable), avg_logprob.</p></li>\n</ul>\n<blockquote>\n<div><p>We intentionally present one <strong>logical</strong> model endpoint via Nginx, but use <strong>two</strong> local vLLM processes (one model each) due to vLLM\u2019s one\u2011model\u2011per\u2011process design.</p>\n</div></blockquote>\n</section>\n<hr class=\"docutils\" />\n<section id=\"chunking-docling-hybridchunker\">\n<h2>8) Chunking (Docling <strong>HybridChunker</strong>)<a class=\"headerlink\" href=\"#chunking-docling-hybridchunker\" title=\"Link to this heading\">#</a></h2>\n<ul>\n<li><p><strong>Parameters</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">target_tokens=400</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">overlap=80</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">min_tokens=120</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">max_tokens=480</span></code>.</p></li>\n<li><p>Structure\u2011aware segmentation first; spillover via sliding windows.</p></li>\n<li><p>Captures <code class=\"docutils literal notranslate\"><span class=\"pre\">doctags_span</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">start_char/end_char</span></code> for explainable highlights.</p></li>\n<li><p><strong>Parquet dataset</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">parquet/chunks/model=docling_hybrid/run=&lt;run_id&gt;/part-*.parquet</span></code>\n<strong>Schema</strong>:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">doc_id</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">section</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">start_char</span><span class=\"p\">:</span> <span class=\"n\">int32</span>\n<span class=\"n\">end_char</span><span class=\"p\">:</span> <span class=\"n\">int32</span>\n<span class=\"n\">doctags_span</span><span class=\"p\">:</span> <span class=\"n\">struct</span><span class=\"o\">&lt;</span><span class=\"n\">node_id</span><span class=\"p\">:</span><span class=\"n\">string</span><span class=\"p\">,</span><span class=\"n\">start</span><span class=\"p\">:</span><span class=\"n\">int32</span><span class=\"p\">,</span><span class=\"n\">end</span><span class=\"p\">:</span><span class=\"n\">int32</span><span class=\"o\">&gt;</span>\n<span class=\"n\">text</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">tokens</span><span class=\"p\">:</span> <span class=\"n\">int32</span>\n<span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">timestamp</span>\n</pre></div>\n</div>\n</li>\n<li><p>Register resulting dataset in <code class=\"docutils literal notranslate\"><span class=\"pre\">registry.datasets</span></code> (kind=\u2019chunks\u2019) and each row in <code class=\"docutils literal notranslate\"><span class=\"pre\">chunks</span></code>.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"dense-embeddings-qwen3embedding4b-2560dim-vllm\">\n<h2>9) Dense embeddings (Qwen3\u2011Embedding\u20114B &#64; <strong>2560\u2011dim</strong>, vLLM)<a class=\"headerlink\" href=\"#dense-embeddings-qwen3embedding4b-2560dim-vllm\" title=\"Link to this heading\">#</a></h2>\n<ul>\n<li><p><strong>Serving</strong>: vLLM pre\u2011release process <strong>#2</strong> on localhost:8002; router maps <code class=\"docutils literal notranslate\"><span class=\"pre\">/v1/embeddings</span> <span class=\"pre\">\u2192</span> <span class=\"pre\">8002</span></code>.</p></li>\n<li><p><strong>Embedding length</strong>: <strong>2560</strong> (model supports 32\u20132560; set explicitly).</p></li>\n<li><p><strong>Batching</strong>: automatic; target <strong>\u2264 80%</strong> of available VRAM.</p></li>\n<li><p><strong>Normalization</strong>: L2; store norm (float32).</p></li>\n<li><p><strong>Parquet dataset</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">parquet/dense/model=Qwen3-Embedding-4B/run=&lt;run_id&gt;/part-*.parquet</span></code>\n<strong>Schema</strong>:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">model</span><span class=\"p\">:</span> <span class=\"n\">string</span>              <span class=\"o\">--</span> <span class=\"s1\">&#39;Qwen3-Embedding-4B&#39;</span>\n<span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">dim</span><span class=\"p\">:</span> <span class=\"n\">int16</span>                 <span class=\"o\">--</span> <span class=\"mi\">2560</span>\n<span class=\"n\">vector</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"o\">&lt;</span><span class=\"nb\">float</span><span class=\"o\">&gt;</span>        <span class=\"o\">--</span> <span class=\"n\">length</span><span class=\"o\">==</span><span class=\"mi\">2560</span> <span class=\"p\">(</span><span class=\"n\">float32</span> <span class=\"n\">on</span> <span class=\"n\">disk</span><span class=\"p\">)</span>\n<span class=\"n\">l2_norm</span><span class=\"p\">:</span> <span class=\"nb\">float</span>\n<span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">timestamp</span>\n</pre></div>\n</div>\n</li>\n<li><p><strong>Compression</strong>: ZSTD=6; row_group=4096; dictionary encoding on categorical cols.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"sparse-embeddings-indices-spladev3-gpu-bm25\">\n<h2>10) Sparse embeddings &amp; indices (SPLADE\u2011v3 <strong>GPU</strong> + BM25)<a class=\"headerlink\" href=\"#sparse-embeddings-indices-spladev3-gpu-bm25\" title=\"Link to this heading\">#</a></h2>\n<ul>\n<li><p><strong>SPLADE\u2011v3 encoder</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">naver/splade-v3-distilbert</span></code></p>\n<ul>\n<li><p>CUDA (Torch 2.9, cu130), AMP fp16, <code class=\"docutils literal notranslate\"><span class=\"pre\">max_seq_len=512</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">topK=256</span></code> nnz per chunk.</p></li>\n<li><p>Tokenizer: distilbert WordPiece, <code class=\"docutils literal notranslate\"><span class=\"pre\">vocab_size=30522</span></code>.</p></li>\n<li><p><strong>Parquet dataset</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">parquet/sparse/model=SPLADE-v3-distilbert/run=&lt;run_id&gt;/part-*.parquet</span></code>\n<strong>Schema</strong>:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">model</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"n\">string</span>\n<span class=\"n\">vocab_ids</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"o\">&lt;</span><span class=\"n\">int32</span><span class=\"o\">&gt;</span>    <span class=\"o\">--</span> <span class=\"nb\">sorted</span><span class=\"p\">,</span> <span class=\"n\">unique</span>\n<span class=\"n\">weights</span><span class=\"p\">:</span>   <span class=\"nb\">list</span><span class=\"o\">&lt;</span><span class=\"nb\">float</span><span class=\"o\">&gt;</span>    <span class=\"o\">--</span> <span class=\"n\">same</span> <span class=\"n\">length</span> <span class=\"k\">as</span> <span class=\"n\">vocab_ids</span>\n<span class=\"n\">nnz</span><span class=\"p\">:</span> <span class=\"n\">int16</span>\n<span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">timestamp</span>\n</pre></div>\n</div>\n</li>\n</ul>\n</li>\n<li><p><strong>Indexing</strong>: <strong>Lucene impact index</strong> (Pyserini).</p>\n<ul class=\"simple\">\n<li><p><strong>No JSONL at rest</strong>: a streaming adapter reads Parquet rows and writes directly to Lucene via Pyserini builders (any temporary files are ephemeral and excluded from registry).</p></li>\n</ul>\n</li>\n<li><p><strong>BM25</strong>: Pyserini (Lucene). Params: <strong>k1=0.9</strong>, <strong>b=0.4</strong>; field boosts <code class=\"docutils literal notranslate\"><span class=\"pre\">title^2.0,</span> <span class=\"pre\">section^1.2,</span> <span class=\"pre\">body^1.0</span></code>.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"faiss-gpu-with-cuvs-cuda-13\">\n<h2>11) FAISS (GPU with <strong>cuVS</strong>), CUDA 13<a class=\"headerlink\" href=\"#faiss-gpu-with-cuvs-cuda-13\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>Install</strong>: Prefer <strong>GPU binary</strong> (wheel) built for CUDA 13 <strong>with cuVS enabled</strong>. If unavailable, build from source with <code class=\"docutils literal notranslate\"><span class=\"pre\">-DFAISS_ENABLE_GPU=ON</span> <span class=\"pre\">-DFAISS_ENABLE_CUVS=ON</span></code>.</p></li>\n<li><p><strong>Index factory (default)</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">OPQ64,IVF8192,PQ64</span></code> (good for <strong>d=2560</strong>; OPQ pre\u2011rotation at 64; PQ m=64).</p></li>\n<li><p><strong>Training</strong>: sample <strong>10M</strong> vectors or all (if fewer), seed=42.</p></li>\n<li><p><strong>Search</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">nprobe=64</span></code>. Codes 8\u2011bit per subvector.</p></li>\n<li><p><strong>Memory</strong>: PQ codes ~<strong>64\u202fB/vector</strong> (+ID/overhead \u21d2 ~<strong>80\u2013100\u202fB/vector</strong> typical).</p></li>\n<li><p><strong>Persistence</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">.faiss</span></code> index + <code class=\"docutils literal notranslate\"><span class=\"pre\">.ids</span></code> idmap; shards \u226410M vectors each.</p></li>\n<li><p><strong>Registration</strong>: rows in DuckDB <code class=\"docutils literal notranslate\"><span class=\"pre\">faiss_indexes</span></code> (logical index id groups shards).</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"ontology-ingestion-concept-encoders\">\n<h2>12) Ontology ingestion &amp; concept encoders<a class=\"headerlink\" href=\"#ontology-ingestion-concept-encoders\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>Formats</strong>: OWL/RDF (TTL/RDF\u2011XML), OBO, SKOS.</p></li>\n<li><p><strong>Normalization</strong>: lowercase, NFC, strip most punctuation, lemmatize EN, stopword\u2011smart; build surface forms from <code class=\"docutils literal notranslate\"><span class=\"pre\">pref_label</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">alt_labels</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">synonyms</span></code>, and <code class=\"docutils literal notranslate\"><span class=\"pre\">definition</span></code>.</p></li>\n<li><p><strong>Dense concept embeddings</strong>: Qwen3\u2011Embedding\u20114B with <strong>dim=2560</strong> (concat text: <code class=\"docutils literal notranslate\"><span class=\"pre\">pref_label</span> <span class=\"pre\">|</span> <span class=\"pre\">definition</span> <span class=\"pre\">|</span> <span class=\"pre\">5</span> <span class=\"pre\">best</span> <span class=\"pre\">synonyms</span></code>).</p></li>\n<li><p><strong>Sparse concept embeddings</strong>: SPLADE\u2011v3 with <strong>topK=128</strong>.</p></li>\n<li><p><strong>Parquet datasets</strong> mirroring chunk schemas; registered in <code class=\"docutils literal notranslate\"><span class=\"pre\">concept_embeddings</span></code>.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"linker-chunkconcept-calibrated\">\n<h2>13) Linker (chunk\u2192concept), calibrated<a class=\"headerlink\" href=\"#linker-chunkconcept-calibrated\" title=\"Link to this heading\">#</a></h2>\n<p><strong>Candidate generation</strong></p>\n<ul class=\"simple\">\n<li><p>SPLADE concept index <strong>&#64;100</strong> using chunk text;</p></li>\n<li><p>Lexical dictionary match <strong>&#64;50</strong> (max phrase len=6 tokens, case\u2011folded).</p></li>\n</ul>\n<p><strong>Feature scoring</strong></p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">dense_sim</span></code> = cosine(qwen_chunk, qwen_concept)</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">sparse_sim</span></code> = normalized SPLADE (min\u2013max per query)</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">lexical_overlap</span></code> = matched_chars / chunk_chars (clamp [0, 0.2])</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">depth_bonus</span></code> = +0.02 \u00d7 levels from root (cap +0.10)</p></li>\n</ul>\n<p><strong>Fusion &amp; decision</strong></p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">score</span> <span class=\"pre\">=</span> <span class=\"pre\">0.55*dense</span> <span class=\"pre\">+</span> <span class=\"pre\">0.35*sparse</span> <span class=\"pre\">+</span> <span class=\"pre\">0.10*lexical</span> <span class=\"pre\">+</span> <span class=\"pre\">depth_bonus</span></code></p></li>\n<li><p>Thresholds: <strong>link \u2265 0.62</strong>, <strong>reject \u2264 0.35</strong>, else uncertain.</p></li>\n<li><p><strong>Calibration</strong>: isotonic regression stored per linker run; output <code class=\"docutils literal notranslate\"><span class=\"pre\">LinkAssertion</span></code> Parquet.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"knowledge-graph-neo4j-local\">\n<h2>14) Knowledge Graph (Neo4j, local)<a class=\"headerlink\" href=\"#knowledge-graph-neo4j-local\" title=\"Link to this heading\">#</a></h2>\n<p><strong>Nodes</strong></p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">(:Doc</span> <span class=\"pre\">{doc_id,</span> <span class=\"pre\">title,</span> <span class=\"pre\">year,</span> <span class=\"pre\">license,</span> <span class=\"pre\">source,</span> <span class=\"pre\">source_id})</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">(:Chunk</span> <span class=\"pre\">{chunk_id,</span> <span class=\"pre\">section,</span> <span class=\"pre\">start_char,</span> <span class=\"pre\">end_char})</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">(:Concept</span> <span class=\"pre\">{concept_id,</span> <span class=\"pre\">ontology,</span> <span class=\"pre\">pref_label})</span></code></p></li>\n</ul>\n<p><strong>Relationships</strong></p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">(:Doc)-[:HAS_CHUNK]-&gt;(:Chunk)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">(:Chunk)-[:MENTIONS</span> <span class=\"pre\">{score,</span> <span class=\"pre\">run_id,</span> <span class=\"pre\">evidence_span,</span> <span class=\"pre\">created_at}]-&gt;(:Concept)</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">(:Concept)-[:IS_A]-&gt;(:Concept)</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">[:RELATED_TO]</span></code> (from ontology).</p></li>\n</ul>\n<p><strong>Constraints &amp; indexes</strong></p>\n<ul class=\"simple\">\n<li><p>Uniqueness on <code class=\"docutils literal notranslate\"><span class=\"pre\">doc_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">chunk_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">concept_id</span></code>; B\u2011tree index on <code class=\"docutils literal notranslate\"><span class=\"pre\">MENTIONS.score</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">MENTIONS.run_id</span></code>.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"hybrid-search-api-fastapi-local\">\n<h2>15) Hybrid search API (FastAPI, local)<a class=\"headerlink\" href=\"#hybrid-search-api-fastapi-local\" title=\"Link to this heading\">#</a></h2>\n<p><strong>Endpoints</strong></p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">POST</span> <span class=\"pre\">/search</span></code>\nBody: <code class=\"docutils literal notranslate\"><span class=\"pre\">{query:</span> <span class=\"pre\">str,</span> <span class=\"pre\">k?:</span> <span class=\"pre\">int=10,</span> <span class=\"pre\">filters?:</span> <span class=\"pre\">{...},</span> <span class=\"pre\">explain?:</span> <span class=\"pre\">bool=false}</span></code>\nReturns top chunks &amp; doc rollups with dense/sparse scores, KG boosts, spans, linked concepts.</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">POST</span> <span class=\"pre\">/graph/concepts</span></code> (browse ontology)</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">GET</span> <span class=\"pre\">/healthz</span></code></p></li>\n</ul>\n<p><strong>Algorithm (fixed)</strong></p>\n<ol class=\"arabic simple\">\n<li><p>Query embedding via Qwen3 (2560\u2011d) + parse lexical concept mentions.</p></li>\n<li><p>Retrieve <strong>dense&#64;200</strong> (FAISS) + <strong>sparse&#64;200</strong> (BM25 and SPLADE).</p></li>\n<li><p>Fuse via <strong>RRF(k=60)</strong>.</p></li>\n<li><p>KG boosts: +0.08 for direct concept match; +0.04 for one\u2011hop neighbor.</p></li>\n<li><p><strong>MMR</strong> (\u03bb=0.7) at doc level.</p></li>\n<li><p>Return top\u2011k.</p></li>\n</ol>\n</section>\n<hr class=\"docutils\" />\n<section id=\"configuration-yaml-singlebox-defaults\">\n<h2>16) Configuration (YAML; single\u2011box defaults)<a class=\"headerlink\" href=\"#configuration-yaml-singlebox-defaults\" title=\"Link to this heading\">#</a></h2>\n<div class=\"highlight-yaml notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"nt\">system</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">os</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">ubuntu-24.04</span>\n<span class=\"w\">  </span><span class=\"nt\">threads</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">14</span>\n<span class=\"w\">  </span><span class=\"nt\">seed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">42</span>\n<span class=\"w\">  </span><span class=\"nt\">parquet_root</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/parquet</span>\n<span class=\"w\">  </span><span class=\"nt\">artifacts_root</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/artifacts</span>\n<span class=\"w\">  </span><span class=\"nt\">duckdb_path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/catalog/catalog.duckdb</span>\n\n<span class=\"nt\">runtime</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">python</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;3.13&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">cuda</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;13.0&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">torch</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;2.9&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">duckdb_min</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;1.4.1&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">vllm_channel</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;pre-release-cuda13&quot;</span>\n\n<span class=\"nt\">network</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">nginx_port</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">80</span>\n<span class=\"w\">  </span><span class=\"nt\">vlm_port</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8001</span>\n<span class=\"w\">  </span><span class=\"nt\">emb_port</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8002</span>\n<span class=\"w\">  </span><span class=\"nt\">api_port</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8080</span>\n\n<span class=\"nt\">harvest</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">provider</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">pyalex</span>\n<span class=\"w\">  </span><span class=\"nt\">per_page</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">200</span>\n<span class=\"w\">  </span><span class=\"nt\">max_works</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">20000</span>\n<span class=\"w\">  </span><span class=\"nt\">years</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;&gt;=2018&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">filters</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">is_oa</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">    </span><span class=\"nt\">has_oa_published_version</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">fallbacks</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">unpaywall</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">    </span><span class=\"nt\">arxiv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">    </span><span class=\"nt\">pmc</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">concurrency</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8</span>\n<span class=\"w\">  </span><span class=\"nt\">timeout_sec</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">60</span>\n<span class=\"w\">  </span><span class=\"nt\">retries</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">3</span>\n\n<span class=\"nt\">doc_conversion</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">vlm_model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">ibm-granite/granite-docling-258M</span>\n<span class=\"w\">  </span><span class=\"nt\">vlm_revision</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">untied</span>\n<span class=\"w\">  </span><span class=\"nt\">endpoint</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">http://localhost/vlm/</span>\n<span class=\"w\">  </span><span class=\"nt\">dpi</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">220</span>\n<span class=\"w\">  </span><span class=\"nt\">page_batch</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8</span>\n<span class=\"w\">  </span><span class=\"nt\">ocr_fallback</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">max_pages</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">2000</span>\n<span class=\"w\">  </span><span class=\"nt\">timeout_sec</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">120</span>\n\n<span class=\"nt\">chunking</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">engine</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">docling_hybrid</span>\n<span class=\"w\">  </span><span class=\"nt\">target_tokens</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">400</span>\n<span class=\"w\">  </span><span class=\"nt\">overlap_tokens</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">80</span>\n<span class=\"w\">  </span><span class=\"nt\">min_tokens</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">120</span>\n<span class=\"w\">  </span><span class=\"nt\">max_tokens</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">480</span>\n\n<span class=\"nt\">dense_embedding</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Qwen/Qwen3-Embedding-4B</span>\n<span class=\"w\">  </span><span class=\"nt\">endpoint</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">http://localhost/v1/embeddings</span>\n<span class=\"w\">  </span><span class=\"nt\">output_dim</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">2560</span>\n<span class=\"w\">  </span><span class=\"nt\">parquet_out</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${system.parquet_root}/dense/model=Qwen3-Embedding-4B/run=${run_id}</span>\n\n<span class=\"nt\">sparse_embedding</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">splade</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">naver/splade-v3-distilbert</span>\n<span class=\"w\">    </span><span class=\"nt\">device</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">cuda</span>\n<span class=\"w\">    </span><span class=\"nt\">amp</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">fp16</span>\n<span class=\"w\">    </span><span class=\"nt\">max_seq_len</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">512</span>\n<span class=\"w\">    </span><span class=\"nt\">topk</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">256</span>\n<span class=\"w\">    </span><span class=\"nt\">parquet_out</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${system.parquet_root}/sparse/model=SPLADE-v3-distilbert/run=${run_id}</span>\n<span class=\"w\">  </span><span class=\"nt\">bm25</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">k1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">0.9</span>\n<span class=\"w\">    </span><span class=\"nt\">b</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">0.4</span>\n<span class=\"w\">    </span><span class=\"nt\">field_boosts</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> title</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">2.0</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> section</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">1.2</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> body</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">1.0</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">    </span><span class=\"nt\">index_dir</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/lucene/bm25</span>\n\n<span class=\"nt\">faiss</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">index_factory</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">OPQ64,IVF8192,PQ64</span>\n<span class=\"w\">  </span><span class=\"nt\">nprobe</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">64</span>\n<span class=\"w\">  </span><span class=\"nt\">train_samples</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">10000000</span>\n<span class=\"w\">  </span><span class=\"nt\">shards</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">max_vectors_per_shard</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">10000000</span>\n<span class=\"w\">  </span><span class=\"nt\">gpu</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">cuvs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">output_dir</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/faiss/qwen3_ivfpq</span>\n\n<span class=\"nt\">ontology</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">inputs</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> ontology_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">mesh</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> format</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">obo</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> uri</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">/data/ontologies/mesh.obo</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">    </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> ontology_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">go</span><span class=\"p p-Indicator\">,</span><span class=\"nt\">   format</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">obo</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> uri</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">/data/ontologies/go.obo</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">  </span><span class=\"nt\">concept_embed</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">dense_model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Qwen3-Embedding-4B</span>\n<span class=\"w\">    </span><span class=\"nt\">dense_dim</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">2560</span>\n<span class=\"w\">    </span><span class=\"nt\">splade_model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">SPLADE-v3-distilbert</span>\n<span class=\"w\">    </span><span class=\"nt\">splade_topk</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">128</span>\n\n<span class=\"nt\">linker</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">candidates</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> splade_topk</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">100</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> lexicon_topk</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">50</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">  </span><span class=\"nt\">fusion_weights</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> dense</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.55</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> sparse</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.35</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> lexical</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.10</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> depth_bonus_per_level</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.02</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> depth_cap</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.10</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">  </span><span class=\"nt\">thresholds</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> high</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.62</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> low</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.35</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">  </span><span class=\"nt\">calibration</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">isotonic</span>\n\n<span class=\"nt\">graph</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">backend</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">neo4j</span>\n<span class=\"w\">  </span><span class=\"nt\">uri</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">bolt://localhost:7687</span>\n<span class=\"w\">  </span><span class=\"nt\">user</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">neo4j</span>\n<span class=\"w\">  </span><span class=\"nt\">password_env</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">NEO4J_PASSWORD</span>\n\n<span class=\"nt\">search</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">10</span>\n<span class=\"w\">  </span><span class=\"nt\">dense_candidates</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">200</span>\n<span class=\"w\">  </span><span class=\"nt\">sparse_candidates</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">200</span>\n<span class=\"w\">  </span><span class=\"nt\">rrf_k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">60</span>\n<span class=\"w\">  </span><span class=\"nt\">mmr_lambda</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">0.7</span>\n<span class=\"w\">  </span><span class=\"nt\">kg_boosts</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> direct</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.08</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> one_hop</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.04</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n</pre></div>\n</div>\n</section>\n<hr class=\"docutils\" />\n<section id=\"duckdb-1-4-1-schema-views-full-fidelity\">\n<h2>17) DuckDB (\u2265\u202f1.4.1) schema &amp; views (full fidelity)<a class=\"headerlink\" href=\"#duckdb-1-4-1-schema-views-full-fidelity\" title=\"Link to this heading\">#</a></h2>\n<p><strong>Tables (key ones)</strong></p>\n<div class=\"highlight-sql notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">model_registry</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">model_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">repo</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">tokenizer</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">embedding_dim</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span><span class=\"w\">      </span><span class=\"c1\">-- 2560 for Qwen3 embeddings</span>\n<span class=\"w\">  </span><span class=\"n\">vocab_size</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span><span class=\"w\">         </span><span class=\"c1\">-- 30522 for SPLADE v3 tokenizer</span>\n<span class=\"w\">  </span><span class=\"n\">framework</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\">         </span><span class=\"c1\">-- &#39;vllm&#39;|&#39;hf&#39;</span>\n<span class=\"w\">  </span><span class=\"n\">framework_version</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">build_info</span><span class=\"w\"> </span><span class=\"n\">JSON</span><span class=\"p\">,</span><span class=\"w\">        </span><span class=\"c1\">-- FAISS flags, CUDA, cuVS info</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">model_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"p\">)</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">runs</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">run_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">purpose</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\">           </span><span class=\"c1\">-- &#39;dense_embed&#39;|&#39;splade_encode&#39;|&#39;bm25_build&#39;|&#39;faiss_build&#39;|...</span>\n<span class=\"w\">  </span><span class=\"n\">model_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">started_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">finished_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"n\">JSON</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">documents</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">doc_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">openalex_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">doi</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arxiv_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pmcid</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">authors</span><span class=\"w\"> </span><span class=\"n\">JSON</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pub_date</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">license</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">language</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">pdf_uri</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">source</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">content_hash</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\">         </span><span class=\"c1\">-- canonical text hash (after DocTags\u2192text)</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">doctags</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">doc_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">documents</span><span class=\"p\">(</span><span class=\"n\">doc_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">doctags_uri</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pages</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">vlm_model</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vlm_revision</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">avg_logprob</span><span class=\"w\"> </span><span class=\"n\">DOUBLE</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">datasets</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">dataset_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\">                 </span><span class=\"c1\">-- &#39;chunks&#39;|&#39;dense&#39;|&#39;sparse&#39;|&#39;concepts&#39;</span>\n<span class=\"w\">  </span><span class=\"n\">parquet_root</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">run_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">runs</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">chunk_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">doc_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">documents</span><span class=\"p\">(</span><span class=\"n\">doc_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">section</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">start_char</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">end_char</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">doctags_span</span><span class=\"w\"> </span><span class=\"n\">JSON</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tokens</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">dataset_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">datasets</span><span class=\"p\">(</span><span class=\"n\">dataset_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">dense_runs</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">run_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">runs</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dim</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span><span class=\"w\">       </span><span class=\"c1\">-- 2560</span>\n<span class=\"w\">  </span><span class=\"n\">parquet_root</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">sparse_runs</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">run_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">runs</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vocab_size</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">parquet_root</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">backend</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\">               </span><span class=\"c1\">-- &#39;lucene-impact&#39;|&#39;lucene-bm25&#39;</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">faiss_indexes</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">logical_index_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\">     </span><span class=\"c1\">-- groups shards into a single logical index</span>\n<span class=\"w\">  </span><span class=\"n\">run_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">dense_runs</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">shard_id</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">index_type</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nlist</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">opq</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nprobe</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">gpu</span><span class=\"w\"> </span><span class=\"nb\">BOOLEAN</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cuvs</span><span class=\"w\"> </span><span class=\"nb\">BOOLEAN</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">index_uri</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idmap_uri</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">logical_index_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shard_id</span><span class=\"p\">)</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">ontologies</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">ontology_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src_uri</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">loaded_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">concept_count</span><span class=\"w\"> </span><span class=\"nb\">INT</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">concept_embeddings</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">ontology_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">ontologies</span><span class=\"p\">(</span><span class=\"n\">ontology_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dim</span><span class=\"w\"> </span><span class=\"nb\">INT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">parquet_root</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ontology_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">)</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">link_assertions</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">chunk_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"p\">(</span><span class=\"n\">chunk_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">concept_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">score</span><span class=\"w\"> </span><span class=\"n\">DOUBLE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">decision</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">evidence_span</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"n\">JSON</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">run_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">REFERENCES</span><span class=\"w\"> </span><span class=\"n\">runs</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">TABLE</span><span class=\"w\"> </span><span class=\"n\">pipeline_events</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"n\">event_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"w\"> </span><span class=\"k\">PRIMARY</span><span class=\"w\"> </span><span class=\"k\">KEY</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">event_name</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">subject_id</span><span class=\"w\"> </span><span class=\"nb\">TEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">payload</span><span class=\"w\"> </span><span class=\"n\">JSON</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"n\">created_at</span><span class=\"w\"> </span><span class=\"k\">TIMESTAMP</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">-- Helpful indexes</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">INDEX</span><span class=\"w\"> </span><span class=\"n\">idx_chunks_doc</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"p\">(</span><span class=\"n\">doc_id</span><span class=\"p\">);</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">INDEX</span><span class=\"w\"> </span><span class=\"n\">idx_link_chunk</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">link_assertions</span><span class=\"p\">(</span><span class=\"n\">chunk_id</span><span class=\"p\">);</span>\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">INDEX</span><span class=\"w\"> </span><span class=\"n\">idx_link_concept</span><span class=\"w\"> </span><span class=\"k\">ON</span><span class=\"w\"> </span><span class=\"n\">link_assertions</span><span class=\"p\">(</span><span class=\"n\">concept_id</span><span class=\"p\">);</span>\n</pre></div>\n</div>\n<p><strong>Views</strong> (Parquet unification)</p>\n<div class=\"highlight-sql notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">PRAGMA</span><span class=\"w\"> </span><span class=\"n\">threads</span><span class=\"o\">=</span><span class=\"mi\">14</span><span class=\"p\">;</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">OR</span><span class=\"w\"> </span><span class=\"k\">REPLACE</span><span class=\"w\"> </span><span class=\"k\">VIEW</span><span class=\"w\"> </span><span class=\"n\">dense_vectors_view</span><span class=\"w\"> </span><span class=\"k\">AS</span>\n<span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">read_parquet</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">parquet_root</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">dense_runs</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">union_by_name</span><span class=\"o\">=</span><span class=\"k\">true</span><span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">OR</span><span class=\"w\"> </span><span class=\"k\">REPLACE</span><span class=\"w\"> </span><span class=\"k\">VIEW</span><span class=\"w\"> </span><span class=\"n\">splade_vectors_view</span><span class=\"w\"> </span><span class=\"k\">AS</span>\n<span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">read_parquet</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">parquet_root</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">sparse_runs</span><span class=\"w\"> </span><span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"n\">backend</span><span class=\"o\">=</span><span class=\"s1\">&#39;lucene-impact&#39;</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">union_by_name</span><span class=\"o\">=</span><span class=\"k\">true</span><span class=\"p\">);</span>\n\n<span class=\"k\">CREATE</span><span class=\"w\"> </span><span class=\"k\">OR</span><span class=\"w\"> </span><span class=\"k\">REPLACE</span><span class=\"w\"> </span><span class=\"k\">VIEW</span><span class=\"w\"> </span><span class=\"n\">chunk_texts</span><span class=\"w\"> </span><span class=\"k\">AS</span>\n<span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">read_parquet</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">SELECT</span><span class=\"w\"> </span><span class=\"n\">parquet_root</span><span class=\"w\"> </span><span class=\"k\">FROM</span><span class=\"w\"> </span><span class=\"n\">datasets</span><span class=\"w\"> </span><span class=\"k\">WHERE</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"o\">=</span><span class=\"s1\">&#39;chunks&#39;</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">union_by_name</span><span class=\"o\">=</span><span class=\"k\">true</span><span class=\"p\">);</span>\n</pre></div>\n</div>\n</section>\n<hr class=\"docutils\" />\n<section id=\"vllm-nginx-single-logical-endpoint\">\n<h2>18) vLLM &amp; Nginx (single logical endpoint)<a class=\"headerlink\" href=\"#vllm-nginx-single-logical-endpoint\" title=\"Link to this heading\">#</a></h2>\n<p><strong>Nginx</strong> (local):</p>\n<div class=\"highlight-nginx notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">server</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kn\">listen</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kn\">server_name</span><span class=\"w\"> </span><span class=\"s\">localhost</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"kn\">location</span><span class=\"w\"> </span><span class=\"s\">/vlm/</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">              </span><span class=\"c1\"># Docling VLM</span>\n<span class=\"w\">    </span><span class=\"kn\">proxy_pass</span><span class=\"w\"> </span><span class=\"s\">http://127.0.0.1:8001/</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"kn\">location</span><span class=\"w\"> </span><span class=\"s\">/v1/embeddings</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">     </span><span class=\"c1\"># Qwen3 embeddings (OpenAI-compatible)</span>\n<span class=\"w\">    </span><span class=\"kn\">proxy_pass</span><span class=\"w\"> </span><span class=\"s\">http://127.0.0.1:8002/v1/embeddings</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"kn\">location</span><span class=\"w\"> </span><span class=\"s\">/healthz</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kn\">return</span><span class=\"w\"> </span><span class=\"mi\">200</span><span class=\"w\"> </span><span class=\"s\">&#39;ok\\n&#39;</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n<p><strong>vLLM processes (systemd units suggested)</strong></p>\n<ul class=\"simple\">\n<li><p><strong>Granite\u2011Docling</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">vllm</span> <span class=\"pre\">serve</span> <span class=\"pre\">ibm-granite/granite-docling-258M</span> <span class=\"pre\">--revision</span> <span class=\"pre\">untied</span> <span class=\"pre\">--host</span> <span class=\"pre\">127.0.0.1</span> <span class=\"pre\">--port</span> <span class=\"pre\">8001</span> <span class=\"pre\">--dtype</span> <span class=\"pre\">bfloat16</span></code></p></li>\n<li><p><strong>Qwen3\u2011Embedding</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">vllm</span> <span class=\"pre\">serve</span> <span class=\"pre\">Qwen/Qwen3-Embedding-4B</span> <span class=\"pre\">--host</span> <span class=\"pre\">127.0.0.1</span> <span class=\"pre\">--port</span> <span class=\"pre\">8002</span> <span class=\"pre\">--dtype</span> <span class=\"pre\">float16</span> <span class=\"pre\">--max-num-seqs</span> <span class=\"pre\">1024</span> <span class=\"pre\">--trust-remote-code</span></code></p></li>\n</ul>\n<p><em>(One model per vLLM process; router gives you a single host/endpoint.)</em></p>\n</section>\n<hr class=\"docutils\" />\n<section id=\"implementation-skeletons-selected\">\n<h2>19) Implementation skeletons (selected)<a class=\"headerlink\" href=\"#implementation-skeletons-selected\" title=\"Link to this heading\">#</a></h2>\n<section id=\"downloader-pyalex-fallbacks\">\n<h3>19.1 Downloader (PyAlex + fallbacks)<a class=\"headerlink\" href=\"#downloader-pyalex-fallbacks\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># download/harvester.py</span>\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">OpenAccessHarvester</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">cfg</span><span class=\"p\">,</span> <span class=\"n\">http</span><span class=\"p\">,</span> <span class=\"n\">unpaywall_client</span><span class=\"p\">):</span>\n        <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">search_openalex</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">topic</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">years</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">max_works</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">dict</span><span class=\"p\">]:</span>\n        <span class=\"c1\"># paginate PyAlex queries; collect candidate OA PDF URLs + metadata</span>\n        <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">resolve_pdf</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">work</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span> <span class=\"o\">|</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"c1\"># try best_oa_location.pdf_url \u2192 locations[].pdf_url \u2192 unpaywall \u2192 arxiv/pmc</span>\n        <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">download_pdf</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">url</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">dest_path</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">bool</span><span class=\"p\">:</span>\n        <span class=\"c1\"># 60s timeout, 3 retries, 8 concurrent workers</span>\n        <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">topic</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">years</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">max_works</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Doc</span><span class=\"p\">]:</span>\n        <span class=\"c1\"># returns registered documents (DuckDB insert)</span>\n        <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"doctags-conversion\">\n<h3>19.2 DocTags conversion<a class=\"headerlink\" href=\"#doctags-conversion\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># docling/vlm.py</span>\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">GraniteDoclingVLM</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">endpoint</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">dpi</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">page_batch</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">timeout</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">ocr_fallback</span><span class=\"p\">:</span> <span class=\"nb\">bool</span><span class=\"p\">):</span>\n        <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">to_doctags</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pdf_path</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">dict</span><span class=\"p\">:</span>\n        <span class=\"c1\"># call vLLM endpoint; assemble DocTags JSON; OCR fallback per page if needed</span>\n        <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">persist</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">doc_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">doctags</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span>\n        <span class=\"c1\"># write to /data/doctags/&lt;doc_id&gt;.dt.json.zst, return URI</span>\n</pre></div>\n</div>\n</section>\n<section id=\"chunking\">\n<h3>19.3 Chunking<a class=\"headerlink\" href=\"#chunking\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># docling/hybrid.py</span>\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">HybridChunker</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">target</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"o\">=</span><span class=\"mi\">400</span><span class=\"p\">,</span> <span class=\"n\">overlap</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"o\">=</span><span class=\"mi\">80</span><span class=\"p\">,</span> <span class=\"n\">min_tokens</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"o\">=</span><span class=\"mi\">120</span><span class=\"p\">,</span> <span class=\"n\">max_tokens</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"o\">=</span><span class=\"mi\">480</span><span class=\"p\">):</span>\n        <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">chunk</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">doctags_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Chunk</span><span class=\"p\">]:</span>\n        <span class=\"c1\"># parse, section-aware splitting, sliding windows, record spans/offsets</span>\n        <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"dense-embeddings-qwen3-2560d-via-vllm\">\n<h3>19.4 Dense embeddings (Qwen3 2560\u2011d via vLLM)<a class=\"headerlink\" href=\"#dense-embeddings-qwen3-2560d-via-vllm\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># embeddings_dense/qwen3.py</span>\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Qwen3Embedder</span><span class=\"p\">:</span>\n    <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;Qwen3-Embedding-4B&quot;</span>\n    <span class=\"n\">dim</span> <span class=\"o\">=</span> <span class=\"mi\">2560</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">endpoint</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">):</span>\n        <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">embed_texts</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">texts</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">:</span>\n        <span class=\"c1\"># call /v1/embeddings; enforce dim=2560; L2-normalize</span>\n        <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"spladev3-encoder-gpu\">\n<h3>19.5 SPLADE\u2011v3 encoder (GPU)<a class=\"headerlink\" href=\"#spladev3-encoder-gpu\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># embeddings_sparse/splade.py</span>\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">SPLADEv3Encoder</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">device</span><span class=\"o\">=</span><span class=\"s2\">&quot;cuda&quot;</span><span class=\"p\">,</span> <span class=\"n\">topk</span><span class=\"o\">=</span><span class=\"mi\">256</span><span class=\"p\">,</span> <span class=\"n\">max_seq_len</span><span class=\"o\">=</span><span class=\"mi\">512</span><span class=\"p\">):</span>\n        <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">encode</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">texts</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">],</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">float</span><span class=\"p\">]]]:</span>\n        <span class=\"c1\"># torch.no_grad + autocast; prune to topK</span>\n        <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"faiss-index-gpu-cuvs\">\n<h3>19.6 FAISS index (GPU + cuVS)<a class=\"headerlink\" href=\"#faiss-index-gpu-cuvs\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># vectorstore_faiss/gpu.py</span>\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">FaissGpuIndex</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">factory</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">nprobe</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">gpu</span><span class=\"p\">:</span> <span class=\"nb\">bool</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">cuvs</span><span class=\"p\">:</span> <span class=\"nb\">bool</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">train</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">train_vectors</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">add</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">keys</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">],</span> <span class=\"n\">vectors</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">search</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]]:</span>\n        <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">index_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">idmap_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"hybrid-retrieval-rerank-search-api\">\n<h3>19.7 Hybrid retrieval &amp; rerank (search_api)<a class=\"headerlink\" href=\"#hybrid-retrieval-rerank-search-api\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># search_api/service.py</span>\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">hybrid_search</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">dict</span><span class=\"p\">]:</span>\n    <span class=\"n\">q_vec</span> <span class=\"o\">=</span> <span class=\"n\">dense_embedder</span><span class=\"o\">.</span><span class=\"n\">embed_texts</span><span class=\"p\">([</span><span class=\"n\">query</span><span class=\"p\">])[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"n\">dense_hits</span> <span class=\"o\">=</span> <span class=\"n\">faiss</span><span class=\"o\">.</span><span class=\"n\">search</span><span class=\"p\">(</span><span class=\"n\">q_vec</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"o\">=</span><span class=\"mi\">200</span><span class=\"p\">)</span>\n    <span class=\"n\">sparse_hits</span> <span class=\"o\">=</span> <span class=\"n\">bm25</span><span class=\"o\">.</span><span class=\"n\">search</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"o\">=</span><span class=\"mi\">200</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"n\">splade</span><span class=\"o\">.</span><span class=\"n\">search</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"o\">=</span><span class=\"mi\">200</span><span class=\"p\">)</span>\n    <span class=\"n\">fused</span> <span class=\"o\">=</span> <span class=\"n\">rrf_fuse</span><span class=\"p\">(</span><span class=\"n\">dense_hits</span><span class=\"p\">,</span> <span class=\"n\">sparse_hits</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"o\">=</span><span class=\"mi\">60</span><span class=\"p\">)</span>\n    <span class=\"n\">boosted</span> <span class=\"o\">=</span> <span class=\"n\">apply_kg_boosts</span><span class=\"p\">(</span><span class=\"n\">fused</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">)</span>\n    <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"n\">mmr_deduplicate</span><span class=\"p\">(</span><span class=\"n\">boosted</span><span class=\"p\">,</span> <span class=\"n\">lambda_</span><span class=\"o\">=</span><span class=\"mf\">0.7</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">explain</span><span class=\"p\">(</span><span class=\"n\">results</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n</section>\n</section>\n<hr class=\"docutils\" />\n<section id=\"quality-gates-evaluation-ci\">\n<h2>20) Quality gates, evaluation &amp; CI<a class=\"headerlink\" href=\"#quality-gates-evaluation-ci\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>Retrieval</strong>: nDCG&#64;10 \u2265 0.50 (baseline), Recall&#64;1K \u2265 0.85.</p></li>\n<li><p><strong>Linker</strong>: F1 \u2265 0.70 on a labeled set; <strong>ECE \u2264 0.08</strong> after isotonic calibration.</p></li>\n<li><p><strong>Latency</strong>: p95 search <strong>&lt; 300\u202fms</strong> (top\u201110); p50 chunk\u2192embed throughput tracked.</p></li>\n<li><p><strong>CI</strong>: Unit tests (mypy, ruff), golden tests, nightly 1k\u2011doc mini\u2011pipeline; fail on regressions.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"security-licensing-governance-local\">\n<h2>21) Security, licensing, governance (local)<a class=\"headerlink\" href=\"#security-licensing-governance-local\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>License guard</strong> at harvest; store license string in <code class=\"docutils literal notranslate\"><span class=\"pre\">documents.license</span></code>.</p></li>\n<li><p>vLLM binds to <strong>localhost</strong> only; Nginx is the only front door; <strong>API\u2011key</strong> auth on search API.</p></li>\n<li><p><strong>Secrets</strong> (if any) from environment; never persisted.</p></li>\n<li><p><strong>Provenance</strong>: every artifact row includes <code class=\"docutils literal notranslate\"><span class=\"pre\">{run_id,</span> <span class=\"pre\">model_id,</span> <span class=\"pre\">revision,</span> <span class=\"pre\">created_at}</span></code>.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"capacity-sizing-with-2560dim\">\n<h2>22) Capacity &amp; sizing with <strong>2560\u2011dim</strong><a class=\"headerlink\" href=\"#capacity-sizing-with-2560dim\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>Dense Parquet</strong>: \u2248 <strong>10\u202fKB/chunk</strong> pre\u2011compression (2560 \u00d7 4\u202fB).</p></li>\n<li><p><strong>IVF\u2011PQ</strong> (PQ64) codes: \u2248 <strong>64\u202fB/vector</strong> (+ID/overhead ~80\u2013100\u202fB).</p></li>\n<li><p><strong>SPLADE postings</strong>: ~<strong>2\u202fKB/chunk</strong> before Lucene compression (256 nnz).</p></li>\n<li><p>Scale by chunk count (e.g., 5M chunks \u2192 ~50\u202fGB dense Parquet uncompressed; index is small enough for GPU).</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"operational-runbooks\">\n<h2>23) Operational runbooks<a class=\"headerlink\" href=\"#operational-runbooks\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>CUDA 13 + Torch 2.9</strong>: install CUDA 13, confirm <code class=\"docutils literal notranslate\"><span class=\"pre\">nvcc</span> <span class=\"pre\">--version</span></code>, install cu130 wheels.</p></li>\n<li><p><strong>vLLM pre\u2011release</strong>: install channel with CUDA\u201113 support; start two processes; verify health on <code class=\"docutils literal notranslate\"><span class=\"pre\">:8001</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">:8002</span></code>; Nginx routes.</p></li>\n<li><p><strong>FAISS GPU + cuVS</strong>: install GPU binary (preferred); if needed, build from source with CMake flags enabling cuVS.</p></li>\n<li><p><strong>Directories</strong>:</p>\n<ul>\n<li><p>PDFs: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/pdfs</span></code></p></li>\n<li><p>DocTags: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/doctags</span></code></p></li>\n<li><p>Parquet: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/parquet</span></code></p></li>\n<li><p>Lucene: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/lucene/{bm25,splade}</span></code></p></li>\n<li><p>FAISS: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/faiss</span></code></p></li>\n<li><p>DuckDB: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/catalog/catalog.duckdb</span></code></p></li>\n</ul>\n</li>\n<li><p><strong>Resource limits</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">ulimit</span> <span class=\"pre\">-n</span> <span class=\"pre\">65535</span></code>; I/O scheduler <code class=\"docutils literal notranslate\"><span class=\"pre\">mq-deadline</span></code>; set <code class=\"docutils literal notranslate\"><span class=\"pre\">PRAGMA</span> <span class=\"pre\">threads=14</span></code> in DuckDB.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"workstreams-implementation-plans-deliverables\">\n<h2>24) Workstreams (implementation plans &amp; deliverables)<a class=\"headerlink\" href=\"#workstreams-implementation-plans-deliverables\" title=\"Link to this heading\">#</a></h2>\n<ol class=\"arabic simple\">\n<li><p><strong>Downloader &amp; Harvester (PyAlex + fallbacks)</strong></p>\n<ul class=\"simple\">\n<li><p>PyAlex client; OA filters; DOI/ID extract; Unpaywall integration; robust downloader; license guard; DuckDB registration.</p></li>\n<li><p>Deliverables: module, config, tests (mock HTTP), metrics (<code class=\"docutils literal notranslate\"><span class=\"pre\">pdf_download_success_total</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">oa_resolution_latency</span></code>).</p></li>\n</ul>\n</li>\n<li><p><strong>Docling VLM &amp; DocTags</strong></p>\n<ul class=\"simple\">\n<li><p>vLLM integration; page batching; OCR fallback; DocTags writer; quality metrics (avg logprob/page).</p></li>\n<li><p>Deliverables: module, Nginx+vLLM configs, DDL updates, golden DocTags samples.</p></li>\n</ul>\n</li>\n<li><p><strong>Chunking (Docling Hybrid)</strong></p>\n<ul class=\"simple\">\n<li><p>Hybrid configuration; token accounting; offsets/spans; Parquet writer; golden chunk fixtures.</p></li>\n</ul>\n</li>\n<li><p><strong>Dense embeddings (Qwen3 2560\u2011d)</strong></p>\n<ul class=\"simple\">\n<li><p>vLLM client; batching &amp; normalization; Parquet writer; memory instrumentation; retries.</p></li>\n</ul>\n</li>\n<li><p><strong>SPLADE\u2011v3 GPU encoder + Pyserini indices</strong></p>\n<ul class=\"simple\">\n<li><p>Torch 2.9 encoder; Parquet encoder; streaming into Lucene (impact); BM25 build; query APIs.</p></li>\n</ul>\n</li>\n<li><p><strong>FAISS GPU/cuVS</strong></p>\n<ul class=\"simple\">\n<li><p>Binary installation or source build; index builder (OPQ64,IVF8192,PQ64); training sampler; shard manager; search adapter.</p></li>\n</ul>\n</li>\n<li><p><strong>Ontology &amp; concept embeddings</strong></p>\n<ul class=\"simple\">\n<li><p>Loaders (OWL/OBO/SKOS); normalization; concept Parquet; Qwen3(2560) + SPLADE encoders.</p></li>\n</ul>\n</li>\n<li><p><strong>Linker</strong></p>\n<ul class=\"simple\">\n<li><p>Candidate gen; fusion; calibration (isotonic); assertions Parquet; explainability; ablations.</p></li>\n</ul>\n</li>\n<li><p><strong>KG Builder (Neo4j)</strong></p>\n<ul class=\"simple\">\n<li><p>Node/edge upserts; constraints; indexes; maintenance; graph query helpers.</p></li>\n</ul>\n</li>\n<li><p><strong>Search API</strong></p>\n<ul class=\"simple\">\n<li><p>FastAPI; hybrid retrieval; RRF; KG boosts; MMR; explanations; OpenAPI schema; auth.</p></li>\n</ul>\n</li>\n<li><p><strong>Registry (DuckDB)</strong></p>\n<ul class=\"simple\">\n<li><p>Migrations; registration helpers; views across Parquet; integrity checks; provenance guards.</p></li>\n</ul>\n</li>\n<li><p><strong>Orchestration &amp; Observability</strong></p>\n<ul class=\"simple\">\n<li><p>Prefect flows; retries; dashboards; tracing; alerting; local startup scripts.</p></li>\n</ul>\n</li>\n</ol>\n</section>\n<hr class=\"docutils\" />\n<section id=\"coding-standards-bestinclass-python-practices\">\n<h2>25) Coding standards &amp; best\u2011in\u2011class Python practices<a class=\"headerlink\" href=\"#coding-standards-bestinclass-python-practices\" title=\"Link to this heading\">#</a></h2>\n<ul class=\"simple\">\n<li><p><strong>Static typing</strong> everywhere (<code class=\"docutils literal notranslate\"><span class=\"pre\">mypy</span> <span class=\"pre\">--strict</span></code>).</p></li>\n<li><p><strong>Pydantic v2</strong> for all externalized contracts; validate at boundaries only.</p></li>\n<li><p><strong>Dataclasses/NamedTuples</strong> for internal\u2011only small records on hot paths.</p></li>\n<li><p><strong>Pure functions</strong> for transformations; side effects behind adapters.</p></li>\n<li><p><strong>Dependency inversion</strong>: constructors accept interfaces, not concretes.</p></li>\n<li><p><strong>Factories</strong> resolve plugins from entry\u2011points; no <code class=\"docutils literal notranslate\"><span class=\"pre\">if/elif</span></code> on provider names in business logic.</p></li>\n<li><p><strong>Error handling</strong>: wrap external calls in <code class=\"docutils literal notranslate\"><span class=\"pre\">Result[T,</span> <span class=\"pre\">E]</span></code>\u2011like helpers (or <code class=\"docutils literal notranslate\"><span class=\"pre\">try/except</span></code> mapping to domain errors).</p></li>\n<li><p><strong>Logging</strong>: structured (<code class=\"docutils literal notranslate\"><span class=\"pre\">json</span></code>); include <code class=\"docutils literal notranslate\"><span class=\"pre\">run_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">doc_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">chunk_id</span></code>.</p></li>\n<li><p><strong>Testing</strong>: unit + contract tests per port; \u201cfake\u201d in\u2011memory providers; golden tests for DocTags/chunks; end\u2011to\u2011end smoke.</p></li>\n<li><p><strong>Performance</strong>: vector ops on GPU; streaming I/O; Parquet row groups sized for cache locality; avoid pandas on hot paths.</p></li>\n<li><p><strong>Docs</strong>: every public class/method has docstrings; README per package; ADRs for significant choices.</p></li>\n</ul>\n</section>\n</section>\n<hr class=\"docutils\" />\n<section id=\"addendum-additional-architecture-information\">\n<h1>Addendum - additional architecture information<a class=\"headerlink\" href=\"#addendum-additional-architecture-information\" title=\"Link to this heading\">#</a></h1>\n<section id=\"part-a-gap-analysis-whats-unspecified-resolutions-in-addendum\">\n<h2>PART A \u2014 GAP ANALYSIS (WHAT\u2019S UNSPECIFIED) \u2192 RESOLUTIONS IN ADDENDUM<a class=\"headerlink\" href=\"#part-a-gap-analysis-whats-unspecified-resolutions-in-addendum\" title=\"Link to this heading\">#</a></h2>\n<div class=\"pst-scrollable-table-container\"><table class=\"table\">\n<thead>\n<tr class=\"row-odd\"><th class=\"head\"><p>Area</p></th>\n<th class=\"head\"><p>Gap / ambiguity</p></th>\n<th class=\"head\"><p>Why it matters</p></th>\n<th class=\"head\"><p>Final specification (summary)</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"row-even\"><td><p><strong>Canonical text &amp; ID hashing</strong></p></td>\n<td><p>Exact <em>canonicalization</em> pipeline from DocTags to text (line breaks, whitespace, Unicode norms) not fixed; ID hashing step unclear.</p></td>\n<td><p>Reproducibility; stable <code class=\"docutils literal notranslate\"><span class=\"pre\">doc_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">chunk_id</span></code>.</p></td>\n<td><p>Define canonicalizer (NFC \u2192 collapse whitespace \u2192 normalize bullets/ligatures \u2192 Unix line endings). Hash <strong>canonical text</strong> SHA\u2011256, use first 16 bytes (base32) for URNs. (\u00a7B1)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>Tokenizer for chunk sizes</strong></p></td>\n<td><p>Which tokenizer governs <code class=\"docutils literal notranslate\"><span class=\"pre\">target_tokens</span></code> not pinned.</p></td>\n<td><p>Chunk consistency, embedding costs.</p></td>\n<td><p>Use <strong>Qwen3\u2011Embedding tokenizer</strong> via HF <code class=\"docutils literal notranslate\"><span class=\"pre\">AutoTokenizer</span></code> for token counts. (\u00a7B2)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>DocTags fidelity</strong></p></td>\n<td><p>Which DocTags nodes to include/exclude (headers/footers/refs), and OCR fallback merge rules unclear.</p></td>\n<td><p>Content quality; linkability back to pages.</p></td>\n<td><p>Include body, headings, tables, captions, figure text; exclude references by default. OCR per\u2011page fallback with provenance flag; page order preserved. (\u00a7B3)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>Downloader resolution order &amp; de\u2011dupe</strong></p></td>\n<td><p>Ties between multiple OA locations; DOI/arXiv/PMCID overlaps; file dedup not specified.</p></td>\n<td><p>Avoid duplicate processing and wasted space.</p></td>\n<td><p>Stable priority list (OpenAlex best_oa \u2192 other locations \u2192 Unpaywall \u2192 source\u2011specific), MIME check; compute <code class=\"docutils literal notranslate\"><span class=\"pre\">pdf_sha256</span></code>; deduplicate by hash; symlink duplicate DoIs. (\u00a7B4)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>PyAlex topic query spec</strong></p></td>\n<td><p>Which OpenAlex fields are searched; year filters and pagination; retries/timeouts not fixed.</p></td>\n<td><p>Recall and reliability.</p></td>\n<td><p>Search <code class=\"docutils literal notranslate\"><span class=\"pre\">title,</span> <span class=\"pre\">abstract_inverted_index,</span> <span class=\"pre\">fulltext</span></code> with AND semantics; filter by <code class=\"docutils literal notranslate\"><span class=\"pre\">from_year..to_year</span></code>; <code class=\"docutils literal notranslate\"><span class=\"pre\">per_page=200</span></code>; backoff retries 3\u00d7; http timeout 30\u202fs; polite <code class=\"docutils literal notranslate\"><span class=\"pre\">User-Agent</span></code> and mailto. (\u00a7B4)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>Qwen3 embeddings 2560\u2011d</strong></p></td>\n<td><p>Request parameter to enforce 2560 output; failure behavior if unsupported.</p></td>\n<td><p>Index shape; FAISS train.</p></td>\n<td><p>Request <code class=\"docutils literal notranslate\"><span class=\"pre\">dimension=2560</span></code>; assert response dim; if unsupported (model mismatch), <strong>fail fast</strong> and record incident. (\u00a7B5)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>SPLADE\u2011v3 GPU encoder</strong></p></td>\n<td><p>Pre\u2011processing (lowercasing, punctuation), truncation, batching, AMP, and top\u2011K pruning details not pinned.</p></td>\n<td><p>Index size and quality; repeatability.</p></td>\n<td><p>Lowercase; strip control chars; keep punctuation; truncation at 512 WP tokens; AMP fp16; batch size auto\u2011tuned; top\u2011K=256 with stable tiebreaker (token id). (\u00a7B6)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>BM25 analyzer</strong></p></td>\n<td><p>Analyzer pipeline (tokenizer, stopwords, stemming, casefold) not fixed.</p></td>\n<td><p>Matching behavior and score comparability.</p></td>\n<td><p>Lucene StandardTokenizer; English minimal stemming; lowercase; English stoplist; synonyms off by default (can be added per domain). (\u00a7B6)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>Parquet schemas &amp; partitioning</strong></p></td>\n<td><p>Columns, dtypes, compression, row group size, directory partitioning not fully fixed.</p></td>\n<td><p>IO performance; schema drift.</p></td>\n<td><p>Fixed schemas listed; <strong>ZSTD=6</strong>, <code class=\"docutils literal notranslate\"><span class=\"pre\">row_group=4096</span></code>; partition by <code class=\"docutils literal notranslate\"><span class=\"pre\">model</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">run_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">shard</span></code>; filename <code class=\"docutils literal notranslate\"><span class=\"pre\">part-&lt;nnnnn&gt;.parquet</span></code>. (\u00a7B7)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>DuckDB catalog</strong></p></td>\n<td><p>Migrations, integrity checks, FK behaviors, thread settings unspecified.</p></td>\n<td><p>Registry reliability.</p></td>\n<td><p>Versioned migrations (<code class=\"docutils literal notranslate\"><span class=\"pre\">registry/migrations/*.sql</span></code>), FK constraints, indexes, <code class=\"docutils literal notranslate\"><span class=\"pre\">PRAGMA</span> <span class=\"pre\">threads=14</span></code>, two\u2011phase registration. (\u00a7B8)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>FAISS details (GPU+cuVS)</strong></p></td>\n<td><p>Factory choice confirmed, but training sample selection, OPQ params, memory budgeting, shard policy not fully pinned.</p></td>\n<td><p>Performance &amp; determinism.</p></td>\n<td><p><code class=\"docutils literal notranslate\"><span class=\"pre\">OPQ64,IVF8192,PQ64</span></code>, train on 10M random (seed 42); <code class=\"docutils literal notranslate\"><span class=\"pre\">nprobe=64</span></code>; \u226410M vectors/shard; GPU add/search; save <code class=\"docutils literal notranslate\"><span class=\"pre\">.faiss</span></code> + <code class=\"docutils literal notranslate\"><span class=\"pre\">.ids</span></code>. (\u00a7B9)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>vLLM topology</strong></p></td>\n<td><p>Routing is known, but request/response schemas, timeouts, retries, health checks not fully specified.</p></td>\n<td><p>Client stability.</p></td>\n<td><p>OpenAI\u2011compatible <code class=\"docutils literal notranslate\"><span class=\"pre\">/v1/embeddings</span></code>; per\u2011request timeout 30\u202fs; 3\u00d7 retries; health endpoints <code class=\"docutils literal notranslate\"><span class=\"pre\">/v1/models</span></code> &amp; <code class=\"docutils literal notranslate\"><span class=\"pre\">/health</span></code>; router (Nginx) config pinned; backpressure policy documented. (\u00a7B10)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>Ontology ingestion</strong></p></td>\n<td><p>Supported predicates for labels/synonyms/defs, CURIE mapping, deprecations, and merges not fully specified.</p></td>\n<td><p>Correct concept catalog and IDs.</p></td>\n<td><p>Accept SKOS (<code class=\"docutils literal notranslate\"><span class=\"pre\">prefLabel</span></code>,<code class=\"docutils literal notranslate\"><span class=\"pre\">altLabel</span></code>), OBO (<code class=\"docutils literal notranslate\"><span class=\"pre\">hasExactSynonym</span></code>,<code class=\"docutils literal notranslate\"><span class=\"pre\">def</span></code>), RDFS labels; support <code class=\"docutils literal notranslate\"><span class=\"pre\">deprecated</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">replaced_by</span></code>; CURIE mapping table; normalize text; unique <code class=\"docutils literal notranslate\"><span class=\"pre\">urn:concept:&lt;ont&gt;:&lt;curie&gt;</span></code>. (\u00a7B11)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>Linker calibration</strong></p></td>\n<td><p>Dev set size, fold policy, calibration storage, and runtime application not explicit.</p></td>\n<td><p>Score interpretability.</p></td>\n<td><p>Dev set 2,000 chunk\u2011concept pairs labeled; 5\u2011fold isotonic regression; parameters stored per <code class=\"docutils literal notranslate\"><span class=\"pre\">linker_run_id</span></code>; applied at runtime; ECE reported. (\u00a7B12)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>Hybrid fusion math</strong></p></td>\n<td><p>RRF <code class=\"docutils literal notranslate\"><span class=\"pre\">k</span></code>, candidate pool sizes, KG boost exact math not completely fixed.</p></td>\n<td><p>Deterministic results.</p></td>\n<td><p>Dense&#64;200 + Sparse&#64;200; <strong>RRF(k=60)</strong>; KG boosts: direct +0.08, 1\u2011hop +0.04; MMR \u03bb=0.7 at doc level. (\u00a7B13)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>API design</strong></p></td>\n<td><p>Only endpoint sketch; errors, pagination, filters, sorting, rate limits, auth, and OpenAPI not fully specified.</p></td>\n<td><p>Independent backend/frontend work.</p></td>\n<td><p>Full <strong>OpenAPI</strong> spec, error schema, pagination, filters (year, source, license), API\u2011key auth, per\u2011key rate limits (local token bucket), JSON response formats. (\u00a7B14)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>End\u2011to\u2011end testing</strong></p></td>\n<td><p>What E2E scenarios and fixtures to use; success criteria per stage unclear.</p></td>\n<td><p>Integration confidence.</p></td>\n<td><p>Provide seed corpora (10 docs), synthetic ontologies, golden outputs; E2E pipeline test that asserts all DDLs, artifact counts, index sizes, retrieval metrics over thresholds. (\u00a7B15)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>Observability</strong></p></td>\n<td><p>Log schema, metric names, labels, exemplar traces, dashboards unspecified.</p></td>\n<td><p>Ops readiness.</p></td>\n<td><p>Define <strong>metrics</strong> (names, types), <strong>logs</strong> (JSON schema), <strong>traces</strong> (span names &amp; attributes); provide Grafana panels JSON. (\u00a7B16)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>Failure handling</strong></p></td>\n<td><p>Error taxonomy, retry matrices, poison\u2011pill protocol, quarantine dirs not fixed.</p></td>\n<td><p>Robustness under real corpora.</p></td>\n<td><p>Standard error classes; retry/backoff tables; quarantine locations; incident log table and CLI. (\u00a7B17)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>Security &amp; licensing</strong></p></td>\n<td><p>Key storage, license enforcement points, audit fields not formalized.</p></td>\n<td><p>Compliance and reproducibility.</p></td>\n<td><p><code class=\"docutils literal notranslate\"><span class=\"pre\">.env</span></code> for secrets; license filters in downloader; persist license string and OA source; audit table records provenance; API keys in env; localhost binding. (\u00a7B18)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>Project structure &amp; code quality</strong></p></td>\n<td><p>Pre\u2011commit, linters, typing level, docstrings, ADRs, contribution workflow not locked.</p></td>\n<td><p>Team velocity &amp; consistency.</p></td>\n<td><p>Pre\u2011commit (ruff, black, mypy\u2011strict), conventional commits, ADR template, mkdocs site, contribution guide, codeowners. (\u00a7B19)</p></td>\n</tr>\n<tr class=\"row-odd\"><td><p><strong>Local dev &amp; bootstrap</strong></p></td>\n<td><p>No exact bootstrap steps and Make targets.</p></td>\n<td><p>Fast onboarding.</p></td>\n<td><p>Provide <code class=\"docutils literal notranslate\"><span class=\"pre\">scripts/bootstrap.sh</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">Makefile</span></code> targets, systemd units for vLLM + Nginx, folder layout creation. (\u00a7B20)</p></td>\n</tr>\n<tr class=\"row-even\"><td><p><strong>Performance SLAs</strong></p></td>\n<td><p>Hard SLAs and perf targets partially stated.</p></td>\n<td><p>Planning &amp; regression gates.</p></td>\n<td><p>SLAs/SLOs formalized per stage; CI gates with thresholds; perf budgets by stage. (\u00a7B21)</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</section>\n<hr class=\"docutils\" />\n<section id=\"part-b-exhaustive-specifications-resolutions\">\n<h2>PART B \u2014 EXHAUSTIVE SPECIFICATIONS (RESOLUTIONS)<a class=\"headerlink\" href=\"#part-b-exhaustive-specifications-resolutions\" title=\"Link to this heading\">#</a></h2>\n<section id=\"b1-canonical-text-hashing-ids\">\n<h3>B1. Canonical text, hashing &amp; IDs<a class=\"headerlink\" href=\"#b1-canonical-text-hashing-ids\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Canonicalizer</strong> (DocTags \u2192 text):</p>\n<ol class=\"arabic simple\">\n<li><p>Decode UTF\u20118; apply <strong>Unicode NFC</strong>.</p></li>\n<li><p>Replace Windows/old Mac line breaks with <code class=\"docutils literal notranslate\"><span class=\"pre\">\\n</span></code>.</p></li>\n<li><p>Collapse runs of whitespace to a single space <strong>except</strong> keep single <code class=\"docutils literal notranslate\"><span class=\"pre\">\\n</span></code> line breaks between block nodes (paragraph/heading/list/table caption).</p></li>\n<li><p>Normalize bullets (<code class=\"docutils literal notranslate\"><span class=\"pre\">\u2022</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">\u25e6</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">\u2013</span></code>) to <code class=\"docutils literal notranslate\"><span class=\"pre\">-</span></code>.</p></li>\n<li><p>Strip page headers/footers using DocTags region types; <strong>exclude References</strong> section by default (configurable).</p></li>\n<li><p>Retain figure/table captions, equations (inline LaTeX left as\u2011is), and footnotes (inlined at end of page).</p></li>\n</ol>\n</li>\n<li><p><strong>doc_id</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">urn:doc:sha256:&lt;first16B</span> <span class=\"pre\">base32&gt;</span></code> over <strong>canonical text</strong> (not PDF bytes).</p></li>\n<li><p><strong>chunk_id</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;</span></code> using <strong>character offsets</strong> in canonical text (inclusive start, exclusive end).</p></li>\n<li><p>Hashes computed with SHA\u2011256; extraction reproducible.</p></li>\n</ul>\n</section>\n<section id=\"b2-tokenizer-chunking-quantization\">\n<h3>B2. Tokenizer &amp; chunking quantization<a class=\"headerlink\" href=\"#b2-tokenizer-chunking-quantization\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Tokenizer of record</strong>: HuggingFace tokenizer for <strong>Qwen/Qwen3\u2011Embedding\u20114B</strong>.</p></li>\n<li><p><strong>Chunker parameters (fixed defaults)</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">target=400</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">overlap=80</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">min=120</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">max=480</span></code> <strong>Qwen tokens</strong>; stride=<code class=\"docutils literal notranslate\"><span class=\"pre\">target-overlap=320</span></code>.</p></li>\n<li><p>If a section is shorter than 120 tokens and can be merged with its successor without exceeding 480, merge; otherwise leave standalone.</p></li>\n<li><p>Sliding spill\u2011windows never cross major section boundaries (title/abstract/intro/methods/results/discussion).</p></li>\n</ul>\n</section>\n<section id=\"b3-doctags-selection-ocr-fallback\">\n<h3>B3. DocTags selection &amp; OCR fallback<a class=\"headerlink\" href=\"#b3-doctags-selection-ocr-fallback\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Include</strong>: title, authors, abstract, section headings, paragraphs, lists, tables, figures\u2019 captions, equations.</p></li>\n<li><p><strong>Exclude</strong> by default: acknowledgements, references; can enable via <code class=\"docutils literal notranslate\"><span class=\"pre\">config.doc_conversion.include_references=true</span></code>.</p></li>\n<li><p><strong>OCR</strong>: page\u2011level fallback using Tesseract when Docling VLM avg logprob &lt; 0.5; OCR text anchored into DocTags page node with <code class=\"docutils literal notranslate\"><span class=\"pre\">provenance=&quot;ocr&quot;</span></code>.</p></li>\n<li><p><strong>Provenance</strong> fields in DoctagsAsset: <code class=\"docutils literal notranslate\"><span class=\"pre\">{avg_logprob,</span> <span class=\"pre\">ocr_pages:[int]}</span></code>.</p></li>\n</ul>\n</section>\n<section id=\"b4-harvester-downloader-pyalex-first-with-fallbacks\">\n<h3>B4. Harvester &amp; downloader (PyAlex first, with fallbacks)<a class=\"headerlink\" href=\"#b4-harvester-downloader-pyalex-first-with-fallbacks\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>PyAlex search</strong>:</p>\n<ul>\n<li><p>Query compiled as AND of: <code class=\"docutils literal notranslate\"><span class=\"pre\">topic</span></code> (applied to <code class=\"docutils literal notranslate\"><span class=\"pre\">title</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">abstract_inverted_index</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">fulltext</span></code>), optional <code class=\"docutils literal notranslate\"><span class=\"pre\">year</span> <span class=\"pre\">&gt;=</span> <span class=\"pre\">from_year</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">is_oa=true</span> <span class=\"pre\">OR</span> <span class=\"pre\">has_oa_published_version=true</span> <span class=\"pre\">OR</span> <span class=\"pre\">has_oa_accepted_or_published_version=true</span></code>.</p></li>\n<li><p>Pagination: <code class=\"docutils literal notranslate\"><span class=\"pre\">per_page=200</span></code>, resume with <code class=\"docutils literal notranslate\"><span class=\"pre\">cursor</span></code>, cap at <code class=\"docutils literal notranslate\"><span class=\"pre\">max_works</span></code>.</p></li>\n<li><p>HTTP timeout=30\u202fs, retries=3 (exponential 1.0/2.0/4.0\u202fs), <code class=\"docutils literal notranslate\"><span class=\"pre\">User-Agent:</span> <span class=\"pre\">kgfoundry/1.0</span> <span class=\"pre\">(+contact&#64;example.com)</span></code>.</p></li>\n</ul>\n</li>\n<li><p><strong>Resolution priority</strong> (first success wins):</p>\n<ol class=\"arabic simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">best_oa_location.pdf_url</span></code> (OpenAlex).</p></li>\n<li><p>Any <code class=\"docutils literal notranslate\"><span class=\"pre\">locations[].pdf_url</span></code> with <code class=\"docutils literal notranslate\"><span class=\"pre\">is_oa=true</span></code> (prefer <code class=\"docutils literal notranslate\"><span class=\"pre\">publishedVersion</span></code> &gt; <code class=\"docutils literal notranslate\"><span class=\"pre\">acceptedVersion</span></code>).</p></li>\n<li><p><strong>Unpaywall</strong> by DOI \u2192 <code class=\"docutils literal notranslate\"><span class=\"pre\">url_for_pdf</span></code>.</p></li>\n<li><p>Source\u2011specific fallback: arXiv (<code class=\"docutils literal notranslate\"><span class=\"pre\">/pdf/&lt;id&gt;.pdf</span></code>), PMC article PDF.</p></li>\n</ol>\n</li>\n<li><p><strong>MIME + size checks</strong>: Require <code class=\"docutils literal notranslate\"><span class=\"pre\">application/pdf</span></code>; max size 100\u202fMB (configurable).</p></li>\n<li><p><strong>De\u2011dup</strong>: compute <code class=\"docutils literal notranslate\"><span class=\"pre\">pdf_sha256</span></code> of bytes; if duplicate of an existing doc, <strong>link</strong> new metadata to existing file and record alias (<code class=\"docutils literal notranslate\"><span class=\"pre\">openalex_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">doi</span></code>, etc.).</p></li>\n<li><p><strong>Registration</strong>: Insert into <code class=\"docutils literal notranslate\"><span class=\"pre\">documents</span></code> with all source IDs, <code class=\"docutils literal notranslate\"><span class=\"pre\">pdf_uri</span></code>, license, OA source, and timestamp.</p></li>\n</ul>\n</section>\n<section id=\"b5-dense-embeddings-qwen3-2560d\">\n<h3>B5. Dense embeddings (Qwen3 2560\u2011d)<a class=\"headerlink\" href=\"#b5-dense-embeddings-qwen3-2560d\" title=\"Link to this heading\">#</a></h3>\n<ul>\n<li><p><strong>API</strong>: OpenAI\u2011compatible <code class=\"docutils literal notranslate\"><span class=\"pre\">/v1/embeddings</span></code> with body:</p>\n<div class=\"highlight-json notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"p\">{</span><span class=\"nt\">&quot;model&quot;</span><span class=\"p\">:</span><span class=\"s2\">&quot;Qwen/Qwen3-Embedding-4B&quot;</span><span class=\"p\">,</span><span class=\"nt\">&quot;input&quot;</span><span class=\"p\">:[</span><span class=\"w\"> </span><span class=\"s2\">&quot;...chunk text...&quot;</span><span class=\"w\"> </span><span class=\"p\">],</span><span class=\"nt\">&quot;dimensions&quot;</span><span class=\"p\">:</span><span class=\"mi\">2560</span><span class=\"p\">}</span>\n</pre></div>\n</div>\n</li>\n<li><p><strong>Response validation</strong>: assert vector length 2560; otherwise <strong>fail run</strong> with incident record.</p></li>\n<li><p><strong>Batching</strong>: dynamic batch size uses VRAM probe; keep <strong>\u226480%</strong> VRAM.</p></li>\n<li><p><strong>Normalization</strong>: client L2\u2011normalizes vector (float32) and stores original L2.</p></li>\n<li><p><strong>Errors</strong>: HTTP 429/5xx \u2192 retries (3\u00d7); timeouts \u2192 retries; after 3 failures, quarantine batch.</p></li>\n</ul>\n</section>\n<section id=\"b6-sparse-spladev3-gpu-bm25-details\">\n<h3>B6. Sparse (SPLADE\u2011v3 GPU) &amp; BM25 details<a class=\"headerlink\" href=\"#b6-sparse-spladev3-gpu-bm25-details\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>SPLADE\u2011v3 encoder</strong>:</p>\n<ul>\n<li><p>Pre\u2011proc: lowercase; strip control chars (<code class=\"docutils literal notranslate\"><span class=\"pre\">\\x00</span></code>..<code class=\"docutils literal notranslate\"><span class=\"pre\">\\x1f</span></code>), keep punctuation; whitespace collapse single space; no stopword removal.</p></li>\n<li><p>Tokenization: DistilBERT WordPiece; <code class=\"docutils literal notranslate\"><span class=\"pre\">max_seq_len=512</span></code> (truncate tail).</p></li>\n<li><p>AMP: <code class=\"docutils literal notranslate\"><span class=\"pre\">torch.autocast(device_type=&quot;cuda&quot;,</span> <span class=\"pre\">dtype=torch.float16)</span></code>.</p></li>\n<li><p>Batch size: auto\u2011tuned per GPU memory; cap at 2048 tokens/batch.</p></li>\n<li><p>Top\u2011K pruning: select top 256 weights by value; tie\u2011break by <strong>token id asc</strong>; <strong>sort ascending</strong> token ids for indexer.</p></li>\n</ul>\n</li>\n<li><p><strong>BM25 (Pyserini/Lucene)</strong>:</p>\n<ul>\n<li><p>Analyzer: StandardTokenizer \u2192 Lowercase \u2192 EnglishMinimalStemFilter \u2192 EnglishStopFilter.</p></li>\n<li><p>Params: <code class=\"docutils literal notranslate\"><span class=\"pre\">k1=0.9</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">b=0.4</span></code>.</p></li>\n<li><p>Fields: <code class=\"docutils literal notranslate\"><span class=\"pre\">title</span></code> (boost 2.0), <code class=\"docutils literal notranslate\"><span class=\"pre\">section</span></code> (1.2), <code class=\"docutils literal notranslate\"><span class=\"pre\">body</span></code> (1.0). Title from DocTags title node; section from chunk.section; body from chunk text.</p></li>\n</ul>\n</li>\n</ul>\n</section>\n<section id=\"b7-parquet-datasets-all-embeddings-and-chunks\">\n<h3>B7. Parquet datasets (ALL embeddings and chunks)<a class=\"headerlink\" href=\"#b7-parquet-datasets-all-embeddings-and-chunks\" title=\"Link to this heading\">#</a></h3>\n<ul>\n<li><p><strong>Common options</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">compression=&quot;ZSTD&quot;</span></code>, level=6; <code class=\"docutils literal notranslate\"><span class=\"pre\">row_group_size=4096</span></code>; <code class=\"docutils literal notranslate\"><span class=\"pre\">use_dictionary=True</span></code> for categorical columns (<code class=\"docutils literal notranslate\"><span class=\"pre\">model</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">run_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">doc_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">section</span></code>).</p></li>\n<li><p><strong>Dense</strong>:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"n\">string</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">:</span> <span class=\"n\">string</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"n\">string</span><span class=\"p\">,</span> <span class=\"n\">dim</span><span class=\"p\">:</span> <span class=\"n\">int16</span> <span class=\"p\">(</span><span class=\"o\">=</span><span class=\"mi\">2560</span><span class=\"p\">),</span>\n<span class=\"n\">vector</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"o\">&lt;</span><span class=\"nb\">float</span><span class=\"o\">&gt;</span><span class=\"p\">,</span> <span class=\"n\">l2_norm</span><span class=\"p\">:</span> <span class=\"nb\">float</span><span class=\"p\">,</span> <span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">timestamp</span>\n</pre></div>\n</div>\n<p>Partitions: <code class=\"docutils literal notranslate\"><span class=\"pre\">model=Qwen3-Embedding-4B/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</span></code>.</p>\n</li>\n<li><p><strong>SPLADE</strong>:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"n\">string</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">:</span> <span class=\"n\">string</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"n\">string</span><span class=\"p\">,</span>\n<span class=\"n\">vocab_ids</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"o\">&lt;</span><span class=\"n\">int32</span><span class=\"o\">&gt;</span><span class=\"p\">,</span> <span class=\"n\">weights</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"o\">&lt;</span><span class=\"nb\">float</span><span class=\"o\">&gt;</span><span class=\"p\">,</span> <span class=\"n\">nnz</span><span class=\"p\">:</span> <span class=\"n\">int16</span><span class=\"p\">,</span> <span class=\"n\">created_at</span><span class=\"p\">:</span> <span class=\"n\">timestamp</span>\n</pre></div>\n</div>\n<p>Partitions: <code class=\"docutils literal notranslate\"><span class=\"pre\">model=SPLADE-v3-distilbert/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</span></code>.</p>\n</li>\n<li><p><strong>Chunks</strong>:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">chunk_id</span><span class=\"p\">,</span> <span class=\"n\">doc_id</span><span class=\"p\">,</span> <span class=\"n\">section</span><span class=\"p\">,</span> <span class=\"n\">start_char</span><span class=\"p\">:</span><span class=\"n\">int32</span><span class=\"p\">,</span> <span class=\"n\">end_char</span><span class=\"p\">:</span><span class=\"n\">int32</span><span class=\"p\">,</span>\n<span class=\"n\">doctags_span</span><span class=\"p\">:</span> <span class=\"n\">struct</span><span class=\"o\">&lt;</span><span class=\"n\">node_id</span><span class=\"p\">:</span><span class=\"n\">string</span><span class=\"p\">,</span><span class=\"n\">start</span><span class=\"p\">:</span><span class=\"n\">int32</span><span class=\"p\">,</span><span class=\"n\">end</span><span class=\"p\">:</span><span class=\"n\">int32</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"n\">text</span><span class=\"p\">:</span><span class=\"n\">string</span><span class=\"p\">,</span> <span class=\"n\">tokens</span><span class=\"p\">:</span><span class=\"n\">int32</span><span class=\"p\">,</span> <span class=\"n\">created_at</span><span class=\"p\">:</span><span class=\"n\">timestamp</span>\n</pre></div>\n</div>\n<p>Partition: <code class=\"docutils literal notranslate\"><span class=\"pre\">model=docling_hybrid/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</span></code>.</p>\n</li>\n</ul>\n</section>\n<section id=\"b8-duckdb-registry-1-4-1-migrations-guards\">\n<h3>B8. DuckDB registry (\u2265\u202f1.4.1): migrations &amp; guards<a class=\"headerlink\" href=\"#b8-duckdb-registry-1-4-1-migrations-guards\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Migrations</strong>: SQL files in <code class=\"docutils literal notranslate\"><span class=\"pre\">/registry/migrations</span></code>, applied by <code class=\"docutils literal notranslate\"><span class=\"pre\">registry</span> <span class=\"pre\">apply-migrations</span></code>. Each migration increments <code class=\"docutils literal notranslate\"><span class=\"pre\">schema_version</span></code> table.</p></li>\n<li><p><strong>Two\u2011phase registration</strong>: write Parquet to temp dir \u2192 validate row counts &amp; schema \u2192 <code class=\"docutils literal notranslate\"><span class=\"pre\">BEGIN</span></code> \u2192 insert into <code class=\"docutils literal notranslate\"><span class=\"pre\">datasets</span></code>/<code class=\"docutils literal notranslate\"><span class=\"pre\">runs</span></code> \u2192 <code class=\"docutils literal notranslate\"><span class=\"pre\">COMMIT</span></code> \u2192 rename dir into place; on failure <code class=\"docutils literal notranslate\"><span class=\"pre\">ROLLBACK</span></code> and delete temp.</p></li>\n<li><p><strong>Threading</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">PRAGMA</span> <span class=\"pre\">threads=14</span></code>; all read_parquet with <code class=\"docutils literal notranslate\"><span class=\"pre\">union_by_name=true</span></code>.</p></li>\n<li><p><strong>Integrity</strong>: FKs and unique constraints as defined.</p></li>\n<li><p><strong>Views</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">dense_vectors_view</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">splade_vectors_view</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">chunk_texts</span></code> pre\u2011created.</p></li>\n</ul>\n</section>\n<section id=\"b9-faiss-gpu-cuvs-cuda-13\">\n<h3>B9. FAISS GPU + cuVS (CUDA 13)<a class=\"headerlink\" href=\"#b9-faiss-gpu-cuvs-cuda-13\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Factory</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">OPQ64,IVF8192,PQ64</span></code> (for d=2560).</p></li>\n<li><p><strong>Train</strong>: Random sample of <strong>min(10M, 100% of corpus)</strong> dense vectors; seed=42; normalize before train.</p></li>\n<li><p><strong>Add</strong>: On GPU; batch of N where memory \u2264 80% VRAM; record adds per shard in DuckDB.</p></li>\n<li><p><strong>Search</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">nprobe=64</span></code>; return distances as <strong>IP or L2</strong> consistent with training (we use <strong>IP</strong> on normalized vectors \u2192 cosine).</p></li>\n<li><p><strong>Persist</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">.faiss</span></code> index + <code class=\"docutils literal notranslate\"><span class=\"pre\">.ids</span></code> idmap per shard; <code class=\"docutils literal notranslate\"><span class=\"pre\">faiss_indexes</span></code> table records <code class=\"docutils literal notranslate\"><span class=\"pre\">logical_index_id</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">shard_id</span></code>, file paths, config.</p></li>\n<li><p><strong>Merge</strong>: logical index = set of shards; search fans out to shards, merges top\u2011K.</p></li>\n</ul>\n</section>\n<section id=\"b10-vllm-servers-router\">\n<h3>B10. vLLM servers &amp; router<a class=\"headerlink\" href=\"#b10-vllm-servers-router\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Granite\u2011Docling (VLM)</strong>: vLLM process #1 on <code class=\"docutils literal notranslate\"><span class=\"pre\">127.0.0.1:8001</span></code>.</p></li>\n<li><p><strong>Qwen3 embeddings</strong>: vLLM process #2 on <code class=\"docutils literal notranslate\"><span class=\"pre\">127.0.0.1:8002</span></code>.</p></li>\n<li><p><strong>Router</strong>: Nginx on <code class=\"docutils literal notranslate\"><span class=\"pre\">:80</span></code> maps <code class=\"docutils literal notranslate\"><span class=\"pre\">/vlm/*</span></code> \u2192 8001 and <code class=\"docutils literal notranslate\"><span class=\"pre\">/v1/embeddings</span></code> \u2192 8002.</p></li>\n<li><p><strong>Health checks</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">/healthz</span></code> on router; <code class=\"docutils literal notranslate\"><span class=\"pre\">/v1/models</span></code> on each vLLM.</p></li>\n<li><p><strong>Client policy</strong>: per\u2011request timeout 30\u202fs, retries \u00d73 (429/5xx), exponential backoff 1/2/4\u202fs; circuit\u2011breaker opens after 10 consecutive failures (per\u2011service) for 30\u202fs.</p></li>\n</ul>\n</section>\n<section id=\"b11-ontology-ingestion-catalog\">\n<h3>B11. Ontology ingestion &amp; catalog<a class=\"headerlink\" href=\"#b11-ontology-ingestion-catalog\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Formats</strong>: OBO, OWL/RDF (TTL, RDF/XML), SKOS (RDF).</p></li>\n<li><p><strong>Predicates</strong>:</p>\n<ul>\n<li><p>Labels: <code class=\"docutils literal notranslate\"><span class=\"pre\">rdfs:label</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">skos:prefLabel</span></code>.</p></li>\n<li><p>Synonyms: <code class=\"docutils literal notranslate\"><span class=\"pre\">oboInOwl:hasExactSynonym</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">skos:altLabel</span></code>.</p></li>\n<li><p>Definitions: <code class=\"docutils literal notranslate\"><span class=\"pre\">IAO:0000115</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">skos:definition</span></code>.</p></li>\n<li><p>Hierarchy: <code class=\"docutils literal notranslate\"><span class=\"pre\">rdfs:subClassOf</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">skos:broader</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">BFO:part_of</span></code> (normalized to <code class=\"docutils literal notranslate\"><span class=\"pre\">IS_A</span></code> or <code class=\"docutils literal notranslate\"><span class=\"pre\">PART_OF</span></code>).</p></li>\n<li><p>Deprecation: <code class=\"docutils literal notranslate\"><span class=\"pre\">owl:deprecated</span></code> true; replacements: <code class=\"docutils literal notranslate\"><span class=\"pre\">iao:0100001</span></code> or custom <code class=\"docutils literal notranslate\"><span class=\"pre\">replaced_by</span></code>.</p></li>\n</ul>\n</li>\n<li><p><strong>CURIEs</strong>: Provide <code class=\"docutils literal notranslate\"><span class=\"pre\">prefix</span> <span class=\"pre\">\u2192</span> <span class=\"pre\">base</span> <span class=\"pre\">IRI</span></code> map per ontology; compute <code class=\"docutils literal notranslate\"><span class=\"pre\">urn:concept:&lt;ont&gt;:&lt;CURIE&gt;</span></code>.</p></li>\n<li><p><strong>Normalization</strong>: lowercased, NFC, punctuation trimmed (except hyphen and slash), English lemmatization.</p></li>\n<li><p><strong>Concept embeddings</strong>:</p>\n<ul>\n<li><p>Dense (Qwen3 2560\u2011d): text = <code class=\"docutils literal notranslate\"><span class=\"pre\">pref_label</span> <span class=\"pre\">|</span> <span class=\"pre\">definition</span> <span class=\"pre\">|</span> <span class=\"pre\">top5_synonyms</span></code>; same Parquet schema as chunks (swap <code class=\"docutils literal notranslate\"><span class=\"pre\">chunk_id</span> <span class=\"pre\">\u2192</span> <span class=\"pre\">concept_id</span></code>).</p></li>\n<li><p>Sparse (SPLADE): text same as above; topK=128.</p></li>\n</ul>\n</li>\n</ul>\n</section>\n<section id=\"b12-linker-calibration-decision-policy\">\n<h3>B12. Linker calibration &amp; decision policy<a class=\"headerlink\" href=\"#b12-linker-calibration-decision-policy\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Labeling</strong>: 2,000 chunk\u2011concept candidate pairs labeled by domain curators.</p></li>\n<li><p><strong>Splits</strong>: 5\u2011fold CV; train isotonic regression to map fused score \u2192 calibrated [0,1].</p></li>\n<li><p><strong>Thresholds</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">\u03c4_high=0.62</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">\u03c4_low=0.35</span></code> applied <strong>after calibration</strong>.</p></li>\n<li><p><strong>Outputs</strong>: save calibration params in DuckDB as JSON attached to <code class=\"docutils literal notranslate\"><span class=\"pre\">run_id</span></code> (linker run).</p></li>\n<li><p><strong>Metrics</strong>: precision/recall/F1; <strong>Expected Calibration Error</strong> (ECE).</p></li>\n</ul>\n</section>\n<section id=\"b13-hybrid-retrieval-fusion-fixed-math\">\n<h3>B13. Hybrid retrieval fusion (fixed math)<a class=\"headerlink\" href=\"#b13-hybrid-retrieval-fusion-fixed-math\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Retrieval</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">dense&#64;200</span></code> (FAISS), <code class=\"docutils literal notranslate\"><span class=\"pre\">sparse&#64;200</span></code> (BM25 and SPLADE each produce lists; we interleave by highest score then take top 200 combined sparse).</p></li>\n<li><p><strong>RRF</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">RRF_k</span> <span class=\"pre\">=</span> <span class=\"pre\">60</span></code>. Score = <code class=\"docutils literal notranslate\"><span class=\"pre\">\u03a3</span> <span class=\"pre\">1/(k</span> <span class=\"pre\">+</span> <span class=\"pre\">rank_i)</span></code> over participating rankers (dense, bm25, splade).</p></li>\n<li><p><strong>KG boost</strong>: +0.08 if any linked concept of chunk \u2208 query concepts; +0.04 if within one ontology hop; max boost +0.12.</p></li>\n<li><p><strong>MMR</strong>: doc\u2011level, <code class=\"docutils literal notranslate\"><span class=\"pre\">\u03bb=0.7</span></code>; similarity measured by cosine of mean chunk vectors per doc.</p></li>\n</ul>\n</section>\n<section id=\"b14-search-api-openapi-3-1-final\">\n<h3>B14. Search API \u2014 <strong>OpenAPI 3.1</strong> (final)<a class=\"headerlink\" href=\"#b14-search-api-openapi-3-1-final\" title=\"Link to this heading\">#</a></h3>\n<ul>\n<li><p><strong>Auth</strong>: Bearer API key header <code class=\"docutils literal notranslate\"><span class=\"pre\">Authorization:</span> <span class=\"pre\">Bearer</span> <span class=\"pre\">&lt;token&gt;</span></code> (tokens read from env <code class=\"docutils literal notranslate\"><span class=\"pre\">SEARCH_API_KEYS</span></code>, comma\u2011separated).</p></li>\n<li><p><strong>Rate limits</strong>: token\u2011bucket: 120 req/min per key; 1,000 req/day per key (in\u2011memory counters, process\u2011local).</p></li>\n<li><p><strong>Endpoints</strong>:</p>\n<ul>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">POST</span> <span class=\"pre\">/search</span></code></p>\n<ul>\n<li><p>Body:</p>\n<div class=\"highlight-json notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;query&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;string&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;k&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;filters&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"nt\">&quot;year_from&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2018</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">&quot;year_to&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2025</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">&quot;source&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s2\">&quot;openalex&quot;</span><span class=\"p\">,</span><span class=\"s2\">&quot;arxiv&quot;</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"nt\">&quot;license&quot;</span><span class=\"p\">:[</span><span class=\"s2\">&quot;CC-BY&quot;</span><span class=\"p\">,</span><span class=\"s2\">&quot;CC0&quot;</span><span class=\"p\">]},</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;explain&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">false</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n</li>\n<li><p>200 Response (per result):</p>\n<div class=\"highlight-json notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;doc_id&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;urn:doc:...&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;chunk_id&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;urn:chunk:...&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;title&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;string&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;section&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Methods&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;score&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">2.381</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;signals&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"nt\">&quot;dense&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">0.73</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">&quot;sparse&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">0.61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">&quot;rrf&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">0.025</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">&quot;kg_boost&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">0.08</span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;spans&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"nt\">&quot;start_char&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">120</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">&quot;end_char&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">420</span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nt\">&quot;concepts&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[{</span><span class=\"nt\">&quot;concept_id&quot;</span><span class=\"p\">:</span><span class=\"s2\">&quot;urn:concept:mesh:D012345&quot;</span><span class=\"p\">,</span><span class=\"nt\">&quot;label&quot;</span><span class=\"p\">:</span><span class=\"s2\">&quot;...&quot;</span><span class=\"p\">,</span><span class=\"nt\">&quot;match&quot;</span><span class=\"p\">:</span><span class=\"s2\">&quot;direct&quot;</span><span class=\"p\">}]</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n</li>\n<li><p>Errors: <code class=\"docutils literal notranslate\"><span class=\"pre\">400</span></code> (bad input), <code class=\"docutils literal notranslate\"><span class=\"pre\">401</span></code> (auth), <code class=\"docutils literal notranslate\"><span class=\"pre\">429</span></code> (rate limit), <code class=\"docutils literal notranslate\"><span class=\"pre\">500</span></code> (server).</p></li>\n</ul>\n</li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">POST</span> <span class=\"pre\">/graph/concepts</span></code></p>\n<ul class=\"simple\">\n<li><p>Body: <code class=\"docutils literal notranslate\"><span class=\"pre\">{&quot;q&quot;:&quot;string&quot;,&quot;limit&quot;:50}</span></code> \u2192 returns matching concept IDs + labels + paths to root.</p></li>\n</ul>\n</li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">GET</span> <span class=\"pre\">/healthz</span></code> \u2192 <code class=\"docutils literal notranslate\"><span class=\"pre\">{status:&quot;ok&quot;,</span> <span class=\"pre\">components:{faiss:&quot;ok&quot;,</span> <span class=\"pre\">bm25:&quot;ok&quot;,</span> <span class=\"pre\">vllm_embeddings:&quot;ok&quot;,</span> <span class=\"pre\">neo4j:&quot;ok&quot;}}</span></code>.</p></li>\n</ul>\n</li>\n</ul>\n</section>\n<section id=\"b15-endtoend-stage-testing\">\n<h3>B15. End\u2011to\u2011end &amp; stage testing<a class=\"headerlink\" href=\"#b15-endtoend-stage-testing\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Seed fixtures</strong>:</p>\n<ul>\n<li><p>10 OA PDFs (mix arXiv/PMC/journal) on disk for offline tests.</p></li>\n<li><p>Tiny ontology (50 concepts, 2 levels) + MeSH subset (for integration).</p></li>\n<li><p>Golden outputs: a) DocTags JSON; b) chunk Parquet; c) sample dense/sparse Parquets; d) FAISS index shards; e) SPLADE/BM25 Lucene dirs.</p></li>\n</ul>\n</li>\n<li><p><strong>E2E test</strong> (<code class=\"docutils literal notranslate\"><span class=\"pre\">pytest</span> <span class=\"pre\">-m</span> <span class=\"pre\">e2e</span></code>):</p>\n<ol class=\"arabic simple\">\n<li><p>Harvest &amp; download (mock pyalex/unpaywall): expect N PDFs.</p></li>\n<li><p>DocTags conversion: expect pages&gt;0, DocTags file exists, avg_logprob recorded.</p></li>\n<li><p>Chunking: expect chunks&gt;0; token counts within bounds; offsets monotonic.</p></li>\n<li><p>Dense embed: expect vectors dim=2560; Parquet rows==chunks.</p></li>\n<li><p>SPLADE encode &amp; BM25 index: Lucene dirs exist; postings &gt;0.</p></li>\n<li><p>FAISS build: index files exist; search for \u201ctopic\u201d returns &gt;0 results.</p></li>\n<li><p>Ontology ingest + concept embeddings: counts &gt;0; CURIEs valid.</p></li>\n<li><p>Linker: assertions produced; at least X% linked.</p></li>\n<li><p>KG upsert: node/edge counts as expected.</p></li>\n<li><p>Search API: <code class=\"docutils literal notranslate\"><span class=\"pre\">/search</span></code> returns 200 and k results; latency p95 &lt; 300\u202fms on fixtures.</p></li>\n</ol>\n</li>\n<li><p><strong>Stage unit tests</strong>: contract tests per ABC; property\u2011based tests (idempotency; stable IDs); golden tests for DocTags/chunks; benchmarking tests for encoder throughput.</p></li>\n</ul>\n</section>\n<section id=\"b16-observability-diagnostics\">\n<h3>B16. Observability &amp; diagnostics<a class=\"headerlink\" href=\"#b16-observability-diagnostics\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Logs</strong>: JSON lines with fields: <code class=\"docutils literal notranslate\"><span class=\"pre\">ts,</span> <span class=\"pre\">level,</span> <span class=\"pre\">module,</span> <span class=\"pre\">event,</span> <span class=\"pre\">run_id,</span> <span class=\"pre\">doc_id,</span> <span class=\"pre\">chunk_id,</span> <span class=\"pre\">duration_ms,</span> <span class=\"pre\">err_code,</span> <span class=\"pre\">message</span></code>.</p></li>\n<li><p><strong>Metrics</strong> (Prometheus):</p>\n<ul>\n<li><p>Counters: <code class=\"docutils literal notranslate\"><span class=\"pre\">pdf_download_success_total</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">pdf_download_failure_total{reason}</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">chunks_total</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">dense_vectors_total</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">splade_vectors_total</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">faiss_queries_total</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">bm25_queries_total</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">splade_queries_total</span></code>.</p></li>\n<li><p>Histograms: <code class=\"docutils literal notranslate\"><span class=\"pre\">download_latency_ms</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">doctags_latency_ms</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">chunking_latency_ms</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">embed_dense_latency_ms</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">splade_encode_latency_ms</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">faiss_search_latency_ms</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">search_total_latency_ms</span></code>.</p></li>\n<li><p>Gauges: <code class=\"docutils literal notranslate\"><span class=\"pre\">faiss_index_size_vectors</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">lucene_docs_count</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">duckdb_open_files</span></code>.</p></li>\n</ul>\n</li>\n<li><p><strong>Tracing</strong> (OpenTelemetry):</p>\n<ul>\n<li><p>Spans: <code class=\"docutils literal notranslate\"><span class=\"pre\">harvest.search</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">download.pdf</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">docling.to_doctags</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">chunking.hybrid</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">embed.qwen3</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">encode.splade</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">index.faiss.add</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">index.lucene.build</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">linker.run</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">kg.upsert</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">api.search</span></code>.</p></li>\n<li><p>Attributes: <code class=\"docutils literal notranslate\"><span class=\"pre\">{run_id,</span> <span class=\"pre\">doc_id,</span> <span class=\"pre\">shard_id,</span> <span class=\"pre\">model,</span> <span class=\"pre\">dim,</span> <span class=\"pre\">nprobe,</span> <span class=\"pre\">nnz}</span></code>.</p></li>\n</ul>\n</li>\n<li><p><strong>Dashboards</strong>: provide JSON exports for:</p>\n<ul>\n<li><p><strong>Ingest Health</strong> (download rates/errors).</p></li>\n<li><p><strong>Pipeline Throughput</strong> (chunks/min, embeddings/min).</p></li>\n<li><p><strong>Search SLOs</strong> (p50/p95/p99 latency, error rate).</p></li>\n<li><p><strong>Index Footprint</strong> (FAISS vectors, Lucene docs).</p></li>\n</ul>\n</li>\n</ul>\n</section>\n<section id=\"b17-failure-handling-resilience\">\n<h3>B17. Failure handling &amp; resilience<a class=\"headerlink\" href=\"#b17-failure-handling-resilience\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Error taxonomy</strong>:</p>\n<ul>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">DownloadError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">UnsupportedMIMEError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">DoclingError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">OCRTimeout</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">ChunkingError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">EmbeddingError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">SpladeOOM</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">FaissOOM</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">IndexBuildError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">OntologyParseError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">LinkerCalibrationError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">Neo4jError</span></code>.</p></li>\n</ul>\n</li>\n<li><p><strong>Retry/backoff</strong> table:</p>\n<ul>\n<li><p>External HTTP (download, vLLM): retries=3, backoff 1/2/4\u202fs.</p></li>\n<li><p>GPU OOM: reduce batch by 50%, retry up to 2 times; if still fails \u2192 quarantine.</p></li>\n<li><p>FAISS add error: split shard; retry once per split.</p></li>\n</ul>\n</li>\n<li><p><strong>Quarantine</strong>:</p>\n<ul>\n<li><p>PDFs: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/quarantine/pdfs/\u2026</span></code></p></li>\n<li><p>Parquet batches: <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/quarantine/parquet/\u2026</span></code></p></li>\n<li><p>Incidents table: <code class=\"docutils literal notranslate\"><span class=\"pre\">registry.incidents(event,</span> <span class=\"pre\">subject_id,</span> <span class=\"pre\">error_class,</span> <span class=\"pre\">message,</span> <span class=\"pre\">created_at)</span></code>.</p></li>\n</ul>\n</li>\n<li><p><strong>Poison pill</strong>: if a <code class=\"docutils literal notranslate\"><span class=\"pre\">doc_id</span></code> fails at stage X twice, mark <code class=\"docutils literal notranslate\"><span class=\"pre\">documents.status='poison'</span></code> and exclude from subsequent runs until manual override.</p></li>\n</ul>\n</section>\n<section id=\"b18-security-licensing-config-secrets\">\n<h3>B18. Security, licensing, config secrets<a class=\"headerlink\" href=\"#b18-security-licensing-config-secrets\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Local\u2011only</strong> network binding for vLLM and Neo4j.</p></li>\n<li><p><strong>API keys</strong> for Search API read from env <code class=\"docutils literal notranslate\"><span class=\"pre\">SEARCH_API_KEYS</span></code> (comma\u2011separated).</p></li>\n<li><p><strong>Licenses</strong> stored verbatim from source; <code class=\"docutils literal notranslate\"><span class=\"pre\">documents.license</span></code> required for downstream processing; refuse embedding/indexing if missing or not OA.</p></li>\n<li><p><strong>.env</strong> template for secrets and contact email; never commit real secrets.</p></li>\n</ul>\n</section>\n<section id=\"b19-code-quality-governance\">\n<h3>B19. Code quality &amp; governance<a class=\"headerlink\" href=\"#b19-code-quality-governance\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Pre\u2011commit</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">ruff</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">black</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">mypy</span> <span class=\"pre\">--strict</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">pyupgrade</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">interrogate</span></code> (docstring coverage).</p></li>\n<li><p><strong>Type discipline</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">from</span> <span class=\"pre\">__future__</span> <span class=\"pre\">import</span> <span class=\"pre\">annotations</span></code>, Protocol/ABC for interfaces, <code class=\"docutils literal notranslate\"><span class=\"pre\">Final</span></code> constants.</p></li>\n<li><p><strong>Docs</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">mkdocs</span></code> site with API docs (pdoc or mkdocstrings), how\u2011to guides, and ADRs (<code class=\"docutils literal notranslate\"><span class=\"pre\">/docs/adr/0001-...md</span></code>).</p></li>\n<li><p><strong>Conventional commits</strong> and <strong>semantic versioning</strong> per package.</p></li>\n<li><p><strong>Codeowners</strong> by directory.</p></li>\n</ul>\n</section>\n<section id=\"b20-bootstrap-devex\">\n<h3>B20. Bootstrap &amp; DevEx<a class=\"headerlink\" href=\"#b20-bootstrap-devex\" title=\"Link to this heading\">#</a></h3>\n<ul>\n<li><p><strong>Makefile</strong> targets:</p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">make</span> <span class=\"pre\">bootstrap</span></code> \u2192 create venv, install deps, install CUDA\u201113 Torch wheels, build/install FAISS GPU/cuVS (or fetch wheel), install vLLM prerelease, create dirs under <code class=\"docutils literal notranslate\"><span class=\"pre\">/data/*</span></code>, apply migrations, install systemd units for vLLM and Nginx.</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">make</span> <span class=\"pre\">run</span></code> \u2192 start router, start API, ensure vLLM services up.</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">make</span> <span class=\"pre\">e2e</span></code> \u2192 run the full fixture pipeline &amp; API checks.</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">make</span> <span class=\"pre\">clean</span></code> \u2192 remove indexes and temp outputs.</p></li>\n</ul>\n</li>\n<li><p><strong>Systemd</strong> units: <code class=\"docutils literal notranslate\"><span class=\"pre\">vllm-vlm.service</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">vllm-embed.service</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">nginx.service</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">search-api.service</span></code>.</p></li>\n<li><p><strong>Directory layout</strong>:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">pdfs</span>\n<span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">doctags</span>\n<span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">parquet</span><span class=\"o\">/</span><span class=\"p\">{</span><span class=\"n\">chunks</span><span class=\"p\">,</span><span class=\"n\">dense</span><span class=\"p\">,</span><span class=\"n\">sparse</span><span class=\"p\">,</span><span class=\"n\">concepts</span><span class=\"p\">}</span>\n<span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">lucene</span><span class=\"o\">/</span><span class=\"p\">{</span><span class=\"n\">bm25</span><span class=\"p\">,</span><span class=\"n\">splade</span><span class=\"p\">}</span>\n<span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">faiss</span>\n<span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">catalog</span><span class=\"o\">/</span><span class=\"n\">catalog</span><span class=\"o\">.</span><span class=\"n\">duckdb</span>\n<span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">quarantine</span><span class=\"o\">/</span><span class=\"p\">{</span><span class=\"n\">pdfs</span><span class=\"p\">,</span><span class=\"n\">parquet</span><span class=\"p\">}</span>\n</pre></div>\n</div>\n</li>\n</ul>\n</section>\n<section id=\"b21-slas-slos-performance-budgets\">\n<h3>B21. SLAs/SLOs &amp; performance budgets<a class=\"headerlink\" href=\"#b21-slas-slos-performance-budgets\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><strong>Downloader</strong>: \u2265 95% of accessible OA PDFs succeed within 60\u202fs; retries included.</p></li>\n<li><p><strong>DocTags</strong>: p95 \u2264 6\u202fs/10 pages (Granite\u2011Docling, RTX\u202f5090).</p></li>\n<li><p><strong>Chunking</strong>: \u2265 5,000 chunks/min CPU.</p></li>\n<li><p><strong>Dense embedding</strong>: \u2265 8,000 chunks/min (2560\u2011d) on RTX\u202f5090 under 80% VRAM.</p></li>\n<li><p><strong>SPLADE encoding</strong>: \u2265 5,000 chunks/min (AMP).</p></li>\n<li><p><strong>FAISS search</strong>: p95 \u2264 40\u202fms for 200\u2011NN; build time \u2264 2\u202fh per 10M vectors shard.</p></li>\n<li><p><strong>Search API</strong>: p95 end\u2011to\u2011end \u2264 300\u202fms for <code class=\"docutils literal notranslate\"><span class=\"pre\">k=10</span></code>, concurrency 64.</p></li>\n<li><p><strong>Linker run</strong>: \u2265 1M chunk\u2011concept candidate scorings/hour; ECE \u2264 0.08; F1 \u2265 0.70 on dev set.</p></li>\n<li><p><strong>CI gates</strong>: fail if nDCG&#64;10 drops &gt; 0.02 from last green or p95 latency \u2191 &gt; 20%.</p></li>\n</ul>\n</section>\n</section>\n<hr class=\"docutils\" />\n<section id=\"part-c-interfaces-module-contracts-ready-for-coding\">\n<h2>PART C \u2014 INTERFACES &amp; MODULE CONTRACTS (READY FOR CODING)<a class=\"headerlink\" href=\"#part-c-interfaces-module-contracts-ready-for-coding\" title=\"Link to this heading\">#</a></h2>\n<p>Below are <strong>Python interface signatures</strong> (type\u2011checked; exceptions documented). All implementations must adhere to these contracts.</p>\n<section id=\"c1-registry-duckdb-registry-api-py\">\n<h3>C1. Registry (DuckDB) \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">registry/api.py</span></code><a class=\"headerlink\" href=\"#c1-registry-duckdb-registry-api-py\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Registry</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">begin_dataset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">kind</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">commit_dataset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">dataset_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">parquet_root</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">rows</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">rollback_dataset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">dataset_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">insert_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">purpose</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">model_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">|</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">revision</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">|</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">config</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">close_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">success</span><span class=\"p\">:</span> <span class=\"nb\">bool</span><span class=\"p\">,</span> <span class=\"n\">notes</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">|</span> <span class=\"kc\">None</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">register_documents</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">docs</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Doc</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">register_doctags</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">assets</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">DoctagsAsset</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">register_chunks</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">dataset_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">chunk_rows</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">register_dense_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">dim</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">parquet_root</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">register_sparse_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">vocab_size</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">parquet_root</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">backend</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">register_faiss_shard</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">logical_index_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">shard_id</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">cfg</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">,</span> <span class=\"n\">index_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">idmap_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">emit_event</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">event_name</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">subject_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">incident</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">subject_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">error_class</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"c2-downloader-download-harvester-py\">\n<h3>C2. Downloader \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">download/harvester.py</span></code><a class=\"headerlink\" href=\"#c2-downloader-download-harvester-py\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Harvester</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">search</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">topic</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">years</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">max_works</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">dict</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">resolve_pdf</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">work</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span> <span class=\"o\">|</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">download_pdf</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">url</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">target_path</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span> <span class=\"o\">...</span>  <span class=\"c1\"># returns final path</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">topic</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">years</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">max_works</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Doc</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n<p><strong>Exceptions</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">DownloadError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">UnsupportedMIMEError</span></code>.</p>\n</section>\n<section id=\"c3-doctags-chunking-docling-vlm-py-docling-hybrid-py\">\n<h3>C3. DocTags &amp; chunking \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">docling/vlm.py</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">docling/hybrid.py</span></code><a class=\"headerlink\" href=\"#c3-doctags-chunking-docling-vlm-py-docling-hybrid-py\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">DocTagsConverter</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">to_doctags</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pdf_path</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">dict</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">persist</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">doc_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">doctags</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Chunker</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">chunk</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">doctags_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Chunk</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n<p><strong>Exceptions</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">DoclingError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">OCRTimeout</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">ChunkingError</span></code>.</p>\n</section>\n<section id=\"c4-embeddings-embeddings-dense-qwen3-py-embeddings-sparse-splade-py-embeddings-sparse-bm25-py\">\n<h3>C4. Embeddings \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">embeddings_dense/qwen3.py</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">embeddings_sparse/splade.py</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">embeddings_sparse/bm25.py</span></code><a class=\"headerlink\" href=\"#c4-embeddings-embeddings-dense-qwen3-py-embeddings-sparse-splade-py-embeddings-sparse-bm25-py\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">DenseEmbedder</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n    <span class=\"n\">dim</span><span class=\"p\">:</span> <span class=\"nb\">int</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">embed_texts</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">texts</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">SparseEncoder</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">encode</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">texts</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">],</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">float</span><span class=\"p\">]]]:</span> <span class=\"o\">...</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">SparseIndex</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">build</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">docs_iterable</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Iterable[tuple[str, dict]]&quot;</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">search</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">:</span> <span class=\"nb\">dict</span> <span class=\"o\">|</span> <span class=\"kc\">None</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]]:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n<p><strong>Exceptions</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">EmbeddingError</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">SpladeOOM</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">IndexBuildError</span></code>.</p>\n</section>\n<section id=\"c5-vector-store-vectorstore-faiss-gpu-py\">\n<h3>C5. Vector store \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">vectorstore_faiss/gpu.py</span></code><a class=\"headerlink\" href=\"#c5-vector-store-vectorstore-faiss-gpu-py\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">VectorStore</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">train</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">train_vectors</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"n\">factory</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">seed</span><span class=\"p\">:</span> <span class=\"nb\">int</span> <span class=\"o\">=</span> <span class=\"mi\">42</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">add</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">keys</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">],</span> <span class=\"n\">vectors</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">search</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]]:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">index_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">idmap_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">load</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">index_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">idmap_uri</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n<p><strong>Exceptions</strong>: <code class=\"docutils literal notranslate\"><span class=\"pre\">FaissOOM</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">IndexBuildError</span></code>.</p>\n</section>\n<section id=\"c6-ontology-catalog-ontology-loader-py\">\n<h3>C6. Ontology &amp; catalog \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">ontology/loader.py</span></code><a class=\"headerlink\" href=\"#c6-ontology-catalog-ontology-loader-py\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">OntologyCatalog</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">load</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">inputs</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">dict</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Concept</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">neighbors</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">concept_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">depth</span><span class=\"p\">:</span> <span class=\"nb\">int</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">concept_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">Concept</span> <span class=\"o\">|</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"c7-linker-linking-linker-py\">\n<h3>C7. Linker \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">linking/linker.py</span></code><a class=\"headerlink\" href=\"#c7-linker-linking-linker-py\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Linker</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">candidate_concepts</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunk_text</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">k_sparse</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">k_lex</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">score</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunk_vec</span><span class=\"p\">:</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">,</span> <span class=\"n\">concept_vecs</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"s2\">&quot;np.ndarray&quot;</span><span class=\"p\">],</span> <span class=\"n\">features</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">float</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">calibrate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">devset</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">float</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">]])</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">dict</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">link_chunk</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunk</span><span class=\"p\">:</span> <span class=\"n\">Chunk</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">LinkAssertion</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"c8-kg-builder-kg-builder-neo4j-py\">\n<h3>C8. KG builder \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">kg_builder/neo4j.py</span></code><a class=\"headerlink\" href=\"#c8-kg-builder-kg-builder-neo4j-py\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-python notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">GraphStore</span><span class=\"p\">(</span><span class=\"n\">Protocol</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">upsert_docs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">docs</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Doc</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">upsert_chunks</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunks</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Chunk</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">upsert_concepts</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">concepts</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">Concept</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">upsert_mentions</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">assertions</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">LinkAssertion</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span> <span class=\"o\">...</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">linked_concepts</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]:</span> <span class=\"o\">...</span>\n</pre></div>\n</div>\n</section>\n<section id=\"c9-search-api-search-api-app-py\">\n<h3>C9. Search API \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">search_api/app.py</span></code><a class=\"headerlink\" href=\"#c9-search-api-search-api-app-py\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p>Bootstraps FAISS handle(s), BM25, SPLADE, OntologyCatalog, GraphStore, DenseEmbedder; exposes FastAPI app with routers:</p>\n<ul>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">/search</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">/graph/concepts</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">/healthz</span></code>.</p></li>\n</ul>\n</li>\n<li><p>All responses validated with <code class=\"docutils literal notranslate\"><span class=\"pre\">pydantic</span></code> models.</p></li>\n</ul>\n</section>\n</section>\n<hr class=\"docutils\" />\n<section id=\"part-d-orchestration-prefect-2-x\">\n<h2>PART D \u2014 ORCHESTRATION (PREFECT 2.x)<a class=\"headerlink\" href=\"#part-d-orchestration-prefect-2-x\" title=\"Link to this heading\">#</a></h2>\n<section id=\"d1-flow-graph-idempotency-keys\">\n<h3>D1. Flow graph &amp; idempotency keys<a class=\"headerlink\" href=\"#d1-flow-graph-idempotency-keys\" title=\"Link to this heading\">#</a></h3>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span>harvest_and_download \u2192 convert_to_doctags \u2192 chunk_with_docling \u2192 \\\nembed_dense_qwen3 \u2510                                        \\\nencode_splade_v3  \u251c\u2500\u2500 build_bm25_index \u2510                    \\\n                   \u2514\u2500\u2500 build_faiss_index  \u2192 ingest_ontologies \u2192 embed_concepts \\\n                                                   \u2192 link_chunks_to_concepts \u2192 kg_upsert\n</pre></div>\n</div>\n<ul class=\"simple\">\n<li><p><strong>Idempotency keys</strong>:</p>\n<ul>\n<li><p>Harvest: <code class=\"docutils literal notranslate\"><span class=\"pre\">(topic,</span> <span class=\"pre\">years,</span> <span class=\"pre\">work_id)</span></code></p></li>\n<li><p>DocTags: <code class=\"docutils literal notranslate\"><span class=\"pre\">pdf_sha256</span></code></p></li>\n<li><p>Chunking: <code class=\"docutils literal notranslate\"><span class=\"pre\">(doc_id,</span> <span class=\"pre\">chunker_version)</span></code></p></li>\n<li><p>Dense: <code class=\"docutils literal notranslate\"><span class=\"pre\">(chunk_dataset_id,</span> <span class=\"pre\">model=Qwen3,</span> <span class=\"pre\">dim=2560)</span></code></p></li>\n<li><p>SPLADE: <code class=\"docutils literal notranslate\"><span class=\"pre\">(chunk_dataset_id,</span> <span class=\"pre\">model=SPLADE-v3,</span> <span class=\"pre\">topk=256)</span></code></p></li>\n<li><p>FAISS: <code class=\"docutils literal notranslate\"><span class=\"pre\">(dense_run_id,</span> <span class=\"pre\">factory,</span> <span class=\"pre\">nlist,</span> <span class=\"pre\">m,</span> <span class=\"pre\">nprobe)</span></code></p></li>\n<li><p>Ontology: <code class=\"docutils literal notranslate\"><span class=\"pre\">(ontology_id,</span> <span class=\"pre\">src_uri,</span> <span class=\"pre\">loader_version)</span></code></p></li>\n<li><p>Linker: <code class=\"docutils literal notranslate\"><span class=\"pre\">(chunk_dataset_id,</span> <span class=\"pre\">ontology_id,</span> <span class=\"pre\">linker_version)</span></code></p></li>\n</ul>\n</li>\n</ul>\n</section>\n<section id=\"d2-concurrency-retries\">\n<h3>D2. Concurrency &amp; retries<a class=\"headerlink\" href=\"#d2-concurrency-retries\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p>Download: 8 workers, retry matrix as in \u00a7B17.</p></li>\n<li><p>VLM/embeddings/SPLADE: GPU queue depth=2; batch auto\u2011tune; 3 retries on transient errors.</p></li>\n<li><p>Index builds: FAISS shards in parallel up to 2; Lucene index single\u2011writer with merges at end.</p></li>\n</ul>\n</section>\n<section id=\"d3-cli-commands-invoke-via-typer\">\n<h3>D3. CLI commands (invoke via Typer)<a class=\"headerlink\" href=\"#d3-cli-commands-invoke-via-typer\" title=\"Link to this heading\">#</a></h3>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">harvest</span> <span class=\"pre\">--topic</span> <span class=\"pre\">&quot;LLM</span> <span class=\"pre\">alignment&quot;</span> <span class=\"pre\">--years</span> <span class=\"pre\">2018..2025</span> <span class=\"pre\">--max</span> <span class=\"pre\">20000</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">doctags</span> <span class=\"pre\">--input</span> <span class=\"pre\">/data/pdfs</span> <span class=\"pre\">--out</span> <span class=\"pre\">/data/doctags</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">chunk</span> <span class=\"pre\">--doctags</span> <span class=\"pre\">/data/doctags</span> <span class=\"pre\">--out</span> <span class=\"pre\">/data/parquet/chunks</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">embed-dense</span> <span class=\"pre\">--chunks</span> <span class=\"pre\">&lt;dataset_id&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">encode-splade</span> <span class=\"pre\">--chunks</span> <span class=\"pre\">&lt;dataset_id&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">index-bm25</span> <span class=\"pre\">--chunks</span> <span class=\"pre\">&lt;dataset_id&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">index-faiss</span> <span class=\"pre\">--dense-run</span> <span class=\"pre\">&lt;run_id&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">ingest-ontology</span> <span class=\"pre\">--id</span> <span class=\"pre\">mesh</span> <span class=\"pre\">--uri</span> <span class=\"pre\">/data/ontologies/mesh.obo</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">embed-concepts</span> <span class=\"pre\">--ontology</span> <span class=\"pre\">mesh</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">link</span> <span class=\"pre\">--chunks</span> <span class=\"pre\">&lt;dataset_id&gt;</span> <span class=\"pre\">--ontology</span> <span class=\"pre\">mesh</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">kg-upsert</span> <span class=\"pre\">--link-run</span> <span class=\"pre\">&lt;run_id&gt;</span></code></p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">kgf</span> <span class=\"pre\">api</span> <span class=\"pre\">--port</span> <span class=\"pre\">8080</span></code></p></li>\n</ul>\n</section>\n</section>\n<hr class=\"docutils\" />\n<section id=\"part-e-endtoend-acceptance-criteria-per-workstream\">\n<h2>PART E \u2014 END\u2011TO\u2011END ACCEPTANCE CRITERIA (PER WORKSTREAM)<a class=\"headerlink\" href=\"#part-e-endtoend-acceptance-criteria-per-workstream\" title=\"Link to this heading\">#</a></h2>\n<p><strong>Downloader</strong></p>\n<ul class=\"simple\">\n<li><p>Given topic and year range, at least N documents discovered; \u226595% OA downloads succeed; duplicates deduped; license persisted.</p></li>\n</ul>\n<p><strong>DocTags</strong></p>\n<ul class=\"simple\">\n<li><p>For each PDF, DocTags exists; pages count &gt; 0; avg_logprob recorded; OCR fallback pages tracked.</p></li>\n</ul>\n<p><strong>Chunking</strong></p>\n<ul class=\"simple\">\n<li><p>For each <code class=\"docutils literal notranslate\"><span class=\"pre\">doc_id</span></code>, sum of chunk spans covers \u226590% of canonical text; token counts in [min,max]; offsets monotonic.</p></li>\n</ul>\n<p><strong>Dense embeddings</strong></p>\n<ul class=\"simple\">\n<li><p>Row count == chunk rows; all vectors dim=2560; Parquet schema validated; L2 norms avg in [0.95,1.05] post\u2011norm.</p></li>\n</ul>\n<p><strong>SPLADE/BM25</strong></p>\n<ul class=\"simple\">\n<li><p>SPLADE nnz distribution mean \u2248 220\u2013260; Lucene impact index has postings; BM25 index doc count == chunk count.</p></li>\n</ul>\n<p><strong>FAISS</strong></p>\n<ul class=\"simple\">\n<li><p>Trained index exists; top\u2011K search returns results; p95 latency \u2264 40\u202fms for K=200 on fixture set.</p></li>\n</ul>\n<p><strong>Ontology &amp; concepts</strong></p>\n<ul class=\"simple\">\n<li><p>Loaded concepts &gt; 0; no duplicate CURIEs; concept embeddings Parquet rows == concepts; ontology edges inserted.</p></li>\n</ul>\n<p><strong>Linker</strong></p>\n<ul class=\"simple\">\n<li><p>Produces assertions; on fixtures F1 \u2265 0.70; ECE \u2264 0.08; calibration saved and applied.</p></li>\n</ul>\n<p><strong>KG</strong></p>\n<ul class=\"simple\">\n<li><p>Node uniqueness constraints enforced; edge counts match assertions; query <code class=\"docutils literal notranslate\"><span class=\"pre\">linked_concepts(chunk)</span></code> returns expected IDs.</p></li>\n</ul>\n<p><strong>Search API</strong></p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">/healthz</span></code> OK; <code class=\"docutils literal notranslate\"><span class=\"pre\">/search</span></code> returns k results with explanations; p95 \u2264 300\u202fms on fixtures.</p></li>\n</ul>\n</section>\n<hr class=\"docutils\" />\n<section id=\"part-f-sample-openapi-excerpt\">\n<h2>PART F \u2014 SAMPLE OPENAPI (EXCERPT)<a class=\"headerlink\" href=\"#part-f-sample-openapi-excerpt\" title=\"Link to this heading\">#</a></h2>\n<div class=\"highlight-yaml notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"nt\">openapi</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">3.1.0</span>\n<span class=\"nt\">info</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">title</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">kgfoundry Search API</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> version</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">1.0.0</span><span class=\"p p-Indicator\">}</span>\n<span class=\"nt\">paths</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">/search</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">post</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"nt\">security</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">[{</span><span class=\"nt\">ApiKeyAuth</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">[]}]</span>\n<span class=\"w\">      </span><span class=\"nt\">requestBody</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"nt\">content</span><span class=\"p\">:</span>\n<span class=\"w\">          </span><span class=\"nt\">application/json</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"nt\">schema</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">object</span>\n<span class=\"w\">              </span><span class=\"nt\">required</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">[</span><span class=\"nv\">query</span><span class=\"p p-Indicator\">]</span>\n<span class=\"w\">              </span><span class=\"nt\">properties</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"nt\">query</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> minLength</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">1</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">                </span><span class=\"nt\">k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">integer</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> minimum</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">1</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> maximum</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">100</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> default</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">10</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">                </span><span class=\"nt\">filters</span><span class=\"p\">:</span>\n<span class=\"w\">                  </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">object</span>\n<span class=\"w\">                  </span><span class=\"nt\">properties</span><span class=\"p\">:</span>\n<span class=\"w\">                    </span><span class=\"nt\">year_from</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">integer</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">                    </span><span class=\"nt\">year_to</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">integer</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">                    </span><span class=\"nt\">source</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">array</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> items</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">}}</span>\n<span class=\"w\">                    </span><span class=\"nt\">license</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">array</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> items</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">}}</span>\n<span class=\"w\">                </span><span class=\"nt\">explain</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">boolean</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> default</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">false</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">      </span><span class=\"nt\">responses</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"s\">&#39;200&#39;</span><span class=\"p p-Indicator\">:</span>\n<span class=\"w\">          </span><span class=\"nt\">description</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">OK</span>\n<span class=\"w\">          </span><span class=\"nt\">content</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"nt\">application/json</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"nt\">schema</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">object</span>\n<span class=\"w\">                </span><span class=\"nt\">properties</span><span class=\"p\">:</span>\n<span class=\"w\">                  </span><span class=\"nt\">results</span><span class=\"p\">:</span>\n<span class=\"w\">                    </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">array</span>\n<span class=\"w\">                    </span><span class=\"nt\">items</span><span class=\"p\">:</span>\n<span class=\"w\">                      </span><span class=\"nt\">$ref</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&#39;#/components/schemas/Result&#39;</span>\n<span class=\"w\">        </span><span class=\"s\">&#39;400&#39;</span><span class=\"p p-Indicator\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">$ref</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&#39;#/components/responses/BadRequest&#39;</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"s\">&#39;401&#39;</span><span class=\"p p-Indicator\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">$ref</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&#39;#/components/responses/Unauthorized&#39;</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"s\">&#39;429&#39;</span><span class=\"p p-Indicator\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">$ref</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&#39;#/components/responses/TooManyRequests&#39;</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"s\">&#39;500&#39;</span><span class=\"p p-Indicator\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">$ref</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&#39;#/components/responses/ServerError&#39;</span><span class=\"p p-Indicator\">}</span>\n<span class=\"nt\">components</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">securitySchemes</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">ApiKeyAuth</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">http</span>\n<span class=\"w\">      </span><span class=\"nt\">scheme</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">bearer</span>\n<span class=\"w\">  </span><span class=\"nt\">schemas</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">Result</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">object</span>\n<span class=\"w\">      </span><span class=\"nt\">required</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">[</span><span class=\"nv\">doc_id</span><span class=\"p p-Indicator\">,</span><span class=\"w\"> </span><span class=\"nv\">chunk_id</span><span class=\"p p-Indicator\">,</span><span class=\"w\"> </span><span class=\"nv\">title</span><span class=\"p p-Indicator\">,</span><span class=\"w\"> </span><span class=\"nv\">section</span><span class=\"p p-Indicator\">,</span><span class=\"w\"> </span><span class=\"nv\">score</span><span class=\"p p-Indicator\">]</span>\n<span class=\"w\">      </span><span class=\"nt\">properties</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"nt\">doc_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"nt\">chunk_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"nt\">title</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"nt\">section</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"nt\">score</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">number</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"nt\">signals</span><span class=\"p\">:</span>\n<span class=\"w\">          </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">object</span>\n<span class=\"w\">          </span><span class=\"nt\">properties</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"nt\">dense</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">number</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">            </span><span class=\"nt\">sparse</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">number</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">            </span><span class=\"nt\">rrf</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">number</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">            </span><span class=\"nt\">kg_boost</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">number</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"nt\">spans</span><span class=\"p\">:</span>\n<span class=\"w\">          </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">object</span>\n<span class=\"w\">          </span><span class=\"nt\">properties</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"nt\">start_char</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">integer</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">            </span><span class=\"nt\">end_char</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">integer</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">        </span><span class=\"nt\">concepts</span><span class=\"p\">:</span>\n<span class=\"w\">          </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">array</span>\n<span class=\"w\">          </span><span class=\"nt\">items</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">object</span>\n<span class=\"w\">            </span><span class=\"nt\">properties</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"nt\">concept_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">              </span><span class=\"nt\">label</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">              </span><span class=\"nt\">match</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\">type</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">string</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> enum</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">[</span><span class=\"nv\">direct</span><span class=\"p p-Indicator\">,</span><span class=\"nv\">nearby</span><span class=\"p p-Indicator\">]}</span>\n</pre></div>\n</div>\n</section>\n<hr class=\"docutils\" />\n<section id=\"part-g-implementation-checklists-by-workstream\">\n<h2>PART G \u2014 IMPLEMENTATION CHECKLISTS (BY WORKSTREAM)<a class=\"headerlink\" href=\"#part-g-implementation-checklists-by-workstream\" title=\"Link to this heading\">#</a></h2>\n<ol class=\"arabic simple\">\n<li><p><strong>Download &amp; Harvest</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] PyAlex client; config; retries; polite UA.</p></li>\n<li><p>[ ] Fallback Unpaywall client; DOI resolver.</p></li>\n<li><p>[ ] PDF validator; MIME/size checks; hash; dedup; storage path; registry insert.</p></li>\n<li><p>[ ] Metrics/logs/tests; CLI command; E2E hooks.</p></li>\n</ul>\n</li>\n<li><p><strong>DocTags Conversion</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] vLLM client; page batches; OCR fallback; canonicalizer; provenance.</p></li>\n<li><p>[ ] Persist <code class=\"docutils literal notranslate\"><span class=\"pre\">.dt.json.zst</span></code>; register DoctagsAsset; golden tests.</p></li>\n</ul>\n</li>\n<li><p><strong>Hybrid Chunker</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] Qwen tokenizer; section splitting; sliding windows; spans &amp; offsets.</p></li>\n<li><p>[ ] Parquet writer; ID scheme; tests for bounds &amp; coverage.</p></li>\n</ul>\n</li>\n<li><p><strong>Dense Embedder (Qwen3 2560)</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] OpenAI API client; dimension param; batching; normalization; retries.</p></li>\n<li><p>[ ] Parquet writer; registry run; throughput metric; tests.</p></li>\n</ul>\n</li>\n<li><p><strong>SPLADE\u2011v3 &amp; BM25</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] Torch encoder; AMP; top\u2011K; Parquet writer; impact index streaming.</p></li>\n<li><p>[ ] BM25 analyzer config; indexer; search adapter; tests.</p></li>\n</ul>\n</li>\n<li><p><strong>FAISS GPU/cuVS</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] Loader; training sampler; add &amp; search; shard manager; save/load.</p></li>\n<li><p>[ ] Query adapter (top\u2011K); memory gauges; tests.</p></li>\n</ul>\n</li>\n<li><p><strong>Ontology &amp; Concepts</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] Parsers (OBO/OWL/SKOS); normalization; CURIEs; edges.</p></li>\n<li><p>[ ] Dense &amp; SPLADE embeddings for concepts; Parquet &amp; registry.</p></li>\n</ul>\n</li>\n<li><p><strong>Linker</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] Candidate gen (SPLADE+lexicon); feature extractor; fusion; calibration; thresholds.</p></li>\n<li><p>[ ] Assertions Parquet; metrics; tests.</p></li>\n</ul>\n</li>\n<li><p><strong>KG Builder (Neo4j)</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] Node/edge upserts; uniqueness constraints; indexes.</p></li>\n<li><p>[ ] Linked concept lookups; tests.</p></li>\n</ul>\n</li>\n<li><p><strong>Search API</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] Startup wiring; RRF; KG boosts; MMR; filters; auth; rate limits.</p></li>\n<li><p>[ ] OpenAPI; integration tests; latency regression tests.</p></li>\n</ul>\n</li>\n<li><p><strong>Registry &amp; Orchestration</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] Migrations; two\u2011phase dataset registration; events &amp; incidents.</p></li>\n<li><p>[ ] Prefect flows; CLI; idempotency keys; dashboards.</p></li>\n</ul>\n</li>\n<li><p><strong>Ops</strong></p>\n<ul class=\"simple\">\n<li><p>[ ] systemd units; Nginx config; health checks; log rotation; backup scripts (Parquet+DuckDB).</p></li>\n</ul>\n</li>\n</ol>\n</section>\n<hr class=\"docutils\" />\n<section id=\"part-h-example-config-final-ready-to-commit\">\n<h2>PART H \u2014 EXAMPLE CONFIG (FINAL; READY TO COMMIT)<a class=\"headerlink\" href=\"#part-h-example-config-final-ready-to-commit\" title=\"Link to this heading\">#</a></h2>\n<div class=\"highlight-yaml notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"nt\">system</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">os</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">ubuntu-24.04</span>\n<span class=\"w\">  </span><span class=\"nt\">threads</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">14</span>\n<span class=\"w\">  </span><span class=\"nt\">seed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">42</span>\n<span class=\"w\">  </span><span class=\"nt\">parquet_root</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/parquet</span>\n<span class=\"w\">  </span><span class=\"nt\">artifacts_root</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/artifacts</span>\n<span class=\"w\">  </span><span class=\"nt\">duckdb_path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/catalog/catalog.duckdb</span>\n\n<span class=\"nt\">runtime</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">python</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;3.13&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">cuda</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;13.0&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">torch</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;2.9&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">duckdb_min</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;1.4.1&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">vllm_channel</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;pre-release-cuda13&quot;</span>\n\n<span class=\"nt\">network</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">nginx_port</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">80</span>\n<span class=\"w\">  </span><span class=\"nt\">vlm_port</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8001</span>\n<span class=\"w\">  </span><span class=\"nt\">emb_port</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8002</span>\n<span class=\"w\">  </span><span class=\"nt\">api_port</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8080</span>\n\n<span class=\"nt\">harvest</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">provider</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">pyalex</span>\n<span class=\"w\">  </span><span class=\"nt\">per_page</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">200</span>\n<span class=\"w\">  </span><span class=\"nt\">max_works</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">20000</span>\n<span class=\"w\">  </span><span class=\"nt\">years</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">&quot;&gt;=2018&quot;</span>\n<span class=\"w\">  </span><span class=\"nt\">filters</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">is_oa</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">    </span><span class=\"nt\">has_oa_published_version</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">fallbacks</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">unpaywall</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">    </span><span class=\"nt\">arxiv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">    </span><span class=\"nt\">pmc</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">concurrency</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8</span>\n<span class=\"w\">  </span><span class=\"nt\">timeout_sec</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">60</span>\n<span class=\"w\">  </span><span class=\"nt\">retries</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">3</span>\n\n<span class=\"nt\">doc_conversion</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">vlm_model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">ibm-granite/granite-docling-258M</span>\n<span class=\"w\">  </span><span class=\"nt\">vlm_revision</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">untied</span>\n<span class=\"w\">  </span><span class=\"nt\">endpoint</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">http://localhost/vlm/</span>\n<span class=\"w\">  </span><span class=\"nt\">dpi</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">220</span>\n<span class=\"w\">  </span><span class=\"nt\">page_batch</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">8</span>\n<span class=\"w\">  </span><span class=\"nt\">ocr_fallback</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">max_pages</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">2000</span>\n<span class=\"w\">  </span><span class=\"nt\">timeout_sec</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">120</span>\n\n<span class=\"nt\">chunking</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">engine</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">docling_hybrid</span>\n<span class=\"w\">  </span><span class=\"nt\">target_tokens</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">400</span>\n<span class=\"w\">  </span><span class=\"nt\">overlap_tokens</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">80</span>\n<span class=\"w\">  </span><span class=\"nt\">min_tokens</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">120</span>\n<span class=\"w\">  </span><span class=\"nt\">max_tokens</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">480</span>\n\n<span class=\"nt\">dense_embedding</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Qwen/Qwen3-Embedding-4B</span>\n<span class=\"w\">  </span><span class=\"nt\">endpoint</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">http://localhost/v1/embeddings</span>\n<span class=\"w\">  </span><span class=\"nt\">output_dim</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">2560</span>\n<span class=\"w\">  </span><span class=\"nt\">parquet_out</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${system.parquet_root}/dense/model=Qwen3-Embedding-4B/run=${run_id}</span>\n\n<span class=\"nt\">sparse_embedding</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">splade</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">naver/splade-v3-distilbert</span>\n<span class=\"w\">    </span><span class=\"nt\">device</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">cuda</span>\n<span class=\"w\">    </span><span class=\"nt\">amp</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">fp16</span>\n<span class=\"w\">    </span><span class=\"nt\">max_seq_len</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">512</span>\n<span class=\"w\">    </span><span class=\"nt\">topk</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">256</span>\n<span class=\"w\">    </span><span class=\"nt\">parquet_out</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${system.parquet_root}/sparse/model=SPLADE-v3-distilbert/run=${run_id}</span>\n<span class=\"w\">  </span><span class=\"nt\">bm25</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">k1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">0.9</span>\n<span class=\"w\">    </span><span class=\"nt\">b</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">0.4</span>\n<span class=\"w\">    </span><span class=\"nt\">field_boosts</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> title</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">2.0</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> section</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">1.2</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> body</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">1.0</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">    </span><span class=\"nt\">index_dir</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/lucene/bm25</span>\n\n<span class=\"nt\">faiss</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">index_factory</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">OPQ64,IVF8192,PQ64</span>\n<span class=\"w\">  </span><span class=\"nt\">nprobe</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">64</span>\n<span class=\"w\">  </span><span class=\"nt\">train_samples</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">10000000</span>\n<span class=\"w\">  </span><span class=\"nt\">shards</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">max_vectors_per_shard</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">10000000</span>\n<span class=\"w\">  </span><span class=\"nt\">gpu</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">cuvs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">true</span>\n<span class=\"w\">  </span><span class=\"nt\">output_dir</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/data/faiss/qwen3_ivfpq</span>\n\n<span class=\"nt\">ontology</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">inputs</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> ontology_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">mesh</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> format</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">obo</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> uri</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">/data/ontologies/mesh.obo</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">    </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> ontology_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">go</span><span class=\"p p-Indicator\">,</span><span class=\"nt\">   format</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">obo</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> uri</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">/data/ontologies/go.obo</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">  </span><span class=\"nt\">concept_embed</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">dense_model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Qwen3-Embedding-4B</span>\n<span class=\"w\">    </span><span class=\"nt\">dense_dim</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">2560</span>\n<span class=\"w\">    </span><span class=\"nt\">splade_model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">SPLADE-v3-distilbert</span>\n<span class=\"w\">    </span><span class=\"nt\">splade_topk</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">128</span>\n\n<span class=\"nt\">linker</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">candidates</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> splade_topk</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">100</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> lexicon_topk</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">50</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">  </span><span class=\"nt\">fusion_weights</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> dense</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.55</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> sparse</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.35</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> lexical</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.10</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> depth_bonus_per_level</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.02</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> depth_cap</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.10</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">  </span><span class=\"nt\">thresholds</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> high</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.62</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> low</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.35</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n<span class=\"w\">  </span><span class=\"nt\">calibration</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">isotonic</span>\n\n<span class=\"nt\">graph</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">backend</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">neo4j</span>\n<span class=\"w\">  </span><span class=\"nt\">uri</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">bolt://localhost:7687</span>\n<span class=\"w\">  </span><span class=\"nt\">user</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">neo4j</span>\n<span class=\"w\">  </span><span class=\"nt\">password_env</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">NEO4J_PASSWORD</span>\n\n<span class=\"nt\">search</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">10</span>\n<span class=\"w\">  </span><span class=\"nt\">dense_candidates</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">200</span>\n<span class=\"w\">  </span><span class=\"nt\">sparse_candidates</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">200</span>\n<span class=\"w\">  </span><span class=\"nt\">rrf_k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">60</span>\n<span class=\"w\">  </span><span class=\"nt\">mmr_lambda</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">0.7</span>\n<span class=\"w\">  </span><span class=\"nt\">kg_boosts</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">{</span><span class=\"nt\"> direct</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.08</span><span class=\"p p-Indicator\">,</span><span class=\"nt\"> one_hop</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nv\">0.04</span><span class=\"w\"> </span><span class=\"p p-Indicator\">}</span>\n</pre></div>\n</div>\n</section>\n<hr class=\"docutils\" />\n<section id=\"part-i-what-happens-next\">\n<h2>PART I \u2014 WHAT HAPPENS NEXT<a class=\"headerlink\" href=\"#part-i-what-happens-next\" title=\"Link to this heading\">#</a></h2>\n<p>With these <strong>resolved specifications</strong>:</p>\n<ul class=\"simple\">\n<li><p>Each workstream has <strong>clear interfaces</strong>, <strong>error types</strong>, <strong>Parquet schemas</strong>, <strong>DuckDB DDL</strong>, <strong>router/API contracts</strong>, <strong>orchestration flows</strong>, <strong>observability</strong>, <strong>SLAs</strong>, and <strong>acceptance tests</strong>.</p></li>\n<li><p>Teams can now draft <strong>detailed implementation plans</strong> and begin coding, confident that components will integrate cleanly on the single\u2011box target environment.</p></li>\n</ul>\n<p>If you want, I can generate <strong>skeleton packages</strong> (directories, ABCs, Pydantic models, Typer CLI, Prefect flows, Makefile, pre\u2011commit, and sample tests) to serve as the starting point for implementation.</p>\n</section>\n</section>\n", "metatags": "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["explanations/251025_FAISS_whl_overview", "Updated cuVS Addendum", "N", "next"], ["explanations/index", "Explanations", "P", "previous"]], "sourcename": "explanations/251025_HighLevelArchitecture.md.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Implementation-Grade Architecture Overview</a><ul>\n<li><a class=\"reference internal\" href=\"#big-picture-endtoend-singlebox\">0) Big picture (end\u2011to\u2011end, single\u2011box)</a></li>\n<li><a class=\"reference internal\" href=\"#design-principles-concretized\">1) Design principles (concretized)</a></li>\n<li><a class=\"reference internal\" href=\"#repository-layout-monorepo-independently-ownable-packages\">2) Repository layout (monorepo; independently ownable packages)</a></li>\n<li><a class=\"reference internal\" href=\"#core-data-contracts-pydantic-v2-contentaddressed-ids\">3) Core data contracts (Pydantic v2; content\u2011addressed IDs)</a></li>\n<li><a class=\"reference internal\" href=\"#storage-layers-adapters-ports\">4) Storage layers &amp; adapters (ports)</a></li>\n<li><a class=\"reference internal\" href=\"#orchestration-prefect-2-x-all-local\">5) Orchestration (Prefect 2.x; all local)</a></li>\n<li><a class=\"reference internal\" href=\"#harvesters-pdf-download-pyalex-first-resilient-fallbacks\">6) Harvesters &amp; PDF download (PyAlex first; resilient fallbacks)</a></li>\n<li><a class=\"reference internal\" href=\"#pdf-doctags-docling-vlm-granitedocling\">7) PDF \u2192 <strong>DocTags</strong> (Docling VLM Granite\u2011Docling)</a></li>\n<li><a class=\"reference internal\" href=\"#chunking-docling-hybridchunker\">8) Chunking (Docling <strong>HybridChunker</strong>)</a></li>\n<li><a class=\"reference internal\" href=\"#dense-embeddings-qwen3embedding4b-2560dim-vllm\">9) Dense embeddings (Qwen3\u2011Embedding\u20114B &#64; <strong>2560\u2011dim</strong>, vLLM)</a></li>\n<li><a class=\"reference internal\" href=\"#sparse-embeddings-indices-spladev3-gpu-bm25\">10) Sparse embeddings &amp; indices (SPLADE\u2011v3 <strong>GPU</strong> + BM25)</a></li>\n<li><a class=\"reference internal\" href=\"#faiss-gpu-with-cuvs-cuda-13\">11) FAISS (GPU with <strong>cuVS</strong>), CUDA 13</a></li>\n<li><a class=\"reference internal\" href=\"#ontology-ingestion-concept-encoders\">12) Ontology ingestion &amp; concept encoders</a></li>\n<li><a class=\"reference internal\" href=\"#linker-chunkconcept-calibrated\">13) Linker (chunk\u2192concept), calibrated</a></li>\n<li><a class=\"reference internal\" href=\"#knowledge-graph-neo4j-local\">14) Knowledge Graph (Neo4j, local)</a></li>\n<li><a class=\"reference internal\" href=\"#hybrid-search-api-fastapi-local\">15) Hybrid search API (FastAPI, local)</a></li>\n<li><a class=\"reference internal\" href=\"#configuration-yaml-singlebox-defaults\">16) Configuration (YAML; single\u2011box defaults)</a></li>\n<li><a class=\"reference internal\" href=\"#duckdb-1-4-1-schema-views-full-fidelity\">17) DuckDB (\u2265\u202f1.4.1) schema &amp; views (full fidelity)</a></li>\n<li><a class=\"reference internal\" href=\"#vllm-nginx-single-logical-endpoint\">18) vLLM &amp; Nginx (single logical endpoint)</a></li>\n<li><a class=\"reference internal\" href=\"#implementation-skeletons-selected\">19) Implementation skeletons (selected)</a><ul>\n<li><a class=\"reference internal\" href=\"#downloader-pyalex-fallbacks\">19.1 Downloader (PyAlex + fallbacks)</a></li>\n<li><a class=\"reference internal\" href=\"#doctags-conversion\">19.2 DocTags conversion</a></li>\n<li><a class=\"reference internal\" href=\"#chunking\">19.3 Chunking</a></li>\n<li><a class=\"reference internal\" href=\"#dense-embeddings-qwen3-2560d-via-vllm\">19.4 Dense embeddings (Qwen3 2560\u2011d via vLLM)</a></li>\n<li><a class=\"reference internal\" href=\"#spladev3-encoder-gpu\">19.5 SPLADE\u2011v3 encoder (GPU)</a></li>\n<li><a class=\"reference internal\" href=\"#faiss-index-gpu-cuvs\">19.6 FAISS index (GPU + cuVS)</a></li>\n<li><a class=\"reference internal\" href=\"#hybrid-retrieval-rerank-search-api\">19.7 Hybrid retrieval &amp; rerank (search_api)</a></li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#quality-gates-evaluation-ci\">20) Quality gates, evaluation &amp; CI</a></li>\n<li><a class=\"reference internal\" href=\"#security-licensing-governance-local\">21) Security, licensing, governance (local)</a></li>\n<li><a class=\"reference internal\" href=\"#capacity-sizing-with-2560dim\">22) Capacity &amp; sizing with <strong>2560\u2011dim</strong></a></li>\n<li><a class=\"reference internal\" href=\"#operational-runbooks\">23) Operational runbooks</a></li>\n<li><a class=\"reference internal\" href=\"#workstreams-implementation-plans-deliverables\">24) Workstreams (implementation plans &amp; deliverables)</a></li>\n<li><a class=\"reference internal\" href=\"#coding-standards-bestinclass-python-practices\">25) Coding standards &amp; best\u2011in\u2011class Python practices</a></li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#addendum-additional-architecture-information\">Addendum - additional architecture information</a><ul>\n<li><a class=\"reference internal\" href=\"#part-a-gap-analysis-whats-unspecified-resolutions-in-addendum\">PART A \u2014 GAP ANALYSIS (WHAT\u2019S UNSPECIFIED) \u2192 RESOLUTIONS IN ADDENDUM</a></li>\n<li><a class=\"reference internal\" href=\"#part-b-exhaustive-specifications-resolutions\">PART B \u2014 EXHAUSTIVE SPECIFICATIONS (RESOLUTIONS)</a><ul>\n<li><a class=\"reference internal\" href=\"#b1-canonical-text-hashing-ids\">B1. Canonical text, hashing &amp; IDs</a></li>\n<li><a class=\"reference internal\" href=\"#b2-tokenizer-chunking-quantization\">B2. Tokenizer &amp; chunking quantization</a></li>\n<li><a class=\"reference internal\" href=\"#b3-doctags-selection-ocr-fallback\">B3. DocTags selection &amp; OCR fallback</a></li>\n<li><a class=\"reference internal\" href=\"#b4-harvester-downloader-pyalex-first-with-fallbacks\">B4. Harvester &amp; downloader (PyAlex first, with fallbacks)</a></li>\n<li><a class=\"reference internal\" href=\"#b5-dense-embeddings-qwen3-2560d\">B5. Dense embeddings (Qwen3 2560\u2011d)</a></li>\n<li><a class=\"reference internal\" href=\"#b6-sparse-spladev3-gpu-bm25-details\">B6. Sparse (SPLADE\u2011v3 GPU) &amp; BM25 details</a></li>\n<li><a class=\"reference internal\" href=\"#b7-parquet-datasets-all-embeddings-and-chunks\">B7. Parquet datasets (ALL embeddings and chunks)</a></li>\n<li><a class=\"reference internal\" href=\"#b8-duckdb-registry-1-4-1-migrations-guards\">B8. DuckDB registry (\u2265\u202f1.4.1): migrations &amp; guards</a></li>\n<li><a class=\"reference internal\" href=\"#b9-faiss-gpu-cuvs-cuda-13\">B9. FAISS GPU + cuVS (CUDA 13)</a></li>\n<li><a class=\"reference internal\" href=\"#b10-vllm-servers-router\">B10. vLLM servers &amp; router</a></li>\n<li><a class=\"reference internal\" href=\"#b11-ontology-ingestion-catalog\">B11. Ontology ingestion &amp; catalog</a></li>\n<li><a class=\"reference internal\" href=\"#b12-linker-calibration-decision-policy\">B12. Linker calibration &amp; decision policy</a></li>\n<li><a class=\"reference internal\" href=\"#b13-hybrid-retrieval-fusion-fixed-math\">B13. Hybrid retrieval fusion (fixed math)</a></li>\n<li><a class=\"reference internal\" href=\"#b14-search-api-openapi-3-1-final\">B14. Search API \u2014 <strong>OpenAPI 3.1</strong> (final)</a></li>\n<li><a class=\"reference internal\" href=\"#b15-endtoend-stage-testing\">B15. End\u2011to\u2011end &amp; stage testing</a></li>\n<li><a class=\"reference internal\" href=\"#b16-observability-diagnostics\">B16. Observability &amp; diagnostics</a></li>\n<li><a class=\"reference internal\" href=\"#b17-failure-handling-resilience\">B17. Failure handling &amp; resilience</a></li>\n<li><a class=\"reference internal\" href=\"#b18-security-licensing-config-secrets\">B18. Security, licensing, config secrets</a></li>\n<li><a class=\"reference internal\" href=\"#b19-code-quality-governance\">B19. Code quality &amp; governance</a></li>\n<li><a class=\"reference internal\" href=\"#b20-bootstrap-devex\">B20. Bootstrap &amp; DevEx</a></li>\n<li><a class=\"reference internal\" href=\"#b21-slas-slos-performance-budgets\">B21. SLAs/SLOs &amp; performance budgets</a></li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#part-c-interfaces-module-contracts-ready-for-coding\">PART C \u2014 INTERFACES &amp; MODULE CONTRACTS (READY FOR CODING)</a><ul>\n<li><a class=\"reference internal\" href=\"#c1-registry-duckdb-registry-api-py\">C1. Registry (DuckDB) \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">registry/api.py</span></code></a></li>\n<li><a class=\"reference internal\" href=\"#c2-downloader-download-harvester-py\">C2. Downloader \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">download/harvester.py</span></code></a></li>\n<li><a class=\"reference internal\" href=\"#c3-doctags-chunking-docling-vlm-py-docling-hybrid-py\">C3. DocTags &amp; chunking \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">docling/vlm.py</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">docling/hybrid.py</span></code></a></li>\n<li><a class=\"reference internal\" href=\"#c4-embeddings-embeddings-dense-qwen3-py-embeddings-sparse-splade-py-embeddings-sparse-bm25-py\">C4. Embeddings \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">embeddings_dense/qwen3.py</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">embeddings_sparse/splade.py</span></code>, <code class=\"docutils literal notranslate\"><span class=\"pre\">embeddings_sparse/bm25.py</span></code></a></li>\n<li><a class=\"reference internal\" href=\"#c5-vector-store-vectorstore-faiss-gpu-py\">C5. Vector store \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">vectorstore_faiss/gpu.py</span></code></a></li>\n<li><a class=\"reference internal\" href=\"#c6-ontology-catalog-ontology-loader-py\">C6. Ontology &amp; catalog \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">ontology/loader.py</span></code></a></li>\n<li><a class=\"reference internal\" href=\"#c7-linker-linking-linker-py\">C7. Linker \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">linking/linker.py</span></code></a></li>\n<li><a class=\"reference internal\" href=\"#c8-kg-builder-kg-builder-neo4j-py\">C8. KG builder \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">kg_builder/neo4j.py</span></code></a></li>\n<li><a class=\"reference internal\" href=\"#c9-search-api-search-api-app-py\">C9. Search API \u2014 <code class=\"docutils literal notranslate\"><span class=\"pre\">search_api/app.py</span></code></a></li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#part-d-orchestration-prefect-2-x\">PART D \u2014 ORCHESTRATION (PREFECT 2.x)</a><ul>\n<li><a class=\"reference internal\" href=\"#d1-flow-graph-idempotency-keys\">D1. Flow graph &amp; idempotency keys</a></li>\n<li><a class=\"reference internal\" href=\"#d2-concurrency-retries\">D2. Concurrency &amp; retries</a></li>\n<li><a class=\"reference internal\" href=\"#d3-cli-commands-invoke-via-typer\">D3. CLI commands (invoke via Typer)</a></li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#part-e-endtoend-acceptance-criteria-per-workstream\">PART E \u2014 END\u2011TO\u2011END ACCEPTANCE CRITERIA (PER WORKSTREAM)</a></li>\n<li><a class=\"reference internal\" href=\"#part-f-sample-openapi-excerpt\">PART F \u2014 SAMPLE OPENAPI (EXCERPT)</a></li>\n<li><a class=\"reference internal\" href=\"#part-g-implementation-checklists-by-workstream\">PART G \u2014 IMPLEMENTATION CHECKLISTS (BY WORKSTREAM)</a></li>\n<li><a class=\"reference internal\" href=\"#part-h-example-config-final-ready-to-commit\">PART H \u2014 EXAMPLE CONFIG (FINAL; READY TO COMMIT)</a></li>\n<li><a class=\"reference internal\" href=\"#part-i-what-happens-next\">PART I \u2014 WHAT HAPPENS NEXT</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".md", "has_maths_elements": false, "current_page_name": "explanations/251025_HighLevelArchitecture", "sidebars": ["sidebar-nav-bs.html"], "alabaster_version": "1.0.0", "alabaster_version_info": [1, 0, 0], "theme_show_toc_level": 1, "generate_toctree_html": "<functools._lru_cache_wrapper object at 0x79418bad3c10>", "generate_toc_html": "<functools._lru_cache_wrapper object at 0x79418bad3cc0>", "theme_version": "0.16.1", "theme_logo": {"image_relative": {}}}