{"parents": [{"link": "../../../", "title": "Module code"}], "title": "src.search_api.bm25_index", "body": "<h1>Source code for src.search_api.bm25_index</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"linenos\">  1</span><span class=\"sd\">&quot;&quot;&quot;Overview of bm25 index.</span>\n<span class=\"linenos\">  2</span>\n<span class=\"linenos\">  3</span><span class=\"sd\">This module bundles bm25 index logic for the kgfoundry stack. It groups related helpers so</span>\n<span class=\"linenos\">  4</span><span class=\"sd\">downstream packages can import a single cohesive namespace. Refer to the functions and classes below</span>\n<span class=\"linenos\">  5</span><span class=\"sd\">for implementation specifics.</span>\n<span class=\"linenos\">  6</span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"linenos\">  7</span>\n<span class=\"linenos\">  8</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">__future__</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">annotations</span>\n<span class=\"linenos\">  9</span>\n<span class=\"linenos\"> 10</span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">math</span>\n<span class=\"linenos\"> 11</span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">pickle</span>\n<span class=\"linenos\"> 12</span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">re</span>\n<span class=\"linenos\"> 13</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">collections.abc</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Iterable</span>\n<span class=\"linenos\"> 14</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">dataclasses</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">dataclass</span>\n<span class=\"linenos\"> 15</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">pathlib</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Path</span>\n<span class=\"linenos\"> 16</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Final</span>\n<span class=\"linenos\"> 17</span>\n<span class=\"linenos\"> 18</span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">duckdb</span>\n<span class=\"linenos\"> 19</span>\n<span class=\"linenos\"> 20</span><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">kgfoundry_common.navmap_types</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">NavMap</span>\n<span class=\"linenos\"> 21</span>\n<span class=\"linenos\"> 22</span><span class=\"n\">__all__</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s2\">&quot;BM25Doc&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;BM25Index&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;toks&quot;</span><span class=\"p\">]</span>\n<span class=\"linenos\"> 23</span>\n<span class=\"linenos\"> 24</span><span class=\"n\">__navmap__</span><span class=\"p\">:</span> <span class=\"n\">Final</span><span class=\"p\">[</span><span class=\"n\">NavMap</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n<span class=\"linenos\"> 25</span>    <span class=\"s2\">&quot;title&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;search_api.bm25_index&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 26</span>    <span class=\"s2\">&quot;synopsis&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Toy BM25 index backed by DuckDB parquet exports.&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 27</span>    <span class=\"s2\">&quot;exports&quot;</span><span class=\"p\">:</span> <span class=\"n\">__all__</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 28</span>    <span class=\"s2\">&quot;sections&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n<span class=\"linenos\"> 29</span>        <span class=\"p\">{</span>\n<span class=\"linenos\"> 30</span>            <span class=\"s2\">&quot;id&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;public-api&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 31</span>            <span class=\"s2\">&quot;title&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;Public API&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 32</span>            <span class=\"s2\">&quot;symbols&quot;</span><span class=\"p\">:</span> <span class=\"n\">__all__</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 33</span>        <span class=\"p\">},</span>\n<span class=\"linenos\"> 34</span>    <span class=\"p\">],</span>\n<span class=\"linenos\"> 35</span>    <span class=\"s2\">&quot;module_meta&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n<span class=\"linenos\"> 36</span>        <span class=\"s2\">&quot;owner&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;@search-api&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 37</span>        <span class=\"s2\">&quot;stability&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;experimental&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 38</span>        <span class=\"s2\">&quot;since&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;0.2.0&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 39</span>    <span class=\"p\">},</span>\n<span class=\"linenos\"> 40</span>    <span class=\"s2\">&quot;symbols&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n<span class=\"linenos\"> 41</span>        <span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n<span class=\"linenos\"> 42</span>            <span class=\"s2\">&quot;owner&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;@search-api&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 43</span>            <span class=\"s2\">&quot;stability&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;experimental&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 44</span>            <span class=\"s2\">&quot;since&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;0.2.0&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\"> 45</span>        <span class=\"p\">}</span>\n<span class=\"linenos\"> 46</span>        <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">__all__</span>\n<span class=\"linenos\"> 47</span>    <span class=\"p\">},</span>\n<span class=\"linenos\"> 48</span><span class=\"p\">}</span>\n<span class=\"linenos\"> 49</span>\n<span class=\"linenos\"> 50</span><span class=\"n\">TOKEN_RE</span> <span class=\"o\">=</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;[A-Za-z0-9]+&quot;</span><span class=\"p\">)</span>\n<span class=\"linenos\"> 51</span>\n<span class=\"linenos\"> 52</span>\n<span class=\"linenos\"> 53</span><span class=\"c1\"># [nav:anchor toks]</span>\n<div class=\"viewcode-block\" id=\"toks\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.toks\">[docs]</a>\n<span class=\"linenos\"> 54</span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">toks</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]:</span>\n<span class=\"linenos\"> 55</span><span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Compute toks.</span>\n<span class=\"linenos\"> 56</span>\n<span class=\"linenos\"> 57</span><span class=\"sd\">    Carry out the toks operation for the surrounding component. Generated documentation highlights how this helper collaborates with neighbouring utilities. Callers rely on the routine to remain stable across releases.</span>\n<span class=\"linenos\"> 58</span><span class=\"sd\">    </span>\n<span class=\"linenos\"> 59</span><span class=\"sd\">    Parameters</span>\n<span class=\"linenos\"> 60</span><span class=\"sd\">    ----------</span>\n<span class=\"linenos\"> 61</span><span class=\"sd\">    text : str</span>\n<span class=\"linenos\"> 62</span><span class=\"sd\">        Description for ``text``.</span>\n<span class=\"linenos\"> 63</span><span class=\"sd\">    </span>\n<span class=\"linenos\"> 64</span><span class=\"sd\">    Returns</span>\n<span class=\"linenos\"> 65</span><span class=\"sd\">    -------</span>\n<span class=\"linenos\"> 66</span><span class=\"sd\">    List[str]</span>\n<span class=\"linenos\"> 67</span><span class=\"sd\">        Description of return value.</span>\n<span class=\"linenos\"> 68</span><span class=\"sd\">    </span>\n<span class=\"linenos\"> 69</span><span class=\"sd\">    Examples</span>\n<span class=\"linenos\"> 70</span><span class=\"sd\">    --------</span>\n<span class=\"linenos\"> 71</span><span class=\"sd\">    &gt;&gt;&gt; from search_api.bm25_index import toks</span>\n<span class=\"linenos\"> 72</span><span class=\"sd\">    &gt;&gt;&gt; result = toks(...)</span>\n<span class=\"linenos\"> 73</span><span class=\"sd\">    &gt;&gt;&gt; result  # doctest: +ELLIPSIS</span>\n<span class=\"linenos\"> 74</span><span class=\"sd\">    ...</span>\n<span class=\"linenos\"> 75</span><span class=\"sd\">    &quot;&quot;&quot;</span>\n<span class=\"linenos\"> 76</span>    \n<span class=\"linenos\"> 77</span>    <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"n\">token</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">()</span> <span class=\"k\">for</span> <span class=\"n\">token</span> <span class=\"ow\">in</span> <span class=\"n\">TOKEN_RE</span><span class=\"o\">.</span><span class=\"n\">findall</span><span class=\"p\">(</span><span class=\"n\">text</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">)]</span></div>\n\n<span class=\"linenos\"> 78</span>\n<span class=\"linenos\"> 79</span>\n<span class=\"linenos\"> 80</span><span class=\"c1\"># [nav:anchor BM25Doc]</span>\n<span class=\"linenos\"> 81</span><span class=\"nd\">@dataclass</span>\n<div class=\"viewcode-block\" id=\"BM25Doc\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Doc\">[docs]</a>\n<span class=\"linenos\"> 82</span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">BM25Doc</span><span class=\"p\">:</span>\n<span class=\"linenos\"> 83</span><span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Model the BM25Doc.</span>\n<span class=\"linenos\"> 84</span>\n<span class=\"linenos\"> 85</span><span class=\"sd\">    Represent the bm25doc data structure used throughout the project. The class encapsulates</span>\n<span class=\"linenos\"> 86</span><span class=\"sd\">    behaviour behind a well-defined interface for collaborating components. Instances are typically</span>\n<span class=\"linenos\"> 87</span><span class=\"sd\">    created by factories or runtime orchestrators documented nearby.</span>\n<span class=\"linenos\"> 88</span><span class=\"sd\">    &quot;&quot;&quot;</span>\n<span class=\"linenos\"> 89</span>\n<div class=\"viewcode-block\" id=\"BM25Doc.chunk_id\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Doc.chunk_id\">[docs]</a>\n<span class=\"linenos\"> 90</span>    <span class=\"n\">chunk_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Doc.doc_id\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Doc.doc_id\">[docs]</a>\n<span class=\"linenos\"> 91</span>    <span class=\"n\">doc_id</span><span class=\"p\">:</span> <span class=\"nb\">str</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Doc.title\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Doc.title\">[docs]</a>\n<span class=\"linenos\"> 92</span>    <span class=\"n\">title</span><span class=\"p\">:</span> <span class=\"nb\">str</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Doc.section\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Doc.section\">[docs]</a>\n<span class=\"linenos\"> 93</span>    <span class=\"n\">section</span><span class=\"p\">:</span> <span class=\"nb\">str</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Doc.tf\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Doc.tf\">[docs]</a>\n<span class=\"linenos\"> 94</span>    <span class=\"n\">tf</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Doc.dl\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Doc.dl\">[docs]</a>\n<span class=\"linenos\"> 95</span>    <span class=\"n\">dl</span><span class=\"p\">:</span> <span class=\"nb\">float</span></div>\n</div>\n\n<span class=\"linenos\"> 96</span>\n<span class=\"linenos\"> 97</span>\n<span class=\"linenos\"> 98</span><span class=\"c1\"># [nav:anchor BM25Index]</span>\n<div class=\"viewcode-block\" id=\"BM25Index\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index\">[docs]</a>\n<span class=\"linenos\"> 99</span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">BM25Index</span><span class=\"p\">:</span>\n<span class=\"linenos\">100</span><span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Model the BM25Index.</span>\n<span class=\"linenos\">101</span>\n<span class=\"linenos\">102</span><span class=\"sd\">    Represent the bm25index data structure used throughout the project. The class encapsulates</span>\n<span class=\"linenos\">103</span><span class=\"sd\">    behaviour behind a well-defined interface for collaborating components. Instances are typically</span>\n<span class=\"linenos\">104</span><span class=\"sd\">    created by factories or runtime orchestrators documented nearby.</span>\n<span class=\"linenos\">105</span><span class=\"sd\">    &quot;&quot;&quot;</span>\n<span class=\"linenos\">106</span>\n<span class=\"linenos\">107</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">k1</span><span class=\"p\">:</span> <span class=\"nb\">float</span> <span class=\"o\">=</span> <span class=\"mf\">0.9</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"nb\">float</span> <span class=\"o\">=</span> <span class=\"mf\">0.4</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<span class=\"linenos\">108</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Compute init.</span>\n<span class=\"linenos\">109</span>\n<span class=\"linenos\">110</span><span class=\"sd\">        Initialise a new instance with validated parameters. The constructor prepares internal state and coordinates any setup required by the class. Subclasses should call ``super().__init__`` to keep validation and defaults intact.</span>\n<span class=\"linenos\">111</span>\n<span class=\"linenos\">112</span><span class=\"sd\">        Parameters</span>\n<span class=\"linenos\">113</span><span class=\"sd\">        ----------</span>\n<span class=\"linenos\">114</span><span class=\"sd\">        k1 : float | None</span>\n<span class=\"linenos\">115</span><span class=\"sd\">            Optional parameter default ``0.9``. Description for ``k1``.</span>\n<span class=\"linenos\">116</span><span class=\"sd\">        b : float | None</span>\n<span class=\"linenos\">117</span><span class=\"sd\">            Optional parameter default ``0.4``. Description for ``b``.</span>\n<span class=\"linenos\">118</span><span class=\"sd\">        &quot;&quot;&quot;</span>\n<span class=\"linenos\">119</span>        \n<div class=\"viewcode-block\" id=\"BM25Index.k1\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.k1\">[docs]</a>\n<span class=\"linenos\">120</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">k1</span> <span class=\"o\">=</span> <span class=\"n\">k1</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Index.b\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.b\">[docs]</a>\n<span class=\"linenos\">121</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">b</span> <span class=\"o\">=</span> <span class=\"n\">b</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Index.docs\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.docs\">[docs]</a>\n<span class=\"linenos\">122</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">docs</span><span class=\"p\">:</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"n\">BM25Doc</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">[]</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Index.df\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.df\">[docs]</a>\n<span class=\"linenos\">123</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">df</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">{}</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Index.N\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.N\">[docs]</a>\n<span class=\"linenos\">124</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span> <span class=\"o\">=</span> <span class=\"mi\">0</span></div>\n\n<div class=\"viewcode-block\" id=\"BM25Index.avgdl\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.avgdl\">[docs]</a>\n<span class=\"linenos\">125</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">avgdl</span> <span class=\"o\">=</span> <span class=\"mf\">0.0</span></div>\n\n<span class=\"linenos\">126</span>\n<span class=\"linenos\">127</span>    <span class=\"nd\">@classmethod</span>\n<div class=\"viewcode-block\" id=\"BM25Index.build_from_duckdb\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.build_from_duckdb\">[docs]</a>\n<span class=\"linenos\">128</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">build_from_duckdb</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">db_path</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">BM25Index</span><span class=\"p\">:</span>\n<span class=\"linenos\">129</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Compute build from duckdb.</span>\n<span class=\"linenos\">130</span>\n<span class=\"linenos\">131</span><span class=\"sd\">        Carry out the build from duckdb operation for the surrounding component. Generated documentation highlights how this helper collaborates with neighbouring utilities. Callers rely on the routine to remain stable across releases.</span>\n<span class=\"linenos\">132</span><span class=\"sd\">        </span>\n<span class=\"linenos\">133</span><span class=\"sd\">        Parameters</span>\n<span class=\"linenos\">134</span><span class=\"sd\">        ----------</span>\n<span class=\"linenos\">135</span><span class=\"sd\">        db_path : str</span>\n<span class=\"linenos\">136</span><span class=\"sd\">            Description for ``db_path``.</span>\n<span class=\"linenos\">137</span><span class=\"sd\">        </span>\n<span class=\"linenos\">138</span><span class=\"sd\">        Returns</span>\n<span class=\"linenos\">139</span><span class=\"sd\">        -------</span>\n<span class=\"linenos\">140</span><span class=\"sd\">        BM25Index</span>\n<span class=\"linenos\">141</span><span class=\"sd\">            Description of return value.</span>\n<span class=\"linenos\">142</span><span class=\"sd\">        </span>\n<span class=\"linenos\">143</span><span class=\"sd\">        Examples</span>\n<span class=\"linenos\">144</span><span class=\"sd\">        --------</span>\n<span class=\"linenos\">145</span><span class=\"sd\">        &gt;&gt;&gt; from search_api.bm25_index import build_from_duckdb</span>\n<span class=\"linenos\">146</span><span class=\"sd\">        &gt;&gt;&gt; result = build_from_duckdb(...)</span>\n<span class=\"linenos\">147</span><span class=\"sd\">        &gt;&gt;&gt; result  # doctest: +ELLIPSIS</span>\n<span class=\"linenos\">148</span><span class=\"sd\">        ...</span>\n<span class=\"linenos\">149</span><span class=\"sd\">        &quot;&quot;&quot;</span>\n<span class=\"linenos\">150</span>        \n<span class=\"linenos\">151</span>        <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"p\">()</span>\n<span class=\"linenos\">152</span>        <span class=\"n\">con</span> <span class=\"o\">=</span> <span class=\"n\">duckdb</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">db_path</span><span class=\"p\">)</span>\n<span class=\"linenos\">153</span>        <span class=\"k\">try</span><span class=\"p\">:</span>\n<span class=\"linenos\">154</span>            <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">con</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"linenos\">155</span>                <span class=\"s2\">&quot;SELECT parquet_root FROM datasets &quot;</span>\n<span class=\"linenos\">156</span>                <span class=\"s2\">&quot;WHERE kind=&#39;chunks&#39; ORDER BY created_at DESC LIMIT 1&quot;</span>\n<span class=\"linenos\">157</span>            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">fetchone</span><span class=\"p\">()</span>\n<span class=\"linenos\">158</span>            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">dataset</span><span class=\"p\">:</span>\n<span class=\"linenos\">159</span>                <span class=\"k\">return</span> <span class=\"n\">index</span>\n<span class=\"linenos\">160</span>            <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n<span class=\"linenos\">161</span>            <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"n\">con</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"linenos\">162</span>                <span class=\"sa\">f</span><span class=\"s2\">&quot;&quot;&quot;</span>\n<span class=\"linenos\">163</span><span class=\"s2\">                SELECT c.chunk_id, c.doc_id, coalesce(c.section,&#39;&#39;), c.text, coalesce(d.title,&#39;&#39;)</span>\n<span class=\"linenos\">164</span><span class=\"s2\">                FROM read_parquet(&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s2\">/*/*.parquet&#39;, union_by_name=true) AS c</span>\n<span class=\"linenos\">165</span><span class=\"s2\">                LEFT JOIN documents d ON c.doc_id = d.doc_id</span>\n<span class=\"linenos\">166</span><span class=\"s2\">            &quot;&quot;&quot;</span>\n<span class=\"linenos\">167</span>            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">()</span>\n<span class=\"linenos\">168</span>        <span class=\"k\">finally</span><span class=\"p\">:</span>\n<span class=\"linenos\">169</span>            <span class=\"n\">con</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n<span class=\"linenos\">170</span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">_build</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">)</span>\n<span class=\"linenos\">171</span>        <span class=\"k\">return</span> <span class=\"n\">index</span></div>\n\n<span class=\"linenos\">172</span>\n<div class=\"viewcode-block\" id=\"BM25Index._build\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index._build\">[docs]</a>\n<span class=\"linenos\">173</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">_build</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">rows</span><span class=\"p\">:</span> <span class=\"n\">Iterable</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">]])</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<span class=\"linenos\">174</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Compute build.</span>\n<span class=\"linenos\">175</span>\n<span class=\"linenos\">176</span><span class=\"sd\">        Carry out the build operation.</span>\n<span class=\"linenos\">177</span>\n<span class=\"linenos\">178</span><span class=\"sd\">        Parameters</span>\n<span class=\"linenos\">179</span><span class=\"sd\">        ----------</span>\n<span class=\"linenos\">180</span><span class=\"sd\">        rows : Iterable[Tuple[str, str, str, str, str]]</span>\n<span class=\"linenos\">181</span><span class=\"sd\">            Description for ``rows``.</span>\n<span class=\"linenos\">182</span><span class=\"sd\">        &quot;&quot;&quot;</span>\n<span class=\"linenos\">183</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">docs</span><span class=\"o\">.</span><span class=\"n\">clear</span><span class=\"p\">()</span>\n<span class=\"linenos\">184</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">df</span><span class=\"o\">.</span><span class=\"n\">clear</span><span class=\"p\">()</span>\n<span class=\"linenos\">185</span>        <span class=\"n\">dl_sum</span> <span class=\"o\">=</span> <span class=\"mf\">0.0</span>\n<span class=\"linenos\">186</span>        <span class=\"k\">for</span> <span class=\"n\">chunk_id</span><span class=\"p\">,</span> <span class=\"n\">doc_id</span><span class=\"p\">,</span> <span class=\"n\">section</span><span class=\"p\">,</span> <span class=\"n\">body</span><span class=\"p\">,</span> <span class=\"n\">title</span> <span class=\"ow\">in</span> <span class=\"n\">rows</span><span class=\"p\">:</span>\n<span class=\"linenos\">187</span>            <span class=\"n\">tf</span><span class=\"p\">:</span> <span class=\"nb\">dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n<span class=\"linenos\">188</span>            <span class=\"k\">for</span> <span class=\"n\">term</span> <span class=\"ow\">in</span> <span class=\"n\">toks</span><span class=\"p\">(</span><span class=\"n\">body</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n<span class=\"linenos\">189</span>                <span class=\"n\">tf</span><span class=\"p\">[</span><span class=\"n\">term</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">tf</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">term</span><span class=\"p\">,</span> <span class=\"mf\">0.0</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"mf\">1.0</span>\n<span class=\"linenos\">190</span>            <span class=\"k\">for</span> <span class=\"n\">term</span> <span class=\"ow\">in</span> <span class=\"n\">toks</span><span class=\"p\">(</span><span class=\"n\">title</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n<span class=\"linenos\">191</span>                <span class=\"n\">tf</span><span class=\"p\">[</span><span class=\"n\">term</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">tf</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">term</span><span class=\"p\">,</span> <span class=\"mf\">0.0</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"mf\">2.0</span>\n<span class=\"linenos\">192</span>            <span class=\"k\">for</span> <span class=\"n\">term</span> <span class=\"ow\">in</span> <span class=\"n\">toks</span><span class=\"p\">(</span><span class=\"n\">section</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n<span class=\"linenos\">193</span>                <span class=\"n\">tf</span><span class=\"p\">[</span><span class=\"n\">term</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">tf</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">term</span><span class=\"p\">,</span> <span class=\"mf\">0.0</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"mf\">1.2</span>\n<span class=\"linenos\">194</span>            <span class=\"n\">dl</span> <span class=\"o\">=</span> <span class=\"nb\">sum</span><span class=\"p\">(</span><span class=\"n\">tf</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">())</span>\n<span class=\"linenos\">195</span>            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">docs</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n<span class=\"linenos\">196</span>                <span class=\"n\">BM25Doc</span><span class=\"p\">(</span>\n<span class=\"linenos\">197</span>                    <span class=\"n\">chunk_id</span><span class=\"o\">=</span><span class=\"n\">chunk_id</span><span class=\"p\">,</span>\n<span class=\"linenos\">198</span>                    <span class=\"n\">doc_id</span><span class=\"o\">=</span><span class=\"n\">doc_id</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;urn:doc:fixture&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\">199</span>                    <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"n\">title</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;Fixture&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\">200</span>                    <span class=\"n\">section</span><span class=\"o\">=</span><span class=\"n\">section</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n<span class=\"linenos\">201</span>                    <span class=\"n\">tf</span><span class=\"o\">=</span><span class=\"n\">tf</span><span class=\"p\">,</span>\n<span class=\"linenos\">202</span>                    <span class=\"n\">dl</span><span class=\"o\">=</span><span class=\"n\">dl</span><span class=\"p\">,</span>\n<span class=\"linenos\">203</span>                <span class=\"p\">)</span>\n<span class=\"linenos\">204</span>            <span class=\"p\">)</span>\n<span class=\"linenos\">205</span>            <span class=\"n\">dl_sum</span> <span class=\"o\">+=</span> <span class=\"n\">dl</span>\n<span class=\"linenos\">206</span>            <span class=\"k\">for</span> <span class=\"n\">term</span> <span class=\"ow\">in</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">tf</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">()):</span>\n<span class=\"linenos\">207</span>                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">df</span><span class=\"p\">[</span><span class=\"n\">term</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">df</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">term</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n<span class=\"linenos\">208</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">docs</span><span class=\"p\">)</span>\n<span class=\"linenos\">209</span>        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">avgdl</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">dl_sum</span> <span class=\"o\">/</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span> <span class=\"k\">else</span> <span class=\"mf\">0.0</span></div>\n\n<span class=\"linenos\">210</span>\n<span class=\"linenos\">211</span>    <span class=\"nd\">@classmethod</span>\n<div class=\"viewcode-block\" id=\"BM25Index.from_parquet\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.from_parquet\">[docs]</a>\n<span class=\"linenos\">212</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">from_parquet</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"n\">k1</span><span class=\"p\">:</span> <span class=\"nb\">float</span> <span class=\"o\">=</span> <span class=\"mf\">0.9</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"nb\">float</span> <span class=\"o\">=</span> <span class=\"mf\">0.4</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">BM25Index</span><span class=\"p\">:</span>\n<span class=\"linenos\">213</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Instantiate an index from a parquet dataset without DuckDB metadata.&quot;&quot;&quot;</span>\n<span class=\"linenos\">214</span>        <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"p\">(</span><span class=\"n\">k1</span><span class=\"o\">=</span><span class=\"n\">k1</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">b</span><span class=\"p\">)</span>\n<span class=\"linenos\">215</span>        <span class=\"n\">con</span> <span class=\"o\">=</span> <span class=\"n\">duckdb</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">database</span><span class=\"o\">=</span><span class=\"s2\">&quot;:memory:&quot;</span><span class=\"p\">)</span>\n<span class=\"linenos\">216</span>        <span class=\"k\">try</span><span class=\"p\">:</span>\n<span class=\"linenos\">217</span>            <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"n\">con</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"linenos\">218</span>                <span class=\"sa\">f</span><span class=\"s2\">&quot;&quot;&quot;</span>\n<span class=\"linenos\">219</span><span class=\"s2\">                SELECT chunk_id,</span>\n<span class=\"linenos\">220</span><span class=\"s2\">                       coalesce(doc_id, chunk_id) AS doc_id,</span>\n<span class=\"linenos\">221</span><span class=\"s2\">                       coalesce(section,&#39;&#39;) AS section,</span>\n<span class=\"linenos\">222</span><span class=\"s2\">                       text,</span>\n<span class=\"linenos\">223</span><span class=\"s2\">                       &#39;&#39; AS title</span>\n<span class=\"linenos\">224</span><span class=\"s2\">                FROM read_parquet(&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s2\">&#39;, union_by_name=true)</span>\n<span class=\"linenos\">225</span><span class=\"s2\">            &quot;&quot;&quot;</span>\n<span class=\"linenos\">226</span>            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">()</span>\n<span class=\"linenos\">227</span>        <span class=\"k\">finally</span><span class=\"p\">:</span>\n<span class=\"linenos\">228</span>            <span class=\"n\">con</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n<span class=\"linenos\">229</span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">_build</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">)</span>\n<span class=\"linenos\">230</span>        <span class=\"k\">return</span> <span class=\"n\">index</span></div>\n\n<span class=\"linenos\">231</span>\n<div class=\"viewcode-block\" id=\"BM25Index.save\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.save\">[docs]</a>\n<span class=\"linenos\">232</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n<span class=\"linenos\">233</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Compute save.</span>\n<span class=\"linenos\">234</span>\n<span class=\"linenos\">235</span><span class=\"sd\">        Carry out the save operation for the surrounding component. Generated documentation highlights how this helper collaborates with neighbouring utilities. Callers rely on the routine to remain stable across releases.</span>\n<span class=\"linenos\">236</span><span class=\"sd\">        </span>\n<span class=\"linenos\">237</span><span class=\"sd\">        Parameters</span>\n<span class=\"linenos\">238</span><span class=\"sd\">        ----------</span>\n<span class=\"linenos\">239</span><span class=\"sd\">        path : str</span>\n<span class=\"linenos\">240</span><span class=\"sd\">            Description for ``path``.</span>\n<span class=\"linenos\">241</span><span class=\"sd\">        </span>\n<span class=\"linenos\">242</span><span class=\"sd\">        Examples</span>\n<span class=\"linenos\">243</span><span class=\"sd\">        --------</span>\n<span class=\"linenos\">244</span><span class=\"sd\">        &gt;&gt;&gt; from search_api.bm25_index import save</span>\n<span class=\"linenos\">245</span><span class=\"sd\">        &gt;&gt;&gt; save(...)  # doctest: +ELLIPSIS</span>\n<span class=\"linenos\">246</span><span class=\"sd\">        &quot;&quot;&quot;</span>\n<span class=\"linenos\">247</span>        \n<span class=\"linenos\">248</span>        <span class=\"n\">Path</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"o\">.</span><span class=\"n\">mkdir</span><span class=\"p\">(</span><span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"linenos\">249</span>        <span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s2\">&quot;wb&quot;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">handle</span><span class=\"p\">:</span>\n<span class=\"linenos\">250</span>            <span class=\"n\">pickle</span><span class=\"o\">.</span><span class=\"n\">dump</span><span class=\"p\">(</span>\n<span class=\"linenos\">251</span>                <span class=\"p\">{</span>\n<span class=\"linenos\">252</span>                    <span class=\"s2\">&quot;k1&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">k1</span><span class=\"p\">,</span>\n<span class=\"linenos\">253</span>                    <span class=\"s2\">&quot;b&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">b</span><span class=\"p\">,</span>\n<span class=\"linenos\">254</span>                    <span class=\"s2\">&quot;N&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span><span class=\"p\">,</span>\n<span class=\"linenos\">255</span>                    <span class=\"s2\">&quot;avgdl&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">avgdl</span><span class=\"p\">,</span>\n<span class=\"linenos\">256</span>                    <span class=\"s2\">&quot;df&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">df</span><span class=\"p\">,</span>\n<span class=\"linenos\">257</span>                    <span class=\"s2\">&quot;docs&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">docs</span><span class=\"p\">,</span>\n<span class=\"linenos\">258</span>                <span class=\"p\">},</span>\n<span class=\"linenos\">259</span>                <span class=\"n\">handle</span><span class=\"p\">,</span>\n<span class=\"linenos\">260</span>            <span class=\"p\">)</span></div>\n\n<span class=\"linenos\">261</span>\n<span class=\"linenos\">262</span>    <span class=\"nd\">@classmethod</span>\n<div class=\"viewcode-block\" id=\"BM25Index.load\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.load\">[docs]</a>\n<span class=\"linenos\">263</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">load</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">BM25Index</span><span class=\"p\">:</span>\n<span class=\"linenos\">264</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Compute load.</span>\n<span class=\"linenos\">265</span>\n<span class=\"linenos\">266</span><span class=\"sd\">        Carry out the load operation for the surrounding component. Generated documentation highlights how this helper collaborates with neighbouring utilities. Callers rely on the routine to remain stable across releases.</span>\n<span class=\"linenos\">267</span><span class=\"sd\">        </span>\n<span class=\"linenos\">268</span><span class=\"sd\">        Parameters</span>\n<span class=\"linenos\">269</span><span class=\"sd\">        ----------</span>\n<span class=\"linenos\">270</span><span class=\"sd\">        path : str</span>\n<span class=\"linenos\">271</span><span class=\"sd\">            Description for ``path``.</span>\n<span class=\"linenos\">272</span><span class=\"sd\">        </span>\n<span class=\"linenos\">273</span><span class=\"sd\">        Returns</span>\n<span class=\"linenos\">274</span><span class=\"sd\">        -------</span>\n<span class=\"linenos\">275</span><span class=\"sd\">        BM25Index</span>\n<span class=\"linenos\">276</span><span class=\"sd\">            Description of return value.</span>\n<span class=\"linenos\">277</span><span class=\"sd\">        </span>\n<span class=\"linenos\">278</span><span class=\"sd\">        Examples</span>\n<span class=\"linenos\">279</span><span class=\"sd\">        --------</span>\n<span class=\"linenos\">280</span><span class=\"sd\">        &gt;&gt;&gt; from search_api.bm25_index import load</span>\n<span class=\"linenos\">281</span><span class=\"sd\">        &gt;&gt;&gt; result = load(...)</span>\n<span class=\"linenos\">282</span><span class=\"sd\">        &gt;&gt;&gt; result  # doctest: +ELLIPSIS</span>\n<span class=\"linenos\">283</span><span class=\"sd\">        ...</span>\n<span class=\"linenos\">284</span><span class=\"sd\">        &quot;&quot;&quot;</span>\n<span class=\"linenos\">285</span>        \n<span class=\"linenos\">286</span>        <span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s2\">&quot;rb&quot;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">handle</span><span class=\"p\">:</span>\n<span class=\"linenos\">287</span>            <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"n\">pickle</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">)</span>\n<span class=\"linenos\">288</span>        <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"p\">(</span><span class=\"n\">payload</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;k1&quot;</span><span class=\"p\">,</span> <span class=\"mf\">0.9</span><span class=\"p\">),</span> <span class=\"n\">payload</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;b&quot;</span><span class=\"p\">,</span> <span class=\"mf\">0.4</span><span class=\"p\">))</span>\n<span class=\"linenos\">289</span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">N</span> <span class=\"o\">=</span> <span class=\"n\">payload</span><span class=\"p\">[</span><span class=\"s2\">&quot;N&quot;</span><span class=\"p\">]</span>\n<span class=\"linenos\">290</span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">avgdl</span> <span class=\"o\">=</span> <span class=\"n\">payload</span><span class=\"p\">[</span><span class=\"s2\">&quot;avgdl&quot;</span><span class=\"p\">]</span>\n<span class=\"linenos\">291</span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">df</span> <span class=\"o\">=</span> <span class=\"n\">payload</span><span class=\"p\">[</span><span class=\"s2\">&quot;df&quot;</span><span class=\"p\">]</span>\n<span class=\"linenos\">292</span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">docs</span> <span class=\"o\">=</span> <span class=\"n\">payload</span><span class=\"p\">[</span><span class=\"s2\">&quot;docs&quot;</span><span class=\"p\">]</span>\n<span class=\"linenos\">293</span>        <span class=\"k\">return</span> <span class=\"n\">index</span></div>\n\n<span class=\"linenos\">294</span>\n<div class=\"viewcode-block\" id=\"BM25Index._idf\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index._idf\">[docs]</a>\n<span class=\"linenos\">295</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">_idf</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">term</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">float</span><span class=\"p\">:</span>\n<span class=\"linenos\">296</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Compute idf.</span>\n<span class=\"linenos\">297</span>\n<span class=\"linenos\">298</span><span class=\"sd\">        Carry out the idf operation.</span>\n<span class=\"linenos\">299</span>\n<span class=\"linenos\">300</span><span class=\"sd\">        Parameters</span>\n<span class=\"linenos\">301</span><span class=\"sd\">        ----------</span>\n<span class=\"linenos\">302</span><span class=\"sd\">        term : str</span>\n<span class=\"linenos\">303</span><span class=\"sd\">            Description for ``term``.</span>\n<span class=\"linenos\">304</span>\n<span class=\"linenos\">305</span><span class=\"sd\">        Returns</span>\n<span class=\"linenos\">306</span><span class=\"sd\">        -------</span>\n<span class=\"linenos\">307</span><span class=\"sd\">        float</span>\n<span class=\"linenos\">308</span><span class=\"sd\">            Description of return value.</span>\n<span class=\"linenos\">309</span><span class=\"sd\">        &quot;&quot;&quot;</span>\n<span class=\"linenos\">310</span>        <span class=\"n\">df</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">df</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">term</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"linenos\">311</span>        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span> <span class=\"o\">==</span> <span class=\"mi\">0</span> <span class=\"ow\">or</span> <span class=\"n\">df</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"linenos\">312</span>            <span class=\"k\">return</span> <span class=\"mf\">0.0</span>\n<span class=\"linenos\">313</span>        <span class=\"k\">return</span> <span class=\"n\">math</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"p\">((</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span> <span class=\"o\">-</span> <span class=\"n\">df</span> <span class=\"o\">+</span> <span class=\"mf\">0.5</span><span class=\"p\">)</span> <span class=\"o\">/</span> <span class=\"p\">(</span><span class=\"n\">df</span> <span class=\"o\">+</span> <span class=\"mf\">0.5</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"mf\">1.0</span><span class=\"p\">)</span></div>\n\n<span class=\"linenos\">314</span>\n<div class=\"viewcode-block\" id=\"BM25Index.search\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.search\">[docs]</a>\n<span class=\"linenos\">315</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">search</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"nb\">int</span> <span class=\"o\">=</span> <span class=\"mi\">10</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"nb\">float</span><span class=\"p\">]]:</span>\n<span class=\"linenos\">316</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Compute search.</span>\n<span class=\"linenos\">317</span>\n<span class=\"linenos\">318</span><span class=\"sd\">        Carry out the search operation for the surrounding component. Generated documentation highlights how this helper collaborates with neighbouring utilities. Callers rely on the routine to remain stable across releases.</span>\n<span class=\"linenos\">319</span><span class=\"sd\">        </span>\n<span class=\"linenos\">320</span><span class=\"sd\">        Parameters</span>\n<span class=\"linenos\">321</span><span class=\"sd\">        ----------</span>\n<span class=\"linenos\">322</span><span class=\"sd\">        query : str</span>\n<span class=\"linenos\">323</span><span class=\"sd\">            Description for ``query``.</span>\n<span class=\"linenos\">324</span><span class=\"sd\">        k : int | None</span>\n<span class=\"linenos\">325</span><span class=\"sd\">            Optional parameter default ``10``. Description for ``k``.</span>\n<span class=\"linenos\">326</span><span class=\"sd\">        </span>\n<span class=\"linenos\">327</span><span class=\"sd\">        Returns</span>\n<span class=\"linenos\">328</span><span class=\"sd\">        -------</span>\n<span class=\"linenos\">329</span><span class=\"sd\">        List[Tuple[str, float]]</span>\n<span class=\"linenos\">330</span><span class=\"sd\">            Description of return value.</span>\n<span class=\"linenos\">331</span><span class=\"sd\">        </span>\n<span class=\"linenos\">332</span><span class=\"sd\">        Examples</span>\n<span class=\"linenos\">333</span><span class=\"sd\">        --------</span>\n<span class=\"linenos\">334</span><span class=\"sd\">        &gt;&gt;&gt; from search_api.bm25_index import search</span>\n<span class=\"linenos\">335</span><span class=\"sd\">        &gt;&gt;&gt; result = search(...)</span>\n<span class=\"linenos\">336</span><span class=\"sd\">        &gt;&gt;&gt; result  # doctest: +ELLIPSIS</span>\n<span class=\"linenos\">337</span><span class=\"sd\">        ...</span>\n<span class=\"linenos\">338</span><span class=\"sd\">        &quot;&quot;&quot;</span>\n<span class=\"linenos\">339</span>        \n<span class=\"linenos\">340</span>        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"linenos\">341</span>            <span class=\"k\">return</span> <span class=\"p\">[]</span>\n<span class=\"linenos\">342</span>        <span class=\"n\">terms</span> <span class=\"o\">=</span> <span class=\"n\">toks</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n<span class=\"linenos\">343</span>        <span class=\"n\">scores</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"mf\">0.0</span><span class=\"p\">]</span> <span class=\"o\">*</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">N</span>\n<span class=\"linenos\">344</span>        <span class=\"k\">for</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">doc</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">docs</span><span class=\"p\">):</span>\n<span class=\"linenos\">345</span>            <span class=\"n\">score</span> <span class=\"o\">=</span> <span class=\"mf\">0.0</span>\n<span class=\"linenos\">346</span>            <span class=\"k\">for</span> <span class=\"n\">term</span> <span class=\"ow\">in</span> <span class=\"n\">terms</span><span class=\"p\">:</span>\n<span class=\"linenos\">347</span>                <span class=\"n\">tf</span> <span class=\"o\">=</span> <span class=\"n\">doc</span><span class=\"o\">.</span><span class=\"n\">tf</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">term</span><span class=\"p\">,</span> <span class=\"mf\">0.0</span><span class=\"p\">)</span>\n<span class=\"linenos\">348</span>                <span class=\"k\">if</span> <span class=\"n\">tf</span> <span class=\"o\">&lt;=</span> <span class=\"mf\">0.0</span><span class=\"p\">:</span>\n<span class=\"linenos\">349</span>                    <span class=\"k\">continue</span>\n<span class=\"linenos\">350</span>                <span class=\"n\">idf</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_idf</span><span class=\"p\">(</span><span class=\"n\">term</span><span class=\"p\">)</span>\n<span class=\"linenos\">351</span>                <span class=\"n\">denom</span> <span class=\"o\">=</span> <span class=\"n\">tf</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">k1</span> <span class=\"o\">*</span> <span class=\"p\">(</span><span class=\"mf\">1.0</span> <span class=\"o\">-</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">b</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">b</span> <span class=\"o\">*</span> <span class=\"p\">(</span><span class=\"n\">doc</span><span class=\"o\">.</span><span class=\"n\">dl</span> <span class=\"o\">/</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">avgdl</span> <span class=\"ow\">or</span> <span class=\"mf\">1.0</span><span class=\"p\">)))</span>\n<span class=\"linenos\">352</span>                <span class=\"n\">score</span> <span class=\"o\">+=</span> <span class=\"n\">idf</span> <span class=\"o\">*</span> <span class=\"p\">((</span><span class=\"n\">tf</span> <span class=\"o\">*</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">k1</span> <span class=\"o\">+</span> <span class=\"mf\">1.0</span><span class=\"p\">))</span> <span class=\"o\">/</span> <span class=\"n\">denom</span><span class=\"p\">)</span>\n<span class=\"linenos\">353</span>            <span class=\"n\">scores</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">score</span>\n<span class=\"linenos\">354</span>        <span class=\"n\">ranked</span> <span class=\"o\">=</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"n\">scores</span><span class=\"p\">),</span> <span class=\"n\">key</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">item</span><span class=\"p\">:</span> <span class=\"n\">item</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"n\">reverse</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"linenos\">355</span>        <span class=\"k\">return</span> <span class=\"p\">[(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">docs</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">chunk_id</span><span class=\"p\">,</span> <span class=\"n\">score</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">index</span><span class=\"p\">,</span> <span class=\"n\">score</span> <span class=\"ow\">in</span> <span class=\"n\">ranked</span><span class=\"p\">[:</span><span class=\"n\">k</span><span class=\"p\">]</span> <span class=\"k\">if</span> <span class=\"n\">score</span> <span class=\"o\">&gt;</span> <span class=\"mf\">0.0</span><span class=\"p\">]</span></div>\n\n<span class=\"linenos\">356</span>\n<div class=\"viewcode-block\" id=\"BM25Index.doc\">\n<a class=\"viewcode-back\" href=\"../../../../autoapi/src/search_api/bm25_index/#src.search_api.bm25_index.BM25Index.doc\">[docs]</a>\n<span class=\"linenos\">357</span>    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">doc</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">index</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">BM25Doc</span><span class=\"p\">:</span>\n<span class=\"linenos\">358</span><span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Compute doc.</span>\n<span class=\"linenos\">359</span>\n<span class=\"linenos\">360</span><span class=\"sd\">        Carry out the doc operation for the surrounding component. Generated documentation highlights how this helper collaborates with neighbouring utilities. Callers rely on the routine to remain stable across releases.</span>\n<span class=\"linenos\">361</span><span class=\"sd\">        </span>\n<span class=\"linenos\">362</span><span class=\"sd\">        Parameters</span>\n<span class=\"linenos\">363</span><span class=\"sd\">        ----------</span>\n<span class=\"linenos\">364</span><span class=\"sd\">        index : int</span>\n<span class=\"linenos\">365</span><span class=\"sd\">            Description for ``index``.</span>\n<span class=\"linenos\">366</span><span class=\"sd\">        </span>\n<span class=\"linenos\">367</span><span class=\"sd\">        Returns</span>\n<span class=\"linenos\">368</span><span class=\"sd\">        -------</span>\n<span class=\"linenos\">369</span><span class=\"sd\">        BM25Doc</span>\n<span class=\"linenos\">370</span><span class=\"sd\">            Description of return value.</span>\n<span class=\"linenos\">371</span><span class=\"sd\">        </span>\n<span class=\"linenos\">372</span><span class=\"sd\">        Examples</span>\n<span class=\"linenos\">373</span><span class=\"sd\">        --------</span>\n<span class=\"linenos\">374</span><span class=\"sd\">        &gt;&gt;&gt; from search_api.bm25_index import doc</span>\n<span class=\"linenos\">375</span><span class=\"sd\">        &gt;&gt;&gt; result = doc(...)</span>\n<span class=\"linenos\">376</span><span class=\"sd\">        &gt;&gt;&gt; result  # doctest: +ELLIPSIS</span>\n<span class=\"linenos\">377</span><span class=\"sd\">        ...</span>\n<span class=\"linenos\">378</span><span class=\"sd\">        &quot;&quot;&quot;</span>\n<span class=\"linenos\">379</span>        \n<span class=\"linenos\">380</span>        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">docs</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">]</span></div>\n</div>\n\n</pre></div>", "current_page_name": "_modules/src/search_api/bm25_index", "sidebars": ["sidebar-nav-bs.html"], "alabaster_version": "1.0.0", "alabaster_version_info": [1, 0, 0], "theme_show_toc_level": 1, "generate_toctree_html": "<functools._lru_cache_wrapper object at 0x7628d5732da0>", "generate_toc_html": "<functools._lru_cache_wrapper object at 0x7628d5733cc0>", "theme_version": "0.16.1", "theme_logo": {"image_relative": {}}}