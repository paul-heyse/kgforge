{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://kgfoundry/docs/_build/schema_agent_catalog.json",
  "title": "Agent Catalog",
  "type": "object",
  "required": [
    "version",
    "generated_at",
    "repo",
    "link_policy",
    "artifacts",
    "packages"
  ],
  "properties": {
    "version": {"type": "string"},
    "generated_at": {"type": "string", "format": "date-time"},
    "repo": {
      "type": "object",
      "required": ["sha"],
      "properties": {
        "sha": {"type": "string"},
        "root": {"type": "string"}
      },
      "additionalProperties": false
    },
    "link_policy": {
      "type": "object",
      "required": ["mode", "editor_template", "github_template"],
      "properties": {
        "mode": {"type": "string", "enum": ["editor", "github"]},
        "editor_template": {"type": "string"},
        "github_template": {"type": "string"},
        "github": {
          "type": "object",
          "required": ["org", "repo", "sha"],
          "properties": {
            "org": {"type": "string"},
            "repo": {"type": "string"},
            "sha": {"type": "string"}
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "artifacts": {
      "type": "object",
      "required": [
        "docfacts",
        "navmap",
        "by_module",
        "by_file",
        "symbols",
        "test_map",
        "test_map_coverage",
        "test_map_summary"
      ],
      "properties": {
        "docfacts": {"type": "string"},
        "navmap": {"type": "string"},
        "by_module": {"type": "string"},
        "by_file": {"type": "string"},
        "symbols": {"type": "string"},
        "test_map": {"type": "string"},
        "test_map_coverage": {"type": "string"},
        "test_map_summary": {"type": "string"}
      },
      "additionalProperties": false
    },
    "packages": {
      "type": "array",
      "items": {"$ref": "#/$defs/package"}
    },
    "shards": {
      "anyOf": [
        {"type": "null"},
        {
          "type": "object",
          "required": ["index", "packages"],
          "properties": {
            "index": {"type": "string"},
            "packages": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["name", "path", "modules"],
                "properties": {
                  "name": {"type": "string"},
                  "path": {"type": "string"},
                  "modules": {"type": "integer", "minimum": 0}
                },
                "additionalProperties": false
              }
            }
          },
          "additionalProperties": false
        }
      ]
    }
  },
  "$defs": {
    "package": {
      "type": "object",
      "required": ["name", "modules"],
      "properties": {
        "name": {"type": "string"},
        "modules": {
          "type": "array",
          "items": {"$ref": "#/$defs/module"}
        }
      },
      "additionalProperties": false
    },
    "module": {
      "type": "object",
      "required": ["name", "qualified", "source", "pages", "imports", "symbols", "graph"],
      "properties": {
        "name": {"type": "string"},
        "qualified": {"type": "string"},
        "source": {
          "type": "object",
          "required": ["path"],
          "properties": {
            "path": {"type": "string"}
          },
          "additionalProperties": false
        },
        "pages": {
          "type": "object",
          "required": ["html", "fjson"],
          "properties": {
            "html": {"type": ["string", "null"]},
            "fjson": {"type": ["string", "null"]}
          },
          "additionalProperties": false
        },
        "imports": {
          "type": "array",
          "items": {"type": "string"}
        },
        "symbols": {
          "type": "array",
          "items": {"$ref": "#/$defs/symbol"}
        },
        "graph": {
          "type": "object",
          "required": ["imports", "calls"],
          "properties": {
            "imports": {
              "type": "array",
              "items": {"type": "string"}
            },
            "calls": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["caller", "callee", "confidence"],
                "properties": {
                  "caller": {"type": "string"},
                  "callee": {"type": "string"},
                  "confidence": {"type": "string"}
                },
                "additionalProperties": false
              }
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "symbol": {
      "type": "object",
      "required": [
        "qname",
        "kind",
        "symbol_id",
        "docfacts",
        "anchors",
        "quality",
        "metrics",
        "agent_hints",
        "change_impact",
        "exemplars"
      ],
      "properties": {
        "qname": {"type": "string"},
        "kind": {"type": "string"},
        "symbol_id": {"type": "string"},
        "docfacts": {
          "type": ["object", "null"],
          "additionalProperties": true
        },
        "anchors": {"$ref": "#/$defs/anchors"},
        "quality": {"$ref": "#/$defs/quality"},
        "metrics": {"$ref": "#/$defs/metrics"},
        "agent_hints": {"$ref": "#/$defs/agent_hints"},
        "change_impact": {"$ref": "#/$defs/change_impact"},
        "exemplars": {
          "type": "array",
          "items": {"$ref": "#/$defs/exemplar"}
        }
      },
      "additionalProperties": false
    },
    "anchors": {
      "type": "object",
      "required": ["start_line", "end_line", "cst_fingerprint", "remap_order"],
      "properties": {
        "start_line": {"type": ["integer", "null"]},
        "end_line": {"type": ["integer", "null"]},
        "cst_fingerprint": {"type": ["string", "null"]},
        "remap_order": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["symbol_id", "cst_fingerprint", "name_arity", "nearest_text"],
            "properties": {
              "symbol_id": {"type": "string"},
              "cst_fingerprint": {"type": ["string", "null"]},
              "name_arity": {"type": "integer"},
              "nearest_text": {"type": ["string", "null"]}
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "quality": {
      "type": "object",
      "required": [
        "mypy_status",
        "ruff_rules",
        "pydoclint_parity",
        "docstring_coverage",
        "doctest_status"
      ],
      "properties": {
        "mypy_status": {"type": "string"},
        "ruff_rules": {
          "type": "array",
          "items": {"type": "string"}
        },
        "pydoclint_parity": {"type": ["boolean", "null"]},
        "docstring_coverage": {"type": ["number", "null"]},
        "doctest_status": {"type": "string"}
      },
      "additionalProperties": false
    },
    "metrics": {
      "type": "object",
      "required": [
        "complexity",
        "loc",
        "last_modified",
        "codeowners",
        "stability",
        "deprecated"
      ],
      "properties": {
        "complexity": {"type": ["number", "null"]},
        "loc": {"type": ["integer", "null"]},
        "last_modified": {"type": ["string", "null"], "format": "date-time"},
        "codeowners": {
          "type": "array",
          "items": {"type": "string"}
        },
        "stability": {"type": ["string", "null"]},
        "deprecated": {"type": "boolean"}
      },
      "additionalProperties": false
    },
    "agent_hints": {
      "type": "object",
      "required": [
        "intent_tags",
        "safe_ops",
        "tests_to_run",
        "perf_budgets",
        "breaking_change_notes"
      ],
      "properties": {
        "intent_tags": {
          "type": "array",
          "items": {"type": "string"}
        },
        "safe_ops": {
          "type": "array",
          "items": {"type": "string"}
        },
        "tests_to_run": {
          "type": "array",
          "items": {"type": "string"}
        },
        "perf_budgets": {
          "type": "array",
          "items": {"type": "string"}
        },
        "breaking_change_notes": {
          "type": "array",
          "items": {"type": "string"}
        }
      },
      "additionalProperties": false
    },
    "change_impact": {
      "type": "object",
      "required": ["callers", "callees", "tests", "codeowners", "churn_last_n"],
      "properties": {
        "callers": {
          "type": "array",
          "items": {"type": "string"}
        },
        "callees": {
          "type": "array",
          "items": {"type": "string"}
        },
        "tests": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["file"],
            "properties": {
              "file": {"type": "string"},
              "lines": {
                "type": "array",
                "items": {"type": "integer"}
              },
              "reason": {"type": ["string", "null"]},
              "windows": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["start", "end"],
                  "properties": {
                    "start": {"type": "integer"},
                    "end": {"type": "integer"}
                  },
                  "additionalProperties": false
                }
              }
            },
            "additionalProperties": false
          }
        },
        "codeowners": {
          "type": "array",
          "items": {"type": "string"}
        },
        "churn_last_n": {"type": "integer", "minimum": 0}
      },
      "additionalProperties": false
    },
    "exemplar": {
      "type": "object",
      "required": ["title", "language", "snippet"],
      "properties": {
        "title": {"type": "string"},
        "language": {"type": "string"},
        "snippet": {"type": "string"},
        "counter_example": {"type": ["boolean", "null"]},
        "negative_prompts": {
          "type": "array",
          "items": {"type": "string"}
        },
        "context_notes": {"type": ["string", "null"]}
      },
      "additionalProperties": false
    }
  }
}
