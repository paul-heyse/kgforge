
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Updated cuVS Addendum &#8212; kgfoundry  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'explanations/251025_FAISS_whl_overview';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Migration: Strict NumPy Docstring Compliance" href="numpy-docstring-migration.html" />
    <link rel="prev" title="Implementation-Grade Architecture Overview" href="251025_HighLevelArchitecture.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">kgfoundry  documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting-started.html">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to/index.html">
    How-to Guides
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../architecture/index.html">
    Architecture
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../reference/test-matrix.html">
    Test Matrix (symbol → tests)
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../reference/observability/metrics.html">
    Metrics (static scan)
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../reference/observability/logs.html">
    Log events (static scan)
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../reference/observability/traces.html">
    Traces (static scan)
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../reference/observability/config.html">
    Configuration surfaces (Pydantic Settings & env usage)
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../reference/schemas/index.html">
    Data Contract Schemas
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../reference/graphs/index.html">
    Package Graphs
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../policies/visibility-policy.html">
    NavMap Visibility Policy
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/docling/index.html">
    src.docling
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/download/index.html">
    src.download
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/embeddings_dense/index.html">
    src.embeddings_dense
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/embeddings_sparse/index.html">
    src.embeddings_sparse
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/kf_common/index.html">
    src.kf_common
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/kg_builder/index.html">
    src.kg_builder
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/kgfoundry/index.html">
    src.kgfoundry
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/kgfoundry_common/index.html">
    src.kgfoundry_common
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/linking/index.html">
    src.linking
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/observability/index.html">
    src.observability
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/ontology/index.html">
    src.ontology
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/orchestration/index.html">
    src.orchestration
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/registry/index.html">
    src.registry
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/search_api/index.html">
    src.search_api
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/search_client/index.html">
    src.search_client
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/src/vectorstore_faiss/index.html">
    src.vectorstore_faiss
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../gallery/index.html">
    Welcome to the kgfoundry examples gallery
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting-started.html">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to/index.html">
    How-to Guides
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../architecture/index.html">
    Architecture
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/test-matrix.html">
    Test Matrix (symbol → tests)
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/observability/metrics.html">
    Metrics (static scan)
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/observability/logs.html">
    Log events (static scan)
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/observability/traces.html">
    Traces (static scan)
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/observability/config.html">
    Configuration surfaces (Pydantic Settings & env usage)
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/schemas/index.html">
    Data Contract Schemas
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/graphs/index.html">
    Package Graphs
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../policies/visibility-policy.html">
    NavMap Visibility Policy
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/docling/index.html">
    src.docling
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/download/index.html">
    src.download
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/embeddings_dense/index.html">
    src.embeddings_dense
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/embeddings_sparse/index.html">
    src.embeddings_sparse
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/kf_common/index.html">
    src.kf_common
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/kg_builder/index.html">
    src.kg_builder
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/kgfoundry/index.html">
    src.kgfoundry
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/kgfoundry_common/index.html">
    src.kgfoundry_common
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/linking/index.html">
    src.linking
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/observability/index.html">
    src.observability
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/ontology/index.html">
    src.ontology
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/orchestration/index.html">
    src.orchestration
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/registry/index.html">
    src.registry
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/search_api/index.html">
    src.search_api
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/search_client/index.html">
    src.search_client
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/src/vectorstore_faiss/index.html">
    src.vectorstore_faiss
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../gallery/index.html">
    Welcome to the kgfoundry examples gallery
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="251025_HighLevelArchitecture.html">Implementation-Grade Architecture Overview</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">Updated cuVS Addendum</a></li>


<li class="toctree-l1"><a class="reference internal" href="numpy-docstring-migration.html">Migration: Strict NumPy Docstring Compliance</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Explanations</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Updated cuVS Addendum</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="updated-cuvs-addendum">
<h1>Updated cuVS Addendum<a class="headerlink" href="#updated-cuvs-addendum" title="Link to this heading">#</a></h1>
<p>Below is an <strong>updated, implementation‑grade addendum</strong> that reflects your <strong>new FAISS wheel</strong> with <strong>cuVS integration compiled for</strong>: <strong>Flat</strong>, <strong>IVF‑Flat</strong>, <strong>IVF‑PQ</strong>, <strong>Graph CAGRA</strong>, and <strong>Binary‑CAGRA</strong>, as indicated by the build artifacts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CuvsFlatIndex</span><span class="o">.</span><span class="n">cu</span><span class="o">.</span><span class="n">o</span>
<span class="n">CuvsIVFFlat</span><span class="o">.</span><span class="n">cu</span><span class="o">.</span><span class="n">o</span>
<span class="n">CuvsIVFPQ</span><span class="o">.</span><span class="n">cu</span><span class="o">.</span><span class="n">o</span>
<span class="n">CuvsCagra</span><span class="o">.</span><span class="n">cu</span><span class="o">.</span><span class="n">o</span>
<span class="n">BinaryCuvsCagra</span><span class="o">.</span><span class="n">cu</span><span class="o">.</span><span class="n">o</span>
<span class="n">utils</span><span class="o">/</span><span class="n">CuvsFilterConvert</span><span class="o">.</span><span class="n">cu</span><span class="o">.</span><span class="n">o</span>
<span class="n">utils</span><span class="o">/</span><span class="n">CuvsUtils</span><span class="o">.</span><span class="n">cu</span><span class="o">.</span><span class="n">o</span>
</pre></div>
</div>
<blockquote>
<div><p><strong>Key consequence:</strong> In this wheel, <strong>FAISS GPU indexes can dispatch to cuVS kernels</strong> for the families above when you <strong>enable cuVS</strong> at construction/cloning time and the <strong>cuVS/RAPIDS libraries are present</strong> in the process. The runtime loader &amp; resource rules for cuVS remain the same (preload <code class="docutils literal notranslate"><span class="pre">libcuvs</span></code>, <code class="docutils literal notranslate"><span class="pre">librmm</span></code>, logging; use a shared <code class="docutils literal notranslate"><span class="pre">Resources</span></code> handle if calling cuVS directly).</p>
</div></blockquote>
<hr class="docutils" />
<section id="revised-capability-matrix-this-wheel">
<h2>1) Revised capability matrix (this wheel)<a class="headerlink" href="#revised-capability-matrix-this-wheel" title="Link to this heading">#</a></h2>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Family / class</p></th>
<th class="head text-right"><p>CPU</p></th>
<th class="head text-right"><p>GPU (FAISS kernels)</p></th>
<th class="head text-right"><p><strong>cuVS through FAISS (this wheel)</strong></p></th>
<th class="head text-right"><p><strong>cuVS direct (Python)</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Flat (exact)</strong></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">IndexFlat{L2,IP}</span></code></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexFlat{L2,IP}</span></code></p></td>
<td class="text-right"><p>✅ via <strong>index‑level cuVS</strong> (<code class="docutils literal notranslate"><span class="pre">GpuIndexFlat{L2,IP}</span></code> with <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code>) and via <strong>bfKNN</strong> (<code class="docutils literal notranslate"><span class="pre">knn_gpu/bfKnn</span></code> with <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code>)</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.brute_force</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>IVF‑Flat</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFFlat</span></code></p></td>
<td class="text-right"><p>✅ <strong>index‑level cuVS</strong> (<code class="docutils literal notranslate"><span class="pre">GpuIndexIVFFlat</span></code> with <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code>)</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.ivf_flat</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>IVF‑PQ</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFPQ</span></code></p></td>
<td class="text-right"><p>✅ <strong>index‑level cuVS</strong> (<code class="docutils literal notranslate"><span class="pre">GpuIndexIVFPQ</span></code> with <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code>)</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.ivf_pq</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>IVF‑SQ</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFScalarQuantizer</span></code></p></td>
<td class="text-right"><p>– (no cuVS kernel here)</p></td>
<td class="text-right"><p>–</p></td>
</tr>
<tr class="row-even"><td><p><strong>Graph (HNSW)</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>–</p></td>
<td class="text-right"><p>–</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.hnsw</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Graph (CAGRA)</strong></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">IndexHNSWCagra</span></code></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexCagra</span></code></p></td>
<td class="text-right"><p>✅ <strong>index‑level cuVS</strong> (<code class="docutils literal notranslate"><span class="pre">GpuIndexCagra</span></code> with <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code>)</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.cagra</span></code> (+ multi‑GPU)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Binary</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexBinaryFlat</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexBinaryCagra</span></code></p></td>
<td class="text-right"><p>✅ <strong>Binary‑CAGRA</strong> via <strong>index‑level cuVS</strong> (<code class="docutils literal notranslate"><span class="pre">GpuIndexBinaryCagra</span></code>)</p></td>
<td class="text-right"><p>–</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Direct bfKNN</strong></p></td>
<td class="text-right"><p>–</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">bfKnn(...)</span></code> / <code class="docutils literal notranslate"><span class="pre">knn_gpu(...)</span></code></p></td>
<td class="text-right"><p>✅ <strong>set <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code></strong> (guard with <code class="docutils literal notranslate"><span class="pre">should_use_cuvs(...)</span></code>)</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.distance</span></code> / brute_force</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>What changed:</strong> In earlier guidance, IVF‑Flat/IVF‑PQ/CAGRA/Binary‑CAGRA were marked “not via FAISS route”. In <strong>this</strong> wheel, those families <strong>are</strong> cuVS‑enabled inside FAISS when you opt in via the <strong>index configs</strong> or <strong>GPU cloner options</strong> described below (and cuVS libs are present). The bfKNN cuVS path remains available. The cuVS loader &amp; environment remain as documented.</p>
</section>
<hr class="docutils" />
<section id="how-to-enable-cuvs-reliable-patterns">
<h2>2) How to enable cuVS (reliable patterns)<a class="headerlink" href="#how-to-enable-cuvs-reliable-patterns" title="Link to this heading">#</a></h2>
<section id="oneline-preload-cuvs-rapids-libs">
<h3>2.1. One‑line preload (cuVS/RAPIDS libs)<a class="headerlink" href="#oneline-preload-cuvs-rapids-libs" title="Link to this heading">#</a></h3>
<p>Call this <strong>before</strong> importing/initializing FAISS to ensure the shared libraries are resident:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libcuvs</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_library</span>
<span class="n">load_library</span><span class="p">()</span>  <span class="c1"># loads libcuvs, librmm, rapids_logger; idempotent</span>
</pre></div>
</div>
<p>This follows the integration guidance in your loader reference and prevents <code class="docutils literal notranslate"><span class="pre">OSError:</span> <span class="pre">libcuvs_c.so</span> <span class="pre">not</span> <span class="pre">found</span></code> surprises.</p>
</section>
<hr class="docutils" />
<section id="enabling-cuvs-via-gpu-cloner-options-recommended">
<h3>2.2. Enabling cuVS via <strong>GPU Cloner Options</strong> (recommended)<a class="headerlink" href="#enabling-cuvs-via-gpu-cloner-options-recommended" title="Link to this heading">#</a></h3>
<p>The simplest and most portable way to engage cuVS for <strong>Flat / IVF‑Flat / IVF‑PQ / CAGRA / Binary‑CAGRA</strong> is to <strong>build the index on CPU</strong>, then <strong>clone to GPU</strong> with a cuVS‑aware cloner:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>

<span class="c1"># 1) Build a CPU index (examples below)</span>
<span class="n">cpu_index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_factory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;OPQ64,IVF8192,PQ64&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>
<span class="n">cpu_index</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_vectors</span><span class="p">)</span>

<span class="c1"># 2) Prepare GPU resources</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">StandardGpuResources</span><span class="p">()</span>

<span class="c1"># 3) Clone with cuVS enabled (guarded)</span>
<span class="n">co</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuClonerOptions</span><span class="p">()</span>
<span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># ask for cuVS kernels if available</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">gpu_index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu_index</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
    <span class="c1"># Fallback if cuVS cannot be used for this combo</span>
    <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gpu_index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu_index</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GpuClonerOptions.use_cuvs</span></code> is exposed in this wheel and directs FAISS to build the <strong>cuVS‑backed</strong> GPU index when possible.</p></li>
<li><p>This pattern works uniformly across Flat / IVF‑Flat / IVF‑PQ and also covers <strong>CAGRA</strong> if cloning from <code class="docutils literal notranslate"><span class="pre">IndexHNSWCagra</span></code> to <code class="docutils literal notranslate"><span class="pre">GpuIndexCagra</span></code> is desired. (You can also build <code class="docutils literal notranslate"><span class="pre">GpuIndexCagra</span></code> directly; see 2.3.)</p></li>
<li><p>Keep your <strong>existing memory tuning</strong> (<code class="docutils literal notranslate"><span class="pre">setTempMemory</span></code>, <code class="docutils literal notranslate"><span class="pre">setPinnedMemory</span></code>) for throughput.</p></li>
</ul>
<blockquote>
<div><p>You can also probe <code class="docutils literal notranslate"><span class="pre">faiss.should_use_cuvs(...)</span></code> before setting the flag; however, the <strong>try/except</strong> is the most robust guard when combining drivers, cards, and dims.</p>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="enabling-cuvs-via-index-configs-direct-gpu-constructors">
<h3>2.3. Enabling cuVS via <strong>index configs</strong> (direct GPU constructors)<a class="headerlink" href="#enabling-cuvs-via-index-configs-direct-gpu-constructors" title="Link to this heading">#</a></h3>
<p>When you <strong>construct GPU indexes directly</strong>, pass a config whose base type is <code class="docutils literal notranslate"><span class="pre">GpuIndexConfig</span></code> and set <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code> there (the property is inherited by specific configs):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Flat</span>
<span class="n">flat_cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexFlatConfig</span><span class="p">()</span>
<span class="n">flat_cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gpu_flat</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexFlatIP</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">flat_cfg</span><span class="p">)</span>  <span class="c1"># or GpuIndexFlatL2</span>

<span class="c1"># IVF-FLAT / IVF-PQ</span>
<span class="n">ivf_cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexIVFConfig</span><span class="p">()</span>
<span class="n">ivf_cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># ... pass ivf_cfg to the appropriate GpuIndexIVF* constructor</span>

<span class="c1"># CAGRA</span>
<span class="n">cagra_cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexCagraConfig</span><span class="p">()</span>
<span class="n">cagra_cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gpu_cagra</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexCagra</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">cagra_cfg</span><span class="p">)</span>

<span class="c1"># Binary-CAGRA (if you build it directly)</span>
<span class="c1"># (config class may not be separate in the API; prefer the cloner path if unsure)</span>
</pre></div>
</div>
<p>These configs inherit <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code> through <code class="docutils literal notranslate"><span class="pre">GpuIndexConfig</span></code> in this wheel. Use the cloner option (2.2) when you want one code path that works across all index types.</p>
</section>
<hr class="docutils" />
<section id="enabling-cuvs-for-direct-gpu-bruteforce-knn">
<h3>2.4. Enabling cuVS for <strong>direct GPU brute‑force kNN</strong><a class="headerlink" href="#enabling-cuvs-for-direct-gpu-bruteforce-knn" title="Link to this heading">#</a></h3>
<p>The <strong>bfKNN</strong> path can independently dispatch to cuVS kernels:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">faiss</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardGpuResources</span><span class="p">,</span> <span class="n">METRIC_INNER_PRODUCT</span><span class="p">,</span> <span class="n">GpuDistanceParams</span><span class="p">,</span> <span class="n">knn_gpu</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">StandardGpuResources</span><span class="p">()</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">GpuDistanceParams</span><span class="p">();</span> <span class="n">params</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">METRIC_INNER_PRODUCT</span><span class="p">;</span> <span class="n">params</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">params</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="n">d</span>

<span class="c1"># guard with should_use_cuvs; fallback is automatic inside knn_gpu if you pass False</span>
<span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># or: bool(faiss.should_use_cuvs(params))</span>
<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">knn_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">xq</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">xb</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
               <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">,</span> <span class="n">use_cuvs</span><span class="o">=</span><span class="n">use_cuvs</span><span class="p">)</span>
</pre></div>
</div>
<p>This remains a great baseline even when your main serving index is IVF‑PQ/CAGRA.</p>
</section>
</section>
<hr class="docutils" />
<section id="minimal-correct-by-construction-recipes-per-family">
<h2>3) Minimal “correct by construction” recipes per family<a class="headerlink" href="#minimal-correct-by-construction-recipes-per-family" title="Link to this heading">#</a></h2>
<blockquote>
<div><p>These patterns <strong>train on CPU</strong> (deterministic), then <strong>clone to GPU with cuVS</strong>. You can switch to direct GPU construction later; the recall/latency behavior is identical once cuVS is engaged.</p>
</div></blockquote>
<section id="ivfpq-opq64-ivf8192-pq64-with-cuvs">
<h3>3.1. <strong>IVF‑PQ (OPQ64,IVF8192,PQ64)</strong> with cuVS<a class="headerlink" href="#ivfpq-opq64-ivf8192-pq64-with-cuvs" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">d</span> <span class="o">=</span> <span class="mi">2560</span>
<span class="n">cpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_factory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;OPQ64,IVF8192,PQ64&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">faiss</span><span class="o">.</span><span class="n">normalize_L2</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">cpu</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">StandardGpuResources</span><span class="p">()</span>
<span class="n">co</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuClonerOptions</span><span class="p">();</span> <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>  <span class="c1"># cuVS-backed IVFPQ</span>

<span class="c1"># add/search as usual</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Keeps your default “best‑in‑class” factory and determinism.</p></li>
<li><p>The <strong>cloner</strong> chooses the cuVS implementation for the data path compiled in this wheel.</p></li>
</ul>
</section>
<section id="ivfflat-with-cuvs">
<h3>3.2. <strong>IVF‑Flat</strong> with cuVS<a class="headerlink" href="#ivfflat-with-cuvs" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_factory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;IVF8192,Flat&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>
<span class="n">cpu</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="n">co</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuClonerOptions</span><span class="p">();</span> <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>  <span class="c1"># cuVS-backed IVFFlat</span>
</pre></div>
</div>
</section>
<section id="flat-exact-with-cuvs">
<h3>3.3. <strong>Flat (exact)</strong> with cuVS<a class="headerlink" href="#flat-exact-with-cuvs" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Index route:</strong> <code class="docutils literal notranslate"><span class="pre">GpuIndexFlat{L2,IP}</span></code> with <code class="docutils literal notranslate"><span class="pre">GpuIndexFlatConfig.use_cuvs</span> <span class="pre">=</span> <span class="pre">True</span></code>.</p></li>
<li><p><strong>Direct KNN:</strong> <code class="docutils literal notranslate"><span class="pre">knn_gpu(...,</span> <span class="pre">use_cuvs=True)</span></code> (guarded).</p></li>
</ul>
</section>
<section id="cagra-with-cuvs">
<h3>3.4. <strong>CAGRA</strong> with cuVS<a class="headerlink" href="#cagra-with-cuvs" title="Link to this heading">#</a></h3>
<ul>
<li><p><strong>Direct GPU build</strong> (graph lives on GPU):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexCagraConfig</span><span class="p">();</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gpu_cagra</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexCagra</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
<span class="c1"># gpu_cagra.add(n, xb) builds the graph; search as usual</span>
</pre></div>
</div>
</li>
<li><p><strong>CPU↔GPU interop:</strong> <code class="docutils literal notranslate"><span class="pre">IndexHNSWCagra</span></code> exists on CPU for moving graph structure if needed (e.g., copy base level). Keep primary serving on GPU to avoid host &lt;-&gt; device hops.</p></li>
</ul>
</section>
<section id="binarycagra-with-cuvs">
<h3>3.5. <strong>Binary‑CAGRA</strong> with cuVS<a class="headerlink" href="#binarycagra-with-cuvs" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Prefer the <strong>cloner path</strong> when coming from CPU binary indexes; if you instantiate <code class="docutils literal notranslate"><span class="pre">GpuIndexBinaryCagra</span></code> directly, keep the same principle: construct with a config that enables cuVS (or clone with <code class="docutils literal notranslate"><span class="pre">GpuClonerOptions.use_cuvs=True</span></code>) and fall back on error.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="filters-selectors-what-those-cuvsfilter-objects-mean-for-you">
<h2>4) Filters &amp; selectors (what those <code class="docutils literal notranslate"><span class="pre">CuvsFilter*</span></code> objects mean for you)<a class="headerlink" href="#filters-selectors-what-those-cuvsfilter-objects-mean-for-you" title="Link to this heading">#</a></h2>
<p>The presence of <code class="docutils literal notranslate"><span class="pre">utils/CuvsFilterConvert.cu.o</span></code> indicates FAISS performs <strong>selector/bitset conversion</strong> into cuVS‑compatible filter representations when a filter is passed at search time (e.g., via <code class="docutils literal notranslate"><span class="pre">SearchParametersIVF.sel</span></code> / ID selectors). You do not need to change your Python calls:</p>
<ul class="simple">
<li><p>Keep using FAISS’ <strong>search parameters</strong> (e.g., <code class="docutils literal notranslate"><span class="pre">SearchParametersIVF</span></code>’s selector).</p></li>
<li><p>When the index was constructed/cloned with <strong><code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code></strong>, the FAISS runtime converts the filter to cuVS’ internal format and applies it during list scans.</p></li>
</ul>
<p>This is transparent but worth noting for <strong>filtered search</strong> scenarios. (The general cuVS run‑time and loader expectations remain exactly as previously documented.)</p>
</section>
<hr class="docutils" />
<section id="operational-reminders-unchanged-but-critical">
<h2>5) Operational reminders (unchanged but critical)<a class="headerlink" href="#operational-reminders-unchanged-but-critical" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Preload cuVS</strong> once per process (<code class="docutils literal notranslate"><span class="pre">libcuvs.load_library()</span></code>), so <strong>RMM</strong> and logging are initialized and all <code class="docutils literal notranslate"><span class="pre">.so</span></code> dependencies are resident.</p></li>
<li><p>Stick to <strong>row‑major <code class="docutils literal notranslate"><span class="pre">float32</span></code></strong> contiguous arrays for FAISS; normalize vectors for cosine (IP).</p></li>
<li><p>Keep GPU working set <strong>≤ ~80% VRAM</strong>; pre‑allocate <strong>temp</strong> and <strong>pinned</strong> memory on <code class="docutils literal notranslate"><span class="pre">StandardGpuResources</span></code>.</p></li>
<li><p>For <strong>cuVS direct</strong> experimentation (IVF‑PQ, IVF‑Flat, CAGRA, HNSW, multi‑GPU), continue to use the Python surfaces under <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.*</span></code> with a shared <code class="docutils literal notranslate"><span class="pre">Resources</span></code> handle and device arrays, as documented in your cuVS reference.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="quick-am-i-using-cuvs-right-now-probes">
<h2>6) Quick “am I using cuVS right now?” probes<a class="headerlink" href="#quick-am-i-using-cuvs-right-now-probes" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># After calling libcuvs.load_library() and constructing your GPU index:</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>

<span class="c1"># 1) For bfKNN:</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuDistanceParams</span><span class="p">();</span> <span class="n">p</span><span class="o">.</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">dims</span><span class="o">=</span><span class="n">d</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">metric</span><span class="o">=</span><span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bfKNN should_use_cuvs:&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">should_use_cuvs</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># True → bfKNN will route to cuVS</span>

<span class="c1"># 2) For an index you plan to build:</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexIVFConfig</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Index should_use_cuvs:&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">should_use_cuvs</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>  <span class="c1"># True → set cfg/co.use_cuvs = True</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If you skip <code class="docutils literal notranslate"><span class="pre">should_use_cuvs</span></code>, simply <strong>set <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code></strong> and <strong>catch</strong> a <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> on construction; re‑try with <code class="docutils literal notranslate"><span class="pre">False</span></code>. This keeps your code robust across environments while <strong>preferring cuVS</strong> whenever available.</p></li>
</ul>
<hr class="docutils" />
<section id="pointers-unchanged">
<h3>Pointers (unchanged)<a class="headerlink" href="#pointers-unchanged" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>cuVS API &amp; usage</strong> (neighbors, distance, resources, device arrays) — your cuVS reference.</p></li>
<li><p><strong>cuVS loader &amp; environment</strong> (preload order, env vars, system vs wheel libs) — libcuvs loader reference.</p></li>
<li><p><strong>System architecture &amp; defaults</strong> (2560‑d, OPQ64/IVF8192/PQ64, persistence, observability) — high‑level architecture.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="bottom-line-what-to-change-in-your-code">
<h2>7) Bottom line (what to change in your code)<a class="headerlink" href="#bottom-line-what-to-change-in-your-code" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Call</strong> <code class="docutils literal notranslate"><span class="pre">load_library()</span></code> <strong>once at startup</strong>.</p></li>
<li><p><strong>When cloning</strong> CPU→GPU, set <code class="docutils literal notranslate"><span class="pre">co.use_cuvs</span> <span class="pre">=</span> <span class="pre">True</span></code> and <strong>fall back</strong> on error. This now enables cuVS for <strong>Flat</strong>, <strong>IVF‑Flat</strong>, <strong>IVF‑PQ</strong>, <strong>CAGRA</strong>, and <strong>Binary‑CAGRA</strong> in this build.</p></li>
<li><p><strong>When constructing GPU indexes directly</strong>, set <code class="docutils literal notranslate"><span class="pre">cfg.use_cuvs</span> <span class="pre">=</span> <span class="pre">True</span></code> on the appropriate <strong><code class="docutils literal notranslate"><span class="pre">GpuIndex*Config</span></code></strong> (or use the cloner).</p></li>
<li><p>For <strong>bfKNN</strong>, pass <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code> (or guard with <code class="docutils literal notranslate"><span class="pre">should_use_cuvs</span></code>).</p></li>
<li><p>Keep the rest of the pipeline (factory string, normalization, memory planning, multi‑GPU strategy, persistence) <strong>unchanged</strong>.</p></li>
</ol>
</section>
</section>
<section id="addendum-base-content-on-faiss-gpu-library">
<h1>addendum, base content on faiss gpu library<a class="headerlink" href="#addendum-base-content-on-faiss-gpu-library" title="Link to this heading">#</a></h1>
<section id="what-changed-vs-the-prior-wheel-and-how-to-think-about-it">
<h2>0) What changed vs. the prior wheel (and how to think about it)<a class="headerlink" href="#what-changed-vs-the-prior-wheel-and-how-to-think-about-it" title="Link to this heading">#</a></h2>
<p><strong>Hardware/ABI</strong></p>
<ul class="simple">
<li><p>CUDA runtime linked: <strong><code class="docutils literal notranslate"><span class="pre">libcudart.so.13</span></code></strong> → the wheel targets <strong>CUDA 13</strong> (Blackwell‑ready).</p></li>
<li><p>GPU arch: <strong><code class="docutils literal notranslate"><span class="pre">sm_120</span></code> SASS + PTX</strong> (“<strong><code class="docutils literal notranslate"><span class="pre">sm_120‑virtual</span></code></strong>”) for forward compatibility—native kernels when they match, PTX JIT otherwise.</p></li>
</ul>
<p><strong>cuVS inside FAISS (this wheel)</strong></p>
<ul class="simple">
<li><p>The GPU SWIG layer exports <strong><code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code> gates on index configs and cloner options</strong> and dynamically links against cuVS/RAPIDS libs. With cuVS libraries <strong>preloaded</strong>, FAISS GPU indexes can route to <strong>cuVS kernels</strong> for <strong>Flat, IVF‑Flat, IVF‑PQ, CAGRA, Binary‑CAGRA</strong>; otherwise FAISS falls back to its own kernels.</p></li>
</ul>
<blockquote>
<div><p><strong>Reminder</strong>: the kernels themselves live in the <strong>cuVS</strong> shared libraries; the FAISS wheel holds <strong>dispatch hooks</strong> and dynamic links. Ensure the cuVS loader is invoked at process start.</p>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="cpu-vs-gpu-vs-cuvs-updated-capability-map-this-wheel">
<h2>1) CPU vs GPU vs cuVS — updated capability map (this wheel)<a class="headerlink" href="#cpu-vs-gpu-vs-cuvs-updated-capability-map-this-wheel" title="Link to this heading">#</a></h2>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Family / class</p></th>
<th class="head text-right"><p>CPU</p></th>
<th class="head text-right"><p>GPU (FAISS kernels)</p></th>
<th class="head text-right"><p><strong>cuVS through FAISS</strong> (this wheel)</p></th>
<th class="head text-right"><p><strong>cuVS direct (Python)</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Flat (exact)</strong></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">IndexFlat{L2,IP}</span></code></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexFlat{L2,IP}</span></code></p></td>
<td class="text-right"><p>✅ via <strong>index‑level <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code></strong> on <code class="docutils literal notranslate"><span class="pre">GpuIndexFlat*</span></code> and via <strong>bfKNN</strong> (<code class="docutils literal notranslate"><span class="pre">knn_gpu/bfKnn</span></code> <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code>)</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.brute_force</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>IVF‑Flat</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFFlat</span></code></p></td>
<td class="text-right"><p>✅ via <strong>index‑level <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code></strong> / GPU cloner</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.ivf_flat</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>IVF‑PQ</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFPQ</span></code></p></td>
<td class="text-right"><p>✅ via <strong>index‑level <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code></strong> / GPU cloner</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.ivf_pq</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>IVF‑SQ</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFScalarQuantizer</span></code></p></td>
<td class="text-right"><p>– (no cuVS path)</p></td>
<td class="text-right"><p>–</p></td>
</tr>
<tr class="row-even"><td><p><strong>Graph (HNSW)</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>–</p></td>
<td class="text-right"><p>–</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.hnsw</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Graph (CAGRA)</strong></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">IndexHNSWCagra</span></code></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexCagra</span></code></p></td>
<td class="text-right"><p>✅ via <strong>index‑level <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code></strong></p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.cagra</span></code> (+ multi‑GPU)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Binary</strong></p></td>
<td class="text-right"><p>✅</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">GpuIndexBinaryFlat</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexBinaryCagra</span></code></p></td>
<td class="text-right"><p>✅ <strong>Binary‑CAGRA</strong> via index‑level <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code></p></td>
<td class="text-right"><p>–</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Direct bfKNN</strong></p></td>
<td class="text-right"><p>–</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">bfKnn(...)</span></code> / <code class="docutils literal notranslate"><span class="pre">knn_gpu(...)</span></code></p></td>
<td class="text-right"><p>✅ <strong><code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code></strong> (guard with <code class="docutils literal notranslate"><span class="pre">should_use_cuvs</span></code>)</p></td>
<td class="text-right"><p>✅ <code class="docutils literal notranslate"><span class="pre">cuvs.distance</span></code> / brute_force</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Filters &amp; selectors:</strong> your build includes <code class="docutils literal notranslate"><span class="pre">CuvsFilterConvert.cu.o</span></code>; FAISS will convert FAISS selectors/bitsets into cuVS’ filter format automatically when the index was created with <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code>. You keep using standard FAISS search params at the Python layer.</p>
</section>
<hr class="docutils" />
<section id="blackwell-rtx-5090-support-sass-sm-120-ptx-sm-120virtual">
<h2>2) Blackwell (RTX 5090) support: SASS <strong><code class="docutils literal notranslate"><span class="pre">sm_120</span></code></strong> + PTX <strong><code class="docutils literal notranslate"><span class="pre">sm_120‑virtual</span></code></strong><a class="headerlink" href="#blackwell-rtx-5090-support-sass-sm-120-ptx-sm-120virtual" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Why it matters</strong>: perfect performance when SASS matches; <strong>PTX fallback</strong> when driver/toolkit moves ahead (no “no kernel image” errors).</p></li>
<li><p><strong>Ops tips</strong>: leave <code class="docutils literal notranslate"><span class="pre">CUDA_CACHE_MAXSIZE</span></code> roomy to avoid first‑run JIT thrash; never force JIT in production.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="cuvs-enablement-model-final-patterns">
<h2>3) cuVS enablement model (final patterns)<a class="headerlink" href="#cuvs-enablement-model-final-patterns" title="Link to this heading">#</a></h2>
<p><strong>Always preload cuVS/RAPIDS libs before FAISS</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libcuvs</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_library</span>
<span class="n">load_library</span><span class="p">()</span>  <span class="c1"># loads libcuvs, librmm, rapids_logger; idempotent. :contentReference[oaicite:12]{index=12}</span>
</pre></div>
</div>
<p><strong>A) Index‑level enablement (recommended)</strong>
Set <strong><code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code></strong> on the GPU cloner or GPU index config; <strong>catch &amp; fallback</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>

<span class="c1"># Clone CPU → GPU (works uniformly for Flat / IVF-Flat / IVF-PQ / CAGRA / Binary-CAGRA)</span>
<span class="n">co</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuClonerOptions</span><span class="p">();</span> <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">gpu_index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu_index</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
    <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gpu_index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu_index</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>
</pre></div>
</div>
<p>Or <strong>construct GPU indexes directly</strong> with a config inheriting <code class="docutils literal notranslate"><span class="pre">GpuIndexConfig.use_cuvs</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">flat_cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexFlatConfig</span><span class="p">();</span> <span class="n">flat_cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gpu_flat</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexFlatIP</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">flat_cfg</span><span class="p">)</span>

<span class="n">ivf_cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexIVFConfig</span><span class="p">();</span> <span class="n">ivf_cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># pass ivf_cfg into the appropriate GpuIndexIVF* constructor</span>

<span class="n">cagra_cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexCagraConfig</span><span class="p">();</span> <span class="n">cagra_cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gpu_cagra</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexCagra</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">cagra_cfg</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>B) Brute‑force KNN path</strong>
Guard <strong><code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code></strong> with the central probe (falls back if not viable):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuDistanceParams</span><span class="p">();</span> <span class="n">params</span><span class="o">.</span><span class="n">dims</span><span class="o">=</span><span class="n">d</span><span class="p">;</span> <span class="n">params</span><span class="o">.</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span> <span class="n">params</span><span class="o">.</span><span class="n">metric</span><span class="o">=</span><span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span>
<span class="n">use_cuvs</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">faiss</span><span class="o">.</span><span class="n">should_use_cuvs</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>  <span class="c1"># detects viability at runtime. :contentReference[oaicite:13]{index=13}</span>
<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">knn_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">xq</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">xb</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span>
                     <span class="n">metric</span><span class="o">=</span><span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">,</span> <span class="n">use_cuvs</span><span class="o">=</span><span class="n">use_cuvs</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>C) Direct cuVS ANN (optional)</strong>
Use cuVS Python APIs for IVF‑Flat/IVF‑PQ/CAGRA/HNSW (especially when you want multi‑GPU <code class="docutils literal notranslate"><span class="pre">mg.*</span></code> variants): <code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.{ivf_flat,</span> <span class="pre">ivf_pq,</span> <span class="pre">cagra,</span> <span class="pre">hnsw}</span></code> with <code class="docutils literal notranslate"><span class="pre">Resources</span></code> handle and device arrays.</p>
</section>
<hr class="docutils" />
<section id="bestinclass-faiss-build-on-rtx-5090-cosine-2560d-now-with-cuvs-toggles">
<h2>4) “Best‑in‑class” FAISS build on RTX 5090 (cosine, 2560‑d) — <strong>now with cuVS toggles</strong><a class="headerlink" href="#bestinclass-faiss-build-on-rtx-5090-cosine-2560d-now-with-cuvs-toggles" title="Link to this heading">#</a></h2>
<p><strong>Index choice</strong>: <code class="docutils literal notranslate"><span class="pre">OPQ64,IVF8192,PQ64</span></code> (cosine via L2 normalization + IP). <strong>Train</strong> on up to <strong>10 M</strong> samples (seed=42). <strong>Search</strong> with <code class="docutils literal notranslate"><span class="pre">nprobe=64</span></code>.</p>
<p><strong>GPU clone with cuVS</strong> (preferred path):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">d</span> <span class="o">=</span> <span class="mi">2560</span>
<span class="n">cpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_factory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;OPQ64,IVF8192,PQ64&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">);</span> <span class="n">faiss</span><span class="o">.</span><span class="n">normalize_L2</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">cpu</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">StandardGpuResources</span><span class="p">()</span>
<span class="n">res</span><span class="o">.</span><span class="n">setTempMemory</span><span class="p">(</span><span class="mi">1_200_000_000</span><span class="p">);</span> <span class="n">res</span><span class="o">.</span><span class="n">setPinnedMemory</span><span class="p">(</span><span class="mi">512_000_000</span><span class="p">)</span>

<span class="n">co</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuClonerOptions</span><span class="p">();</span> <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">gpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>  <span class="c1"># cuVS-backed IVFPQ in this build</span>
<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
    <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>

<span class="c1"># add / search as usual</span>
</pre></div>
</div>
<p><strong>Notes &amp; knobs</strong></p>
<ul class="simple">
<li><p>Precompute lookup tables on GPU if your PQ config benefits (via cloner/options); keep working set ≤ <strong>80%</strong> VRAM; reuse pinned host buffers for larger transfers.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="when-to-call-cuvs-directly-and-when-faiss-cuvs-is-enough">
<h2>5) When to call cuVS directly (and when FAISS+cuVS is enough)<a class="headerlink" href="#when-to-call-cuvs-directly-and-when-faiss-cuvs-is-enough" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Stay inside FAISS</strong> (with <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code>) for: <strong>Flat, IVF‑Flat, IVF‑PQ, CAGRA, Binary‑CAGRA</strong>; you get FAISS’ ergonomics and cuVS performance.</p></li>
<li><p><strong>Call cuVS directly</strong> when you need: <strong>multi‑GPU <code class="docutils literal notranslate"><span class="pre">mg.*</span></code></strong> pipelines, algorithm‑specific parameters not exposed by FAISS’ wrappers, or you want to co‑locate with other RAFT pipelines with explicit stream choreography.</p></li>
</ul>
<p><strong>Direct IVF‑PQ example (unchanged)</strong> — device arrays + <code class="docutils literal notranslate"><span class="pre">Resources</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resources</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ivf_pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pylibraft.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">device_ndarray</span>
<span class="c1"># build/search as in your prior example … :contentReference[oaicite:18]{index=18}</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="quick-api-map-what-youll-call-most-often">
<h2>6) Quick API map — <strong>what you’ll call most often</strong><a class="headerlink" href="#quick-api-map-what-youll-call-most-often" title="Link to this heading">#</a></h2>
<p><strong>CPU</strong>
<code class="docutils literal notranslate"><span class="pre">IndexFlat{L2,IP}</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexIVFFlat</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexIVFPQ</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexIVFScalarQuantizer</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexHNSW*</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexHNSWCagra</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexBinary*</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexPreTransform</span></code>, <code class="docutils literal notranslate"><span class="pre">OPQMatrix</span></code>, <code class="docutils literal notranslate"><span class="pre">PCAMatrix</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexRefineFlat</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexShards</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexReplicas</span></code>.</p>
<p><strong>GPU (FAISS)</strong>
<code class="docutils literal notranslate"><span class="pre">StandardGpuResources</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexFlat{L2,IP}</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFFlat</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFPQ</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexIVFScalarQuantizer</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexCagra</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexBinaryFlat</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndexBinaryCagra</span></code>, <code class="docutils literal notranslate"><span class="pre">index_cpu_to_gpu[_multiple]</span></code>, <code class="docutils literal notranslate"><span class="pre">index_gpu_to_cpu</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuClonerOptions</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuParameterSpace</span></code>, <code class="docutils literal notranslate"><span class="pre">knn_gpu(...)</span></code>, <code class="docutils literal notranslate"><span class="pre">bfKnn(...)</span></code>.</p>
<p><strong>cuVS hooks inside FAISS</strong>
<code class="docutils literal notranslate"><span class="pre">GpuClonerOptions.use_cuvs</span></code>, <code class="docutils literal notranslate"><span class="pre">GpuIndex*Config.use_cuvs</span></code>, <code class="docutils literal notranslate"><span class="pre">should_use_cuvs(...)</span></code> (for bfKNN probe), <code class="docutils literal notranslate"><span class="pre">knn_gpu(...,</span> <span class="pre">use_cuvs=...)</span></code>.</p>
<p><strong>cuVS (direct)</strong>
<code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.{ivf_flat,</span> <span class="pre">ivf_pq,</span> <span class="pre">cagra,</span> <span class="pre">hnsw,</span> <span class="pre">brute_force,</span> <span class="pre">mg.*}</span></code>, <code class="docutils literal notranslate"><span class="pre">cuvs.cluster.kmeans</span></code>, <code class="docutils literal notranslate"><span class="pre">cuvs.distance.pairwise_distance</span></code>, <code class="docutils literal notranslate"><span class="pre">cuvs.common.Resources</span></code>.</p>
</section>
<hr class="docutils" />
<section id="validation-checklist-runtime">
<h2>7) Validation checklist (runtime)<a class="headerlink" href="#validation-checklist-runtime" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Preload check</strong> (did we load the libraries?):</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libcuvs</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_library</span>
<span class="nb">print</span><span class="p">([</span><span class="n">h</span><span class="o">.</span><span class="n">_name</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">load_library</span><span class="p">()])</span>  <span class="c1"># expect libcuvs*, librmm, rapids_logger. :contentReference[oaicite:21]{index=21}</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>Index‑level cuVS</strong> (construction guard):</p></li>
</ol>
<ul class="simple">
<li><p>Clone/construct with <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code>. If it <strong>raises</strong>, retry with <code class="docutils literal notranslate"><span class="pre">False</span></code>. Log the final <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code> state per index.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p><strong>bfKNN cuVS probe</strong> (fast sanity):</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">faiss</span><span class="w"> </span><span class="kn">import</span> <span class="n">GpuDistanceParams</span><span class="p">,</span> <span class="n">should_use_cuvs</span><span class="p">,</span> <span class="n">METRIC_INNER_PRODUCT</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">GpuDistanceParams</span><span class="p">();</span> <span class="n">p</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">METRIC_INNER_PRODUCT</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">2560</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">10</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bfKNN should_use_cuvs:&quot;</span><span class="p">,</span> <span class="n">should_use_cuvs</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># True =&gt; bfKNN will route to cuVS. :contentReference[oaicite:22]{index=22}</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p><strong>Direct cuVS smoke</strong> (IVF‑PQ or brute‑force) with device arrays + <code class="docutils literal notranslate"><span class="pre">Resources</span></code>.</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="operational-guidance-unchanged-principles-cuvsaware">
<h2>8) Operational guidance (unchanged principles, cuVS‑aware)<a class="headerlink" href="#operational-guidance-unchanged-principles-cuvsaware" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Loader order</strong>: preload RAPIDS/cuVS first; then import FAISS.</p></li>
<li><p><strong>Memory</strong>: size <code class="docutils literal notranslate"><span class="pre">setTempMemory</span></code>/<code class="docutils literal notranslate"><span class="pre">setPinnedMemory</span></code> once; keep VRAM headroom ~<strong>20%</strong>; batch adds to avoid OOM; precompute tables where helpful.</p></li>
<li><p><strong>Streams</strong>: cuVS direct calls accept a <code class="docutils literal notranslate"><span class="pre">Resources</span></code> handle (shared stream) and only sync when you call <code class="docutils literal notranslate"><span class="pre">handle.sync()</span></code>. FAISS tends to sync at call boundaries; overlap I/O with compute using pinned buffers.</p></li>
<li><p><strong>Indexes at rest</strong>: save <strong>CPU</strong> index (<code class="docutils literal notranslate"><span class="pre">.faiss</span></code>) + <code class="docutils literal notranslate"><span class="pre">.ids</span></code>; rebuild GPU clones at startup (set <code class="docutils literal notranslate"><span class="pre">use_cuvs</span></code> again when cloning).</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="readytopaste-helpers-with-cuvs-autoengage">
<h2>9) Ready‑to‑paste helpers (with cuVS auto‑engage)<a class="headerlink" href="#readytopaste-helpers-with-cuvs-autoengage" title="Link to this heading">#</a></h2>
<p><strong>A. GPU clone (cuVS‑first, safe fallback)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">to_gpu_cuvs_first</span><span class="p">(</span><span class="n">cpu_index</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuClonerOptions</span><span class="p">();</span> <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">cpu_index</span><span class="p">,</span> <span class="n">co</span><span class="p">),</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">cpu_index</span><span class="p">,</span> <span class="n">co</span><span class="p">),</span> <span class="kc">False</span>
</pre></div>
</div>
<p><strong>B. bfKNN with automatic cuVS</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">knn_gpu_auto</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">xq_f32</span><span class="p">,</span> <span class="n">xb_f32</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuDistanceParams</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="p">;</span> <span class="n">params</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">params</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="n">xq_f32</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">use</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">should_use_cuvs</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># True when viable. :contentReference[oaicite:28]{index=28}</span>
    <span class="k">return</span> <span class="n">faiss</span><span class="o">.</span><span class="n">knn_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">xq_f32</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="n">xb_f32</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="n">k</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">use_cuvs</span><span class="o">=</span><span class="n">use</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>C. Direct cuVS IVF‑PQ (device arrays)</strong> — unchanged.</p>
</section>
<hr class="docutils" />
<section id="bottom-line">
<h2>10) Bottom line<a class="headerlink" href="#bottom-line" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>This wheel</strong>: Blackwell‑ready (<strong><code class="docutils literal notranslate"><span class="pre">sm_120</span></code> + PTX</strong>), CUDA‑13, and <strong>cuVS‑enabled</strong> inside FAISS for <strong>Flat, IVF‑Flat, IVF‑PQ, CAGRA, Binary‑CAGRA</strong>.</p></li>
<li><p><strong>Your code</strong>: preload cuVS; set <strong><code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code></strong> on GPU clones/constructors; guard with try/except; use <code class="docutils literal notranslate"><span class="pre">should_use_cuvs(...)</span></code> for bfKNN.</p></li>
<li><p><strong>Architecture &amp; defaults</strong> (factory, training, persistence, multi‑GPU) remain per plan; you simply get <strong>cuVS speed paths</strong> where available without changing the higher‑level design.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="addendum-agentoriented-details-updated-to-match-the-new-cuvs-coverage">
<h1>Addendum — Agent‑oriented details (updated to match the new cuVS coverage)<a class="headerlink" href="#addendum-agentoriented-details-updated-to-match-the-new-cuvs-coverage" title="Link to this heading">#</a></h1>
<p>These sections expand the “how” with concrete interfaces, schemas, and runbooks across the stack and already assume <strong>FAISS can route to cuVS</strong> for the families above.</p>
<section id="a1-process-bootstrap-deterministic-cuvsready">
<h2>A1. Process bootstrap (deterministic &amp; cuVS‑ready)<a class="headerlink" href="#a1-process-bootstrap-deterministic-cuvsready" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libcuvs</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_library</span><span class="p">;</span> <span class="n">load_library</span><span class="p">()</span>   <span class="c1"># ensures libcuvs/librmm/logging are loaded. :contentReference[oaicite:31]{index=31}</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">StandardGpuResources</span><span class="p">()</span>
<span class="n">res</span><span class="o">.</span><span class="n">setTempMemory</span><span class="p">(</span><span class="mi">1_200_000_000</span><span class="p">);</span> <span class="n">res</span><span class="o">.</span><span class="n">setPinnedMemory</span><span class="p">(</span><span class="mi">512_000_000</span><span class="p">)</span>
</pre></div>
</div>
<p>Keep a single <code class="docutils literal notranslate"><span class="pre">StandardGpuResources</span></code> per device for the process lifetime and configure it once.</p>
</section>
<section id="a2-zerocopy-interop-faiss-cuvs">
<h2>A2. Zero‑copy interop (FAISS ↔ cuVS)<a class="headerlink" href="#a2-zerocopy-interop-faiss-cuvs" title="Link to this heading">#</a></h2>
<p>Use RAFT <code class="docutils literal notranslate"><span class="pre">Resources</span></code> and device arrays when calling cuVS directly; prefer pinned host arenas + contiguous <code class="docutils literal notranslate"><span class="pre">float32</span></code> for FAISS inputs to minimize hidden copies.</p>
</section>
<section id="a3-multigpu-replicas-and-shards-unchanged">
<h2>A3. Multi‑GPU: replicas and shards (unchanged)<a class="headerlink" href="#a3-multigpu-replicas-and-shards-unchanged" title="Link to this heading">#</a></h2>
<p>Use <code class="docutils literal notranslate"><span class="pre">IndexReplicas</span></code> (QPS) or <code class="docutils literal notranslate"><span class="pre">IndexShards</span></code> (capacity). When cloning to multiple GPUs, set <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code> on the cloner options once; FAISS will apply it per device (fallback per GPU on error).</p>
</section>
<section id="a4-memory-planning-batching">
<h2>A4. Memory planning &amp; batching<a class="headerlink" href="#a4-memory-planning-batching" title="Link to this heading">#</a></h2>
<p>Budget <strong>scratch + PQ tables + codes + ids + batch</strong> ≤ <strong>80%</strong> VRAM. Tune batch add/search sizes empirically; precompute lookup tables where it helps latency.</p>
</section>
<section id="a5-persistence-registry">
<h2>A5. Persistence &amp; registry<a class="headerlink" href="#a5-persistence-registry" title="Link to this heading">#</a></h2>
<p>Persist <strong>CPU</strong> index (<code class="docutils literal notranslate"><span class="pre">.faiss</span></code>) + <strong><code class="docutils literal notranslate"><span class="pre">.ids</span></code></strong>; rebuild GPU clones at service start using <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code>. Record the final <strong>applied</strong> state (<code class="docutils literal notranslate"><span class="pre">cuvs=true/false</span></code>) in your registry’s <code class="docutils literal notranslate"><span class="pre">faiss_indexes</span></code> rows for observability.</p>
</section>
<section id="a6-observability-probes">
<h2>A6. Observability &amp; probes<a class="headerlink" href="#a6-observability-probes" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Log <code class="docutils literal notranslate"><span class="pre">{gpu_id,</span> <span class="pre">nlist,</span> <span class="pre">m,</span> <span class="pre">nprobe,</span> <span class="pre">k,</span> <span class="pre">batch,</span> <span class="pre">temp_mem,</span> <span class="pre">pinned_mem,</span> <span class="pre">use_cuvs}</span></code> for each search; expose p50/p95/p99 histograms.</p></li>
<li><p>Quick “are the libs loaded?” probe: <code class="docutils literal notranslate"><span class="pre">list(h._name</span> <span class="pre">for</span> <span class="pre">h</span> <span class="pre">in</span> <span class="pre">load_library())</span></code>.</p></li>
<li><p>Quick “will bfKNN use cuVS?” probe: <code class="docutils literal notranslate"><span class="pre">should_use_cuvs(GpuDistanceParams(...))</span></code>.</p></li>
</ul>
</section>
<section id="a7-failure-taxonomy-fallbacks-gpu-paths">
<h2>A7. Failure taxonomy &amp; fallbacks (GPU paths)<a class="headerlink" href="#a7-failure-taxonomy-fallbacks-gpu-paths" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Missing libs</strong> → run <code class="docutils literal notranslate"><span class="pre">load_library()</span></code> first (or fix <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code>); <strong>resume</strong> with FAISS kernels if cuVS fails to initialize.</p></li>
<li><p><strong>OOM</strong> → halve batch; lower <code class="docutils literal notranslate"><span class="pre">setTempMemory</span></code>; retry twice; then quarantine batch.</p></li>
</ul>
</section>
<section id="a8-direct-cuvs-catalog-unchanged-surfaces">
<h2>A8. Direct cuVS catalog (unchanged surfaces)<a class="headerlink" href="#a8-direct-cuvs-catalog-unchanged-surfaces" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">cuvs.neighbors.{ivf_flat,</span> <span class="pre">ivf_pq,</span> <span class="pre">cagra,</span> <span class="pre">hnsw,</span> <span class="pre">brute_force,</span> <span class="pre">mg.*}</span></code>, <code class="docutils literal notranslate"><span class="pre">cuvs.cluster.kmeans</span></code>, <code class="docutils literal notranslate"><span class="pre">cuvs.distance.pairwise_distance</span></code>, <code class="docutils literal notranslate"><span class="pre">cuvs.common.Resources</span></code> — consistent <code class="docutils literal notranslate"><span class="pre">IndexParams</span></code>/<code class="docutils literal notranslate"><span class="pre">SearchParams</span></code>/<code class="docutils literal notranslate"><span class="pre">build</span></code>/<code class="docutils literal notranslate"><span class="pre">extend</span></code>/<code class="docutils literal notranslate"><span class="pre">save</span></code>/<code class="docutils literal notranslate"><span class="pre">load</span></code> patterns.</p>
</section>
<section id="a9-architecture-defaults-for-the-broader-system">
<h2>A9. Architecture defaults (for the broader system)<a class="headerlink" href="#a9-architecture-defaults-for-the-broader-system" title="Link to this heading">#</a></h2>
<p>Keep the <strong>2560‑d</strong> embedder, chunking settings, Parquet schemas, DuckDB catalog/migrations, and hybrid retrieval pipeline exactly as specified in your architecture doc; nothing about the cuVS enablement changes those contracts.</p>
<hr class="docutils" />
<p>If you’d like, I can also output a <strong>drop‑in <code class="docutils literal notranslate"><span class="pre">vectorstore_faiss</span></code> module</strong> (Python package) that wraps the <strong>train/add/search/persist</strong> flow with <strong>cuVS‑first</strong> cloning and automatic bfKNN fallback, plus a tiny <strong>validator</strong> script that prints library load locations, shows <code class="docutils literal notranslate"><span class="pre">should_use_cuvs(...)</span></code>, and runs a 10k‑vector bfKNN smoke test on the RTX 5090.</p>
<p>Below is a <strong>comprehensive, example‑driven reference</strong> that fills in the remaining FAISS and cuVS Python surfaces we hadn’t previously shown with code. It’s organized so an agent can copy/paste snippets and understand shapes, params, edge‑cases, and performance notes. Where relevant, I point to the cuVS and loader docs you provided.</p>
</section>
<hr class="docutils" />
<section id="a-faiss-cpuside-classes-utilities-with-examples">
<h2>A) FAISS — CPU‑side classes &amp; utilities (with examples)<a class="headerlink" href="#a-faiss-cpuside-classes-utilities-with-examples" title="Link to this heading">#</a></h2>
<section id="a1-indexidmap-indexidmap2-stable-ids-around-any-index">
<h3>A1) <code class="docutils literal notranslate"><span class="pre">IndexIDMap</span></code> / <code class="docutils literal notranslate"><span class="pre">IndexIDMap2</span></code> — stable IDs around any index<a class="headerlink" href="#a1-indexidmap-indexidmap2-stable-ids-around-any-index" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> FAISS stores integer IDs; these wrappers let you control them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Base ANN index (any type works)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">2560</span>
<span class="n">base</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_factory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;IVF8192,PQ64&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>

<span class="c1"># Wrap with an ID map so we add our own 64-bit IDs</span>
<span class="n">idmap</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexIDMap2</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

<span class="c1"># Train as usual (on base)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">);</span> <span class="n">faiss</span><span class="o">.</span><span class="n">normalize_L2</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">idmap</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="c1"># Add vectors with application-specific IDs</span>
<span class="n">xb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">500_000</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">);</span> <span class="n">faiss</span><span class="o">.</span><span class="n">normalize_L2</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100_000</span><span class="p">,</span> <span class="mi">100_000</span> <span class="o">+</span> <span class="n">xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
<span class="n">idmap</span><span class="o">.</span><span class="n">add_with_ids</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

<span class="c1"># Search returns your IDs</span>
<span class="n">xq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">);</span> <span class="n">faiss</span><span class="o">.</span><span class="n">normalize_L2</span><span class="p">(</span><span class="n">xq</span><span class="p">)</span>
<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">idmap</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">IndexIDMap2</span></code> (64‑bit IDs) for large corpora.</p></li>
<li><p>Persist <strong>CPU</strong> form (see A6) and keep a parallel <code class="docutils literal notranslate"><span class="pre">.ids</span></code> copy if you ever unwrap the map.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a2-indexrefineflat-refine-ann-hits-with-exact-scoring">
<h3>A2) <code class="docutils literal notranslate"><span class="pre">IndexRefineFlat</span></code> — refine ANN hits with exact scoring<a class="headerlink" href="#a2-indexrefineflat-refine-ann-hits-with-exact-scoring" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Get IVF/graph latency with exact cosine/IP re‑ranking.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a fast coarse index (e.g., IVF,PQ) then refine with Flat</span>
<span class="n">coarse</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_factory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;IVF8192,PQ64&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>
<span class="n">coarse</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">);</span> <span class="n">coarse</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

<span class="n">refined</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexRefineFlat</span><span class="p">(</span><span class="n">coarse</span><span class="p">)</span>   <span class="c1"># wraps the coarse index with an exact refiner</span>
<span class="n">refined</span><span class="o">.</span><span class="n">kfactor</span> <span class="o">=</span> <span class="mf">2.0</span>                     <span class="c1"># search 2×k in coarse stage, re-rank down to k</span>

<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">refined</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>On GPU you’ll typically run the coarse stage on device, then refine on device or CPU depending on memory; the wrapper manages the sequence.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a3-indexpretransform-transforms-opqmatrix-pcamatrix">
<h3>A3) <code class="docutils literal notranslate"><span class="pre">IndexPreTransform</span></code> + transforms (<code class="docutils literal notranslate"><span class="pre">OPQMatrix</span></code>, <code class="docutils literal notranslate"><span class="pre">PCAMatrix</span></code>)<a class="headerlink" href="#a3-indexpretransform-transforms-opqmatrix-pcamatrix" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Pre‑rotate or reduce dimension <strong>inside</strong> the index for better PQ fit.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1) Build transforms: PCA (optional) then OPQ</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">PCAMatrix</span><span class="p">(</span><span class="n">d_in</span><span class="o">=</span><span class="mi">2560</span><span class="p">,</span> <span class="n">d_out</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">eigen_power</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># example PCA step</span>
<span class="n">opq</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">OPQMatrix</span><span class="p">(</span><span class="n">d_out</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>  <span class="c1"># OPQ with 64 subquantizers</span>

<span class="c1"># 2) Chain transforms in a vector</span>
<span class="n">vt</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">VectorTransformChain</span><span class="p">()</span>
<span class="n">vt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pca</span><span class="p">)</span>
<span class="n">vt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opq</span><span class="p">)</span>

<span class="c1"># 3) Base index AFTER transforms (note d=1024 now)</span>
<span class="n">base</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_factory</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;IVF8192,PQ64&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>

<span class="c1"># 4) Wrap into IndexPreTransform</span>
<span class="n">pre</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexPreTransform</span><span class="p">(</span><span class="n">vt</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

<span class="c1"># 5) Train on original-dim data; transform is applied internally</span>
<span class="n">pre</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>       <span class="c1"># &#39;train&#39; runs PCA/OPQ fitting + IVF/PQ training</span>
<span class="n">pre</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>For our default blueprint we already use OPQ64; <code class="docutils literal notranslate"><span class="pre">IndexPreTransform</span></code> is the explicit form of that pipeline. Keep cosine/IP consistency: <strong>normalize</strong> before train/add/query.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a4-clustering-kmeans-build-coarse-quantizers-explicitly">
<h3>A4) <code class="docutils literal notranslate"><span class="pre">Clustering</span></code> (K‑means) — build coarse quantizers explicitly<a class="headerlink" href="#a4-clustering-kmeans-build-coarse-quantizers-explicitly" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Manual control when you don’t use <code class="docutils literal notranslate"><span class="pre">index_factory()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train IVF coarse quantizer centroids explicitly with K-means</span>
<span class="n">nlist</span> <span class="o">=</span> <span class="mi">8192</span>
<span class="n">kmeans</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">Clustering</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">nlist</span><span class="p">)</span>
<span class="n">kmeans</span><span class="o">.</span><span class="n">niter</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">quantizer</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexFlatIP</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>        <span class="c1"># cosine via normalization + IP</span>
<span class="n">kmeans</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">quantizer</span><span class="p">)</span>

<span class="c1"># Use trained quantizer to build IVF, then attach PQ</span>
<span class="n">ivf</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexIVFFlat</span><span class="p">(</span><span class="n">quantizer</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nlist</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>
<span class="n">ivf</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">ivf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">index_factory()</span></code> automates this, but direct <code class="docutils literal notranslate"><span class="pre">Clustering</span></code> is useful for specialized training schedules.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a5-parameterspace-gpuparameterspace-named-tuning-knobs">
<h3>A5) <code class="docutils literal notranslate"><span class="pre">ParameterSpace</span></code> / <code class="docutils literal notranslate"><span class="pre">GpuParameterSpace</span></code> — named tuning knobs<a class="headerlink" href="#a5-parameterspace-gpuparameterspace-named-tuning-knobs" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Set parameters (e.g., <code class="docutils literal notranslate"><span class="pre">nprobe</span></code>) by <strong>name</strong>, works across families.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># CPU</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">ParameterSpace</span><span class="p">()</span>
<span class="n">ps</span><span class="o">.</span><span class="n">set_index_parameter</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;nprobe&quot;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>

<span class="c1"># GPU</span>
<span class="n">gps</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuParameterSpace</span><span class="p">();</span> <span class="n">gps</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">gpu_index</span><span class="p">)</span>
<span class="n">gps</span><span class="o">.</span><span class="n">set_index_parameter</span><span class="p">(</span><span class="n">gpu_index</span><span class="p">,</span> <span class="s2">&quot;nprobe&quot;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>   <span class="c1"># same name on GPU</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Prefer these over ad‑hoc setters; helps keep code index‑agnostic.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a6-persistence-write-index-read-index">
<h3>A6) Persistence — <code class="docutils literal notranslate"><span class="pre">write_index</span></code> / <code class="docutils literal notranslate"><span class="pre">read_index</span></code><a class="headerlink" href="#a6-persistence-write-index-read-index" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Save CPU index for fast reload; re‑clone to GPU at runtime.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">faiss</span><span class="o">.</span><span class="n">write_index</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="s2">&quot;/data/faiss/shard_000.idx&quot;</span><span class="p">)</span>          <span class="c1"># save CPU index (any type)</span>
<span class="n">idmap2</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="s2">&quot;/data/faiss/shard_000.idx&quot;</span><span class="p">)</span>         <span class="c1"># load CPU index</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Don’t save GPU indexes; reconstruct by cloning the CPU index on startup. Track paths and config in DuckDB (<code class="docutils literal notranslate"><span class="pre">faiss_indexes</span></code>).</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a7-range-search-range-search-a-k-a-radius-search">
<h3>A7) Range search — <code class="docutils literal notranslate"><span class="pre">range_search</span></code> (a.k.a. radius search)<a class="headerlink" href="#a7-range-search-range-search-a-k-a-radius-search" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Get all neighbors within a distance threshold instead of top‑K.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">radius</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># for cosine/IP, pick meaningful threshold on normalized vectors</span>
<span class="n">rs</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">RangeSearchResult</span><span class="p">(</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">idmap</span><span class="o">.</span><span class="n">range_search</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>

<span class="c1"># Extract result per query</span>
<span class="n">lims</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">lims</span><span class="p">,</span> <span class="n">rs</span><span class="o">.</span><span class="n">distances</span><span class="p">,</span> <span class="n">rs</span><span class="o">.</span><span class="n">labels</span>
<span class="k">for</span> <span class="n">qi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">qi</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="n">qi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">neigh_ids</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">neigh_dist</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Range search is less common for large‑scale serving, but handy for thresholded neighbor graphs.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a8-filtered-search-idselector-searchparametersivf">
<h3>A8) Filtered search — <code class="docutils literal notranslate"><span class="pre">IDSelector*</span></code> + <code class="docutils literal notranslate"><span class="pre">SearchParametersIVF</span></code><a class="headerlink" href="#a8-filtered-search-idselector-searchparametersivf" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Exclude/allow subsets of IDs at <strong>query time</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a selector (ids in [lo, hi))</span>
<span class="n">sel</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IDSelectorRange</span><span class="p">(</span><span class="n">lo</span><span class="o">=</span><span class="mi">100_000</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="mi">150_000</span><span class="p">)</span>

<span class="c1"># Tie selector to IVF search params</span>
<span class="n">sp</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">SearchParametersIVF</span><span class="p">()</span>
<span class="n">sp</span><span class="o">.</span><span class="n">nprobe</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">sp</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span>

<span class="c1"># Call the 3-arg search to pass params</span>
<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">idmap</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">sp</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>With cuVS‑backed GPU indexes enabled (<code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code> when cloning/constructing), FAISS converts these selectors into cuVS filters under the hood (your build includes the converter).</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a9-deletions-remove-ids">
<h3>A9) Deletions — <code class="docutils literal notranslate"><span class="pre">remove_ids</span></code><a class="headerlink" href="#a9-deletions-remove-ids" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Remove a set of IDs (e.g., retractions, updates).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">to_remove</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IDSelectorRange</span><span class="p">(</span><span class="mi">200_000</span><span class="p">,</span> <span class="mi">210_000</span><span class="p">)</span>  <span class="c1"># OR IDSelectorBatch([...])</span>
<span class="n">n_removed</span> <span class="o">=</span> <span class="n">idmap</span><span class="o">.</span><span class="n">remove_ids</span><span class="p">(</span><span class="n">to_remove</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>IVF/PQ structures become “holey” over time; periodic rebuilds (or re‑add to a fresh shard) keep performance consistent.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="a10-reconstruction-reconstruct-reconstruct-n">
<h3>A10) Reconstruction — <code class="docutils literal notranslate"><span class="pre">reconstruct</span></code>, <code class="docutils literal notranslate"><span class="pre">reconstruct_n</span></code><a class="headerlink" href="#a10-reconstruction-reconstruct-reconstruct-n" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Retrieve vector approximations (exact for Flat/HNSW; approximate for PQ).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vec</span> <span class="o">=</span> <span class="n">idmap</span><span class="o">.</span><span class="n">reconstruct</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">mat</span> <span class="o">=</span> <span class="n">idmap</span><span class="o">.</span><span class="n">reconstruct_n</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>   <span class="c1"># first 100 vectors</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="a11-cpu-parallelism-omp-set-num-threads">
<h3>A11) CPU parallelism — <code class="docutils literal notranslate"><span class="pre">omp_set_num_threads</span></code><a class="headerlink" href="#a11-cpu-parallelism-omp-set-num-threads" title="Link to this heading">#</a></h3>
<p><strong>Why:</strong> Pin thread count for CPU add/search/training.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">faiss</span><span class="o">.</span><span class="n">omp_set_num_threads</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>  <span class="c1"># match your server threads</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="b-faiss-gpu-multigpu-functions-deeper-with-cuvs-enablement">
<h2>B) FAISS — GPU &amp; multi‑GPU functions (deeper, with cuVS enablement)<a class="headerlink" href="#b-faiss-gpu-multigpu-functions-deeper-with-cuvs-enablement" title="Link to this heading">#</a></h2>
<blockquote>
<div><p><strong>Reminder</strong>: In your wheel, FAISS GPU indexes can dispatch to <strong>cuVS</strong> for <strong>Flat, IVF‑Flat, IVF‑PQ, CAGRA, Binary‑CAGRA</strong> when you set <code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code> on the <strong>GPU cloner</strong> or the <strong>GPU index config</strong>, and the cuVS libraries are preloaded.</p>
</div></blockquote>
<section id="b1-cpugpu-cloning-single-multigpu">
<h3>B1) CPU→GPU cloning (single &amp; multi‑GPU)<a class="headerlink" href="#b1-cpugpu-cloning-single-multigpu" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>

<span class="c1"># 1) Single GPU (cuVS-first, safe fallback)</span>
<span class="n">co</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuClonerOptions</span><span class="p">();</span> <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">gpu_index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
    <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gpu_index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>

<span class="c1"># 2) Replicated (QPS-scale)</span>
<span class="n">ngpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">get_num_gpus</span><span class="p">()</span>
<span class="n">resources</span> <span class="o">=</span> <span class="p">[</span><span class="n">faiss</span><span class="o">.</span><span class="n">StandardGpuResources</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngpu</span><span class="p">)]</span>
<span class="n">replicas</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexReplicas</span><span class="p">()</span>
<span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngpu</span><span class="p">):</span>
    <span class="n">replicas</span><span class="o">.</span><span class="n">addIndex</span><span class="p">(</span><span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">resources</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">dev</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="n">co</span><span class="p">))</span>

<span class="c1"># 3) Sharded (capacity-scale)</span>
<span class="n">shards</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexShards</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">threaded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">successive_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># Build per-shard CPU indexes first, then clone each with co.use_cuvs=True and add to &#39;shards&#39;</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Replicas improve QPS; shards expand capacity; wrap both under one logical index in your registry and fan‑out search.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="b2-direct-gpu-constructors-with-gpuindex-config-use-cuvs">
<h3>B2) Direct GPU constructors with <code class="docutils literal notranslate"><span class="pre">GpuIndex*Config.use_cuvs</span></code><a class="headerlink" href="#b2-direct-gpu-constructors-with-gpuindex-config-use-cuvs" title="Link to this heading">#</a></h3>
<p><strong>Flat</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexFlatConfig</span><span class="p">();</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gpu_flat</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexFlatIP</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>IVF‑Flat / IVF‑PQ</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ivf_cfg</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuIndexIVFConfig</span><span class="p">();</span> <span class="n">ivf_cfg</span><span class="o">.</span><span class="n">use_cuvs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># Pass ivf_cfg to the appropriate GpuIndexIVF* constructor for your metric/quantizer</span>
</pre></div>
</div>
<p><strong>CAGRA</strong> (graph ANN)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prefer CPU→GPU cloning unless you need specific GPU-only build options.</span>
<span class="c1"># If constructing directly, set the config that inherits GpuIndexConfig:</span>
<span class="c1"># cagra_cfg = faiss.GpuIndexCagraConfig(); cagra_cfg.use_cuvs = True</span>
<span class="c1"># gpu_cagra = faiss.GpuIndexCagra(res, d, cagra_cfg)</span>
</pre></div>
</div>
<p><strong>Binary‑CAGRA</strong></p>
<ul class="simple">
<li><p>Use the <strong>cloner</strong> (<code class="docutils literal notranslate"><span class="pre">GpuClonerOptions.use_cuvs=True</span></code>) when moving from CPU binary graph indexes to GPU.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="b3-gpu-distance-primitives-bfknn-knn-gpu-bfknn">
<h3>B3) GPU distance primitives — bfKNN (<code class="docutils literal notranslate"><span class="pre">knn_gpu</span></code>/<code class="docutils literal notranslate"><span class="pre">bfKnn</span></code>)<a class="headerlink" href="#b3-gpu-distance-primitives-bfknn-knn-gpu-bfknn" title="Link to this heading">#</a></h3>
<p><strong>Exact GPU kNN</strong> (cuVS‑aware):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuDistanceParams</span><span class="p">();</span> <span class="n">params</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span>
<span class="n">params</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">params</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="n">d</span>
<span class="n">use_cuvs</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">faiss</span><span class="o">.</span><span class="n">should_use_cuvs</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>     <span class="c1"># central probe, then:</span>

<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">knn_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">xq</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">xb</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                     <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">,</span> <span class="n">use_cuvs</span><span class="o">=</span><span class="n">use_cuvs</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Your build routes bfKNN to cuVS when possible; otherwise FAISS kernels are used. Preload cuVS so the probe can return True when viable.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="b4-gpu-tuning-knobs-gpuparameterspace-configs">
<h3>B4) GPU tuning knobs — <code class="docutils literal notranslate"><span class="pre">GpuParameterSpace</span></code> &amp; configs<a class="headerlink" href="#b4-gpu-tuning-knobs-gpuparameterspace-configs" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GpuParameterSpace.set_index_parameter(gpu_index,</span> <span class="pre">&quot;nprobe&quot;,</span> <span class="pre">64)</span></code> — uniform way to set IVF probes.</p></li>
<li><p>IVFPQ config highlights:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">usePrecomputedTables</span></code> — faster scans at higher memory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">useFloat16LookupTables</span></code> — lower memory, slight precision trade‑off; useful for large <code class="docutils literal notranslate"><span class="pre">m</span></code> or tight VRAM budgets.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="c-faiss-contrib-helpers-youll-likely-use">
<h2>C) FAISS contrib helpers you’ll likely use<a class="headerlink" href="#c-faiss-contrib-helpers-youll-likely-use" title="Link to this heading">#</a></h2>
<p><em>(These ship in the python package and are handy for pipelines.)</em></p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">contrib.factory_tools</span></code></strong> — convenience builders &amp; validators for factory strings.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">contrib.ivf_tools</span></code></strong> — IVF diagnostics, centroid utilities.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">contrib.big_batch_search</span></code></strong> — large‑batch search helpers to pipeline host↔device copies.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">contrib.ondisk</span></code></strong> — on‑disk inverted lists for huge CPU‑side corpora.</p></li>
</ul>
<p>Use them to simplify scripts; your production path should still keep <strong>CPU index persisted + GPU clone</strong> at runtime as the source of truth.</p>
</section>
<hr class="docutils" />
<section id="d-cuvs-functions-modules-we-hadnt-exemplified-now-with-code">
<h2>D) cuVS — functions &amp; modules we hadn’t exemplified (now with code)<a class="headerlink" href="#d-cuvs-functions-modules-we-hadnt-exemplified-now-with-code" title="Link to this heading">#</a></h2>
<blockquote>
<div><p>cuVS runs <strong>entirely on GPU</strong> with a consistent <code class="docutils literal notranslate"><span class="pre">build</span> <span class="pre">/</span> <span class="pre">extend</span> <span class="pre">/</span> <span class="pre">search</span> <span class="pre">/</span> <span class="pre">save</span> <span class="pre">/</span> <span class="pre">load</span></code> shape per algorithm. Provide a <code class="docutils literal notranslate"><span class="pre">Resources</span></code> handle to share a stream and avoid implicit syncs; pass <strong>device arrays</strong> for best performance.</p>
</div></blockquote>
<section id="d1-neighbors-brute-force-exact-knn-baseline-qa">
<h3>D1) <code class="docutils literal notranslate"><span class="pre">neighbors.brute_force</span></code> — exact kNN (baseline &amp; QA)<a class="headerlink" href="#d1-neighbors-brute-force-exact-knn-baseline-qa" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resources</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">brute_force</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pylibraft.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">device_ndarray</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">Resources</span><span class="p">()</span>
<span class="n">xb</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">xq</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,</span>    <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="n">index</span> <span class="o">=</span> <span class="n">brute_force</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">brute_force</span><span class="o">.</span><span class="n">IndexParams</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s2">&quot;sqeuclidean&quot;</span><span class="p">),</span> <span class="n">xb</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="n">D</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
<span class="n">brute_force</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">brute_force</span><span class="o">.</span><span class="n">SearchParams</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s2">&quot;sqeuclidean&quot;</span><span class="p">),</span>
                   <span class="n">index</span><span class="p">,</span> <span class="n">xq</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">distances</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Incremental ingest</span>
<span class="n">xb2</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">200_000</span><span class="p">,</span> <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">brute_force</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">xb2</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Persistence</span>
<span class="n">brute_force</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;/tmp/cuvs_bruteforce.idx&quot;</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">brute_force</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/tmp/cuvs_bruteforce.idx&quot;</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Good for <strong>ground truth</strong> during tuning and for small datasets.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="d2-neighbors-ivf-flat-faisslike-ivf-on-gpu">
<h3>D2) <code class="docutils literal notranslate"><span class="pre">neighbors.ivf_flat</span></code> — FAISS‑like IVF on GPU<a class="headerlink" href="#d2-neighbors-ivf-flat-faisslike-ivf-on-gpu" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ivf_flat</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">Resources</span><span class="p">()</span>
<span class="n">xb</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,</span> <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">xq</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,</span>  <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="n">idx</span> <span class="o">=</span> <span class="n">ivf_flat</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">ivf_flat</span><span class="o">.</span><span class="n">IndexParams</span><span class="p">(</span><span class="n">n_lists</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;sqeuclidean&quot;</span><span class="p">),</span> <span class="n">xb</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="n">D</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
<span class="n">ivf_flat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ivf_flat</span><span class="o">.</span><span class="n">SearchParams</span><span class="p">(</span><span class="n">n_probes</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">xq</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">distances</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Add more</span>
<span class="n">ivf_flat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">5_000</span><span class="p">,</span> <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Save / load</span>
<span class="n">ivf_flat</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;/tmp/cuvs_ivfflat.idx&quot;</span><span class="p">)</span>
<span class="n">idx2</span> <span class="o">=</span> <span class="n">ivf_flat</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/tmp/cuvs_ivfflat.idx&quot;</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Parameter names mirror FAISS concepts: <code class="docutils literal notranslate"><span class="pre">n_lists</span></code>, <code class="docutils literal notranslate"><span class="pre">n_probes</span></code>, metric.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="d3-neighbors-ivf-pq-ivf-with-product-quantization">
<h3>D3) <code class="docutils literal notranslate"><span class="pre">neighbors.ivf_pq</span></code> — IVF with Product Quantization<a class="headerlink" href="#d3-neighbors-ivf-pq-ivf-with-product-quantization" title="Link to this heading">#</a></h3>
<p><em>(We’d shown build/search before; here’s <code class="docutils literal notranslate"><span class="pre">extend/save/load</span></code> and host output conversion.)</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ivf_pq</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">Resources</span><span class="p">()</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">ivf_pq</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">ivf_pq</span><span class="o">.</span><span class="n">IndexParams</span><span class="p">(</span><span class="n">n_lists</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;sqeuclidean&quot;</span><span class="p">,</span> <span class="n">pq_bits</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
                   <span class="n">xb</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Extend incrementally</span>
<span class="n">ivf_pq</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">20_000</span><span class="p">,</span> <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Search to host arrays (optional)</span>
<span class="n">D_dev</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">I_dev</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
<span class="n">ivf_pq</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ivf_pq</span><span class="o">.</span><span class="n">SearchParams</span><span class="p">(</span><span class="n">n_probes</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">xq</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">distances</span><span class="o">=</span><span class="n">D_dev</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="n">I_dev</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">D_host</span><span class="p">,</span> <span class="n">I_host</span> <span class="o">=</span> <span class="n">D_dev</span><span class="o">.</span><span class="n">copy_to_host</span><span class="p">(),</span> <span class="n">I_dev</span><span class="o">.</span><span class="n">copy_to_host</span><span class="p">()</span>

<span class="c1"># Save / load</span>
<span class="n">ivf_pq</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;/tmp/cuvs_ivfpq.idx&quot;</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">ivf_pq</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/tmp/cuvs_ivfpq.idx&quot;</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="d4-neighbors-cagra-highrecall-graph-ann">
<h3>D4) <code class="docutils literal notranslate"><span class="pre">neighbors.cagra</span></code> — high‑recall graph ANN<a class="headerlink" href="#d4-neighbors-cagra-highrecall-graph-ann" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">cagra</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">Resources</span><span class="p">()</span>
<span class="n">xb</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2_000_000</span><span class="p">,</span> <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">xq</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">20_000</span><span class="p">,</span>    <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="n">idx</span> <span class="o">=</span> <span class="n">cagra</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">cagra</span><span class="o">.</span><span class="n">IndexParams</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s2">&quot;sqeuclidean&quot;</span><span class="p">),</span> <span class="n">xb</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="n">D</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
<span class="n">cagra</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cagra</span><span class="o">.</span><span class="n">SearchParams</span><span class="p">(),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">xq</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">distances</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Extend / persist</span>
<span class="n">cagra</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">device_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100_000</span><span class="p">,</span> <span class="mi">2560</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">cagra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;/tmp/cuvs_cagra.idx&quot;</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">cagra</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/tmp/cuvs_cagra.idx&quot;</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>CAGRA is excellent for tight latency at high recall; memory‑heavier than PQ. Use it for premium tiers.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="d5-neighbors-hnsw">
<h3>D5) <code class="docutils literal notranslate"><span class="pre">neighbors.hnsw</span></code><a class="headerlink" href="#d5-neighbors-hnsw" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">hnsw</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">Resources</span><span class="p">()</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">hnsw</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">hnsw</span><span class="o">.</span><span class="n">IndexParams</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s2">&quot;sqeuclidean&quot;</span><span class="p">),</span> <span class="n">xb</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">hnsw</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hnsw</span><span class="o">.</span><span class="n">SearchParams</span><span class="p">(),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">xq</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">distances</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">hnsw</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;/tmp/cuvs_hnsw.idx&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>A familiar graph ANN baseline on GPU. Pick either <strong>CAGRA</strong> (higher perf) or <strong>HNSW</strong> depending on constraints.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="d6-filters-refine-tiered-indexes-highlevel-patterns">
<h3>D6) Filters, refine, tiered indexes (high‑level patterns)<a class="headerlink" href="#d6-filters-refine-tiered-indexes-highlevel-patterns" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Filters</strong> — apply post‑search restrictions or pre‑filter candidates with <code class="docutils literal notranslate"><span class="pre">neighbors.filters</span></code> utilities (e.g., by ID set). Use them for <strong>policy constraints</strong> or <strong>tenancy</strong>.</p></li>
<li><p><strong>Refine</strong> — re‑score ANN candidates with an exact step (<code class="docutils literal notranslate"><span class="pre">neighbors.refine</span></code>) for <strong>accuracy boosts</strong>. Good when you need Flat re‑ranking on a subset.</p></li>
<li><p><strong>Tiered index</strong> — orchestrate multi‑stage pipelines (e.g., IVF‑PQ → refine) using <code class="docutils literal notranslate"><span class="pre">neighbors.tiered_index</span></code> helpers.</p></li>
</ul>
<p><em>(Function names follow the <code class="docutils literal notranslate"><span class="pre">build/search/extend/save/load</span></code> theme; wire them like the examples above.)</em></p>
</section>
<hr class="docutils" />
<section id="d7-multigpu-neighbors-mg-distributed-ivfpq-ivfflat-cagra">
<h3>D7) Multi‑GPU (<code class="docutils literal notranslate"><span class="pre">neighbors.mg</span></code>) — <strong>distributed IVF‑PQ / IVF‑Flat / CAGRA</strong><a class="headerlink" href="#d7-multigpu-neighbors-mg-distributed-ivfpq-ivfflat-cagra" title="Link to this heading">#</a></h3>
<p><strong>Conceptual usage</strong> (keep the same <code class="docutils literal notranslate"><span class="pre">Resources</span></code> concept per device and use NCCL):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.neighbors.mg</span><span class="w"> </span><span class="kn">import</span> <span class="n">ivf_pq</span> <span class="k">as</span> <span class="n">mg_ivfpq</span>
<span class="c1"># Build: mg_ivfpq.build(mg_ivfpq.IndexParams(...), dataset_per_gpu, resources=handles_per_gpu)</span>
<span class="c1"># Search: mg_ivfpq.search(..., k=..., resources=handles_per_gpu)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Requires NCCL. Use this path when one GPU’s memory is insufficient or you need cluster‑like throughput while staying on a single multi‑GPU box.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="d8-distance-pairwise-distance-gpu-distance-matrix">
<h3>D8) <code class="docutils literal notranslate"><span class="pre">distance.pairwise_distance</span></code> — GPU distance matrix<a class="headerlink" href="#d8-distance-pairwise-distance-gpu-distance-matrix" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cuvs</span><span class="w"> </span><span class="kn">import</span> <span class="n">distance</span>
<span class="n">Dx</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">pairwise_distance</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;sqeuclidean&quot;</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>  <span class="c1"># Dx on device by default</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Handy for diagnostics, unit tests, or custom scoring layers.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="d9-cluster-kmeans-gpu-kmeans-centers-predict-cost">
<h3>D9) <code class="docutils literal notranslate"><span class="pre">cluster.kmeans</span></code> — GPU KMeans (centers, predict, cost)<a class="headerlink" href="#d9-cluster-kmeans-gpu-kmeans-centers-predict-cost" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">kmeans</span>

<span class="n">centers</span><span class="p">,</span> <span class="n">inertia</span><span class="p">,</span> <span class="n">n_iters</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">KMeansParams</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">8192</span><span class="p">),</span> <span class="n">xb</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="n">cost</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_cost</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Use for <strong>custom IVF training</strong> or other clustering tasks; interoperates with device arrays.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="e-libcuvs-loader-functions-env-youll-use-in-code">
<h2>E) libcuvs loader — functions &amp; env you’ll use in code<a class="headerlink" href="#e-libcuvs-loader-functions-env-youll-use-in-code" title="Link to this heading">#</a></h2>
<blockquote>
<div><p>Preload cuVS and RAPIDS libs <strong>once per process</strong> before any FAISS/cuVS calls to guarantee symbol resolution and allocator setup.</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libcuvs</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_library</span>
<span class="n">handles</span> <span class="o">=</span> <span class="n">load_library</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">_name</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">])</span>  <span class="c1"># libcuvs.so, libcuvs_c.so, librmm.so, rapids_logger.so</span>
</pre></div>
</div>
<p><strong>Environment knobs</strong> (optional):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RAPIDS_LIBCUVS_PREFER_SYSTEM_LIBRARY=true</span></code> → prefer system libs over wheel‑bundled copies.</p></li>
<li><p>HybridSearch’s <code class="docutils literal notranslate"><span class="pre">_ensure_cuvs_loader_path()</span></code> adds all <code class="docutils literal notranslate"><span class="pre">lib64/</span></code> dirs to <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> for child processes (inheritance is useful for workers).</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="f-endtoend-patterns-that-combine-the-above">
<h2>F) End‑to‑end patterns that combine the above<a class="headerlink" href="#f-endtoend-patterns-that-combine-the-above" title="Link to this heading">#</a></h2>
<section id="f1-filtered-refined-ivfpq-on-gpu-with-cuvs">
<h3>F1) <strong>Filtered, refined IVF‑PQ</strong> on GPU with cuVS<a class="headerlink" href="#f1-filtered-refined-ivfpq-on-gpu-with-cuvs" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 0) Preload cuVS (once)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libcuvs</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_library</span><span class="p">;</span> <span class="n">load_library</span><span class="p">()</span>                               <span class="c1"># loader. :contentReference[oaicite:25]{index=25}</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">d</span><span class="o">=</span><span class="mi">2560</span>
<span class="n">cpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_factory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;OPQ64,IVF8192,PQ64&quot;</span><span class="p">,</span> <span class="n">faiss</span><span class="o">.</span><span class="n">METRIC_INNER_PRODUCT</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">);</span> <span class="n">faiss</span><span class="o">.</span><span class="n">normalize_L2</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">cpu</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="c1"># ID map to carry your IDs</span>
<span class="n">idmap</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexIDMap2</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
<span class="n">xb</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20_000_000</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">);</span> <span class="n">faiss</span><span class="o">.</span><span class="n">normalize_L2</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
<span class="n">idmap</span><span class="o">.</span><span class="n">add_with_ids</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

<span class="c1"># Clone to GPU with cuVS enabled (fallback safe)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">StandardGpuResources</span><span class="p">();</span> <span class="n">res</span><span class="o">.</span><span class="n">setTempMemory</span><span class="p">(</span><span class="mi">1_200_000_000</span><span class="p">);</span> <span class="n">res</span><span class="o">.</span><span class="n">setPinnedMemory</span><span class="p">(</span><span class="mi">512_000_000</span><span class="p">)</span>
<span class="n">co</span>  <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">GpuClonerOptions</span><span class="p">();</span> <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span><span class="o">=</span><span class="kc">True</span>
<span class="k">try</span><span class="p">:</span> <span class="n">gpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
    <span class="n">co</span><span class="o">.</span><span class="n">use_cuvs</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">gpu</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">index_cpu_to_gpu</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>

<span class="c1"># Filter: only IDs in a range, then search &amp; refine</span>
<span class="n">sp</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">SearchParametersIVF</span><span class="p">();</span> <span class="n">sp</span><span class="o">.</span><span class="n">nprobe</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="n">sp</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IDSelectorRange</span><span class="p">(</span><span class="mi">100_000</span><span class="p">,</span> <span class="mi">500_000</span><span class="p">)</span>
<span class="n">refiner</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexRefineFlat</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span> <span class="n">refiner</span><span class="o">.</span><span class="n">kfactor</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">xq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">);</span> <span class="n">faiss</span><span class="o">.</span><span class="n">normalize_L2</span><span class="p">(</span><span class="n">xq</span><span class="p">)</span>
<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">sp</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Why this works well for you</strong></p>
<ul class="simple">
<li><p>Cosine via normalization + IP (2560‑d per architecture).</p></li>
<li><p>cuVS path engaged for IVF‑PQ when available; otherwise FAISS kernels.</p></li>
<li><p>Filter converted to cuVS filter internally in your build.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="f2-direct-cuvs-multigpu-ivfpq-outline">
<h3>F2) <strong>Direct cuVS</strong> multi‑GPU IVF‑PQ (outline)<a class="headerlink" href="#f2-direct-cuvs-multigpu-ivfpq-outline" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pseudocode outline (patterns match single-GPU examples; use mg.ivf_pq)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cuvs.neighbors.mg</span><span class="w"> </span><span class="kn">import</span> <span class="n">ivf_pq</span> <span class="k">as</span> <span class="n">mg_ivfpq</span>
<span class="c1"># handles = [Resources() per GPU]; datasets split per GPU as device arrays</span>
<span class="c1"># idx = mg_ivfpq.build(mg_ivfpq.IndexParams(n_lists=8192, metric=&quot;sqeuclidean&quot;, pq_bits=8),</span>
<span class="c1">#                      datasets, resources=handles)</span>
<span class="c1"># mg_ivfpq.search(mg_ivfpq.SearchParams(n_probes=64), idx, queries, k=10,</span>
<span class="c1">#                 distances=..., neighbors=..., resources=handles)</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p>Reach for multi‑GPU cuVS when a single GPU’s VRAM is the bottleneck.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="g-quick-checklist-for-agents-so-you-dont-miss-a-function-again">
<h2>G) Quick checklist for agents (so you don’t miss a function again)<a class="headerlink" href="#g-quick-checklist-for-agents-so-you-dont-miss-a-function-again" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Always normalize</strong> embeddings for cosine/IP.</p></li>
<li><p>Use <strong><code class="docutils literal notranslate"><span class="pre">IndexIDMap2</span></code></strong> to own IDs; <strong><code class="docutils literal notranslate"><span class="pre">IndexRefineFlat</span></code></strong> when you need exact re‑ranking.</p></li>
<li><p>Set knobs with <strong><code class="docutils literal notranslate"><span class="pre">ParameterSpace</span></code> / <code class="docutils literal notranslate"><span class="pre">GpuParameterSpace</span></code></strong>.</p></li>
<li><p>For <strong>filters</strong>, use <strong><code class="docutils literal notranslate"><span class="pre">IDSelector*</span></code></strong> + <code class="docutils literal notranslate"><span class="pre">SearchParametersIVF</span></code>; your build converts to cuVS automatically when cuVS is enabled.</p></li>
<li><p>Persist <strong>CPU</strong> index with <code class="docutils literal notranslate"><span class="pre">write_index</span></code>; <strong>re‑clone</strong> to GPU on startup.</p></li>
<li><p>Preload cuVS (<code class="docutils literal notranslate"><span class="pre">libcuvs.load_library()</span></code>), then set <strong><code class="docutils literal notranslate"><span class="pre">use_cuvs=True</span></code></strong> on <strong>cloner/config</strong> for <strong>Flat, IVF‑Flat, IVF‑PQ, CAGRA, Binary‑CAGRA</strong>; guard with try/except or <code class="docutils literal notranslate"><span class="pre">should_use_cuvs</span></code> for <strong>bfKNN</strong>.</p></li>
<li><p>For <strong>direct cuVS</strong>: use <code class="docutils literal notranslate"><span class="pre">build/extend/search/save/load</span></code> in <code class="docutils literal notranslate"><span class="pre">neighbors.{ivf_flat,</span> <span class="pre">ivf_pq,</span> <span class="pre">cagra,</span> <span class="pre">hnsw,</span> <span class="pre">brute_force}</span></code> with <strong>device arrays</strong> and a shared <strong><code class="docutils literal notranslate"><span class="pre">Resources</span></code></strong> handle.</p></li>
<li><p>Keep defaults from the architecture doc (2560‑d, <code class="docutils literal notranslate"><span class="pre">OPQ64,IVF8192,PQ64</span></code>, <code class="docutils literal notranslate"><span class="pre">nprobe=64</span></code>, shards ≤10 M vectors).</p></li>
</ul>
<hr class="docutils" />
<p>If you want, I can also package these into a <strong>reference Jupyter notebook</strong> that runs each snippet end‑to‑end (with small synthetic data) and prints sanity checks (dimensions, top‑K shapes, cuVS enabled flags).</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="251025_HighLevelArchitecture.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Implementation-Grade Architecture Overview</p>
      </div>
    </a>
    <a class="right-next"
       href="numpy-docstring-migration.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Migration: Strict NumPy Docstring Compliance</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Updated cuVS Addendum</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#revised-capability-matrix-this-wheel">1) Revised capability matrix (this wheel)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-enable-cuvs-reliable-patterns">2) How to enable cuVS (reliable patterns)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#oneline-preload-cuvs-rapids-libs">2.1. One‑line preload (cuVS/RAPIDS libs)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#enabling-cuvs-via-gpu-cloner-options-recommended">2.2. Enabling cuVS via <strong>GPU Cloner Options</strong> (recommended)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#enabling-cuvs-via-index-configs-direct-gpu-constructors">2.3. Enabling cuVS via <strong>index configs</strong> (direct GPU constructors)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#enabling-cuvs-for-direct-gpu-bruteforce-knn">2.4. Enabling cuVS for <strong>direct GPU brute‑force kNN</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#minimal-correct-by-construction-recipes-per-family">3) Minimal “correct by construction” recipes per family</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ivfpq-opq64-ivf8192-pq64-with-cuvs">3.1. <strong>IVF‑PQ (OPQ64,IVF8192,PQ64)</strong> with cuVS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ivfflat-with-cuvs">3.2. <strong>IVF‑Flat</strong> with cuVS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flat-exact-with-cuvs">3.3. <strong>Flat (exact)</strong> with cuVS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cagra-with-cuvs">3.4. <strong>CAGRA</strong> with cuVS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#binarycagra-with-cuvs">3.5. <strong>Binary‑CAGRA</strong> with cuVS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#filters-selectors-what-those-cuvsfilter-objects-mean-for-you">4) Filters &amp; selectors (what those <code class="docutils literal notranslate"><span class="pre">CuvsFilter*</span></code> objects mean for you)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#operational-reminders-unchanged-but-critical">5) Operational reminders (unchanged but critical)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-am-i-using-cuvs-right-now-probes">6) Quick “am I using cuVS right now?” probes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pointers-unchanged">Pointers (unchanged)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bottom-line-what-to-change-in-your-code">7) Bottom line (what to change in your code)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#addendum-base-content-on-faiss-gpu-library">addendum, base content on faiss gpu library</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-changed-vs-the-prior-wheel-and-how-to-think-about-it">0) What changed vs. the prior wheel (and how to think about it)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cpu-vs-gpu-vs-cuvs-updated-capability-map-this-wheel">1) CPU vs GPU vs cuVS — updated capability map (this wheel)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#blackwell-rtx-5090-support-sass-sm-120-ptx-sm-120virtual">2) Blackwell (RTX 5090) support: SASS <strong><code class="docutils literal notranslate"><span class="pre">sm_120</span></code></strong> + PTX <strong><code class="docutils literal notranslate"><span class="pre">sm_120‑virtual</span></code></strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cuvs-enablement-model-final-patterns">3) cuVS enablement model (final patterns)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bestinclass-faiss-build-on-rtx-5090-cosine-2560d-now-with-cuvs-toggles">4) “Best‑in‑class” FAISS build on RTX 5090 (cosine, 2560‑d) — <strong>now with cuVS toggles</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-call-cuvs-directly-and-when-faiss-cuvs-is-enough">5) When to call cuVS directly (and when FAISS+cuVS is enough)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-api-map-what-youll-call-most-often">6) Quick API map — <strong>what you’ll call most often</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#validation-checklist-runtime">7) Validation checklist (runtime)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#operational-guidance-unchanged-principles-cuvsaware">8) Operational guidance (unchanged principles, cuVS‑aware)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#readytopaste-helpers-with-cuvs-autoengage">9) Ready‑to‑paste helpers (with cuVS auto‑engage)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bottom-line">10) Bottom line</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#addendum-agentoriented-details-updated-to-match-the-new-cuvs-coverage">Addendum — Agent‑oriented details (updated to match the new cuVS coverage)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a1-process-bootstrap-deterministic-cuvsready">A1. Process bootstrap (deterministic &amp; cuVS‑ready)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a2-zerocopy-interop-faiss-cuvs">A2. Zero‑copy interop (FAISS ↔ cuVS)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a3-multigpu-replicas-and-shards-unchanged">A3. Multi‑GPU: replicas and shards (unchanged)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a4-memory-planning-batching">A4. Memory planning &amp; batching</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a5-persistence-registry">A5. Persistence &amp; registry</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a6-observability-probes">A6. Observability &amp; probes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a7-failure-taxonomy-fallbacks-gpu-paths">A7. Failure taxonomy &amp; fallbacks (GPU paths)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a8-direct-cuvs-catalog-unchanged-surfaces">A8. Direct cuVS catalog (unchanged surfaces)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a9-architecture-defaults-for-the-broader-system">A9. Architecture defaults (for the broader system)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-faiss-cpuside-classes-utilities-with-examples">A) FAISS — CPU‑side classes &amp; utilities (with examples)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a1-indexidmap-indexidmap2-stable-ids-around-any-index">A1) <code class="docutils literal notranslate"><span class="pre">IndexIDMap</span></code> / <code class="docutils literal notranslate"><span class="pre">IndexIDMap2</span></code> — stable IDs around any index</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a2-indexrefineflat-refine-ann-hits-with-exact-scoring">A2) <code class="docutils literal notranslate"><span class="pre">IndexRefineFlat</span></code> — refine ANN hits with exact scoring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a3-indexpretransform-transforms-opqmatrix-pcamatrix">A3) <code class="docutils literal notranslate"><span class="pre">IndexPreTransform</span></code> + transforms (<code class="docutils literal notranslate"><span class="pre">OPQMatrix</span></code>, <code class="docutils literal notranslate"><span class="pre">PCAMatrix</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a4-clustering-kmeans-build-coarse-quantizers-explicitly">A4) <code class="docutils literal notranslate"><span class="pre">Clustering</span></code> (K‑means) — build coarse quantizers explicitly</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a5-parameterspace-gpuparameterspace-named-tuning-knobs">A5) <code class="docutils literal notranslate"><span class="pre">ParameterSpace</span></code> / <code class="docutils literal notranslate"><span class="pre">GpuParameterSpace</span></code> — named tuning knobs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a6-persistence-write-index-read-index">A6) Persistence — <code class="docutils literal notranslate"><span class="pre">write_index</span></code> / <code class="docutils literal notranslate"><span class="pre">read_index</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a7-range-search-range-search-a-k-a-radius-search">A7) Range search — <code class="docutils literal notranslate"><span class="pre">range_search</span></code> (a.k.a. radius search)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a8-filtered-search-idselector-searchparametersivf">A8) Filtered search — <code class="docutils literal notranslate"><span class="pre">IDSelector*</span></code> + <code class="docutils literal notranslate"><span class="pre">SearchParametersIVF</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a9-deletions-remove-ids">A9) Deletions — <code class="docutils literal notranslate"><span class="pre">remove_ids</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a10-reconstruction-reconstruct-reconstruct-n">A10) Reconstruction — <code class="docutils literal notranslate"><span class="pre">reconstruct</span></code>, <code class="docutils literal notranslate"><span class="pre">reconstruct_n</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a11-cpu-parallelism-omp-set-num-threads">A11) CPU parallelism — <code class="docutils literal notranslate"><span class="pre">omp_set_num_threads</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-faiss-gpu-multigpu-functions-deeper-with-cuvs-enablement">B) FAISS — GPU &amp; multi‑GPU functions (deeper, with cuVS enablement)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b1-cpugpu-cloning-single-multigpu">B1) CPU→GPU cloning (single &amp; multi‑GPU)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b2-direct-gpu-constructors-with-gpuindex-config-use-cuvs">B2) Direct GPU constructors with <code class="docutils literal notranslate"><span class="pre">GpuIndex*Config.use_cuvs</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b3-gpu-distance-primitives-bfknn-knn-gpu-bfknn">B3) GPU distance primitives — bfKNN (<code class="docutils literal notranslate"><span class="pre">knn_gpu</span></code>/<code class="docutils literal notranslate"><span class="pre">bfKnn</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b4-gpu-tuning-knobs-gpuparameterspace-configs">B4) GPU tuning knobs — <code class="docutils literal notranslate"><span class="pre">GpuParameterSpace</span></code> &amp; configs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-faiss-contrib-helpers-youll-likely-use">C) FAISS contrib helpers you’ll likely use</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#d-cuvs-functions-modules-we-hadnt-exemplified-now-with-code">D) cuVS — functions &amp; modules we hadn’t exemplified (now with code)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d1-neighbors-brute-force-exact-knn-baseline-qa">D1) <code class="docutils literal notranslate"><span class="pre">neighbors.brute_force</span></code> — exact kNN (baseline &amp; QA)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d2-neighbors-ivf-flat-faisslike-ivf-on-gpu">D2) <code class="docutils literal notranslate"><span class="pre">neighbors.ivf_flat</span></code> — FAISS‑like IVF on GPU</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d3-neighbors-ivf-pq-ivf-with-product-quantization">D3) <code class="docutils literal notranslate"><span class="pre">neighbors.ivf_pq</span></code> — IVF with Product Quantization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d4-neighbors-cagra-highrecall-graph-ann">D4) <code class="docutils literal notranslate"><span class="pre">neighbors.cagra</span></code> — high‑recall graph ANN</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d5-neighbors-hnsw">D5) <code class="docutils literal notranslate"><span class="pre">neighbors.hnsw</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d6-filters-refine-tiered-indexes-highlevel-patterns">D6) Filters, refine, tiered indexes (high‑level patterns)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d7-multigpu-neighbors-mg-distributed-ivfpq-ivfflat-cagra">D7) Multi‑GPU (<code class="docutils literal notranslate"><span class="pre">neighbors.mg</span></code>) — <strong>distributed IVF‑PQ / IVF‑Flat / CAGRA</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d8-distance-pairwise-distance-gpu-distance-matrix">D8) <code class="docutils literal notranslate"><span class="pre">distance.pairwise_distance</span></code> — GPU distance matrix</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d9-cluster-kmeans-gpu-kmeans-centers-predict-cost">D9) <code class="docutils literal notranslate"><span class="pre">cluster.kmeans</span></code> — GPU KMeans (centers, predict, cost)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#e-libcuvs-loader-functions-env-youll-use-in-code">E) libcuvs loader — functions &amp; env you’ll use in code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#f-endtoend-patterns-that-combine-the-above">F) End‑to‑end patterns that combine the above</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f1-filtered-refined-ivfpq-on-gpu-with-cuvs">F1) <strong>Filtered, refined IVF‑PQ</strong> on GPU with cuVS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f2-direct-cuvs-multigpu-ivfpq-outline">F2) <strong>Direct cuVS</strong> multi‑GPU IVF‑PQ (outline)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#g-quick-checklist-for-agents-so-you-dont-miss-a-function-again">G) Quick checklist for agents (so you don’t miss a function again)</a></li>
</ul>
</li>
</ul>

  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/explanations/251025_FAISS_whl_overview.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>