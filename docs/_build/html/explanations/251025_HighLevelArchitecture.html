
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>0) Big picture (end‑to‑end, single‑box) &#8212; KGForge  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'explanations/251025_HighLevelArchitecture';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1) Revised capability matrix (this wheel)" href="251025_FAISS_whl_overview.html" />
    <link rel="prev" title="Explanations" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">KGForge  documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting-started.html">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to/index.html">
    How-to Guides
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../architecture/index.html">
    Architecture
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting-started.html">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to/index.html">
    How-to Guides
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../architecture/index.html">
    Architecture
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">0) Big picture (end‑to‑end, single‑box)</a></li>


























<li class="toctree-l1"><a class="reference internal" href="251025_FAISS_whl_overview.html">1) Revised capability matrix (this wheel)</a></li>








</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Explanations</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">0) Big picture (end‑to‑end, single‑box)</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p>Below is the <strong>fully elaborated, implementation‑grade architecture</strong> for your end‑to‑end, single‑machine system. It updates <strong>every topic</strong> from the original plan and adds all <strong>new constraints</strong> you set:</p>
<ul class="simple">
<li><p><strong>OS/Host</strong>: Ubuntu 24.04 (single box, no external servers).</p></li>
<li><p><strong>GPU</strong>: NVIDIA RTX 5090 (CUDA <strong>13.0</strong> toolchain).</p></li>
<li><p><strong>CPU/RAM</strong>: AMD 9950X (16 cores), 192 GB RAM.</p></li>
<li><p><strong>Python</strong>: <strong>3.13</strong>.</p></li>
<li><p><strong>PyTorch</strong>: <strong>2.9</strong> (CUDA 13 build).</p></li>
<li><p><strong>vLLM</strong>: latest <strong>pre‑release</strong> that supports CUDA 13.</p></li>
<li><p><strong>DuckDB</strong>: <strong>≥ 1.4.1</strong> (interpreting your “1.41” as <strong>1.4.1</strong>).</p></li>
<li><p><strong>Dense embeddings</strong>: <strong>Qwen3‑Embedding‑4B</strong> at <strong>2560‑dimensional</strong> output.</p></li>
<li><p><strong>Sparse embeddings</strong>: <strong>BM25</strong> + <strong>SPLADE‑v3</strong> (GPU).</p></li>
<li><p><strong>PDF→DocTags &amp; chunking</strong>: <strong>Docling VLM (Granite‑Docling)</strong> + <strong>Docling HybridChunker</strong>.</p></li>
<li><p><strong>All embeddings in Parquet</strong> (no JSONL at rest).</p></li>
<li><p><strong>Vector indexing &amp; ops</strong>: <strong>FAISS GPU</strong> with <strong>cuVS</strong> enabled.</p></li>
<li><p><strong>Model serving</strong>: a <strong>single logical endpoint</strong> fronting <strong>two local vLLM processes</strong> (Granite‑Docling VLM + Qwen3‑Embedding‑4B), routed by <strong>Nginx</strong> (necessary because one vLLM process ≙ one base model).</p></li>
<li><p><strong>Registry</strong>: all artifacts (PDFs, DocTags, chunks, embeddings, indices, ontologies, links) registered in local <strong>DuckDB</strong>.</p></li>
</ul>
<hr class="docutils" />
<section id="big-picture-endtoend-singlebox">
<h1>0) Big picture (end‑to‑end, single‑box)<a class="headerlink" href="#big-picture-endtoend-singlebox" title="Link to this heading">#</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Topic → (PyAlex) Harvest &amp; OA PDF Download (with fallbacks)
     → Docling VLM (Granite‑Docling) → DocTags
     → Docling HybridChunker → Chunk Parquet
     → Dense (Qwen3‑Embedding‑4B, 2560‑d via vLLM) → Parquet → FAISS (GPU, cuVS)
     → Sparse (SPLADE‑v3, GPU → Parquet → Lucene impact) + BM25 (Lucene)
     → Ontology ingest → Concept catalog + embeddings (dense 2560‑d + SPLADE)
     → Chunk–Concept linker → Assertions (Parquet) → KG (Neo4j local)
     → Hybrid search API (FAISS + BM25 + SPLADE + KG‑aware rerank)
     → Everything registered in DuckDB (≥1.4.1)
</pre></div>
</div>
<p><strong>Architectural style</strong>: <strong>Ports &amp; Adapters (Hexagonal)</strong> + <strong>Domain contracts</strong> (Pydantic v2) + <strong>Plugin registry</strong> (entry points) + <strong>Immutable, content‑addressed artifacts</strong>. All heavy compute runs <strong>locally</strong> (no remote compute/storage).</p>
</section>
<hr class="docutils" />
<section id="design-principles-concretized">
<h1>1) Design principles (concretized)<a class="headerlink" href="#design-principles-concretized" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>Interface‑first</strong>: every subsystem exposes an ABC (Abstract Base Class). Impl classes are pluggable via entry‑points.</p></li>
<li><p><strong>Encapsulation &amp; cohesion</strong>: one public façade per package; internals hidden. Each module owns a single concern.</p></li>
<li><p><strong>Idempotency</strong>: outputs keyed by <strong>content hashes</strong>; re‑runs never duplicate artifacts.</p></li>
<li><p><strong>Determinism</strong>: global <code class="docutils literal notranslate"><span class="pre">seed=42</span></code>, fixed training samples for FAISS, fixed chunking parameters.</p></li>
<li><p><strong>All embeddings in Parquet</strong>: columnar, compressed with <strong>ZSTD=6</strong>, <strong>row_group=4096</strong>; <strong>no JSONL</strong> persisted.</p></li>
<li><p><strong>Observability from day one</strong>: OpenTelemetry traces; structured logs with artifact IDs; Prometheus counters/histograms.</p></li>
<li><p><strong>Local‑only</strong>: no remote indices or vector DBs; FAISS, Pyserini, Neo4j, DuckDB all on the box.</p></li>
<li><p><strong>Security (local)</strong>: vLLM bound to localhost; Nginx fronts a single endpoint; API‑key auth for the search API.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="repository-layout-monorepo-independently-ownable-packages">
<h1>2) Repository layout (monorepo; independently ownable packages)<a class="headerlink" href="#repository-layout-monorepo-independently-ownable-packages" title="Link to this heading">#</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">src</span>
  <span class="o">/</span><span class="n">kgforge_common</span>            <span class="c1"># contracts, IDs, hashing, config, utils</span>
  <span class="o">/</span><span class="n">download</span>                  <span class="c1"># PyAlex harvester + OA PDF downloader + fallbacks</span>
  <span class="o">/</span><span class="n">docling</span>                   <span class="c1"># VLM convert-to-DocTags + HybridChunker wrappers</span>
  <span class="o">/</span><span class="n">embeddings_dense</span>          <span class="c1"># vLLM client, Qwen3-Embedding-4B (2560-d)</span>
  <span class="o">/</span><span class="n">embeddings_sparse</span>         <span class="c1"># SPLADE-v3 GPU encoder (Parquet) + BM25/SPLADE indices (Pyserini)</span>
  <span class="o">/</span><span class="n">vectorstore_faiss</span>         <span class="c1"># FAISS GPU/cuVS index build/search adapters</span>
  <span class="o">/</span><span class="n">ontology</span>                  <span class="c1"># OWL/OBO/SKOS loaders, normalization, concept embeddings</span>
  <span class="o">/</span><span class="n">linking</span>                   <span class="c1"># candidate gen, scoring, calibration, assertions</span>
  <span class="o">/</span><span class="n">kg_builder</span>                <span class="c1"># Neo4j adapter; nodes/edges upsert</span>
  <span class="o">/</span><span class="n">search_api</span>                <span class="c1"># FastAPI; hybrid retrieval + KG-aware rerank; OpenAPI</span>
  <span class="o">/</span><span class="n">orchestration</span>             <span class="c1"># Prefect flows &amp; CLI commands (local)</span>
  <span class="o">/</span><span class="n">registry</span>                  <span class="c1"># DuckDB schema, migrations, dataset registration</span>
  <span class="o">/</span><span class="n">observability</span>             <span class="c1"># OTEL + Prometheus exporters</span>
<span class="o">/</span><span class="n">tests</span>
<span class="o">/</span><span class="n">config</span>                      <span class="c1"># YAML config(s), ngnix.conf, systemd units</span>
<span class="o">/</span><span class="n">scripts</span>                     <span class="c1"># bootstrap &amp; build scripts (CUDA 13, FAISS+cuVS, vLLM)</span>
</pre></div>
</div>
<p><strong>Packaging</strong>: <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> (Poetry or uv). <strong>Entry‑points</strong> register providers:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[project.entry-points.kgforge.plugins]</span>
<span class="n">dense</span><span class="p">.</span><span class="n">qwen3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;embeddings_dense.qwen3:Qwen3Embedder&quot;</span>
<span class="n">sparse</span><span class="p">.</span><span class="n">splade_v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;embeddings_sparse.splade:SPLADEv3Encoder&quot;</span>
<span class="n">sparse</span><span class="p">.</span><span class="n">bm25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;embeddings_sparse.bm25:BM25Index&quot;</span>
<span class="n">docling</span><span class="p">.</span><span class="n">vlm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;docling.vlm:GraniteDoclingVLM&quot;</span>
<span class="n">chunker</span><span class="p">.</span><span class="n">docling_hybrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;docling.hybrid:HybridChunker&quot;</span>
<span class="n">vector</span><span class="p">.</span><span class="n">faiss_gpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;vectorstore_faiss.gpu:FaissGpuIndex&quot;</span>
<span class="n">graph</span><span class="p">.</span><span class="n">neo4j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kg_builder.neo4j:Neo4jStore&quot;</span>
<span class="n">ontology</span><span class="p">.</span><span class="n">loader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ontology.loader:OntologyLoader&quot;</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="core-data-contracts-pydantic-v2-contentaddressed-ids">
<h1>3) Core data contracts (Pydantic v2; content‑addressed IDs)<a class="headerlink" href="#core-data-contracts-pydantic-v2-contentaddressed-ids" title="Link to this heading">#</a></h1>
<blockquote>
<div><p>Keep models lean. Payloads (large text, vectors) live in Parquet files; rows refer to them via IDs.</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># kgforge_common/models.py (Python 3.13, Pydantic v2)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">AwareDatetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="n">Id</span> <span class="o">=</span> <span class="nb">str</span>  <span class="c1"># URN-like opaque IDs, stable and content-addressed</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Doc</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Id</span>                           <span class="c1"># urn:doc:sha256:&lt;16b&gt;</span>
    <span class="n">openalex_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">doi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">arxiv_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pmcid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">authors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pub_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># ISO8601</span>
    <span class="n">license</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">language</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;en&quot;</span>
    <span class="n">pdf_uri</span><span class="p">:</span> <span class="nb">str</span>                     <span class="c1"># local path (e.g., /data/pdfs/&lt;id&gt;.pdf)</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>                      <span class="c1"># &#39;openalex&#39;, &#39;arxiv&#39;, &#39;pmc&#39;, ...</span>
    <span class="n">content_hash</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># sha256 of canonical text (after DocTags-&gt;text)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">AwareDatetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DoctagsAsset</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">doc_id</span><span class="p">:</span> <span class="n">Id</span>
    <span class="n">doctags_uri</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># /data/doctags/&lt;doc_id&gt;.dt.json.zst</span>
    <span class="n">pages</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">vlm_model</span><span class="p">:</span> <span class="nb">str</span>                   <span class="c1"># granite-docling-258M</span>
    <span class="n">vlm_revision</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># &#39;untied&#39; if used</span>
    <span class="n">avg_logprob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">AwareDatetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Chunk</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Id</span>                           <span class="c1"># urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;</span>
    <span class="n">doc_id</span><span class="p">:</span> <span class="n">Id</span>
    <span class="n">section</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">start_char</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">end_char</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">doctags_span</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>     <span class="c1"># {node_id, start, end}</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">AwareDatetime</span>
    <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># backpointer to Parquet dataset</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DenseVectorMeta</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">chunk_id</span><span class="p">:</span> <span class="n">Id</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>                       <span class="c1"># &#39;Qwen3-Embedding-4B&#39;</span>
    <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span>                         <span class="c1"># 2560</span>
    <span class="n">l2_norm</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">AwareDatetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SparseVectorMeta</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">chunk_id</span><span class="p">:</span> <span class="n">Id</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>                       <span class="c1"># &#39;SPLADE-v3-distilbert&#39;</span>
    <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">nnz</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">AwareDatetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Concept</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Id</span>                           <span class="c1"># urn:concept:&lt;ontology&gt;:&lt;curie&gt;</span>
    <span class="n">ontology</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">pref_label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alt_labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">definition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LinkAssertion</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Id</span>                           <span class="c1"># urn:assert:&lt;chunk_id&gt;:&lt;concept_id&gt;@&lt;run_id&gt;</span>
    <span class="n">chunk_id</span><span class="p">:</span> <span class="n">Id</span>
    <span class="n">concept_id</span><span class="p">:</span> <span class="n">Id</span>
    <span class="n">score</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">decision</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">,</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span><span class="s1">&#39;uncertain&#39;</span><span class="p">]</span>
    <span class="n">evidence_span</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dense_sim, sparse_sim, lexical_overlap, depth_bonus</span>
    <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">AwareDatetime</span>
</pre></div>
</div>
<p><strong>ID scheme (deterministic)</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">doc_id</span> <span class="pre">=</span> <span class="pre">urn:doc:sha256:&lt;first16</span> <span class="pre">bytes</span> <span class="pre">of</span> <span class="pre">sha256</span> <span class="pre">canonical_text,</span> <span class="pre">base32&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chunk_id</span> <span class="pre">=</span> <span class="pre">urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dense</span> <span class="pre">vec</span> <span class="pre">id</span> <span class="pre">=</span> <span class="pre">urn:vec:&lt;chunk_id&gt;:qwen3&#64;&lt;run_id&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sparse</span> <span class="pre">id</span> <span class="pre">=</span> <span class="pre">urn:sparse:&lt;chunk_id&gt;:splade_v3&#64;&lt;run_id&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">concept</span> <span class="pre">id</span> <span class="pre">=</span> <span class="pre">urn:concept:&lt;ontology&gt;:&lt;curie&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertion</span> <span class="pre">id</span> <span class="pre">=</span> <span class="pre">urn:assert:&lt;chunk_id&gt;:&lt;concept_id&gt;&#64;&lt;run_id&gt;</span></code></p></li>
</ul>
</section>
<hr class="docutils" />
<section id="storage-layers-adapters-ports">
<h1>4) Storage layers &amp; adapters (ports)<a class="headerlink" href="#storage-layers-adapters-ports" title="Link to this heading">#</a></h1>
<p><strong>VectorStore (FAISS GPU + cuVS)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">VectorStore</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_vectors</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">vectors</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idmap_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idmap_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>SparseIndex</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SparseIndex</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs_iterable</span><span class="p">:</span> <span class="s2">&quot;Iterable[SparseDoc]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p>Implementations: <strong>BM25Index</strong> (Pyserini) and <strong>SpladeImpactIndex</strong> (Pyserini).</p>
<p><strong>GraphStore</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GraphStore</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Doc</span><span class="p">],</span> <span class="n">concepts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Concept</span><span class="p">],</span> <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chunk</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_mentions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LinkAssertion</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">linked_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Registry (DuckDB ≥1.4.1)</strong></p>
<ul class="simple">
<li><p>Provides <strong>DDL/migrations</strong>, <strong>safe registration</strong> (two‑phase commit: write Parquet → atomically register).</p></li>
<li><p>Exposes <strong>views</strong> across Parquet datasets (union_by_name).</p></li>
<li><p>Threading: default <strong>PRAGMA threads=14</strong>.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="orchestration-prefect-2-x-all-local">
<h1>5) Orchestration (Prefect 2.x; all local)<a class="headerlink" href="#orchestration-prefect-2-x-all-local" title="Link to this heading">#</a></h1>
<p><strong>Flows</strong> (idempotent, content‑hash keyed):</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">harvest_and_download(topic,</span> <span class="pre">years,</span> <span class="pre">max_works)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">convert_to_doctags(doc_ids[])</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chunk_with_docling(doc_ids[])</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embed_dense_qwen3(chunk_dataset_id)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">encode_splade_v3(chunk_dataset_id)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">build_bm25_index(chunk_dataset_id)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">build_faiss_index(dense_run_id)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ingest_ontologies(ontology_specs[])</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embed_concepts(ontology_id)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">link_chunks_to_concepts(chunk_dataset_id,</span> <span class="pre">ontology_id)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">upsert_kg(link_run_id)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">serve_search_api()</span></code> (starts uvicorn if not already)</p></li>
</ol>
<p><strong>Events</strong> recorded in <code class="docutils literal notranslate"><span class="pre">registry.pipeline_events</span></code>: <code class="docutils literal notranslate"><span class="pre">DocumentIngested</span></code>, <code class="docutils literal notranslate"><span class="pre">DoctagsReady</span></code>, <code class="docutils literal notranslate"><span class="pre">ChunksCreated</span></code>, <code class="docutils literal notranslate"><span class="pre">DenseEmbedded</span></code>, <code class="docutils literal notranslate"><span class="pre">SpladeEncoded</span></code>, <code class="docutils literal notranslate"><span class="pre">BM25Built</span></code>, <code class="docutils literal notranslate"><span class="pre">FAISSBuilt</span></code>, <code class="docutils literal notranslate"><span class="pre">OntologyLoaded</span></code>, <code class="docutils literal notranslate"><span class="pre">ConceptEmbeddingsReady</span></code>, <code class="docutils literal notranslate"><span class="pre">LinkerRun</span></code>, <code class="docutils literal notranslate"><span class="pre">KGUpdated</span></code>.</p>
<p><strong>Concurrency defaults</strong>:</p>
<ul class="simple">
<li><p>Downloader 8 parallel fetches;</p></li>
<li><p>VLM 2 docs in flight;</p></li>
<li><p>Dense/SPLADE batchers tuned to ~80% VRAM;</p></li>
<li><p>FAISS build: 2 shards concurrently;</p></li>
<li><p>All others CPU‑bound threads = 14.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="harvesters-pdf-download-pyalex-first-resilient-fallbacks">
<h1>6) Harvesters &amp; PDF download (PyAlex first; resilient fallbacks)<a class="headerlink" href="#harvesters-pdf-download-pyalex-first-resilient-fallbacks" title="Link to this heading">#</a></h1>
<p><strong>Workflow</strong></p>
<ul class="simple">
<li><p><strong>Search</strong>: PyAlex (OpenAlex) by <code class="docutils literal notranslate"><span class="pre">topic</span></code> across title/abstract/fulltext; filter OA flags; optionally by year range.</p></li>
<li><p>Extract candidate OA locations: <code class="docutils literal notranslate"><span class="pre">best_oa_location</span></code>, <code class="docutils literal notranslate"><span class="pre">primary_location</span></code>, <code class="docutils literal notranslate"><span class="pre">locations[]</span></code>, DOI, arXiv id, pmcid.</p></li>
<li><p><strong>Download resolution</strong> (in order):</p>
<ol class="arabic simple">
<li><p>OpenAlex <code class="docutils literal notranslate"><span class="pre">best_oa_location.pdf_url</span></code>.</p></li>
<li><p>Any <code class="docutils literal notranslate"><span class="pre">locations[].pdf_url</span></code> with <code class="docutils literal notranslate"><span class="pre">is_oa=true</span></code> favoring <code class="docutils literal notranslate"><span class="pre">publishedVersion</span></code> or <code class="docutils literal notranslate"><span class="pre">acceptedVersion</span></code>.</p></li>
<li><p><strong>Unpaywall</strong> by DOI (<code class="docutils literal notranslate"><span class="pre">url_for_pdf</span></code>) — requires configured contact email and rate limits.</p></li>
<li><p><strong>Source‑specific</strong>:</p>
<ul>
<li><p>arXiv → <code class="docutils literal notranslate"><span class="pre">https://arxiv.org/pdf/&lt;id&gt;.pdf</span></code></p></li>
<li><p>PubMed Central → <code class="docutils literal notranslate"><span class="pre">https://www.ncbi.nlm.nih.gov/pmc/articles/&lt;pmcid&gt;/pdf</span></code></p></li>
</ul>
</li>
</ol>
</li>
<li><p><strong>License guard</strong>: accept only OA‑compatible licenses; persist license string on <code class="docutils literal notranslate"><span class="pre">Doc</span></code>.</p></li>
<li><p><strong>Download</strong>: 8 concurrency; 60s timeout; 3 retries w/ exp backoff; <code class="docutils literal notranslate"><span class="pre">User-Agent</span></code> includes contact/email.</p></li>
<li><p><strong>Storage</strong>: <code class="docutils literal notranslate"><span class="pre">/data/pdfs/&lt;doc_id&gt;.pdf</span></code> where <code class="docutils literal notranslate"><span class="pre">doc_id</span></code> derived later from canonical text (post‑DocTags). Temporarily name by OpenAlex ID then rename after canonicalization.</p></li>
<li><p><strong>Registration</strong>: each successful PDF produces a <code class="docutils literal notranslate"><span class="pre">documents</span></code> row (openalex id, doi, license, pdf_uri, source).</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="pdf-doctags-docling-vlm-granitedocling">
<h1>7) PDF → <strong>DocTags</strong> (Docling VLM Granite‑Docling)<a class="headerlink" href="#pdf-doctags-docling-vlm-granitedocling" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>Serving</strong>: vLLM pre‑release (CUDA 13) process <strong>#1</strong> on localhost:8001.</p></li>
<li><p><strong>Router</strong>: Nginx exposes <code class="docutils literal notranslate"><span class="pre">/vlm/*</span> <span class="pre">→</span> <span class="pre">8001</span></code>.</p></li>
<li><p><strong>Defaults</strong>: DPI=220, page_batch=8, bf16 if supported, fallback fp16.</p></li>
<li><p><strong>Quality gate</strong>: if avg token logprob &lt; 0.5 on a page → fallback OCR for that page; provenance notes retained.</p></li>
<li><p><strong>Timeouts</strong>: 120s per 100 pages; max 2000 pages.</p></li>
<li><p><strong>Outputs</strong>: <code class="docutils literal notranslate"><span class="pre">/data/doctags/&lt;doc_id&gt;.dt.json.zst</span></code>.</p></li>
<li><p><strong>Registration</strong>: DuckDB <code class="docutils literal notranslate"><span class="pre">doctags</span></code> with pages, model, revision (<code class="docutils literal notranslate"><span class="pre">untied</span></code> if applicable), avg_logprob.</p></li>
</ul>
<blockquote>
<div><p>We intentionally present one <strong>logical</strong> model endpoint via Nginx, but use <strong>two</strong> local vLLM processes (one model each) due to vLLM’s one‑model‑per‑process design.</p>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="chunking-docling-hybridchunker">
<h1>8) Chunking (Docling <strong>HybridChunker</strong>)<a class="headerlink" href="#chunking-docling-hybridchunker" title="Link to this heading">#</a></h1>
<ul>
<li><p><strong>Parameters</strong>: <code class="docutils literal notranslate"><span class="pre">target_tokens=400</span></code>, <code class="docutils literal notranslate"><span class="pre">overlap=80</span></code>, <code class="docutils literal notranslate"><span class="pre">min_tokens=120</span></code>, <code class="docutils literal notranslate"><span class="pre">max_tokens=480</span></code>.</p></li>
<li><p>Structure‑aware segmentation first; spillover via sliding windows.</p></li>
<li><p>Captures <code class="docutils literal notranslate"><span class="pre">doctags_span</span></code> and <code class="docutils literal notranslate"><span class="pre">start_char/end_char</span></code> for explainable highlights.</p></li>
<li><p><strong>Parquet dataset</strong>: <code class="docutils literal notranslate"><span class="pre">parquet/chunks/model=docling_hybrid/run=&lt;run_id&gt;/part-*.parquet</span></code>
<strong>Schema</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chunk_id</span><span class="p">:</span> <span class="n">string</span>
<span class="n">doc_id</span><span class="p">:</span> <span class="n">string</span>
<span class="n">section</span><span class="p">:</span> <span class="n">string</span>
<span class="n">start_char</span><span class="p">:</span> <span class="n">int32</span>
<span class="n">end_char</span><span class="p">:</span> <span class="n">int32</span>
<span class="n">doctags_span</span><span class="p">:</span> <span class="n">struct</span><span class="o">&lt;</span><span class="n">node_id</span><span class="p">:</span><span class="n">string</span><span class="p">,</span><span class="n">start</span><span class="p">:</span><span class="n">int32</span><span class="p">,</span><span class="n">end</span><span class="p">:</span><span class="n">int32</span><span class="o">&gt;</span>
<span class="n">text</span><span class="p">:</span> <span class="n">string</span>
<span class="n">tokens</span><span class="p">:</span> <span class="n">int32</span>
<span class="n">created_at</span><span class="p">:</span> <span class="n">timestamp</span>
</pre></div>
</div>
</li>
<li><p>Register resulting dataset in <code class="docutils literal notranslate"><span class="pre">registry.datasets</span></code> (kind=’chunks’) and each row in <code class="docutils literal notranslate"><span class="pre">chunks</span></code>.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="dense-embeddings-qwen3embedding4b-2560dim-vllm">
<h1>9) Dense embeddings (Qwen3‑Embedding‑4B &#64; <strong>2560‑dim</strong>, vLLM)<a class="headerlink" href="#dense-embeddings-qwen3embedding4b-2560dim-vllm" title="Link to this heading">#</a></h1>
<ul>
<li><p><strong>Serving</strong>: vLLM pre‑release process <strong>#2</strong> on localhost:8002; router maps <code class="docutils literal notranslate"><span class="pre">/v1/embeddings</span> <span class="pre">→</span> <span class="pre">8002</span></code>.</p></li>
<li><p><strong>Embedding length</strong>: <strong>2560</strong> (model supports 32–2560; set explicitly).</p></li>
<li><p><strong>Batching</strong>: automatic; target <strong>≤ 80%</strong> of available VRAM.</p></li>
<li><p><strong>Normalization</strong>: L2; store norm (float32).</p></li>
<li><p><strong>Parquet dataset</strong>: <code class="docutils literal notranslate"><span class="pre">parquet/dense/model=Qwen3-Embedding-4B/run=&lt;run_id&gt;/part-*.parquet</span></code>
<strong>Schema</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chunk_id</span><span class="p">:</span> <span class="n">string</span>
<span class="n">model</span><span class="p">:</span> <span class="n">string</span>              <span class="o">--</span> <span class="s1">&#39;Qwen3-Embedding-4B&#39;</span>
<span class="n">run_id</span><span class="p">:</span> <span class="n">string</span>
<span class="n">dim</span><span class="p">:</span> <span class="n">int16</span>                 <span class="o">--</span> <span class="mi">2560</span>
<span class="n">vector</span><span class="p">:</span> <span class="nb">list</span><span class="o">&lt;</span><span class="nb">float</span><span class="o">&gt;</span>        <span class="o">--</span> <span class="n">length</span><span class="o">==</span><span class="mi">2560</span> <span class="p">(</span><span class="n">float32</span> <span class="n">on</span> <span class="n">disk</span><span class="p">)</span>
<span class="n">l2_norm</span><span class="p">:</span> <span class="nb">float</span>
<span class="n">created_at</span><span class="p">:</span> <span class="n">timestamp</span>
</pre></div>
</div>
</li>
<li><p><strong>Compression</strong>: ZSTD=6; row_group=4096; dictionary encoding on categorical cols.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="sparse-embeddings-indices-spladev3-gpu-bm25">
<h1>10) Sparse embeddings &amp; indices (SPLADE‑v3 <strong>GPU</strong> + BM25)<a class="headerlink" href="#sparse-embeddings-indices-spladev3-gpu-bm25" title="Link to this heading">#</a></h1>
<ul>
<li><p><strong>SPLADE‑v3 encoder</strong>: <code class="docutils literal notranslate"><span class="pre">naver/splade-v3-distilbert</span></code></p>
<ul>
<li><p>CUDA (Torch 2.9, cu130), AMP fp16, <code class="docutils literal notranslate"><span class="pre">max_seq_len=512</span></code>, <code class="docutils literal notranslate"><span class="pre">topK=256</span></code> nnz per chunk.</p></li>
<li><p>Tokenizer: distilbert WordPiece, <code class="docutils literal notranslate"><span class="pre">vocab_size=30522</span></code>.</p></li>
<li><p><strong>Parquet dataset</strong>: <code class="docutils literal notranslate"><span class="pre">parquet/sparse/model=SPLADE-v3-distilbert/run=&lt;run_id&gt;/part-*.parquet</span></code>
<strong>Schema</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chunk_id</span><span class="p">:</span> <span class="n">string</span>
<span class="n">model</span><span class="p">:</span> <span class="n">string</span>
<span class="n">run_id</span><span class="p">:</span> <span class="n">string</span>
<span class="n">vocab_ids</span><span class="p">:</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span>    <span class="o">--</span> <span class="nb">sorted</span><span class="p">,</span> <span class="n">unique</span>
<span class="n">weights</span><span class="p">:</span>   <span class="nb">list</span><span class="o">&lt;</span><span class="nb">float</span><span class="o">&gt;</span>    <span class="o">--</span> <span class="n">same</span> <span class="n">length</span> <span class="k">as</span> <span class="n">vocab_ids</span>
<span class="n">nnz</span><span class="p">:</span> <span class="n">int16</span>
<span class="n">created_at</span><span class="p">:</span> <span class="n">timestamp</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>Indexing</strong>: <strong>Lucene impact index</strong> (Pyserini).</p>
<ul class="simple">
<li><p><strong>No JSONL at rest</strong>: a streaming adapter reads Parquet rows and writes directly to Lucene via Pyserini builders (any temporary files are ephemeral and excluded from registry).</p></li>
</ul>
</li>
<li><p><strong>BM25</strong>: Pyserini (Lucene). Params: <strong>k1=0.9</strong>, <strong>b=0.4</strong>; field boosts <code class="docutils literal notranslate"><span class="pre">title^2.0,</span> <span class="pre">section^1.2,</span> <span class="pre">body^1.0</span></code>.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="faiss-gpu-with-cuvs-cuda-13">
<h1>11) FAISS (GPU with <strong>cuVS</strong>), CUDA 13<a class="headerlink" href="#faiss-gpu-with-cuvs-cuda-13" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>Install</strong>: Prefer <strong>GPU binary</strong> (wheel) built for CUDA 13 <strong>with cuVS enabled</strong>. If unavailable, build from source with <code class="docutils literal notranslate"><span class="pre">-DFAISS_ENABLE_GPU=ON</span> <span class="pre">-DFAISS_ENABLE_CUVS=ON</span></code>.</p></li>
<li><p><strong>Index factory (default)</strong>: <code class="docutils literal notranslate"><span class="pre">OPQ64,IVF8192,PQ64</span></code> (good for <strong>d=2560</strong>; OPQ pre‑rotation at 64; PQ m=64).</p></li>
<li><p><strong>Training</strong>: sample <strong>10M</strong> vectors or all (if fewer), seed=42.</p></li>
<li><p><strong>Search</strong>: <code class="docutils literal notranslate"><span class="pre">nprobe=64</span></code>. Codes 8‑bit per subvector.</p></li>
<li><p><strong>Memory</strong>: PQ codes ~<strong>64 B/vector</strong> (+ID/overhead ⇒ ~<strong>80–100 B/vector</strong> typical).</p></li>
<li><p><strong>Persistence</strong>: <code class="docutils literal notranslate"><span class="pre">.faiss</span></code> index + <code class="docutils literal notranslate"><span class="pre">.ids</span></code> idmap; shards ≤10M vectors each.</p></li>
<li><p><strong>Registration</strong>: rows in DuckDB <code class="docutils literal notranslate"><span class="pre">faiss_indexes</span></code> (logical index id groups shards).</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="ontology-ingestion-concept-encoders">
<h1>12) Ontology ingestion &amp; concept encoders<a class="headerlink" href="#ontology-ingestion-concept-encoders" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>Formats</strong>: OWL/RDF (TTL/RDF‑XML), OBO, SKOS.</p></li>
<li><p><strong>Normalization</strong>: lowercase, NFC, strip most punctuation, lemmatize EN, stopword‑smart; build surface forms from <code class="docutils literal notranslate"><span class="pre">pref_label</span></code>, <code class="docutils literal notranslate"><span class="pre">alt_labels</span></code>, <code class="docutils literal notranslate"><span class="pre">synonyms</span></code>, and <code class="docutils literal notranslate"><span class="pre">definition</span></code>.</p></li>
<li><p><strong>Dense concept embeddings</strong>: Qwen3‑Embedding‑4B with <strong>dim=2560</strong> (concat text: <code class="docutils literal notranslate"><span class="pre">pref_label</span> <span class="pre">|</span> <span class="pre">definition</span> <span class="pre">|</span> <span class="pre">5</span> <span class="pre">best</span> <span class="pre">synonyms</span></code>).</p></li>
<li><p><strong>Sparse concept embeddings</strong>: SPLADE‑v3 with <strong>topK=128</strong>.</p></li>
<li><p><strong>Parquet datasets</strong> mirroring chunk schemas; registered in <code class="docutils literal notranslate"><span class="pre">concept_embeddings</span></code>.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="linker-chunkconcept-calibrated">
<h1>13) Linker (chunk→concept), calibrated<a class="headerlink" href="#linker-chunkconcept-calibrated" title="Link to this heading">#</a></h1>
<p><strong>Candidate generation</strong></p>
<ul class="simple">
<li><p>SPLADE concept index <strong>&#64;100</strong> using chunk text;</p></li>
<li><p>Lexical dictionary match <strong>&#64;50</strong> (max phrase len=6 tokens, case‑folded).</p></li>
</ul>
<p><strong>Feature scoring</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dense_sim</span></code> = cosine(qwen_chunk, qwen_concept)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sparse_sim</span></code> = normalized SPLADE (min–max per query)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lexical_overlap</span></code> = matched_chars / chunk_chars (clamp [0, 0.2])</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">depth_bonus</span></code> = +0.02 × levels from root (cap +0.10)</p></li>
</ul>
<p><strong>Fusion &amp; decision</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">score</span> <span class="pre">=</span> <span class="pre">0.55*dense</span> <span class="pre">+</span> <span class="pre">0.35*sparse</span> <span class="pre">+</span> <span class="pre">0.10*lexical</span> <span class="pre">+</span> <span class="pre">depth_bonus</span></code></p></li>
<li><p>Thresholds: <strong>link ≥ 0.62</strong>, <strong>reject ≤ 0.35</strong>, else uncertain.</p></li>
<li><p><strong>Calibration</strong>: isotonic regression stored per linker run; output <code class="docutils literal notranslate"><span class="pre">LinkAssertion</span></code> Parquet.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="knowledge-graph-neo4j-local">
<h1>14) Knowledge Graph (Neo4j, local)<a class="headerlink" href="#knowledge-graph-neo4j-local" title="Link to this heading">#</a></h1>
<p><strong>Nodes</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(:Doc</span> <span class="pre">{doc_id,</span> <span class="pre">title,</span> <span class="pre">year,</span> <span class="pre">license,</span> <span class="pre">source,</span> <span class="pre">source_id})</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(:Chunk</span> <span class="pre">{chunk_id,</span> <span class="pre">section,</span> <span class="pre">start_char,</span> <span class="pre">end_char})</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(:Concept</span> <span class="pre">{concept_id,</span> <span class="pre">ontology,</span> <span class="pre">pref_label})</span></code></p></li>
</ul>
<p><strong>Relationships</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(:Doc)-[:HAS_CHUNK]-&gt;(:Chunk)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(:Chunk)-[:MENTIONS</span> <span class="pre">{score,</span> <span class="pre">run_id,</span> <span class="pre">evidence_span,</span> <span class="pre">created_at}]-&gt;(:Concept)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(:Concept)-[:IS_A]-&gt;(:Concept)</span></code> and <code class="docutils literal notranslate"><span class="pre">[:RELATED_TO]</span></code> (from ontology).</p></li>
</ul>
<p><strong>Constraints &amp; indexes</strong></p>
<ul class="simple">
<li><p>Uniqueness on <code class="docutils literal notranslate"><span class="pre">doc_id</span></code>, <code class="docutils literal notranslate"><span class="pre">chunk_id</span></code>, <code class="docutils literal notranslate"><span class="pre">concept_id</span></code>; B‑tree index on <code class="docutils literal notranslate"><span class="pre">MENTIONS.score</span></code> and <code class="docutils literal notranslate"><span class="pre">MENTIONS.run_id</span></code>.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="hybrid-search-api-fastapi-local">
<h1>15) Hybrid search API (FastAPI, local)<a class="headerlink" href="#hybrid-search-api-fastapi-local" title="Link to this heading">#</a></h1>
<p><strong>Endpoints</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/search</span></code>
Body: <code class="docutils literal notranslate"><span class="pre">{query:</span> <span class="pre">str,</span> <span class="pre">k?:</span> <span class="pre">int=10,</span> <span class="pre">filters?:</span> <span class="pre">{...},</span> <span class="pre">explain?:</span> <span class="pre">bool=false}</span></code>
Returns top chunks &amp; doc rollups with dense/sparse scores, KG boosts, spans, linked concepts.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/graph/concepts</span></code> (browse ontology)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/healthz</span></code></p></li>
</ul>
<p><strong>Algorithm (fixed)</strong></p>
<ol class="arabic simple">
<li><p>Query embedding via Qwen3 (2560‑d) + parse lexical concept mentions.</p></li>
<li><p>Retrieve <strong>dense&#64;200</strong> (FAISS) + <strong>sparse&#64;200</strong> (BM25 and SPLADE).</p></li>
<li><p>Fuse via <strong>RRF(k=60)</strong>.</p></li>
<li><p>KG boosts: +0.08 for direct concept match; +0.04 for one‑hop neighbor.</p></li>
<li><p><strong>MMR</strong> (λ=0.7) at doc level.</p></li>
<li><p>Return top‑k.</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="configuration-yaml-singlebox-defaults">
<h1>16) Configuration (YAML; single‑box defaults)<a class="headerlink" href="#configuration-yaml-singlebox-defaults" title="Link to this heading">#</a></h1>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">system</span><span class="p">:</span>
<span class="w">  </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-24.04</span>
<span class="w">  </span><span class="nt">threads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">14</span>
<span class="w">  </span><span class="nt">seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<span class="w">  </span><span class="nt">parquet_root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/parquet</span>
<span class="w">  </span><span class="nt">artifacts_root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/artifacts</span>
<span class="w">  </span><span class="nt">duckdb_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/catalog/catalog.duckdb</span>

<span class="nt">runtime</span><span class="p">:</span>
<span class="w">  </span><span class="nt">python</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.13&quot;</span>
<span class="w">  </span><span class="nt">cuda</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;13.0&quot;</span>
<span class="w">  </span><span class="nt">torch</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.9&quot;</span>
<span class="w">  </span><span class="nt">duckdb_min</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.4.1&quot;</span>
<span class="w">  </span><span class="nt">vllm_channel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pre-release-cuda13&quot;</span>

<span class="nt">network</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nginx_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="nt">vlm_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8001</span>
<span class="w">  </span><span class="nt">emb_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8002</span>
<span class="w">  </span><span class="nt">api_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>

<span class="nt">harvest</span><span class="p">:</span>
<span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyalex</span>
<span class="w">  </span><span class="nt">per_page</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
<span class="w">  </span><span class="nt">max_works</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20000</span>
<span class="w">  </span><span class="nt">years</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&gt;=2018&quot;</span>
<span class="w">  </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">is_oa</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">has_oa_published_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">fallbacks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">unpaywall</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">arxiv</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">pmc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">concurrency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">  </span><span class="nt">timeout_sec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<span class="w">  </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>

<span class="nt">doc_conversion</span><span class="p">:</span>
<span class="w">  </span><span class="nt">vlm_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ibm-granite/granite-docling-258M</span>
<span class="w">  </span><span class="nt">vlm_revision</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">untied</span>
<span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost/vlm/</span>
<span class="w">  </span><span class="nt">dpi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">220</span>
<span class="w">  </span><span class="nt">page_batch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">  </span><span class="nt">ocr_fallback</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">max_pages</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2000</span>
<span class="w">  </span><span class="nt">timeout_sec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120</span>

<span class="nt">chunking</span><span class="p">:</span>
<span class="w">  </span><span class="nt">engine</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docling_hybrid</span>
<span class="w">  </span><span class="nt">target_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">400</span>
<span class="w">  </span><span class="nt">overlap_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="nt">min_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120</span>
<span class="w">  </span><span class="nt">max_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">480</span>

<span class="nt">dense_embedding</span><span class="p">:</span>
<span class="w">  </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Qwen/Qwen3-Embedding-4B</span>
<span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost/v1/embeddings</span>
<span class="w">  </span><span class="nt">output_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2560</span>
<span class="w">  </span><span class="nt">parquet_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${system.parquet_root}/dense/model=Qwen3-Embedding-4B/run=${run_id}</span>

<span class="nt">sparse_embedding</span><span class="p">:</span>
<span class="w">  </span><span class="nt">splade</span><span class="p">:</span>
<span class="w">    </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">naver/splade-v3-distilbert</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda</span>
<span class="w">    </span><span class="nt">amp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fp16</span>
<span class="w">    </span><span class="nt">max_seq_len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="w">    </span><span class="nt">topk</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span>
<span class="w">    </span><span class="nt">parquet_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${system.parquet_root}/sparse/model=SPLADE-v3-distilbert/run=${run_id}</span>
<span class="w">  </span><span class="nt">bm25</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.9</span>
<span class="w">    </span><span class="nt">b</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4</span>
<span class="w">    </span><span class="nt">field_boosts</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> title</span><span class="p">:</span><span class="w"> </span><span class="nv">2.0</span><span class="p p-Indicator">,</span><span class="nt"> section</span><span class="p">:</span><span class="w"> </span><span class="nv">1.2</span><span class="p p-Indicator">,</span><span class="nt"> body</span><span class="p">:</span><span class="w"> </span><span class="nv">1.0</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">index_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/lucene/bm25</span>

<span class="nt">faiss</span><span class="p">:</span>
<span class="w">  </span><span class="nt">index_factory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OPQ64,IVF8192,PQ64</span>
<span class="w">  </span><span class="nt">nprobe</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">train_samples</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000000</span>
<span class="w">  </span><span class="nt">shards</span><span class="p">:</span>
<span class="w">    </span><span class="nt">max_vectors_per_shard</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000000</span>
<span class="w">  </span><span class="nt">gpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">cuvs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">output_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/faiss/qwen3_ivfpq</span>

<span class="nt">ontology</span><span class="p">:</span>
<span class="w">  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> ontology_id</span><span class="p">:</span><span class="w"> </span><span class="nv">mesh</span><span class="p p-Indicator">,</span><span class="nt"> format</span><span class="p">:</span><span class="w"> </span><span class="nv">obo</span><span class="p p-Indicator">,</span><span class="nt"> uri</span><span class="p">:</span><span class="w"> </span><span class="nv">/data/ontologies/mesh.obo</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> ontology_id</span><span class="p">:</span><span class="w"> </span><span class="nv">go</span><span class="p p-Indicator">,</span><span class="nt">   format</span><span class="p">:</span><span class="w"> </span><span class="nv">obo</span><span class="p p-Indicator">,</span><span class="nt"> uri</span><span class="p">:</span><span class="w"> </span><span class="nv">/data/ontologies/go.obo</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">concept_embed</span><span class="p">:</span>
<span class="w">    </span><span class="nt">dense_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Qwen3-Embedding-4B</span>
<span class="w">    </span><span class="nt">dense_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2560</span>
<span class="w">    </span><span class="nt">splade_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SPLADE-v3-distilbert</span>
<span class="w">    </span><span class="nt">splade_topk</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>

<span class="nt">linker</span><span class="p">:</span>
<span class="w">  </span><span class="nt">candidates</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> splade_topk</span><span class="p">:</span><span class="w"> </span><span class="nv">100</span><span class="p p-Indicator">,</span><span class="nt"> lexicon_topk</span><span class="p">:</span><span class="w"> </span><span class="nv">50</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">fusion_weights</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> dense</span><span class="p">:</span><span class="w"> </span><span class="nv">0.55</span><span class="p p-Indicator">,</span><span class="nt"> sparse</span><span class="p">:</span><span class="w"> </span><span class="nv">0.35</span><span class="p p-Indicator">,</span><span class="nt"> lexical</span><span class="p">:</span><span class="w"> </span><span class="nv">0.10</span><span class="p p-Indicator">,</span><span class="nt"> depth_bonus_per_level</span><span class="p">:</span><span class="w"> </span><span class="nv">0.02</span><span class="p p-Indicator">,</span><span class="nt"> depth_cap</span><span class="p">:</span><span class="w"> </span><span class="nv">0.10</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">thresholds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> high</span><span class="p">:</span><span class="w"> </span><span class="nv">0.62</span><span class="p p-Indicator">,</span><span class="nt"> low</span><span class="p">:</span><span class="w"> </span><span class="nv">0.35</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">calibration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">isotonic</span>

<span class="nt">graph</span><span class="p">:</span>
<span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">neo4j</span>
<span class="w">  </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bolt://localhost:7687</span>
<span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">neo4j</span>
<span class="w">  </span><span class="nt">password_env</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NEO4J_PASSWORD</span>

<span class="nt">search</span><span class="p">:</span>
<span class="w">  </span><span class="nt">k</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">  </span><span class="nt">dense_candidates</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
<span class="w">  </span><span class="nt">sparse_candidates</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
<span class="w">  </span><span class="nt">rrf_k</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<span class="w">  </span><span class="nt">mmr_lambda</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.7</span>
<span class="w">  </span><span class="nt">kg_boosts</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> direct</span><span class="p">:</span><span class="w"> </span><span class="nv">0.08</span><span class="p p-Indicator">,</span><span class="nt"> one_hop</span><span class="p">:</span><span class="w"> </span><span class="nv">0.04</span><span class="w"> </span><span class="p p-Indicator">}</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="duckdb-1-4-1-schema-views-full-fidelity">
<h1>17) DuckDB (≥ 1.4.1) schema &amp; views (full fidelity)<a class="headerlink" href="#duckdb-1-4-1-schema-views-full-fidelity" title="Link to this heading">#</a></h1>
<p><strong>Tables (key ones)</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">model_registry</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">model_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">repo</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">revision</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">tokenizer</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">embedding_dim</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">      </span><span class="c1">-- 2560 for Qwen3 embeddings</span>
<span class="w">  </span><span class="n">vocab_size</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">         </span><span class="c1">-- 30522 for SPLADE v3 tokenizer</span>
<span class="w">  </span><span class="n">framework</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">         </span><span class="c1">-- &#39;vllm&#39;|&#39;hf&#39;</span>
<span class="w">  </span><span class="n">framework_version</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">build_info</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span><span class="w">        </span><span class="c1">-- FAISS flags, CUDA, cuVS info</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span><span class="w"> </span><span class="n">revision</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">runs</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">run_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">purpose</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">           </span><span class="c1">-- &#39;dense_embed&#39;|&#39;splade_encode&#39;|&#39;bm25_build&#39;|&#39;faiss_build&#39;|...</span>
<span class="w">  </span><span class="n">model_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">revision</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">started_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="n">finished_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="n">config</span><span class="w"> </span><span class="n">JSON</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">documents</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">doc_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">openalex_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">doi</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">arxiv_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">pmcid</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span><span class="w"> </span><span class="n">pub_date</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="n">license</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="k">language</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">pdf_uri</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="k">source</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">content_hash</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">         </span><span class="c1">-- canonical text hash (after DocTags→text)</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">doctags</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">doc_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">documents</span><span class="p">(</span><span class="n">doc_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">doctags_uri</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">  </span><span class="n">vlm_model</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">vlm_revision</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">avg_logprob</span><span class="w"> </span><span class="n">DOUBLE</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">datasets</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">dataset_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">                 </span><span class="c1">-- &#39;chunks&#39;|&#39;dense&#39;|&#39;sparse&#39;|&#39;concepts&#39;</span>
<span class="w">  </span><span class="n">parquet_root</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">run_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">runs</span><span class="p">(</span><span class="n">run_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">chunks</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">chunk_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">doc_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">documents</span><span class="p">(</span><span class="n">doc_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">section</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">start_char</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w"> </span><span class="n">end_char</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">  </span><span class="n">doctags_span</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">  </span><span class="n">dataset_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">datasets</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">dense_runs</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">run_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">runs</span><span class="p">(</span><span class="n">run_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">model</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">       </span><span class="c1">-- 2560</span>
<span class="w">  </span><span class="n">parquet_root</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sparse_runs</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">run_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">runs</span><span class="p">(</span><span class="n">run_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">model</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">vocab_size</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">  </span><span class="n">parquet_root</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="n">backend</span><span class="w"> </span><span class="nb">TEXT</span><span class="w">               </span><span class="c1">-- &#39;lucene-impact&#39;|&#39;lucene-bm25&#39;</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">faiss_indexes</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">logical_index_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">     </span><span class="c1">-- groups shards into a single logical index</span>
<span class="w">  </span><span class="n">run_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">dense_runs</span><span class="p">(</span><span class="n">run_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">shard_id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">  </span><span class="n">index_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">nlist</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w"> </span><span class="n">opq</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w"> </span><span class="n">nprobe</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">  </span><span class="n">gpu</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">,</span><span class="w"> </span><span class="n">cuvs</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">,</span>
<span class="w">  </span><span class="n">index_uri</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">idmap_uri</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">logical_index_id</span><span class="p">,</span><span class="w"> </span><span class="n">shard_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">ontologies</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">ontology_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">format</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">src_uri</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">loaded_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span><span class="w"> </span><span class="n">concept_count</span><span class="w"> </span><span class="nb">INT</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">concept_embeddings</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">ontology_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">ontologies</span><span class="p">(</span><span class="n">ontology_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">model</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">  </span><span class="n">parquet_root</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">ontology_id</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">link_assertions</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">chunk_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">chunks</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">concept_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">score</span><span class="w"> </span><span class="n">DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">decision</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">evidence_span</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">features</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">  </span><span class="n">run_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">runs</span><span class="p">(</span><span class="n">run_id</span><span class="p">),</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">pipeline_events</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">event_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">event_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">subject_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>

<span class="c1">-- Helpful indexes</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_chunks_doc</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">chunks</span><span class="p">(</span><span class="n">doc_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_link_chunk</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">link_assertions</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_link_concept</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">link_assertions</span><span class="p">(</span><span class="n">concept_id</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Views</strong> (Parquet unification)</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">threads</span><span class="o">=</span><span class="mi">14</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">dense_vectors_view</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">read_parquet</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">parquet_root</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">dense_runs</span><span class="p">),</span><span class="w"> </span><span class="n">union_by_name</span><span class="o">=</span><span class="k">true</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">splade_vectors_view</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">read_parquet</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">parquet_root</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sparse_runs</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;lucene-impact&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">union_by_name</span><span class="o">=</span><span class="k">true</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">chunk_texts</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">read_parquet</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">parquet_root</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">datasets</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;chunks&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">union_by_name</span><span class="o">=</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="vllm-nginx-single-logical-endpoint">
<h1>18) vLLM &amp; Nginx (single logical endpoint)<a class="headerlink" href="#vllm-nginx-single-logical-endpoint" title="Link to this heading">#</a></h1>
<p><strong>Nginx</strong> (local):</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">  </span><span class="kn">server_name</span><span class="w"> </span><span class="s">localhost</span><span class="p">;</span>

<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/vlm/</span><span class="w"> </span><span class="p">{</span><span class="w">              </span><span class="c1"># Docling VLM</span>
<span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://127.0.0.1:8001/</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/v1/embeddings</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="c1"># Qwen3 embeddings (OpenAI-compatible)</span>
<span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://127.0.0.1:8002/v1/embeddings</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/healthz</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="s">&#39;ok\n&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>vLLM processes (systemd units suggested)</strong></p>
<ul class="simple">
<li><p><strong>Granite‑Docling</strong>: <code class="docutils literal notranslate"><span class="pre">vllm</span> <span class="pre">serve</span> <span class="pre">ibm-granite/granite-docling-258M</span> <span class="pre">--revision</span> <span class="pre">untied</span> <span class="pre">--host</span> <span class="pre">127.0.0.1</span> <span class="pre">--port</span> <span class="pre">8001</span> <span class="pre">--dtype</span> <span class="pre">bfloat16</span></code></p></li>
<li><p><strong>Qwen3‑Embedding</strong>: <code class="docutils literal notranslate"><span class="pre">vllm</span> <span class="pre">serve</span> <span class="pre">Qwen/Qwen3-Embedding-4B</span> <span class="pre">--host</span> <span class="pre">127.0.0.1</span> <span class="pre">--port</span> <span class="pre">8002</span> <span class="pre">--dtype</span> <span class="pre">float16</span> <span class="pre">--max-num-seqs</span> <span class="pre">1024</span> <span class="pre">--trust-remote-code</span></code></p></li>
</ul>
<p><em>(One model per vLLM process; router gives you a single host/endpoint.)</em></p>
</section>
<hr class="docutils" />
<section id="implementation-skeletons-selected">
<h1>19) Implementation skeletons (selected)<a class="headerlink" href="#implementation-skeletons-selected" title="Link to this heading">#</a></h1>
<section id="downloader-pyalex-fallbacks">
<h2>19.1 Downloader (PyAlex + fallbacks)<a class="headerlink" href="#downloader-pyalex-fallbacks" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># download/harvester.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenAccessHarvester</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="n">unpaywall_client</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search_openalex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_works</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="c1"># paginate PyAlex queries; collect candidate OA PDF URLs + metadata</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># try best_oa_location.pdf_url → locations[].pdf_url → unpaywall → arxiv/pmc</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">download_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># 60s timeout, 3 retries, 8 concurrent workers</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_works</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Doc</span><span class="p">]:</span>
        <span class="c1"># returns registered documents (DuckDB insert)</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="doctags-conversion">
<h2>19.2 DocTags conversion<a class="headerlink" href="#doctags-conversion" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># docling/vlm.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GraniteDoclingVLM</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">page_batch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ocr_fallback</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_doctags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdf_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># call vLLM endpoint; assemble DocTags JSON; OCR fallback per page if needed</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">doctags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># write to /data/doctags/&lt;doc_id&gt;.dt.json.zst, return URI</span>
</pre></div>
</div>
</section>
<section id="chunking">
<h2>19.3 Chunking<a class="headerlink" href="#chunking" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># docling/hybrid.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HybridChunker</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">min_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">480</span><span class="p">):</span>
        <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doctags_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chunk</span><span class="p">]:</span>
        <span class="c1"># parse, section-aware splitting, sliding windows, record spans/offsets</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="dense-embeddings-qwen3-2560d-via-vllm">
<h2>19.4 Dense embeddings (Qwen3 2560‑d via vLLM)<a class="headerlink" href="#dense-embeddings-qwen3-2560d-via-vllm" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># embeddings_dense/qwen3.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Qwen3Embedder</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Qwen3-Embedding-4B&quot;</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">2560</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">embed_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">:</span>
        <span class="c1"># call /v1/embeddings; enforce dim=2560; L2-normalize</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="spladev3-encoder-gpu">
<h2>19.5 SPLADE‑v3 encoder (GPU)<a class="headerlink" href="#spladev3-encoder-gpu" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># embeddings_sparse/splade.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SPLADEv3Encoder</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
        <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
        <span class="c1"># torch.no_grad + autocast; prune to topK</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="faiss-index-gpu-cuvs">
<h2>19.6 FAISS index (GPU + cuVS)<a class="headerlink" href="#faiss-index-gpu-cuvs" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># vectorstore_faiss/gpu.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FaissGpuIndex</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nprobe</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gpu</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cuvs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_vectors</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">vectors</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idmap_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="hybrid-retrieval-rerank-search-api">
<h2>19.7 Hybrid retrieval &amp; rerank (search_api)<a class="headerlink" href="#hybrid-retrieval-rerank-search-api" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># search_api/service.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">hybrid_search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">q_vec</span> <span class="o">=</span> <span class="n">dense_embedder</span><span class="o">.</span><span class="n">embed_texts</span><span class="p">([</span><span class="n">query</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dense_hits</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">q_vec</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">sparse_hits</span> <span class="o">=</span> <span class="n">bm25</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="o">+</span> <span class="n">splade</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">fused</span> <span class="o">=</span> <span class="n">rrf_fuse</span><span class="p">(</span><span class="n">dense_hits</span><span class="p">,</span> <span class="n">sparse_hits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">boosted</span> <span class="o">=</span> <span class="n">apply_kg_boosts</span><span class="p">(</span><span class="n">fused</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">mmr_deduplicate</span><span class="p">(</span><span class="n">boosted</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">explain</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="quality-gates-evaluation-ci">
<h1>20) Quality gates, evaluation &amp; CI<a class="headerlink" href="#quality-gates-evaluation-ci" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>Retrieval</strong>: nDCG&#64;10 ≥ 0.50 (baseline), Recall&#64;1K ≥ 0.85.</p></li>
<li><p><strong>Linker</strong>: F1 ≥ 0.70 on a labeled set; <strong>ECE ≤ 0.08</strong> after isotonic calibration.</p></li>
<li><p><strong>Latency</strong>: p95 search <strong>&lt; 300 ms</strong> (top‑10); p50 chunk→embed throughput tracked.</p></li>
<li><p><strong>CI</strong>: Unit tests (mypy, ruff), golden tests, nightly 1k‑doc mini‑pipeline; fail on regressions.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="security-licensing-governance-local">
<h1>21) Security, licensing, governance (local)<a class="headerlink" href="#security-licensing-governance-local" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>License guard</strong> at harvest; store license string in <code class="docutils literal notranslate"><span class="pre">documents.license</span></code>.</p></li>
<li><p>vLLM binds to <strong>localhost</strong> only; Nginx is the only front door; <strong>API‑key</strong> auth on search API.</p></li>
<li><p><strong>Secrets</strong> (if any) from environment; never persisted.</p></li>
<li><p><strong>Provenance</strong>: every artifact row includes <code class="docutils literal notranslate"><span class="pre">{run_id,</span> <span class="pre">model_id,</span> <span class="pre">revision,</span> <span class="pre">created_at}</span></code>.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="capacity-sizing-with-2560dim">
<h1>22) Capacity &amp; sizing with <strong>2560‑dim</strong><a class="headerlink" href="#capacity-sizing-with-2560dim" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>Dense Parquet</strong>: ≈ <strong>10 KB/chunk</strong> pre‑compression (2560 × 4 B).</p></li>
<li><p><strong>IVF‑PQ</strong> (PQ64) codes: ≈ <strong>64 B/vector</strong> (+ID/overhead ~80–100 B).</p></li>
<li><p><strong>SPLADE postings</strong>: ~<strong>2 KB/chunk</strong> before Lucene compression (256 nnz).</p></li>
<li><p>Scale by chunk count (e.g., 5M chunks → ~50 GB dense Parquet uncompressed; index is small enough for GPU).</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="operational-runbooks">
<h1>23) Operational runbooks<a class="headerlink" href="#operational-runbooks" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>CUDA 13 + Torch 2.9</strong>: install CUDA 13, confirm <code class="docutils literal notranslate"><span class="pre">nvcc</span> <span class="pre">--version</span></code>, install cu130 wheels.</p></li>
<li><p><strong>vLLM pre‑release</strong>: install channel with CUDA‑13 support; start two processes; verify health on <code class="docutils literal notranslate"><span class="pre">:8001</span></code>, <code class="docutils literal notranslate"><span class="pre">:8002</span></code>; Nginx routes.</p></li>
<li><p><strong>FAISS GPU + cuVS</strong>: install GPU binary (preferred); if needed, build from source with CMake flags enabling cuVS.</p></li>
<li><p><strong>Directories</strong>:</p>
<ul>
<li><p>PDFs: <code class="docutils literal notranslate"><span class="pre">/data/pdfs</span></code></p></li>
<li><p>DocTags: <code class="docutils literal notranslate"><span class="pre">/data/doctags</span></code></p></li>
<li><p>Parquet: <code class="docutils literal notranslate"><span class="pre">/data/parquet</span></code></p></li>
<li><p>Lucene: <code class="docutils literal notranslate"><span class="pre">/data/lucene/{bm25,splade}</span></code></p></li>
<li><p>FAISS: <code class="docutils literal notranslate"><span class="pre">/data/faiss</span></code></p></li>
<li><p>DuckDB: <code class="docutils literal notranslate"><span class="pre">/data/catalog/catalog.duckdb</span></code></p></li>
</ul>
</li>
<li><p><strong>Resource limits</strong>: <code class="docutils literal notranslate"><span class="pre">ulimit</span> <span class="pre">-n</span> <span class="pre">65535</span></code>; I/O scheduler <code class="docutils literal notranslate"><span class="pre">mq-deadline</span></code>; set <code class="docutils literal notranslate"><span class="pre">PRAGMA</span> <span class="pre">threads=14</span></code> in DuckDB.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="workstreams-implementation-plans-deliverables">
<h1>24) Workstreams (implementation plans &amp; deliverables)<a class="headerlink" href="#workstreams-implementation-plans-deliverables" title="Link to this heading">#</a></h1>
<ol class="arabic simple">
<li><p><strong>Downloader &amp; Harvester (PyAlex + fallbacks)</strong></p>
<ul class="simple">
<li><p>PyAlex client; OA filters; DOI/ID extract; Unpaywall integration; robust downloader; license guard; DuckDB registration.</p></li>
<li><p>Deliverables: module, config, tests (mock HTTP), metrics (<code class="docutils literal notranslate"><span class="pre">pdf_download_success_total</span></code>, <code class="docutils literal notranslate"><span class="pre">oa_resolution_latency</span></code>).</p></li>
</ul>
</li>
<li><p><strong>Docling VLM &amp; DocTags</strong></p>
<ul class="simple">
<li><p>vLLM integration; page batching; OCR fallback; DocTags writer; quality metrics (avg logprob/page).</p></li>
<li><p>Deliverables: module, Nginx+vLLM configs, DDL updates, golden DocTags samples.</p></li>
</ul>
</li>
<li><p><strong>Chunking (Docling Hybrid)</strong></p>
<ul class="simple">
<li><p>Hybrid configuration; token accounting; offsets/spans; Parquet writer; golden chunk fixtures.</p></li>
</ul>
</li>
<li><p><strong>Dense embeddings (Qwen3 2560‑d)</strong></p>
<ul class="simple">
<li><p>vLLM client; batching &amp; normalization; Parquet writer; memory instrumentation; retries.</p></li>
</ul>
</li>
<li><p><strong>SPLADE‑v3 GPU encoder + Pyserini indices</strong></p>
<ul class="simple">
<li><p>Torch 2.9 encoder; Parquet encoder; streaming into Lucene (impact); BM25 build; query APIs.</p></li>
</ul>
</li>
<li><p><strong>FAISS GPU/cuVS</strong></p>
<ul class="simple">
<li><p>Binary installation or source build; index builder (OPQ64,IVF8192,PQ64); training sampler; shard manager; search adapter.</p></li>
</ul>
</li>
<li><p><strong>Ontology &amp; concept embeddings</strong></p>
<ul class="simple">
<li><p>Loaders (OWL/OBO/SKOS); normalization; concept Parquet; Qwen3(2560) + SPLADE encoders.</p></li>
</ul>
</li>
<li><p><strong>Linker</strong></p>
<ul class="simple">
<li><p>Candidate gen; fusion; calibration (isotonic); assertions Parquet; explainability; ablations.</p></li>
</ul>
</li>
<li><p><strong>KG Builder (Neo4j)</strong></p>
<ul class="simple">
<li><p>Node/edge upserts; constraints; indexes; maintenance; graph query helpers.</p></li>
</ul>
</li>
<li><p><strong>Search API</strong></p>
<ul class="simple">
<li><p>FastAPI; hybrid retrieval; RRF; KG boosts; MMR; explanations; OpenAPI schema; auth.</p></li>
</ul>
</li>
<li><p><strong>Registry (DuckDB)</strong></p>
<ul class="simple">
<li><p>Migrations; registration helpers; views across Parquet; integrity checks; provenance guards.</p></li>
</ul>
</li>
<li><p><strong>Orchestration &amp; Observability</strong></p>
<ul class="simple">
<li><p>Prefect flows; retries; dashboards; tracing; alerting; local startup scripts.</p></li>
</ul>
</li>
</ol>
</section>
<hr class="docutils" />
<section id="coding-standards-bestinclass-python-practices">
<h1>25) Coding standards &amp; best‑in‑class Python practices<a class="headerlink" href="#coding-standards-bestinclass-python-practices" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><strong>Static typing</strong> everywhere (<code class="docutils literal notranslate"><span class="pre">mypy</span> <span class="pre">--strict</span></code>).</p></li>
<li><p><strong>Pydantic v2</strong> for all externalized contracts; validate at boundaries only.</p></li>
<li><p><strong>Dataclasses/NamedTuples</strong> for internal‑only small records on hot paths.</p></li>
<li><p><strong>Pure functions</strong> for transformations; side effects behind adapters.</p></li>
<li><p><strong>Dependency inversion</strong>: constructors accept interfaces, not concretes.</p></li>
<li><p><strong>Factories</strong> resolve plugins from entry‑points; no <code class="docutils literal notranslate"><span class="pre">if/elif</span></code> on provider names in business logic.</p></li>
<li><p><strong>Error handling</strong>: wrap external calls in <code class="docutils literal notranslate"><span class="pre">Result[T,</span> <span class="pre">E]</span></code>‑like helpers (or <code class="docutils literal notranslate"><span class="pre">try/except</span></code> mapping to domain errors).</p></li>
<li><p><strong>Logging</strong>: structured (<code class="docutils literal notranslate"><span class="pre">json</span></code>); include <code class="docutils literal notranslate"><span class="pre">run_id</span></code>, <code class="docutils literal notranslate"><span class="pre">doc_id</span></code>, <code class="docutils literal notranslate"><span class="pre">chunk_id</span></code>.</p></li>
<li><p><strong>Testing</strong>: unit + contract tests per port; “fake” in‑memory providers; golden tests for DocTags/chunks; end‑to‑end smoke.</p></li>
<li><p><strong>Performance</strong>: vector ops on GPU; streaming I/O; Parquet row groups sized for cache locality; avoid pandas on hot paths.</p></li>
<li><p><strong>Docs</strong>: every public class/method has docstrings; README per package; ADRs for significant choices.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="addendum-additional-architecture-information">
<h1>Addendum - additional architecture information<a class="headerlink" href="#addendum-additional-architecture-information" title="Link to this heading">#</a></h1>
<section id="part-a-gap-analysis-whats-unspecified-resolutions-in-addendum">
<h2>PART A — GAP ANALYSIS (WHAT’S UNSPECIFIED) → RESOLUTIONS IN ADDENDUM<a class="headerlink" href="#part-a-gap-analysis-whats-unspecified-resolutions-in-addendum" title="Link to this heading">#</a></h2>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Area</p></th>
<th class="head"><p>Gap / ambiguity</p></th>
<th class="head"><p>Why it matters</p></th>
<th class="head"><p>Final specification (summary)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Canonical text &amp; ID hashing</strong></p></td>
<td><p>Exact <em>canonicalization</em> pipeline from DocTags to text (line breaks, whitespace, Unicode norms) not fixed; ID hashing step unclear.</p></td>
<td><p>Reproducibility; stable <code class="docutils literal notranslate"><span class="pre">doc_id</span></code>, <code class="docutils literal notranslate"><span class="pre">chunk_id</span></code>.</p></td>
<td><p>Define canonicalizer (NFC → collapse whitespace → normalize bullets/ligatures → Unix line endings). Hash <strong>canonical text</strong> SHA‑256, use first 16 bytes (base32) for URNs. (§B1)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Tokenizer for chunk sizes</strong></p></td>
<td><p>Which tokenizer governs <code class="docutils literal notranslate"><span class="pre">target_tokens</span></code> not pinned.</p></td>
<td><p>Chunk consistency, embedding costs.</p></td>
<td><p>Use <strong>Qwen3‑Embedding tokenizer</strong> via HF <code class="docutils literal notranslate"><span class="pre">AutoTokenizer</span></code> for token counts. (§B2)</p></td>
</tr>
<tr class="row-even"><td><p><strong>DocTags fidelity</strong></p></td>
<td><p>Which DocTags nodes to include/exclude (headers/footers/refs), and OCR fallback merge rules unclear.</p></td>
<td><p>Content quality; linkability back to pages.</p></td>
<td><p>Include body, headings, tables, captions, figure text; exclude references by default. OCR per‑page fallback with provenance flag; page order preserved. (§B3)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Downloader resolution order &amp; de‑dupe</strong></p></td>
<td><p>Ties between multiple OA locations; DOI/arXiv/PMCID overlaps; file dedup not specified.</p></td>
<td><p>Avoid duplicate processing and wasted space.</p></td>
<td><p>Stable priority list (OpenAlex best_oa → other locations → Unpaywall → source‑specific), MIME check; compute <code class="docutils literal notranslate"><span class="pre">pdf_sha256</span></code>; deduplicate by hash; symlink duplicate DoIs. (§B4)</p></td>
</tr>
<tr class="row-even"><td><p><strong>PyAlex topic query spec</strong></p></td>
<td><p>Which OpenAlex fields are searched; year filters and pagination; retries/timeouts not fixed.</p></td>
<td><p>Recall and reliability.</p></td>
<td><p>Search <code class="docutils literal notranslate"><span class="pre">title,</span> <span class="pre">abstract_inverted_index,</span> <span class="pre">fulltext</span></code> with AND semantics; filter by <code class="docutils literal notranslate"><span class="pre">from_year..to_year</span></code>; <code class="docutils literal notranslate"><span class="pre">per_page=200</span></code>; backoff retries 3×; http timeout 30 s; polite <code class="docutils literal notranslate"><span class="pre">User-Agent</span></code> and mailto. (§B4)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Qwen3 embeddings 2560‑d</strong></p></td>
<td><p>Request parameter to enforce 2560 output; failure behavior if unsupported.</p></td>
<td><p>Index shape; FAISS train.</p></td>
<td><p>Request <code class="docutils literal notranslate"><span class="pre">dimension=2560</span></code>; assert response dim; if unsupported (model mismatch), <strong>fail fast</strong> and record incident. (§B5)</p></td>
</tr>
<tr class="row-even"><td><p><strong>SPLADE‑v3 GPU encoder</strong></p></td>
<td><p>Pre‑processing (lowercasing, punctuation), truncation, batching, AMP, and top‑K pruning details not pinned.</p></td>
<td><p>Index size and quality; repeatability.</p></td>
<td><p>Lowercase; strip control chars; keep punctuation; truncation at 512 WP tokens; AMP fp16; batch size auto‑tuned; top‑K=256 with stable tiebreaker (token id). (§B6)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>BM25 analyzer</strong></p></td>
<td><p>Analyzer pipeline (tokenizer, stopwords, stemming, casefold) not fixed.</p></td>
<td><p>Matching behavior and score comparability.</p></td>
<td><p>Lucene StandardTokenizer; English minimal stemming; lowercase; English stoplist; synonyms off by default (can be added per domain). (§B6)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Parquet schemas &amp; partitioning</strong></p></td>
<td><p>Columns, dtypes, compression, row group size, directory partitioning not fully fixed.</p></td>
<td><p>IO performance; schema drift.</p></td>
<td><p>Fixed schemas listed; <strong>ZSTD=6</strong>, <code class="docutils literal notranslate"><span class="pre">row_group=4096</span></code>; partition by <code class="docutils literal notranslate"><span class="pre">model</span></code>, <code class="docutils literal notranslate"><span class="pre">run_id</span></code>, <code class="docutils literal notranslate"><span class="pre">shard</span></code>; filename <code class="docutils literal notranslate"><span class="pre">part-&lt;nnnnn&gt;.parquet</span></code>. (§B7)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>DuckDB catalog</strong></p></td>
<td><p>Migrations, integrity checks, FK behaviors, thread settings unspecified.</p></td>
<td><p>Registry reliability.</p></td>
<td><p>Versioned migrations (<code class="docutils literal notranslate"><span class="pre">registry/migrations/*.sql</span></code>), FK constraints, indexes, <code class="docutils literal notranslate"><span class="pre">PRAGMA</span> <span class="pre">threads=14</span></code>, two‑phase registration. (§B8)</p></td>
</tr>
<tr class="row-even"><td><p><strong>FAISS details (GPU+cuVS)</strong></p></td>
<td><p>Factory choice confirmed, but training sample selection, OPQ params, memory budgeting, shard policy not fully pinned.</p></td>
<td><p>Performance &amp; determinism.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">OPQ64,IVF8192,PQ64</span></code>, train on 10M random (seed 42); <code class="docutils literal notranslate"><span class="pre">nprobe=64</span></code>; ≤10M vectors/shard; GPU add/search; save <code class="docutils literal notranslate"><span class="pre">.faiss</span></code> + <code class="docutils literal notranslate"><span class="pre">.ids</span></code>. (§B9)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>vLLM topology</strong></p></td>
<td><p>Routing is known, but request/response schemas, timeouts, retries, health checks not fully specified.</p></td>
<td><p>Client stability.</p></td>
<td><p>OpenAI‑compatible <code class="docutils literal notranslate"><span class="pre">/v1/embeddings</span></code>; per‑request timeout 30 s; 3× retries; health endpoints <code class="docutils literal notranslate"><span class="pre">/v1/models</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">/health</span></code>; router (Nginx) config pinned; backpressure policy documented. (§B10)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Ontology ingestion</strong></p></td>
<td><p>Supported predicates for labels/synonyms/defs, CURIE mapping, deprecations, and merges not fully specified.</p></td>
<td><p>Correct concept catalog and IDs.</p></td>
<td><p>Accept SKOS (<code class="docutils literal notranslate"><span class="pre">prefLabel</span></code>,<code class="docutils literal notranslate"><span class="pre">altLabel</span></code>), OBO (<code class="docutils literal notranslate"><span class="pre">hasExactSynonym</span></code>,<code class="docutils literal notranslate"><span class="pre">def</span></code>), RDFS labels; support <code class="docutils literal notranslate"><span class="pre">deprecated</span></code> and <code class="docutils literal notranslate"><span class="pre">replaced_by</span></code>; CURIE mapping table; normalize text; unique <code class="docutils literal notranslate"><span class="pre">urn:concept:&lt;ont&gt;:&lt;curie&gt;</span></code>. (§B11)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Linker calibration</strong></p></td>
<td><p>Dev set size, fold policy, calibration storage, and runtime application not explicit.</p></td>
<td><p>Score interpretability.</p></td>
<td><p>Dev set 2,000 chunk‑concept pairs labeled; 5‑fold isotonic regression; parameters stored per <code class="docutils literal notranslate"><span class="pre">linker_run_id</span></code>; applied at runtime; ECE reported. (§B12)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Hybrid fusion math</strong></p></td>
<td><p>RRF <code class="docutils literal notranslate"><span class="pre">k</span></code>, candidate pool sizes, KG boost exact math not completely fixed.</p></td>
<td><p>Deterministic results.</p></td>
<td><p>Dense&#64;200 + Sparse&#64;200; <strong>RRF(k=60)</strong>; KG boosts: direct +0.08, 1‑hop +0.04; MMR λ=0.7 at doc level. (§B13)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>API design</strong></p></td>
<td><p>Only endpoint sketch; errors, pagination, filters, sorting, rate limits, auth, and OpenAPI not fully specified.</p></td>
<td><p>Independent backend/frontend work.</p></td>
<td><p>Full <strong>OpenAPI</strong> spec, error schema, pagination, filters (year, source, license), API‑key auth, per‑key rate limits (local token bucket), JSON response formats. (§B14)</p></td>
</tr>
<tr class="row-even"><td><p><strong>End‑to‑end testing</strong></p></td>
<td><p>What E2E scenarios and fixtures to use; success criteria per stage unclear.</p></td>
<td><p>Integration confidence.</p></td>
<td><p>Provide seed corpora (10 docs), synthetic ontologies, golden outputs; E2E pipeline test that asserts all DDLs, artifact counts, index sizes, retrieval metrics over thresholds. (§B15)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Observability</strong></p></td>
<td><p>Log schema, metric names, labels, exemplar traces, dashboards unspecified.</p></td>
<td><p>Ops readiness.</p></td>
<td><p>Define <strong>metrics</strong> (names, types), <strong>logs</strong> (JSON schema), <strong>traces</strong> (span names &amp; attributes); provide Grafana panels JSON. (§B16)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Failure handling</strong></p></td>
<td><p>Error taxonomy, retry matrices, poison‑pill protocol, quarantine dirs not fixed.</p></td>
<td><p>Robustness under real corpora.</p></td>
<td><p>Standard error classes; retry/backoff tables; quarantine locations; incident log table and CLI. (§B17)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Security &amp; licensing</strong></p></td>
<td><p>Key storage, license enforcement points, audit fields not formalized.</p></td>
<td><p>Compliance and reproducibility.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.env</span></code> for secrets; license filters in downloader; persist license string and OA source; audit table records provenance; API keys in env; localhost binding. (§B18)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Project structure &amp; code quality</strong></p></td>
<td><p>Pre‑commit, linters, typing level, docstrings, ADRs, contribution workflow not locked.</p></td>
<td><p>Team velocity &amp; consistency.</p></td>
<td><p>Pre‑commit (ruff, black, mypy‑strict), conventional commits, ADR template, mkdocs site, contribution guide, codeowners. (§B19)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Local dev &amp; bootstrap</strong></p></td>
<td><p>No exact bootstrap steps and Make targets.</p></td>
<td><p>Fast onboarding.</p></td>
<td><p>Provide <code class="docutils literal notranslate"><span class="pre">scripts/bootstrap.sh</span></code>, <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> targets, systemd units for vLLM + Nginx, folder layout creation. (§B20)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Performance SLAs</strong></p></td>
<td><p>Hard SLAs and perf targets partially stated.</p></td>
<td><p>Planning &amp; regression gates.</p></td>
<td><p>SLAs/SLOs formalized per stage; CI gates with thresholds; perf budgets by stage. (§B21)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<hr class="docutils" />
<section id="part-b-exhaustive-specifications-resolutions">
<h2>PART B — EXHAUSTIVE SPECIFICATIONS (RESOLUTIONS)<a class="headerlink" href="#part-b-exhaustive-specifications-resolutions" title="Link to this heading">#</a></h2>
<section id="b1-canonical-text-hashing-ids">
<h3>B1. Canonical text, hashing &amp; IDs<a class="headerlink" href="#b1-canonical-text-hashing-ids" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Canonicalizer</strong> (DocTags → text):</p>
<ol class="arabic simple">
<li><p>Decode UTF‑8; apply <strong>Unicode NFC</strong>.</p></li>
<li><p>Replace Windows/old Mac line breaks with <code class="docutils literal notranslate"><span class="pre">\n</span></code>.</p></li>
<li><p>Collapse runs of whitespace to a single space <strong>except</strong> keep single <code class="docutils literal notranslate"><span class="pre">\n</span></code> line breaks between block nodes (paragraph/heading/list/table caption).</p></li>
<li><p>Normalize bullets (<code class="docutils literal notranslate"><span class="pre">•</span></code>, <code class="docutils literal notranslate"><span class="pre">◦</span></code>, <code class="docutils literal notranslate"><span class="pre">–</span></code>) to <code class="docutils literal notranslate"><span class="pre">-</span></code>.</p></li>
<li><p>Strip page headers/footers using DocTags region types; <strong>exclude References</strong> section by default (configurable).</p></li>
<li><p>Retain figure/table captions, equations (inline LaTeX left as‑is), and footnotes (inlined at end of page).</p></li>
</ol>
</li>
<li><p><strong>doc_id</strong>: <code class="docutils literal notranslate"><span class="pre">urn:doc:sha256:&lt;first16B</span> <span class="pre">base32&gt;</span></code> over <strong>canonical text</strong> (not PDF bytes).</p></li>
<li><p><strong>chunk_id</strong>: <code class="docutils literal notranslate"><span class="pre">urn:chunk:&lt;doc_hash&gt;:&lt;start&gt;-&lt;end&gt;</span></code> using <strong>character offsets</strong> in canonical text (inclusive start, exclusive end).</p></li>
<li><p>Hashes computed with SHA‑256; extraction reproducible.</p></li>
</ul>
</section>
<section id="b2-tokenizer-chunking-quantization">
<h3>B2. Tokenizer &amp; chunking quantization<a class="headerlink" href="#b2-tokenizer-chunking-quantization" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Tokenizer of record</strong>: HuggingFace tokenizer for <strong>Qwen/Qwen3‑Embedding‑4B</strong>.</p></li>
<li><p><strong>Chunker parameters (fixed defaults)</strong>: <code class="docutils literal notranslate"><span class="pre">target=400</span></code>, <code class="docutils literal notranslate"><span class="pre">overlap=80</span></code>, <code class="docutils literal notranslate"><span class="pre">min=120</span></code>, <code class="docutils literal notranslate"><span class="pre">max=480</span></code> <strong>Qwen tokens</strong>; stride=<code class="docutils literal notranslate"><span class="pre">target-overlap=320</span></code>.</p></li>
<li><p>If a section is shorter than 120 tokens and can be merged with its successor without exceeding 480, merge; otherwise leave standalone.</p></li>
<li><p>Sliding spill‑windows never cross major section boundaries (title/abstract/intro/methods/results/discussion).</p></li>
</ul>
</section>
<section id="b3-doctags-selection-ocr-fallback">
<h3>B3. DocTags selection &amp; OCR fallback<a class="headerlink" href="#b3-doctags-selection-ocr-fallback" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Include</strong>: title, authors, abstract, section headings, paragraphs, lists, tables, figures’ captions, equations.</p></li>
<li><p><strong>Exclude</strong> by default: acknowledgements, references; can enable via <code class="docutils literal notranslate"><span class="pre">config.doc_conversion.include_references=true</span></code>.</p></li>
<li><p><strong>OCR</strong>: page‑level fallback using Tesseract when Docling VLM avg logprob &lt; 0.5; OCR text anchored into DocTags page node with <code class="docutils literal notranslate"><span class="pre">provenance=&quot;ocr&quot;</span></code>.</p></li>
<li><p><strong>Provenance</strong> fields in DoctagsAsset: <code class="docutils literal notranslate"><span class="pre">{avg_logprob,</span> <span class="pre">ocr_pages:[int]}</span></code>.</p></li>
</ul>
</section>
<section id="b4-harvester-downloader-pyalex-first-with-fallbacks">
<h3>B4. Harvester &amp; downloader (PyAlex first, with fallbacks)<a class="headerlink" href="#b4-harvester-downloader-pyalex-first-with-fallbacks" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>PyAlex search</strong>:</p>
<ul>
<li><p>Query compiled as AND of: <code class="docutils literal notranslate"><span class="pre">topic</span></code> (applied to <code class="docutils literal notranslate"><span class="pre">title</span></code>, <code class="docutils literal notranslate"><span class="pre">abstract_inverted_index</span></code>, <code class="docutils literal notranslate"><span class="pre">fulltext</span></code>), optional <code class="docutils literal notranslate"><span class="pre">year</span> <span class="pre">&gt;=</span> <span class="pre">from_year</span></code>, <code class="docutils literal notranslate"><span class="pre">is_oa=true</span> <span class="pre">OR</span> <span class="pre">has_oa_published_version=true</span> <span class="pre">OR</span> <span class="pre">has_oa_accepted_or_published_version=true</span></code>.</p></li>
<li><p>Pagination: <code class="docutils literal notranslate"><span class="pre">per_page=200</span></code>, resume with <code class="docutils literal notranslate"><span class="pre">cursor</span></code>, cap at <code class="docutils literal notranslate"><span class="pre">max_works</span></code>.</p></li>
<li><p>HTTP timeout=30 s, retries=3 (exponential 1.0/2.0/4.0 s), <code class="docutils literal notranslate"><span class="pre">User-Agent:</span> <span class="pre">kgforge/1.0</span> <span class="pre">(+contact&#64;example.com)</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Resolution priority</strong> (first success wins):</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">best_oa_location.pdf_url</span></code> (OpenAlex).</p></li>
<li><p>Any <code class="docutils literal notranslate"><span class="pre">locations[].pdf_url</span></code> with <code class="docutils literal notranslate"><span class="pre">is_oa=true</span></code> (prefer <code class="docutils literal notranslate"><span class="pre">publishedVersion</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">acceptedVersion</span></code>).</p></li>
<li><p><strong>Unpaywall</strong> by DOI → <code class="docutils literal notranslate"><span class="pre">url_for_pdf</span></code>.</p></li>
<li><p>Source‑specific fallback: arXiv (<code class="docutils literal notranslate"><span class="pre">/pdf/&lt;id&gt;.pdf</span></code>), PMC article PDF.</p></li>
</ol>
</li>
<li><p><strong>MIME + size checks</strong>: Require <code class="docutils literal notranslate"><span class="pre">application/pdf</span></code>; max size 100 MB (configurable).</p></li>
<li><p><strong>De‑dup</strong>: compute <code class="docutils literal notranslate"><span class="pre">pdf_sha256</span></code> of bytes; if duplicate of an existing doc, <strong>link</strong> new metadata to existing file and record alias (<code class="docutils literal notranslate"><span class="pre">openalex_id</span></code>, <code class="docutils literal notranslate"><span class="pre">doi</span></code>, etc.).</p></li>
<li><p><strong>Registration</strong>: Insert into <code class="docutils literal notranslate"><span class="pre">documents</span></code> with all source IDs, <code class="docutils literal notranslate"><span class="pre">pdf_uri</span></code>, license, OA source, and timestamp.</p></li>
</ul>
</section>
<section id="b5-dense-embeddings-qwen3-2560d">
<h3>B5. Dense embeddings (Qwen3 2560‑d)<a class="headerlink" href="#b5-dense-embeddings-qwen3-2560d" title="Link to this heading">#</a></h3>
<ul>
<li><p><strong>API</strong>: OpenAI‑compatible <code class="docutils literal notranslate"><span class="pre">/v1/embeddings</span></code> with body:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="s2">&quot;Qwen/Qwen3-Embedding-4B&quot;</span><span class="p">,</span><span class="nt">&quot;input&quot;</span><span class="p">:[</span><span class="w"> </span><span class="s2">&quot;...chunk text...&quot;</span><span class="w"> </span><span class="p">],</span><span class="nt">&quot;dimensions&quot;</span><span class="p">:</span><span class="mi">2560</span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><strong>Response validation</strong>: assert vector length 2560; otherwise <strong>fail run</strong> with incident record.</p></li>
<li><p><strong>Batching</strong>: dynamic batch size uses VRAM probe; keep <strong>≤80%</strong> VRAM.</p></li>
<li><p><strong>Normalization</strong>: client L2‑normalizes vector (float32) and stores original L2.</p></li>
<li><p><strong>Errors</strong>: HTTP 429/5xx → retries (3×); timeouts → retries; after 3 failures, quarantine batch.</p></li>
</ul>
</section>
<section id="b6-sparse-spladev3-gpu-bm25-details">
<h3>B6. Sparse (SPLADE‑v3 GPU) &amp; BM25 details<a class="headerlink" href="#b6-sparse-spladev3-gpu-bm25-details" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>SPLADE‑v3 encoder</strong>:</p>
<ul>
<li><p>Pre‑proc: lowercase; strip control chars (<code class="docutils literal notranslate"><span class="pre">\x00</span></code>..<code class="docutils literal notranslate"><span class="pre">\x1f</span></code>), keep punctuation; whitespace collapse single space; no stopword removal.</p></li>
<li><p>Tokenization: DistilBERT WordPiece; <code class="docutils literal notranslate"><span class="pre">max_seq_len=512</span></code> (truncate tail).</p></li>
<li><p>AMP: <code class="docutils literal notranslate"><span class="pre">torch.autocast(device_type=&quot;cuda&quot;,</span> <span class="pre">dtype=torch.float16)</span></code>.</p></li>
<li><p>Batch size: auto‑tuned per GPU memory; cap at 2048 tokens/batch.</p></li>
<li><p>Top‑K pruning: select top 256 weights by value; tie‑break by <strong>token id asc</strong>; <strong>sort ascending</strong> token ids for indexer.</p></li>
</ul>
</li>
<li><p><strong>BM25 (Pyserini/Lucene)</strong>:</p>
<ul>
<li><p>Analyzer: StandardTokenizer → Lowercase → EnglishMinimalStemFilter → EnglishStopFilter.</p></li>
<li><p>Params: <code class="docutils literal notranslate"><span class="pre">k1=0.9</span></code>, <code class="docutils literal notranslate"><span class="pre">b=0.4</span></code>.</p></li>
<li><p>Fields: <code class="docutils literal notranslate"><span class="pre">title</span></code> (boost 2.0), <code class="docutils literal notranslate"><span class="pre">section</span></code> (1.2), <code class="docutils literal notranslate"><span class="pre">body</span></code> (1.0). Title from DocTags title node; section from chunk.section; body from chunk text.</p></li>
</ul>
</li>
</ul>
</section>
<section id="b7-parquet-datasets-all-embeddings-and-chunks">
<h3>B7. Parquet datasets (ALL embeddings and chunks)<a class="headerlink" href="#b7-parquet-datasets-all-embeddings-and-chunks" title="Link to this heading">#</a></h3>
<ul>
<li><p><strong>Common options</strong>: <code class="docutils literal notranslate"><span class="pre">compression=&quot;ZSTD&quot;</span></code>, level=6; <code class="docutils literal notranslate"><span class="pre">row_group_size=4096</span></code>; <code class="docutils literal notranslate"><span class="pre">use_dictionary=True</span></code> for categorical columns (<code class="docutils literal notranslate"><span class="pre">model</span></code>, <code class="docutils literal notranslate"><span class="pre">run_id</span></code>, <code class="docutils literal notranslate"><span class="pre">doc_id</span></code>, <code class="docutils literal notranslate"><span class="pre">section</span></code>).</p></li>
<li><p><strong>Dense</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chunk_id</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="n">int16</span> <span class="p">(</span><span class="o">=</span><span class="mi">2560</span><span class="p">),</span>
<span class="n">vector</span><span class="p">:</span> <span class="nb">list</span><span class="o">&lt;</span><span class="nb">float</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">l2_norm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">created_at</span><span class="p">:</span> <span class="n">timestamp</span>
</pre></div>
</div>
<p>Partitions: <code class="docutils literal notranslate"><span class="pre">model=Qwen3-Embedding-4B/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</span></code>.</p>
</li>
<li><p><strong>SPLADE</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chunk_id</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span>
<span class="n">vocab_ids</span><span class="p">:</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">list</span><span class="o">&lt;</span><span class="nb">float</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">nnz</span><span class="p">:</span> <span class="n">int16</span><span class="p">,</span> <span class="n">created_at</span><span class="p">:</span> <span class="n">timestamp</span>
</pre></div>
</div>
<p>Partitions: <code class="docutils literal notranslate"><span class="pre">model=SPLADE-v3-distilbert/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</span></code>.</p>
</li>
<li><p><strong>Chunks</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">start_char</span><span class="p">:</span><span class="n">int32</span><span class="p">,</span> <span class="n">end_char</span><span class="p">:</span><span class="n">int32</span><span class="p">,</span>
<span class="n">doctags_span</span><span class="p">:</span> <span class="n">struct</span><span class="o">&lt;</span><span class="n">node_id</span><span class="p">:</span><span class="n">string</span><span class="p">,</span><span class="n">start</span><span class="p">:</span><span class="n">int32</span><span class="p">,</span><span class="n">end</span><span class="p">:</span><span class="n">int32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="n">text</span><span class="p">:</span><span class="n">string</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span><span class="n">int32</span><span class="p">,</span> <span class="n">created_at</span><span class="p">:</span><span class="n">timestamp</span>
</pre></div>
</div>
<p>Partition: <code class="docutils literal notranslate"><span class="pre">model=docling_hybrid/run_id=&lt;run&gt;/shard=&lt;nnnn&gt;</span></code>.</p>
</li>
</ul>
</section>
<section id="b8-duckdb-registry-1-4-1-migrations-guards">
<h3>B8. DuckDB registry (≥ 1.4.1): migrations &amp; guards<a class="headerlink" href="#b8-duckdb-registry-1-4-1-migrations-guards" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Migrations</strong>: SQL files in <code class="docutils literal notranslate"><span class="pre">/registry/migrations</span></code>, applied by <code class="docutils literal notranslate"><span class="pre">registry</span> <span class="pre">apply-migrations</span></code>. Each migration increments <code class="docutils literal notranslate"><span class="pre">schema_version</span></code> table.</p></li>
<li><p><strong>Two‑phase registration</strong>: write Parquet to temp dir → validate row counts &amp; schema → <code class="docutils literal notranslate"><span class="pre">BEGIN</span></code> → insert into <code class="docutils literal notranslate"><span class="pre">datasets</span></code>/<code class="docutils literal notranslate"><span class="pre">runs</span></code> → <code class="docutils literal notranslate"><span class="pre">COMMIT</span></code> → rename dir into place; on failure <code class="docutils literal notranslate"><span class="pre">ROLLBACK</span></code> and delete temp.</p></li>
<li><p><strong>Threading</strong>: <code class="docutils literal notranslate"><span class="pre">PRAGMA</span> <span class="pre">threads=14</span></code>; all read_parquet with <code class="docutils literal notranslate"><span class="pre">union_by_name=true</span></code>.</p></li>
<li><p><strong>Integrity</strong>: FKs and unique constraints as defined.</p></li>
<li><p><strong>Views</strong>: <code class="docutils literal notranslate"><span class="pre">dense_vectors_view</span></code>, <code class="docutils literal notranslate"><span class="pre">splade_vectors_view</span></code>, <code class="docutils literal notranslate"><span class="pre">chunk_texts</span></code> pre‑created.</p></li>
</ul>
</section>
<section id="b9-faiss-gpu-cuvs-cuda-13">
<h3>B9. FAISS GPU + cuVS (CUDA 13)<a class="headerlink" href="#b9-faiss-gpu-cuvs-cuda-13" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Factory</strong>: <code class="docutils literal notranslate"><span class="pre">OPQ64,IVF8192,PQ64</span></code> (for d=2560).</p></li>
<li><p><strong>Train</strong>: Random sample of <strong>min(10M, 100% of corpus)</strong> dense vectors; seed=42; normalize before train.</p></li>
<li><p><strong>Add</strong>: On GPU; batch of N where memory ≤ 80% VRAM; record adds per shard in DuckDB.</p></li>
<li><p><strong>Search</strong>: <code class="docutils literal notranslate"><span class="pre">nprobe=64</span></code>; return distances as <strong>IP or L2</strong> consistent with training (we use <strong>IP</strong> on normalized vectors → cosine).</p></li>
<li><p><strong>Persist</strong>: <code class="docutils literal notranslate"><span class="pre">.faiss</span></code> index + <code class="docutils literal notranslate"><span class="pre">.ids</span></code> idmap per shard; <code class="docutils literal notranslate"><span class="pre">faiss_indexes</span></code> table records <code class="docutils literal notranslate"><span class="pre">logical_index_id</span></code>, <code class="docutils literal notranslate"><span class="pre">shard_id</span></code>, file paths, config.</p></li>
<li><p><strong>Merge</strong>: logical index = set of shards; search fans out to shards, merges top‑K.</p></li>
</ul>
</section>
<section id="b10-vllm-servers-router">
<h3>B10. vLLM servers &amp; router<a class="headerlink" href="#b10-vllm-servers-router" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Granite‑Docling (VLM)</strong>: vLLM process #1 on <code class="docutils literal notranslate"><span class="pre">127.0.0.1:8001</span></code>.</p></li>
<li><p><strong>Qwen3 embeddings</strong>: vLLM process #2 on <code class="docutils literal notranslate"><span class="pre">127.0.0.1:8002</span></code>.</p></li>
<li><p><strong>Router</strong>: Nginx on <code class="docutils literal notranslate"><span class="pre">:80</span></code> maps <code class="docutils literal notranslate"><span class="pre">/vlm/*</span></code> → 8001 and <code class="docutils literal notranslate"><span class="pre">/v1/embeddings</span></code> → 8002.</p></li>
<li><p><strong>Health checks</strong>: <code class="docutils literal notranslate"><span class="pre">/healthz</span></code> on router; <code class="docutils literal notranslate"><span class="pre">/v1/models</span></code> on each vLLM.</p></li>
<li><p><strong>Client policy</strong>: per‑request timeout 30 s, retries ×3 (429/5xx), exponential backoff 1/2/4 s; circuit‑breaker opens after 10 consecutive failures (per‑service) for 30 s.</p></li>
</ul>
</section>
<section id="b11-ontology-ingestion-catalog">
<h3>B11. Ontology ingestion &amp; catalog<a class="headerlink" href="#b11-ontology-ingestion-catalog" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Formats</strong>: OBO, OWL/RDF (TTL, RDF/XML), SKOS (RDF).</p></li>
<li><p><strong>Predicates</strong>:</p>
<ul>
<li><p>Labels: <code class="docutils literal notranslate"><span class="pre">rdfs:label</span></code>, <code class="docutils literal notranslate"><span class="pre">skos:prefLabel</span></code>.</p></li>
<li><p>Synonyms: <code class="docutils literal notranslate"><span class="pre">oboInOwl:hasExactSynonym</span></code>, <code class="docutils literal notranslate"><span class="pre">skos:altLabel</span></code>.</p></li>
<li><p>Definitions: <code class="docutils literal notranslate"><span class="pre">IAO:0000115</span></code>, <code class="docutils literal notranslate"><span class="pre">skos:definition</span></code>.</p></li>
<li><p>Hierarchy: <code class="docutils literal notranslate"><span class="pre">rdfs:subClassOf</span></code>, <code class="docutils literal notranslate"><span class="pre">skos:broader</span></code>, <code class="docutils literal notranslate"><span class="pre">BFO:part_of</span></code> (normalized to <code class="docutils literal notranslate"><span class="pre">IS_A</span></code> or <code class="docutils literal notranslate"><span class="pre">PART_OF</span></code>).</p></li>
<li><p>Deprecation: <code class="docutils literal notranslate"><span class="pre">owl:deprecated</span></code> true; replacements: <code class="docutils literal notranslate"><span class="pre">iao:0100001</span></code> or custom <code class="docutils literal notranslate"><span class="pre">replaced_by</span></code>.</p></li>
</ul>
</li>
<li><p><strong>CURIEs</strong>: Provide <code class="docutils literal notranslate"><span class="pre">prefix</span> <span class="pre">→</span> <span class="pre">base</span> <span class="pre">IRI</span></code> map per ontology; compute <code class="docutils literal notranslate"><span class="pre">urn:concept:&lt;ont&gt;:&lt;CURIE&gt;</span></code>.</p></li>
<li><p><strong>Normalization</strong>: lowercased, NFC, punctuation trimmed (except hyphen and slash), English lemmatization.</p></li>
<li><p><strong>Concept embeddings</strong>:</p>
<ul>
<li><p>Dense (Qwen3 2560‑d): text = <code class="docutils literal notranslate"><span class="pre">pref_label</span> <span class="pre">|</span> <span class="pre">definition</span> <span class="pre">|</span> <span class="pre">top5_synonyms</span></code>; same Parquet schema as chunks (swap <code class="docutils literal notranslate"><span class="pre">chunk_id</span> <span class="pre">→</span> <span class="pre">concept_id</span></code>).</p></li>
<li><p>Sparse (SPLADE): text same as above; topK=128.</p></li>
</ul>
</li>
</ul>
</section>
<section id="b12-linker-calibration-decision-policy">
<h3>B12. Linker calibration &amp; decision policy<a class="headerlink" href="#b12-linker-calibration-decision-policy" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Labeling</strong>: 2,000 chunk‑concept candidate pairs labeled by domain curators.</p></li>
<li><p><strong>Splits</strong>: 5‑fold CV; train isotonic regression to map fused score → calibrated [0,1].</p></li>
<li><p><strong>Thresholds</strong>: <code class="docutils literal notranslate"><span class="pre">τ_high=0.62</span></code>, <code class="docutils literal notranslate"><span class="pre">τ_low=0.35</span></code> applied <strong>after calibration</strong>.</p></li>
<li><p><strong>Outputs</strong>: save calibration params in DuckDB as JSON attached to <code class="docutils literal notranslate"><span class="pre">run_id</span></code> (linker run).</p></li>
<li><p><strong>Metrics</strong>: precision/recall/F1; <strong>Expected Calibration Error</strong> (ECE).</p></li>
</ul>
</section>
<section id="b13-hybrid-retrieval-fusion-fixed-math">
<h3>B13. Hybrid retrieval fusion (fixed math)<a class="headerlink" href="#b13-hybrid-retrieval-fusion-fixed-math" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Retrieval</strong>: <code class="docutils literal notranslate"><span class="pre">dense&#64;200</span></code> (FAISS), <code class="docutils literal notranslate"><span class="pre">sparse&#64;200</span></code> (BM25 and SPLADE each produce lists; we interleave by highest score then take top 200 combined sparse).</p></li>
<li><p><strong>RRF</strong>: <code class="docutils literal notranslate"><span class="pre">RRF_k</span> <span class="pre">=</span> <span class="pre">60</span></code>. Score = <code class="docutils literal notranslate"><span class="pre">Σ</span> <span class="pre">1/(k</span> <span class="pre">+</span> <span class="pre">rank_i)</span></code> over participating rankers (dense, bm25, splade).</p></li>
<li><p><strong>KG boost</strong>: +0.08 if any linked concept of chunk ∈ query concepts; +0.04 if within one ontology hop; max boost +0.12.</p></li>
<li><p><strong>MMR</strong>: doc‑level, <code class="docutils literal notranslate"><span class="pre">λ=0.7</span></code>; similarity measured by cosine of mean chunk vectors per doc.</p></li>
</ul>
</section>
<section id="b14-search-api-openapi-3-1-final">
<h3>B14. Search API — <strong>OpenAPI 3.1</strong> (final)<a class="headerlink" href="#b14-search-api-openapi-3-1-final" title="Link to this heading">#</a></h3>
<ul>
<li><p><strong>Auth</strong>: Bearer API key header <code class="docutils literal notranslate"><span class="pre">Authorization:</span> <span class="pre">Bearer</span> <span class="pre">&lt;token&gt;</span></code> (tokens read from env <code class="docutils literal notranslate"><span class="pre">SEARCH_API_KEYS</span></code>, comma‑separated).</p></li>
<li><p><strong>Rate limits</strong>: token‑bucket: 120 req/min per key; 1,000 req/day per key (in‑memory counters, process‑local).</p></li>
<li><p><strong>Endpoints</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/search</span></code></p>
<ul>
<li><p>Body:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;k&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;filters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;year_from&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2018</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;year_to&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2025</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;openalex&quot;</span><span class="p">,</span><span class="s2">&quot;arxiv&quot;</span><span class="p">],</span><span class="w"> </span><span class="nt">&quot;license&quot;</span><span class="p">:[</span><span class="s2">&quot;CC-BY&quot;</span><span class="p">,</span><span class="s2">&quot;CC0&quot;</span><span class="p">]},</span>
<span class="w">  </span><span class="nt">&quot;explain&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>200 Response (per result):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;doc_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;urn:doc:...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;chunk_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;urn:chunk:...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;section&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Methods&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;score&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2.381</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;signals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;dense&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.73</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;sparse&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.61</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;rrf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.025</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;kg_boost&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.08</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;spans&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;start_char&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;end_char&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">420</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;concepts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="s2">&quot;urn:concept:mesh:D012345&quot;</span><span class="p">,</span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="s2">&quot;direct&quot;</span><span class="p">}]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Errors: <code class="docutils literal notranslate"><span class="pre">400</span></code> (bad input), <code class="docutils literal notranslate"><span class="pre">401</span></code> (auth), <code class="docutils literal notranslate"><span class="pre">429</span></code> (rate limit), <code class="docutils literal notranslate"><span class="pre">500</span></code> (server).</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/graph/concepts</span></code></p>
<ul class="simple">
<li><p>Body: <code class="docutils literal notranslate"><span class="pre">{&quot;q&quot;:&quot;string&quot;,&quot;limit&quot;:50}</span></code> → returns matching concept IDs + labels + paths to root.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/healthz</span></code> → <code class="docutils literal notranslate"><span class="pre">{status:&quot;ok&quot;,</span> <span class="pre">components:{faiss:&quot;ok&quot;,</span> <span class="pre">bm25:&quot;ok&quot;,</span> <span class="pre">vllm_embeddings:&quot;ok&quot;,</span> <span class="pre">neo4j:&quot;ok&quot;}}</span></code>.</p></li>
</ul>
</li>
</ul>
</section>
<section id="b15-endtoend-stage-testing">
<h3>B15. End‑to‑end &amp; stage testing<a class="headerlink" href="#b15-endtoend-stage-testing" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Seed fixtures</strong>:</p>
<ul>
<li><p>10 OA PDFs (mix arXiv/PMC/journal) on disk for offline tests.</p></li>
<li><p>Tiny ontology (50 concepts, 2 levels) + MeSH subset (for integration).</p></li>
<li><p>Golden outputs: a) DocTags JSON; b) chunk Parquet; c) sample dense/sparse Parquets; d) FAISS index shards; e) SPLADE/BM25 Lucene dirs.</p></li>
</ul>
</li>
<li><p><strong>E2E test</strong> (<code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">-m</span> <span class="pre">e2e</span></code>):</p>
<ol class="arabic simple">
<li><p>Harvest &amp; download (mock pyalex/unpaywall): expect N PDFs.</p></li>
<li><p>DocTags conversion: expect pages&gt;0, DocTags file exists, avg_logprob recorded.</p></li>
<li><p>Chunking: expect chunks&gt;0; token counts within bounds; offsets monotonic.</p></li>
<li><p>Dense embed: expect vectors dim=2560; Parquet rows==chunks.</p></li>
<li><p>SPLADE encode &amp; BM25 index: Lucene dirs exist; postings &gt;0.</p></li>
<li><p>FAISS build: index files exist; search for “topic” returns &gt;0 results.</p></li>
<li><p>Ontology ingest + concept embeddings: counts &gt;0; CURIEs valid.</p></li>
<li><p>Linker: assertions produced; at least X% linked.</p></li>
<li><p>KG upsert: node/edge counts as expected.</p></li>
<li><p>Search API: <code class="docutils literal notranslate"><span class="pre">/search</span></code> returns 200 and k results; latency p95 &lt; 300 ms on fixtures.</p></li>
</ol>
</li>
<li><p><strong>Stage unit tests</strong>: contract tests per ABC; property‑based tests (idempotency; stable IDs); golden tests for DocTags/chunks; benchmarking tests for encoder throughput.</p></li>
</ul>
</section>
<section id="b16-observability-diagnostics">
<h3>B16. Observability &amp; diagnostics<a class="headerlink" href="#b16-observability-diagnostics" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Logs</strong>: JSON lines with fields: <code class="docutils literal notranslate"><span class="pre">ts,</span> <span class="pre">level,</span> <span class="pre">module,</span> <span class="pre">event,</span> <span class="pre">run_id,</span> <span class="pre">doc_id,</span> <span class="pre">chunk_id,</span> <span class="pre">duration_ms,</span> <span class="pre">err_code,</span> <span class="pre">message</span></code>.</p></li>
<li><p><strong>Metrics</strong> (Prometheus):</p>
<ul>
<li><p>Counters: <code class="docutils literal notranslate"><span class="pre">pdf_download_success_total</span></code>, <code class="docutils literal notranslate"><span class="pre">pdf_download_failure_total{reason}</span></code>, <code class="docutils literal notranslate"><span class="pre">chunks_total</span></code>, <code class="docutils literal notranslate"><span class="pre">dense_vectors_total</span></code>, <code class="docutils literal notranslate"><span class="pre">splade_vectors_total</span></code>, <code class="docutils literal notranslate"><span class="pre">faiss_queries_total</span></code>, <code class="docutils literal notranslate"><span class="pre">bm25_queries_total</span></code>, <code class="docutils literal notranslate"><span class="pre">splade_queries_total</span></code>.</p></li>
<li><p>Histograms: <code class="docutils literal notranslate"><span class="pre">download_latency_ms</span></code>, <code class="docutils literal notranslate"><span class="pre">doctags_latency_ms</span></code>, <code class="docutils literal notranslate"><span class="pre">chunking_latency_ms</span></code>, <code class="docutils literal notranslate"><span class="pre">embed_dense_latency_ms</span></code>, <code class="docutils literal notranslate"><span class="pre">splade_encode_latency_ms</span></code>, <code class="docutils literal notranslate"><span class="pre">faiss_search_latency_ms</span></code>, <code class="docutils literal notranslate"><span class="pre">search_total_latency_ms</span></code>.</p></li>
<li><p>Gauges: <code class="docutils literal notranslate"><span class="pre">faiss_index_size_vectors</span></code>, <code class="docutils literal notranslate"><span class="pre">lucene_docs_count</span></code>, <code class="docutils literal notranslate"><span class="pre">duckdb_open_files</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Tracing</strong> (OpenTelemetry):</p>
<ul>
<li><p>Spans: <code class="docutils literal notranslate"><span class="pre">harvest.search</span></code>, <code class="docutils literal notranslate"><span class="pre">download.pdf</span></code>, <code class="docutils literal notranslate"><span class="pre">docling.to_doctags</span></code>, <code class="docutils literal notranslate"><span class="pre">chunking.hybrid</span></code>, <code class="docutils literal notranslate"><span class="pre">embed.qwen3</span></code>, <code class="docutils literal notranslate"><span class="pre">encode.splade</span></code>, <code class="docutils literal notranslate"><span class="pre">index.faiss.add</span></code>, <code class="docutils literal notranslate"><span class="pre">index.lucene.build</span></code>, <code class="docutils literal notranslate"><span class="pre">linker.run</span></code>, <code class="docutils literal notranslate"><span class="pre">kg.upsert</span></code>, <code class="docutils literal notranslate"><span class="pre">api.search</span></code>.</p></li>
<li><p>Attributes: <code class="docutils literal notranslate"><span class="pre">{run_id,</span> <span class="pre">doc_id,</span> <span class="pre">shard_id,</span> <span class="pre">model,</span> <span class="pre">dim,</span> <span class="pre">nprobe,</span> <span class="pre">nnz}</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Dashboards</strong>: provide JSON exports for:</p>
<ul>
<li><p><strong>Ingest Health</strong> (download rates/errors).</p></li>
<li><p><strong>Pipeline Throughput</strong> (chunks/min, embeddings/min).</p></li>
<li><p><strong>Search SLOs</strong> (p50/p95/p99 latency, error rate).</p></li>
<li><p><strong>Index Footprint</strong> (FAISS vectors, Lucene docs).</p></li>
</ul>
</li>
</ul>
</section>
<section id="b17-failure-handling-resilience">
<h3>B17. Failure handling &amp; resilience<a class="headerlink" href="#b17-failure-handling-resilience" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Error taxonomy</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">DownloadError</span></code>, <code class="docutils literal notranslate"><span class="pre">UnsupportedMIMEError</span></code>, <code class="docutils literal notranslate"><span class="pre">DoclingError</span></code>, <code class="docutils literal notranslate"><span class="pre">OCRTimeout</span></code>, <code class="docutils literal notranslate"><span class="pre">ChunkingError</span></code>, <code class="docutils literal notranslate"><span class="pre">EmbeddingError</span></code>, <code class="docutils literal notranslate"><span class="pre">SpladeOOM</span></code>, <code class="docutils literal notranslate"><span class="pre">FaissOOM</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexBuildError</span></code>, <code class="docutils literal notranslate"><span class="pre">OntologyParseError</span></code>, <code class="docutils literal notranslate"><span class="pre">LinkerCalibrationError</span></code>, <code class="docutils literal notranslate"><span class="pre">Neo4jError</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Retry/backoff</strong> table:</p>
<ul>
<li><p>External HTTP (download, vLLM): retries=3, backoff 1/2/4 s.</p></li>
<li><p>GPU OOM: reduce batch by 50%, retry up to 2 times; if still fails → quarantine.</p></li>
<li><p>FAISS add error: split shard; retry once per split.</p></li>
</ul>
</li>
<li><p><strong>Quarantine</strong>:</p>
<ul>
<li><p>PDFs: <code class="docutils literal notranslate"><span class="pre">/data/quarantine/pdfs/…</span></code></p></li>
<li><p>Parquet batches: <code class="docutils literal notranslate"><span class="pre">/data/quarantine/parquet/…</span></code></p></li>
<li><p>Incidents table: <code class="docutils literal notranslate"><span class="pre">registry.incidents(event,</span> <span class="pre">subject_id,</span> <span class="pre">error_class,</span> <span class="pre">message,</span> <span class="pre">created_at)</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Poison pill</strong>: if a <code class="docutils literal notranslate"><span class="pre">doc_id</span></code> fails at stage X twice, mark <code class="docutils literal notranslate"><span class="pre">documents.status='poison'</span></code> and exclude from subsequent runs until manual override.</p></li>
</ul>
</section>
<section id="b18-security-licensing-config-secrets">
<h3>B18. Security, licensing, config secrets<a class="headerlink" href="#b18-security-licensing-config-secrets" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Local‑only</strong> network binding for vLLM and Neo4j.</p></li>
<li><p><strong>API keys</strong> for Search API read from env <code class="docutils literal notranslate"><span class="pre">SEARCH_API_KEYS</span></code> (comma‑separated).</p></li>
<li><p><strong>Licenses</strong> stored verbatim from source; <code class="docutils literal notranslate"><span class="pre">documents.license</span></code> required for downstream processing; refuse embedding/indexing if missing or not OA.</p></li>
<li><p><strong>.env</strong> template for secrets and contact email; never commit real secrets.</p></li>
</ul>
</section>
<section id="b19-code-quality-governance">
<h3>B19. Code quality &amp; governance<a class="headerlink" href="#b19-code-quality-governance" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Pre‑commit</strong>: <code class="docutils literal notranslate"><span class="pre">ruff</span></code>, <code class="docutils literal notranslate"><span class="pre">black</span></code>, <code class="docutils literal notranslate"><span class="pre">mypy</span> <span class="pre">--strict</span></code>, <code class="docutils literal notranslate"><span class="pre">pyupgrade</span></code>, <code class="docutils literal notranslate"><span class="pre">interrogate</span></code> (docstring coverage).</p></li>
<li><p><strong>Type discipline</strong>: <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">__future__</span> <span class="pre">import</span> <span class="pre">annotations</span></code>, Protocol/ABC for interfaces, <code class="docutils literal notranslate"><span class="pre">Final</span></code> constants.</p></li>
<li><p><strong>Docs</strong>: <code class="docutils literal notranslate"><span class="pre">mkdocs</span></code> site with API docs (pdoc or mkdocstrings), how‑to guides, and ADRs (<code class="docutils literal notranslate"><span class="pre">/docs/adr/0001-...md</span></code>).</p></li>
<li><p><strong>Conventional commits</strong> and <strong>semantic versioning</strong> per package.</p></li>
<li><p><strong>Codeowners</strong> by directory.</p></li>
</ul>
</section>
<section id="b20-bootstrap-devex">
<h3>B20. Bootstrap &amp; DevEx<a class="headerlink" href="#b20-bootstrap-devex" title="Link to this heading">#</a></h3>
<ul>
<li><p><strong>Makefile</strong> targets:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">bootstrap</span></code> → create venv, install deps, install CUDA‑13 Torch wheels, build/install FAISS GPU/cuVS (or fetch wheel), install vLLM prerelease, create dirs under <code class="docutils literal notranslate"><span class="pre">/data/*</span></code>, apply migrations, install systemd units for vLLM and Nginx.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">run</span></code> → start router, start API, ensure vLLM services up.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">e2e</span></code> → run the full fixture pipeline &amp; API checks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> → remove indexes and temp outputs.</p></li>
</ul>
</li>
<li><p><strong>Systemd</strong> units: <code class="docutils literal notranslate"><span class="pre">vllm-vlm.service</span></code>, <code class="docutils literal notranslate"><span class="pre">vllm-embed.service</span></code>, <code class="docutils literal notranslate"><span class="pre">nginx.service</span></code>, <code class="docutils literal notranslate"><span class="pre">search-api.service</span></code>.</p></li>
<li><p><strong>Directory layout</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">pdfs</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">doctags</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">parquet</span><span class="o">/</span><span class="p">{</span><span class="n">chunks</span><span class="p">,</span><span class="n">dense</span><span class="p">,</span><span class="n">sparse</span><span class="p">,</span><span class="n">concepts</span><span class="p">}</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">lucene</span><span class="o">/</span><span class="p">{</span><span class="n">bm25</span><span class="p">,</span><span class="n">splade</span><span class="p">}</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">faiss</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">catalog</span><span class="o">/</span><span class="n">catalog</span><span class="o">.</span><span class="n">duckdb</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">quarantine</span><span class="o">/</span><span class="p">{</span><span class="n">pdfs</span><span class="p">,</span><span class="n">parquet</span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="b21-slas-slos-performance-budgets">
<h3>B21. SLAs/SLOs &amp; performance budgets<a class="headerlink" href="#b21-slas-slos-performance-budgets" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Downloader</strong>: ≥ 95% of accessible OA PDFs succeed within 60 s; retries included.</p></li>
<li><p><strong>DocTags</strong>: p95 ≤ 6 s/10 pages (Granite‑Docling, RTX 5090).</p></li>
<li><p><strong>Chunking</strong>: ≥ 5,000 chunks/min CPU.</p></li>
<li><p><strong>Dense embedding</strong>: ≥ 8,000 chunks/min (2560‑d) on RTX 5090 under 80% VRAM.</p></li>
<li><p><strong>SPLADE encoding</strong>: ≥ 5,000 chunks/min (AMP).</p></li>
<li><p><strong>FAISS search</strong>: p95 ≤ 40 ms for 200‑NN; build time ≤ 2 h per 10M vectors shard.</p></li>
<li><p><strong>Search API</strong>: p95 end‑to‑end ≤ 300 ms for <code class="docutils literal notranslate"><span class="pre">k=10</span></code>, concurrency 64.</p></li>
<li><p><strong>Linker run</strong>: ≥ 1M chunk‑concept candidate scorings/hour; ECE ≤ 0.08; F1 ≥ 0.70 on dev set.</p></li>
<li><p><strong>CI gates</strong>: fail if nDCG&#64;10 drops &gt; 0.02 from last green or p95 latency ↑ &gt; 20%.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="part-c-interfaces-module-contracts-ready-for-coding">
<h2>PART C — INTERFACES &amp; MODULE CONTRACTS (READY FOR CODING)<a class="headerlink" href="#part-c-interfaces-module-contracts-ready-for-coding" title="Link to this heading">#</a></h2>
<p>Below are <strong>Python interface signatures</strong> (type‑checked; exceptions documented). All implementations must adhere to these contracts.</p>
<section id="c1-registry-duckdb-registry-api-py">
<h3>C1. Registry (DuckDB) — <code class="docutils literal notranslate"><span class="pre">registry/api.py</span></code><a class="headerlink" href="#c1-registry-duckdb-registry-api-py" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Registry</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">begin_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commit_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parquet_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rollback_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">insert_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">purpose</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Doc</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_doctags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assets</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DoctagsAsset</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chunk_rows</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_dense_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">parquet_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_sparse_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">parquet_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_faiss_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_index_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">index_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idmap_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">emit_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">incident</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_class</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="c2-downloader-download-harvester-py">
<h3>C2. Downloader — <code class="docutils literal notranslate"><span class="pre">download/harvester.py</span></code><a class="headerlink" href="#c2-downloader-download-harvester-py" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Harvester</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_works</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>  <span class="c1"># returns final path</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_works</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Doc</span><span class="p">]:</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Exceptions</strong>: <code class="docutils literal notranslate"><span class="pre">DownloadError</span></code>, <code class="docutils literal notranslate"><span class="pre">UnsupportedMIMEError</span></code>.</p>
</section>
<section id="c3-doctags-chunking-docling-vlm-py-docling-hybrid-py">
<h3>C3. DocTags &amp; chunking — <code class="docutils literal notranslate"><span class="pre">docling/vlm.py</span></code>, <code class="docutils literal notranslate"><span class="pre">docling/hybrid.py</span></code><a class="headerlink" href="#c3-doctags-chunking-docling-vlm-py-docling-hybrid-py" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DocTagsConverter</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_doctags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdf_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">doctags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Chunker</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doctags_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chunk</span><span class="p">]:</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Exceptions</strong>: <code class="docutils literal notranslate"><span class="pre">DoclingError</span></code>, <code class="docutils literal notranslate"><span class="pre">OCRTimeout</span></code>, <code class="docutils literal notranslate"><span class="pre">ChunkingError</span></code>.</p>
</section>
<section id="c4-embeddings-embeddings-dense-qwen3-py-embeddings-sparse-splade-py-embeddings-sparse-bm25-py">
<h3>C4. Embeddings — <code class="docutils literal notranslate"><span class="pre">embeddings_dense/qwen3.py</span></code>, <code class="docutils literal notranslate"><span class="pre">embeddings_sparse/splade.py</span></code>, <code class="docutils literal notranslate"><span class="pre">embeddings_sparse/bm25.py</span></code><a class="headerlink" href="#c4-embeddings-embeddings-dense-qwen3-py-embeddings-sparse-splade-py-embeddings-sparse-bm25-py" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DenseEmbedder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">embed_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">:</span> <span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SparseEncoder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span> <span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SparseIndex</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs_iterable</span><span class="p">:</span> <span class="s2">&quot;Iterable[tuple[str, dict]]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Exceptions</strong>: <code class="docutils literal notranslate"><span class="pre">EmbeddingError</span></code>, <code class="docutils literal notranslate"><span class="pre">SpladeOOM</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexBuildError</span></code>.</p>
</section>
<section id="c5-vector-store-vectorstore-faiss-gpu-py">
<h3>C5. Vector store — <code class="docutils literal notranslate"><span class="pre">vectorstore_faiss/gpu.py</span></code><a class="headerlink" href="#c5-vector-store-vectorstore-faiss-gpu-py" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">VectorStore</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_vectors</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">factory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">vectors</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idmap_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idmap_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Exceptions</strong>: <code class="docutils literal notranslate"><span class="pre">FaissOOM</span></code>, <code class="docutils literal notranslate"><span class="pre">IndexBuildError</span></code>.</p>
</section>
<section id="c6-ontology-catalog-ontology-loader-py">
<h3>C6. Ontology &amp; catalog — <code class="docutils literal notranslate"><span class="pre">ontology/loader.py</span></code><a class="headerlink" href="#c6-ontology-catalog-ontology-loader-py" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">OntologyCatalog</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Concept</span><span class="p">]:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Concept</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="c7-linker-linking-linker-py">
<h3>C7. Linker — <code class="docutils literal notranslate"><span class="pre">linking/linker.py</span></code><a class="headerlink" href="#c7-linker-linking-linker-py" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Linker</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">candidate_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">k_sparse</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">k_lex</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_vec</span><span class="p">:</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">,</span> <span class="n">concept_vecs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;np.ndarray&quot;</span><span class="p">],</span> <span class="n">features</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devset</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">link_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="n">Chunk</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">LinkAssertion</span><span class="p">]:</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="c8-kg-builder-kg-builder-neo4j-py">
<h3>C8. KG builder — <code class="docutils literal notranslate"><span class="pre">kg_builder/neo4j.py</span></code><a class="headerlink" href="#c8-kg-builder-kg-builder-neo4j-py" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GraphStore</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Doc</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chunk</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concepts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Concept</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_mentions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LinkAssertion</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">linked_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="c9-search-api-search-api-app-py">
<h3>C9. Search API — <code class="docutils literal notranslate"><span class="pre">search_api/app.py</span></code><a class="headerlink" href="#c9-search-api-search-api-app-py" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Bootstraps FAISS handle(s), BM25, SPLADE, OntologyCatalog, GraphStore, DenseEmbedder; exposes FastAPI app with routers:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">/search</span></code>, <code class="docutils literal notranslate"><span class="pre">/graph/concepts</span></code>, <code class="docutils literal notranslate"><span class="pre">/healthz</span></code>.</p></li>
</ul>
</li>
<li><p>All responses validated with <code class="docutils literal notranslate"><span class="pre">pydantic</span></code> models.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="part-d-orchestration-prefect-2-x">
<h2>PART D — ORCHESTRATION (PREFECT 2.x)<a class="headerlink" href="#part-d-orchestration-prefect-2-x" title="Link to this heading">#</a></h2>
<section id="d1-flow-graph-idempotency-keys">
<h3>D1. Flow graph &amp; idempotency keys<a class="headerlink" href="#d1-flow-graph-idempotency-keys" title="Link to this heading">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>harvest_and_download → convert_to_doctags → chunk_with_docling → \
embed_dense_qwen3 ┐                                        \
encode_splade_v3  ├── build_bm25_index ┐                    \
                   └── build_faiss_index  → ingest_ontologies → embed_concepts \
                                                   → link_chunks_to_concepts → kg_upsert
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Idempotency keys</strong>:</p>
<ul>
<li><p>Harvest: <code class="docutils literal notranslate"><span class="pre">(topic,</span> <span class="pre">years,</span> <span class="pre">work_id)</span></code></p></li>
<li><p>DocTags: <code class="docutils literal notranslate"><span class="pre">pdf_sha256</span></code></p></li>
<li><p>Chunking: <code class="docutils literal notranslate"><span class="pre">(doc_id,</span> <span class="pre">chunker_version)</span></code></p></li>
<li><p>Dense: <code class="docutils literal notranslate"><span class="pre">(chunk_dataset_id,</span> <span class="pre">model=Qwen3,</span> <span class="pre">dim=2560)</span></code></p></li>
<li><p>SPLADE: <code class="docutils literal notranslate"><span class="pre">(chunk_dataset_id,</span> <span class="pre">model=SPLADE-v3,</span> <span class="pre">topk=256)</span></code></p></li>
<li><p>FAISS: <code class="docutils literal notranslate"><span class="pre">(dense_run_id,</span> <span class="pre">factory,</span> <span class="pre">nlist,</span> <span class="pre">m,</span> <span class="pre">nprobe)</span></code></p></li>
<li><p>Ontology: <code class="docutils literal notranslate"><span class="pre">(ontology_id,</span> <span class="pre">src_uri,</span> <span class="pre">loader_version)</span></code></p></li>
<li><p>Linker: <code class="docutils literal notranslate"><span class="pre">(chunk_dataset_id,</span> <span class="pre">ontology_id,</span> <span class="pre">linker_version)</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="d2-concurrency-retries">
<h3>D2. Concurrency &amp; retries<a class="headerlink" href="#d2-concurrency-retries" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Download: 8 workers, retry matrix as in §B17.</p></li>
<li><p>VLM/embeddings/SPLADE: GPU queue depth=2; batch auto‑tune; 3 retries on transient errors.</p></li>
<li><p>Index builds: FAISS shards in parallel up to 2; Lucene index single‑writer with merges at end.</p></li>
</ul>
</section>
<section id="d3-cli-commands-invoke-via-typer">
<h3>D3. CLI commands (invoke via Typer)<a class="headerlink" href="#d3-cli-commands-invoke-via-typer" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">harvest</span> <span class="pre">--topic</span> <span class="pre">&quot;LLM</span> <span class="pre">alignment&quot;</span> <span class="pre">--years</span> <span class="pre">2018..2025</span> <span class="pre">--max</span> <span class="pre">20000</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">doctags</span> <span class="pre">--input</span> <span class="pre">/data/pdfs</span> <span class="pre">--out</span> <span class="pre">/data/doctags</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">chunk</span> <span class="pre">--doctags</span> <span class="pre">/data/doctags</span> <span class="pre">--out</span> <span class="pre">/data/parquet/chunks</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">embed-dense</span> <span class="pre">--chunks</span> <span class="pre">&lt;dataset_id&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">encode-splade</span> <span class="pre">--chunks</span> <span class="pre">&lt;dataset_id&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">index-bm25</span> <span class="pre">--chunks</span> <span class="pre">&lt;dataset_id&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">index-faiss</span> <span class="pre">--dense-run</span> <span class="pre">&lt;run_id&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">ingest-ontology</span> <span class="pre">--id</span> <span class="pre">mesh</span> <span class="pre">--uri</span> <span class="pre">/data/ontologies/mesh.obo</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">embed-concepts</span> <span class="pre">--ontology</span> <span class="pre">mesh</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">link</span> <span class="pre">--chunks</span> <span class="pre">&lt;dataset_id&gt;</span> <span class="pre">--ontology</span> <span class="pre">mesh</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">kg-upsert</span> <span class="pre">--link-run</span> <span class="pre">&lt;run_id&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kgf</span> <span class="pre">api</span> <span class="pre">--port</span> <span class="pre">8080</span></code></p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="part-e-endtoend-acceptance-criteria-per-workstream">
<h2>PART E — END‑TO‑END ACCEPTANCE CRITERIA (PER WORKSTREAM)<a class="headerlink" href="#part-e-endtoend-acceptance-criteria-per-workstream" title="Link to this heading">#</a></h2>
<p><strong>Downloader</strong></p>
<ul class="simple">
<li><p>Given topic and year range, at least N documents discovered; ≥95% OA downloads succeed; duplicates deduped; license persisted.</p></li>
</ul>
<p><strong>DocTags</strong></p>
<ul class="simple">
<li><p>For each PDF, DocTags exists; pages count &gt; 0; avg_logprob recorded; OCR fallback pages tracked.</p></li>
</ul>
<p><strong>Chunking</strong></p>
<ul class="simple">
<li><p>For each <code class="docutils literal notranslate"><span class="pre">doc_id</span></code>, sum of chunk spans covers ≥90% of canonical text; token counts in [min,max]; offsets monotonic.</p></li>
</ul>
<p><strong>Dense embeddings</strong></p>
<ul class="simple">
<li><p>Row count == chunk rows; all vectors dim=2560; Parquet schema validated; L2 norms avg in [0.95,1.05] post‑norm.</p></li>
</ul>
<p><strong>SPLADE/BM25</strong></p>
<ul class="simple">
<li><p>SPLADE nnz distribution mean ≈ 220–260; Lucene impact index has postings; BM25 index doc count == chunk count.</p></li>
</ul>
<p><strong>FAISS</strong></p>
<ul class="simple">
<li><p>Trained index exists; top‑K search returns results; p95 latency ≤ 40 ms for K=200 on fixture set.</p></li>
</ul>
<p><strong>Ontology &amp; concepts</strong></p>
<ul class="simple">
<li><p>Loaded concepts &gt; 0; no duplicate CURIEs; concept embeddings Parquet rows == concepts; ontology edges inserted.</p></li>
</ul>
<p><strong>Linker</strong></p>
<ul class="simple">
<li><p>Produces assertions; on fixtures F1 ≥ 0.70; ECE ≤ 0.08; calibration saved and applied.</p></li>
</ul>
<p><strong>KG</strong></p>
<ul class="simple">
<li><p>Node uniqueness constraints enforced; edge counts match assertions; query <code class="docutils literal notranslate"><span class="pre">linked_concepts(chunk)</span></code> returns expected IDs.</p></li>
</ul>
<p><strong>Search API</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/healthz</span></code> OK; <code class="docutils literal notranslate"><span class="pre">/search</span></code> returns k results with explanations; p95 ≤ 300 ms on fixtures.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="part-f-sample-openapi-excerpt">
<h2>PART F — SAMPLE OPENAPI (EXCERPT)<a class="headerlink" href="#part-f-sample-openapi-excerpt" title="Link to this heading">#</a></h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">openapi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.1.0</span>
<span class="nt">info</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="nv">KGForge Search API</span><span class="p p-Indicator">,</span><span class="nt"> version</span><span class="p">:</span><span class="w"> </span><span class="nv">1.0.0</span><span class="p p-Indicator">}</span>
<span class="nt">paths</span><span class="p">:</span>
<span class="w">  </span><span class="nt">/search</span><span class="p">:</span>
<span class="w">    </span><span class="nt">post</span><span class="p">:</span>
<span class="w">      </span><span class="nt">security</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[{</span><span class="nt">ApiKeyAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]}]</span>
<span class="w">      </span><span class="nt">requestBody</span><span class="p">:</span>
<span class="w">        </span><span class="nt">content</span><span class="p">:</span>
<span class="w">          </span><span class="nt">application/json</span><span class="p">:</span>
<span class="w">            </span><span class="nt">schema</span><span class="p">:</span>
<span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">              </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">query</span><span class="p p-Indicator">]</span>
<span class="w">              </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">                </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">,</span><span class="nt"> minLength</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">}</span>
<span class="w">                </span><span class="nt">k</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">integer</span><span class="p p-Indicator">,</span><span class="nt"> minimum</span><span class="p">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nt"> maximum</span><span class="p">:</span><span class="w"> </span><span class="nv">100</span><span class="p p-Indicator">,</span><span class="nt"> default</span><span class="p">:</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">}</span>
<span class="w">                </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">                  </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">year_from</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">integer</span><span class="p p-Indicator">}</span>
<span class="w">                    </span><span class="nt">year_to</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">integer</span><span class="p p-Indicator">}</span>
<span class="w">                    </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">array</span><span class="p p-Indicator">,</span><span class="nt"> items</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">}}</span>
<span class="w">                    </span><span class="nt">license</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">array</span><span class="p p-Indicator">,</span><span class="nt"> items</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">}}</span>
<span class="w">                </span><span class="nt">explain</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">boolean</span><span class="p p-Indicator">,</span><span class="nt"> default</span><span class="p">:</span><span class="w"> </span><span class="nv">false</span><span class="p p-Indicator">}</span>
<span class="w">      </span><span class="nt">responses</span><span class="p">:</span>
<span class="w">        </span><span class="s">&#39;200&#39;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OK</span>
<span class="w">          </span><span class="nt">content</span><span class="p">:</span>
<span class="w">            </span><span class="nt">application/json</span><span class="p">:</span>
<span class="w">              </span><span class="nt">schema</span><span class="p">:</span>
<span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">                </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">results</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">                    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/components/schemas/Result&#39;</span>
<span class="w">        </span><span class="s">&#39;400&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/components/responses/BadRequest&#39;</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="s">&#39;401&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/components/responses/Unauthorized&#39;</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="s">&#39;429&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/components/responses/TooManyRequests&#39;</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="s">&#39;500&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/components/responses/ServerError&#39;</span><span class="p p-Indicator">}</span>
<span class="nt">components</span><span class="p">:</span>
<span class="w">  </span><span class="nt">securitySchemes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ApiKeyAuth</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">      </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bearer</span>
<span class="w">  </span><span class="nt">schemas</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Result</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">      </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">doc_id</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">chunk_id</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">title</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">section</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">score</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">        </span><span class="nt">doc_id</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">chunk_id</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">section</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">score</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">number</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">signals</span><span class="p">:</span>
<span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">          </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">            </span><span class="nt">dense</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">number</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">sparse</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">number</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">rrf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">number</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">kg_boost</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">number</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">spans</span><span class="p">:</span>
<span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">          </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">            </span><span class="nt">start_char</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">integer</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">end_char</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">integer</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">concepts</span><span class="p">:</span>
<span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">          </span><span class="nt">items</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">            </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">              </span><span class="nt">concept_id</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">}</span>
<span class="w">              </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">}</span>
<span class="w">              </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="nv">string</span><span class="p p-Indicator">,</span><span class="nt"> enum</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">direct</span><span class="p p-Indicator">,</span><span class="nv">nearby</span><span class="p p-Indicator">]}</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="part-g-implementation-checklists-by-workstream">
<h2>PART G — IMPLEMENTATION CHECKLISTS (BY WORKSTREAM)<a class="headerlink" href="#part-g-implementation-checklists-by-workstream" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Download &amp; Harvest</strong></p>
<ul class="simple">
<li><p>[ ] PyAlex client; config; retries; polite UA.</p></li>
<li><p>[ ] Fallback Unpaywall client; DOI resolver.</p></li>
<li><p>[ ] PDF validator; MIME/size checks; hash; dedup; storage path; registry insert.</p></li>
<li><p>[ ] Metrics/logs/tests; CLI command; E2E hooks.</p></li>
</ul>
</li>
<li><p><strong>DocTags Conversion</strong></p>
<ul class="simple">
<li><p>[ ] vLLM client; page batches; OCR fallback; canonicalizer; provenance.</p></li>
<li><p>[ ] Persist <code class="docutils literal notranslate"><span class="pre">.dt.json.zst</span></code>; register DoctagsAsset; golden tests.</p></li>
</ul>
</li>
<li><p><strong>Hybrid Chunker</strong></p>
<ul class="simple">
<li><p>[ ] Qwen tokenizer; section splitting; sliding windows; spans &amp; offsets.</p></li>
<li><p>[ ] Parquet writer; ID scheme; tests for bounds &amp; coverage.</p></li>
</ul>
</li>
<li><p><strong>Dense Embedder (Qwen3 2560)</strong></p>
<ul class="simple">
<li><p>[ ] OpenAI API client; dimension param; batching; normalization; retries.</p></li>
<li><p>[ ] Parquet writer; registry run; throughput metric; tests.</p></li>
</ul>
</li>
<li><p><strong>SPLADE‑v3 &amp; BM25</strong></p>
<ul class="simple">
<li><p>[ ] Torch encoder; AMP; top‑K; Parquet writer; impact index streaming.</p></li>
<li><p>[ ] BM25 analyzer config; indexer; search adapter; tests.</p></li>
</ul>
</li>
<li><p><strong>FAISS GPU/cuVS</strong></p>
<ul class="simple">
<li><p>[ ] Loader; training sampler; add &amp; search; shard manager; save/load.</p></li>
<li><p>[ ] Query adapter (top‑K); memory gauges; tests.</p></li>
</ul>
</li>
<li><p><strong>Ontology &amp; Concepts</strong></p>
<ul class="simple">
<li><p>[ ] Parsers (OBO/OWL/SKOS); normalization; CURIEs; edges.</p></li>
<li><p>[ ] Dense &amp; SPLADE embeddings for concepts; Parquet &amp; registry.</p></li>
</ul>
</li>
<li><p><strong>Linker</strong></p>
<ul class="simple">
<li><p>[ ] Candidate gen (SPLADE+lexicon); feature extractor; fusion; calibration; thresholds.</p></li>
<li><p>[ ] Assertions Parquet; metrics; tests.</p></li>
</ul>
</li>
<li><p><strong>KG Builder (Neo4j)</strong></p>
<ul class="simple">
<li><p>[ ] Node/edge upserts; uniqueness constraints; indexes.</p></li>
<li><p>[ ] Linked concept lookups; tests.</p></li>
</ul>
</li>
<li><p><strong>Search API</strong></p>
<ul class="simple">
<li><p>[ ] Startup wiring; RRF; KG boosts; MMR; filters; auth; rate limits.</p></li>
<li><p>[ ] OpenAPI; integration tests; latency regression tests.</p></li>
</ul>
</li>
<li><p><strong>Registry &amp; Orchestration</strong></p>
<ul class="simple">
<li><p>[ ] Migrations; two‑phase dataset registration; events &amp; incidents.</p></li>
<li><p>[ ] Prefect flows; CLI; idempotency keys; dashboards.</p></li>
</ul>
</li>
<li><p><strong>Ops</strong></p>
<ul class="simple">
<li><p>[ ] systemd units; Nginx config; health checks; log rotation; backup scripts (Parquet+DuckDB).</p></li>
</ul>
</li>
</ol>
</section>
<hr class="docutils" />
<section id="part-h-example-config-final-ready-to-commit">
<h2>PART H — EXAMPLE CONFIG (FINAL; READY TO COMMIT)<a class="headerlink" href="#part-h-example-config-final-ready-to-commit" title="Link to this heading">#</a></h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">system</span><span class="p">:</span>
<span class="w">  </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-24.04</span>
<span class="w">  </span><span class="nt">threads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">14</span>
<span class="w">  </span><span class="nt">seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<span class="w">  </span><span class="nt">parquet_root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/parquet</span>
<span class="w">  </span><span class="nt">artifacts_root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/artifacts</span>
<span class="w">  </span><span class="nt">duckdb_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/catalog/catalog.duckdb</span>

<span class="nt">runtime</span><span class="p">:</span>
<span class="w">  </span><span class="nt">python</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.13&quot;</span>
<span class="w">  </span><span class="nt">cuda</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;13.0&quot;</span>
<span class="w">  </span><span class="nt">torch</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.9&quot;</span>
<span class="w">  </span><span class="nt">duckdb_min</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.4.1&quot;</span>
<span class="w">  </span><span class="nt">vllm_channel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pre-release-cuda13&quot;</span>

<span class="nt">network</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nginx_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="nt">vlm_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8001</span>
<span class="w">  </span><span class="nt">emb_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8002</span>
<span class="w">  </span><span class="nt">api_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>

<span class="nt">harvest</span><span class="p">:</span>
<span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyalex</span>
<span class="w">  </span><span class="nt">per_page</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
<span class="w">  </span><span class="nt">max_works</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20000</span>
<span class="w">  </span><span class="nt">years</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&gt;=2018&quot;</span>
<span class="w">  </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">is_oa</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">has_oa_published_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">fallbacks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">unpaywall</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">arxiv</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">pmc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">concurrency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">  </span><span class="nt">timeout_sec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<span class="w">  </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>

<span class="nt">doc_conversion</span><span class="p">:</span>
<span class="w">  </span><span class="nt">vlm_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ibm-granite/granite-docling-258M</span>
<span class="w">  </span><span class="nt">vlm_revision</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">untied</span>
<span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost/vlm/</span>
<span class="w">  </span><span class="nt">dpi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">220</span>
<span class="w">  </span><span class="nt">page_batch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">  </span><span class="nt">ocr_fallback</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">max_pages</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2000</span>
<span class="w">  </span><span class="nt">timeout_sec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120</span>

<span class="nt">chunking</span><span class="p">:</span>
<span class="w">  </span><span class="nt">engine</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docling_hybrid</span>
<span class="w">  </span><span class="nt">target_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">400</span>
<span class="w">  </span><span class="nt">overlap_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="nt">min_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120</span>
<span class="w">  </span><span class="nt">max_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">480</span>

<span class="nt">dense_embedding</span><span class="p">:</span>
<span class="w">  </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Qwen/Qwen3-Embedding-4B</span>
<span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost/v1/embeddings</span>
<span class="w">  </span><span class="nt">output_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2560</span>
<span class="w">  </span><span class="nt">parquet_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${system.parquet_root}/dense/model=Qwen3-Embedding-4B/run=${run_id}</span>

<span class="nt">sparse_embedding</span><span class="p">:</span>
<span class="w">  </span><span class="nt">splade</span><span class="p">:</span>
<span class="w">    </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">naver/splade-v3-distilbert</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda</span>
<span class="w">    </span><span class="nt">amp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fp16</span>
<span class="w">    </span><span class="nt">max_seq_len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="w">    </span><span class="nt">topk</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span>
<span class="w">    </span><span class="nt">parquet_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${system.parquet_root}/sparse/model=SPLADE-v3-distilbert/run=${run_id}</span>
<span class="w">  </span><span class="nt">bm25</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.9</span>
<span class="w">    </span><span class="nt">b</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4</span>
<span class="w">    </span><span class="nt">field_boosts</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> title</span><span class="p">:</span><span class="w"> </span><span class="nv">2.0</span><span class="p p-Indicator">,</span><span class="nt"> section</span><span class="p">:</span><span class="w"> </span><span class="nv">1.2</span><span class="p p-Indicator">,</span><span class="nt"> body</span><span class="p">:</span><span class="w"> </span><span class="nv">1.0</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">index_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/lucene/bm25</span>

<span class="nt">faiss</span><span class="p">:</span>
<span class="w">  </span><span class="nt">index_factory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OPQ64,IVF8192,PQ64</span>
<span class="w">  </span><span class="nt">nprobe</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">  </span><span class="nt">train_samples</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000000</span>
<span class="w">  </span><span class="nt">shards</span><span class="p">:</span>
<span class="w">    </span><span class="nt">max_vectors_per_shard</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000000</span>
<span class="w">  </span><span class="nt">gpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">cuvs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">output_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/faiss/qwen3_ivfpq</span>

<span class="nt">ontology</span><span class="p">:</span>
<span class="w">  </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> ontology_id</span><span class="p">:</span><span class="w"> </span><span class="nv">mesh</span><span class="p p-Indicator">,</span><span class="nt"> format</span><span class="p">:</span><span class="w"> </span><span class="nv">obo</span><span class="p p-Indicator">,</span><span class="nt"> uri</span><span class="p">:</span><span class="w"> </span><span class="nv">/data/ontologies/mesh.obo</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> ontology_id</span><span class="p">:</span><span class="w"> </span><span class="nv">go</span><span class="p p-Indicator">,</span><span class="nt">   format</span><span class="p">:</span><span class="w"> </span><span class="nv">obo</span><span class="p p-Indicator">,</span><span class="nt"> uri</span><span class="p">:</span><span class="w"> </span><span class="nv">/data/ontologies/go.obo</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">concept_embed</span><span class="p">:</span>
<span class="w">    </span><span class="nt">dense_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Qwen3-Embedding-4B</span>
<span class="w">    </span><span class="nt">dense_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2560</span>
<span class="w">    </span><span class="nt">splade_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SPLADE-v3-distilbert</span>
<span class="w">    </span><span class="nt">splade_topk</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>

<span class="nt">linker</span><span class="p">:</span>
<span class="w">  </span><span class="nt">candidates</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> splade_topk</span><span class="p">:</span><span class="w"> </span><span class="nv">100</span><span class="p p-Indicator">,</span><span class="nt"> lexicon_topk</span><span class="p">:</span><span class="w"> </span><span class="nv">50</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">fusion_weights</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> dense</span><span class="p">:</span><span class="w"> </span><span class="nv">0.55</span><span class="p p-Indicator">,</span><span class="nt"> sparse</span><span class="p">:</span><span class="w"> </span><span class="nv">0.35</span><span class="p p-Indicator">,</span><span class="nt"> lexical</span><span class="p">:</span><span class="w"> </span><span class="nv">0.10</span><span class="p p-Indicator">,</span><span class="nt"> depth_bonus_per_level</span><span class="p">:</span><span class="w"> </span><span class="nv">0.02</span><span class="p p-Indicator">,</span><span class="nt"> depth_cap</span><span class="p">:</span><span class="w"> </span><span class="nv">0.10</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">thresholds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> high</span><span class="p">:</span><span class="w"> </span><span class="nv">0.62</span><span class="p p-Indicator">,</span><span class="nt"> low</span><span class="p">:</span><span class="w"> </span><span class="nv">0.35</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">calibration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">isotonic</span>

<span class="nt">graph</span><span class="p">:</span>
<span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">neo4j</span>
<span class="w">  </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bolt://localhost:7687</span>
<span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">neo4j</span>
<span class="w">  </span><span class="nt">password_env</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NEO4J_PASSWORD</span>

<span class="nt">search</span><span class="p">:</span>
<span class="w">  </span><span class="nt">k</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">  </span><span class="nt">dense_candidates</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
<span class="w">  </span><span class="nt">sparse_candidates</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
<span class="w">  </span><span class="nt">rrf_k</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<span class="w">  </span><span class="nt">mmr_lambda</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.7</span>
<span class="w">  </span><span class="nt">kg_boosts</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> direct</span><span class="p">:</span><span class="w"> </span><span class="nv">0.08</span><span class="p p-Indicator">,</span><span class="nt"> one_hop</span><span class="p">:</span><span class="w"> </span><span class="nv">0.04</span><span class="w"> </span><span class="p p-Indicator">}</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="part-i-what-happens-next">
<h2>PART I — WHAT HAPPENS NEXT<a class="headerlink" href="#part-i-what-happens-next" title="Link to this heading">#</a></h2>
<p>With these <strong>resolved specifications</strong>:</p>
<ul class="simple">
<li><p>Each workstream has <strong>clear interfaces</strong>, <strong>error types</strong>, <strong>Parquet schemas</strong>, <strong>DuckDB DDL</strong>, <strong>router/API contracts</strong>, <strong>orchestration flows</strong>, <strong>observability</strong>, <strong>SLAs</strong>, and <strong>acceptance tests</strong>.</p></li>
<li><p>Teams can now draft <strong>detailed implementation plans</strong> and begin coding, confident that components will integrate cleanly on the single‑box target environment.</p></li>
</ul>
<p>If you want, I can generate <strong>skeleton packages</strong> (directories, ABCs, Pydantic models, Typer CLI, Prefect flows, Makefile, pre‑commit, and sample tests) to serve as the starting point for implementation.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Explanations</p>
      </div>
    </a>
    <a class="right-next"
       href="251025_FAISS_whl_overview.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">1) Revised capability matrix (this wheel)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">0) Big picture (end‑to‑end, single‑box)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#design-principles-concretized">1) Design principles (concretized)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#repository-layout-monorepo-independently-ownable-packages">2) Repository layout (monorepo; independently ownable packages)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#core-data-contracts-pydantic-v2-contentaddressed-ids">3) Core data contracts (Pydantic v2; content‑addressed IDs)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#storage-layers-adapters-ports">4) Storage layers &amp; adapters (ports)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#orchestration-prefect-2-x-all-local">5) Orchestration (Prefect 2.x; all local)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#harvesters-pdf-download-pyalex-first-resilient-fallbacks">6) Harvesters &amp; PDF download (PyAlex first; resilient fallbacks)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pdf-doctags-docling-vlm-granitedocling">7) PDF → <strong>DocTags</strong> (Docling VLM Granite‑Docling)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#chunking-docling-hybridchunker">8) Chunking (Docling <strong>HybridChunker</strong>)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dense-embeddings-qwen3embedding4b-2560dim-vllm">9) Dense embeddings (Qwen3‑Embedding‑4B @ <strong>2560‑dim</strong>, vLLM)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#sparse-embeddings-indices-spladev3-gpu-bm25">10) Sparse embeddings &amp; indices (SPLADE‑v3 <strong>GPU</strong> + BM25)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#faiss-gpu-with-cuvs-cuda-13">11) FAISS (GPU with <strong>cuVS</strong>), CUDA 13</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ontology-ingestion-concept-encoders">12) Ontology ingestion &amp; concept encoders</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#linker-chunkconcept-calibrated">13) Linker (chunk→concept), calibrated</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#knowledge-graph-neo4j-local">14) Knowledge Graph (Neo4j, local)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#hybrid-search-api-fastapi-local">15) Hybrid search API (FastAPI, local)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-yaml-singlebox-defaults">16) Configuration (YAML; single‑box defaults)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#duckdb-1-4-1-schema-views-full-fidelity">17) DuckDB (≥ 1.4.1) schema &amp; views (full fidelity)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#vllm-nginx-single-logical-endpoint">18) vLLM &amp; Nginx (single logical endpoint)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-skeletons-selected">19) Implementation skeletons (selected)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloader-pyalex-fallbacks">19.1 Downloader (PyAlex + fallbacks)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#doctags-conversion">19.2 DocTags conversion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chunking">19.3 Chunking</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dense-embeddings-qwen3-2560d-via-vllm">19.4 Dense embeddings (Qwen3 2560‑d via vLLM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spladev3-encoder-gpu">19.5 SPLADE‑v3 encoder (GPU)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#faiss-index-gpu-cuvs">19.6 FAISS index (GPU + cuVS)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hybrid-retrieval-rerank-search-api">19.7 Hybrid retrieval &amp; rerank (search_api)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-gates-evaluation-ci">20) Quality gates, evaluation &amp; CI</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#security-licensing-governance-local">21) Security, licensing, governance (local)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#capacity-sizing-with-2560dim">22) Capacity &amp; sizing with <strong>2560‑dim</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#operational-runbooks">23) Operational runbooks</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#workstreams-implementation-plans-deliverables">24) Workstreams (implementation plans &amp; deliverables)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-standards-bestinclass-python-practices">25) Coding standards &amp; best‑in‑class Python practices</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#addendum-additional-architecture-information">Addendum - additional architecture information</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-a-gap-analysis-whats-unspecified-resolutions-in-addendum">PART A — GAP ANALYSIS (WHAT’S UNSPECIFIED) → RESOLUTIONS IN ADDENDUM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-b-exhaustive-specifications-resolutions">PART B — EXHAUSTIVE SPECIFICATIONS (RESOLUTIONS)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b1-canonical-text-hashing-ids">B1. Canonical text, hashing &amp; IDs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b2-tokenizer-chunking-quantization">B2. Tokenizer &amp; chunking quantization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b3-doctags-selection-ocr-fallback">B3. DocTags selection &amp; OCR fallback</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b4-harvester-downloader-pyalex-first-with-fallbacks">B4. Harvester &amp; downloader (PyAlex first, with fallbacks)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b5-dense-embeddings-qwen3-2560d">B5. Dense embeddings (Qwen3 2560‑d)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b6-sparse-spladev3-gpu-bm25-details">B6. Sparse (SPLADE‑v3 GPU) &amp; BM25 details</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b7-parquet-datasets-all-embeddings-and-chunks">B7. Parquet datasets (ALL embeddings and chunks)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b8-duckdb-registry-1-4-1-migrations-guards">B8. DuckDB registry (≥ 1.4.1): migrations &amp; guards</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b9-faiss-gpu-cuvs-cuda-13">B9. FAISS GPU + cuVS (CUDA 13)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b10-vllm-servers-router">B10. vLLM servers &amp; router</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b11-ontology-ingestion-catalog">B11. Ontology ingestion &amp; catalog</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b12-linker-calibration-decision-policy">B12. Linker calibration &amp; decision policy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b13-hybrid-retrieval-fusion-fixed-math">B13. Hybrid retrieval fusion (fixed math)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b14-search-api-openapi-3-1-final">B14. Search API — <strong>OpenAPI 3.1</strong> (final)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b15-endtoend-stage-testing">B15. End‑to‑end &amp; stage testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b16-observability-diagnostics">B16. Observability &amp; diagnostics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b17-failure-handling-resilience">B17. Failure handling &amp; resilience</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b18-security-licensing-config-secrets">B18. Security, licensing, config secrets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b19-code-quality-governance">B19. Code quality &amp; governance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b20-bootstrap-devex">B20. Bootstrap &amp; DevEx</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b21-slas-slos-performance-budgets">B21. SLAs/SLOs &amp; performance budgets</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-c-interfaces-module-contracts-ready-for-coding">PART C — INTERFACES &amp; MODULE CONTRACTS (READY FOR CODING)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c1-registry-duckdb-registry-api-py">C1. Registry (DuckDB) — <code class="docutils literal notranslate"><span class="pre">registry/api.py</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c2-downloader-download-harvester-py">C2. Downloader — <code class="docutils literal notranslate"><span class="pre">download/harvester.py</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c3-doctags-chunking-docling-vlm-py-docling-hybrid-py">C3. DocTags &amp; chunking — <code class="docutils literal notranslate"><span class="pre">docling/vlm.py</span></code>, <code class="docutils literal notranslate"><span class="pre">docling/hybrid.py</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c4-embeddings-embeddings-dense-qwen3-py-embeddings-sparse-splade-py-embeddings-sparse-bm25-py">C4. Embeddings — <code class="docutils literal notranslate"><span class="pre">embeddings_dense/qwen3.py</span></code>, <code class="docutils literal notranslate"><span class="pre">embeddings_sparse/splade.py</span></code>, <code class="docutils literal notranslate"><span class="pre">embeddings_sparse/bm25.py</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c5-vector-store-vectorstore-faiss-gpu-py">C5. Vector store — <code class="docutils literal notranslate"><span class="pre">vectorstore_faiss/gpu.py</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c6-ontology-catalog-ontology-loader-py">C6. Ontology &amp; catalog — <code class="docutils literal notranslate"><span class="pre">ontology/loader.py</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c7-linker-linking-linker-py">C7. Linker — <code class="docutils literal notranslate"><span class="pre">linking/linker.py</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c8-kg-builder-kg-builder-neo4j-py">C8. KG builder — <code class="docutils literal notranslate"><span class="pre">kg_builder/neo4j.py</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c9-search-api-search-api-app-py">C9. Search API — <code class="docutils literal notranslate"><span class="pre">search_api/app.py</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-d-orchestration-prefect-2-x">PART D — ORCHESTRATION (PREFECT 2.x)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d1-flow-graph-idempotency-keys">D1. Flow graph &amp; idempotency keys</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d2-concurrency-retries">D2. Concurrency &amp; retries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d3-cli-commands-invoke-via-typer">D3. CLI commands (invoke via Typer)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-e-endtoend-acceptance-criteria-per-workstream">PART E — END‑TO‑END ACCEPTANCE CRITERIA (PER WORKSTREAM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-f-sample-openapi-excerpt">PART F — SAMPLE OPENAPI (EXCERPT)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-g-implementation-checklists-by-workstream">PART G — IMPLEMENTATION CHECKLISTS (BY WORKSTREAM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-h-example-config-final-ready-to-commit">PART H — EXAMPLE CONFIG (FINAL; READY TO COMMIT)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-i-what-happens-next">PART I — WHAT HAPPENS NEXT</a></li>
</ul>
</li>
</ul>

  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/explanations/251025_HighLevelArchitecture.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>