# Agent Catalog & Portal Guide

The Agent Catalog bundles every documentation artifact generated by the build. This
guide explains how to consume the JSON schema, the typed clients, the CLIs, and the
optional hosted mode RBAC controls.

## Catalog Schema Overview

The catalog is published to `docs/_build/agent_catalog.json` and validated against
`docs/_build/schema_agent_catalog.json` (JSON Schema 2020-12). The top-level payload
contains:

- `version`: semantic version for the payload format.
- `generated_at`: RFC 3339 timestamp in UTC.
- `repo`: repository metadata (`root`, `sha`).
- `link_policy`: resolved editor/GitHub templates. When `mode="github"` the
  `{org}`, `{repo}`, and `{sha}` placeholders MUST be provided via environment
  variables or CLI overrides.
- `artifacts`: relative paths to supporting documents (DocFacts, NavMap, schemas,
  semantic index, observability snapshots, etc.).
- `packages[*].modules[*]`: module entries with source metadata, graph edges,
  quality signals, agent hints, change-impact summaries, and symbol anchors. Any
  ordered data (such as `anchors.remap_order`, exemplar lists, or change windows)
  is expressed as an array.
- `semantic_index`: FAISS metadata (`index`, `mapping`, `model`, `dimension`).
- `shards`: optional package shards with relative paths. Clients transparently
  resolve shards when `load_shards=True`.

### Schema Validation

Validate a catalog payload with:

```bash
uv run python -m jsonschema --instance docs/_build/agent_catalog.json \
  --schema docs/_build/schema_agent_catalog.json
```

### Problem Details Example

Errors surfaced by hosted APIs follow RFC 9457 Problem Details:

```json
{
  "type": "https://kgfoundry/errors/catalog/not-found",
  "title": "Symbol not found",
  "status": 404,
  "detail": "Symbol demo.module.missing could not be located",
  "instance": "urn:catalogctl:symbol/abcd"
}
```

## CLI Usage (`catalogctl`)

Install via the packaged console script:

```bash
uv run catalogctl --help
```

Key commands:

- `catalogctl capabilities` — list packages.
- `catalogctl list-modules <package>` — enumerate modules for a package.
- `catalogctl symbol <symbol_id>` — show metadata for a symbol.
- `catalogctl find-callers|find-callees <symbol_id>` — reveal graph edges.
- `catalogctl change-impact <symbol_id>` — render change-impact metadata.
- `catalogctl suggest-tests <symbol_id>` — show recommended tests.
- `catalogctl open-anchor <symbol_id>` — emit editor/GitHub URLs.
- `catalogctl search "query" [--facet key=value] [--k 10]` — hybrid search
  across lexical and embedding indices.

All commands exit with `0` on success, `2` on configuration errors (missing catalog,
misconfigured repo root, invalid facets), and `3` on internal errors. Results are
rendered as JSON/NDJSON to ease scripting.

### Stdio / MCP Server

The `catalogctl-mcp` console script spawns `kgfoundry.agent_catalog.mcp:main`, a
stdio JSON-RPC server compliant with the Model Context Protocol. Each session
performs RBAC checks and writes audit events via `kgfoundry.agent_catalog.audit`.
The server exits cleanly on stdin EOF and never opens a network port. Example:

```bash
catalogctl-mcp --catalog docs/_build/agent_catalog.json <<'EOF'
{"jsonrpc": "2.0", "id": 1, "method": "agent/catalog.capabilities"}
EOF
```

## Hosted Mode, RBAC, and Audit Logging

Hosted deployments can opt into RBAC by exporting `AGENT_CATALOG_HOSTED=1` and
providing a policy via `kgfoundry.agent_catalog.rbac.configure_roles`. Three roles
are supported:

- `viewer`: read-only access to catalog queries.
- `contributor`: may submit local feedback (still redacted client-side).
- `admin`: may toggle hosted features, inspect audit logs, and manage policies.

Audit events are recorded through `kgfoundry.agent_catalog.audit.AuditLogger`. Each
event includes the actor, action, result, and contextual metadata (such as the
symbol queried). Hosted integrations SHOULD persist audit records to an append-only
store. The default implementation logs to structured JSON on stdout.

## Portal Usage

Run `uv run python tools/docs/render_agent_portal.py` (or `make artifacts`) to
generate `site/_build/agent/index.html`. The portal provides:

- Quick links to supporting artifacts (DocFacts, NavMap, schemas, analytics).
- Faceted search over package, stability, parity, coverage, and churn thresholds.
- Module cards with metrics, agent hints, exemplar snippets, dependency summaries,
  and "Open anchor" buttons that trigger `catalogctl://` deeplinks.
- Tutorials linking back to this document and the CLI guide.
- A local-only feedback form with automatic redaction of emails and long numbers.

### Content-Addressed Caching

Module cards are rendered through a content-addressed cache stored alongside the
portal artifact (`site/_build/agent/.module_cache`). When catalog inputs do not
change, rendering reads cached HTML fragments and prunes unused cards.

## Analytics

`tools/docs/build_agent_analytics.py` writes `docs/_build/analytics.json`. The
payload captures catalog metrics, portal session counters, and link validation
errors. Re-running the builder increments the `portal.sessions.builds` counter,
allowing CI to detect drift. The analytics step is wired into the artifact build
pipeline and exposed via CI annotations.

## Docker Usage

The repository ships with `docker/catalogctl.Dockerfile`, a multi-stage image that
builds the project wheel with `uv build`, installs it into a slim runtime, and
copies catalog artifacts into `/srv/catalog`. At runtime set `CATALOG_ROOT=/srv/catalog`
so clients and CLIs pick up the bundled artifacts. The entrypoint runs the CLI
tooling on demand; no daemons or network ports are started.
