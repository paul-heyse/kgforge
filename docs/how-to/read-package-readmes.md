# How to Read Package READMEs

The autogenerated package READMEs provide a quick, structured view of every
public symbol in a package. This guide explains how to read them, how badges and
links are constructed, and which commands keep the documents fresh.

## README Structure at a Glance

Every generated README follows the same layout:

1. **H1 Title** – ``# `<package>` `` where ``<package>`` is the fully qualified
   package name.
2. **Synopsis** – The first sentence of the package ``__init__`` docstring. If
   no docstring exists you will see the fallback sentence
   *“Package synopsis not yet documented.”*
3. **DocToc Markers** – Two HTML comments that mark where DocToc inserts the
   table of contents when you run it locally or via `--run-doctoc`.
4. **Sections** – Symbols are grouped deterministically into
   `Modules`, `Classes`, `Functions`, and `Exceptions`. Empty sections are
   omitted.
5. **Entries** – Each symbol renders as:

   ```markdown
   - **`package.symbol`** — First sentence of the symbol docstring
     `stability:beta` `owner:@docs` `section:getting-started`
     `since:0.2.0` `deprecated:0.5.0` `tested-by: tests/unit/test_symbol.py:42`
     → [open](vscode://file/ABS:LINE:1) | [view](https://github.com/org/repo/blob/SHA/path#Lstart-Lend)
   ```

## Badge Reference

Badges expose metadata captured in the NavMap (`site/_build/navmap/navmap.json`)
and TestMap (`docs/_build/test_map.json`) artifacts. They always appear in the
following order:

| Badge | Meaning | Source |
| --- | --- | --- |
| ``stability:<state>`` | Lifecycle state (`stable`, `beta`, `experimental`, `deprecated`) | NavMap ``meta`` or ``module_meta`` |
| ``owner:<@team>`` | Responsible team or individual | NavMap |
| ``section:<id>`` | Documentation section identifier | NavMap ``sections[*].id`` |
| ``since:<version>`` | Version when the symbol was introduced | NavMap |
| ``deprecated:<version>`` | Version when the symbol became deprecated | NavMap |
| ``tested-by:file[:line]`` | Up to three test files that cover the symbol | TestMap |

Badges wrap onto a new line once the combined summary + badge text exceeds 80
characters; continuation lines are indented with four spaces so wrapped badges
align visually.

## Link Types

Two link columns appear to the right of each entry depending on the selected
link mode:

* **[open]** – Deep-link into your editor.
  * VSCode: `vscode://file/<abs_path>:<line>:1`
  * Relative: `./<repo-relative-path>:<line>:1`
* **[view]** – GitHub permalink to the exact line range in the current commit:
  `https://github.com/<org>/<repo>/blob/<sha>/<path>#L<start>-L<end>`

Use `--link-mode editor`, `--link-mode github`, or `--link-mode both` to control
which column appears. Pair `--editor relative` with `--link-mode editor` when you
share READMEs outside of VSCode.

## When and How to Regenerate READMEs

Regenerate READMEs whenever you:

* modify docstrings or public APIs in a package
* update NavMap/TestMap metadata (owners, stability, tests)
* add or remove Python modules, classes, functions, or exceptions

To regenerate all READMEs:

```bash
python tools/gen_readmes.py --link-mode both --editor vscode
```

To regenerate a subset, set `DOCS_PKG` (comma-separated list) or pass
`--packages` explicitly.

### DocToc Integration

Pass `--run-doctoc` to invoke DocToc automatically after each README write. The
command checks for the `doctoc` binary (npm) and skips gracefully if it is not
installed.

## CLI Flags and Environment Variables

| Flag | Environment Variable | Description |
| --- | --- | --- |
| `--packages` | `DOCS_PKG` | Comma-separated list of packages to document. Auto-detected when omitted. |
| `--link-mode` | `DOCS_LINK_MODE` | `github`, `editor`, or `both`. Defaults to `both`. |
| `--editor` | `DOCS_EDITOR` | `vscode` or `relative`. Controls editor link format. |
| `--fail-on-metadata-miss` | – | Exit with code 2 when `owner` or `stability` metadata is missing. |
| `--dry-run` | – | Print planned writes without touching the filesystem. |
| `--verbose` | – | Emit timing information and DocToc output. |
| `--run-doctoc` | – | Run DocToc after writing each README (requires the `doctoc` CLI). |

Additional environment overrides: `DOCS_GITHUB_ORG`, `DOCS_GITHUB_REPO`, and
`DOCS_GITHUB_SHA` customise the permalink target when working outside of a git
repository.

## Examples

*Generate READMEs for two packages and open links in VSCode*

```bash
DOCS_PKG=kgfoundry_common,download \
python tools/gen_readmes.py --link-mode both --editor vscode
```

*Render GitHub-only links for CI validation*

```bash
python tools/gen_readmes.py --link-mode github --editor relative
```

*Preview without writing to disk*

```bash
python tools/gen_readmes.py --dry-run --packages kgfoundry_common
```

## Troubleshooting

| Symptom | Likely Cause | Fix |
| --- | --- | --- |
| Missing badges | NavMap/TestMap not built | Run `python tools/navmap/build_navmap.py` and `python tools/docs/build_test_map.py` |
| `tested-by` empty | No tests recorded for the symbol | Add coverage to `docs/_build/test_map.json` via `build_test_map.py` |
| No README written | Package lacks public symbols | Add public modules/classes/functions or run with `--verbose` to inspect filtering |
| Absolute VSCode paths | Using default `vscode` editor mode outside repo root | Switch to `--editor relative` |
| DocToc skipped | CLI not installed | `npm install -g doctoc` |

## Quick Commands

* **Regenerate everything:** `python tools/gen_readmes.py`
* **One package only:** `DOCS_PKG=kgfoundry_common python tools/gen_readmes.py`
* **Run DocToc automatically:** `python tools/gen_readmes.py --run-doctoc`
* **Enforce metadata completeness:** `python tools/gen_readmes.py --fail-on-metadata-miss`
* **Validate README freshness (CI-equivalent):**

  ```bash
  python tools/gen_readmes.py --link-mode github --editor relative
  git diff -- src/**/README.md
  ```

## Relationship to NavMap and TestMap

* The **NavMap** drives ownership, stability, section, and version badges. If
  a symbol lacks metadata the generator falls back to module defaults.
* The **TestMap** contributes up to three “tested-by” references per symbol,
  prioritising unit tests first. Missing TestMap entries simply omit the badge.

Keep both artifacts current to produce meaningful READMEs.
